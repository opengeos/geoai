
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A Python package for using Artificial Intelligence (AI) with geospatial data">
      
      
        <meta name="author" content="opengeos">
      
      
        <link rel="canonical" href="https://opengeoai.org/geoai/">
      
      
        <link rel="prev" href="../geo_agents/">
      
      
        <link rel="next" href="../download/">
      
      
      <link rel="icon" href="../assets/logo.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>geoai module - GeoAI</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../css/timeago.css">
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#geoai-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GeoAI" class="md-header__button md-logo" aria-label="GeoAI" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GeoAI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              geoai module
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/opengeos/geoai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GeoAI" class="md-nav__button md-logo" aria-label="GeoAI" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    GeoAI
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/opengeos/geoai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/opengeos/geoai/releases" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/opengeos/geoai/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Report Issues
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/download_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/download_sentinel2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download sentinel2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/download_naip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download naip
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/planetary_computer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planetary computer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/view_metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    View metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/create_vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create vector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/edit_vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Edit vector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/image_chips/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image chips
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/image_tiling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image tiling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/create_training_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create training data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/export_training_data_formats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Export training data formats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_footprints_usa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building footprints usa
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_footprints_africa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building footprints africa
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_footprints_china/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building footprints china
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_regularization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building regularization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/geometric_properties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Geometric properties
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/car_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Car detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/ship_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ship detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/solar_panel_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Solar panel detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/text_prompt_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Text prompt segmentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/parking_spot_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parking spot detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/data_visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data visualization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_object_detection_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train object detection model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_segmentation_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train segmentation model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_instance_segmentation_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train instance segmentation model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_landcover_classification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train landcover classification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_building_footprints_usa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train building footprints usa
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_solar_panel_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train solar panel detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_car_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train car detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_ship_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train ship detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_water_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train water detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/water_dynamics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Water dynamics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/wetland_mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Wetland mapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/wetland_dynamics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Wetland dynamics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/regularization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Regularization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/globe_projection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Globe projection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/samgeo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Samgeo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/grounded_sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grounded sam
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/load_model_checkpoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Load model checkpoint
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/water_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Water detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/water_detection_s2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Water detection s2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/batch_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch segmentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_detection_lidar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building detection lidar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/instance_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instance segmentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/change_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change detection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/JPEG2000/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JPEG2000
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/DINOv3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DINOv3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/DINOv3_visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DINOv3 visualization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/DINOv3_wetlands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DINOv3 wetlands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/AlphaEarth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AlphaEarth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/AI_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/STAC_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    STAC agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/catalog_search_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Catalog search agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_timm_classifier/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train timm classifier
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_timm_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train timm segmentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/lightly_train_self_supervised/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lightly train self supervised
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/clean_segmentation_results/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Clean segmentation results
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Workshops
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Workshops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/GeoAI_Workshop_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GeoAI Workshop 2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/AWS_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS 2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/TNView_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TNView 2025
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../change_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    change_detection module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../classify/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    classify module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../detectron2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    detectron2 module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dinov3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DINOv3 module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../geo_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    geo_agents module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    geoai module
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    geoai module
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai" class="md-nav__link">
    <span class="md-ellipsis">
      geoai
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator" class="md-nav__link">
    <span class="md-ellipsis">
      AgricultureFieldDelineator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgricultureFieldDelineator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.initialize_sentinel2_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_sentinel2_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.preprocess_sentinel_bands" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess_sentinel_bands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.process_sentinel_raster" class="md-nav__link">
    <span class="md-ellipsis">
      process_sentinel_raster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.update_band_stats" class="md-nav__link">
    <span class="md-ellipsis">
      update_band_stats
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.BoundingBox" class="md-nav__link">
    <span class="md-ellipsis">
      BoundingBox
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.BuildingFootprintExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BuildingFootprintExtractor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BuildingFootprintExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.BuildingFootprintExtractor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.BuildingFootprintExtractor.regularize_buildings" class="md-nav__link">
    <span class="md-ellipsis">
      regularize_buildings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      CLIPSegmentation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLIPSegmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation.segment_image" class="md-nav__link">
    <span class="md-ellipsis">
      segment_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation.segment_image_batch" class="md-nav__link">
    <span class="md-ellipsis">
      segment_image_batch
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.CarDetector" class="md-nav__link">
    <span class="md-ellipsis">
      CarDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CarDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset" class="md-nav__link">
    <span class="md-ellipsis">
      CustomDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CustomDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.DetectionResult" class="md-nav__link">
    <span class="md-ellipsis">
      DetectionResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.GroundedSAM" class="md-nav__link">
    <span class="md-ellipsis">
      GroundedSAM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GroundedSAM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.GroundedSAM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.GroundedSAM.segment_image" class="md-nav__link">
    <span class="md-ellipsis">
      segment_image
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.LeafMap" class="md-nav__link">
    <span class="md-ellipsis">
      LeafMap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LeafMap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.LeafMap.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.LeafMap.add_dinov3_gui" class="md-nav__link">
    <span class="md-ellipsis">
      add_dinov3_gui
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.Map" class="md-nav__link">
    <span class="md-ellipsis">
      Map
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Map">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.Map.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector" class="md-nav__link">
    <span class="md-ellipsis">
      ObjectDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ObjectDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.download_model_from_hf" class="md-nav__link">
    <span class="md-ellipsis">
      download_model_from_hf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.filter_edge_objects" class="md-nav__link">
    <span class="md-ellipsis">
      filter_edge_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.filter_overlapping_polygons" class="md-nav__link">
    <span class="md-ellipsis">
      filter_overlapping_polygons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.generate_masks" class="md-nav__link">
    <span class="md-ellipsis">
      generate_masks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.initialize_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.load_weights" class="md-nav__link">
    <span class="md-ellipsis">
      load_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.mask_to_polygons" class="md-nav__link">
    <span class="md-ellipsis">
      mask_to_polygons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.masks_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      masks_to_vector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.process_raster" class="md-nav__link">
    <span class="md-ellipsis">
      process_raster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.regularize_objects" class="md-nav__link">
    <span class="md-ellipsis">
      regularize_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.save_masks_as_geotiff" class="md-nav__link">
    <span class="md-ellipsis">
      save_masks_as_geotiff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.vectorize_masks" class="md-nav__link">
    <span class="md-ellipsis">
      vectorize_masks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.visualize_results" class="md-nav__link">
    <span class="md-ellipsis">
      visualize_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.ParkingSplotDetector" class="md-nav__link">
    <span class="md-ellipsis">
      ParkingSplotDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParkingSplotDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ParkingSplotDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.ShipDetector" class="md-nav__link">
    <span class="md-ellipsis">
      ShipDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ShipDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ShipDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.SolarPanelDetector" class="md-nav__link">
    <span class="md-ellipsis">
      SolarPanelDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SolarPanelDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.SolarPanelDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.adaptive_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      adaptive_regularization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.add_geometric_properties" class="md-nav__link">
    <span class="md-ellipsis">
      add_geometric_properties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.analyze_vector_attributes" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_vector_attributes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.batch_vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      batch_vector_to_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.bbox_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      bbox_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.boxes_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      boxes_to_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_f1_score" class="md-nav__link">
    <span class="md-ellipsis">
      calc_f1_score
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_iou" class="md-nav__link">
    <span class="md-ellipsis">
      calc_iou
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_segmentation_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      calc_segmentation_metrics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_stats" class="md-nav__link">
    <span class="md-ellipsis">
      calc_stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.clip_raster_by_bbox" class="md-nav__link">
    <span class="md-ellipsis">
      clip_raster_by_bbox
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.coords_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      coords_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.create_overview_image" class="md-nav__link">
    <span class="md-ellipsis">
      create_overview_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.create_split_map" class="md-nav__link">
    <span class="md-ellipsis">
      create_split_map
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.create_vector_data" class="md-nav__link">
    <span class="md-ellipsis">
      create_vector_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.dict_to_image" class="md-nav__link">
    <span class="md-ellipsis">
      dict_to_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.dict_to_rioxarray" class="md-nav__link">
    <span class="md-ellipsis">
      dict_to_rioxarray
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.display_image_with_vector" class="md-nav__link">
    <span class="md-ellipsis">
      display_image_with_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.display_training_tiles" class="md-nav__link">
    <span class="md-ellipsis">
      display_training_tiles
    </span>
  </a>
  
    <nav class="md-nav" aria-label="display_training_tiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.display_training_tiles--or-save-to-file" class="md-nav__link">
    <span class="md-ellipsis">
      Or save to file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.download_file" class="md-nav__link">
    <span class="md-ellipsis">
      download_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.download_model_from_hf" class="md-nav__link">
    <span class="md-ellipsis">
      download_model_from_hf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.edit_vector_data" class="md-nav__link">
    <span class="md-ellipsis">
      edit_vector_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.empty_cache" class="md-nav__link">
    <span class="md-ellipsis">
      empty_cache
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles" class="md-nav__link">
    <span class="md-ellipsis">
      export_geotiff_tiles
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch" class="md-nav__link">
    <span class="md-ellipsis">
      export_geotiff_tiles_batch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="export_geotiff_tiles_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--images-only-no-masks" class="md-nav__link">
    <span class="md-ellipsis">
      Images only (no masks)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--single-vector-file-covering-all-images" class="md-nav__link">
    <span class="md-ellipsis">
      Single vector file covering all images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--multiple-vector-files-matched-by-filename" class="md-nav__link">
    <span class="md-ellipsis">
      Multiple vector files, matched by filename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--multiple-mask-files-matched-by-sorted-order" class="md-nav__link">
    <span class="md-ellipsis">
      Multiple mask files, matched by sorted order
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_tiles_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      export_tiles_to_geojson
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_training_data" class="md-nav__link">
    <span class="md-ellipsis">
      export_training_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.geojson_to_coords" class="md-nav__link">
    <span class="md-ellipsis">
      geojson_to_coords
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.geojson_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      geojson_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_device" class="md-nav__link">
    <span class="md-ellipsis">
      get_device
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_model_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_model_input_channels" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_input_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_info_gdal" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_info_gdal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_resolution" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_resolution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_stats" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      get_vector_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_vector_info_ogr" class="md-nav__link">
    <span class="md-ellipsis">
      get_vector_info_ogr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.hybrid_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      hybrid_regularization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.image_segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      image_segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.inspect_pth_file" class="md-nav__link">
    <span class="md-ellipsis">
      inspect_pth_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.install_package" class="md-nav__link">
    <span class="md-ellipsis">
      install_package
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.mask_generation" class="md-nav__link">
    <span class="md-ellipsis">
      mask_generation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.masks_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      masks_to_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.mosaic_geotiffs" class="md-nav__link">
    <span class="md-ellipsis">
      mosaic_geotiffs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.orthogonalize" class="md-nav__link">
    <span class="md-ellipsis">
      orthogonalize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_batch" class="md-nav__link">
    <span class="md-ellipsis">
      plot_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_images" class="md-nav__link">
    <span class="md-ellipsis">
      plot_images
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_masks" class="md-nav__link">
    <span class="md-ellipsis">
      plot_masks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_performance_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      plot_performance_metrics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_prediction_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      plot_prediction_comparison
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.print_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      print_raster_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.print_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      print_vector_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.raster_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      raster_to_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.raster_to_vector_batch" class="md-nav__link">
    <span class="md-ellipsis">
      raster_to_vector_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.read_raster" class="md-nav__link">
    <span class="md-ellipsis">
      read_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.read_vector" class="md-nav__link">
    <span class="md-ellipsis">
      read_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.region_groups" class="md-nav__link">
    <span class="md-ellipsis">
      region_groups
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.regularization" class="md-nav__link">
    <span class="md-ellipsis">
      regularization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.regularize" class="md-nav__link">
    <span class="md-ellipsis">
      regularize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.rowcol_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      rowcol_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.stack_bands" class="md-nav__link">
    <span class="md-ellipsis">
      stack_bands
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.temp_file_path" class="md-nav__link">
    <span class="md-ellipsis">
      temp_file_path
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.try_common_architectures" class="md-nav__link">
    <span class="md-ellipsis">
      try_common_architectures
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.vector_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      vector_to_geojson
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      vector_to_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_image" class="md-nav__link">
    <span class="md-ellipsis">
      view_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_raster" class="md-nav__link">
    <span class="md-ellipsis">
      view_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_vector" class="md-nav__link">
    <span class="md-ellipsis">
      view_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_vector_interactive" class="md-nav__link">
    <span class="md-ellipsis">
      view_vector_interactive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.visualize_vector_by_attribute" class="md-nav__link">
    <span class="md-ellipsis">
      visualize_vector_by_attribute
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.write_colormap" class="md-nav__link">
    <span class="md-ellipsis">
      write_colormap
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../download/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    download module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    extract module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hf module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../map_tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    map_tools module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../map_widgets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    map_widgets module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    sam module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    segmentation module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../timm_train/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    timm_train module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../timm_segment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    timm_segment module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../train/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    train module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils module
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai" class="md-nav__link">
    <span class="md-ellipsis">
      geoai
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator" class="md-nav__link">
    <span class="md-ellipsis">
      AgricultureFieldDelineator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgricultureFieldDelineator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.initialize_sentinel2_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_sentinel2_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.preprocess_sentinel_bands" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess_sentinel_bands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.process_sentinel_raster" class="md-nav__link">
    <span class="md-ellipsis">
      process_sentinel_raster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.AgricultureFieldDelineator.update_band_stats" class="md-nav__link">
    <span class="md-ellipsis">
      update_band_stats
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.BoundingBox" class="md-nav__link">
    <span class="md-ellipsis">
      BoundingBox
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.BuildingFootprintExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BuildingFootprintExtractor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BuildingFootprintExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.BuildingFootprintExtractor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.BuildingFootprintExtractor.regularize_buildings" class="md-nav__link">
    <span class="md-ellipsis">
      regularize_buildings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      CLIPSegmentation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLIPSegmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation.segment_image" class="md-nav__link">
    <span class="md-ellipsis">
      segment_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CLIPSegmentation.segment_image_batch" class="md-nav__link">
    <span class="md-ellipsis">
      segment_image_batch
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.CarDetector" class="md-nav__link">
    <span class="md-ellipsis">
      CarDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CarDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CarDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset" class="md-nav__link">
    <span class="md-ellipsis">
      CustomDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CustomDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.CustomDataset.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.DetectionResult" class="md-nav__link">
    <span class="md-ellipsis">
      DetectionResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.GroundedSAM" class="md-nav__link">
    <span class="md-ellipsis">
      GroundedSAM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GroundedSAM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.GroundedSAM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.GroundedSAM.segment_image" class="md-nav__link">
    <span class="md-ellipsis">
      segment_image
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.LeafMap" class="md-nav__link">
    <span class="md-ellipsis">
      LeafMap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LeafMap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.LeafMap.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.LeafMap.add_dinov3_gui" class="md-nav__link">
    <span class="md-ellipsis">
      add_dinov3_gui
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.Map" class="md-nav__link">
    <span class="md-ellipsis">
      Map
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Map">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.Map.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector" class="md-nav__link">
    <span class="md-ellipsis">
      ObjectDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ObjectDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.download_model_from_hf" class="md-nav__link">
    <span class="md-ellipsis">
      download_model_from_hf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.filter_edge_objects" class="md-nav__link">
    <span class="md-ellipsis">
      filter_edge_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.filter_overlapping_polygons" class="md-nav__link">
    <span class="md-ellipsis">
      filter_overlapping_polygons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.generate_masks" class="md-nav__link">
    <span class="md-ellipsis">
      generate_masks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.initialize_model" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.load_weights" class="md-nav__link">
    <span class="md-ellipsis">
      load_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.mask_to_polygons" class="md-nav__link">
    <span class="md-ellipsis">
      mask_to_polygons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.masks_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      masks_to_vector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.process_raster" class="md-nav__link">
    <span class="md-ellipsis">
      process_raster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.regularize_objects" class="md-nav__link">
    <span class="md-ellipsis">
      regularize_objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.save_masks_as_geotiff" class="md-nav__link">
    <span class="md-ellipsis">
      save_masks_as_geotiff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.vectorize_masks" class="md-nav__link">
    <span class="md-ellipsis">
      vectorize_masks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ObjectDetector.visualize_results" class="md-nav__link">
    <span class="md-ellipsis">
      visualize_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.ParkingSplotDetector" class="md-nav__link">
    <span class="md-ellipsis">
      ParkingSplotDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParkingSplotDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ParkingSplotDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.ShipDetector" class="md-nav__link">
    <span class="md-ellipsis">
      ShipDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ShipDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.ShipDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.SolarPanelDetector" class="md-nav__link">
    <span class="md-ellipsis">
      SolarPanelDetector
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SolarPanelDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.SolarPanelDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.adaptive_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      adaptive_regularization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.add_geometric_properties" class="md-nav__link">
    <span class="md-ellipsis">
      add_geometric_properties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.analyze_vector_attributes" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_vector_attributes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.batch_vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      batch_vector_to_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.bbox_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      bbox_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.boxes_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      boxes_to_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_f1_score" class="md-nav__link">
    <span class="md-ellipsis">
      calc_f1_score
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_iou" class="md-nav__link">
    <span class="md-ellipsis">
      calc_iou
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_segmentation_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      calc_segmentation_metrics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.calc_stats" class="md-nav__link">
    <span class="md-ellipsis">
      calc_stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.clip_raster_by_bbox" class="md-nav__link">
    <span class="md-ellipsis">
      clip_raster_by_bbox
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.coords_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      coords_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.create_overview_image" class="md-nav__link">
    <span class="md-ellipsis">
      create_overview_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.create_split_map" class="md-nav__link">
    <span class="md-ellipsis">
      create_split_map
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.create_vector_data" class="md-nav__link">
    <span class="md-ellipsis">
      create_vector_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.dict_to_image" class="md-nav__link">
    <span class="md-ellipsis">
      dict_to_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.dict_to_rioxarray" class="md-nav__link">
    <span class="md-ellipsis">
      dict_to_rioxarray
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.display_image_with_vector" class="md-nav__link">
    <span class="md-ellipsis">
      display_image_with_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.display_training_tiles" class="md-nav__link">
    <span class="md-ellipsis">
      display_training_tiles
    </span>
  </a>
  
    <nav class="md-nav" aria-label="display_training_tiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.display_training_tiles--or-save-to-file" class="md-nav__link">
    <span class="md-ellipsis">
      Or save to file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.download_file" class="md-nav__link">
    <span class="md-ellipsis">
      download_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.download_model_from_hf" class="md-nav__link">
    <span class="md-ellipsis">
      download_model_from_hf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.edit_vector_data" class="md-nav__link">
    <span class="md-ellipsis">
      edit_vector_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.empty_cache" class="md-nav__link">
    <span class="md-ellipsis">
      empty_cache
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles" class="md-nav__link">
    <span class="md-ellipsis">
      export_geotiff_tiles
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch" class="md-nav__link">
    <span class="md-ellipsis">
      export_geotiff_tiles_batch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="export_geotiff_tiles_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--images-only-no-masks" class="md-nav__link">
    <span class="md-ellipsis">
      Images only (no masks)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--single-vector-file-covering-all-images" class="md-nav__link">
    <span class="md-ellipsis">
      Single vector file covering all images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--multiple-vector-files-matched-by-filename" class="md-nav__link">
    <span class="md-ellipsis">
      Multiple vector files, matched by filename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoai.geoai.export_geotiff_tiles_batch--multiple-mask-files-matched-by-sorted-order" class="md-nav__link">
    <span class="md-ellipsis">
      Multiple mask files, matched by sorted order
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_tiles_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      export_tiles_to_geojson
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.export_training_data" class="md-nav__link">
    <span class="md-ellipsis">
      export_training_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.geojson_to_coords" class="md-nav__link">
    <span class="md-ellipsis">
      geojson_to_coords
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.geojson_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      geojson_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_device" class="md-nav__link">
    <span class="md-ellipsis">
      get_device
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_model_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_model_input_channels" class="md-nav__link">
    <span class="md-ellipsis">
      get_model_input_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_info_gdal" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_info_gdal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_resolution" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_resolution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_raster_stats" class="md-nav__link">
    <span class="md-ellipsis">
      get_raster_stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      get_vector_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.get_vector_info_ogr" class="md-nav__link">
    <span class="md-ellipsis">
      get_vector_info_ogr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.hybrid_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      hybrid_regularization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.image_segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      image_segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.inspect_pth_file" class="md-nav__link">
    <span class="md-ellipsis">
      inspect_pth_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.install_package" class="md-nav__link">
    <span class="md-ellipsis">
      install_package
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.mask_generation" class="md-nav__link">
    <span class="md-ellipsis">
      mask_generation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.masks_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      masks_to_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.mosaic_geotiffs" class="md-nav__link">
    <span class="md-ellipsis">
      mosaic_geotiffs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.orthogonalize" class="md-nav__link">
    <span class="md-ellipsis">
      orthogonalize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_batch" class="md-nav__link">
    <span class="md-ellipsis">
      plot_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_images" class="md-nav__link">
    <span class="md-ellipsis">
      plot_images
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_masks" class="md-nav__link">
    <span class="md-ellipsis">
      plot_masks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_performance_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      plot_performance_metrics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.plot_prediction_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      plot_prediction_comparison
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.print_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      print_raster_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.print_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      print_vector_info
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.raster_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      raster_to_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.raster_to_vector_batch" class="md-nav__link">
    <span class="md-ellipsis">
      raster_to_vector_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.read_raster" class="md-nav__link">
    <span class="md-ellipsis">
      read_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.read_vector" class="md-nav__link">
    <span class="md-ellipsis">
      read_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.region_groups" class="md-nav__link">
    <span class="md-ellipsis">
      region_groups
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.regularization" class="md-nav__link">
    <span class="md-ellipsis">
      regularization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.regularize" class="md-nav__link">
    <span class="md-ellipsis">
      regularize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.rowcol_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      rowcol_to_xy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.stack_bands" class="md-nav__link">
    <span class="md-ellipsis">
      stack_bands
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.temp_file_path" class="md-nav__link">
    <span class="md-ellipsis">
      temp_file_path
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.try_common_architectures" class="md-nav__link">
    <span class="md-ellipsis">
      try_common_architectures
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.vector_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      vector_to_geojson
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      vector_to_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_image" class="md-nav__link">
    <span class="md-ellipsis">
      view_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_raster" class="md-nav__link">
    <span class="md-ellipsis">
      view_raster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_vector" class="md-nav__link">
    <span class="md-ellipsis">
      view_vector
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.view_vector_interactive" class="md-nav__link">
    <span class="md-ellipsis">
      view_vector_interactive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.visualize_vector_by_attribute" class="md-nav__link">
    <span class="md-ellipsis">
      visualize_vector_by_attribute
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.geoai.write_colormap" class="md-nav__link">
    <span class="md-ellipsis">
      write_colormap
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="geoai-module">geoai module<a class="headerlink" href="#geoai-module" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="geoai.geoai"></a>
    <div class="doc doc-contents first">

        <p>Main module.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.AgricultureFieldDelineator" class="doc doc-heading">
            <code>AgricultureFieldDelineator</code>


<a href="#geoai.geoai.AgricultureFieldDelineator" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ObjectDetector (geoai.extract.ObjectDetector)" href="../extract/#geoai.extract.ObjectDetector">ObjectDetector</a></code></p>


        <p>Agricultural field boundary delineation using a pre-trained Mask R-CNN model.</p>
<p>This class extends the ObjectDetector class to specifically handle Sentinel-2
imagery with 12 spectral bands for agricultural field boundary detection.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.AgricultureFieldDelineator.band_selection">band_selection</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices to use for prediction (default: RGB)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.AgricultureFieldDelineator.sentinel_band_stats">sentinel_band_stats</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Per-band statistics for Sentinel-2 data</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.AgricultureFieldDelineator.use_ndvi">use_ndvi</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to calculate and include NDVI as an additional channel</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AgricultureFieldDelineator</span><span class="p">(</span><span class="n">ObjectDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Agricultural field boundary delineation using a pre-trained Mask R-CNN model.</span>

<span class="sd">    This class extends the ObjectDetector class to specifically handle Sentinel-2</span>
<span class="sd">    imagery with 12 spectral bands for agricultural field boundary detection.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        band_selection: List of band indices to use for prediction (default: RGB)</span>
<span class="sd">        sentinel_band_stats: Per-band statistics for Sentinel-2 data</span>
<span class="sd">        use_ndvi: Whether to calculate and include NDVI as an additional channel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;field_boundary_detector.pth&quot;</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_ndvi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the field boundary delineator.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">            model: Custom model to use for inference.</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">            band_selection: List of Sentinel-2 band indices to use (None = adapt based on model)</span>
<span class="sd">            use_ndvi: Whether to calculate and include NDVI as an additional channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Save parameters before calling parent constructor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span> <span class="o">=</span> <span class="n">band_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span>

        <span class="c1"># Set device (copied from parent init to ensure it&#39;s set before initialize_model)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Initialize model differently for multi-spectral input</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_sentinel2_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Call parent but with our custom model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="c1"># Default Sentinel-2 band statistics (can be overridden with actual stats)</span>
        <span class="c1"># Band order: [B1, B2, B3, B4, B5, B6, B7, B8, B8A, B9, B10, B11, B12]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mf">0.0975</span><span class="p">,</span>
                <span class="mf">0.0476</span><span class="p">,</span>
                <span class="mf">0.0598</span><span class="p">,</span>
                <span class="mf">0.0697</span><span class="p">,</span>
                <span class="mf">0.1077</span><span class="p">,</span>
                <span class="mf">0.1859</span><span class="p">,</span>
                <span class="mf">0.2378</span><span class="p">,</span>
                <span class="mf">0.2061</span><span class="p">,</span>
                <span class="mf">0.2598</span><span class="p">,</span>
                <span class="mf">0.4120</span><span class="p">,</span>
                <span class="mf">0.1956</span><span class="p">,</span>
                <span class="mf">0.1410</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mf">0.0551</span><span class="p">,</span>
                <span class="mf">0.0290</span><span class="p">,</span>
                <span class="mf">0.0298</span><span class="p">,</span>
                <span class="mf">0.0479</span><span class="p">,</span>
                <span class="mf">0.0506</span><span class="p">,</span>
                <span class="mf">0.0505</span><span class="p">,</span>
                <span class="mf">0.0747</span><span class="p">,</span>
                <span class="mf">0.0642</span><span class="p">,</span>
                <span class="mf">0.0782</span><span class="p">,</span>
                <span class="mf">0.1187</span><span class="p">,</span>
                <span class="mf">0.0651</span><span class="p">,</span>
                <span class="mf">0.0679</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Set default band selection (RGB - typically B4, B3, B2 for Sentinel-2)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># R, G, B bands</span>

        <span class="c1"># Customize parameters for field delineation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Default confidence threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Higher overlap for field boundary detection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Minimum area in pixels for field detection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Higher tolerance for field boundaries</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_sentinel2_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Mask R-CNN model with a modified first layer to accept Sentinel-2 data.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: Pre-initialized model (optional)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Modified model with appropriate input channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">maskrcnn_resnet50_fpn</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection.backbone_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">resnet_fpn_backbone</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span>

        <span class="c1"># Determine number of input channels based on band selection and NDVI</span>
        <span class="n">num_input_channels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="mi">3</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span><span class="p">:</span>
            <span class="n">num_input_channels</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Mask R-CNN model with </span><span class="si">{</span><span class="n">num_input_channels</span><span class="si">}</span><span class="s2"> input channels&quot;</span><span class="p">)</span>

        <span class="c1"># Create a ResNet50 backbone with modified input channels</span>
        <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet_fpn_backbone</span><span class="p">(</span><span class="s2">&quot;resnet50&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Replace the first conv layer to accept multi-spectral input</span>
        <span class="n">original_conv</span> <span class="o">=</span> <span class="n">backbone</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">conv1</span>
        <span class="n">backbone</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
            <span class="n">num_input_channels</span><span class="p">,</span>
            <span class="n">original_conv</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create Mask R-CNN with our modified backbone</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">maskrcnn_resnet50_fpn</span><span class="p">(</span>
            <span class="n">backbone</span><span class="o">=</span><span class="n">backbone</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Background + field</span>
            <span class="n">image_mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_input_channels</span><span class="p">,</span>  <span class="c1"># Extend mean to all channels</span>
            <span class="n">image_std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_input_channels</span><span class="p">,</span>  <span class="c1"># Extend std to all channels</span>
        <span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_sentinel_bands</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_ndvi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess Sentinel-2 band data for model input.</span>

<span class="sd">        Args:</span>
<span class="sd">            image_data: Raw Sentinel-2 image data as numpy array [bands, height, width]</span>
<span class="sd">            band_selection: List of band indices to use (overrides instance default if provided)</span>
<span class="sd">            use_ndvi: Whether to include NDVI (overrides instance default if provided)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Processed tensor ready for model input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use instance defaults if not specified</span>
        <span class="n">band_selection</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">band_selection</span> <span class="k">if</span> <span class="n">band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span>
        <span class="p">)</span>
        <span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span> <span class="k">if</span> <span class="n">use_ndvi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span>

        <span class="c1"># Select bands</span>
        <span class="n">selected_bands</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">band_selection</span><span class="p">]</span>

        <span class="c1"># Calculate NDVI if requested (using B8 and B4 which are indices 7 and 3)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">use_ndvi</span>
            <span class="ow">and</span> <span class="mi">7</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">nir</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># B8 (NIR)</span>
            <span class="n">red</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># B4 (Red)</span>

            <span class="c1"># Avoid division by zero</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">nir</span> <span class="o">+</span> <span class="n">red</span>
            <span class="n">ndvi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nir</span><span class="p">)</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">denominator</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">ndvi</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">red</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">[</span>
                <span class="n">valid_mask</span>
            <span class="p">]</span>

            <span class="c1"># Rescale NDVI from [-1, 1] to [0, 1]</span>
            <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndvi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># Add NDVI as an additional channel</span>
            <span class="n">selected_bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">selected_bands</span><span class="p">,</span> <span class="n">ndvi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]])</span>

        <span class="c1"># Convert to tensor</span>
        <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">selected_bands</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># Normalize using band statistics</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">band_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_selection</span><span class="p">):</span>
            <span class="c1"># Make sure band_idx is within range of our statistics</span>
            <span class="k">if</span> <span class="n">band_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">]):</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">]</span>
                <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span><span class="p">[</span><span class="s2">&quot;stds&quot;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">]</span>
                <span class="n">image_tensor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_tensor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>

        <span class="c1"># If NDVI was added, normalize it too (last channel)</span>
        <span class="k">if</span> <span class="n">use_ndvi</span><span class="p">:</span>
            <span class="c1"># NDVI is already roughly in [0,1] range, just standardize it slightly</span>
            <span class="n">image_tensor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_tensor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.5</span>

        <span class="k">return</span> <span class="n">image_tensor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_band_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update band statistics from the input Sentinel-2 raster.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to the Sentinel-2 raster file</span>
<span class="sd">            band_selection: Specific bands to update (None = update all available)</span>
<span class="sd">            sample_size: Number of random pixels to sample for statistics calculation</span>

<span class="sd">        Returns:</span>
<span class="sd">            Updated band statistics dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Check if this is likely a Sentinel-2 product</span>
            <span class="n">band_count</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>
            <span class="k">if</span> <span class="n">band_count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Raster has only </span><span class="si">{</span><span class="n">band_count</span><span class="si">}</span><span class="s2"> bands, may not be Sentinel-2 data&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Get dimensions</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>

            <span class="c1"># Determine which bands to analyze</span>
            <span class="k">if</span> <span class="n">band_selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">band_selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">band_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 1-indexed</span>

            <span class="c1"># Initialize arrays for band statistics</span>
            <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Sample random pixels</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># For reproducibility</span>
            <span class="n">sample_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
            <span class="n">sample_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

            <span class="c1"># Calculate statistics for each band</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_selection</span><span class="p">:</span>
                <span class="c1"># Read band data</span>
                <span class="n">band_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

                <span class="c1"># Sample values</span>
                <span class="n">sample_values</span> <span class="o">=</span> <span class="n">band_data</span><span class="p">[</span><span class="n">sample_rows</span><span class="p">,</span> <span class="n">sample_cols</span><span class="p">]</span>

                <span class="c1"># Remove invalid values (e.g., nodata)</span>
                <span class="n">valid_samples</span> <span class="o">=</span> <span class="n">sample_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample_values</span><span class="p">)]</span>

                <span class="c1"># Calculate statistics</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_samples</span><span class="p">))</span>
                <span class="n">std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">valid_samples</span><span class="p">))</span>

                <span class="c1"># Store results</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2">: mean=</span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update instance variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">means</span><span class="p">,</span> <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="n">stds</span><span class="p">}</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_sentinel_raster</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_ndvi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">edge_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a Sentinel-2 raster to extract field boundaries.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to Sentinel-2 raster file</span>
<span class="sd">            output_path: Path to output GeoJSON or Parquet file (optional)</span>
<span class="sd">            batch_size: Batch size for processing</span>
<span class="sd">            band_selection: List of bands to use (None = use instance default)</span>
<span class="sd">            use_ndvi: Whether to include NDVI (None = use instance default)</span>
<span class="sd">            filter_edges: Whether to filter out objects at the edges of the image</span>
<span class="sd">            edge_buffer: Size of edge buffer in pixels to filter out objects</span>
<span class="sd">            **kwargs: Additional parameters for processing</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with field boundaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use instance defaults if not specified</span>
        <span class="n">band_selection</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">band_selection</span> <span class="k">if</span> <span class="n">band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span>
        <span class="p">)</span>
        <span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span> <span class="k">if</span> <span class="n">use_ndvi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span>

        <span class="c1"># Get parameters from kwargs or use instance defaults</span>
        <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
        <span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
        <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>
        <span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span><span class="p">)</span>
        <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
        <span class="n">min_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span><span class="p">)</span>
        <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simplify_tolerance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span><span class="p">)</span>

        <span class="c1"># Update band statistics if not already done</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;update_stats&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_band_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">band_selection</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing with parameters:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Using bands: </span><span class="si">{</span><span class="n">band_selection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Include NDVI: </span><span class="si">{</span><span class="n">use_ndvi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Confidence threshold: </span><span class="si">{</span><span class="n">confidence_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Tile overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Chip size: </span><span class="si">{</span><span class="n">chip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Filter edge objects: </span><span class="si">{</span><span class="n">filter_edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a custom Sentinel-2 dataset class</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">Sentinel2Dataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">chip_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                <span class="n">stride_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">stride_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">band_selection</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                <span class="n">use_ndvi</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">field_delineator</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span> <span class="o">=</span> <span class="n">raster_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span> <span class="o">=</span> <span class="n">chip_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span> <span class="o">=</span> <span class="n">stride_x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span> <span class="o">=</span> <span class="n">stride_y</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span> <span class="o">=</span> <span class="n">band_selection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_delineator</span> <span class="o">=</span> <span class="n">field_delineator</span>

                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

                    <span class="c1"># Calculate row_starts and col_starts</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># Normal row starts using stride</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">)</span>

                    <span class="c1"># Add a special last row that ensures we reach the bottom edge</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the image is smaller than chip size, just start at 0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># Normal column starts using stride</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">)</span>

                    <span class="c1"># Add a special last column that ensures we reach the right edge</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the image is smaller than chip size, just start at 0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Calculate number of tiles</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Dataset initialized with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="si">}</span><span class="s2"> rows and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="si">}</span><span class="s2"> columns of chips&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chip size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>

            <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
                <span class="c1"># Convert flat index to grid position</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>

                <span class="c1"># Get pre-calculated starting positions</span>
                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

                <span class="c1"># Read window from raster</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="c1"># Make sure we don&#39;t read outside the image</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>

                    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

                    <span class="c1"># Read all bands</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                    <span class="c1"># Handle partial windows at edges by padding</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">temp</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="n">image</span> <span class="o">=</span> <span class="n">temp</span>

                <span class="c1"># Preprocess bands for the model</span>
                <span class="n">image_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_delineator</span><span class="o">.</span><span class="n">preprocess_sentinel_bands</span><span class="p">(</span>
                    <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span>
                <span class="p">)</span>

                <span class="c1"># Get geographic bounds for the window</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
                    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">bbox</span> <span class="o">=</span> <span class="p">[</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">]</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_tensor</span><span class="p">,</span>
                    <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
                    <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
                    <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
                <span class="p">}</span>

        <span class="c1"># Calculate stride based on overlap</span>
        <span class="n">stride_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>
        <span class="n">stride_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>

        <span class="c1"># Create dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Sentinel2Dataset</span><span class="p">(</span>
            <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
            <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
            <span class="n">stride_x</span><span class="o">=</span><span class="n">stride_x</span><span class="p">,</span>
            <span class="n">stride_y</span><span class="o">=</span><span class="n">stride_y</span><span class="p">,</span>
            <span class="n">band_selection</span><span class="o">=</span><span class="n">band_selection</span><span class="p">,</span>
            <span class="n">use_ndvi</span><span class="o">=</span><span class="n">use_ndvi</span><span class="p">,</span>
            <span class="n">field_delineator</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Define custom collate function</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t collate bbox objects, keep as list</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For tensors and other collatable types</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="c1"># Fall back to list for non-collatable types</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default collate for non-dict types</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="c1"># Create dataloader</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Process batches (call the parent class&#39;s process_raster method)</span>
        <span class="c1"># We&#39;ll adapt the process_raster method to work with our Sentinel2Dataset</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_raster</span><span class="p">(</span>
            <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">filter_edges</span><span class="o">=</span><span class="n">filter_edges</span><span class="p">,</span>
            <span class="n">edge_buffer</span><span class="o">=</span><span class="n">edge_buffer</span><span class="p">,</span>
            <span class="n">confidence_threshold</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
            <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span><span class="p">,</span>
            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
            <span class="n">min_object_area</span><span class="o">=</span><span class="n">min_object_area</span><span class="p">,</span>
            <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.AgricultureFieldDelineator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;field_boundary_detector.pth&#39;</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ndvi</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.geoai.AgricultureFieldDelineator.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the field boundary delineator.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>&#39;field_boundary_detector.pth&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repo ID for loading models from the Hub.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom model to use for inference.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_selection</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Sentinel-2 band indices to use (None = adapt based on model)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ndvi</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to calculate and include NDVI as an additional channel</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;field_boundary_detector.pth&quot;</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_ndvi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the field boundary delineator.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">        model: Custom model to use for inference.</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        band_selection: List of Sentinel-2 band indices to use (None = adapt based on model)</span>
<span class="sd">        use_ndvi: Whether to calculate and include NDVI as an additional channel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Save parameters before calling parent constructor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span> <span class="o">=</span> <span class="n">band_selection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span>

    <span class="c1"># Set device (copied from parent init to ensure it&#39;s set before initialize_model)</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Initialize model differently for multi-spectral input</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_sentinel2_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Call parent but with our custom model</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="c1"># Default Sentinel-2 band statistics (can be overridden with actual stats)</span>
    <span class="c1"># Band order: [B1, B2, B3, B4, B5, B6, B7, B8, B8A, B9, B10, B11, B12]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="mf">0.0975</span><span class="p">,</span>
            <span class="mf">0.0476</span><span class="p">,</span>
            <span class="mf">0.0598</span><span class="p">,</span>
            <span class="mf">0.0697</span><span class="p">,</span>
            <span class="mf">0.1077</span><span class="p">,</span>
            <span class="mf">0.1859</span><span class="p">,</span>
            <span class="mf">0.2378</span><span class="p">,</span>
            <span class="mf">0.2061</span><span class="p">,</span>
            <span class="mf">0.2598</span><span class="p">,</span>
            <span class="mf">0.4120</span><span class="p">,</span>
            <span class="mf">0.1956</span><span class="p">,</span>
            <span class="mf">0.1410</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="mf">0.0551</span><span class="p">,</span>
            <span class="mf">0.0290</span><span class="p">,</span>
            <span class="mf">0.0298</span><span class="p">,</span>
            <span class="mf">0.0479</span><span class="p">,</span>
            <span class="mf">0.0506</span><span class="p">,</span>
            <span class="mf">0.0505</span><span class="p">,</span>
            <span class="mf">0.0747</span><span class="p">,</span>
            <span class="mf">0.0642</span><span class="p">,</span>
            <span class="mf">0.0782</span><span class="p">,</span>
            <span class="mf">0.1187</span><span class="p">,</span>
            <span class="mf">0.0651</span><span class="p">,</span>
            <span class="mf">0.0679</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># Set default band selection (RGB - typically B4, B3, B2 for Sentinel-2)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># R, G, B bands</span>

    <span class="c1"># Customize parameters for field delineation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Default confidence threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Higher overlap for field boundary detection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Minimum area in pixels for field detection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Higher tolerance for field boundaries</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.AgricultureFieldDelineator.initialize_sentinel2_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_sentinel2_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.AgricultureFieldDelineator.initialize_sentinel2_model" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize a Mask R-CNN model with a modified first layer to accept Sentinel-2 data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pre-initialized model (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Modified model with appropriate input channels</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_sentinel2_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a Mask R-CNN model with a modified first layer to accept Sentinel-2 data.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Pre-initialized model (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Modified model with appropriate input channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">maskrcnn_resnet50_fpn</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.detection.backbone_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">resnet_fpn_backbone</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="c1"># Determine number of input channels based on band selection and NDVI</span>
    <span class="n">num_input_channels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="mi">3</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span><span class="p">:</span>
        <span class="n">num_input_channels</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Mask R-CNN model with </span><span class="si">{</span><span class="n">num_input_channels</span><span class="si">}</span><span class="s2"> input channels&quot;</span><span class="p">)</span>

    <span class="c1"># Create a ResNet50 backbone with modified input channels</span>
    <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet_fpn_backbone</span><span class="p">(</span><span class="s2">&quot;resnet50&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Replace the first conv layer to accept multi-spectral input</span>
    <span class="n">original_conv</span> <span class="o">=</span> <span class="n">backbone</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">conv1</span>
    <span class="n">backbone</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
        <span class="n">num_input_channels</span><span class="p">,</span>
        <span class="n">original_conv</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">stride</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
        <span class="n">bias</span><span class="o">=</span><span class="n">original_conv</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create Mask R-CNN with our modified backbone</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">maskrcnn_resnet50_fpn</span><span class="p">(</span>
        <span class="n">backbone</span><span class="o">=</span><span class="n">backbone</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Background + field</span>
        <span class="n">image_mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_input_channels</span><span class="p">,</span>  <span class="c1"># Extend mean to all channels</span>
        <span class="n">image_std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_input_channels</span><span class="p">,</span>  <span class="c1"># Extend std to all channels</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.AgricultureFieldDelineator.preprocess_sentinel_bands" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preprocess_sentinel_bands</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">band_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ndvi</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.AgricultureFieldDelineator.preprocess_sentinel_bands" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Preprocess Sentinel-2 band data for model input.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_data</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Raw Sentinel-2 image data as numpy array [bands, height, width]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_selection</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices to use (overrides instance default if provided)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ndvi</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include NDVI (overrides instance default if provided)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed tensor ready for model input</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_sentinel_bands</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_ndvi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess Sentinel-2 band data for model input.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_data: Raw Sentinel-2 image data as numpy array [bands, height, width]</span>
<span class="sd">        band_selection: List of band indices to use (overrides instance default if provided)</span>
<span class="sd">        use_ndvi: Whether to include NDVI (overrides instance default if provided)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Processed tensor ready for model input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use instance defaults if not specified</span>
    <span class="n">band_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">band_selection</span> <span class="k">if</span> <span class="n">band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span>
    <span class="p">)</span>
    <span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span> <span class="k">if</span> <span class="n">use_ndvi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span>

    <span class="c1"># Select bands</span>
    <span class="n">selected_bands</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">band_selection</span><span class="p">]</span>

    <span class="c1"># Calculate NDVI if requested (using B8 and B4 which are indices 7 and 3)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">use_ndvi</span>
        <span class="ow">and</span> <span class="mi">7</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">):</span>
        <span class="n">nir</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># B8 (NIR)</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># B4 (Red)</span>

        <span class="c1"># Avoid division by zero</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">nir</span> <span class="o">+</span> <span class="n">red</span>
        <span class="n">ndvi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nir</span><span class="p">)</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">denominator</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">ndvi</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">red</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">[</span>
            <span class="n">valid_mask</span>
        <span class="p">]</span>

        <span class="c1"># Rescale NDVI from [-1, 1] to [0, 1]</span>
        <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndvi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Add NDVI as an additional channel</span>
        <span class="n">selected_bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">selected_bands</span><span class="p">,</span> <span class="n">ndvi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]])</span>

    <span class="c1"># Convert to tensor</span>
    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">selected_bands</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="c1"># Normalize using band statistics</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">band_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_selection</span><span class="p">):</span>
        <span class="c1"># Make sure band_idx is within range of our statistics</span>
        <span class="k">if</span> <span class="n">band_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">]):</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">]</span>
            <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span><span class="p">[</span><span class="s2">&quot;stds&quot;</span><span class="p">][</span><span class="n">band_idx</span><span class="p">]</span>
            <span class="n">image_tensor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_tensor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>

    <span class="c1"># If NDVI was added, normalize it too (last channel)</span>
    <span class="k">if</span> <span class="n">use_ndvi</span><span class="p">:</span>
        <span class="c1"># NDVI is already roughly in [0,1] range, just standardize it slightly</span>
        <span class="n">image_tensor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_tensor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">image_tensor</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.AgricultureFieldDelineator.process_sentinel_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_sentinel_raster</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">band_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ndvi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.AgricultureFieldDelineator.process_sentinel_raster" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a Sentinel-2 raster to extract field boundaries.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to Sentinel-2 raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output GeoJSON or Parquet file (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for processing</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_selection</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of bands to use (None = use instance default)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ndvi</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include NDVI (None = use instance default)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filter_edges</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to filter out objects at the edges of the image</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edge_buffer</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of edge buffer in pixels to filter out objects</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for processing</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with field boundaries</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_sentinel_raster</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_ndvi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filter_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">edge_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a Sentinel-2 raster to extract field boundaries.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to Sentinel-2 raster file</span>
<span class="sd">        output_path: Path to output GeoJSON or Parquet file (optional)</span>
<span class="sd">        batch_size: Batch size for processing</span>
<span class="sd">        band_selection: List of bands to use (None = use instance default)</span>
<span class="sd">        use_ndvi: Whether to include NDVI (None = use instance default)</span>
<span class="sd">        filter_edges: Whether to filter out objects at the edges of the image</span>
<span class="sd">        edge_buffer: Size of edge buffer in pixels to filter out objects</span>
<span class="sd">        **kwargs: Additional parameters for processing</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with field boundaries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use instance defaults if not specified</span>
    <span class="n">band_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">band_selection</span> <span class="k">if</span> <span class="n">band_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span>
    <span class="p">)</span>
    <span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span> <span class="k">if</span> <span class="n">use_ndvi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span>

    <span class="c1"># Get parameters from kwargs or use instance defaults</span>
    <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
    <span class="p">)</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
    <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>
    <span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span><span class="p">)</span>
    <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
    <span class="n">min_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span><span class="p">)</span>
    <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simplify_tolerance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span><span class="p">)</span>

    <span class="c1"># Update band statistics if not already done</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;update_stats&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_band_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">band_selection</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing with parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Using bands: </span><span class="si">{</span><span class="n">band_selection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Include NDVI: </span><span class="si">{</span><span class="n">use_ndvi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Confidence threshold: </span><span class="si">{</span><span class="n">confidence_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Tile overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Chip size: </span><span class="si">{</span><span class="n">chip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Filter edge objects: </span><span class="si">{</span><span class="n">filter_edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create a custom Sentinel-2 dataset class</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Sentinel2Dataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">chip_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
            <span class="n">stride_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">stride_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">band_selection</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
            <span class="n">use_ndvi</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">field_delineator</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span> <span class="o">=</span> <span class="n">raster_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span> <span class="o">=</span> <span class="n">chip_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span> <span class="o">=</span> <span class="n">stride_x</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span> <span class="o">=</span> <span class="n">stride_y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span> <span class="o">=</span> <span class="n">band_selection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span> <span class="o">=</span> <span class="n">use_ndvi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_delineator</span> <span class="o">=</span> <span class="n">field_delineator</span>

            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

                <span class="c1"># Calculate row_starts and col_starts</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Normal row starts using stride</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">)</span>

                <span class="c1"># Add a special last row that ensures we reach the bottom edge</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the image is smaller than chip size, just start at 0</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Normal column starts using stride</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">)</span>

                <span class="c1"># Add a special last column that ensures we reach the right edge</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the image is smaller than chip size, just start at 0</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Calculate number of tiles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dataset initialized with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="si">}</span><span class="s2"> rows and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="si">}</span><span class="s2"> columns of chips&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chip size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="c1"># Convert flat index to grid position</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>

            <span class="c1"># Get pre-calculated starting positions</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

            <span class="c1"># Read window from raster</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># Make sure we don&#39;t read outside the image</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>

                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

                <span class="c1"># Read all bands</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Handle partial windows at edges by padding</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">temp</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">image</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="c1"># Preprocess bands for the model</span>
            <span class="n">image_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_delineator</span><span class="o">.</span><span class="n">preprocess_sentinel_bands</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_selection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ndvi</span>
            <span class="p">)</span>

            <span class="c1"># Get geographic bounds for the window</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
                <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="p">[</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">]</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_tensor</span><span class="p">,</span>
                <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
                <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
                <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="c1"># Calculate stride based on overlap</span>
    <span class="n">stride_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>
    <span class="n">stride_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>

    <span class="c1"># Create dataset</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">Sentinel2Dataset</span><span class="p">(</span>
        <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
        <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
        <span class="n">stride_x</span><span class="o">=</span><span class="n">stride_x</span><span class="p">,</span>
        <span class="n">stride_y</span><span class="o">=</span><span class="n">stride_y</span><span class="p">,</span>
        <span class="n">band_selection</span><span class="o">=</span><span class="n">band_selection</span><span class="p">,</span>
        <span class="n">use_ndvi</span><span class="o">=</span><span class="n">use_ndvi</span><span class="p">,</span>
        <span class="n">field_delineator</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Define custom collate function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t collate bbox objects, keep as list</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For tensors and other collatable types</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="c1"># Fall back to list for non-collatable types</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default collate for non-dict types</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># Create dataloader</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Process batches (call the parent class&#39;s process_raster method)</span>
    <span class="c1"># We&#39;ll adapt the process_raster method to work with our Sentinel2Dataset</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_raster</span><span class="p">(</span>
        <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">filter_edges</span><span class="o">=</span><span class="n">filter_edges</span><span class="p">,</span>
        <span class="n">edge_buffer</span><span class="o">=</span><span class="n">edge_buffer</span><span class="p">,</span>
        <span class="n">confidence_threshold</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
        <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
        <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span><span class="p">,</span>
        <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
        <span class="n">min_object_area</span><span class="o">=</span><span class="n">min_object_area</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.AgricultureFieldDelineator.update_band_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_band_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">band_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code>

<a href="#geoai.geoai.AgricultureFieldDelineator.update_band_stats" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update band statistics from the input Sentinel-2 raster.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the Sentinel-2 raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_selection</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific bands to update (None = update all available)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of random pixels to sample for statistics calculation</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated band statistics dictionary</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_band_stats</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">band_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update band statistics from the input Sentinel-2 raster.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to the Sentinel-2 raster file</span>
<span class="sd">        band_selection: Specific bands to update (None = update all available)</span>
<span class="sd">        sample_size: Number of random pixels to sample for statistics calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated band statistics dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Check if this is likely a Sentinel-2 product</span>
        <span class="n">band_count</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>
        <span class="k">if</span> <span class="n">band_count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Raster has only </span><span class="si">{</span><span class="n">band_count</span><span class="si">}</span><span class="s2"> bands, may not be Sentinel-2 data&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get dimensions</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>

        <span class="c1"># Determine which bands to analyze</span>
        <span class="k">if</span> <span class="n">band_selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">band_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 1-indexed</span>

        <span class="c1"># Initialize arrays for band statistics</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Sample random pixels</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># For reproducibility</span>
        <span class="n">sample_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
        <span class="n">sample_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="c1"># Calculate statistics for each band</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_selection</span><span class="p">:</span>
            <span class="c1"># Read band data</span>
            <span class="n">band_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

            <span class="c1"># Sample values</span>
            <span class="n">sample_values</span> <span class="o">=</span> <span class="n">band_data</span><span class="p">[</span><span class="n">sample_rows</span><span class="p">,</span> <span class="n">sample_cols</span><span class="p">]</span>

            <span class="c1"># Remove invalid values (e.g., nodata)</span>
            <span class="n">valid_samples</span> <span class="o">=</span> <span class="n">sample_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample_values</span><span class="p">)]</span>

            <span class="c1"># Calculate statistics</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_samples</span><span class="p">))</span>
            <span class="n">std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">valid_samples</span><span class="p">))</span>

            <span class="c1"># Store results</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2">: mean=</span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">means</span><span class="p">,</span> <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="n">stds</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_band_stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.BoundingBox" class="doc doc-heading">
            <code>BoundingBox</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#geoai.geoai.BoundingBox" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Represents a bounding box with coordinates.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/segment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BoundingBox</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a bounding box with coordinates.&quot;&quot;&quot;</span>

    <span class="n">xmin</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">ymin</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">xmax</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">ymax</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xyxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.BuildingFootprintExtractor" class="doc doc-heading">
            <code>BuildingFootprintExtractor</code>


<a href="#geoai.geoai.BuildingFootprintExtractor" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ObjectDetector (geoai.extract.ObjectDetector)" href="../extract/#geoai.extract.ObjectDetector">ObjectDetector</a></code></p>


        <p>Building footprint extraction using a pre-trained Mask R-CNN model.</p>
<p>This class extends the
<code>ObjectDetector</code> class with additional methods for building footprint extraction."</p>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BuildingFootprintExtractor</span><span class="p">(</span><span class="n">ObjectDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Building footprint extraction using a pre-trained Mask R-CNN model.</span>

<span class="sd">    This class extends the</span>
<span class="sd">    `ObjectDetector` class with additional methods for building footprint extraction.&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;building_footprints_usa.pth&quot;</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object extractor.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">            model: Custom model to use for inference.</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">regularize_buildings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">min_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">orthogonality_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="n">rectangularity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regularize building footprints to enforce right angles and rectangular shapes.</span>

<span class="sd">        Args:</span>
<span class="sd">            gdf: GeoDataFrame with building footprints</span>
<span class="sd">            min_area: Minimum area in square units to keep a building</span>
<span class="sd">            angle_threshold: Maximum deviation from 90 degrees to consider an angle as orthogonal (degrees)</span>
<span class="sd">            orthogonality_threshold: Percentage of angles that must be orthogonal for a building to be regularized</span>
<span class="sd">            rectangularity_threshold: Minimum area ratio to building&#39;s oriented bounding box for rectangular simplification</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with regularized building footprints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularize_objects</span><span class="p">(</span>
            <span class="n">gdf</span><span class="p">,</span>
            <span class="n">min_area</span><span class="o">=</span><span class="n">min_area</span><span class="p">,</span>
            <span class="n">angle_threshold</span><span class="o">=</span><span class="n">angle_threshold</span><span class="p">,</span>
            <span class="n">orthogonality_threshold</span><span class="o">=</span><span class="n">orthogonality_threshold</span><span class="p">,</span>
            <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="n">rectangularity_threshold</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.BuildingFootprintExtractor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;building_footprints_usa.pth&#39;</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.BuildingFootprintExtractor.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the object extractor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>&#39;building_footprints_usa.pth&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repo ID for loading models from the Hub.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom model to use for inference.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;building_footprints_usa.pth&quot;</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the object extractor.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">        model: Custom model to use for inference.</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.BuildingFootprintExtractor.regularize_buildings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regularize_buildings</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">orthogonality_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span></code>

<a href="#geoai.geoai.BuildingFootprintExtractor.regularize_buildings" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Regularize building footprints to enforce right angles and rectangular shapes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>gdf</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with building footprints</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in square units to keep a building</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle_threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum deviation from 90 degrees to consider an angle as orthogonal (degrees)</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orthogonality_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentage of angles that must be orthogonal for a building to be regularized</p>
              </div>
            </td>
            <td>
                  <code>0.3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rectangularity_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area ratio to building's oriented bounding box for rectangular simplification</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">regularize_buildings</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
    <span class="n">min_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">orthogonality_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="n">rectangularity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regularize building footprints to enforce right angles and rectangular shapes.</span>

<span class="sd">    Args:</span>
<span class="sd">        gdf: GeoDataFrame with building footprints</span>
<span class="sd">        min_area: Minimum area in square units to keep a building</span>
<span class="sd">        angle_threshold: Maximum deviation from 90 degrees to consider an angle as orthogonal (degrees)</span>
<span class="sd">        orthogonality_threshold: Percentage of angles that must be orthogonal for a building to be regularized</span>
<span class="sd">        rectangularity_threshold: Minimum area ratio to building&#39;s oriented bounding box for rectangular simplification</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularize_objects</span><span class="p">(</span>
        <span class="n">gdf</span><span class="p">,</span>
        <span class="n">min_area</span><span class="o">=</span><span class="n">min_area</span><span class="p">,</span>
        <span class="n">angle_threshold</span><span class="o">=</span><span class="n">angle_threshold</span><span class="p">,</span>
        <span class="n">orthogonality_threshold</span><span class="o">=</span><span class="n">orthogonality_threshold</span><span class="p">,</span>
        <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="n">rectangularity_threshold</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.CLIPSegmentation" class="doc doc-heading">
            <code>CLIPSegmentation</code>


<a href="#geoai.geoai.CLIPSegmentation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>A class for segmenting high-resolution satellite imagery using text prompts with CLIP-based models.</p>
<p>This segmenter utilizes the CLIP-Seg model to perform semantic segmentation based on text prompts.
It can process large GeoTIFF files by tiling them and handles proper georeferencing in the output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the CLIP-Seg model to use. Defaults to "CIDAS/clipseg-rd64-refined".</p>
              </div>
            </td>
            <td>
                  <code>&#39;CIDAS/clipseg-rd64-refined&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run the model on ('cuda', 'cpu'). If None, will use CUDA if available.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles to process the image in chunks. Defaults to 352.</p>
              </div>
            </td>
            <td>
                  <code>512</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles to avoid edge artifacts. Defaults to 16.</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CLIPSegmentation.processor">processor</span></code></td>
            <td>
                  <code><span title="transformers.CLIPSegProcessor">CLIPSegProcessor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The processor for the CLIP-Seg model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CLIPSegmentation.model">model</span></code></td>
            <td>
                  <code><span title="transformers.CLIPSegForImageSegmentation">CLIPSegForImageSegmentation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The CLIP-Seg model for segmentation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CLIPSegmentation.device">device</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device being used ('cuda' or 'cpu').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CLIPSegmentation.tile_size">tile_size</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles for processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CLIPSegmentation.overlap">overlap</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>geoai/segment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CLIPSegmentation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for segmenting high-resolution satellite imagery using text prompts with CLIP-based models.</span>

<span class="sd">    This segmenter utilizes the CLIP-Seg model to perform semantic segmentation based on text prompts.</span>
<span class="sd">    It can process large GeoTIFF files by tiling them and handles proper georeferencing in the output.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name (str): Name of the CLIP-Seg model to use. Defaults to &quot;CIDAS/clipseg-rd64-refined&quot;.</span>
<span class="sd">        device (str): Device to run the model on (&#39;cuda&#39;, &#39;cpu&#39;). If None, will use CUDA if available.</span>
<span class="sd">        tile_size (int): Size of tiles to process the image in chunks. Defaults to 352.</span>
<span class="sd">        overlap (int): Overlap between tiles to avoid edge artifacts. Defaults to 16.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        processor (CLIPSegProcessor): The processor for the CLIP-Seg model.</span>
<span class="sd">        model (CLIPSegForImageSegmentation): The CLIP-Seg model for segmentation.</span>
<span class="sd">        device (str): The device being used (&#39;cuda&#39; or &#39;cpu&#39;).</span>
<span class="sd">        tile_size (int): Size of tiles for processing.</span>
<span class="sd">        overlap (int): Overlap between tiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIDAS/clipseg-rd64-refined&quot;</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
        <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ImageSegmenter with the specified model and settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (str): Name of the CLIP-Seg model to use. Defaults to &quot;CIDAS/clipseg-rd64-refined&quot;.</span>
<span class="sd">            device (str): Device to run the model on (&#39;cuda&#39;, &#39;cpu&#39;). If None, will use CUDA if available.</span>
<span class="sd">            tile_size (int): Size of tiles to process the image in chunks. Defaults to 512.</span>
<span class="sd">            overlap (int): Overlap between tiles to avoid edge artifacts. Defaults to 32.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">=</span> <span class="n">tile_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>

        <span class="c1"># Set device</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

        <span class="c1"># Load model and processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">CLIPSegProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">CLIPSegForImageSegmentation</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model loaded on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">segment_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">text_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">smoothing_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Segment a GeoTIFF image using the provided text prompt.</span>

<span class="sd">        The function processes the image in tiles and saves the result as a GeoTIFF with two bands:</span>
<span class="sd">        - Band 1: Binary segmentation mask (0 or 1)</span>
<span class="sd">        - Band 2: Probability scores (0.0 to 1.0)</span>

<span class="sd">        Args:</span>
<span class="sd">            input_path (str): Path to the input GeoTIFF file.</span>
<span class="sd">            output_path (str): Path where the output GeoTIFF will be saved.</span>
<span class="sd">            text_prompt (str): Text description of what to segment (e.g., &quot;water&quot;, &quot;buildings&quot;).</span>
<span class="sd">            threshold (float): Threshold for binary segmentation (0.0 to 1.0). Defaults to 0.5.</span>
<span class="sd">            smoothing_sigma (float): Sigma value for Gaussian smoothing to reduce blockiness. Defaults to 1.0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Path to the saved output file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open the input GeoTIFF</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Get metadata</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>

            <span class="c1"># Create output metadata</span>
            <span class="n">out_meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

            <span class="c1"># Create arrays for results</span>
            <span class="n">segmentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Calculate effective tile size (accounting for overlap)</span>
            <span class="n">effective_tile_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>

            <span class="c1"># Calculate number of tiles</span>
            <span class="n">n_tiles_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
            <span class="n">n_tiles_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
            <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">n_tiles_x</span> <span class="o">*</span> <span class="n">n_tiles_y</span>

            <span class="c1"># Process tiles with tqdm progress bar</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_tiles</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tiles&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="c1"># Iterate through tiles</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_y</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_x</span><span class="p">):</span>
                        <span class="c1"># Calculate tile coordinates with overlap</span>
                        <span class="n">x_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                        <span class="n">y_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                        <span class="n">x_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                        <span class="n">y_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                            <span class="n">height</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                        <span class="p">)</span>

                        <span class="n">tile_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>
                        <span class="n">tile_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>

                        <span class="c1"># Read the tile</span>
                        <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">)</span>
                        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                        <span class="c1"># Process the tile</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Convert to RGB if necessary (handling different satellite bands)</span>
                            <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="c1"># Use first three bands for RGB representation</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="c1"># Normalize data to 0-255 range if needed</span>
                                <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                        <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                        <span class="o">*</span> <span class="mi">255</span>
                                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># Create RGB from grayscale</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                                    <span class="n">tile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
                                <span class="p">)</span>
                                <span class="c1"># Normalize if needed</span>
                                <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                        <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                        <span class="o">*</span> <span class="mi">255</span>
                                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Already 3-channel, assume RGB</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="c1"># Normalize if needed</span>
                                <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                        <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                        <span class="o">*</span> <span class="mi">255</span>
                                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                            <span class="c1"># Convert to PIL Image</span>
                            <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_tile</span><span class="p">)</span>

                            <span class="c1"># Resize if needed to match model&#39;s requirements</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">pil_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span>
                                <span class="ow">or</span> <span class="n">pil_image</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span>
                            <span class="p">):</span>
                                <span class="c1"># Keep aspect ratio - use LANCZOS resampling instead of deprecated constant</span>
                                <span class="n">pil_image</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span>
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span><span class="p">),</span>
                                    <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">,</span>
                                <span class="p">)</span>

                            <span class="c1"># Process with CLIP-Seg</span>
                            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
                                <span class="n">text</span><span class="o">=</span><span class="n">text_prompt</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                            <span class="c1"># Forward pass</span>
                            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

                            <span class="c1"># Get logits and resize to original tile size</span>
                            <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="c1"># Convert logits to probabilities with sigmoid</span>
                            <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                            <span class="c1"># Resize back to original tile size if needed</span>
                            <span class="k">if</span> <span class="n">probs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tile_height</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">):</span>
                                <span class="c1"># Use bicubic interpolation for smoother results</span>
                                <span class="n">probs_resized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                                        <span class="p">(</span><span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">),</span>
                                        <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">probs_resized</span> <span class="o">=</span> <span class="n">probs</span>

                            <span class="c1"># Apply gaussian blur to reduce blockiness</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>

                                <span class="n">probs_resized</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
                                    <span class="n">probs_resized</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">smoothing_sigma</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                                <span class="k">pass</span>  <span class="c1"># Continue without smoothing if scipy is not available</span>

                            <span class="c1"># Store results in the full arrays</span>
                            <span class="c1"># Only store the non-overlapping part (except at edges)</span>
                            <span class="n">valid_x_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">valid_y_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">valid_x_end</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">tile_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                                <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n_tiles_x</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="k">else</span> <span class="n">tile_width</span>
                            <span class="p">)</span>
                            <span class="n">valid_y_end</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">tile_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                                <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">n_tiles_y</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="k">else</span> <span class="n">tile_height</span>
                            <span class="p">)</span>

                            <span class="n">dest_x_start</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_start</span>
                            <span class="n">dest_y_start</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_start</span>
                            <span class="n">dest_x_end</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_end</span>
                            <span class="n">dest_y_end</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_end</span>

                            <span class="c1"># Store probabilities</span>
                            <span class="n">probabilities</span><span class="p">[</span>
                                <span class="n">dest_y_start</span><span class="p">:</span><span class="n">dest_y_end</span><span class="p">,</span> <span class="n">dest_x_start</span><span class="p">:</span><span class="n">dest_x_end</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">probs_resized</span><span class="p">[</span>
                                <span class="n">valid_y_start</span><span class="p">:</span><span class="n">valid_y_end</span><span class="p">,</span> <span class="n">valid_x_start</span><span class="p">:</span><span class="n">valid_x_end</span>
                            <span class="p">]</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing tile at (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># Continue with next tile</span>

                        <span class="c1"># Update progress bar</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Create binary segmentation from probabilities</span>
            <span class="n">segmentation</span> <span class="o">=</span> <span class="p">(</span><span class="n">probabilities</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Write the output GeoTIFF</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">segmentation</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Add descriptions to bands</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Binary Segmentation&quot;</span><span class="p">)</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Probability Scores&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">segment_image_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">text_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">smoothing_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_segmented&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Segment multiple GeoTIFF images using the provided text prompt.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_paths (list): List of paths to input GeoTIFF files.</span>
<span class="sd">            output_dir (str): Directory where output GeoTIFFs will be saved.</span>
<span class="sd">            text_prompt (str): Text description of what to segment.</span>
<span class="sd">            threshold (float): Threshold for binary segmentation. Defaults to 0.5.</span>
<span class="sd">            smoothing_sigma (float): Sigma value for Gaussian smoothing to reduce blockiness. Defaults to 1.0.</span>
<span class="sd">            suffix (str): Suffix to add to output filenames. Defaults to &quot;_segmented&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Paths to all saved output files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create output directory if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">output_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each input file</span>
        <span class="k">for</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">input_paths</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing files&quot;</span><span class="p">):</span>
            <span class="c1"># Generate output path</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
            <span class="n">base_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Segment the image</span>
            <span class="n">result_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_image</span><span class="p">(</span>
                <span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">text_prompt</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">smoothing_sigma</span>
            <span class="p">)</span>
            <span class="n">output_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output_paths</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CLIPSegmentation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;CIDAS/clipseg-rd64-refined&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span></code>

<a href="#geoai.geoai.CLIPSegmentation.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the ImageSegmenter with the specified model and settings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the CLIP-Seg model to use. Defaults to "CIDAS/clipseg-rd64-refined".</p>
              </div>
            </td>
            <td>
                  <code>&#39;CIDAS/clipseg-rd64-refined&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run the model on ('cuda', 'cpu'). If None, will use CUDA if available.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles to process the image in chunks. Defaults to 512.</p>
              </div>
            </td>
            <td>
                  <code>512</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles to avoid edge artifacts. Defaults to 32.</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/segment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIDAS/clipseg-rd64-refined&quot;</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the ImageSegmenter with the specified model and settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name (str): Name of the CLIP-Seg model to use. Defaults to &quot;CIDAS/clipseg-rd64-refined&quot;.</span>
<span class="sd">        device (str): Device to run the model on (&#39;cuda&#39;, &#39;cpu&#39;). If None, will use CUDA if available.</span>
<span class="sd">        tile_size (int): Size of tiles to process the image in chunks. Defaults to 512.</span>
<span class="sd">        overlap (int): Overlap between tiles to avoid edge artifacts. Defaults to 32.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">=</span> <span class="n">tile_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>

    <span class="c1"># Set device</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="c1"># Load model and processor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">CLIPSegProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">CLIPSegForImageSegmentation</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model loaded on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CLIPSegmentation.segment_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment_image</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">text_prompt</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">smoothing_sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.geoai.CLIPSegmentation.segment_image" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Segment a GeoTIFF image using the provided text prompt.</p>
<p>The function processes the image in tiles and saves the result as a GeoTIFF with two bands:
- Band 1: Binary segmentation mask (0 or 1)
- Band 2: Probability scores (0.0 to 1.0)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the output GeoTIFF will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text description of what to segment (e.g., "water", "buildings").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for binary segmentation (0.0 to 1.0). Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smoothing_sigma</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sigma value for Gaussian smoothing to reduce blockiness. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved output file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/segment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">segment_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">text_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">smoothing_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segment a GeoTIFF image using the provided text prompt.</span>

<span class="sd">    The function processes the image in tiles and saves the result as a GeoTIFF with two bands:</span>
<span class="sd">    - Band 1: Binary segmentation mask (0 or 1)</span>
<span class="sd">    - Band 2: Probability scores (0.0 to 1.0)</span>

<span class="sd">    Args:</span>
<span class="sd">        input_path (str): Path to the input GeoTIFF file.</span>
<span class="sd">        output_path (str): Path where the output GeoTIFF will be saved.</span>
<span class="sd">        text_prompt (str): Text description of what to segment (e.g., &quot;water&quot;, &quot;buildings&quot;).</span>
<span class="sd">        threshold (float): Threshold for binary segmentation (0.0 to 1.0). Defaults to 0.5.</span>
<span class="sd">        smoothing_sigma (float): Sigma value for Gaussian smoothing to reduce blockiness. Defaults to 1.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the input GeoTIFF</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get metadata</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>

        <span class="c1"># Create output metadata</span>
        <span class="n">out_meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

        <span class="c1"># Create arrays for results</span>
        <span class="n">segmentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Calculate effective tile size (accounting for overlap)</span>
        <span class="n">effective_tile_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>

        <span class="c1"># Calculate number of tiles</span>
        <span class="n">n_tiles_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
        <span class="n">n_tiles_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">n_tiles_x</span> <span class="o">*</span> <span class="n">n_tiles_y</span>

        <span class="c1"># Process tiles with tqdm progress bar</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_tiles</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tiles&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="c1"># Iterate through tiles</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_x</span><span class="p">):</span>
                    <span class="c1"># Calculate tile coordinates with overlap</span>
                    <span class="n">x_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">y_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">x_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">y_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">height</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                    <span class="p">)</span>

                    <span class="n">tile_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>
                    <span class="n">tile_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>

                    <span class="c1"># Read the tile</span>
                    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">)</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                    <span class="c1"># Process the tile</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Convert to RGB if necessary (handling different satellite bands)</span>
                        <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="c1"># Use first three bands for RGB representation</span>
                            <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="c1"># Normalize data to 0-255 range if needed</span>
                            <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">*</span> <span class="mi">255</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Create RGB from grayscale</span>
                            <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                                <span class="n">tile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
                            <span class="p">)</span>
                            <span class="c1"># Normalize if needed</span>
                            <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">*</span> <span class="mi">255</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Already 3-channel, assume RGB</span>
                            <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="c1"># Normalize if needed</span>
                            <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">*</span> <span class="mi">255</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                        <span class="c1"># Convert to PIL Image</span>
                        <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_tile</span><span class="p">)</span>

                        <span class="c1"># Resize if needed to match model&#39;s requirements</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">pil_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span>
                            <span class="ow">or</span> <span class="n">pil_image</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span>
                        <span class="p">):</span>
                            <span class="c1"># Keep aspect ratio - use LANCZOS resampling instead of deprecated constant</span>
                            <span class="n">pil_image</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span><span class="p">),</span>
                                <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">,</span>
                            <span class="p">)</span>

                        <span class="c1"># Process with CLIP-Seg</span>
                        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
                            <span class="n">text</span><span class="o">=</span><span class="n">text_prompt</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                        <span class="c1"># Forward pass</span>
                        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

                        <span class="c1"># Get logits and resize to original tile size</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Convert logits to probabilities with sigmoid</span>
                        <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                        <span class="c1"># Resize back to original tile size if needed</span>
                        <span class="k">if</span> <span class="n">probs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tile_height</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">):</span>
                            <span class="c1"># Use bicubic interpolation for smoother results</span>
                            <span class="n">probs_resized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">),</span>
                                    <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">probs_resized</span> <span class="o">=</span> <span class="n">probs</span>

                        <span class="c1"># Apply gaussian blur to reduce blockiness</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>

                            <span class="n">probs_resized</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
                                <span class="n">probs_resized</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">smoothing_sigma</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                            <span class="k">pass</span>  <span class="c1"># Continue without smoothing if scipy is not available</span>

                        <span class="c1"># Store results in the full arrays</span>
                        <span class="c1"># Only store the non-overlapping part (except at edges)</span>
                        <span class="n">valid_x_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">valid_y_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">valid_x_end</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">tile_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n_tiles_x</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="n">tile_width</span>
                        <span class="p">)</span>
                        <span class="n">valid_y_end</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">tile_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">n_tiles_y</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="n">tile_height</span>
                        <span class="p">)</span>

                        <span class="n">dest_x_start</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_start</span>
                        <span class="n">dest_y_start</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_start</span>
                        <span class="n">dest_x_end</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_end</span>
                        <span class="n">dest_y_end</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_end</span>

                        <span class="c1"># Store probabilities</span>
                        <span class="n">probabilities</span><span class="p">[</span>
                            <span class="n">dest_y_start</span><span class="p">:</span><span class="n">dest_y_end</span><span class="p">,</span> <span class="n">dest_x_start</span><span class="p">:</span><span class="n">dest_x_end</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">probs_resized</span><span class="p">[</span>
                            <span class="n">valid_y_start</span><span class="p">:</span><span class="n">valid_y_end</span><span class="p">,</span> <span class="n">valid_x_start</span><span class="p">:</span><span class="n">valid_x_end</span>
                        <span class="p">]</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing tile at (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Continue with next tile</span>

                    <span class="c1"># Update progress bar</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create binary segmentation from probabilities</span>
        <span class="n">segmentation</span> <span class="o">=</span> <span class="p">(</span><span class="n">probabilities</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Write the output GeoTIFF</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">segmentation</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Add descriptions to bands</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Binary Segmentation&quot;</span><span class="p">)</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Probability Scores&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CLIPSegmentation.segment_image_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment_image_batch</span><span class="p">(</span><span class="n">input_paths</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">text_prompt</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">smoothing_sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_segmented&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.CLIPSegmentation.segment_image_batch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Segment multiple GeoTIFF images using the provided text prompt.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of paths to input GeoTIFF files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where output GeoTIFFs will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text description of what to segment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for binary segmentation. Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smoothing_sigma</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sigma value for Gaussian smoothing to reduce blockiness. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suffix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suffix to add to output filenames. Defaults to "_segmented".</p>
              </div>
            </td>
            <td>
                  <code>&#39;_segmented&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Paths to all saved output files.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/segment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">segment_image_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">text_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">smoothing_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_segmented&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segment multiple GeoTIFF images using the provided text prompt.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_paths (list): List of paths to input GeoTIFF files.</span>
<span class="sd">        output_dir (str): Directory where output GeoTIFFs will be saved.</span>
<span class="sd">        text_prompt (str): Text description of what to segment.</span>
<span class="sd">        threshold (float): Threshold for binary segmentation. Defaults to 0.5.</span>
<span class="sd">        smoothing_sigma (float): Sigma value for Gaussian smoothing to reduce blockiness. Defaults to 1.0.</span>
<span class="sd">        suffix (str): Suffix to add to output filenames. Defaults to &quot;_segmented&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Paths to all saved output files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">output_paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each input file</span>
    <span class="k">for</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">input_paths</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing files&quot;</span><span class="p">):</span>
        <span class="c1"># Generate output path</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Segment the image</span>
        <span class="n">result_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_image</span><span class="p">(</span>
            <span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">text_prompt</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">smoothing_sigma</span>
        <span class="p">)</span>
        <span class="n">output_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_paths</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.CarDetector" class="doc doc-heading">
            <code>CarDetector</code>


<a href="#geoai.geoai.CarDetector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ObjectDetector (geoai.extract.ObjectDetector)" href="../extract/#geoai.extract.ObjectDetector">ObjectDetector</a></code></p>


        <p>Car detection using a pre-trained Mask R-CNN model.</p>
<p>This class extends the <code>ObjectDetector</code> class with additional methods for car detection.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CarDetector</span><span class="p">(</span><span class="n">ObjectDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Car detection using a pre-trained Mask R-CNN model.</span>

<span class="sd">    This class extends the `ObjectDetector` class with additional methods for car detection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;car_detection_usa.pth&quot;</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object extractor.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">            model: Custom model to use for inference.</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CarDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;car_detection_usa.pth&#39;</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.CarDetector.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the object extractor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>&#39;car_detection_usa.pth&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repo ID for loading models from the Hub.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom model to use for inference.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;car_detection_usa.pth&quot;</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the object extractor.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">        model: Custom model to use for inference.</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.CustomDataset" class="doc doc-heading">
            <code>CustomDataset</code>


<a href="#geoai.geoai.CustomDataset" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torchgeo.datasets.NonGeoDataset">NonGeoDataset</span></code></p>


        <p>A TorchGeo dataset for object extraction with overlapping tiles support.</p>
<p>This dataset class creates overlapping image tiles for object detection,
ensuring complete coverage of the input raster including right and bottom edges.
It inherits from NonGeoDataset to avoid spatial indexing issues.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.raster_path">raster_path</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input raster file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.chip_size">chip_size</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of image chips to extract (height, width).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.overlap">overlap</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Amount of overlap between adjacent tiles (0.0-1.0).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.transforms">transforms</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transforms to apply to the image.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.verbose">verbose</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print detailed processing information.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.stride_x">stride_x</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Horizontal stride between tiles based on overlap.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.stride_y">stride_y</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical stride between tiles based on overlap.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.row_starts">row_starts</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting Y positions for each row of tiles.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.col_starts">col_starts</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting X positions for each column of tiles.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.crs">crs</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system of the raster.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.transform">transform</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Affine transform of the raster.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.height">height</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height of the raster in pixels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.width">width</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width of the raster in pixels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.count">count</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bands in the raster.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.bounds">bounds</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Geographic bounds of the raster (west, south, east, north).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.roi">roi</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shapely box representing the region of interest.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.rows">rows</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rows of tiles.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.cols">cols</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of columns of tiles.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.CustomDataset.raster_stats">raster_stats</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Statistics of the raster.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CustomDataset</span><span class="p">(</span><span class="n">NonGeoDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A TorchGeo dataset for object extraction with overlapping tiles support.</span>

<span class="sd">    This dataset class creates overlapping image tiles for object detection,</span>
<span class="sd">    ensuring complete coverage of the input raster including right and bottom edges.</span>
<span class="sd">    It inherits from NonGeoDataset to avoid spatial indexing issues.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        raster_path: Path to the input raster file.</span>
<span class="sd">        chip_size: Size of image chips to extract (height, width).</span>
<span class="sd">        overlap: Amount of overlap between adjacent tiles (0.0-1.0).</span>
<span class="sd">        transforms: Transforms to apply to the image.</span>
<span class="sd">        verbose: Whether to print detailed processing information.</span>
<span class="sd">        stride_x: Horizontal stride between tiles based on overlap.</span>
<span class="sd">        stride_y: Vertical stride between tiles based on overlap.</span>
<span class="sd">        row_starts: Starting Y positions for each row of tiles.</span>
<span class="sd">        col_starts: Starting X positions for each column of tiles.</span>
<span class="sd">        crs: Coordinate reference system of the raster.</span>
<span class="sd">        transform: Affine transform of the raster.</span>
<span class="sd">        height: Height of the raster in pixels.</span>
<span class="sd">        width: Width of the raster in pixels.</span>
<span class="sd">        count: Number of bands in the raster.</span>
<span class="sd">        bounds: Geographic bounds of the raster (west, south, east, north).</span>
<span class="sd">        roi: Shapely box representing the region of interest.</span>
<span class="sd">        rows: Number of rows of tiles.</span>
<span class="sd">        cols: Number of columns of tiles.</span>
<span class="sd">        raster_stats: Statistics of the raster.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">chip_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
        <span class="n">overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">band_indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the dataset with overlapping tiles.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to the input raster file.</span>
<span class="sd">            chip_size: Size of image chips to extract (height, width). Default is (512, 512).</span>
<span class="sd">            overlap: Amount of overlap between adjacent tiles (0.0-1.0). Default is 0.5 (50%).</span>
<span class="sd">            transforms: Transforms to apply to the image. Default is None.</span>
<span class="sd">            band_indexes: List of band indexes to use. Default is None (use all bands).</span>
<span class="sd">            verbose: Whether to print detailed processing information. Default is False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If overlap is too high resulting in non-positive stride.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Initialize parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span> <span class="o">=</span> <span class="n">raster_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span> <span class="o">=</span> <span class="n">chip_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band_indexes</span> <span class="o">=</span> <span class="n">band_indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Calculate stride based on overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Overlap </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2"> is too high, resulting in non-positive stride&quot;</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>

            <span class="c1"># Define the bounds of the dataset</span>
            <span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

            <span class="c1"># Calculate starting positions for each tile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Normal row starts using stride</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">)</span>

            <span class="c1"># Add a special last row that ensures we reach the bottom edge</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the image is smaller than chip size, just start at 0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Normal column starts using stride</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">)</span>

            <span class="c1"># Add a special last column that ensures we reach the right edge</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the image is smaller than chip size, just start at 0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Update rows and cols based on actual starting positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dataset initialized with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="si">}</span><span class="s2"> rows and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="si">}</span><span class="s2"> columns of chips&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chip size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% (stride_x=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="si">}</span><span class="s2">, stride_y=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get raster stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_stats</span> <span class="o">=</span> <span class="n">get_raster_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an image chip from the dataset by index.</span>

<span class="sd">        Retrieves an image tile with the specified overlap pattern, ensuring</span>
<span class="sd">        proper coverage of the entire raster including edges.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx: Index of the chip to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing:</span>
<span class="sd">                - image: Image tensor.</span>
<span class="sd">                - bbox: Geographic bounding box for the window.</span>
<span class="sd">                - coords: Pixel coordinates as tensor [i, j].</span>
<span class="sd">                - window_size: Window size as tensor [width, height].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert flat index to grid position</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>

        <span class="c1"># Get pre-calculated starting positions</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="c1"># Read window from raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Make sure we don&#39;t read outside the image</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>

            <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

            <span class="c1"># Handle RGBA or multispectral images - keep only first 3 bands</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image has </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bands, using first 3 bands only&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">band_indexes</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># If image has fewer than 3 bands, duplicate the last band to make 3</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Image has </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bands, duplicating bands to make 3&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="c1"># Handle partial windows at edges by padding</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">temp</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">image</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="c1"># Convert to format expected by model (C,H,W)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># Normalize to [0, 1]</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span>

        <span class="c1"># Apply transforms if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Create geographic bounding box for the window</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
            <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
            <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>  <span class="c1"># Consistent format</span>
            <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="p">[</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span>
            <span class="p">),</span>  <span class="c1"># Consistent format</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of samples in the dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Total number of tiles in the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CustomDataset.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></code>

<a href="#geoai.geoai.CustomDataset.__getitem__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get an image chip from the dataset by index.</p>
<p>Retrieves an image tile with the specified overlap pattern, ensuring
proper coverage of the entire raster including edges.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the chip to retrieve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
- image: Image tensor.
- bbox: Geographic bounding box for the window.
- coords: Pixel coordinates as tensor [i, j].
- window_size: Window size as tensor [width, height].</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get an image chip from the dataset by index.</span>

<span class="sd">    Retrieves an image tile with the specified overlap pattern, ensuring</span>
<span class="sd">    proper coverage of the entire raster including edges.</span>

<span class="sd">    Args:</span>
<span class="sd">        idx: Index of the chip to retrieve.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing:</span>
<span class="sd">            - image: Image tensor.</span>
<span class="sd">            - bbox: Geographic bounding box for the window.</span>
<span class="sd">            - coords: Pixel coordinates as tensor [i, j].</span>
<span class="sd">            - window_size: Window size as tensor [width, height].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert flat index to grid position</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>

    <span class="c1"># Get pre-calculated starting positions</span>
    <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="c1"># Read window from raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Make sure we don&#39;t read outside the image</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>

        <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

        <span class="c1"># Handle RGBA or multispectral images - keep only first 3 bands</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image has </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bands, using first 3 bands only&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">band_indexes</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># If image has fewer than 3 bands, duplicate the last band to make 3</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Image has </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bands, duplicating bands to make 3&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="c1"># Handle partial windows at edges by padding</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">temp</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">image</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="c1"># Convert to format expected by model (C,H,W)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="c1"># Normalize to [0, 1]</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span>

    <span class="c1"># Apply transforms if any</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Create geographic bounding box for the window</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
        <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
        <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>  <span class="c1"># Consistent format</span>
        <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="p">[</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span>
        <span class="p">),</span>  <span class="c1"># Consistent format</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CustomDataset.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">chip_size</span><span class="o">=</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.geoai.CustomDataset.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the dataset with overlapping tiles.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input raster file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chip_size</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of image chips to extract (height, width). Default is (512, 512).</p>
              </div>
            </td>
            <td>
                  <code>(512, 512)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Amount of overlap between adjacent tiles (0.0-1.0). Default is 0.5 (50%).</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transforms</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transforms to apply to the image. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indexes to use. Default is None (use all bands).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print detailed processing information. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If overlap is too high resulting in non-positive stride.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">chip_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">band_indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the dataset with overlapping tiles.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to the input raster file.</span>
<span class="sd">        chip_size: Size of image chips to extract (height, width). Default is (512, 512).</span>
<span class="sd">        overlap: Amount of overlap between adjacent tiles (0.0-1.0). Default is 0.5 (50%).</span>
<span class="sd">        transforms: Transforms to apply to the image. Default is None.</span>
<span class="sd">        band_indexes: List of band indexes to use. Default is None (use all bands).</span>
<span class="sd">        verbose: Whether to print detailed processing information. Default is False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If overlap is too high resulting in non-positive stride.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># Initialize parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span> <span class="o">=</span> <span class="n">raster_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span> <span class="o">=</span> <span class="n">chip_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">band_indexes</span> <span class="o">=</span> <span class="n">band_indexes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warned_about_bands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Calculate stride based on overlap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Overlap </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2"> is too high, resulting in non-positive stride&quot;</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>

        <span class="c1"># Define the bounds of the dataset</span>
        <span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

        <span class="c1"># Calculate starting positions for each tile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Normal row starts using stride</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="p">)</span>

        <span class="c1"># Add a special last row that ensures we reach the bottom edge</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the image is smaller than chip size, just start at 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Normal column starts using stride</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="p">)</span>

        <span class="c1"># Add a special last column that ensures we reach the right edge</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the image is smaller than chip size, just start at 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Update rows and cols based on actual starting positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_starts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_starts</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Dataset initialized with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="si">}</span><span class="s2"> rows and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="si">}</span><span class="s2"> columns of chips&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chip size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% (stride_x=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stride_x</span><span class="si">}</span><span class="s2">, stride_y=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stride_y</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get raster stats</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">raster_stats</span> <span class="o">=</span> <span class="n">get_raster_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.CustomDataset.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

<a href="#geoai.geoai.CustomDataset.__len__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the number of samples in the dataset.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of tiles in the dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the number of samples in the dataset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Total number of tiles in the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.DetectionResult" class="doc doc-heading">
            <code>DetectionResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#geoai.geoai.DetectionResult" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Represents a detection result with score, label, bounding box, and optional mask.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/segment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DetectionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a detection result with score, label, bounding box, and optional mask.&quot;&quot;&quot;</span>

    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">box</span><span class="p">:</span> <span class="n">BoundingBox</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">detection_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DetectionResult&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">score</span><span class="o">=</span><span class="n">detection_dict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">detection_dict</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
            <span class="n">box</span><span class="o">=</span><span class="n">BoundingBox</span><span class="p">(</span>
                <span class="n">xmin</span><span class="o">=</span><span class="n">detection_dict</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span>
                <span class="n">ymin</span><span class="o">=</span><span class="n">detection_dict</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">][</span><span class="s2">&quot;ymin&quot;</span><span class="p">],</span>
                <span class="n">xmax</span><span class="o">=</span><span class="n">detection_dict</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">][</span><span class="s2">&quot;xmax&quot;</span><span class="p">],</span>
                <span class="n">ymax</span><span class="o">=</span><span class="n">detection_dict</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">][</span><span class="s2">&quot;ymax&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.GroundedSAM" class="doc doc-heading">
            <code>GroundedSAM</code>


<a href="#geoai.geoai.GroundedSAM" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>A class for segmenting remote sensing imagery using text prompts with Grounding DINO + SAM.</p>
<p>This class combines Grounding DINO for object detection and Segment Anything Model (SAM) for
precise segmentation based on text prompts. It can process large GeoTIFF files by tiling them
and handles proper georeferencing in the outputs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detector_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model ID for Grounding DINO. Defaults to "IDEA-Research/grounding-dino-tiny".</p>
              </div>
            </td>
            <td>
                  <code>&#39;IDEA-Research/grounding-dino-tiny&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segmenter_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model ID for SAM. Defaults to "facebook/sam-vit-base".</p>
              </div>
            </td>
            <td>
                  <code>&#39;facebook/sam-vit-base&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run the models on ('cuda', 'cpu'). If None, will use CUDA if available.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles to process the image in chunks. Defaults to 1024.</p>
              </div>
            </td>
            <td>
                  <code>1024</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles to avoid edge artifacts. Defaults to 128.</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Detection threshold for Grounding DINO. Defaults to 0.3.</p>
              </div>
            </td>
            <td>
                  <code>0.3</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.detector_id">detector_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Grounding DINO model ID.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.segmenter_id">segmenter_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The SAM model ID.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.device">device</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device being used ('cuda' or 'cpu').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.tile_size">tile_size</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles for processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.overlap">overlap</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.threshold">threshold</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Detection threshold.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.object_detector">object_detector</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Grounding DINO pipeline.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.segmentator">segmentator</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The SAM model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="geoai.geoai.GroundedSAM.processor">processor</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The SAM processor.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>geoai/segment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GroundedSAM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for segmenting remote sensing imagery using text prompts with Grounding DINO + SAM.</span>

<span class="sd">    This class combines Grounding DINO for object detection and Segment Anything Model (SAM) for</span>
<span class="sd">    precise segmentation based on text prompts. It can process large GeoTIFF files by tiling them</span>
<span class="sd">    and handles proper georeferencing in the outputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        detector_id (str): Hugging Face model ID for Grounding DINO. Defaults to &quot;IDEA-Research/grounding-dino-tiny&quot;.</span>
<span class="sd">        segmenter_id (str): Hugging Face model ID for SAM. Defaults to &quot;facebook/sam-vit-base&quot;.</span>
<span class="sd">        device (str): Device to run the models on (&#39;cuda&#39;, &#39;cpu&#39;). If None, will use CUDA if available.</span>
<span class="sd">        tile_size (int): Size of tiles to process the image in chunks. Defaults to 1024.</span>
<span class="sd">        overlap (int): Overlap between tiles to avoid edge artifacts. Defaults to 128.</span>
<span class="sd">        threshold (float): Detection threshold for Grounding DINO. Defaults to 0.3.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        detector_id (str): The Grounding DINO model ID.</span>
<span class="sd">        segmenter_id (str): The SAM model ID.</span>
<span class="sd">        device (str): The device being used (&#39;cuda&#39; or &#39;cpu&#39;).</span>
<span class="sd">        tile_size (int): Size of tiles for processing.</span>
<span class="sd">        overlap (int): Overlap between tiles.</span>
<span class="sd">        threshold (float): Detection threshold.</span>
<span class="sd">        object_detector: The Grounding DINO pipeline.</span>
<span class="sd">        segmentator: The SAM model.</span>
<span class="sd">        processor: The SAM processor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">detector_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IDEA-Research/grounding-dino-tiny&quot;</span><span class="p">,</span>
        <span class="n">segmenter_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;facebook/sam-vit-base&quot;</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the GroundedSAM with the specified models and settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            detector_id (str): Hugging Face model ID for Grounding DINO.</span>
<span class="sd">            segmenter_id (str): Hugging Face model ID for SAM.</span>
<span class="sd">            device (str): Device to run the models on (&#39;cuda&#39;, &#39;cpu&#39;).</span>
<span class="sd">            tile_size (int): Size of tiles to process the image in chunks.</span>
<span class="sd">            overlap (int): Overlap between tiles to avoid edge artifacts.</span>
<span class="sd">            threshold (float): Detection threshold for Grounding DINO.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector_id</span> <span class="o">=</span> <span class="n">detector_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segmenter_id</span> <span class="o">=</span> <span class="n">segmenter_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">=</span> <span class="n">tile_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

        <span class="c1"># Set device</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

        <span class="c1"># Load models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_models</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GroundedSAM initialized on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the Grounding DINO and SAM models.&quot;&quot;&quot;</span>
        <span class="c1"># Load Grounding DINO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_detector</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_id</span><span class="p">,</span>
            <span class="n">task</span><span class="o">=</span><span class="s2">&quot;zero-shot-object-detection&quot;</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Load SAM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segmentator</span> <span class="o">=</span> <span class="n">AutoModelForMaskGeneration</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segmenter_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">AutoProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmenter_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DetectionResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use Grounding DINO to detect objects in an image.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (Image.Image): PIL image to detect objects in.</span>
<span class="sd">            labels (List[str]): List of text labels to detect.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[DetectionResult]: List of detection results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure labels end with periods</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_detector</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">candidate_labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">DetectionResult</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_nms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DetectionResult</span><span class="p">],</span> <span class="n">iou_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DetectionResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply Non-Maximum Suppression to remove overlapping detections.</span>

<span class="sd">        Args:</span>
<span class="sd">            detections (List[DetectionResult]): List of detection results.</span>
<span class="sd">            iou_threshold (float): IoU threshold for NMS.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[DetectionResult]: Filtered detection results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">detections</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">detections</span>

        <span class="c1"># Convert to format for NMS</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
            <span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">detection</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span>
                    <span class="n">detection</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span>
                    <span class="n">detection</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span>
                    <span class="n">detection</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Apply NMS using OpenCV</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dnn</span><span class="o">.</span><span class="n">NMSBoxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">detections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DetectionResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract bounding boxes from detection results.&quot;&quot;&quot;</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">xyxy</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">xyxy</span>
            <span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">boxes</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refine_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">masks</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">,</span> <span class="n">polygon_refinement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refine masks from SAM output.&quot;&quot;&quot;</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">(</span><span class="n">masks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">polygon_refinement</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_to_polygon</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">polygon</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_to_mask</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                    <span class="n">masks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">masks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mask_to_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert mask to polygon coordinates.&quot;&quot;&quot;</span>
        <span class="c1"># Find contours in the binary mask</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">contours</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Find the contour with the largest area</span>
        <span class="n">largest_contour</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">)</span>

        <span class="c1"># Extract the vertices of the contour</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">largest_contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">polygon</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_polygon_to_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">image_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert polygon to mask.&quot;&quot;&quot;</span>
        <span class="c1"># Create an empty mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Convert polygon to an array of points</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># Fill the polygon with white color (255)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">pts</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,))</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_separate_instances</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">min_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Separate individual instances from a combined mask using connected components.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (np.ndarray): Combined binary mask.</span>
<span class="sd">            min_area (int): Minimum area threshold for valid instances.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[np.ndarray]: List of individual instance masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find connected components</span>
        <span class="n">num_labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>

        <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">):</span>  <span class="c1"># Skip background (label 0)</span>
            <span class="c1"># Get area of the component</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CC_STAT_AREA</span><span class="p">]</span>

            <span class="c1"># Filter by minimum area</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;=</span> <span class="n">min_area</span><span class="p">:</span>
                <span class="c1"># Create mask for this instance</span>
                <span class="n">instance_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
                <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instances</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mask_to_polygons</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">,</span>
        <span class="n">x_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">y_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">min_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert mask to individual polygons with geospatial coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (np.ndarray): Binary mask.</span>
<span class="sd">            transform: Rasterio transform object.</span>
<span class="sd">            x_offset (int): X offset for tile position.</span>
<span class="sd">            y_offset (int): Y offset for tile position.</span>
<span class="sd">            min_area (int): Minimum area threshold for valid polygons.</span>
<span class="sd">            simplify_tolerance (float): Tolerance for polygon simplification.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: List of polygon dictionaries with geometry and properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get individual instances</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_separate_instances</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">min_area</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">instance_mask</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="c1"># Find contours</span>
            <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                <span class="n">instance_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                <span class="c1"># Filter by minimum area</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Simplify contour</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span>
                <span class="n">simplified_contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Convert to pixel coordinates (add offsets)</span>
                <span class="n">pixel_coords</span> <span class="o">=</span> <span class="n">simplified_contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pixel_coords</span> <span class="o">=</span> <span class="n">pixel_coords</span> <span class="o">+</span> <span class="p">[</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">]</span>

                <span class="c1"># Convert to geographic coordinates</span>
                <span class="n">geo_coords</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">:</span>
                    <span class="n">geo_x</span><span class="p">,</span> <span class="n">geo_y</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">geo_coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">geo_x</span><span class="p">,</span> <span class="n">geo_y</span><span class="p">])</span>

                <span class="c1"># Close the polygon if needed</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geo_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">geo_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">geo_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">geo_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geo_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># Create Shapely polygon</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_coords</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">polygon</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">polygon</span><span class="p">,</span> <span class="s2">&quot;area_pixels&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

        <span class="k">return</span> <span class="n">polygons</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_segment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
        <span class="n">detection_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DetectionResult</span><span class="p">],</span>
        <span class="n">polygon_refinement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DetectionResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use SAM to generate masks for detected objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (Image.Image): PIL image.</span>
<span class="sd">            detection_results (List[DetectionResult]): Detection results from Grounding DINO.</span>
<span class="sd">            polygon_refinement (bool): Whether to refine masks using polygon fitting.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[DetectionResult]: Detection results with masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">detection_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">detection_results</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boxes</span><span class="p">(</span><span class="n">detection_results</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">input_boxes</span><span class="o">=</span><span class="n">boxes</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentator</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">post_process_masks</span><span class="p">(</span>
            <span class="n">masks</span><span class="o">=</span><span class="n">outputs</span><span class="o">.</span><span class="n">pred_masks</span><span class="p">,</span>
            <span class="n">original_sizes</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">original_sizes</span><span class="p">,</span>
            <span class="n">reshaped_input_sizes</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">reshaped_input_sizes</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refine_masks</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">polygon_refinement</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">detection_result</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">detection_results</span><span class="p">,</span> <span class="n">masks</span><span class="p">):</span>
            <span class="n">detection_result</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">detection_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">segment_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">text_prompts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">polygon_refinement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">export_boxes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">export_polygons</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">smoothing_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">nms_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">min_polygon_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Segment a GeoTIFF image using text prompts with improved instance segmentation.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_path (str): Path to the input GeoTIFF file.</span>
<span class="sd">            output_path (str): Path where the output GeoTIFF will be saved.</span>
<span class="sd">            text_prompts (Union[str, List[str]]): Text prompt(s) describing what to segment.</span>
<span class="sd">            polygon_refinement (bool): Whether to refine masks using polygon fitting.</span>
<span class="sd">            export_boxes (bool): Whether to export bounding boxes as a separate vector file.</span>
<span class="sd">            export_polygons (bool): Whether to export segmentation polygons as vector file.</span>
<span class="sd">            smoothing_sigma (float): Sigma value for Gaussian smoothing to reduce blockiness.</span>
<span class="sd">            nms_threshold (float): Non-maximum suppression threshold for removing overlapping detections.</span>
<span class="sd">            min_polygon_area (int): Minimum area in pixels for valid polygons.</span>
<span class="sd">            simplify_tolerance (float): Tolerance for polygon simplification.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Dictionary containing paths to output files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">text_prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_prompts</span><span class="p">]</span>

        <span class="c1"># Open the input GeoTIFF</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Get metadata</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

            <span class="c1"># Create output metadata for segmentation masks</span>
            <span class="n">out_meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span> <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Create arrays for results</span>
            <span class="n">all_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">),</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">all_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Calculate effective tile size (accounting for overlap)</span>
            <span class="n">effective_tile_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>

            <span class="c1"># Calculate number of tiles</span>
            <span class="n">n_tiles_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
            <span class="n">n_tiles_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
            <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">n_tiles_x</span> <span class="o">*</span> <span class="n">n_tiles_y</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">total_tiles</span><span class="si">}</span><span class="s2"> tiles (</span><span class="si">{</span><span class="n">n_tiles_x</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_tiles_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Process tiles with tqdm progress bar</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_tiles</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tiles&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="c1"># Iterate through tiles</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_y</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_x</span><span class="p">):</span>
                        <span class="c1"># Calculate tile coordinates with overlap</span>
                        <span class="n">x_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                        <span class="n">y_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                        <span class="n">x_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                        <span class="n">y_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                            <span class="n">height</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                        <span class="p">)</span>

                        <span class="n">tile_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>
                        <span class="n">tile_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>

                        <span class="c1"># Read the tile</span>
                        <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">)</span>
                        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                        <span class="c1"># Process the tile</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Convert to RGB format for processing</span>
                            <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="c1"># Use first three bands for RGB representation</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># Create RGB from grayscale</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                                    <span class="n">tile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Unsupported number of bands: </span><span class="si">{</span><span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="k">continue</span>

                            <span class="c1"># Normalize to 0-255 range if needed</span>
                            <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                    <span class="o">*</span> <span class="mi">255</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                            <span class="c1"># Convert to PIL Image</span>
                            <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_tile</span><span class="p">)</span>

                            <span class="c1"># Detect objects</span>
                            <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect</span><span class="p">(</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">text_prompts</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">detections</span><span class="p">:</span>
                                <span class="c1"># Apply Non-Maximum Suppression to reduce overlapping detections</span>
                                <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nms</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">detections</span><span class="p">:</span>
                                    <span class="c1"># Segment objects</span>
                                    <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment</span><span class="p">(</span>
                                        <span class="n">pil_image</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">polygon_refinement</span>
                                    <span class="p">)</span>

                                    <span class="c1"># Process results</span>
                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">):</span>
                                        <span class="n">prompt_polygons</span> <span class="o">=</span> <span class="p">[]</span>
                                        <span class="n">prompt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">tile_height</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                                        <span class="p">)</span>

                                        <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="p">(</span>
                                                <span class="n">detection</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                                <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                <span class="o">==</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                            <span class="p">):</span>
                                                <span class="k">if</span> <span class="n">detection</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                                    <span class="c1"># Apply gaussian blur to reduce blockiness</span>
                                                    <span class="k">try</span><span class="p">:</span>
                                                        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                                                            <span class="n">gaussian_filter</span><span class="p">,</span>
                                                        <span class="p">)</span>

                                                        <span class="n">smoothed_mask</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
                                                            <span class="n">detection</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                                                                <span class="nb">float</span>
                                                            <span class="p">),</span>
                                                            <span class="n">sigma</span><span class="o">=</span><span class="n">smoothing_sigma</span><span class="p">,</span>
                                                        <span class="p">)</span>
                                                        <span class="n">detection</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                                                            <span class="n">smoothed_mask</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
                                                        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                                                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                                                        <span class="k">pass</span>

                                                    <span class="c1"># Add to combined mask for this prompt</span>
                                                    <span class="n">prompt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                                                        <span class="n">prompt_mask</span><span class="p">,</span> <span class="n">detection</span><span class="o">.</span><span class="n">mask</span>
                                                    <span class="p">)</span>

                                                <span class="c1"># Store bounding box with geospatial coordinates</span>
                                                <span class="k">if</span> <span class="n">export_boxes</span><span class="p">:</span>
                                                    <span class="n">bbox</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">box</span>
                                                    <span class="n">x_geo_min</span><span class="p">,</span> <span class="n">y_geo_min</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span>
                                                        <span class="n">x_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span>
                                                        <span class="n">y_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span>
                                                    <span class="p">)</span>
                                                    <span class="n">x_geo_max</span><span class="p">,</span> <span class="n">y_geo_max</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span>
                                                        <span class="n">x_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span>
                                                        <span class="n">y_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span>
                                                    <span class="p">)</span>

                                                    <span class="n">geo_box</span> <span class="o">=</span> <span class="p">{</span>
                                                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">detection</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                                        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">detection</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                                                        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                                                        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">box</span><span class="p">(</span>
                                                            <span class="n">x_geo_min</span><span class="p">,</span>
                                                            <span class="n">y_geo_max</span><span class="p">,</span>
                                                            <span class="n">x_geo_max</span><span class="p">,</span>
                                                            <span class="n">y_geo_min</span><span class="p">,</span>
                                                        <span class="p">),</span>
                                                    <span class="p">}</span>
                                                    <span class="n">all_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geo_box</span><span class="p">)</span>

                                        <span class="c1"># Convert masks to individual polygons</span>
                                        <span class="k">if</span> <span class="n">export_polygons</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">prompt_mask</span><span class="p">):</span>
                                            <span class="n">tile_polygons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_to_polygons</span><span class="p">(</span>
                                                <span class="n">prompt_mask</span><span class="p">,</span>
                                                <span class="n">transform</span><span class="p">,</span>
                                                <span class="n">x_start</span><span class="p">,</span>
                                                <span class="n">y_start</span><span class="p">,</span>
                                                <span class="n">min_polygon_area</span><span class="p">,</span>
                                                <span class="n">simplify_tolerance</span><span class="p">,</span>
                                            <span class="p">)</span>

                                            <span class="c1"># Add metadata to polygons</span>
                                            <span class="k">for</span> <span class="n">poly_data</span> <span class="ow">in</span> <span class="n">tile_polygons</span><span class="p">:</span>
                                                <span class="n">poly_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                                    <span class="p">{</span>
                                                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                                                        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span>
                                                            <span class="p">[</span>
                                                                <span class="n">d</span><span class="o">.</span><span class="n">score</span>
                                                                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">detections</span>
                                                                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                                                    <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                                                                <span class="p">)</span>
                                                                <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                                                <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                                <span class="o">==</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                            <span class="p">],</span>
                                                            <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                                        <span class="p">),</span>
                                                        <span class="s2">&quot;tile_x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                                                        <span class="s2">&quot;tile_y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                                                    <span class="p">}</span>
                                                <span class="p">)</span>
                                                <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly_data</span><span class="p">)</span>

                                        <span class="c1"># Store mask in the global array</span>
                                        <span class="n">valid_x_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                        <span class="n">valid_y_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                        <span class="n">valid_x_end</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">tile_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                                            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n_tiles_x</span> <span class="o">-</span> <span class="mi">1</span>
                                            <span class="k">else</span> <span class="n">tile_width</span>
                                        <span class="p">)</span>
                                        <span class="n">valid_y_end</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">tile_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                                            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">n_tiles_y</span> <span class="o">-</span> <span class="mi">1</span>
                                            <span class="k">else</span> <span class="n">tile_height</span>
                                        <span class="p">)</span>

                                        <span class="n">dest_x_start</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_start</span>
                                        <span class="n">dest_y_start</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_start</span>
                                        <span class="n">dest_x_end</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_end</span>
                                        <span class="n">dest_y_end</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_end</span>

                                        <span class="n">mask_slice</span> <span class="o">=</span> <span class="n">prompt_mask</span><span class="p">[</span>
                                            <span class="n">valid_y_start</span><span class="p">:</span><span class="n">valid_y_end</span><span class="p">,</span>
                                            <span class="n">valid_x_start</span><span class="p">:</span><span class="n">valid_x_end</span><span class="p">,</span>
                                        <span class="p">]</span>
                                        <span class="n">all_masks</span><span class="p">[</span>
                                            <span class="n">i</span><span class="p">,</span>
                                            <span class="n">dest_y_start</span><span class="p">:</span><span class="n">dest_y_end</span><span class="p">,</span>
                                            <span class="n">dest_x_start</span><span class="p">:</span><span class="n">dest_x_end</span><span class="p">,</span>
                                        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                                            <span class="n">all_masks</span><span class="p">[</span>
                                                <span class="n">i</span><span class="p">,</span>
                                                <span class="n">dest_y_start</span><span class="p">:</span><span class="n">dest_y_end</span><span class="p">,</span>
                                                <span class="n">dest_x_start</span><span class="p">:</span><span class="n">dest_x_end</span><span class="p">,</span>
                                            <span class="p">],</span>
                                            <span class="n">mask_slice</span><span class="p">,</span>
                                        <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing tile at (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1"># Update progress bar</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Create combined mask (union of all individual masks)</span>
            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">all_masks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Write the output GeoTIFF</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="c1"># Write combined mask as first band</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Write individual masks for each prompt</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_masks</span><span class="p">):</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Add descriptions to bands</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Combined Segmentation&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">):</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Segmentation: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">result_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="n">output_path</span><span class="p">}</span>

            <span class="c1"># Export bounding boxes if requested</span>
            <span class="k">if</span> <span class="n">export_boxes</span> <span class="ow">and</span> <span class="n">all_boxes</span><span class="p">:</span>
                <span class="n">boxes_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;_boxes.geojson&quot;</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">all_boxes</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">boxes_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
                <span class="n">result_files</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes_path</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_boxes</span><span class="p">)</span><span class="si">}</span><span class="s2"> bounding boxes to </span><span class="si">{</span><span class="n">boxes_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Export instance polygons if requested</span>
            <span class="k">if</span> <span class="n">export_polygons</span> <span class="ow">and</span> <span class="n">all_polygons</span><span class="p">:</span>
                <span class="n">polygons_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;_polygons.geojson&quot;</span><span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">polygons_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
                <span class="n">result_files</span><span class="p">[</span><span class="s2">&quot;polygons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygons_path</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Exported </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> instance polygons to </span><span class="si">{</span><span class="n">polygons_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> individual building instances&quot;</span>
                <span class="k">if</span> <span class="n">export_polygons</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">result_files</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.GroundedSAM.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">detector_id</span><span class="o">=</span><span class="s1">&#39;IDEA-Research/grounding-dino-tiny&#39;</span><span class="p">,</span> <span class="n">segmenter_id</span><span class="o">=</span><span class="s1">&#39;facebook/sam-vit-base&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span></code>

<a href="#geoai.geoai.GroundedSAM.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the GroundedSAM with the specified models and settings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detector_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model ID for Grounding DINO.</p>
              </div>
            </td>
            <td>
                  <code>&#39;IDEA-Research/grounding-dino-tiny&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segmenter_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model ID for SAM.</p>
              </div>
            </td>
            <td>
                  <code>&#39;facebook/sam-vit-base&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run the models on ('cuda', 'cpu').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles to process the image in chunks.</p>
              </div>
            </td>
            <td>
                  <code>1024</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles to avoid edge artifacts.</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Detection threshold for Grounding DINO.</p>
              </div>
            </td>
            <td>
                  <code>0.3</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/segment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">detector_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IDEA-Research/grounding-dino-tiny&quot;</span><span class="p">,</span>
    <span class="n">segmenter_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;facebook/sam-vit-base&quot;</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the GroundedSAM with the specified models and settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        detector_id (str): Hugging Face model ID for Grounding DINO.</span>
<span class="sd">        segmenter_id (str): Hugging Face model ID for SAM.</span>
<span class="sd">        device (str): Device to run the models on (&#39;cuda&#39;, &#39;cpu&#39;).</span>
<span class="sd">        tile_size (int): Size of tiles to process the image in chunks.</span>
<span class="sd">        overlap (int): Overlap between tiles to avoid edge artifacts.</span>
<span class="sd">        threshold (float): Detection threshold for Grounding DINO.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">detector_id</span> <span class="o">=</span> <span class="n">detector_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">segmenter_id</span> <span class="o">=</span> <span class="n">segmenter_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">=</span> <span class="n">tile_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

    <span class="c1"># Set device</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="c1"># Load models</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_load_models</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GroundedSAM initialized on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.GroundedSAM.segment_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment_image</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">text_prompts</span><span class="p">,</span> <span class="n">polygon_refinement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_boxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_polygons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smoothing_sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_polygon_area</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span></code>

<a href="#geoai.geoai.GroundedSAM.segment_image" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Segment a GeoTIFF image using text prompts with improved instance segmentation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the output GeoTIFF will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_prompts</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text prompt(s) describing what to segment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>polygon_refinement</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to refine masks using polygon fitting.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>export_boxes</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to export bounding boxes as a separate vector file.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>export_polygons</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to export segmentation polygons as vector file.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smoothing_sigma</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sigma value for Gaussian smoothing to reduce blockiness.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nms_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Non-maximum suppression threshold for removing overlapping detections.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_polygon_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in pixels for valid polygons.</p>
              </div>
            </td>
            <td>
                  <code>50</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for polygon simplification.</p>
              </div>
            </td>
            <td>
                  <code>2.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Dict</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing paths to output files.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/segment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">segment_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">text_prompts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">polygon_refinement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">export_boxes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">export_polygons</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">smoothing_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">nms_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">min_polygon_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segment a GeoTIFF image using text prompts with improved instance segmentation.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_path (str): Path to the input GeoTIFF file.</span>
<span class="sd">        output_path (str): Path where the output GeoTIFF will be saved.</span>
<span class="sd">        text_prompts (Union[str, List[str]]): Text prompt(s) describing what to segment.</span>
<span class="sd">        polygon_refinement (bool): Whether to refine masks using polygon fitting.</span>
<span class="sd">        export_boxes (bool): Whether to export bounding boxes as a separate vector file.</span>
<span class="sd">        export_polygons (bool): Whether to export segmentation polygons as vector file.</span>
<span class="sd">        smoothing_sigma (float): Sigma value for Gaussian smoothing to reduce blockiness.</span>
<span class="sd">        nms_threshold (float): Non-maximum suppression threshold for removing overlapping detections.</span>
<span class="sd">        min_polygon_area (int): Minimum area in pixels for valid polygons.</span>
<span class="sd">        simplify_tolerance (float): Tolerance for polygon simplification.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict: Dictionary containing paths to output files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">text_prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_prompts</span><span class="p">]</span>

    <span class="c1"># Open the input GeoTIFF</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get metadata</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Create output metadata for segmentation masks</span>
        <span class="n">out_meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span> <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Create arrays for results</span>
        <span class="n">all_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">),</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">all_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Calculate effective tile size (accounting for overlap)</span>
        <span class="n">effective_tile_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>

        <span class="c1"># Calculate number of tiles</span>
        <span class="n">n_tiles_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
        <span class="n">n_tiles_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">effective_tile_size</span><span class="p">)))</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">n_tiles_x</span> <span class="o">*</span> <span class="n">n_tiles_y</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">total_tiles</span><span class="si">}</span><span class="s2"> tiles (</span><span class="si">{</span><span class="n">n_tiles_x</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_tiles_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Process tiles with tqdm progress bar</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_tiles</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tiles&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="c1"># Iterate through tiles</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles_x</span><span class="p">):</span>
                    <span class="c1"># Calculate tile coordinates with overlap</span>
                    <span class="n">x_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">y_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">x_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">y_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">height</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">effective_tile_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                    <span class="p">)</span>

                    <span class="n">tile_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>
                    <span class="n">tile_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>

                    <span class="c1"># Read the tile</span>
                    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">)</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                    <span class="c1"># Process the tile</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Convert to RGB format for processing</span>
                        <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="c1"># Use first three bands for RGB representation</span>
                            <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Create RGB from grayscale</span>
                            <span class="n">rgb_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                                <span class="n">tile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Unsupported number of bands: </span><span class="si">{</span><span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1"># Normalize to 0-255 range if needed</span>
                        <span class="k">if</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">rgb_tile</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="p">(</span><span class="n">rgb_tile</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                <span class="o">/</span> <span class="p">(</span><span class="n">rgb_tile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rgb_tile</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                <span class="o">*</span> <span class="mi">255</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                        <span class="c1"># Convert to PIL Image</span>
                        <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_tile</span><span class="p">)</span>

                        <span class="c1"># Detect objects</span>
                        <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect</span><span class="p">(</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">text_prompts</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">detections</span><span class="p">:</span>
                            <span class="c1"># Apply Non-Maximum Suppression to reduce overlapping detections</span>
                            <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nms</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">detections</span><span class="p">:</span>
                                <span class="c1"># Segment objects</span>
                                <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment</span><span class="p">(</span>
                                    <span class="n">pil_image</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">polygon_refinement</span>
                                <span class="p">)</span>

                                <span class="c1"># Process results</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">):</span>
                                    <span class="n">prompt_polygons</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="n">prompt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                        <span class="p">(</span><span class="n">tile_height</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                                    <span class="p">)</span>

                                    <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="p">(</span>
                                            <span class="n">detection</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                            <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                            <span class="o">==</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                        <span class="p">):</span>
                                            <span class="k">if</span> <span class="n">detection</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                                <span class="c1"># Apply gaussian blur to reduce blockiness</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                                                        <span class="n">gaussian_filter</span><span class="p">,</span>
                                                    <span class="p">)</span>

                                                    <span class="n">smoothed_mask</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
                                                        <span class="n">detection</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                                                            <span class="nb">float</span>
                                                        <span class="p">),</span>
                                                        <span class="n">sigma</span><span class="o">=</span><span class="n">smoothing_sigma</span><span class="p">,</span>
                                                    <span class="p">)</span>
                                                    <span class="n">detection</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                                                        <span class="n">smoothed_mask</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
                                                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                                                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                                                    <span class="k">pass</span>

                                                <span class="c1"># Add to combined mask for this prompt</span>
                                                <span class="n">prompt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                                                    <span class="n">prompt_mask</span><span class="p">,</span> <span class="n">detection</span><span class="o">.</span><span class="n">mask</span>
                                                <span class="p">)</span>

                                            <span class="c1"># Store bounding box with geospatial coordinates</span>
                                            <span class="k">if</span> <span class="n">export_boxes</span><span class="p">:</span>
                                                <span class="n">bbox</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">box</span>
                                                <span class="n">x_geo_min</span><span class="p">,</span> <span class="n">y_geo_min</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span>
                                                    <span class="n">x_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span>
                                                    <span class="n">y_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span>
                                                <span class="p">)</span>
                                                <span class="n">x_geo_max</span><span class="p">,</span> <span class="n">y_geo_max</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span>
                                                    <span class="n">x_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span>
                                                    <span class="n">y_start</span> <span class="o">+</span> <span class="n">bbox</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span>
                                                <span class="p">)</span>

                                                <span class="n">geo_box</span> <span class="o">=</span> <span class="p">{</span>
                                                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">detection</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">detection</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                                                    <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                                                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">box</span><span class="p">(</span>
                                                        <span class="n">x_geo_min</span><span class="p">,</span>
                                                        <span class="n">y_geo_max</span><span class="p">,</span>
                                                        <span class="n">x_geo_max</span><span class="p">,</span>
                                                        <span class="n">y_geo_min</span><span class="p">,</span>
                                                    <span class="p">),</span>
                                                <span class="p">}</span>
                                                <span class="n">all_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geo_box</span><span class="p">)</span>

                                    <span class="c1"># Convert masks to individual polygons</span>
                                    <span class="k">if</span> <span class="n">export_polygons</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">prompt_mask</span><span class="p">):</span>
                                        <span class="n">tile_polygons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_to_polygons</span><span class="p">(</span>
                                            <span class="n">prompt_mask</span><span class="p">,</span>
                                            <span class="n">transform</span><span class="p">,</span>
                                            <span class="n">x_start</span><span class="p">,</span>
                                            <span class="n">y_start</span><span class="p">,</span>
                                            <span class="n">min_polygon_area</span><span class="p">,</span>
                                            <span class="n">simplify_tolerance</span><span class="p">,</span>
                                        <span class="p">)</span>

                                        <span class="c1"># Add metadata to polygons</span>
                                        <span class="k">for</span> <span class="n">poly_data</span> <span class="ow">in</span> <span class="n">tile_polygons</span><span class="p">:</span>
                                            <span class="n">poly_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                                <span class="p">{</span>
                                                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                                                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span>
                                                        <span class="p">[</span>
                                                            <span class="n">d</span><span class="o">.</span><span class="n">score</span>
                                                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">detections</span>
                                                            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                                                <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                                                            <span class="p">)</span>
                                                            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                                            <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                            <span class="o">==</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                        <span class="p">],</span>
                                                        <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                                    <span class="p">),</span>
                                                    <span class="s2">&quot;tile_x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                                                    <span class="s2">&quot;tile_y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                                                <span class="p">}</span>
                                            <span class="p">)</span>
                                            <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly_data</span><span class="p">)</span>

                                    <span class="c1"># Store mask in the global array</span>
                                    <span class="n">valid_x_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                    <span class="n">valid_y_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                    <span class="n">valid_x_end</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">tile_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                                        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n_tiles_x</span> <span class="o">-</span> <span class="mi">1</span>
                                        <span class="k">else</span> <span class="n">tile_width</span>
                                    <span class="p">)</span>
                                    <span class="n">valid_y_end</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">tile_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span>
                                        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">n_tiles_y</span> <span class="o">-</span> <span class="mi">1</span>
                                        <span class="k">else</span> <span class="n">tile_height</span>
                                    <span class="p">)</span>

                                    <span class="n">dest_x_start</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_start</span>
                                    <span class="n">dest_y_start</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_start</span>
                                    <span class="n">dest_x_end</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">valid_x_end</span>
                                    <span class="n">dest_y_end</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">valid_y_end</span>

                                    <span class="n">mask_slice</span> <span class="o">=</span> <span class="n">prompt_mask</span><span class="p">[</span>
                                        <span class="n">valid_y_start</span><span class="p">:</span><span class="n">valid_y_end</span><span class="p">,</span>
                                        <span class="n">valid_x_start</span><span class="p">:</span><span class="n">valid_x_end</span><span class="p">,</span>
                                    <span class="p">]</span>
                                    <span class="n">all_masks</span><span class="p">[</span>
                                        <span class="n">i</span><span class="p">,</span>
                                        <span class="n">dest_y_start</span><span class="p">:</span><span class="n">dest_y_end</span><span class="p">,</span>
                                        <span class="n">dest_x_start</span><span class="p">:</span><span class="n">dest_x_end</span><span class="p">,</span>
                                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                                        <span class="n">all_masks</span><span class="p">[</span>
                                            <span class="n">i</span><span class="p">,</span>
                                            <span class="n">dest_y_start</span><span class="p">:</span><span class="n">dest_y_end</span><span class="p">,</span>
                                            <span class="n">dest_x_start</span><span class="p">:</span><span class="n">dest_x_end</span><span class="p">,</span>
                                        <span class="p">],</span>
                                        <span class="n">mask_slice</span><span class="p">,</span>
                                    <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing tile at (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Update progress bar</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create combined mask (union of all individual masks)</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">all_masks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Write the output GeoTIFF</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="c1"># Write combined mask as first band</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Write individual masks for each prompt</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_masks</span><span class="p">):</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Add descriptions to bands</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Combined Segmentation&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_prompts</span><span class="p">):</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">set_band_description</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Segmentation: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="n">output_path</span><span class="p">}</span>

        <span class="c1"># Export bounding boxes if requested</span>
        <span class="k">if</span> <span class="n">export_boxes</span> <span class="ow">and</span> <span class="n">all_boxes</span><span class="p">:</span>
            <span class="n">boxes_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;_boxes.geojson&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">all_boxes</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">boxes_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
            <span class="n">result_files</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes_path</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_boxes</span><span class="p">)</span><span class="si">}</span><span class="s2"> bounding boxes to </span><span class="si">{</span><span class="n">boxes_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Export instance polygons if requested</span>
        <span class="k">if</span> <span class="n">export_polygons</span> <span class="ow">and</span> <span class="n">all_polygons</span><span class="p">:</span>
            <span class="n">polygons_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;_polygons.geojson&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">polygons_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
            <span class="n">result_files</span><span class="p">[</span><span class="s2">&quot;polygons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygons_path</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Exported </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> instance polygons to </span><span class="si">{</span><span class="n">polygons_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> individual building instances&quot;</span>
            <span class="k">if</span> <span class="n">export_polygons</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.LeafMap" class="doc doc-heading">
            <code>LeafMap</code>


<a href="#geoai.geoai.LeafMap" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="geoai.utils.leafmap.Map">Map</span></code></p>


        <p>A subclass of leafmap.Map for GeoAI applications.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/geoai.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LeafMap</span><span class="p">(</span><span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A subclass of leafmap.Map for GeoAI applications.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Map class.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_dinov3_gui</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">processor</span><span class="p">:</span> <span class="s2">&quot;DINOv3GeoProcessor&quot;</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a DINOv3 GUI to the map.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DINOv3GUI</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">host_map</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.LeafMap.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.LeafMap.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the Map class.</p>


            <details class="quote">
              <summary>Source code in <code>geoai/geoai.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Map class.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.LeafMap.add_dinov3_gui" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_dinov3_gui</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.LeafMap.add_dinov3_gui" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a DINOv3 GUI to the map.</p>


            <details class="quote">
              <summary>Source code in <code>geoai/geoai.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_dinov3_gui</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">processor</span><span class="p">:</span> <span class="s2">&quot;DINOv3GeoProcessor&quot;</span><span class="p">,</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a DINOv3 GUI to the map.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DINOv3GUI</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">host_map</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.Map" class="doc doc-heading">
            <code>Map</code>


<a href="#geoai.geoai.Map" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="leafmap.maplibregl.Map">Map</span></code></p>


        <p>A subclass of maplibregl.Map for GeoAI applications.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/geoai.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span><span class="n">maplibregl</span><span class="o">.</span><span class="n">Map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A subclass of maplibregl.Map for GeoAI applications.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Map class.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.Map.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.Map.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the Map class.</p>


            <details class="quote">
              <summary>Source code in <code>geoai/geoai.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Map class.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.ObjectDetector" class="doc doc-heading">
            <code>ObjectDetector</code>


<a href="#geoai.geoai.ObjectDetector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Object extraction using Mask R-CNN with TorchGeo.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ObjectDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object extraction using Mask R-CNN with TorchGeo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object extractor.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Hugging Face repository ID for model download.</span>
<span class="sd">            model: Pre-initialized model object (optional).</span>
<span class="sd">            num_classes: Number of classes for detection (default: 2).</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set device</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Default parameters for object detection - these can be overridden in process_raster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>  <span class="c1"># Size of image chips for processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># Default overlap between tiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Default confidence threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># IoU threshold for non-maximum suppression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Minimum area in pixels to keep an object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Maximum area in pixels to keep an object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Threshold for mask binarization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Tolerance for polygon simplification</span>

        <span class="c1"># Initialize model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>

        <span class="c1"># Download model if needed</span>
        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">)):</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">)</span>

        <span class="c1"># Load model weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

        <span class="c1"># Set model to evaluation mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download_model_from_hf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the object detection model from Hugging Face.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the model file.</span>
<span class="sd">            repo_id: Hugging Face repository ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to the downloaded model file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model path not specified, downloading from Hugging Face...&quot;</span><span class="p">)</span>

            <span class="c1"># Define the repository ID and model filename</span>
            <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">repo_id</span> <span class="o">=</span> <span class="s2">&quot;giswqs/geoai&quot;</span>

            <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;building_footprints_usa.pth&quot;</span>

            <span class="c1"># Download the model</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model downloaded to: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">model_path</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading model from Hugging Face: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify a local model path or ensure internet connectivity.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a deep learning model for object detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): A pre-initialized model object.</span>
<span class="sd">            num_classes (int): Number of classes for detection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.nn.Module: A deep learning model for object detection.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Initialize Mask R-CNN model with ResNet50 backbone.</span>
            <span class="c1"># Standard image mean and std for pre-trained models</span>
            <span class="n">image_mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]</span>
            <span class="n">image_std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>

            <span class="c1"># Create model with explicit normalization parameters</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">maskrcnn_resnet50_fpn</span><span class="p">(</span>
                <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>  <span class="c1"># Background + object</span>
                <span class="n">weights_backbone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="c1"># These parameters ensure consistent normalization</span>
                <span class="n">image_mean</span><span class="o">=</span><span class="n">image_mean</span><span class="p">,</span>
                <span class="n">image_std</span><span class="o">=</span><span class="n">image_std</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load weights from file with error handling for different formats.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to model weights</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Handle different state dict formats</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
                    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;state_dict&quot;</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
                    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>

            <span class="c1"># Try to load state dict</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to fix state_dict keys...&quot;</span><span class="p">)</span>

                <span class="c1"># Try to fix state_dict keys (remove module prefix if needed)</span>
                <span class="n">new_state_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;module.&quot;</span><span class="p">):</span>
                        <span class="n">new_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">7</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">new_state_dict</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully after key fixing&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mask_to_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert binary mask to polygon contours using OpenCV.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask: Binary mask as numpy array</span>
<span class="sd">            **kwargs: Optional parameters:</span>
<span class="sd">                simplify_tolerance: Tolerance for polygon simplification</span>
<span class="sd">                mask_threshold: Threshold for mask binarization</span>
<span class="sd">                min_object_area: Minimum area in pixels to keep an object</span>
<span class="sd">                max_object_area: Maximum area in pixels to keep an object</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of polygons as lists of (x, y) coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get parameters from kwargs or use instance defaults</span>
        <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simplify_tolerance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span><span class="p">)</span>
        <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
        <span class="n">min_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span><span class="p">)</span>
        <span class="n">max_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span><span class="p">)</span>

        <span class="c1"># Ensure binary mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Optional: apply morphological operations to improve mask quality</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># Find contours</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

        <span class="c1"># Convert to list of [x, y] coordinates</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
            <span class="c1"># Filter out too small contours</span>
            <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Filter out too large contours</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_object_area</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Simplify contour if it has many points</span>
            <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Convert to list of [x, y] coordinates</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">polygons</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_overlapping_polygons</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter overlapping polygons using non-maximum suppression.</span>

<span class="sd">        Args:</span>
<span class="sd">            gdf: GeoDataFrame with polygons</span>
<span class="sd">            **kwargs: Optional parameters:</span>
<span class="sd">                nms_iou_threshold: IoU threshold for filtering</span>

<span class="sd">        Returns:</span>
<span class="sd">            Filtered GeoDataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gdf</span>

        <span class="c1"># Get parameters from kwargs or use instance defaults</span>
        <span class="n">iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span><span class="p">)</span>

        <span class="c1"># Sort by confidence</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Fix any invalid geometries</span>
        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_valid</span> <span class="k">else</span> <span class="n">geom</span>
        <span class="p">)</span>

        <span class="n">keep_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
                <span class="c1"># Skip invalid geometries</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Calculate IoU</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">intersection</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">union</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">-</span> <span class="n">intersection</span>
                    <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span> <span class="k">if</span> <span class="n">union</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">iou_threshold</span><span class="p">:</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Skip on topology exceptions</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_edge_objects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter out object detections that fall in padding/edge areas of the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            gdf: GeoDataFrame with object detections</span>
<span class="sd">            raster_path: Path to the original raster file</span>
<span class="sd">            edge_buffer: Buffer in pixels to consider as edge region</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with filtered objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>

        <span class="c1"># If no objects detected, return empty GeoDataFrame</span>
        <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gdf</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Objects before filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Get raster bounds</span>
            <span class="n">raster_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">raster_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="n">raster_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>

            <span class="c1"># Convert edge buffer from pixels to geographic units</span>
            <span class="c1"># We need the smallest dimension of a pixel in geographic units</span>
            <span class="n">pixel_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">raster_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">raster_width</span>
            <span class="n">pixel_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">raster_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">raster_height</span>
            <span class="n">buffer_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pixel_width</span><span class="p">,</span> <span class="n">pixel_height</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge_buffer</span>

            <span class="c1"># Create a slightly smaller bounding box to exclude edge regions</span>
            <span class="n">inner_bounds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># min x (west)</span>
                <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># min y (south)</span>
                <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># max x (east)</span>
                <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># max y (north)</span>
            <span class="p">)</span>

            <span class="c1"># Check that inner bounds are valid</span>
            <span class="k">if</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Edge buffer too large, using original bounds&quot;</span><span class="p">)</span>
                <span class="n">inner_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">raster_bounds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inner_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">inner_bounds</span><span class="p">)</span>

            <span class="c1"># Filter out objects that intersect with the edge of the image</span>
            <span class="n">filtered_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">inner_box</span><span class="p">)]</span>

            <span class="c1"># Additional check for objects that have &gt;50% of their area outside the valid region</span>
            <span class="n">valid_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">inner_box</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="p">:</span>
                    <span class="n">valid_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="n">filtered_gdf</span> <span class="o">=</span> <span class="n">filtered_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_objects</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Objects after filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">filtered_gdf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">masks_to_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_iou_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">regularize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">rectangularity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an object mask GeoTIFF to vector polygons and save as GeoJSON.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask_path: Path to the object masks GeoTIFF</span>
<span class="sd">            output_path: Path to save the output GeoJSON or Parquet file (default: mask_path with .geojson extension)</span>
<span class="sd">            simplify_tolerance: Tolerance for polygon simplification (default: self.simplify_tolerance)</span>
<span class="sd">            mask_threshold: Threshold for mask binarization (default: self.mask_threshold)</span>
<span class="sd">            min_object_area: Minimum area in pixels to keep an object (default: self.min_object_area)</span>
<span class="sd">            max_object_area: Minimum area in pixels to keep an object (default: self.max_object_area)</span>
<span class="sd">            nms_iou_threshold: IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</span>
<span class="sd">            regularize: Whether to regularize objects to right angles (default: True)</span>
<span class="sd">            angle_threshold: Maximum deviation from 90 degrees for regularization (default: 15)</span>
<span class="sd">            rectangularity_threshold: Threshold for rectangle simplification (default: 0.7)</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use class defaults if parameters not provided</span>
        <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">simplify_tolerance</span>
            <span class="k">if</span> <span class="n">simplify_tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span>
        <span class="p">)</span>
        <span class="n">mask_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mask_threshold</span> <span class="k">if</span> <span class="n">mask_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span>
        <span class="p">)</span>
        <span class="n">min_object_area</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">min_object_area</span> <span class="k">if</span> <span class="n">min_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span>
        <span class="p">)</span>
        <span class="n">max_object_area</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_object_area</span> <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span>
        <span class="p">)</span>
        <span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">nms_iou_threshold</span>
            <span class="k">if</span> <span class="n">nms_iou_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span>
        <span class="p">)</span>

        <span class="c1"># Set default output path if not provided</span>
        <span class="c1"># if output_path is None:</span>
        <span class="c1">#     output_path = os.path.splitext(mask_path)[0] + &quot;.geojson&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting mask to GeoJSON with parameters:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min object area: </span><span class="si">{</span><span class="n">min_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Max object area: </span><span class="si">{</span><span class="n">max_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Simplify tolerance: </span><span class="si">{</span><span class="n">simplify_tolerance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- NMS IoU threshold: </span><span class="si">{</span><span class="n">nms_iou_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Regularize objects: </span><span class="si">{</span><span class="n">regularize</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regularize</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Angle threshold: </span><span class="si">{</span><span class="n">angle_threshold</span><span class="si">}</span><span class="s2">° from 90°&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Rectangularity threshold: </span><span class="si">{</span><span class="n">rectangularity_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Open the mask raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Read the mask data</span>
            <span class="n">mask_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

            <span class="c1"># Print mask statistics</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask dimensions: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask value range: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Prepare for connected component analysis</span>
            <span class="c1"># Binarize the mask based on threshold</span>
            <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mask_threshold</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Apply morphological operations for better results (optional)</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

            <span class="c1"># Find connected components</span>
            <span class="n">num_labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span>
                <span class="n">binary_mask</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_labels</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> potential objects&quot;</span>
            <span class="p">)</span>  <span class="c1"># Subtract 1 for background</span>

            <span class="c1"># Create list to store polygons and confidence values</span>
            <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_confidences</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Process each component (skip the first one which is background)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">)):</span>
                <span class="c1"># Extract this object</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CC_STAT_AREA</span><span class="p">]</span>

                <span class="c1"># Skip if too small</span>
                <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Skip if too large</span>
                <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Create a mask for this object</span>
                <span class="n">object_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="c1"># Find contours</span>
                <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                    <span class="n">object_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
                <span class="p">)</span>

                <span class="c1"># Process each contour</span>
                <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                    <span class="c1"># Skip if too few points</span>
                    <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Simplify contour if it has many points</span>
                    <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">simplify_tolerance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># Convert to list of (x, y) coordinates</span>
                    <span class="n">polygon_points</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># Convert pixel coordinates to geographic coordinates</span>
                    <span class="n">geo_points</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">polygon_points</span><span class="p">:</span>
                        <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                        <span class="n">geo_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                    <span class="c1"># Create Shapely polygon</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">shapely_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely_poly</span><span class="p">)</span>

                                <span class="c1"># Calculate &quot;confidence&quot; as normalized size</span>
                                <span class="c1"># This is a proxy since we don&#39;t have model confidence scores</span>
                                <span class="n">normalized_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">area</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Cap at 1.0</span>
                                <span class="n">all_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_size</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid polygons&quot;</span><span class="p">)</span>

            <span class="c1"># Create GeoDataFrame</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_polygons</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">all_polygons</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">all_confidences</span><span class="p">,</span>
                    <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Object class</span>
                <span class="p">},</span>
                <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Apply non-maximum suppression to remove overlapping polygons</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_overlapping_polygons</span><span class="p">(</span>
                <span class="n">gdf</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object count after NMS filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Apply regularization if requested</span>
            <span class="k">if</span> <span class="n">regularize</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Convert pixel area to geographic units for min_area parameter</span>
                <span class="c1"># Estimate pixel size in geographic units</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">pixel_size_x</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span>
                        <span class="mi">0</span>
                    <span class="p">]</span>  <span class="c1"># width of a pixel in geographic units</span>
                    <span class="n">pixel_size_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                        <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># height of a pixel in geographic units</span>
                    <span class="n">avg_pixel_area</span> <span class="o">=</span> <span class="n">pixel_size_x</span> <span class="o">*</span> <span class="n">pixel_size_y</span>

                <span class="c1"># Use 10 pixels as minimum area in geographic units</span>
                <span class="n">min_geo_area</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">avg_pixel_area</span>

                <span class="c1"># Regularize objects</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularize_objects</span><span class="p">(</span>
                    <span class="n">gdf</span><span class="p">,</span>
                    <span class="n">min_area</span><span class="o">=</span><span class="n">min_geo_area</span><span class="p">,</span>
                    <span class="n">angle_threshold</span><span class="o">=</span><span class="n">angle_threshold</span><span class="p">,</span>
                    <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="n">rectangularity_threshold</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Save to file</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
                    <span class="n">gdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_raster</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">filter_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">edge_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">band_indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;gpd.GeoDataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a raster file to extract objects with customizable parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to input raster file</span>
<span class="sd">            output_path: Path to output GeoJSON or Parquet file (optional)</span>
<span class="sd">            batch_size: Batch size for processing</span>
<span class="sd">            filter_edges: Whether to filter out objects at the edges of the image</span>
<span class="sd">            edge_buffer: Size of edge buffer in pixels to filter out objects (if filter_edges=True)</span>
<span class="sd">            band_indexes: List of band indexes to use (if None, use all bands)</span>
<span class="sd">            **kwargs: Additional parameters:</span>
<span class="sd">                confidence_threshold: Minimum confidence score to keep a detection (0.0-1.0)</span>
<span class="sd">                overlap: Overlap between adjacent tiles (0.0-1.0)</span>
<span class="sd">                chip_size: Size of image chips for processing (height, width)</span>
<span class="sd">                nms_iou_threshold: IoU threshold for non-maximum suppression (0.0-1.0)</span>
<span class="sd">                mask_threshold: Threshold for mask binarization (0.0-1.0)</span>
<span class="sd">                min_object_area: Minimum area in pixels to keep an object</span>
<span class="sd">                simplify_tolerance: Tolerance for polygon simplification</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get parameters from kwargs or use instance defaults</span>
        <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
        <span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
        <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>
        <span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span><span class="p">)</span>
        <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
        <span class="n">min_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span><span class="p">)</span>
        <span class="n">max_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span><span class="p">)</span>
        <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simplify_tolerance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span><span class="p">)</span>

        <span class="c1"># Print parameters being used</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing with parameters:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Confidence threshold: </span><span class="si">{</span><span class="n">confidence_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Tile overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Chip size: </span><span class="si">{</span><span class="n">chip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- NMS IoU threshold: </span><span class="si">{</span><span class="n">nms_iou_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min object area: </span><span class="si">{</span><span class="n">min_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Max object area: </span><span class="si">{</span><span class="n">max_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Simplify tolerance: </span><span class="si">{</span><span class="n">simplify_tolerance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Filter edge objects: </span><span class="si">{</span><span class="n">filter_edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filter_edges</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Edge buffer size: </span><span class="si">{</span><span class="n">edge_buffer</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

        <span class="c1"># Create dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
            <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
            <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
            <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">band_indexes</span><span class="o">=</span><span class="n">band_indexes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_stats</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">raster_stats</span>

        <span class="c1"># Custom collate function to handle Shapely objects</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Custom collate function that handles Shapely geometries</span>
<span class="sd">            by keeping them as Python objects rather than trying to collate them.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t collate shapely objects, keep as list</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For tensors and other collatable types</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="c1"># Fall back to list for non-collatable types</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default collate for non-dict types</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="c1"># Create dataloader with simple indexing and custom collate</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Process batches</span>
        <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="c1"># Move images to device</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>  <span class="c1"># (i, j) coordinates in pixels</span>
            <span class="n">bboxes</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span>
                <span class="s2">&quot;bbox&quot;</span>
            <span class="p">]</span>  <span class="c1"># Geographic bounding boxes - now a list, not a tensor</span>

            <span class="c1"># Run inference</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="c1"># Process predictions</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                <span class="c1"># Skip if no predictions</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Filter by confidence threshold</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">confidence_threshold</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

                <span class="c1"># Skip if no valid predictions</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get window coordinates</span>
                <span class="c1"># The coords might be in different formats depending on batch handling</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># If coords is a list of tuples</span>
                    <span class="n">coord_item</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="c1"># If coords is a tensor of shape [batch_size, 2]</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Get window size</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">window_item</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">window_item</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                        <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">window_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected window_size format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected window_size type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;window_size&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Process masks to polygons</span>
                <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                    <span class="c1"># Get binary mask</span>
                    <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Get binary mask</span>

                    <span class="c1"># Convert mask to polygon with custom parameters</span>
                    <span class="n">contours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_to_polygons</span><span class="p">(</span>
                        <span class="n">binary_mask</span><span class="p">,</span>
                        <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
                        <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
                        <span class="n">min_object_area</span><span class="o">=</span><span class="n">min_object_area</span><span class="p">,</span>
                        <span class="n">max_object_area</span><span class="o">=</span><span class="n">max_object_area</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Skip if no valid polygons</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">contours</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Transform polygons to geographic coordinates</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

                        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                            <span class="c1"># Convert polygon to global coordinates</span>
                            <span class="n">global_polygon</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
                                <span class="c1"># Adjust coordinates based on window position</span>
                                <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
                                <span class="n">global_polygon</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                            <span class="c1"># Create Shapely polygon</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">global_polygon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">shapely_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">global_polygon</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely_poly</span><span class="p">)</span>
                                        <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_idx</span><span class="p">]))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_polygons</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">all_polygons</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">all_scores</span><span class="p">,</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Object class</span>
            <span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Remove overlapping polygons with custom threshold</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span><span class="p">)</span>

        <span class="c1"># Filter edge objects if requested</span>
        <span class="k">if</span> <span class="n">filter_edges</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_edge_objects</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">raster_path</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="o">=</span><span class="n">edge_buffer</span><span class="p">)</span>

        <span class="c1"># Save to file if requested</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_masks_as_geotiff</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a raster file to extract object masks and save as GeoTIFF.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to input raster file</span>
<span class="sd">            output_path: Path to output GeoTIFF file (optional, default: input_masks.tif)</span>
<span class="sd">            batch_size: Batch size for processing</span>
<span class="sd">            verbose: Whether to print detailed processing information</span>
<span class="sd">            **kwargs: Additional parameters:</span>
<span class="sd">                confidence_threshold: Minimum confidence score to keep a detection (0.0-1.0)</span>
<span class="sd">                chip_size: Size of image chips for processing (height, width)</span>
<span class="sd">                mask_threshold: Threshold for mask binarization (0.0-1.0)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to the saved GeoTIFF file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get parameters from kwargs or use instance defaults</span>
        <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
        <span class="p">)</span>
        <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>
        <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>

        <span class="c1"># Set default output path if not provided</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_masks.tif&quot;</span>

        <span class="c1"># Print parameters being used</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing masks with parameters:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Confidence threshold: </span><span class="si">{</span><span class="n">confidence_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Chip size: </span><span class="si">{</span><span class="n">chip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
            <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
            <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
            <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Store a flag to avoid repetitive messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_stats</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">raster_stats</span>
        <span class="n">seen_warnings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;resize&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Dictionary to track resize warnings by shape</span>
        <span class="p">}</span>

        <span class="c1"># Open original raster to get metadata</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Create output binary mask raster with same dimensions as input</span>
            <span class="n">output_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">output_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Single band for object mask</span>
                <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create output mask raster</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">output_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="c1"># Initialize mask with zeros</span>
                <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="c1"># Custom collate function to handle Shapely objects</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Custom collate function for DataLoader&quot;&quot;&quot;</span>
                    <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                                <span class="c1"># Don&#39;t collate shapely objects, keep as list</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># For tensors and other collatable types</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                            <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                    <span class="c1"># Fall back to list for non-collatable types</span>
                                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Default collate for non-dict types</span>
                        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

                <span class="c1"># Create dataloader</span>
                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Process batches</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
                    <span class="c1"># Move images to device</span>
                    <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>  <span class="c1"># (i, j) coordinates in pixels</span>

                    <span class="c1"># Run inference</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

                    <span class="c1"># Process predictions</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
                        <span class="n">masks</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                        <span class="c1"># Skip if no predictions</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Filter by confidence threshold</span>
                        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">confidence_threshold</span>
                        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

                        <span class="c1"># Skip if no valid predictions</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get window coordinates</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">coord_item</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get window size</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">window_item</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">window_item</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                                <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">window_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Unexpected window_size format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                            <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Unexpected window_size type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;window_size&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1"># Combine all masks for this window</span>
                        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                        <span class="p">)</span>

                        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
                            <span class="c1"># Get the binary mask</span>
                            <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                            <span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

                            <span class="c1"># Handle size mismatch - resize binary_mask if needed</span>
                            <span class="n">mask_h</span><span class="p">,</span> <span class="n">mask_w</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span>
                            <span class="k">if</span> <span class="n">mask_h</span> <span class="o">!=</span> <span class="n">window_height</span> <span class="ow">or</span> <span class="n">mask_w</span> <span class="o">!=</span> <span class="n">window_width</span><span class="p">:</span>
                                <span class="n">resize_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">mask_h</span><span class="p">,</span><span class="w"> </span><span class="n">mask_w</span><span class="p">)</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="p">(</span><span class="n">window_height</span><span class="p">,</span><span class="w"> </span><span class="n">window_width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">if</span> <span class="n">resize_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_warnings</span><span class="p">[</span><span class="s2">&quot;resize&quot;</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span>
                                            <span class="sa">f</span><span class="s2">&quot;Resizing mask from </span><span class="si">{</span><span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="p">(</span><span class="n">window_height</span><span class="p">,</span><span class="w"> </span><span class="n">window_width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_warnings</span><span class="p">[</span>
                                            <span class="s2">&quot;resize&quot;</span>
                                        <span class="p">]:</span>  <span class="c1"># If this is the first resize warning</span>
                                            <span class="nb">print</span><span class="p">(</span>
                                                <span class="sa">f</span><span class="s2">&quot;Resizing masks at image edges (set verbose=True for details)&quot;</span>
                                            <span class="p">)</span>
                                    <span class="n">seen_warnings</span><span class="p">[</span><span class="s2">&quot;resize&quot;</span><span class="p">][</span><span class="n">resize_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="c1"># Crop or pad the binary mask to match window size</span>
                                <span class="n">resized_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                                <span class="p">)</span>
                                <span class="n">copy_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mask_h</span><span class="p">,</span> <span class="n">window_height</span><span class="p">)</span>
                                <span class="n">copy_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mask_w</span><span class="p">,</span> <span class="n">window_width</span><span class="p">)</span>
                                <span class="n">resized_mask</span><span class="p">[:</span><span class="n">copy_h</span><span class="p">,</span> <span class="p">:</span><span class="n">copy_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="p">[</span>
                                    <span class="p">:</span><span class="n">copy_h</span><span class="p">,</span> <span class="p">:</span><span class="n">copy_w</span>
                                <span class="p">]</span>
                                <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">resized_mask</span>

                            <span class="c1"># Update combined mask (taking maximum where masks overlap)</span>
                            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="n">binary_mask</span><span class="p">)</span>

                        <span class="c1"># Write combined mask to output array</span>
                        <span class="c1"># Handle edge cases where window might be smaller than chip size</span>
                        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">combined_mask</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">valid_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>
                        <span class="n">valid_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">valid_h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                                <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">],</span>
                                <span class="n">combined_mask</span><span class="p">[:</span><span class="n">valid_h</span><span class="p">,</span> <span class="p">:</span><span class="n">valid_w</span><span class="p">],</span>
                            <span class="p">)</span>

                <span class="c1"># Write the final mask to the output file</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object masks saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">regularize_objects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">min_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">orthogonality_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="n">rectangularity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regularize objects to enforce right angles and rectangular shapes.</span>

<span class="sd">        Args:</span>
<span class="sd">            gdf: GeoDataFrame with objects</span>
<span class="sd">            min_area: Minimum area in square units to keep an object</span>
<span class="sd">            angle_threshold: Maximum deviation from 90 degrees to consider an angle as orthogonal (degrees)</span>
<span class="sd">            orthogonality_threshold: Percentage of angles that must be orthogonal for an object to be regularized</span>
<span class="sd">            rectangularity_threshold: Minimum area ratio to Object&#39;s oriented bounding box for rectangular simplification</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with regularized objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">translate</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiPolygon</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">box</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_angle</span><span class="p">(</span>
            <span class="n">p1</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">p2</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">p3</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calculate angle between three points in degrees (0-180)&quot;&quot;&quot;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>

            <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">b</span>

            <span class="n">cosine_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bc</span><span class="p">))</span>
            <span class="c1"># Handle numerical errors that could push cosine outside [-1, 1]</span>
            <span class="n">cosine_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cosine_angle</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosine_angle</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">angle</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_orthogonal</span><span class="p">(</span><span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">angle_threshold</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if angle is close to 90 degrees&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calculate_dominant_direction</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Find the dominant direction of a polygon using PCA&quot;&quot;&quot;</span>
            <span class="c1"># Extract coordinates</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

            <span class="c1"># Mean center the coordinates</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">centered_coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">mean</span>

            <span class="c1"># Calculate covariance matrix and its eigenvalues/eigenvectors</span>
            <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">centered_coords</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>

            <span class="c1"># Get the index of the largest eigenvalue</span>
            <span class="n">largest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>

            <span class="c1"># Get the corresponding eigenvector (principal axis)</span>
            <span class="n">principal_axis</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">largest_idx</span><span class="p">]</span>

            <span class="c1"># Calculate the angle in degrees</span>
            <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">principal_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">principal_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>

            <span class="c1"># Normalize to range 0-180</span>
            <span class="k">if</span> <span class="n">angle_deg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">angle_deg</span> <span class="o">+=</span> <span class="mi">180</span>

            <span class="k">return</span> <span class="n">angle_deg</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">create_oriented_envelope</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">angle_deg</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Polygon</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create an oriented minimum area rectangle for the polygon&quot;&quot;&quot;</span>
            <span class="c1"># Create a rotated rectangle using OpenCV method (more robust than Shapely methods)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>  <span class="c1"># Skip the last point (same as first)</span>

            <span class="c1"># Use OpenCV&#39;s minAreaRect</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">box_points</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

            <span class="c1"># Convert to shapely polygon</span>
            <span class="n">oriented_box</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">box_points</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">oriented_box</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_rectangularity</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">oriented_box</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calculate the rectangularity (area ratio to its oriented bounding box)&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">oriented_box</span><span class="o">.</span><span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">oriented_box</span><span class="o">.</span><span class="n">area</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">check_orthogonality</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check what percentage of angles in the polygon are orthogonal&quot;&quot;&quot;</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Triangle or point</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="c1"># Remove last point (same as first)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">orthogonal_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_angles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_angles</span><span class="p">):</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">total_angles</span><span class="p">]</span>
                <span class="n">p3</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">total_angles</span><span class="p">]</span>

                <span class="n">angle</span> <span class="o">=</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_orthogonal</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
                    <span class="n">orthogonal_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="n">orthogonal_count</span> <span class="o">/</span> <span class="n">total_angles</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">simplify_to_rectangle</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Polygon</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Simplify a polygon to a rectangle using its oriented bounding box&quot;&quot;&quot;</span>
            <span class="c1"># Get dominant direction</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">calculate_dominant_direction</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

            <span class="c1"># Create oriented envelope</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">create_oriented_envelope</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">rect</span>

        <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Objects to regularize&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gdf</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regularizing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Angle threshold: </span><span class="si">{</span><span class="n">angle_threshold</span><span class="si">}</span><span class="s2">° from 90°&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min orthogonality: </span><span class="si">{</span><span class="n">orthogonality_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of angles&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Min rectangularity: </span><span class="si">{</span><span class="n">rectangularity_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of bounding box area&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create a copy to avoid modifying the original</span>
        <span class="n">result_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Track statistics</span>
        <span class="n">total_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
        <span class="n">regularized_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rectangularized_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Process each Object</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)):</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>

            <span class="c1"># Skip invalid or empty geometries</span>
            <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Handle MultiPolygons by processing the largest part</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">):</span>
                <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">areas</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">areas</span><span class="p">)]</span>

            <span class="c1"># Filter out tiny Objects</span>
            <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check orthogonality</span>
            <span class="n">orthogonality</span> <span class="o">=</span> <span class="n">check_orthogonality</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>

            <span class="c1"># Create oriented envelope</span>
            <span class="n">oriented_box</span> <span class="o">=</span> <span class="n">create_oriented_envelope</span><span class="p">(</span>
                <span class="n">geom</span><span class="p">,</span> <span class="n">calculate_dominant_direction</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Check rectangularity</span>
            <span class="n">rectangularity</span> <span class="o">=</span> <span class="n">get_rectangularity</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">oriented_box</span><span class="p">)</span>

            <span class="c1"># Decide how to regularize</span>
            <span class="k">if</span> <span class="n">rectangularity</span> <span class="o">&gt;=</span> <span class="n">rectangularity_threshold</span><span class="p">:</span>
                <span class="c1"># Object is already quite rectangular, simplify to a rectangle</span>
                <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oriented_box</span>
                <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;regularized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rectangle&quot;</span>
                <span class="n">rectangularized_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">orthogonality</span> <span class="o">&gt;=</span> <span class="n">orthogonality_threshold</span><span class="p">:</span>
                <span class="c1"># Object has many orthogonal angles but isn&#39;t rectangular</span>
                <span class="c1"># Could implement more sophisticated regularization here</span>
                <span class="c1"># For now, we&#39;ll still use the oriented rectangle</span>
                <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oriented_box</span>
                <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;regularized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;orthogonal&quot;</span>
                <span class="n">regularized_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Object doesn&#39;t have clear orthogonal structure</span>
                <span class="c1"># Keep original but flag as unmodified</span>
                <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;regularized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span>

        <span class="c1"># Report statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regularization completed:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total objects: </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Rectangular objects: </span><span class="si">{</span><span class="n">rectangularized_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">rectangularized_count</span><span class="o">/</span><span class="n">total_objects</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Other regularized objects: </span><span class="si">{</span><span class="n">regularized_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">regularized_count</span><span class="o">/</span><span class="n">total_objects</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Unmodified objects: </span><span class="si">{</span><span class="n">total_objects</span><span class="o">-</span><span class="n">rectangularized_count</span><span class="o">-</span><span class="n">regularized_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">total_objects</span><span class="o">-</span><span class="n">rectangularized_count</span><span class="o">-</span><span class="n">regularized_count</span><span class="p">)</span><span class="o">/</span><span class="n">total_objects</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result_gdf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">gdf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize object detection results with proper coordinate transformation.</span>

<span class="sd">        This function displays objects on top of the raster image,</span>
<span class="sd">        ensuring proper alignment between the GeoDataFrame polygons and the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to input raster</span>
<span class="sd">            gdf: GeoDataFrame with object polygons (optional)</span>
<span class="sd">            output_path: Path to save visualization (optional)</span>
<span class="sd">            figsize: Figure size (width, height) in inches</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if visualization was successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if raster file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raster_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Raster file &#39;</span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Process raster if GeoDataFrame not provided</span>
        <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_raster</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects to visualize&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if confidence column exists in the GeoDataFrame</span>
        <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Try to access a confidence value to confirm it works</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Try getitem access</span>
                    <span class="n">conf_val</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Using confidence values (range: </span><span class="si">{</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence column exists but couldn&#39;t access values: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No confidence column found in GeoDataFrame&quot;</span><span class="p">)</span>
            <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Read raster for visualization</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Read the entire image or a subset if it&#39;s very large</span>
            <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">2000</span> <span class="ow">or</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
                <span class="c1"># Calculate scale factor to reduce size</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2000</span> <span class="o">/</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">2000</span> <span class="o">/</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
                <span class="n">out_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Read and resample</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="n">out_shape</span><span class="o">=</span><span class="n">out_shape</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">bilinear</span>
                <span class="p">)</span>

                <span class="c1"># Create a scaled transform for the resampled image</span>
                <span class="c1"># Calculate scaling factors</span>
                <span class="n">x_scale</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">y_scale</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Get the original transform</span>
                <span class="n">orig_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

                <span class="c1"># Create a scaled transform</span>
                <span class="n">scaled_transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Affine</span><span class="p">(</span>
                    <span class="n">orig_transform</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">x_scale</span><span class="p">,</span>
                    <span class="n">orig_transform</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                    <span class="n">orig_transform</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">orig_transform</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
                    <span class="n">orig_transform</span><span class="o">.</span><span class="n">e</span> <span class="o">*</span> <span class="n">y_scale</span><span class="p">,</span>
                    <span class="n">orig_transform</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">scaled_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

            <span class="c1"># Convert to RGB for display</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Normalize image for display</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># CHW to HWC</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Likely 0-255 range</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Get image bounds</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Create figure with appropriate aspect ratio</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># width / height</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># Display image</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Make sure the GeoDataFrame has the same CRS as the raster</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">crs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting GeoDataFrame from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Set up colors for confidence visualization</span>
        <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>

                <span class="c1"># Get min/max confidence values</span>
                <span class="n">min_conf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">max_conf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="c1"># Set up normalization and colormap</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">min_conf</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_conf</span><span class="p">)</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>

                <span class="c1"># Create scalar mappable for colorbar</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

                <span class="c1"># Add colorbar</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                    <span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span>
                <span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Confidence Score&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up confidence visualization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Function to convert coordinates</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">geo_to_pixel</span><span class="p">(</span>
            <span class="n">geometry</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="n">Any</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert geometry to pixel coordinates using the provided transform.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">:</span>
                <span class="c1"># Get exterior coordinates</span>
                <span class="n">exterior_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

                <span class="c1"># Convert to pixel coordinates</span>
                <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[</span><span class="o">~</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">exterior_coords</span><span class="p">]</span>

                <span class="c1"># Split into x and y lists</span>
                <span class="n">pixel_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>
                <span class="n">pixel_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported geometry type: </span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">geom_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Plot each object</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Convert polygon to pixel coordinates</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">geo_to_pixel</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">scaled_transform</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
                    <span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span> <span class="o">=</span> <span class="n">coords</span>

                    <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Get confidence value using different methods</span>
                            <span class="c1"># Method 1: Try direct attribute access</span>
                            <span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">confidence</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="c1"># Method 2: Try dictionary-style access</span>
                            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                            <span class="c1"># Method 3: Try accessing by index from the GeoDataFrame</span>
                            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">confidence</span><span class="p">))</span>
                                <span class="c1"># Fill polygon with semi-transparent color</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                                <span class="c1"># Draw border</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                    <span class="n">pixel_x</span><span class="p">,</span>
                                    <span class="n">pixel_y</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Fall back to red if confidence value couldn&#39;t be accessed</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Error using confidence value for polygon </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># No confidence data, just plot outlines in red</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error plotting polygon </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Remove axes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;objects (Found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Save if requested</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Visualization saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Create a simpler visualization focused just on a subset of objects</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

            <span class="c1"># Choose a subset of the image to show</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># Get centroid of first object</span>
                <span class="n">sample_geom</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span>
                <span class="n">centroid</span> <span class="o">=</span> <span class="n">sample_geom</span><span class="o">.</span><span class="n">centroid</span>

                <span class="c1"># Convert to pixel coordinates</span>
                <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="o">~</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

                <span class="c1"># Define a window around this object</span>
                <span class="n">window_size</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># pixels</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="p">)</span>

                <span class="c1"># Read this window</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Convert to RGB for display</span>
                <span class="k">if</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sample_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Normalize image for display</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># CHW to HWC</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Likely 0-255 range</span>
                    <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span> <span class="o">/</span> <span class="mf">255.0</span>

                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Display sample image</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Get the correct transform for this window</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Calculate bounds of the window</span>
                <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
                <span class="n">window_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">window_bounds</span><span class="p">)</span>

                <span class="c1"># Filter objects that intersect with this window</span>
                <span class="n">visible_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_box</span><span class="p">)]</span>

                <span class="c1"># Set up colors for sample view if confidence data exists</span>
                <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Reuse the same normalization and colormap from main view</span>
                        <span class="n">sample_sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                        <span class="n">sample_sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

                        <span class="c1"># Add colorbar to sample view</span>
                        <span class="n">sample_cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                            <span class="n">sample_sm</span><span class="p">,</span>
                            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
                            <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                            <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">sample_cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Confidence Score&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up sample confidence visualization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Plot objects in sample view</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">visible_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Get window-relative pixel coordinates</span>
                        <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>

                        <span class="c1"># Skip empty geometries</span>
                        <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get exterior coordinates</span>
                        <span class="n">exterior_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

                        <span class="c1"># Convert to pixel coordinates relative to window origin</span>
                        <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">exterior_coords</span><span class="p">:</span>
                            <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="o">~</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Convert to image pixels</span>
                            <span class="c1"># Make coordinates relative to window</span>
                            <span class="n">px</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="n">window</span><span class="o">.</span><span class="n">col_off</span>
                            <span class="n">py</span> <span class="o">=</span> <span class="n">py</span> <span class="o">-</span> <span class="n">window</span><span class="o">.</span><span class="n">row_off</span>
                            <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>

                        <span class="c1"># Extract x and y coordinates</span>
                        <span class="n">pixel_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>
                        <span class="n">pixel_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>

                        <span class="c1"># Use confidence colors if available</span>
                        <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Try different methods to access confidence</span>
                                <span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">confidence</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                                <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>

                                <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">confidence</span> <span class="o">=</span> <span class="n">visible_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>

                                <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">confidence</span><span class="p">))</span>
                                    <span class="c1"># Fill polygon with semi-transparent color</span>
                                    <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                                    <span class="c1"># Draw border</span>
                                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                        <span class="n">pixel_x</span><span class="p">,</span>
                                        <span class="n">pixel_y</span><span class="p">,</span>
                                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                        <span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span>
                                    <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Error using confidence in sample view for polygon </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error plotting polygon in sample view: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Set title</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample Area - objects (Showing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">visible_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="c1"># Remove axes</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

                <span class="c1"># Save if requested</span>
                <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                    <span class="n">sample_output</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;_sample&quot;</span>
                        <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">sample_output</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample visualization saved to </span><span class="si">{</span><span class="n">sample_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">confidence_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">max_object_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span>
        <span class="n">overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">band_indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save masks with confidence values as a multi-band GeoTIFF.</span>

<span class="sd">        Objects with area smaller than min_object_area or larger than max_object_area</span>
<span class="sd">        will be filtered out.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_path: Path to input raster</span>
<span class="sd">            output_path: Path for output GeoTIFF</span>
<span class="sd">            confidence_threshold: Minimum confidence score (0.0-1.0)</span>
<span class="sd">            mask_threshold: Threshold for mask binarization (0.0-1.0)</span>
<span class="sd">            min_object_area: Minimum area (in pixels) for an object to be included</span>
<span class="sd">            max_object_area: Maximum area (in pixels) for an object to be included</span>
<span class="sd">            overlap: Overlap between tiles (0.0-1.0)</span>
<span class="sd">            batch_size: Batch size for processing</span>
<span class="sd">            band_indexes: List of band indexes to use (default: all bands)</span>
<span class="sd">            verbose: Whether to print detailed processing information</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to the saved GeoTIFF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use provided thresholds or fall back to instance defaults</span>
        <span class="k">if</span> <span class="n">confidence_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
        <span class="k">if</span> <span class="n">mask_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span>

        <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>

        <span class="c1"># Default output path</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_masks_conf.tif&quot;</span>

        <span class="c1"># Process the raster to get individual masks with confidence</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Create dataset with the specified overlap</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
                <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
                <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
                <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
                <span class="n">band_indexes</span><span class="o">=</span><span class="n">band_indexes</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create output profile</span>
            <span class="n">output_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">output_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Two bands: mask and confidence</span>
                <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Initialize mask and confidence arrays</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">conf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Define custom collate function to handle Shapely objects</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Custom collate function that handles Shapely geometries</span>
<span class="sd">                by keeping them as Python objects rather than trying to collate them.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                            <span class="c1"># Don&#39;t collate shapely objects, keep as list</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># For tensors and other collatable types</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                <span class="c1"># Fall back to list for non-collatable types</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Default collate for non-dict types</span>
                    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="c1"># Create dataloader with custom collate function</span>
            <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Process batches</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
                <span class="c1"># Move images to device</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>  <span class="c1"># Tensor of shape [batch_size, 2]</span>

                <span class="c1"># Run inference</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

                <span class="c1"># Process predictions</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
                    <span class="n">masks</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                    <span class="c1"># Filter by confidence threshold</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">confidence_threshold</span>
                    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

                    <span class="c1"># Skip if no valid predictions</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get window coordinates</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                    <span class="c1"># Process each mask</span>
                    <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                        <span class="c1"># Convert to binary mask</span>
                        <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

                        <span class="c1"># Check object area - calculate number of pixels in the mask</span>
                        <span class="n">object_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">binary_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="c1"># Skip objects that don&#39;t meet area criteria</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">object_area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span>
                            <span class="ow">or</span> <span class="n">object_area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span>
                        <span class="p">):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Filtering out object with area </span><span class="si">{</span><span class="n">object_area</span><span class="si">}</span><span class="s2"> pixels&quot;</span>
                                <span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="n">conf_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># Scale to 0-255</span>

                        <span class="c1"># Update the mask and confidence arrays</span>
                        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">valid_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>
                        <span class="n">valid_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">valid_h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Use maximum for overlapping regions in the mask</span>
                            <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                                <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">],</span>
                                <span class="n">binary_mask</span><span class="p">[:</span><span class="n">valid_h</span><span class="p">,</span> <span class="p">:</span><span class="n">valid_w</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="c1"># For confidence, only update where mask is positive</span>
                            <span class="c1"># and confidence is higher than existing</span>
                            <span class="n">mask_region</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="p">[:</span><span class="n">valid_h</span><span class="p">,</span> <span class="p">:</span><span class="n">valid_w</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_region</span><span class="p">):</span>
                                <span class="c1"># Only update where mask is positive and new confidence is higher</span>
                                <span class="n">current_conf</span> <span class="o">=</span> <span class="n">conf_array</span><span class="p">[</span>
                                    <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span>
                                <span class="p">]</span>

                                <span class="c1"># Where to update confidence (mask positive &amp; higher confidence)</span>
                                <span class="n">update_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                    <span class="n">mask_region</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                        <span class="n">current_conf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">current_conf</span> <span class="o">&lt;</span> <span class="n">conf_value</span>
                                    <span class="p">),</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">update_mask</span><span class="p">):</span>
                                    <span class="n">conf_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">][</span>
                                        <span class="n">update_mask</span>
                                    <span class="p">]</span> <span class="o">=</span> <span class="n">conf_value</span>

            <span class="c1"># Write to GeoTIFF</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">output_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conf_array</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Masks with confidence values saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vectorize_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">masks_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">confidence_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert masks with confidence to vector polygons.</span>

<span class="sd">        Args:</span>
<span class="sd">            masks_path: Path to masks GeoTIFF with confidence band.</span>
<span class="sd">            output_path: Path for output GeoJSON.</span>
<span class="sd">            confidence_threshold: Minimum confidence score (0.0-1.0). Default: 0.5</span>
<span class="sd">            min_object_area: Minimum area in pixels to keep an object. Default: 100</span>
<span class="sd">            max_object_area: Maximum area in pixels to keep an object. Default: None</span>
<span class="sd">            n_workers: int, default=None</span>
<span class="sd">                The number of worker threads to use.</span>
<span class="sd">                &quot;None&quot; means single-threaded processing.</span>
<span class="sd">                &quot;-1&quot;   means using all available CPU processors.</span>
<span class="sd">                Positive integer means using that specific number of threads.</span>
<span class="sd">            **kwargs: Additional parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame with car detections and confidence values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_component</span><span class="p">(</span>
            <span class="n">component_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">conf_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">transform</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
            <span class="n">confidence_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="c1"># Get confidence value</span>
            <span class="n">conf_region</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="n">component_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf_region</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">conf_region</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Skip if confidence is below threshold</span>
            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">confidence_threshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Find contours</span>
            <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                <span class="n">component_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
            <span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                <span class="c1"># Filter by size</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get minimum area rectangle</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                <span class="n">box_points</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

                <span class="c1"># Convert to geographic coordinates</span>
                <span class="n">geo_points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">box_points</span><span class="p">:</span>
                    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">geo_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                <span class="c1"># Create polygon</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">poly</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">area</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_component</span><span class="p">(</span>
            <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper function to process a single component</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">(</span>
                <span class="n">label</span><span class="p">,</span>
                <span class="n">labeled_mask</span><span class="p">,</span>
                <span class="n">conf_data</span><span class="p">,</span>
                <span class="n">transform</span><span class="p">,</span>
                <span class="n">confidence_threshold</span><span class="p">,</span>
                <span class="n">min_object_area</span><span class="p">,</span>
                <span class="n">max_object_area</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

            <span class="c1"># Create mask for this component</span>
            <span class="n">component_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_mask</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_process_single_component</span><span class="p">(</span>
                <span class="n">component_mask</span><span class="p">,</span>
                <span class="n">conf_data</span><span class="p">,</span>
                <span class="n">transform</span><span class="p">,</span>
                <span class="n">confidence_threshold</span><span class="p">,</span>
                <span class="n">min_object_area</span><span class="p">,</span>
                <span class="n">max_object_area</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing masks from: </span><span class="si">{</span><span class="n">masks_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_workers</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_workers</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">masks_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Read mask and confidence bands</span>
            <span class="n">mask_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">conf_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

            <span class="c1"># Convert to binary mask</span>
            <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">mask_data</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="c1"># Find connected components</span>
            <span class="n">labeled_mask</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_features</span><span class="si">}</span><span class="s2"> connected components&quot;</span><span class="p">)</span>

            <span class="c1"># Process each component</span>
            <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">confidences</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">n_workers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_workers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Using single-threaded processing, you can speed up processing by setting n_workers &gt; 1&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Add progress bar</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing components&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># Create mask for this component</span>
                    <span class="n">component_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_mask</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">_process_single_component</span><span class="p">(</span>
                        <span class="n">component_mask</span><span class="p">,</span>
                        <span class="n">conf_data</span><span class="p">,</span>
                        <span class="n">transform</span><span class="p">,</span>
                        <span class="n">confidence_threshold</span><span class="p">,</span>
                        <span class="n">min_object_area</span><span class="p">,</span>
                        <span class="n">max_object_area</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">poly</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="c1"># Add to lists</span>
                            <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
                            <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>
                            <span class="n">pixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Process components in parallel</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">n_workers</span><span class="si">}</span><span class="s2"> workers for parallel processing&quot;</span><span class="p">)</span>

                <span class="n">process_args</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">label</span><span class="p">,</span>
                        <span class="n">labeled_mask</span><span class="p">,</span>
                        <span class="n">conf_data</span><span class="p">,</span>
                        <span class="n">transform</span><span class="p">,</span>
                        <span class="n">confidence_threshold</span><span class="p">,</span>
                        <span class="n">min_object_area</span><span class="p">,</span>
                        <span class="n">max_object_area</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
                    <span class="n">max_workers</span><span class="o">=</span><span class="n">n_workers</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">tqdm</span><span class="p">(</span>
                            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_component</span><span class="p">,</span> <span class="n">process_args</span><span class="p">),</span>
                            <span class="n">total</span><span class="o">=</span><span class="n">num_features</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing components&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">poly</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                                <span class="c1"># Add to lists</span>
                                <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
                                <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>
                                <span class="n">pixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

            <span class="c1"># Create GeoDataFrame</span>
            <span class="k">if</span> <span class="n">polygons</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">polygons</span><span class="p">,</span>
                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidences</span><span class="p">,</span>
                        <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">),</span>
                        <span class="s2">&quot;pixels&quot;</span><span class="p">:</span> <span class="n">pixels</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Save to file if requested</span>
                <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                    <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects with confidence to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total processing time: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">gdf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total processing time: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the object extractor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face repository ID for model download.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pre-initialized model object (optional).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_classes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for detection (default: 2).</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the object extractor.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Hugging Face repository ID for model download.</span>
<span class="sd">        model: Pre-initialized model object (optional).</span>
<span class="sd">        num_classes: Number of classes for detection (default: 2).</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set device</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Default parameters for object detection - these can be overridden in process_raster</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>  <span class="c1"># Size of image chips for processing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># Default overlap between tiles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Default confidence threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># IoU threshold for non-maximum suppression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Minimum area in pixels to keep an object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Maximum area in pixels to keep an object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Threshold for mask binarization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Tolerance for polygon simplification</span>

    <span class="c1"># Initialize model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="c1"># Download model if needed</span>
    <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">)):</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">)</span>

    <span class="c1"># Load model weights</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

    <span class="c1"># Set model to evaluation mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.download_model_from_hf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.download_model_from_hf" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Download the object detection model from Hugging Face.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the model file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face repository ID.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the downloaded model file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">download_model_from_hf</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the object detection model from Hugging Face.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the model file.</span>
<span class="sd">        repo_id: Hugging Face repository ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the downloaded model file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model path not specified, downloading from Hugging Face...&quot;</span><span class="p">)</span>

        <span class="c1"># Define the repository ID and model filename</span>
        <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="s2">&quot;giswqs/geoai&quot;</span>

        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;building_footprints_usa.pth&quot;</span>

        <span class="c1"># Download the model</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model downloaded to: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading model from Hugging Face: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify a local model path or ensure internet connectivity.&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.filter_edge_objects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_edge_objects</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">raster_path</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.filter_edge_objects" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Filter out object detections that fall in padding/edge areas of the image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>gdf</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with object detections</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the original raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edge_buffer</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer in pixels to consider as edge region</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with filtered objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_edge_objects</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out object detections that fall in padding/edge areas of the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        gdf: GeoDataFrame with object detections</span>
<span class="sd">        raster_path: Path to the original raster file</span>
<span class="sd">        edge_buffer: Buffer in pixels to consider as edge region</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with filtered objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>

    <span class="c1"># If no objects detected, return empty GeoDataFrame</span>
    <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Objects before filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get raster bounds</span>
        <span class="n">raster_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">raster_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">raster_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>

        <span class="c1"># Convert edge buffer from pixels to geographic units</span>
        <span class="c1"># We need the smallest dimension of a pixel in geographic units</span>
        <span class="n">pixel_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">raster_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">raster_width</span>
        <span class="n">pixel_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">raster_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">raster_height</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pixel_width</span><span class="p">,</span> <span class="n">pixel_height</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge_buffer</span>

        <span class="c1"># Create a slightly smaller bounding box to exclude edge regions</span>
        <span class="n">inner_bounds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># min x (west)</span>
            <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># min y (south)</span>
            <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># max x (east)</span>
            <span class="n">raster_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">buffer_size</span><span class="p">,</span>  <span class="c1"># max y (north)</span>
        <span class="p">)</span>

        <span class="c1"># Check that inner bounds are valid</span>
        <span class="k">if</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">inner_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Edge buffer too large, using original bounds&quot;</span><span class="p">)</span>
            <span class="n">inner_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">raster_bounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inner_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">inner_bounds</span><span class="p">)</span>

        <span class="c1"># Filter out objects that intersect with the edge of the image</span>
        <span class="n">filtered_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">inner_box</span><span class="p">)]</span>

        <span class="c1"># Additional check for objects that have &gt;50% of their area outside the valid region</span>
        <span class="n">valid_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">inner_box</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="p">:</span>
                <span class="n">valid_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">filtered_gdf</span> <span class="o">=</span> <span class="n">filtered_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_objects</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Objects after filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.filter_overlapping_polygons" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.filter_overlapping_polygons" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Filter overlapping polygons using non-maximum suppression.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>gdf</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with polygons</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parameters:
nms_iou_threshold: IoU threshold for filtering</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filtered GeoDataFrame</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_overlapping_polygons</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter overlapping polygons using non-maximum suppression.</span>

<span class="sd">    Args:</span>
<span class="sd">        gdf: GeoDataFrame with polygons</span>
<span class="sd">        **kwargs: Optional parameters:</span>
<span class="sd">            nms_iou_threshold: IoU threshold for filtering</span>

<span class="sd">    Returns:</span>
<span class="sd">        Filtered GeoDataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="c1"># Get parameters from kwargs or use instance defaults</span>
    <span class="n">iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span><span class="p">)</span>

    <span class="c1"># Sort by confidence</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Fix any invalid geometries</span>
    <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_valid</span> <span class="k">else</span> <span class="n">geom</span>
    <span class="p">)</span>

    <span class="n">keep_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
            <span class="c1"># Skip invalid geometries</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Calculate IoU</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">intersection</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">area</span>
                <span class="n">union</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">-</span> <span class="n">intersection</span>
                <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span> <span class="k">if</span> <span class="n">union</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">iou_threshold</span><span class="p">:</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Skip on topology exceptions</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
            <span class="n">keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.generate_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_object_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_object_area</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">band_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.generate_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save masks with confidence values as a multi-band GeoTIFF.</p>
<p>Objects with area smaller than min_object_area or larger than max_object_area
will be filtered out.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path for output GeoTIFF</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence_threshold</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence score (0.0-1.0)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_threshold</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for mask binarization (0.0-1.0)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_object_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area (in pixels) for an object to be included</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_object_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum area (in pixels) for an object to be included</p>
              </div>
            </td>
            <td>
                  <code><span title="float">float</span>(&#39;inf&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between tiles (0.0-1.0)</p>
              </div>
            </td>
            <td>
                  <code>0.25</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for processing</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indexes to use (default: all bands)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print detailed processing information</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved GeoTIFF</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">confidence_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_object_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">band_indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save masks with confidence values as a multi-band GeoTIFF.</span>

<span class="sd">    Objects with area smaller than min_object_area or larger than max_object_area</span>
<span class="sd">    will be filtered out.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to input raster</span>
<span class="sd">        output_path: Path for output GeoTIFF</span>
<span class="sd">        confidence_threshold: Minimum confidence score (0.0-1.0)</span>
<span class="sd">        mask_threshold: Threshold for mask binarization (0.0-1.0)</span>
<span class="sd">        min_object_area: Minimum area (in pixels) for an object to be included</span>
<span class="sd">        max_object_area: Maximum area (in pixels) for an object to be included</span>
<span class="sd">        overlap: Overlap between tiles (0.0-1.0)</span>
<span class="sd">        batch_size: Batch size for processing</span>
<span class="sd">        band_indexes: List of band indexes to use (default: all bands)</span>
<span class="sd">        verbose: Whether to print detailed processing information</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the saved GeoTIFF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use provided thresholds or fall back to instance defaults</span>
    <span class="k">if</span> <span class="n">confidence_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
    <span class="k">if</span> <span class="n">mask_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span>

    <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>

    <span class="c1"># Default output path</span>
    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_masks_conf.tif&quot;</span>

    <span class="c1"># Process the raster to get individual masks with confidence</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Create dataset with the specified overlap</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
            <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
            <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
            <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">band_indexes</span><span class="o">=</span><span class="n">band_indexes</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create output profile</span>
        <span class="n">output_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">output_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Two bands: mask and confidence</span>
            <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span>
            <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Initialize mask and confidence arrays</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">conf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Define custom collate function to handle Shapely objects</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Custom collate function that handles Shapely geometries</span>
<span class="sd">            by keeping them as Python objects rather than trying to collate them.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t collate shapely objects, keep as list</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For tensors and other collatable types</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="c1"># Fall back to list for non-collatable types</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default collate for non-dict types</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="c1"># Create dataloader with custom collate function</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Process batches</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="c1"># Move images to device</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>  <span class="c1"># Tensor of shape [batch_size, 2]</span>

            <span class="c1"># Run inference</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="c1"># Process predictions</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                <span class="c1"># Filter by confidence threshold</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">confidence_threshold</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

                <span class="c1"># Skip if no valid predictions</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get window coordinates</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                <span class="c1"># Process each mask</span>
                <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                    <span class="c1"># Convert to binary mask</span>
                    <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

                    <span class="c1"># Check object area - calculate number of pixels in the mask</span>
                    <span class="n">object_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">binary_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># Skip objects that don&#39;t meet area criteria</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">object_area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span>
                        <span class="ow">or</span> <span class="n">object_area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Filtering out object with area </span><span class="si">{</span><span class="n">object_area</span><span class="si">}</span><span class="s2"> pixels&quot;</span>
                            <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">conf_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># Scale to 0-255</span>

                    <span class="c1"># Update the mask and confidence arrays</span>
                    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">valid_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>
                    <span class="n">valid_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">valid_h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Use maximum for overlapping regions in the mask</span>
                        <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                            <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">],</span>
                            <span class="n">binary_mask</span><span class="p">[:</span><span class="n">valid_h</span><span class="p">,</span> <span class="p">:</span><span class="n">valid_w</span><span class="p">],</span>
                        <span class="p">)</span>

                        <span class="c1"># For confidence, only update where mask is positive</span>
                        <span class="c1"># and confidence is higher than existing</span>
                        <span class="n">mask_region</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="p">[:</span><span class="n">valid_h</span><span class="p">,</span> <span class="p">:</span><span class="n">valid_w</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_region</span><span class="p">):</span>
                            <span class="c1"># Only update where mask is positive and new confidence is higher</span>
                            <span class="n">current_conf</span> <span class="o">=</span> <span class="n">conf_array</span><span class="p">[</span>
                                <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span>
                            <span class="p">]</span>

                            <span class="c1"># Where to update confidence (mask positive &amp; higher confidence)</span>
                            <span class="n">update_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                <span class="n">mask_region</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                    <span class="n">current_conf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">current_conf</span> <span class="o">&lt;</span> <span class="n">conf_value</span>
                                <span class="p">),</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">update_mask</span><span class="p">):</span>
                                <span class="n">conf_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">][</span>
                                    <span class="n">update_mask</span>
                                <span class="p">]</span> <span class="o">=</span> <span class="n">conf_value</span>

        <span class="c1"># Write to GeoTIFF</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">output_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conf_array</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Masks with confidence values saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.initialize_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.initialize_model" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize a deep learning model for object detection.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pre-initialized model object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_classes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for detection.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.nn.Module: A deep learning model for object detection.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a deep learning model for object detection.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): A pre-initialized model object.</span>
<span class="sd">        num_classes (int): Number of classes for detection.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.nn.Module: A deep learning model for object detection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Initialize Mask R-CNN model with ResNet50 backbone.</span>
        <span class="c1"># Standard image mean and std for pre-trained models</span>
        <span class="n">image_mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]</span>
        <span class="n">image_std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>

        <span class="c1"># Create model with explicit normalization parameters</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">maskrcnn_resnet50_fpn</span><span class="p">(</span>
            <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>  <span class="c1"># Background + object</span>
            <span class="n">weights_backbone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="c1"># These parameters ensure consistent normalization</span>
            <span class="n">image_mean</span><span class="o">=</span><span class="n">image_mean</span><span class="p">,</span>
            <span class="n">image_std</span><span class="o">=</span><span class="n">image_std</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.load_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_weights</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.load_weights" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load weights from file with error handling for different formats.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to model weights</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load weights from file with error handling for different formats.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to model weights</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Handle different state dict formats</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;state_dict&quot;</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>

        <span class="c1"># Try to load state dict</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to fix state_dict keys...&quot;</span><span class="p">)</span>

            <span class="c1"># Try to fix state_dict keys (remove module prefix if needed)</span>
            <span class="n">new_state_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;module.&quot;</span><span class="p">):</span>
                    <span class="n">new_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">7</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">new_state_dict</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully after key fixing&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.mask_to_polygons" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mask_to_polygons</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.mask_to_polygons" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert binary mask to polygon contours using OpenCV.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Binary mask as numpy array</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parameters:
simplify_tolerance: Tolerance for polygon simplification
mask_threshold: Threshold for mask binarization
min_object_area: Minimum area in pixels to keep an object
max_object_area: Maximum area in pixels to keep an object</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of polygons as lists of (x, y) coordinates</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mask_to_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert binary mask to polygon contours using OpenCV.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask: Binary mask as numpy array</span>
<span class="sd">        **kwargs: Optional parameters:</span>
<span class="sd">            simplify_tolerance: Tolerance for polygon simplification</span>
<span class="sd">            mask_threshold: Threshold for mask binarization</span>
<span class="sd">            min_object_area: Minimum area in pixels to keep an object</span>
<span class="sd">            max_object_area: Maximum area in pixels to keep an object</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of polygons as lists of (x, y) coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get parameters from kwargs or use instance defaults</span>
    <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simplify_tolerance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span><span class="p">)</span>
    <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
    <span class="n">min_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span><span class="p">)</span>
    <span class="n">max_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span><span class="p">)</span>

    <span class="c1"># Ensure binary mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Optional: apply morphological operations to improve mask quality</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

    <span class="c1"># Find contours</span>
    <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

    <span class="c1"># Convert to list of [x, y] coordinates</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
        <span class="c1"># Filter out too small contours</span>
        <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Filter out too large contours</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_object_area</span>
        <span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Simplify contour if it has many points</span>
        <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert to list of [x, y] coordinates</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">polygons</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.masks_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">masks_to_vector</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_object_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_object_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regularize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.masks_to_vector" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert an object mask GeoTIFF to vector polygons and save as GeoJSON.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the object masks GeoTIFF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoJSON or Parquet file (default: mask_path with .geojson extension)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for polygon simplification (default: self.simplify_tolerance)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_threshold</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for mask binarization (default: self.mask_threshold)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_object_area</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in pixels to keep an object (default: self.min_object_area)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_object_area</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in pixels to keep an object (default: self.max_object_area)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nms_iou_threshold</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regularize</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to regularize objects to right angles (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle_threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum deviation from 90 degrees for regularization (default: 15)</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rectangularity_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for rectangle simplification (default: 0.7)</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">masks_to_vector</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mask_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nms_iou_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">regularize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">rectangularity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an object mask GeoTIFF to vector polygons and save as GeoJSON.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask_path: Path to the object masks GeoTIFF</span>
<span class="sd">        output_path: Path to save the output GeoJSON or Parquet file (default: mask_path with .geojson extension)</span>
<span class="sd">        simplify_tolerance: Tolerance for polygon simplification (default: self.simplify_tolerance)</span>
<span class="sd">        mask_threshold: Threshold for mask binarization (default: self.mask_threshold)</span>
<span class="sd">        min_object_area: Minimum area in pixels to keep an object (default: self.min_object_area)</span>
<span class="sd">        max_object_area: Minimum area in pixels to keep an object (default: self.max_object_area)</span>
<span class="sd">        nms_iou_threshold: IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</span>
<span class="sd">        regularize: Whether to regularize objects to right angles (default: True)</span>
<span class="sd">        angle_threshold: Maximum deviation from 90 degrees for regularization (default: 15)</span>
<span class="sd">        rectangularity_threshold: Threshold for rectangle simplification (default: 0.7)</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use class defaults if parameters not provided</span>
    <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">simplify_tolerance</span>
        <span class="k">if</span> <span class="n">simplify_tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span>
    <span class="p">)</span>
    <span class="n">mask_threshold</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mask_threshold</span> <span class="k">if</span> <span class="n">mask_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span>
    <span class="p">)</span>
    <span class="n">min_object_area</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">min_object_area</span> <span class="k">if</span> <span class="n">min_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span>
    <span class="p">)</span>
    <span class="n">max_object_area</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">max_object_area</span> <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span>
    <span class="p">)</span>
    <span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">nms_iou_threshold</span>
        <span class="k">if</span> <span class="n">nms_iou_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span>
    <span class="p">)</span>

    <span class="c1"># Set default output path if not provided</span>
    <span class="c1"># if output_path is None:</span>
    <span class="c1">#     output_path = os.path.splitext(mask_path)[0] + &quot;.geojson&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting mask to GeoJSON with parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min object area: </span><span class="si">{</span><span class="n">min_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Max object area: </span><span class="si">{</span><span class="n">max_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Simplify tolerance: </span><span class="si">{</span><span class="n">simplify_tolerance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- NMS IoU threshold: </span><span class="si">{</span><span class="n">nms_iou_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Regularize objects: </span><span class="si">{</span><span class="n">regularize</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">regularize</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Angle threshold: </span><span class="si">{</span><span class="n">angle_threshold</span><span class="si">}</span><span class="s2">° from 90°&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Rectangularity threshold: </span><span class="si">{</span><span class="n">rectangularity_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="c1"># Open the mask raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the mask data</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Print mask statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask dimensions: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask value range: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare for connected component analysis</span>
        <span class="c1"># Binarize the mask based on threshold</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mask_threshold</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Apply morphological operations for better results (optional)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># Find connected components</span>
        <span class="n">num_labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span>
            <span class="n">binary_mask</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_labels</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> potential objects&quot;</span>
        <span class="p">)</span>  <span class="c1"># Subtract 1 for background</span>

        <span class="c1"># Create list to store polygons and confidence values</span>
        <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_confidences</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each component (skip the first one which is background)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">)):</span>
            <span class="c1"># Extract this object</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CC_STAT_AREA</span><span class="p">]</span>

            <span class="c1"># Skip if too small</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Skip if too large</span>
            <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Create a mask for this object</span>
            <span class="n">object_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Find contours</span>
            <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                <span class="n">object_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
            <span class="p">)</span>

            <span class="c1"># Process each contour</span>
            <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                <span class="c1"># Skip if too few points</span>
                <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Simplify contour if it has many points</span>
                <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">simplify_tolerance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Convert to list of (x, y) coordinates</span>
                <span class="n">polygon_points</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Convert pixel coordinates to geographic coordinates</span>
                <span class="n">geo_points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">polygon_points</span><span class="p">:</span>
                    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">geo_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                <span class="c1"># Create Shapely polygon</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shapely_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely_poly</span><span class="p">)</span>

                            <span class="c1"># Calculate &quot;confidence&quot; as normalized size</span>
                            <span class="c1"># This is a proxy since we don&#39;t have model confidence scores</span>
                            <span class="n">normalized_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">area</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Cap at 1.0</span>
                            <span class="n">all_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_size</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid polygons&quot;</span><span class="p">)</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_polygons</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">all_polygons</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">all_confidences</span><span class="p">,</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Object class</span>
            <span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Apply non-maximum suppression to remove overlapping polygons</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_overlapping_polygons</span><span class="p">(</span>
            <span class="n">gdf</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object count after NMS filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Apply regularization if requested</span>
        <span class="k">if</span> <span class="n">regularize</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Convert pixel area to geographic units for min_area parameter</span>
            <span class="c1"># Estimate pixel size in geographic units</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">pixel_size_x</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span>
                    <span class="mi">0</span>
                <span class="p">]</span>  <span class="c1"># width of a pixel in geographic units</span>
                <span class="n">pixel_size_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">)</span>  <span class="c1"># height of a pixel in geographic units</span>
                <span class="n">avg_pixel_area</span> <span class="o">=</span> <span class="n">pixel_size_x</span> <span class="o">*</span> <span class="n">pixel_size_y</span>

            <span class="c1"># Use 10 pixels as minimum area in geographic units</span>
            <span class="n">min_geo_area</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">avg_pixel_area</span>

            <span class="c1"># Regularize objects</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularize_objects</span><span class="p">(</span>
                <span class="n">gdf</span><span class="p">,</span>
                <span class="n">min_area</span><span class="o">=</span><span class="n">min_geo_area</span><span class="p">,</span>
                <span class="n">angle_threshold</span><span class="o">=</span><span class="n">angle_threshold</span><span class="p">,</span>
                <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="n">rectangularity_threshold</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Save to file</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.process_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_raster</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">filter_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">band_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.process_raster" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a raster file to extract objects with customizable parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output GeoJSON or Parquet file (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for processing</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filter_edges</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to filter out objects at the edges of the image</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edge_buffer</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of edge buffer in pixels to filter out objects (if filter_edges=True)</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indexes to use (if None, use all bands)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters:
confidence_threshold: Minimum confidence score to keep a detection (0.0-1.0)
overlap: Overlap between adjacent tiles (0.0-1.0)
chip_size: Size of image chips for processing (height, width)
nms_iou_threshold: IoU threshold for non-maximum suppression (0.0-1.0)
mask_threshold: Threshold for mask binarization (0.0-1.0)
min_object_area: Minimum area in pixels to keep an object
simplify_tolerance: Tolerance for polygon simplification</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_raster</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">filter_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">edge_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">band_indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;gpd.GeoDataFrame&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a raster file to extract objects with customizable parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to input raster file</span>
<span class="sd">        output_path: Path to output GeoJSON or Parquet file (optional)</span>
<span class="sd">        batch_size: Batch size for processing</span>
<span class="sd">        filter_edges: Whether to filter out objects at the edges of the image</span>
<span class="sd">        edge_buffer: Size of edge buffer in pixels to filter out objects (if filter_edges=True)</span>
<span class="sd">        band_indexes: List of band indexes to use (if None, use all bands)</span>
<span class="sd">        **kwargs: Additional parameters:</span>
<span class="sd">            confidence_threshold: Minimum confidence score to keep a detection (0.0-1.0)</span>
<span class="sd">            overlap: Overlap between adjacent tiles (0.0-1.0)</span>
<span class="sd">            chip_size: Size of image chips for processing (height, width)</span>
<span class="sd">            nms_iou_threshold: IoU threshold for non-maximum suppression (0.0-1.0)</span>
<span class="sd">            mask_threshold: Threshold for mask binarization (0.0-1.0)</span>
<span class="sd">            min_object_area: Minimum area in pixels to keep an object</span>
<span class="sd">            simplify_tolerance: Tolerance for polygon simplification</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get parameters from kwargs or use instance defaults</span>
    <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
    <span class="p">)</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
    <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>
    <span class="n">nms_iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_iou_threshold</span><span class="p">)</span>
    <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
    <span class="n">min_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_area</span><span class="p">)</span>
    <span class="n">max_object_area</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_object_area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_object_area</span><span class="p">)</span>
    <span class="n">simplify_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simplify_tolerance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_tolerance</span><span class="p">)</span>

    <span class="c1"># Print parameters being used</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing with parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Confidence threshold: </span><span class="si">{</span><span class="n">confidence_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Tile overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Chip size: </span><span class="si">{</span><span class="n">chip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- NMS IoU threshold: </span><span class="si">{</span><span class="n">nms_iou_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min object area: </span><span class="si">{</span><span class="n">min_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Max object area: </span><span class="si">{</span><span class="n">max_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Simplify tolerance: </span><span class="si">{</span><span class="n">simplify_tolerance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Filter edge objects: </span><span class="si">{</span><span class="n">filter_edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filter_edges</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Edge buffer size: </span><span class="si">{</span><span class="n">edge_buffer</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

    <span class="c1"># Create dataset</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
        <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
        <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
        <span class="n">band_indexes</span><span class="o">=</span><span class="n">band_indexes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">raster_stats</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">raster_stats</span>

    <span class="c1"># Custom collate function to handle Shapely objects</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Custom collate function that handles Shapely geometries</span>
<span class="sd">        by keeping them as Python objects rather than trying to collate them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t collate shapely objects, keep as list</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For tensors and other collatable types</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="c1"># Fall back to list for non-collatable types</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default collate for non-dict types</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># Create dataloader with simple indexing and custom collate</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Process batches</span>
    <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_scores</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
        <span class="c1"># Move images to device</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>  <span class="c1"># (i, j) coordinates in pixels</span>
        <span class="n">bboxes</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span>
            <span class="s2">&quot;bbox&quot;</span>
        <span class="p">]</span>  <span class="c1"># Geographic bounding boxes - now a list, not a tensor</span>

        <span class="c1"># Run inference</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># Process predictions</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="c1"># Skip if no predictions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Filter by confidence threshold</span>
            <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">confidence_threshold</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

            <span class="c1"># Skip if no valid predictions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get window coordinates</span>
            <span class="c1"># The coords might be in different formats depending on batch handling</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># If coords is a list of tuples</span>
                <span class="n">coord_item</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="c1"># If coords is a tensor of shape [batch_size, 2]</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get window size</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">window_item</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">window_item</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">window_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected window_size format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected window_size type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;window_size&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Process masks to polygons</span>
            <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                <span class="c1"># Get binary mask</span>
                <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Get binary mask</span>

                <span class="c1"># Convert mask to polygon with custom parameters</span>
                <span class="n">contours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_to_polygons</span><span class="p">(</span>
                    <span class="n">binary_mask</span><span class="p">,</span>
                    <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
                    <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
                    <span class="n">min_object_area</span><span class="o">=</span><span class="n">min_object_area</span><span class="p">,</span>
                    <span class="n">max_object_area</span><span class="o">=</span><span class="n">max_object_area</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Skip if no valid polygons</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">contours</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Transform polygons to geographic coordinates</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

                    <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                        <span class="c1"># Convert polygon to global coordinates</span>
                        <span class="n">global_polygon</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
                            <span class="c1"># Adjust coordinates based on window position</span>
                            <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
                            <span class="n">global_polygon</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                        <span class="c1"># Create Shapely polygon</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">global_polygon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">shapely_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">global_polygon</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely_poly</span><span class="p">)</span>
                                    <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_idx</span><span class="p">]))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create GeoDataFrame</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_polygons</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">all_polygons</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">all_scores</span><span class="p">,</span>
            <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Object class</span>
        <span class="p">},</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Remove overlapping polygons with custom threshold</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span><span class="p">)</span>

    <span class="c1"># Filter edge objects if requested</span>
    <span class="k">if</span> <span class="n">filter_edges</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_edge_objects</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">raster_path</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="o">=</span><span class="n">edge_buffer</span><span class="p">)</span>

    <span class="c1"># Save to file if requested</span>
    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.regularize_objects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regularize_objects</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">orthogonality_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">rectangularity_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.regularize_objects" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Regularize objects to enforce right angles and rectangular shapes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>gdf</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with objects</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in square units to keep an object</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle_threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum deviation from 90 degrees to consider an angle as orthogonal (degrees)</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orthogonality_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentage of angles that must be orthogonal for an object to be regularized</p>
              </div>
            </td>
            <td>
                  <code>0.3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rectangularity_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area ratio to Object's oriented bounding box for rectangular simplification</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with regularized objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">regularize_objects</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
    <span class="n">min_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">orthogonality_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="n">rectangularity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regularize objects to enforce right angles and rectangular shapes.</span>

<span class="sd">    Args:</span>
<span class="sd">        gdf: GeoDataFrame with objects</span>
<span class="sd">        min_area: Minimum area in square units to keep an object</span>
<span class="sd">        angle_threshold: Maximum deviation from 90 degrees to consider an angle as orthogonal (degrees)</span>
<span class="sd">        orthogonality_threshold: Percentage of angles that must be orthogonal for an object to be regularized</span>
<span class="sd">        rectangularity_threshold: Minimum area ratio to Object&#39;s oriented bounding box for rectangular simplification</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with regularized objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">translate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiPolygon</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">box</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_angle</span><span class="p">(</span>
        <span class="n">p1</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">p2</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">p3</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate angle between three points in degrees (0-180)&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>

        <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">b</span>

        <span class="n">cosine_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bc</span><span class="p">))</span>
        <span class="c1"># Handle numerical errors that could push cosine outside [-1, 1]</span>
        <span class="n">cosine_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cosine_angle</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosine_angle</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">angle</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_orthogonal</span><span class="p">(</span><span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">angle_threshold</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if angle is close to 90 degrees&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_dominant_direction</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the dominant direction of a polygon using PCA&quot;&quot;&quot;</span>
        <span class="c1"># Extract coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># Mean center the coordinates</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">centered_coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">mean</span>

        <span class="c1"># Calculate covariance matrix and its eigenvalues/eigenvectors</span>
        <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">centered_coords</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>

        <span class="c1"># Get the index of the largest eigenvalue</span>
        <span class="n">largest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>

        <span class="c1"># Get the corresponding eigenvector (principal axis)</span>
        <span class="n">principal_axis</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">largest_idx</span><span class="p">]</span>

        <span class="c1"># Calculate the angle in degrees</span>
        <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">principal_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">principal_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>

        <span class="c1"># Normalize to range 0-180</span>
        <span class="k">if</span> <span class="n">angle_deg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle_deg</span> <span class="o">+=</span> <span class="mi">180</span>

        <span class="k">return</span> <span class="n">angle_deg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_oriented_envelope</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">angle_deg</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Polygon</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an oriented minimum area rectangle for the polygon&quot;&quot;&quot;</span>
        <span class="c1"># Create a rotated rectangle using OpenCV method (more robust than Shapely methods)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">)</span>  <span class="c1"># Skip the last point (same as first)</span>

        <span class="c1"># Use OpenCV&#39;s minAreaRect</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">box_points</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

        <span class="c1"># Convert to shapely polygon</span>
        <span class="n">oriented_box</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">box_points</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oriented_box</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_rectangularity</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">oriented_box</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the rectangularity (area ratio to its oriented bounding box)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">oriented_box</span><span class="o">.</span><span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">oriented_box</span><span class="o">.</span><span class="n">area</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_orthogonality</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check what percentage of angles in the polygon are orthogonal&quot;&quot;&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Triangle or point</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Remove last point (same as first)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">orthogonal_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_angles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_angles</span><span class="p">):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">total_angles</span><span class="p">]</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">total_angles</span><span class="p">]</span>

            <span class="n">angle</span> <span class="o">=</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_orthogonal</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
                <span class="n">orthogonal_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">orthogonal_count</span> <span class="o">/</span> <span class="n">total_angles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simplify_to_rectangle</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Polygon</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplify a polygon to a rectangle using its oriented bounding box&quot;&quot;&quot;</span>
        <span class="c1"># Get dominant direction</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">calculate_dominant_direction</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="c1"># Create oriented envelope</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">create_oriented_envelope</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rect</span>

    <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Objects to regularize&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regularizing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Angle threshold: </span><span class="si">{</span><span class="n">angle_threshold</span><span class="si">}</span><span class="s2">° from 90°&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min orthogonality: </span><span class="si">{</span><span class="n">orthogonality_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of angles&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;- Min rectangularity: </span><span class="si">{</span><span class="n">rectangularity_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of bounding box area&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create a copy to avoid modifying the original</span>
    <span class="n">result_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Track statistics</span>
    <span class="n">total_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
    <span class="n">regularized_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rectangularized_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Process each Object</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)):</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>

        <span class="c1"># Skip invalid or empty geometries</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Handle MultiPolygons by processing the largest part</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">):</span>
            <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">areas</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">areas</span><span class="p">)]</span>

        <span class="c1"># Filter out tiny Objects</span>
        <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Check orthogonality</span>
        <span class="n">orthogonality</span> <span class="o">=</span> <span class="n">check_orthogonality</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>

        <span class="c1"># Create oriented envelope</span>
        <span class="n">oriented_box</span> <span class="o">=</span> <span class="n">create_oriented_envelope</span><span class="p">(</span>
            <span class="n">geom</span><span class="p">,</span> <span class="n">calculate_dominant_direction</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check rectangularity</span>
        <span class="n">rectangularity</span> <span class="o">=</span> <span class="n">get_rectangularity</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">oriented_box</span><span class="p">)</span>

        <span class="c1"># Decide how to regularize</span>
        <span class="k">if</span> <span class="n">rectangularity</span> <span class="o">&gt;=</span> <span class="n">rectangularity_threshold</span><span class="p">:</span>
            <span class="c1"># Object is already quite rectangular, simplify to a rectangle</span>
            <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oriented_box</span>
            <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;regularized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rectangle&quot;</span>
            <span class="n">rectangularized_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">orthogonality</span> <span class="o">&gt;=</span> <span class="n">orthogonality_threshold</span><span class="p">:</span>
            <span class="c1"># Object has many orthogonal angles but isn&#39;t rectangular</span>
            <span class="c1"># Could implement more sophisticated regularization here</span>
            <span class="c1"># For now, we&#39;ll still use the oriented rectangle</span>
            <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oriented_box</span>
            <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;regularized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;orthogonal&quot;</span>
            <span class="n">regularized_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Object doesn&#39;t have clear orthogonal structure</span>
            <span class="c1"># Keep original but flag as unmodified</span>
            <span class="n">result_gdf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;regularized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span>

    <span class="c1"># Report statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regularization completed:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total objects: </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;- Rectangular objects: </span><span class="si">{</span><span class="n">rectangularized_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">rectangularized_count</span><span class="o">/</span><span class="n">total_objects</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;- Other regularized objects: </span><span class="si">{</span><span class="n">regularized_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">regularized_count</span><span class="o">/</span><span class="n">total_objects</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;- Unmodified objects: </span><span class="si">{</span><span class="n">total_objects</span><span class="o">-</span><span class="n">rectangularized_count</span><span class="o">-</span><span class="n">regularized_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">total_objects</span><span class="o">-</span><span class="n">rectangularized_count</span><span class="o">-</span><span class="n">regularized_count</span><span class="p">)</span><span class="o">/</span><span class="n">total_objects</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result_gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.save_masks_as_geotiff" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_masks_as_geotiff</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.save_masks_as_geotiff" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a raster file to extract object masks and save as GeoTIFF.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output GeoTIFF file (optional, default: input_masks.tif)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for processing</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print detailed processing information</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters:
confidence_threshold: Minimum confidence score to keep a detection (0.0-1.0)
chip_size: Size of image chips for processing (height, width)
mask_threshold: Threshold for mask binarization (0.0-1.0)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved GeoTIFF file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_masks_as_geotiff</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a raster file to extract object masks and save as GeoTIFF.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to input raster file</span>
<span class="sd">        output_path: Path to output GeoTIFF file (optional, default: input_masks.tif)</span>
<span class="sd">        batch_size: Batch size for processing</span>
<span class="sd">        verbose: Whether to print detailed processing information</span>
<span class="sd">        **kwargs: Additional parameters:</span>
<span class="sd">            confidence_threshold: Minimum confidence score to keep a detection (0.0-1.0)</span>
<span class="sd">            chip_size: Size of image chips for processing (height, width)</span>
<span class="sd">            mask_threshold: Threshold for mask binarization (0.0-1.0)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the saved GeoTIFF file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get parameters from kwargs or use instance defaults</span>
    <span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>
    <span class="p">)</span>
    <span class="n">chip_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chip_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_size</span><span class="p">)</span>
    <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">)</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>

    <span class="c1"># Set default output path if not provided</span>
    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_masks.tif&quot;</span>

    <span class="c1"># Print parameters being used</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing masks with parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Confidence threshold: </span><span class="si">{</span><span class="n">confidence_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Chip size: </span><span class="si">{</span><span class="n">chip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create dataset</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
        <span class="n">raster_path</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
        <span class="n">chip_size</span><span class="o">=</span><span class="n">chip_size</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Store a flag to avoid repetitive messages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">raster_stats</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">raster_stats</span>
    <span class="n">seen_warnings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;resize&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Dictionary to track resize warnings by shape</span>
    <span class="p">}</span>

    <span class="c1"># Open original raster to get metadata</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Create output binary mask raster with same dimensions as input</span>
        <span class="n">output_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">output_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Single band for object mask</span>
            <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span>
            <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create output mask raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">output_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="c1"># Initialize mask with zeros</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Custom collate function to handle Shapely objects</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">custom_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Custom collate function for DataLoader&quot;&quot;&quot;</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span>
                            <span class="c1"># Don&#39;t collate shapely objects, keep as list</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># For tensors and other collatable types</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                <span class="c1"># Fall back to list for non-collatable types</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Default collate for non-dict types</span>
                    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="c1"># Create dataloader</span>
            <span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">collate_fn</span><span class="o">=</span><span class="n">custom_collate</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Process batches</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing raster with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
                <span class="c1"># Move images to device</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>  <span class="c1"># (i, j) coordinates in pixels</span>

                <span class="c1"># Run inference</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

                <span class="c1"># Process predictions</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
                    <span class="n">masks</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                    <span class="c1"># Skip if no predictions</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Filter by confidence threshold</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">confidence_threshold</span>
                    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

                    <span class="c1"># Skip if no valid predictions</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get window coordinates</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">coord_item</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coord_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected coords type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get window size</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">window_item</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">window_item</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                            <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">window_item</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Unexpected window_size format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">window_item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                        <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unexpected window_size type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;window_size&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Combine all masks for this window</span>
                    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
                        <span class="c1"># Get the binary mask</span>
                        <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mask_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                        <span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

                        <span class="c1"># Handle size mismatch - resize binary_mask if needed</span>
                        <span class="n">mask_h</span><span class="p">,</span> <span class="n">mask_w</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">if</span> <span class="n">mask_h</span> <span class="o">!=</span> <span class="n">window_height</span> <span class="ow">or</span> <span class="n">mask_w</span> <span class="o">!=</span> <span class="n">window_width</span><span class="p">:</span>
                            <span class="n">resize_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">mask_h</span><span class="p">,</span><span class="w"> </span><span class="n">mask_w</span><span class="p">)</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="p">(</span><span class="n">window_height</span><span class="p">,</span><span class="w"> </span><span class="n">window_width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="k">if</span> <span class="n">resize_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_warnings</span><span class="p">[</span><span class="s2">&quot;resize&quot;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Resizing mask from </span><span class="si">{</span><span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="p">(</span><span class="n">window_height</span><span class="p">,</span><span class="w"> </span><span class="n">window_width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_warnings</span><span class="p">[</span>
                                        <span class="s2">&quot;resize&quot;</span>
                                    <span class="p">]:</span>  <span class="c1"># If this is the first resize warning</span>
                                        <span class="nb">print</span><span class="p">(</span>
                                            <span class="sa">f</span><span class="s2">&quot;Resizing masks at image edges (set verbose=True for details)&quot;</span>
                                        <span class="p">)</span>
                                <span class="n">seen_warnings</span><span class="p">[</span><span class="s2">&quot;resize&quot;</span><span class="p">][</span><span class="n">resize_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="c1"># Crop or pad the binary mask to match window size</span>
                            <span class="n">resized_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                            <span class="p">)</span>
                            <span class="n">copy_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mask_h</span><span class="p">,</span> <span class="n">window_height</span><span class="p">)</span>
                            <span class="n">copy_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mask_w</span><span class="p">,</span> <span class="n">window_width</span><span class="p">)</span>
                            <span class="n">resized_mask</span><span class="p">[:</span><span class="n">copy_h</span><span class="p">,</span> <span class="p">:</span><span class="n">copy_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_mask</span><span class="p">[</span>
                                <span class="p">:</span><span class="n">copy_h</span><span class="p">,</span> <span class="p">:</span><span class="n">copy_w</span>
                            <span class="p">]</span>
                            <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">resized_mask</span>

                        <span class="c1"># Update combined mask (taking maximum where masks overlap)</span>
                        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="n">binary_mask</span><span class="p">)</span>

                    <span class="c1"># Write combined mask to output array</span>
                    <span class="c1"># Handle edge cases where window might be smaller than chip size</span>
                    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">combined_mask</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">valid_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>
                    <span class="n">valid_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">valid_h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                            <span class="n">mask_array</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">valid_h</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">valid_w</span><span class="p">],</span>
                            <span class="n">combined_mask</span><span class="p">[:</span><span class="n">valid_h</span><span class="p">,</span> <span class="p">:</span><span class="n">valid_w</span><span class="p">],</span>
                        <span class="p">)</span>

            <span class="c1"># Write the final mask to the output file</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object masks saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.vectorize_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vectorize_masks</span><span class="p">(</span><span class="n">masks_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_object_area</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_object_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.ObjectDetector.vectorize_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert masks with confidence to vector polygons.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>masks_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to masks GeoTIFF with confidence band.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path for output GeoJSON.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence score (0.0-1.0). Default: 0.5</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_object_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in pixels to keep an object. Default: 100</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_object_area</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum area in pixels to keep an object. Default: None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_workers</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int, default=None
The number of worker threads to use.
"None" means single-threaded processing.
"-1"   means using all available CPU processors.
Positive integer means using that specific number of threads.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with car detections and confidence values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">vectorize_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">masks_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">confidence_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert masks with confidence to vector polygons.</span>

<span class="sd">    Args:</span>
<span class="sd">        masks_path: Path to masks GeoTIFF with confidence band.</span>
<span class="sd">        output_path: Path for output GeoJSON.</span>
<span class="sd">        confidence_threshold: Minimum confidence score (0.0-1.0). Default: 0.5</span>
<span class="sd">        min_object_area: Minimum area in pixels to keep an object. Default: 100</span>
<span class="sd">        max_object_area: Maximum area in pixels to keep an object. Default: None</span>
<span class="sd">        n_workers: int, default=None</span>
<span class="sd">            The number of worker threads to use.</span>
<span class="sd">            &quot;None&quot; means single-threaded processing.</span>
<span class="sd">            &quot;-1&quot;   means using all available CPU processors.</span>
<span class="sd">            Positive integer means using that specific number of threads.</span>
<span class="sd">        **kwargs: Additional parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame with car detections and confidence values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_component</span><span class="p">(</span>
        <span class="n">component_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">conf_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">confidence_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># Get confidence value</span>
        <span class="n">conf_region</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="n">component_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf_region</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">conf_region</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Skip if confidence is below threshold</span>
        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">confidence_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Find contours</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
            <span class="n">component_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
        <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
            <span class="c1"># Filter by size</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get minimum area rectangle</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            <span class="n">box_points</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

            <span class="c1"># Convert to geographic coordinates</span>
            <span class="n">geo_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">box_points</span><span class="p">:</span>
                <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">geo_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

            <span class="c1"># Create polygon</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">poly</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">area</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_component</span><span class="p">(</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to process a single component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span>
            <span class="n">label</span><span class="p">,</span>
            <span class="n">labeled_mask</span><span class="p">,</span>
            <span class="n">conf_data</span><span class="p">,</span>
            <span class="n">transform</span><span class="p">,</span>
            <span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">min_object_area</span><span class="p">,</span>
            <span class="n">max_object_area</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

        <span class="c1"># Create mask for this component</span>
        <span class="n">component_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_mask</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_process_single_component</span><span class="p">(</span>
            <span class="n">component_mask</span><span class="p">,</span>
            <span class="n">conf_data</span><span class="p">,</span>
            <span class="n">transform</span><span class="p">,</span>
            <span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">min_object_area</span><span class="p">,</span>
            <span class="n">max_object_area</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing masks from: </span><span class="si">{</span><span class="n">masks_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_workers</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">masks_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read mask and confidence bands</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">conf_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Convert to binary mask</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">mask_data</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Find connected components</span>
        <span class="n">labeled_mask</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_features</span><span class="si">}</span><span class="s2"> connected components&quot;</span><span class="p">)</span>

        <span class="c1"># Process each component</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">n_workers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_workers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Using single-threaded processing, you can speed up processing by setting n_workers &gt; 1&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Add progress bar</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing components&quot;</span>
            <span class="p">):</span>
                <span class="c1"># Create mask for this component</span>
                <span class="n">component_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_mask</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">_process_single_component</span><span class="p">(</span>
                    <span class="n">component_mask</span><span class="p">,</span>
                    <span class="n">conf_data</span><span class="p">,</span>
                    <span class="n">transform</span><span class="p">,</span>
                    <span class="n">confidence_threshold</span><span class="p">,</span>
                    <span class="n">min_object_area</span><span class="p">,</span>
                    <span class="n">max_object_area</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">poly</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="c1"># Add to lists</span>
                        <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
                        <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>
                        <span class="n">pixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Process components in parallel</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">n_workers</span><span class="si">}</span><span class="s2"> workers for parallel processing&quot;</span><span class="p">)</span>

            <span class="n">process_args</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span>
                    <span class="n">labeled_mask</span><span class="p">,</span>
                    <span class="n">conf_data</span><span class="p">,</span>
                    <span class="n">transform</span><span class="p">,</span>
                    <span class="n">confidence_threshold</span><span class="p">,</span>
                    <span class="n">min_object_area</span><span class="p">,</span>
                    <span class="n">max_object_area</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
                <span class="n">max_workers</span><span class="o">=</span><span class="n">n_workers</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">tqdm</span><span class="p">(</span>
                        <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_component</span><span class="p">,</span> <span class="n">process_args</span><span class="p">),</span>
                        <span class="n">total</span><span class="o">=</span><span class="n">num_features</span><span class="p">,</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing components&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">poly</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="c1"># Add to lists</span>
                            <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
                            <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>
                            <span class="n">pixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="n">polygons</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">polygons</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidences</span><span class="p">,</span>
                    <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">),</span>
                    <span class="s2">&quot;pixels&quot;</span><span class="p">:</span> <span class="n">pixels</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Save to file if requested</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects with confidence to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total processing time: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gdf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total processing time: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ObjectDetector.visualize_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visualize_results</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">gdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span></code>

<a href="#geoai.geoai.ObjectDetector.visualize_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Visualize object detection results with proper coordinate transformation.</p>
<p>This function displays objects on top of the raster image,
ensuring proper alignment between the GeoDataFrame polygons and the image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gdf</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with object polygons (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save visualization (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size (width, height) in inches</p>
              </div>
            </td>
            <td>
                  <code>(12, 12)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if visualization was successful</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">gdf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize object detection results with proper coordinate transformation.</span>

<span class="sd">    This function displays objects on top of the raster image,</span>
<span class="sd">    ensuring proper alignment between the GeoDataFrame polygons and the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path: Path to input raster</span>
<span class="sd">        gdf: GeoDataFrame with object polygons (optional)</span>
<span class="sd">        output_path: Path to save visualization (optional)</span>
<span class="sd">        figsize: Figure size (width, height) in inches</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if visualization was successful</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if raster file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raster_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Raster file &#39;</span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Process raster if GeoDataFrame not provided</span>
    <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_raster</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects to visualize&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check if confidence column exists in the GeoDataFrame</span>
    <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Try to access a confidence value to confirm it works</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Try getitem access</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using confidence values (range: </span><span class="si">{</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence column exists but couldn&#39;t access values: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No confidence column found in GeoDataFrame&quot;</span><span class="p">)</span>
        <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Read raster for visualization</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the entire image or a subset if it&#39;s very large</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">2000</span> <span class="ow">or</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="c1"># Calculate scale factor to reduce size</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2000</span> <span class="o">/</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">2000</span> <span class="o">/</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">out_shape</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Read and resample</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="n">out_shape</span><span class="o">=</span><span class="n">out_shape</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">bilinear</span>
            <span class="p">)</span>

            <span class="c1"># Create a scaled transform for the resampled image</span>
            <span class="c1"># Calculate scaling factors</span>
            <span class="n">x_scale</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">y_scale</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Get the original transform</span>
            <span class="n">orig_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

            <span class="c1"># Create a scaled transform</span>
            <span class="n">scaled_transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Affine</span><span class="p">(</span>
                <span class="n">orig_transform</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">x_scale</span><span class="p">,</span>
                <span class="n">orig_transform</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="n">orig_transform</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
                <span class="n">orig_transform</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
                <span class="n">orig_transform</span><span class="o">.</span><span class="n">e</span> <span class="o">*</span> <span class="n">y_scale</span><span class="p">,</span>
                <span class="n">orig_transform</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">scaled_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

        <span class="c1"># Convert to RGB for display</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Normalize image for display</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># CHW to HWC</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Likely 0-255 range</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get image bounds</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Create figure with appropriate aspect ratio</span>
    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># width / height</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># Display image</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Make sure the GeoDataFrame has the same CRS as the raster</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">crs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting GeoDataFrame from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Set up colors for confidence visualization</span>
    <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>

            <span class="c1"># Get min/max confidence values</span>
            <span class="n">min_conf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">max_conf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># Set up normalization and colormap</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">min_conf</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_conf</span><span class="p">)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>

            <span class="c1"># Create scalar mappable for colorbar</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

            <span class="c1"># Add colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span>
            <span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Confidence Score&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up confidence visualization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">has_confidence</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Function to convert coordinates</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">geo_to_pixel</span><span class="p">(</span>
        <span class="n">geometry</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert geometry to pixel coordinates using the provided transform.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">:</span>
            <span class="c1"># Get exterior coordinates</span>
            <span class="n">exterior_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

            <span class="c1"># Convert to pixel coordinates</span>
            <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[</span><span class="o">~</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">exterior_coords</span><span class="p">]</span>

            <span class="c1"># Split into x and y lists</span>
            <span class="n">pixel_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>
            <span class="n">pixel_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported geometry type: </span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">geom_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Plot each object</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert polygon to pixel coordinates</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">geo_to_pixel</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">scaled_transform</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
                <span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span> <span class="o">=</span> <span class="n">coords</span>

                <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Get confidence value using different methods</span>
                        <span class="c1"># Method 1: Try direct attribute access</span>
                        <span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">confidence</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="c1"># Method 2: Try dictionary-style access</span>
                        <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                        <span class="c1"># Method 3: Try accessing by index from the GeoDataFrame</span>
                        <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">confidence</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                        <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">confidence</span><span class="p">))</span>
                            <span class="c1"># Fill polygon with semi-transparent color</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="c1"># Draw border</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">pixel_x</span><span class="p">,</span>
                                <span class="n">pixel_y</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Fall back to red if confidence value couldn&#39;t be accessed</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error using confidence value for polygon </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No confidence data, just plot outlines in red</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error plotting polygon </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Remove axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;objects (Found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Save if requested</span>
    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Visualization saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Create a simpler visualization focused just on a subset of objects</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># Choose a subset of the image to show</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Get centroid of first object</span>
            <span class="n">sample_geom</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="n">sample_geom</span><span class="o">.</span><span class="n">centroid</span>

            <span class="c1"># Convert to pixel coordinates</span>
            <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="o">~</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="c1"># Define a window around this object</span>
            <span class="n">window_size</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># pixels</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="c1"># Read this window</span>
            <span class="n">sample_image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

            <span class="c1"># Convert to RGB for display</span>
            <span class="k">if</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Normalize image for display</span>
            <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># CHW to HWC</span>
            <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sample_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Likely 0-255 range</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">sample_image</span> <span class="o">/</span> <span class="mf">255.0</span>

            <span class="n">sample_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Display sample image</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Get the correct transform for this window</span>
            <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

            <span class="c1"># Calculate bounds of the window</span>
            <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
            <span class="n">window_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">window_bounds</span><span class="p">)</span>

            <span class="c1"># Filter objects that intersect with this window</span>
            <span class="n">visible_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_box</span><span class="p">)]</span>

            <span class="c1"># Set up colors for sample view if confidence data exists</span>
            <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Reuse the same normalization and colormap from main view</span>
                    <span class="n">sample_sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                    <span class="n">sample_sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

                    <span class="c1"># Add colorbar to sample view</span>
                    <span class="n">sample_cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                        <span class="n">sample_sm</span><span class="p">,</span>
                        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                        <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
                        <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">sample_cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Confidence Score&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up sample confidence visualization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Plot objects in sample view</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">visible_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Get window-relative pixel coordinates</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>

                    <span class="c1"># Skip empty geometries</span>
                    <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get exterior coordinates</span>
                    <span class="n">exterior_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

                    <span class="c1"># Convert to pixel coordinates relative to window origin</span>
                    <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">exterior_coords</span><span class="p">:</span>
                        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="o">~</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Convert to image pixels</span>
                        <span class="c1"># Make coordinates relative to window</span>
                        <span class="n">px</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="n">window</span><span class="o">.</span><span class="n">col_off</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="n">py</span> <span class="o">-</span> <span class="n">window</span><span class="o">.</span><span class="n">row_off</span>
                        <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>

                    <span class="c1"># Extract x and y coordinates</span>
                    <span class="n">pixel_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>
                    <span class="n">pixel_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pixel_coords</span><span class="p">]</span>

                    <span class="c1"># Use confidence colors if available</span>
                    <span class="k">if</span> <span class="n">has_confidence</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Try different methods to access confidence</span>
                            <span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">confidence</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">visible_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">confidence</span><span class="p">))</span>
                                <span class="c1"># Fill polygon with semi-transparent color</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                                <span class="c1"># Draw border</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                    <span class="n">pixel_x</span><span class="p">,</span>
                                    <span class="n">pixel_y</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                    <span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span>
                                <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Error using confidence in sample view for polygon </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error plotting polygon in sample view: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Set title</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample Area - objects (Showing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">visible_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Remove axes</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

            <span class="c1"># Save if requested</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                <span class="n">sample_output</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;_sample&quot;</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">sample_output</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample visualization saved to </span><span class="si">{</span><span class="n">sample_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.ParkingSplotDetector" class="doc doc-heading">
            <code>ParkingSplotDetector</code>


<a href="#geoai.geoai.ParkingSplotDetector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ObjectDetector (geoai.extract.ObjectDetector)" href="../extract/#geoai.extract.ObjectDetector">ObjectDetector</a></code></p>


        <p>Car detection using a pre-trained Mask R-CNN model.</p>
<p>This class extends the <code>ObjectDetector</code> class with additional methods for car detection.</p>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParkingSplotDetector</span><span class="p">(</span><span class="n">ObjectDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Car detection using a pre-trained Mask R-CNN model.</span>

<span class="sd">    This class extends the `ObjectDetector` class with additional methods for car detection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;parking_spot_detection.pth&quot;</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object extractor.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">            model: Custom model to use for inference.</span>
<span class="sd">            num_classes: Number of classes for the model. Default: 3</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
            <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ParkingSplotDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;parking_spot_detection.pth&#39;</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.ParkingSplotDetector.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the object extractor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>&#39;parking_spot_detection.pth&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repo ID for loading models from the Hub.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom model to use for inference.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_classes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for the model. Default: 3</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;parking_spot_detection.pth&quot;</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the object extractor.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">        model: Custom model to use for inference.</span>
<span class="sd">        num_classes: Number of classes for the model. Default: 3</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.ShipDetector" class="doc doc-heading">
            <code>ShipDetector</code>


<a href="#geoai.geoai.ShipDetector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ObjectDetector (geoai.extract.ObjectDetector)" href="../extract/#geoai.extract.ObjectDetector">ObjectDetector</a></code></p>


        <p>Ship detection using a pre-trained Mask R-CNN model.</p>
<p>This class extends the
<code>ObjectDetector</code> class with additional methods for ship detection."</p>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ShipDetector</span><span class="p">(</span><span class="n">ObjectDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ship detection using a pre-trained Mask R-CNN model.</span>

<span class="sd">    This class extends the</span>
<span class="sd">    `ObjectDetector` class with additional methods for ship detection.&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ship_detection.pth&quot;</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object extractor.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">            model: Custom model to use for inference.</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.ShipDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;ship_detection.pth&#39;</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.ShipDetector.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the object extractor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>&#39;ship_detection.pth&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repo ID for loading models from the Hub.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom model to use for inference.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ship_detection.pth&quot;</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the object extractor.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">        model: Custom model to use for inference.</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="geoai.geoai.SolarPanelDetector" class="doc doc-heading">
            <code>SolarPanelDetector</code>


<a href="#geoai.geoai.SolarPanelDetector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ObjectDetector (geoai.extract.ObjectDetector)" href="../extract/#geoai.extract.ObjectDetector">ObjectDetector</a></code></p>


        <p>Solar panel detection using a pre-trained Mask R-CNN model.</p>
<p>This class extends the
<code>ObjectDetector</code> class with additional methods for solar panel detection."</p>








              <details class="quote">
                <summary>Source code in <code>geoai/extract.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SolarPanelDetector</span><span class="p">(</span><span class="n">ObjectDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solar panel detection using a pre-trained Mask R-CNN model.</span>

<span class="sd">    This class extends the</span>
<span class="sd">    `ObjectDetector` class with additional methods for solar panel detection.&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;solar_panel_detection.pth&quot;</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object extractor.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: Path to the .pth model file.</span>
<span class="sd">            repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">            model: Custom model to use for inference.</span>
<span class="sd">            device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="geoai.geoai.SolarPanelDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;solar_panel_detection.pth&#39;</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.SolarPanelDetector.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the object extractor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth model file.</p>
              </div>
            </td>
            <td>
                  <code>&#39;solar_panel_detection.pth&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repo ID for loading models from the Hub.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom model to use for inference.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to use for inference ('cuda:0', 'cpu', etc.).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/extract.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;solar_panel_detection.pth&quot;</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the object extractor.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the .pth model file.</span>
<span class="sd">        repo_id: Repo ID for loading models from the Hub.</span>
<span class="sd">        model: Custom model to use for inference.</span>
<span class="sd">        device: Device to use for inference (&#39;cuda:0&#39;, &#39;cpu&#39;, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.adaptive_regularization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">adaptive_regularization</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">area_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">preserve_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.geoai.adaptive_regularization" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Adaptively regularizes building footprints based on their characteristics.</p>
<p>This approach determines the best regularization method for each building.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>building_polygons</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distance tolerance for simplification</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum acceptable area ratio</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_shape</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to preserve overall shape for complex buildings</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">adaptive_regularization</span><span class="p">(</span>
    <span class="n">building_polygons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">area_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">preserve_shape</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptively regularizes building footprints based on their characteristics.</span>

<span class="sd">    This approach determines the best regularization method for each building.</span>

<span class="sd">    Args:</span>
<span class="sd">        building_polygons: GeoDataFrame or list of shapely Polygons</span>
<span class="sd">        simplify_tolerance: Distance tolerance for simplification</span>
<span class="sd">        area_threshold: Minimum acceptable area ratio</span>
<span class="sd">        preserve_shape: Whether to preserve overall shape for complex buildings</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame or list of shapely Polygons with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Analyze the overall dataset to set appropriate parameters</span>
    <span class="k">if</span> <span class="n">is_gdf</span> <span class="o">:=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">geom_objects</span><span class="p">:</span>
        <span class="c1"># Skip invalid geometries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">building</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Measure building complexity</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>

        <span class="c1"># Determine if the building has a clear principal direction</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">segment_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># Normalize angles to 0-180 range and get histogram</span>
        <span class="n">norm_angles</span> <span class="o">=</span> <span class="n">angles</span> <span class="o">%</span> <span class="mi">180</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">norm_angles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">segment_lengths</span>
        <span class="p">)</span>

        <span class="c1"># Calculate direction clarity (ratio of longest direction to total)</span>
        <span class="n">direction_clarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Choose regularization method based on building characteristics</span>
        <span class="k">if</span> <span class="n">complexity</span> <span class="o">&lt;</span> <span class="mf">1.2</span> <span class="ow">and</span> <span class="n">direction_clarity</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># Simple building with clear direction: use rotated rectangle</span>
            <span class="n">bin_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
            <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">dominant_angle</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">bin_max</span><span class="p">]</span>

            <span class="c1"># Rotate to align with coordinate system</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Create bounding box in rotated space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Rotate back</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Quality check</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">building</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">area_threshold</span>
                <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">building</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">area_threshold</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># Too much area change, use simplified original</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tolerance</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Complex building or no clear direction: preserve shape</span>
            <span class="k">if</span> <span class="n">preserve_shape</span><span class="p">:</span>
                <span class="c1"># Simplify with topology preservation</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tolerance</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fall back to convex hull for very complex shapes</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">convex_hull</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Return in same format as input</span>
    <span class="k">if</span> <span class="n">is_gdf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">building_polygons</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.add_geometric_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_geometric_properties</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">area_unit</span><span class="o">=</span><span class="s1">&#39;m2&#39;</span><span class="p">,</span> <span class="n">length_unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.add_geometric_properties" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculates geometric properties and adds them to the GeoDataFrame.</p>
<p>This function calculates various geometric properties of features in a
GeoDataFrame and adds them as new columns without modifying existing attributes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame containing vector features.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>properties</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of geometric properties to calculate. Options include:
'area', 'length', 'perimeter', 'centroid_x', 'centroid_y', 'bounds',
'convex_hull_area', 'orientation', 'complexity', 'area_bbox',
'area_convex', 'area_filled', 'major_length', 'minor_length',
'eccentricity', 'diameter_areagth', 'extent', 'solidity',
'elongation'.
Defaults to ['area', 'length'] if None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String specifying the unit for area calculation ('m2', 'km2',
'ha'). Defaults to 'm2'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;m2&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>length_unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String specifying the unit for length calculation ('m', 'km').
Defaults to 'm'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;m&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame: A copy of the input GeoDataFrame with added</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geometric property columns.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6483</span>
<span class="normal">6484</span>
<span class="normal">6485</span>
<span class="normal">6486</span>
<span class="normal">6487</span>
<span class="normal">6488</span>
<span class="normal">6489</span>
<span class="normal">6490</span>
<span class="normal">6491</span>
<span class="normal">6492</span>
<span class="normal">6493</span>
<span class="normal">6494</span>
<span class="normal">6495</span>
<span class="normal">6496</span>
<span class="normal">6497</span>
<span class="normal">6498</span>
<span class="normal">6499</span>
<span class="normal">6500</span>
<span class="normal">6501</span>
<span class="normal">6502</span>
<span class="normal">6503</span>
<span class="normal">6504</span>
<span class="normal">6505</span>
<span class="normal">6506</span>
<span class="normal">6507</span>
<span class="normal">6508</span>
<span class="normal">6509</span>
<span class="normal">6510</span>
<span class="normal">6511</span>
<span class="normal">6512</span>
<span class="normal">6513</span>
<span class="normal">6514</span>
<span class="normal">6515</span>
<span class="normal">6516</span>
<span class="normal">6517</span>
<span class="normal">6518</span>
<span class="normal">6519</span>
<span class="normal">6520</span>
<span class="normal">6521</span>
<span class="normal">6522</span>
<span class="normal">6523</span>
<span class="normal">6524</span>
<span class="normal">6525</span>
<span class="normal">6526</span>
<span class="normal">6527</span>
<span class="normal">6528</span>
<span class="normal">6529</span>
<span class="normal">6530</span>
<span class="normal">6531</span>
<span class="normal">6532</span>
<span class="normal">6533</span>
<span class="normal">6534</span>
<span class="normal">6535</span>
<span class="normal">6536</span>
<span class="normal">6537</span>
<span class="normal">6538</span>
<span class="normal">6539</span>
<span class="normal">6540</span>
<span class="normal">6541</span>
<span class="normal">6542</span>
<span class="normal">6543</span>
<span class="normal">6544</span>
<span class="normal">6545</span>
<span class="normal">6546</span>
<span class="normal">6547</span>
<span class="normal">6548</span>
<span class="normal">6549</span>
<span class="normal">6550</span>
<span class="normal">6551</span>
<span class="normal">6552</span>
<span class="normal">6553</span>
<span class="normal">6554</span>
<span class="normal">6555</span>
<span class="normal">6556</span>
<span class="normal">6557</span>
<span class="normal">6558</span>
<span class="normal">6559</span>
<span class="normal">6560</span>
<span class="normal">6561</span>
<span class="normal">6562</span>
<span class="normal">6563</span>
<span class="normal">6564</span>
<span class="normal">6565</span>
<span class="normal">6566</span>
<span class="normal">6567</span>
<span class="normal">6568</span>
<span class="normal">6569</span>
<span class="normal">6570</span>
<span class="normal">6571</span>
<span class="normal">6572</span>
<span class="normal">6573</span>
<span class="normal">6574</span>
<span class="normal">6575</span>
<span class="normal">6576</span>
<span class="normal">6577</span>
<span class="normal">6578</span>
<span class="normal">6579</span>
<span class="normal">6580</span>
<span class="normal">6581</span>
<span class="normal">6582</span>
<span class="normal">6583</span>
<span class="normal">6584</span>
<span class="normal">6585</span>
<span class="normal">6586</span>
<span class="normal">6587</span>
<span class="normal">6588</span>
<span class="normal">6589</span>
<span class="normal">6590</span>
<span class="normal">6591</span>
<span class="normal">6592</span>
<span class="normal">6593</span>
<span class="normal">6594</span>
<span class="normal">6595</span>
<span class="normal">6596</span>
<span class="normal">6597</span>
<span class="normal">6598</span>
<span class="normal">6599</span>
<span class="normal">6600</span>
<span class="normal">6601</span>
<span class="normal">6602</span>
<span class="normal">6603</span>
<span class="normal">6604</span>
<span class="normal">6605</span>
<span class="normal">6606</span>
<span class="normal">6607</span>
<span class="normal">6608</span>
<span class="normal">6609</span>
<span class="normal">6610</span>
<span class="normal">6611</span>
<span class="normal">6612</span>
<span class="normal">6613</span>
<span class="normal">6614</span>
<span class="normal">6615</span>
<span class="normal">6616</span>
<span class="normal">6617</span>
<span class="normal">6618</span>
<span class="normal">6619</span>
<span class="normal">6620</span>
<span class="normal">6621</span>
<span class="normal">6622</span>
<span class="normal">6623</span>
<span class="normal">6624</span>
<span class="normal">6625</span>
<span class="normal">6626</span>
<span class="normal">6627</span>
<span class="normal">6628</span>
<span class="normal">6629</span>
<span class="normal">6630</span>
<span class="normal">6631</span>
<span class="normal">6632</span>
<span class="normal">6633</span>
<span class="normal">6634</span>
<span class="normal">6635</span>
<span class="normal">6636</span>
<span class="normal">6637</span>
<span class="normal">6638</span>
<span class="normal">6639</span>
<span class="normal">6640</span>
<span class="normal">6641</span>
<span class="normal">6642</span>
<span class="normal">6643</span>
<span class="normal">6644</span>
<span class="normal">6645</span>
<span class="normal">6646</span>
<span class="normal">6647</span>
<span class="normal">6648</span>
<span class="normal">6649</span>
<span class="normal">6650</span>
<span class="normal">6651</span>
<span class="normal">6652</span>
<span class="normal">6653</span>
<span class="normal">6654</span>
<span class="normal">6655</span>
<span class="normal">6656</span>
<span class="normal">6657</span>
<span class="normal">6658</span>
<span class="normal">6659</span>
<span class="normal">6660</span>
<span class="normal">6661</span>
<span class="normal">6662</span>
<span class="normal">6663</span>
<span class="normal">6664</span>
<span class="normal">6665</span>
<span class="normal">6666</span>
<span class="normal">6667</span>
<span class="normal">6668</span>
<span class="normal">6669</span>
<span class="normal">6670</span>
<span class="normal">6671</span>
<span class="normal">6672</span>
<span class="normal">6673</span>
<span class="normal">6674</span>
<span class="normal">6675</span>
<span class="normal">6676</span>
<span class="normal">6677</span>
<span class="normal">6678</span>
<span class="normal">6679</span>
<span class="normal">6680</span>
<span class="normal">6681</span>
<span class="normal">6682</span>
<span class="normal">6683</span>
<span class="normal">6684</span>
<span class="normal">6685</span>
<span class="normal">6686</span>
<span class="normal">6687</span>
<span class="normal">6688</span>
<span class="normal">6689</span>
<span class="normal">6690</span>
<span class="normal">6691</span>
<span class="normal">6692</span>
<span class="normal">6693</span>
<span class="normal">6694</span>
<span class="normal">6695</span>
<span class="normal">6696</span>
<span class="normal">6697</span>
<span class="normal">6698</span>
<span class="normal">6699</span>
<span class="normal">6700</span>
<span class="normal">6701</span>
<span class="normal">6702</span>
<span class="normal">6703</span>
<span class="normal">6704</span>
<span class="normal">6705</span>
<span class="normal">6706</span>
<span class="normal">6707</span>
<span class="normal">6708</span>
<span class="normal">6709</span>
<span class="normal">6710</span>
<span class="normal">6711</span>
<span class="normal">6712</span>
<span class="normal">6713</span>
<span class="normal">6714</span>
<span class="normal">6715</span>
<span class="normal">6716</span>
<span class="normal">6717</span>
<span class="normal">6718</span>
<span class="normal">6719</span>
<span class="normal">6720</span>
<span class="normal">6721</span>
<span class="normal">6722</span>
<span class="normal">6723</span>
<span class="normal">6724</span>
<span class="normal">6725</span>
<span class="normal">6726</span>
<span class="normal">6727</span>
<span class="normal">6728</span>
<span class="normal">6729</span>
<span class="normal">6730</span>
<span class="normal">6731</span>
<span class="normal">6732</span>
<span class="normal">6733</span>
<span class="normal">6734</span>
<span class="normal">6735</span>
<span class="normal">6736</span>
<span class="normal">6737</span>
<span class="normal">6738</span>
<span class="normal">6739</span>
<span class="normal">6740</span>
<span class="normal">6741</span>
<span class="normal">6742</span>
<span class="normal">6743</span>
<span class="normal">6744</span>
<span class="normal">6745</span>
<span class="normal">6746</span>
<span class="normal">6747</span>
<span class="normal">6748</span>
<span class="normal">6749</span>
<span class="normal">6750</span>
<span class="normal">6751</span>
<span class="normal">6752</span>
<span class="normal">6753</span>
<span class="normal">6754</span>
<span class="normal">6755</span>
<span class="normal">6756</span>
<span class="normal">6757</span>
<span class="normal">6758</span>
<span class="normal">6759</span>
<span class="normal">6760</span>
<span class="normal">6761</span>
<span class="normal">6762</span>
<span class="normal">6763</span>
<span class="normal">6764</span>
<span class="normal">6765</span>
<span class="normal">6766</span>
<span class="normal">6767</span>
<span class="normal">6768</span>
<span class="normal">6769</span>
<span class="normal">6770</span>
<span class="normal">6771</span>
<span class="normal">6772</span>
<span class="normal">6773</span>
<span class="normal">6774</span>
<span class="normal">6775</span>
<span class="normal">6776</span>
<span class="normal">6777</span>
<span class="normal">6778</span>
<span class="normal">6779</span>
<span class="normal">6780</span>
<span class="normal">6781</span>
<span class="normal">6782</span>
<span class="normal">6783</span>
<span class="normal">6784</span>
<span class="normal">6785</span>
<span class="normal">6786</span>
<span class="normal">6787</span>
<span class="normal">6788</span>
<span class="normal">6789</span>
<span class="normal">6790</span>
<span class="normal">6791</span>
<span class="normal">6792</span>
<span class="normal">6793</span>
<span class="normal">6794</span>
<span class="normal">6795</span>
<span class="normal">6796</span>
<span class="normal">6797</span>
<span class="normal">6798</span>
<span class="normal">6799</span>
<span class="normal">6800</span>
<span class="normal">6801</span>
<span class="normal">6802</span>
<span class="normal">6803</span>
<span class="normal">6804</span>
<span class="normal">6805</span>
<span class="normal">6806</span>
<span class="normal">6807</span>
<span class="normal">6808</span>
<span class="normal">6809</span>
<span class="normal">6810</span>
<span class="normal">6811</span>
<span class="normal">6812</span>
<span class="normal">6813</span>
<span class="normal">6814</span>
<span class="normal">6815</span>
<span class="normal">6816</span>
<span class="normal">6817</span>
<span class="normal">6818</span>
<span class="normal">6819</span>
<span class="normal">6820</span>
<span class="normal">6821</span>
<span class="normal">6822</span>
<span class="normal">6823</span>
<span class="normal">6824</span>
<span class="normal">6825</span>
<span class="normal">6826</span>
<span class="normal">6827</span>
<span class="normal">6828</span>
<span class="normal">6829</span>
<span class="normal">6830</span>
<span class="normal">6831</span>
<span class="normal">6832</span>
<span class="normal">6833</span>
<span class="normal">6834</span>
<span class="normal">6835</span>
<span class="normal">6836</span>
<span class="normal">6837</span>
<span class="normal">6838</span>
<span class="normal">6839</span>
<span class="normal">6840</span>
<span class="normal">6841</span>
<span class="normal">6842</span>
<span class="normal">6843</span>
<span class="normal">6844</span>
<span class="normal">6845</span>
<span class="normal">6846</span>
<span class="normal">6847</span>
<span class="normal">6848</span>
<span class="normal">6849</span>
<span class="normal">6850</span>
<span class="normal">6851</span>
<span class="normal">6852</span>
<span class="normal">6853</span>
<span class="normal">6854</span>
<span class="normal">6855</span>
<span class="normal">6856</span>
<span class="normal">6857</span>
<span class="normal">6858</span>
<span class="normal">6859</span>
<span class="normal">6860</span>
<span class="normal">6861</span>
<span class="normal">6862</span>
<span class="normal">6863</span>
<span class="normal">6864</span>
<span class="normal">6865</span>
<span class="normal">6866</span>
<span class="normal">6867</span>
<span class="normal">6868</span>
<span class="normal">6869</span>
<span class="normal">6870</span>
<span class="normal">6871</span>
<span class="normal">6872</span>
<span class="normal">6873</span>
<span class="normal">6874</span>
<span class="normal">6875</span>
<span class="normal">6876</span>
<span class="normal">6877</span>
<span class="normal">6878</span>
<span class="normal">6879</span>
<span class="normal">6880</span>
<span class="normal">6881</span>
<span class="normal">6882</span>
<span class="normal">6883</span>
<span class="normal">6884</span>
<span class="normal">6885</span>
<span class="normal">6886</span>
<span class="normal">6887</span>
<span class="normal">6888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_geometric_properties</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">area_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m2&quot;</span><span class="p">,</span>
    <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates geometric properties and adds them to the GeoDataFrame.</span>

<span class="sd">    This function calculates various geometric properties of features in a</span>
<span class="sd">    GeoDataFrame and adds them as new columns without modifying existing attributes.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: GeoDataFrame containing vector features.</span>
<span class="sd">        properties: List of geometric properties to calculate. Options include:</span>
<span class="sd">            &#39;area&#39;, &#39;length&#39;, &#39;perimeter&#39;, &#39;centroid_x&#39;, &#39;centroid_y&#39;, &#39;bounds&#39;,</span>
<span class="sd">            &#39;convex_hull_area&#39;, &#39;orientation&#39;, &#39;complexity&#39;, &#39;area_bbox&#39;,</span>
<span class="sd">            &#39;area_convex&#39;, &#39;area_filled&#39;, &#39;major_length&#39;, &#39;minor_length&#39;,</span>
<span class="sd">            &#39;eccentricity&#39;, &#39;diameter_areagth&#39;, &#39;extent&#39;, &#39;solidity&#39;,</span>
<span class="sd">            &#39;elongation&#39;.</span>
<span class="sd">            Defaults to [&#39;area&#39;, &#39;length&#39;] if None.</span>
<span class="sd">        area_unit: String specifying the unit for area calculation (&#39;m2&#39;, &#39;km2&#39;,</span>
<span class="sd">            &#39;ha&#39;). Defaults to &#39;m2&#39;.</span>
<span class="sd">        length_unit: String specifying the unit for length calculation (&#39;m&#39;, &#39;km&#39;).</span>
<span class="sd">            Defaults to &#39;m&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: A copy of the input GeoDataFrame with added</span>
<span class="sd">        geometric property columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">unary_union</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Make a copy to avoid modifying the original</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Default properties to calculate</span>
    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convex_hull_area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;complexity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_bbox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_convex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_filled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;major_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minor_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diameter_area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elongation&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># Make sure we&#39;re working with a GeoDataFrame with a valid CRS</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input must be a GeoDataFrame&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;GeoDataFrame must have a defined coordinate reference system (CRS)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Ensure we&#39;re working with a projected CRS for accurate measurements</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
        <span class="c1"># Reproject to a suitable projected CRS for accurate measurements</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">estimate_utm_crs</span><span class="p">())</span>

    <span class="c1"># Basic area calculation with unit conversion</span>
    <span class="k">if</span> <span class="s2">&quot;area&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="c1"># Calculate area (only for polygons)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>  <span class="c1"># m² to km²</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>  <span class="c1"># m² to hectares</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m²</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Length calculation with unit conversion</span>
    <span class="k">if</span> <span class="s2">&quot;length&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="c1"># Calculate length (works for lines and polygon boundaries)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>  <span class="c1"># m to km</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;length_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;length_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Perimeter calculation (for polygons)</span>
    <span class="k">if</span> <span class="s2">&quot;perimeter&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;perimeter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">length</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;perimeter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;perimeter&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>  <span class="c1"># m to km</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perimeter&quot;</span><span class="p">:</span> <span class="s2">&quot;perimeter_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perimeter&quot;</span><span class="p">:</span> <span class="s2">&quot;perimeter_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Centroid coordinates</span>
    <span class="k">if</span> <span class="s2">&quot;centroid_x&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="ow">or</span> <span class="s2">&quot;centroid_y&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>

        <span class="k">if</span> <span class="s2">&quot;centroid_x&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">x</span>

        <span class="k">if</span> <span class="s2">&quot;centroid_y&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">y</span>

    <span class="c1"># Bounding box properties</span>
    <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;miny&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;maxx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;maxy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span>

    <span class="c1"># Area of bounding box</span>
    <span class="k">if</span> <span class="s2">&quot;area_bbox&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;area_bbox_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;area_bbox_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m²</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;area_bbox_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Area of convex hull</span>
    <span class="k">if</span> <span class="s2">&quot;area_convex&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="ow">or</span> <span class="s2">&quot;convex_hull_area&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">convex_hull</span><span class="o">.</span><span class="n">area</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_convex&quot;</span><span class="p">:</span> <span class="s2">&quot;area_convex_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_convex&quot;</span><span class="p">:</span> <span class="s2">&quot;area_convex_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m²</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_convex&quot;</span><span class="p">:</span> <span class="s2">&quot;area_convex_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For backward compatibility</span>
        <span class="k">if</span> <span class="s2">&quot;convex_hull_area&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="ow">and</span> <span class="s2">&quot;area_convex&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">:</span> <span class="s2">&quot;convex_hull_area_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">:</span> <span class="s2">&quot;convex_hull_area_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">:</span> <span class="s2">&quot;convex_hull_area_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

    <span class="c1"># Area of filled geometry (no holes)</span>
    <span class="k">if</span> <span class="s2">&quot;area_filled&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_filled_area</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">)):</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">):</span>
                <span class="c1"># For MultiPolygon, fill all constituent polygons</span>
                <span class="n">filled_polys</span> <span class="o">=</span> <span class="p">[</span><span class="n">Polygon</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">unary_union</span><span class="p">(</span><span class="n">filled_polys</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For single Polygon, create a new one with just the exterior ring</span>
                <span class="k">return</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_filled_area</span><span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_filled&quot;</span><span class="p">:</span> <span class="s2">&quot;area_filled_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_filled&quot;</span><span class="p">:</span> <span class="s2">&quot;area_filled_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m²</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_filled&quot;</span><span class="p">:</span> <span class="s2">&quot;area_filled_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Axes lengths, eccentricity, orientation, and elongation</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;major_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minor_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elongation&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_axes_properties</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="c1"># Skip non-polygons</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Handle multipolygons by using the largest polygon</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">):</span>
                <span class="c1"># Get the polygon with the largest area</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the minimum rotated rectangle</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">minimum_rotated_rectangle</span>

                <span class="c1"># Extract coordinates</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span>
                    <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
                <span class="p">]</span>  <span class="c1"># Remove the duplicated last point</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

                <span class="c1"># Calculate lengths of all four sides</span>
                <span class="n">sides</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">p2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span> <span class="o">%</span> <span class="mi">180</span>
                    <span class="n">sides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>

                <span class="c1"># Group sides by length (allowing for small differences due to floating point precision)</span>
                <span class="c1"># This ensures we correctly identify the rectangle&#39;s dimensions</span>
                <span class="n">sides_grouped</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># Tolerance for length comparison</span>

                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
                    <span class="n">length</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sides_grouped</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                            <span class="n">sides_grouped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                            <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                        <span class="n">sides_grouped</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>

                <span class="c1"># Get unique lengths (should be 2 for a rectangle, parallel sides have equal length)</span>
                <span class="n">unique_lengths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sides_grouped</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_lengths</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># If we don&#39;t get exactly 2 unique lengths, something is wrong with the rectangle</span>
                    <span class="c1"># Fall back to simpler method using bounds</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">bounds</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">major_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">minor_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span> <span class="k">else</span> <span class="mi">90</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">major_length</span> <span class="o">=</span> <span class="n">unique_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">minor_length</span> <span class="o">=</span> <span class="n">unique_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Get orientation from the major axis</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">sides_grouped</span><span class="p">[</span><span class="n">major_length</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Calculate eccentricity</span>
                <span class="k">if</span> <span class="n">major_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Eccentricity for an ellipse: e = sqrt(1 - (b²/a²))</span>
                    <span class="c1"># where a is the semi-major axis and b is the semi-minor axis</span>
                    <span class="n">eccentricity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">minor_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">major_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eccentricity</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Calculate elongation (ratio of minor to major axis)</span>
                <span class="n">elongation</span> <span class="o">=</span> <span class="n">major_length</span> <span class="o">/</span> <span class="n">minor_length</span> <span class="k">if</span> <span class="n">major_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                <span class="k">return</span> <span class="n">major_length</span><span class="p">,</span> <span class="n">minor_length</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">elongation</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># For debugging</span>
                <span class="c1"># print(f&quot;Error calculating axes: {e}&quot;)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Apply the function and split the results</span>
        <span class="n">axes_data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_axes_properties</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;major_length&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;major_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Convert to requested units</span>
            <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;major_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;major_length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;major_length&quot;</span><span class="p">:</span> <span class="s2">&quot;major_length_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;major_length&quot;</span><span class="p">:</span> <span class="s2">&quot;major_length_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;minor_length&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minor_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Convert to requested units</span>
            <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minor_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minor_length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;minor_length&quot;</span><span class="p">:</span> <span class="s2">&quot;minor_length_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;minor_length&quot;</span><span class="p">:</span> <span class="s2">&quot;minor_length_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;eccentricity&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;eccentricity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;elongation&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;elongation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Equivalent diameter based on area</span>
    <span class="k">if</span> <span class="s2">&quot;diameter_areagth&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_equivalent_diameter</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># Diameter of a circle with the same area: d = 2 * sqrt(A / π)</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_equivalent_diameter</span><span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">:</span> <span class="s2">&quot;equivalent_diameter_area_km&quot;</span><span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">:</span> <span class="s2">&quot;equivalent_diameter_area_m&quot;</span><span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Extent (ratio of shape area to bounding box area)</span>
    <span class="k">if</span> <span class="s2">&quot;extent&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_extent</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">bbox_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">bbox_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">bbox_area</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;extent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_extent</span><span class="p">)</span>

    <span class="c1"># Solidity (ratio of shape area to convex hull area)</span>
    <span class="k">if</span> <span class="s2">&quot;solidity&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_solidity</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">convex_hull_area</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">convex_hull</span><span class="o">.</span><span class="n">area</span>

            <span class="k">if</span> <span class="n">convex_hull_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">convex_hull_area</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;solidity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_solidity</span><span class="p">)</span>

    <span class="c1"># Complexity (ratio of perimeter to area)</span>
    <span class="k">if</span> <span class="s2">&quot;complexity&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_complexity</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">and</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Shape index: P / (2 * sqrt(π * A))</span>
                <span class="c1"># Normalized to 1 for a circle, higher for more complex shapes</span>
                <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;complexity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_complexity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.analyze_vector_attributes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_vector_attributes</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">)</span></code>

<a href="#geoai.geoai.analyze_vector_attributes" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Analyze a specific attribute in a vector dataset and create a histogram.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing analysis results for the attribute</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_vector_attributes</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze a specific attribute in a vector dataset and create a histogram.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>
<span class="sd">        attribute_name (str): Name of the attribute to analyze</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing analysis results for the attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Check if attribute exists</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; not found in the dataset&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get the attribute series</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]</span>

        <span class="c1"># Perform different analyses based on data type</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="c1"># Numeric attribute</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attribute_name</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;numeric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="s2">&quot;null_count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="c1"># Create histogram</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram of </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Categorical attribute</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attribute_name</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="s2">&quot;null_count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
                <span class="s2">&quot;value_counts&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="c1"># Create bar plot for top categories</span>
            <span class="n">top_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s2"> values for </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">analysis</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing attribute: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.batch_vector_to_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_vector_to_raster</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">attribute_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_rasters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_filename_pattern</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{vector_name}</span><span class="s1">_</span><span class="si">{index}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.batch_vector_to_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Batch convert vector data to multiple rasters based on different extents or reference rasters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input vector file or a GeoDataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save output raster files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in the vector data to use for pixel values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_rasters</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of paths to reference rasters for dimensions, transform and CRS.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bounds_list</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of bounds tuples (left, bottom, right, top) to use if reference_rasters not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_filename_pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pattern for output filenames.
Can include {vector_name} and {index} placeholders.</p>
              </div>
            </td>
            <td>
                  <code>&#39;{vector_name}_{index}&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pixel_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size to use if reference_rasters not provided.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, all pixels touched by geometries will be burned in.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fill_value</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to fill the raster with before burning in features.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="numpy.dtype">dtype</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type of the output raster.</p>
              </div>
            </td>
            <td>
                  <code><span title="numpy.uint8">uint8</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nodata</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>No data value for the output raster.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: List of paths to the created raster files.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">batch_vector_to_raster</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">attribute_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_rasters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bounds_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_filename_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{vector_name}</span><span class="s2">_</span><span class="si">{index}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">pixel_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch convert vector data to multiple rasters based on different extents or reference rasters.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str or GeoDataFrame): Path to the input vector file or a GeoDataFrame.</span>
<span class="sd">        output_dir (str): Directory to save output raster files.</span>
<span class="sd">        attribute_field (str): Field name in the vector data to use for pixel values.</span>
<span class="sd">        reference_rasters (list): List of paths to reference rasters for dimensions, transform and CRS.</span>
<span class="sd">        bounds_list (list): List of bounds tuples (left, bottom, right, top) to use if reference_rasters not provided.</span>
<span class="sd">        output_filename_pattern (str): Pattern for output filenames.</span>
<span class="sd">            Can include {vector_name} and {index} placeholders.</span>
<span class="sd">        pixel_size (float or tuple): Pixel size to use if reference_rasters not provided.</span>
<span class="sd">        all_touched (bool): If True, all pixels touched by geometries will be burned in.</span>
<span class="sd">        fill_value (int): Value to fill the raster with before burning in features.</span>
<span class="sd">        dtype (numpy.dtype): Data type of the output raster.</span>
<span class="sd">        nodata (int): No data value for the output raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: List of paths to the created raster files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load vector data if it&#39;s a path</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
        <span class="n">vector_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vector_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">vector_path</span>
        <span class="n">vector_name</span> <span class="o">=</span> <span class="s2">&quot;vector&quot;</span>

    <span class="c1"># Check input parameters</span>
    <span class="k">if</span> <span class="n">reference_rasters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bounds_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either reference_rasters or bounds_list must be provided.&quot;</span><span class="p">)</span>

    <span class="c1"># Use reference_rasters if provided, otherwise use bounds_list</span>
    <span class="k">if</span> <span class="n">reference_rasters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">reference_rasters</span>
        <span class="n">is_raster_reference</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">bounds_list</span>
        <span class="n">is_raster_reference</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Create output filenames</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each source (reference raster or bounds)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing&quot;</span><span class="p">)):</span>
        <span class="c1"># Generate output filename</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">output_filename_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">vector_name</span><span class="o">=</span><span class="n">vector_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="n">output_filename</span> <span class="o">+=</span> <span class="s2">&quot;.tif&quot;</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_raster_reference</span><span class="p">:</span>
            <span class="c1"># Use reference raster</span>
            <span class="n">vector_to_raster</span><span class="p">(</span>
                <span class="n">vector_path</span><span class="o">=</span><span class="n">gdf</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">reference_raster</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="n">attribute_field</span><span class="o">=</span><span class="n">attribute_field</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use bounds</span>
            <span class="n">vector_to_raster</span><span class="p">(</span>
                <span class="n">vector_path</span><span class="o">=</span><span class="n">gdf</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                <span class="n">attribute_field</span><span class="o">=</span><span class="n">attribute_field</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.bbox_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">bbox_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">coord_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.bbox_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a list of coordinates to pixel coordinates, i.e., (col, row) coordinates.
    Note that map bbox coords is [minx, miny, maxx, maxy] from bottomleft to topright
    While rasterio bbox coords is [minx, max, maxx, min] from topleft to bottomright</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of coordinates in the format of [[minx, miny, maxx, maxy], [minx, miny, maxx, maxy], ...]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coord_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coordinate CRS of the input coordinates. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of pixel coordinates in the format of [[minx, maxy, maxx, miny], ...] from top left to bottom right.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8638</span>
<span class="normal">8639</span>
<span class="normal">8640</span>
<span class="normal">8641</span>
<span class="normal">8642</span>
<span class="normal">8643</span>
<span class="normal">8644</span>
<span class="normal">8645</span>
<span class="normal">8646</span>
<span class="normal">8647</span>
<span class="normal">8648</span>
<span class="normal">8649</span>
<span class="normal">8650</span>
<span class="normal">8651</span>
<span class="normal">8652</span>
<span class="normal">8653</span>
<span class="normal">8654</span>
<span class="normal">8655</span>
<span class="normal">8656</span>
<span class="normal">8657</span>
<span class="normal">8658</span>
<span class="normal">8659</span>
<span class="normal">8660</span>
<span class="normal">8661</span>
<span class="normal">8662</span>
<span class="normal">8663</span>
<span class="normal">8664</span>
<span class="normal">8665</span>
<span class="normal">8666</span>
<span class="normal">8667</span>
<span class="normal">8668</span>
<span class="normal">8669</span>
<span class="normal">8670</span>
<span class="normal">8671</span>
<span class="normal">8672</span>
<span class="normal">8673</span>
<span class="normal">8674</span>
<span class="normal">8675</span>
<span class="normal">8676</span>
<span class="normal">8677</span>
<span class="normal">8678</span>
<span class="normal">8679</span>
<span class="normal">8680</span>
<span class="normal">8681</span>
<span class="normal">8682</span>
<span class="normal">8683</span>
<span class="normal">8684</span>
<span class="normal">8685</span>
<span class="normal">8686</span>
<span class="normal">8687</span>
<span class="normal">8688</span>
<span class="normal">8689</span>
<span class="normal">8690</span>
<span class="normal">8691</span>
<span class="normal">8692</span>
<span class="normal">8693</span>
<span class="normal">8694</span>
<span class="normal">8695</span>
<span class="normal">8696</span>
<span class="normal">8697</span>
<span class="normal">8698</span>
<span class="normal">8699</span>
<span class="normal">8700</span>
<span class="normal">8701</span>
<span class="normal">8702</span>
<span class="normal">8703</span>
<span class="normal">8704</span>
<span class="normal">8705</span>
<span class="normal">8706</span>
<span class="normal">8707</span>
<span class="normal">8708</span>
<span class="normal">8709</span>
<span class="normal">8710</span>
<span class="normal">8711</span>
<span class="normal">8712</span>
<span class="normal">8713</span>
<span class="normal">8714</span>
<span class="normal">8715</span>
<span class="normal">8716</span>
<span class="normal">8717</span>
<span class="normal">8718</span>
<span class="normal">8719</span>
<span class="normal">8720</span>
<span class="normal">8721</span>
<span class="normal">8722</span>
<span class="normal">8723</span>
<span class="normal">8724</span>
<span class="normal">8725</span>
<span class="normal">8726</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bbox_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">coord_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a list of coordinates to pixel coordinates, i.e., (col, row) coordinates.</span>
<span class="sd">        Note that map bbox coords is [minx, miny, maxx, maxy] from bottomleft to topright</span>
<span class="sd">        While rasterio bbox coords is [minx, max, maxx, min] from topleft to bottomright</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp (str): The source raster file path.</span>
<span class="sd">        coords (list): A list of coordinates in the format of [[minx, miny, maxx, maxy], [minx, miny, maxx, maxy], ...]</span>
<span class="sd">        coord_crs (str, optional): The coordinate CRS of the input coordinates. Defaults to &quot;epsg:4326&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of pixel coordinates in the format of [[minx, maxy, maxx, miny], ...] from top left to bottom right.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coord_crs</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epsg:</span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

        <span class="n">geojson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coords must be a list of coordinates.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">coords</span><span class="p">]</span>

    <span class="n">new_coords</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>

        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">coord</span>

            <span class="k">if</span> <span class="n">coord_crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="n">rows1</span><span class="p">,</span> <span class="n">cols1</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="n">rows2</span><span class="p">,</span> <span class="n">cols2</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

                <span class="n">new_coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cols1</span><span class="p">,</span> <span class="n">rows1</span><span class="p">,</span> <span class="n">cols2</span><span class="p">,</span> <span class="n">rows2</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">new_coords</span><span class="p">:</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">coord</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">minx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">miny</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">maxx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">maxy</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">minx</span> <span class="o">&lt;</span> <span class="n">width</span>
            <span class="ow">and</span> <span class="n">miny</span> <span class="o">&lt;</span> <span class="n">height</span>
            <span class="ow">and</span> <span class="n">maxx</span> <span class="o">&lt;</span> <span class="n">width</span>
            <span class="ow">and</span> <span class="n">maxy</span> <span class="o">&lt;</span> <span class="n">height</span>
        <span class="p">):</span>
            <span class="c1"># Note that map bbox coords is [minx, miny, maxx, maxy] from bottomleft to topright</span>
            <span class="c1"># While rasterio bbox coords is [minx, max, maxx, min] from topleft to bottomright</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">miny</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pixel coordinates found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some coordinates are out of the image boundary.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.boxes_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">boxes_to_vector</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.boxes_to_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a list of bounding box coordinates to vector data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of bounding box coordinates in the format [[left, top, right, bottom], [left, top, right, bottom], ...].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>src_crs</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The EPSG code or proj4 string representing the source coordinate reference system (CRS) of the input coordinates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dst_crs</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The EPSG code or proj4 string representing the destination CRS to reproject the data (default is "EPSG:4326").</p>
              </div>
            </td>
            <td>
                  <code>&#39;EPSG:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The full file path (including the directory and filename without the extension) where the vector data should be saved.
                           If None (default), the function returns the GeoDataFrame without saving it to a file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to geopandas.GeoDataFrame.to_file() when saving the vector data.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame or None: The GeoDataFrame with the converted vector data if output is None, otherwise None if the data is saved to a file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8543</span>
<span class="normal">8544</span>
<span class="normal">8545</span>
<span class="normal">8546</span>
<span class="normal">8547</span>
<span class="normal">8548</span>
<span class="normal">8549</span>
<span class="normal">8550</span>
<span class="normal">8551</span>
<span class="normal">8552</span>
<span class="normal">8553</span>
<span class="normal">8554</span>
<span class="normal">8555</span>
<span class="normal">8556</span>
<span class="normal">8557</span>
<span class="normal">8558</span>
<span class="normal">8559</span>
<span class="normal">8560</span>
<span class="normal">8561</span>
<span class="normal">8562</span>
<span class="normal">8563</span>
<span class="normal">8564</span>
<span class="normal">8565</span>
<span class="normal">8566</span>
<span class="normal">8567</span>
<span class="normal">8568</span>
<span class="normal">8569</span>
<span class="normal">8570</span>
<span class="normal">8571</span>
<span class="normal">8572</span>
<span class="normal">8573</span>
<span class="normal">8574</span>
<span class="normal">8575</span>
<span class="normal">8576</span>
<span class="normal">8577</span>
<span class="normal">8578</span>
<span class="normal">8579</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">boxes_to_vector</span><span class="p">(</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">src_crs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dst_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of bounding box coordinates to vector data.</span>

<span class="sd">    Args:</span>
<span class="sd">        coords (list): A list of bounding box coordinates in the format [[left, top, right, bottom], [left, top, right, bottom], ...].</span>
<span class="sd">        src_crs (int or str): The EPSG code or proj4 string representing the source coordinate reference system (CRS) of the input coordinates.</span>
<span class="sd">        dst_crs (int or str, optional): The EPSG code or proj4 string representing the destination CRS to reproject the data (default is &quot;EPSG:4326&quot;).</span>
<span class="sd">        output (str or None, optional): The full file path (including the directory and filename without the extension) where the vector data should be saved.</span>
<span class="sd">                                       If None (default), the function returns the GeoDataFrame without saving it to a file.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to geopandas.GeoDataFrame.to_file() when saving the vector data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame or None: The GeoDataFrame with the converted vector data if output is None, otherwise None if the data is saved to a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>

    <span class="c1"># Create a list of Shapely Polygon objects based on the provided coordinates</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>

    <span class="c1"># Create a GeoDataFrame with the Shapely Polygon objects</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">polygons</span><span class="p">},</span> <span class="n">crs</span><span class="o">=</span><span class="n">src_crs</span><span class="p">)</span>

    <span class="c1"># Reproject the GeoDataFrame to the specified EPSG code</span>
    <span class="n">gdf_reprojected</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">dst_crs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gdf_reprojected</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdf_reprojected</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.calc_f1_score" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_f1_score</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#geoai.geoai.calc_f1_score" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate F1 score between ground truth and prediction masks.</p>
<p>The F1 score is the harmonic mean of precision and recall, computed as:
F1 = 2 * (precision * recall) / (precision + recall)
where precision = TP / (TP + FP) and recall = TP / (TP + FN).</p>
<p>This function supports both binary and multi-class segmentation, and can handle
numpy arrays, PyTorch tensors, or file paths to raster files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth segmentation mask.
Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.
For binary segmentation: shape (H, W) with values {0, 1}.
For multi-class segmentation: shape (H, W) with class indices.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted segmentation mask.
Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.
Should have the same shape and format as ground_truth.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_classes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for multi-class segmentation.
If None, assumes binary segmentation. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_index</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class index to ignore in computation.
Useful for ignoring background or unlabeled pixels. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Smoothing factor to avoid division by zero.
Defaults to 1e-6.</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Band index to read from raster file (1-based indexing).
Only used when input is a file path. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union[float, np.ndarray]: For binary segmentation, returns a single float F1 score.
For multi-class segmentation, returns an array of F1 scores for each class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Binary segmentation with arrays</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f1</span> <span class="o">=</span> <span class="n">calc_f1_score</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">F1 Score: 0.8571</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Multi-class segmentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f1</span> <span class="o">=</span> <span class="n">calc_f1_score</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score per class: </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">F1 Score per class: [0.8571 0.6667 0.6667]</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using PyTorch tensors</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f1</span> <span class="o">=</span> <span class="n">calc_f1_score</span><span class="p">(</span><span class="n">gt_tensor</span><span class="p">,</span> <span class="n">pred_tensor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">F1 Score: 0.8571</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using raster file paths</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f1</span> <span class="o">=</span> <span class="n">calc_f1_score</span><span class="p">(</span><span class="s2">&quot;ground_truth.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction.tif&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean F1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Mean F1: 0.7302</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_f1_score</span><span class="p">(</span>
    <span class="n">ground_truth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smooth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate F1 score between ground truth and prediction masks.</span>

<span class="sd">    The F1 score is the harmonic mean of precision and recall, computed as:</span>
<span class="sd">    F1 = 2 * (precision * recall) / (precision + recall)</span>
<span class="sd">    where precision = TP / (TP + FP) and recall = TP / (TP + FN).</span>

<span class="sd">    This function supports both binary and multi-class segmentation, and can handle</span>
<span class="sd">    numpy arrays, PyTorch tensors, or file paths to raster files.</span>

<span class="sd">    Args:</span>
<span class="sd">        ground_truth (Union[str, np.ndarray, torch.Tensor]): Ground truth segmentation mask.</span>
<span class="sd">            Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.</span>
<span class="sd">            For binary segmentation: shape (H, W) with values {0, 1}.</span>
<span class="sd">            For multi-class segmentation: shape (H, W) with class indices.</span>
<span class="sd">        prediction (Union[str, np.ndarray, torch.Tensor]): Predicted segmentation mask.</span>
<span class="sd">            Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.</span>
<span class="sd">            Should have the same shape and format as ground_truth.</span>
<span class="sd">        num_classes (Optional[int], optional): Number of classes for multi-class segmentation.</span>
<span class="sd">            If None, assumes binary segmentation. Defaults to None.</span>
<span class="sd">        ignore_index (Optional[int], optional): Class index to ignore in computation.</span>
<span class="sd">            Useful for ignoring background or unlabeled pixels. Defaults to None.</span>
<span class="sd">        smooth (float, optional): Smoothing factor to avoid division by zero.</span>
<span class="sd">            Defaults to 1e-6.</span>
<span class="sd">        band (int, optional): Band index to read from raster file (1-based indexing).</span>
<span class="sd">            Only used when input is a file path. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[float, np.ndarray]: For binary segmentation, returns a single float F1 score.</span>
<span class="sd">            For multi-class segmentation, returns an array of F1 scores for each class.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Binary segmentation with arrays</span>
<span class="sd">        &gt;&gt;&gt; gt = np.array([[0, 0, 1, 1], [0, 1, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred = np.array([[0, 0, 1, 1], [0, 0, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; f1 = calc_f1_score(gt, pred)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;F1 Score: {f1:.4f}&quot;)</span>
<span class="sd">        F1 Score: 0.8571</span>

<span class="sd">        &gt;&gt;&gt; # Multi-class segmentation</span>
<span class="sd">        &gt;&gt;&gt; gt = np.array([[0, 0, 1, 1], [0, 2, 2, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred = np.array([[0, 0, 1, 1], [0, 0, 2, 2]])</span>
<span class="sd">        &gt;&gt;&gt; f1 = calc_f1_score(gt, pred, num_classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;F1 Score per class: {f1}&quot;)</span>
<span class="sd">        F1 Score per class: [0.8571 0.6667 0.6667]</span>

<span class="sd">        &gt;&gt;&gt; # Using PyTorch tensors</span>
<span class="sd">        &gt;&gt;&gt; gt_tensor = torch.tensor([[0, 0, 1, 1], [0, 1, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred_tensor = torch.tensor([[0, 0, 1, 1], [0, 0, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; f1 = calc_f1_score(gt_tensor, pred_tensor)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;F1 Score: {f1:.4f}&quot;)</span>
<span class="sd">        F1 Score: 0.8571</span>

<span class="sd">        &gt;&gt;&gt; # Using raster file paths</span>
<span class="sd">        &gt;&gt;&gt; f1 = calc_f1_score(&quot;ground_truth.tif&quot;, &quot;prediction.tif&quot;, num_classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean F1: {np.nanmean(f1):.4f}&quot;)</span>
<span class="sd">        Mean F1: 0.7302</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load from file if string path is provided</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

    <span class="c1"># Convert to numpy if torch tensor</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Ensure inputs have the same shape</span>
    <span class="k">if</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Shape mismatch: ground_truth </span><span class="si">{</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs prediction </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Binary segmentation</span>
    <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Calculate True Positives, False Positives, False Negatives</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="o">~</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="o">~</span><span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Calculate precision and recall</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>

        <span class="c1"># Calculate F1 score</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>

    <span class="c1"># Multi-class segmentation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f1_per_class</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">class_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
            <span class="c1"># Mark ignored class with np.nan</span>
            <span class="k">if</span> <span class="n">ignore_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">class_idx</span> <span class="o">==</span> <span class="n">ignore_index</span><span class="p">:</span>
                <span class="n">f1_per_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Create binary masks for current class</span>
            <span class="n">gt_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">ground_truth</span> <span class="o">==</span> <span class="n">class_idx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">pred_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">==</span> <span class="n">class_idx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

            <span class="c1"># Calculate True Positives, False Positives, False Negatives</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gt_class</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="o">~</span><span class="n">gt_class</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gt_class</span><span class="p">,</span> <span class="o">~</span><span class="n">pred_class</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="c1"># Calculate precision and recall</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>

            <span class="c1"># Calculate F1 score</span>
            <span class="k">if</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If class is not present in both gt and pred</span>
                <span class="n">f1_per_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
                <span class="n">f1_per_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f1_per_class</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.calc_iou" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_iou</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#geoai.geoai.calc_iou" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate Intersection over Union (IoU) between ground truth and prediction masks.</p>
<p>This function computes the IoU metric for segmentation tasks. It supports both
binary and multi-class segmentation, and can handle numpy arrays, PyTorch tensors,
or file paths to raster files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth segmentation mask.
Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.
For binary segmentation: shape (H, W) with values {0, 1}.
For multi-class segmentation: shape (H, W) with class indices.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted segmentation mask.
Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.
Should have the same shape and format as ground_truth.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_classes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for multi-class segmentation.
If None, assumes binary segmentation. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_index</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class index to ignore in computation.
Useful for ignoring background or unlabeled pixels. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Smoothing factor to avoid division by zero.
Defaults to 1e-6.</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Band index to read from raster file (1-based indexing).
Only used when input is a file path. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union[float, np.ndarray]: For binary segmentation, returns a single float IoU score.
For multi-class segmentation, returns an array of IoU scores for each class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Binary segmentation with arrays</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iou</span> <span class="o">=</span> <span class="n">calc_iou</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IoU: </span><span class="si">{</span><span class="n">iou</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">IoU: 0.8333</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Multi-class segmentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iou</span> <span class="o">=</span> <span class="n">calc_iou</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IoU per class: </span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">IoU per class: [0.8333 0.5000 0.5000]</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using PyTorch tensors</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iou</span> <span class="o">=</span> <span class="n">calc_iou</span><span class="p">(</span><span class="n">gt_tensor</span><span class="p">,</span> <span class="n">pred_tensor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IoU: </span><span class="si">{</span><span class="n">iou</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">IoU: 0.8333</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using raster file paths</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iou</span> <span class="o">=</span> <span class="n">calc_iou</span><span class="p">(</span><span class="s2">&quot;ground_truth.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction.tif&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean IoU: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Mean IoU: 0.7500</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_iou</span><span class="p">(</span>
    <span class="n">ground_truth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smooth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Intersection over Union (IoU) between ground truth and prediction masks.</span>

<span class="sd">    This function computes the IoU metric for segmentation tasks. It supports both</span>
<span class="sd">    binary and multi-class segmentation, and can handle numpy arrays, PyTorch tensors,</span>
<span class="sd">    or file paths to raster files.</span>

<span class="sd">    Args:</span>
<span class="sd">        ground_truth (Union[str, np.ndarray, torch.Tensor]): Ground truth segmentation mask.</span>
<span class="sd">            Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.</span>
<span class="sd">            For binary segmentation: shape (H, W) with values {0, 1}.</span>
<span class="sd">            For multi-class segmentation: shape (H, W) with class indices.</span>
<span class="sd">        prediction (Union[str, np.ndarray, torch.Tensor]): Predicted segmentation mask.</span>
<span class="sd">            Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.</span>
<span class="sd">            Should have the same shape and format as ground_truth.</span>
<span class="sd">        num_classes (Optional[int], optional): Number of classes for multi-class segmentation.</span>
<span class="sd">            If None, assumes binary segmentation. Defaults to None.</span>
<span class="sd">        ignore_index (Optional[int], optional): Class index to ignore in computation.</span>
<span class="sd">            Useful for ignoring background or unlabeled pixels. Defaults to None.</span>
<span class="sd">        smooth (float, optional): Smoothing factor to avoid division by zero.</span>
<span class="sd">            Defaults to 1e-6.</span>
<span class="sd">        band (int, optional): Band index to read from raster file (1-based indexing).</span>
<span class="sd">            Only used when input is a file path. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[float, np.ndarray]: For binary segmentation, returns a single float IoU score.</span>
<span class="sd">            For multi-class segmentation, returns an array of IoU scores for each class.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Binary segmentation with arrays</span>
<span class="sd">        &gt;&gt;&gt; gt = np.array([[0, 0, 1, 1], [0, 1, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred = np.array([[0, 0, 1, 1], [0, 0, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; iou = calc_iou(gt, pred)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;IoU: {iou:.4f}&quot;)</span>
<span class="sd">        IoU: 0.8333</span>

<span class="sd">        &gt;&gt;&gt; # Multi-class segmentation</span>
<span class="sd">        &gt;&gt;&gt; gt = np.array([[0, 0, 1, 1], [0, 2, 2, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred = np.array([[0, 0, 1, 1], [0, 0, 2, 2]])</span>
<span class="sd">        &gt;&gt;&gt; iou = calc_iou(gt, pred, num_classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;IoU per class: {iou}&quot;)</span>
<span class="sd">        IoU per class: [0.8333 0.5000 0.5000]</span>

<span class="sd">        &gt;&gt;&gt; # Using PyTorch tensors</span>
<span class="sd">        &gt;&gt;&gt; gt_tensor = torch.tensor([[0, 0, 1, 1], [0, 1, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred_tensor = torch.tensor([[0, 0, 1, 1], [0, 0, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; iou = calc_iou(gt_tensor, pred_tensor)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;IoU: {iou:.4f}&quot;)</span>
<span class="sd">        IoU: 0.8333</span>

<span class="sd">        &gt;&gt;&gt; # Using raster file paths</span>
<span class="sd">        &gt;&gt;&gt; iou = calc_iou(&quot;ground_truth.tif&quot;, &quot;prediction.tif&quot;, num_classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean IoU: {np.nanmean(iou):.4f}&quot;)</span>
<span class="sd">        Mean IoU: 0.7500</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load from file if string path is provided</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

    <span class="c1"># Convert to numpy if torch tensor</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Ensure inputs have the same shape</span>
    <span class="k">if</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Shape mismatch: ground_truth </span><span class="si">{</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs prediction </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Binary segmentation</span>
    <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">intersection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">union</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">union</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">intersection</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="n">iou</span> <span class="o">=</span> <span class="p">(</span><span class="n">intersection</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">union</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>

    <span class="c1"># Multi-class segmentation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iou_per_class</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">class_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
            <span class="c1"># Handle ignored class by appending np.nan</span>
            <span class="k">if</span> <span class="n">ignore_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">class_idx</span> <span class="o">==</span> <span class="n">ignore_index</span><span class="p">:</span>
                <span class="n">iou_per_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Create binary masks for current class</span>
            <span class="n">gt_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">ground_truth</span> <span class="o">==</span> <span class="n">class_idx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">pred_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">==</span> <span class="n">class_idx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

            <span class="n">intersection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gt_class</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">union</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">gt_class</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">union</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If class is not present in both gt and pred</span>
                <span class="n">iou_per_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iou_per_class</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">intersection</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">union</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">iou_per_class</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.calc_segmentation_metrics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_segmentation_metrics</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iou&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">],</span> <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#geoai.geoai.calc_segmentation_metrics" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate multiple segmentation metrics between ground truth and prediction masks.</p>
<p>This is a convenient wrapper function that computes multiple metrics at once,
including IoU (Intersection over Union) and F1 score. It supports both binary
and multi-class segmentation, and can handle numpy arrays, PyTorch tensors,
or file paths to raster files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth segmentation mask.
Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.
For binary segmentation: shape (H, W) with values {0, 1}.
For multi-class segmentation: shape (H, W) with class indices.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted segmentation mask.
Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.
Should have the same shape and format as ground_truth.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_classes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for multi-class segmentation.
If None, assumes binary segmentation. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_index</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class index to ignore in computation.
Useful for ignoring background or unlabeled pixels. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smooth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Smoothing factor to avoid division by zero.
Defaults to 1e-6.</p>
              </div>
            </td>
            <td>
                  <code>1e-06</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of metrics to calculate.
Options: "iou", "f1". Defaults to ["iou", "f1"].</p>
              </div>
            </td>
            <td>
                  <code>[&#39;iou&#39;, &#39;f1&#39;]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Band index to read from raster file (1-based indexing).
Only used when input is a file path. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="numpy.ndarray">ndarray</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Union[float, np.ndarray]]: Dictionary containing the computed metrics.
Keys are metric names ("iou", "f1"), values are the metric scores.
For binary segmentation, values are floats.
For multi-class segmentation, values are numpy arrays with per-class scores.
Also includes "mean_iou" and "mean_f1" for multi-class segmentation
(mean computed over valid classes, ignoring NaN values).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Binary segmentation with arrays</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_segmentation_metrics</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IoU: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;iou&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">IoU: 0.8333, F1: 0.8571</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Multi-class segmentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_segmentation_metrics</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean IoU: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_iou&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean F1: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Per-class IoU: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;iou&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Mean IoU: 0.6111</span>
<span class="go">Mean F1: 0.7302</span>
<span class="go">Per-class IoU: [0.8333 0.5000 0.5000]</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Calculate only IoU</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_segmentation_metrics</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;iou&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean IoU: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_iou&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Mean IoU: 0.6111</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using PyTorch tensors</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pred_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_segmentation_metrics</span><span class="p">(</span><span class="n">gt_tensor</span><span class="p">,</span> <span class="n">pred_tensor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IoU: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;iou&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">IoU: 0.8333, F1: 0.8571</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using raster file paths</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_segmentation_metrics</span><span class="p">(</span><span class="s2">&quot;ground_truth.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction.tif&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean IoU: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_iou&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean F1: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Mean IoU: 0.6111</span>
<span class="go">Mean F1: 0.7302</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_segmentation_metrics</span><span class="p">(</span>
    <span class="n">ground_truth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smooth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;iou&quot;</span><span class="p">,</span> <span class="s2">&quot;f1&quot;</span><span class="p">],</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate multiple segmentation metrics between ground truth and prediction masks.</span>

<span class="sd">    This is a convenient wrapper function that computes multiple metrics at once,</span>
<span class="sd">    including IoU (Intersection over Union) and F1 score. It supports both binary</span>
<span class="sd">    and multi-class segmentation, and can handle numpy arrays, PyTorch tensors,</span>
<span class="sd">    or file paths to raster files.</span>

<span class="sd">    Args:</span>
<span class="sd">        ground_truth (Union[str, np.ndarray, torch.Tensor]): Ground truth segmentation mask.</span>
<span class="sd">            Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.</span>
<span class="sd">            For binary segmentation: shape (H, W) with values {0, 1}.</span>
<span class="sd">            For multi-class segmentation: shape (H, W) with class indices.</span>
<span class="sd">        prediction (Union[str, np.ndarray, torch.Tensor]): Predicted segmentation mask.</span>
<span class="sd">            Can be a file path (str) to a raster file, numpy array, or PyTorch tensor.</span>
<span class="sd">            Should have the same shape and format as ground_truth.</span>
<span class="sd">        num_classes (Optional[int], optional): Number of classes for multi-class segmentation.</span>
<span class="sd">            If None, assumes binary segmentation. Defaults to None.</span>
<span class="sd">        ignore_index (Optional[int], optional): Class index to ignore in computation.</span>
<span class="sd">            Useful for ignoring background or unlabeled pixels. Defaults to None.</span>
<span class="sd">        smooth (float, optional): Smoothing factor to avoid division by zero.</span>
<span class="sd">            Defaults to 1e-6.</span>
<span class="sd">        metrics (List[str], optional): List of metrics to calculate.</span>
<span class="sd">            Options: &quot;iou&quot;, &quot;f1&quot;. Defaults to [&quot;iou&quot;, &quot;f1&quot;].</span>
<span class="sd">        band (int, optional): Band index to read from raster file (1-based indexing).</span>
<span class="sd">            Only used when input is a file path. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Union[float, np.ndarray]]: Dictionary containing the computed metrics.</span>
<span class="sd">            Keys are metric names (&quot;iou&quot;, &quot;f1&quot;), values are the metric scores.</span>
<span class="sd">            For binary segmentation, values are floats.</span>
<span class="sd">            For multi-class segmentation, values are numpy arrays with per-class scores.</span>
<span class="sd">            Also includes &quot;mean_iou&quot; and &quot;mean_f1&quot; for multi-class segmentation</span>
<span class="sd">            (mean computed over valid classes, ignoring NaN values).</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Binary segmentation with arrays</span>
<span class="sd">        &gt;&gt;&gt; gt = np.array([[0, 0, 1, 1], [0, 1, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred = np.array([[0, 0, 1, 1], [0, 0, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; metrics = calc_segmentation_metrics(gt, pred)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;IoU: {metrics[&#39;iou&#39;]:.4f}, F1: {metrics[&#39;f1&#39;]:.4f}&quot;)</span>
<span class="sd">        IoU: 0.8333, F1: 0.8571</span>

<span class="sd">        &gt;&gt;&gt; # Multi-class segmentation</span>
<span class="sd">        &gt;&gt;&gt; gt = np.array([[0, 0, 1, 1], [0, 2, 2, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred = np.array([[0, 0, 1, 1], [0, 0, 2, 2]])</span>
<span class="sd">        &gt;&gt;&gt; metrics = calc_segmentation_metrics(gt, pred, num_classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean IoU: {metrics[&#39;mean_iou&#39;]:.4f}&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean F1: {metrics[&#39;mean_f1&#39;]:.4f}&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Per-class IoU: {metrics[&#39;iou&#39;]}&quot;)</span>
<span class="sd">        Mean IoU: 0.6111</span>
<span class="sd">        Mean F1: 0.7302</span>
<span class="sd">        Per-class IoU: [0.8333 0.5000 0.5000]</span>

<span class="sd">        &gt;&gt;&gt; # Calculate only IoU</span>
<span class="sd">        &gt;&gt;&gt; metrics = calc_segmentation_metrics(gt, pred, num_classes=3, metrics=[&quot;iou&quot;])</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean IoU: {metrics[&#39;mean_iou&#39;]:.4f}&quot;)</span>
<span class="sd">        Mean IoU: 0.6111</span>

<span class="sd">        &gt;&gt;&gt; # Using PyTorch tensors</span>
<span class="sd">        &gt;&gt;&gt; gt_tensor = torch.tensor([[0, 0, 1, 1], [0, 1, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; pred_tensor = torch.tensor([[0, 0, 1, 1], [0, 0, 1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; metrics = calc_segmentation_metrics(gt_tensor, pred_tensor)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;IoU: {metrics[&#39;iou&#39;]:.4f}, F1: {metrics[&#39;f1&#39;]:.4f}&quot;)</span>
<span class="sd">        IoU: 0.8333, F1: 0.8571</span>

<span class="sd">        &gt;&gt;&gt; # Using raster file paths</span>
<span class="sd">        &gt;&gt;&gt; metrics = calc_segmentation_metrics(&quot;ground_truth.tif&quot;, &quot;prediction.tif&quot;, num_classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean IoU: {metrics[&#39;mean_iou&#39;]:.4f}&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean F1: {metrics[&#39;mean_f1&#39;]:.4f}&quot;)</span>
<span class="sd">        Mean IoU: 0.6111</span>
<span class="sd">        Mean F1: 0.7302</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Calculate IoU if requested</span>
    <span class="k">if</span> <span class="s2">&quot;iou&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="n">calc_iou</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="n">ignore_index</span><span class="p">,</span>
            <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
            <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;iou&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iou</span>

        <span class="c1"># Add mean IoU for multi-class</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iou</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># Calculate mean ignoring NaN values</span>
            <span class="n">valid_ious</span> <span class="o">=</span> <span class="n">iou</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">iou</span><span class="p">)]</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mean_iou&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_ious</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_ious</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">)</span>

    <span class="c1"># Calculate F1 score if requested</span>
    <span class="k">if</span> <span class="s2">&quot;f1&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">calc_f1_score</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">prediction</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="n">ignore_index</span><span class="p">,</span>
            <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
            <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1</span>

        <span class="c1"># Add mean F1 for multi-class</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># Calculate mean ignoring NaN values</span>
            <span class="n">valid_f1s</span> <span class="o">=</span> <span class="n">f1</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f1</span><span class="p">)]</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mean_f1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_f1s</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_f1s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.calc_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_stats</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.geoai.calc_stats" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate the statistics (mean and std) for the entire dataset.</p>
<p>This function is adapted from the plot_batch() function in the torchgeo library at
https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html.
Credit to the torchgeo developers for the original implementation.</p>
<p>Warning: This is an approximation. The correct value should take into account the
mean for the whole dataset for computing individual stds.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
                  <code><span title="RasterDataset">RasterDataset</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to calculate statistics for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>divide_by</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to divide the image data by. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[np.ndarray, np.ndarray]: The mean and standard deviation for each band.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_stats</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">divide_by</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the statistics (mean and std) for the entire dataset.</span>

<span class="sd">    This function is adapted from the plot_batch() function in the torchgeo library at</span>
<span class="sd">    https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html.</span>
<span class="sd">    Credit to the torchgeo developers for the original implementation.</span>

<span class="sd">    Warning: This is an approximation. The correct value should take into account the</span>
<span class="sd">    mean for the whole dataset for computing individual stds.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset (RasterDataset): The dataset to calculate statistics for.</span>
<span class="sd">        divide_by (float, optional): The value to divide the image data by. Defaults to 1.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray]: The mean and standard deviation for each band.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># To avoid loading the entire dataset in memory, we will loop through each img</span>
    <span class="c1"># The filenames will be retrieved from the dataset&#39;s rtree index</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">item</span><span class="o">.</span><span class="n">object</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Resetting statistics</span>
    <span class="n">accum_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">accum_std</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">/</span> <span class="n">divide_by</span>  <span class="c1"># type: ignore</span>
        <span class="n">accum_mean</span> <span class="o">+=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">accum_std</span> <span class="o">+=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># at the end, we shall have 2 vectors with length n=chnls</span>
    <span class="c1"># we will average them considering the number of images</span>
    <span class="k">return</span> <span class="n">accum_mean</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">accum_std</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.clip_raster_by_bbox" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="n">input_raster</span><span class="p">,</span> <span class="n">output_raster</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bbox_type</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="n">bbox_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.clip_raster_by_bbox" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Clip a raster dataset using a bounding box and optionally select specific bands.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input raster file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the clipped raster will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box coordinates either as:
         - Geographic coordinates (minx, miny, maxx, maxy) if bbox_type="geo"
         - Pixel indices (min_row, min_col, max_row, max_col) if bbox_type="pixel"</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bands</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices to keep (1-based indexing).
                   If None, all bands will be kept.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of bounding box coordinates. Either "geo" for
                      geographic coordinates or "pixel" for row/column indices.
                      Default is "geo".</p>
              </div>
            </td>
            <td>
                  <code>&#39;geo&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CRS of the bbox if different from the raster CRS.
                             Can be provided as EPSG code (e.g., "EPSG:4326") or
                             as a proj4 string. Only applies when bbox_type="geo".
                             If None, assumes bbox is in the same CRS as the raster.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the clipped output raster.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required dependencies are not installed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the bbox is invalid, bands are out of range, or bbox_type is invalid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the clipping operation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Clip using geographic coordinates in the same CRS as the raster</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_geo.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="go">&#39;clipped_geo.tif&#39;</span>
</code></pre></div></td></tr></table></div>
    <p>Clip using WGS84 coordinates when the raster is in a different CRS</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_wgs84.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">122.5</span><span class="p">,</span> <span class="mf">37.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.4</span><span class="p">,</span> <span class="mf">37.8</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">bbox_crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="go">&#39;clipped_wgs84.tif&#39;</span>
</code></pre></div></td></tr></table></div>
    <p>Clip using row/column indices</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_pixel.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">bbox_type</span><span class="o">=</span><span class="s2">&quot;pixel&quot;</span><span class="p">)</span>
<span class="go">&#39;clipped_pixel.tif&#39;</span>
</code></pre></div></td></tr></table></div>
    <p>Clip with band selection</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_bands.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="go">&#39;clipped_bands.tif&#39;</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clip_raster_by_bbox</span><span class="p">(</span>
    <span class="n">input_raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bbox_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geo&quot;</span><span class="p">,</span>
    <span class="n">bbox_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip a raster dataset using a bounding box and optionally select specific bands.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_raster (str): Path to the input raster file.</span>
<span class="sd">        output_raster (str): Path where the clipped raster will be saved.</span>
<span class="sd">        bbox (tuple): Bounding box coordinates either as:</span>
<span class="sd">                     - Geographic coordinates (minx, miny, maxx, maxy) if bbox_type=&quot;geo&quot;</span>
<span class="sd">                     - Pixel indices (min_row, min_col, max_row, max_col) if bbox_type=&quot;pixel&quot;</span>
<span class="sd">        bands (list, optional): List of band indices to keep (1-based indexing).</span>
<span class="sd">                               If None, all bands will be kept.</span>
<span class="sd">        bbox_type (str, optional): Type of bounding box coordinates. Either &quot;geo&quot; for</span>
<span class="sd">                                  geographic coordinates or &quot;pixel&quot; for row/column indices.</span>
<span class="sd">                                  Default is &quot;geo&quot;.</span>
<span class="sd">        bbox_crs (str or dict, optional): CRS of the bbox if different from the raster CRS.</span>
<span class="sd">                                         Can be provided as EPSG code (e.g., &quot;EPSG:4326&quot;) or</span>
<span class="sd">                                         as a proj4 string. Only applies when bbox_type=&quot;geo&quot;.</span>
<span class="sd">                                         If None, assumes bbox is in the same CRS as the raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the clipped output raster.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If required dependencies are not installed.</span>
<span class="sd">        ValueError: If the bbox is invalid, bands are out of range, or bbox_type is invalid.</span>
<span class="sd">        RuntimeError: If the clipping operation fails.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Clip using geographic coordinates in the same CRS as the raster</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_geo.tif&#39;, (100, 200, 300, 400))</span>
<span class="sd">        &#39;clipped_geo.tif&#39;</span>

<span class="sd">        Clip using WGS84 coordinates when the raster is in a different CRS</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_wgs84.tif&#39;, (-122.5, 37.7, -122.4, 37.8),</span>
<span class="sd">        ...                     bbox_crs=&quot;EPSG:4326&quot;)</span>
<span class="sd">        &#39;clipped_wgs84.tif&#39;</span>

<span class="sd">        Clip using row/column indices</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_pixel.tif&#39;, (50, 100, 150, 200),</span>
<span class="sd">        ...                     bbox_type=&quot;pixel&quot;)</span>
<span class="sd">        &#39;clipped_pixel.tif&#39;</span>

<span class="sd">        Clip with band selection</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_bands.tif&#39;, (100, 200, 300, 400),</span>
<span class="sd">        ...                     bands=[1, 3])</span>
<span class="sd">        &#39;clipped_bands.tif&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_bounds</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform_bounds</span>

    <span class="c1"># Validate bbox_type</span>
    <span class="k">if</span> <span class="n">bbox_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;geo&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bbox_type must be either &#39;geo&#39; or &#39;pixel&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Validate bbox</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bbox must contain exactly 4 values&quot;</span><span class="p">)</span>

    <span class="c1"># Open the source raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get the source CRS</span>
        <span class="n">src_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Handle different bbox types</span>
        <span class="k">if</span> <span class="n">bbox_type</span> <span class="o">==</span> <span class="s2">&quot;geo&quot;</span><span class="p">:</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span>

            <span class="c1"># Validate geographic bbox</span>
            <span class="k">if</span> <span class="n">minx</span> <span class="o">&gt;=</span> <span class="n">maxx</span> <span class="ow">or</span> <span class="n">miny</span> <span class="o">&gt;=</span> <span class="n">maxy</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid geographic bbox. Expected (minx, miny, maxx, maxy) where minx &lt; maxx and miny &lt; maxy&quot;</span>
                <span class="p">)</span>

            <span class="c1"># If bbox_crs is provided and different from the source CRS, transform the bbox</span>
            <span class="k">if</span> <span class="n">bbox_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bbox_crs</span> <span class="o">!=</span> <span class="n">src_crs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Transform bbox coordinates from bbox_crs to src_crs</span>
                    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">transform_bounds</span><span class="p">(</span>
                        <span class="n">bbox_crs</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to transform bbox from </span><span class="si">{</span><span class="n">bbox_crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">src_crs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Calculate the pixel window from geographic coordinates</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

            <span class="c1"># Use the same bounds for the output transform</span>
            <span class="n">output_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># bbox_type == &quot;pixel&quot;</span>
            <span class="n">min_row</span><span class="p">,</span> <span class="n">min_col</span><span class="p">,</span> <span class="n">max_row</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">=</span> <span class="n">bbox</span>

            <span class="c1"># Validate pixel bbox</span>
            <span class="k">if</span> <span class="n">min_row</span> <span class="o">&gt;=</span> <span class="n">max_row</span> <span class="ow">or</span> <span class="n">min_col</span> <span class="o">&gt;=</span> <span class="n">max_col</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid pixel bbox. Expected (min_row, min_col, max_row, max_col) where min_row &lt; max_row and min_col &lt; max_col&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">min_row</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">min_col</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">max_row</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
                <span class="ow">or</span> <span class="n">max_col</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Pixel indices out of bounds. Raster dimensions are </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> rows x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> columns&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create a window from pixel coordinates</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">min_col</span><span class="p">,</span> <span class="n">min_row</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">-</span> <span class="n">min_col</span><span class="p">,</span> <span class="n">max_row</span> <span class="o">-</span> <span class="n">min_row</span><span class="p">)</span>

            <span class="c1"># Calculate the geographic bounds for this window</span>
            <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">output_bounds</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">array_bounds</span><span class="p">(</span>
                <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">window_transform</span>
            <span class="p">)</span>
            <span class="c1"># Reorder to (minx, miny, maxx, maxy)</span>
            <span class="n">output_bounds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Get window dimensions</span>
        <span class="n">window_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">window_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

        <span class="c1"># Check if the window is valid</span>
        <span class="k">if</span> <span class="n">window_width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">window_height</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bounding box results in an empty window&quot;</span><span class="p">)</span>

        <span class="c1"># Handle band selection</span>
        <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use all bands</span>
            <span class="n">bands_to_read</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate band indices</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band indices must be between 1 and </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">bands_to_read</span> <span class="o">=</span> <span class="n">bands</span>

        <span class="c1"># Calculate new transform for the clipped raster</span>
        <span class="n">new_transform</span> <span class="o">=</span> <span class="n">from_bounds</span><span class="p">(</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">window_width</span><span class="p">,</span>
            <span class="n">window_height</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create a metadata dictionary for the output</span>
        <span class="n">out_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">window_height</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">window_width</span><span class="p">,</span>
                <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">new_transform</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands_to_read</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Read the data for the selected bands</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">band_idx</span> <span class="ow">in</span> <span class="n">bands_to_read</span><span class="p">:</span>
            <span class="n">band_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band_idx</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_data</span><span class="p">)</span>

        <span class="c1"># Stack the bands into a single array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">clipped_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clipped_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># Write the output raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clipped_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_raster</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.coords_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coords_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">coord_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.coords_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a list or array of coordinates to pixel coordinates, i.e., (col, row) coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2D or 3D array of coordinates. Can be of shape [[x1, y1], [x2, y2], ...]
    or [[[x1, y1]], [[x2, y2]], ...].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coord_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coordinate CRS of the input coordinates. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_out_of_bounds</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return out-of-bounds coordinates. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rasterio.transform.rowcol.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2D or 3D array of pixel coordinates in the same format as the input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8471</span>
<span class="normal">8472</span>
<span class="normal">8473</span>
<span class="normal">8474</span>
<span class="normal">8475</span>
<span class="normal">8476</span>
<span class="normal">8477</span>
<span class="normal">8478</span>
<span class="normal">8479</span>
<span class="normal">8480</span>
<span class="normal">8481</span>
<span class="normal">8482</span>
<span class="normal">8483</span>
<span class="normal">8484</span>
<span class="normal">8485</span>
<span class="normal">8486</span>
<span class="normal">8487</span>
<span class="normal">8488</span>
<span class="normal">8489</span>
<span class="normal">8490</span>
<span class="normal">8491</span>
<span class="normal">8492</span>
<span class="normal">8493</span>
<span class="normal">8494</span>
<span class="normal">8495</span>
<span class="normal">8496</span>
<span class="normal">8497</span>
<span class="normal">8498</span>
<span class="normal">8499</span>
<span class="normal">8500</span>
<span class="normal">8501</span>
<span class="normal">8502</span>
<span class="normal">8503</span>
<span class="normal">8504</span>
<span class="normal">8505</span>
<span class="normal">8506</span>
<span class="normal">8507</span>
<span class="normal">8508</span>
<span class="normal">8509</span>
<span class="normal">8510</span>
<span class="normal">8511</span>
<span class="normal">8512</span>
<span class="normal">8513</span>
<span class="normal">8514</span>
<span class="normal">8515</span>
<span class="normal">8516</span>
<span class="normal">8517</span>
<span class="normal">8518</span>
<span class="normal">8519</span>
<span class="normal">8520</span>
<span class="normal">8521</span>
<span class="normal">8522</span>
<span class="normal">8523</span>
<span class="normal">8524</span>
<span class="normal">8525</span>
<span class="normal">8526</span>
<span class="normal">8527</span>
<span class="normal">8528</span>
<span class="normal">8529</span>
<span class="normal">8530</span>
<span class="normal">8531</span>
<span class="normal">8532</span>
<span class="normal">8533</span>
<span class="normal">8534</span>
<span class="normal">8535</span>
<span class="normal">8536</span>
<span class="normal">8537</span>
<span class="normal">8538</span>
<span class="normal">8539</span>
<span class="normal">8540</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">coords_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">coord_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span>
    <span class="n">return_out_of_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a list or array of coordinates to pixel coordinates, i.e., (col, row) coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp: The source raster file path.</span>
<span class="sd">        coords: A 2D or 3D array of coordinates. Can be of shape [[x1, y1], [x2, y2], ...]</span>
<span class="sd">                or [[[x1, y1]], [[x2, y2]], ...].</span>
<span class="sd">        coord_crs: The coordinate CRS of the input coordinates. Defaults to &quot;epsg:4326&quot;.</span>
<span class="sd">        return_out_of_bounds: Whether to return out-of-bounds coordinates. Defaults to False.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rasterio.transform.rowcol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A 2D or 3D array of pixel coordinates in the same format as the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform</span> <span class="k">as</span> <span class="n">transform_coords</span>

    <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">input_is_3d</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Check if the input is a 3D array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">input_is_3d</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Flatten the 3D array to 2D if necessary</span>
    <span class="k">if</span> <span class="n">input_is_3d</span><span class="p">:</span>
        <span class="n">original_shape</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Store the original shape</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Flatten to 2D</span>

    <span class="c1"># Convert ndarray to a list if necessary</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="k">if</span> <span class="n">coord_crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">coord_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">)]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_of_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Convert the output back to the original shape if input was 3D</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_is_3d</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>

    <span class="c1"># Handle cases where no valid pixel coordinates are found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pixel coordinates found.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some coordinates are out of the image boundary.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_out_of_bounds</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">out_of_bounds</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.create_overview_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_overview_image</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">geojson_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.create_overview_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create an overview image showing all tiles and their status, with optional GeoJSON export.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src</code>
            </td>
            <td>
                  <code><span title="rasterio.io.DatasetReader">DatasetReader</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_coordinates</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries containing tile information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path where the overview image will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of each tile in pixels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stride between tiles in pixels. Controls overlap between adjacent tiles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>geojson_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, exports the tile rectangles as GeoJSON to this path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved overview image.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4874</span>
<span class="normal">4875</span>
<span class="normal">4876</span>
<span class="normal">4877</span>
<span class="normal">4878</span>
<span class="normal">4879</span>
<span class="normal">4880</span>
<span class="normal">4881</span>
<span class="normal">4882</span>
<span class="normal">4883</span>
<span class="normal">4884</span>
<span class="normal">4885</span>
<span class="normal">4886</span>
<span class="normal">4887</span>
<span class="normal">4888</span>
<span class="normal">4889</span>
<span class="normal">4890</span>
<span class="normal">4891</span>
<span class="normal">4892</span>
<span class="normal">4893</span>
<span class="normal">4894</span>
<span class="normal">4895</span>
<span class="normal">4896</span>
<span class="normal">4897</span>
<span class="normal">4898</span>
<span class="normal">4899</span>
<span class="normal">4900</span>
<span class="normal">4901</span>
<span class="normal">4902</span>
<span class="normal">4903</span>
<span class="normal">4904</span>
<span class="normal">4905</span>
<span class="normal">4906</span>
<span class="normal">4907</span>
<span class="normal">4908</span>
<span class="normal">4909</span>
<span class="normal">4910</span>
<span class="normal">4911</span>
<span class="normal">4912</span>
<span class="normal">4913</span>
<span class="normal">4914</span>
<span class="normal">4915</span>
<span class="normal">4916</span>
<span class="normal">4917</span>
<span class="normal">4918</span>
<span class="normal">4919</span>
<span class="normal">4920</span>
<span class="normal">4921</span>
<span class="normal">4922</span>
<span class="normal">4923</span>
<span class="normal">4924</span>
<span class="normal">4925</span>
<span class="normal">4926</span>
<span class="normal">4927</span>
<span class="normal">4928</span>
<span class="normal">4929</span>
<span class="normal">4930</span>
<span class="normal">4931</span>
<span class="normal">4932</span>
<span class="normal">4933</span>
<span class="normal">4934</span>
<span class="normal">4935</span>
<span class="normal">4936</span>
<span class="normal">4937</span>
<span class="normal">4938</span>
<span class="normal">4939</span>
<span class="normal">4940</span>
<span class="normal">4941</span>
<span class="normal">4942</span>
<span class="normal">4943</span>
<span class="normal">4944</span>
<span class="normal">4945</span>
<span class="normal">4946</span>
<span class="normal">4947</span>
<span class="normal">4948</span>
<span class="normal">4949</span>
<span class="normal">4950</span>
<span class="normal">4951</span>
<span class="normal">4952</span>
<span class="normal">4953</span>
<span class="normal">4954</span>
<span class="normal">4955</span>
<span class="normal">4956</span>
<span class="normal">4957</span>
<span class="normal">4958</span>
<span class="normal">4959</span>
<span class="normal">4960</span>
<span class="normal">4961</span>
<span class="normal">4962</span>
<span class="normal">4963</span>
<span class="normal">4964</span>
<span class="normal">4965</span>
<span class="normal">4966</span>
<span class="normal">4967</span>
<span class="normal">4968</span>
<span class="normal">4969</span>
<span class="normal">4970</span>
<span class="normal">4971</span>
<span class="normal">4972</span>
<span class="normal">4973</span>
<span class="normal">4974</span>
<span class="normal">4975</span>
<span class="normal">4976</span>
<span class="normal">4977</span>
<span class="normal">4978</span>
<span class="normal">4979</span>
<span class="normal">4980</span>
<span class="normal">4981</span>
<span class="normal">4982</span>
<span class="normal">4983</span>
<span class="normal">4984</span>
<span class="normal">4985</span>
<span class="normal">4986</span>
<span class="normal">4987</span>
<span class="normal">4988</span>
<span class="normal">4989</span>
<span class="normal">4990</span>
<span class="normal">4991</span>
<span class="normal">4992</span>
<span class="normal">4993</span>
<span class="normal">4994</span>
<span class="normal">4995</span>
<span class="normal">4996</span>
<span class="normal">4997</span>
<span class="normal">4998</span>
<span class="normal">4999</span>
<span class="normal">5000</span>
<span class="normal">5001</span>
<span class="normal">5002</span>
<span class="normal">5003</span>
<span class="normal">5004</span>
<span class="normal">5005</span>
<span class="normal">5006</span>
<span class="normal">5007</span>
<span class="normal">5008</span>
<span class="normal">5009</span>
<span class="normal">5010</span>
<span class="normal">5011</span>
<span class="normal">5012</span>
<span class="normal">5013</span>
<span class="normal">5014</span>
<span class="normal">5015</span>
<span class="normal">5016</span>
<span class="normal">5017</span>
<span class="normal">5018</span>
<span class="normal">5019</span>
<span class="normal">5020</span>
<span class="normal">5021</span>
<span class="normal">5022</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_overview_image</span><span class="p">(</span>
    <span class="n">src</span><span class="p">,</span> <span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">geojson_path</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an overview image showing all tiles and their status, with optional GeoJSON export.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (rasterio.io.DatasetReader): The source raster dataset.</span>
<span class="sd">        tile_coordinates (list): A list of dictionaries containing tile information.</span>
<span class="sd">        output_path (str): The path where the overview image will be saved.</span>
<span class="sd">        tile_size (int): The size of each tile in pixels.</span>
<span class="sd">        stride (int): The stride between tiles in pixels. Controls overlap between adjacent tiles.</span>
<span class="sd">        geojson_path (str, optional): If provided, exports the tile rectangles as GeoJSON to this path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved overview image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read a reduced version of the source image</span>
    <span class="n">overview_scale</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># Scale to max ~2000px</span>
    <span class="n">overview_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="n">overview_scale</span>
    <span class="n">overview_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="n">overview_scale</span>

    <span class="c1"># Read downsampled image</span>
    <span class="n">overview_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">overview_height</span><span class="p">,</span> <span class="n">overview_width</span><span class="p">),</span>
        <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">average</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create RGB image for display</span>
    <span class="k">if</span> <span class="n">overview_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">overview_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For single band, create grayscale RGB</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">overview_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">overview_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">overview_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Normalize for display</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">non_zero</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="n">band</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p2</span><span class="p">,</span> <span class="n">p98</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">))</span>
            <span class="n">rgb</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">band</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p98</span> <span class="o">-</span> <span class="n">p2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>

    <span class="c1"># If GeoJSON export is requested, prepare GeoJSON structures</span>
    <span class="k">if</span> <span class="n">geojson_path</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Draw tile boundaries</span>
    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tile_coordinates</span><span class="p">:</span>
        <span class="c1"># Convert bounds to pixel coordinates in overview</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="c1"># Calculate scaled pixel coordinates</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_size</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_size</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>

        <span class="c1"># Draw rectangle</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lime&quot;</span> <span class="k">if</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;has_features&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

        <span class="c1"># Add tile number if not too crowded</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x_min</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">y_min</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Add to GeoJSON features if exporting</span>
        <span class="k">if</span> <span class="n">geojson_path</span><span class="p">:</span>
            <span class="c1"># Create a polygon from the bounds (already in geo-coordinates)</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

            <span class="c1"># Calculate overlap with neighboring tiles</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">stride</span> <span class="o">&lt;</span> <span class="n">tile_size</span><span class="p">:</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="n">tile_size</span> <span class="o">-</span> <span class="n">stride</span>

            <span class="c1"># Create a GeoJSON feature</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">polygon</span><span class="p">),</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;has_features&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;has_features&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;bounds_pixel&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;tile_size_px&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                    <span class="s2">&quot;stride_px&quot;</span><span class="p">:</span> <span class="n">stride</span><span class="p">,</span>
                    <span class="s2">&quot;overlap_px&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># Add any additional properties from the tile</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tile</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;has_features&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">]:</span>
                    <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tile Overview (Green = Contains Features, Red = Empty)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overview image saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Export GeoJSON if requested</span>
    <span class="k">if</span> <span class="n">geojson_path</span><span class="p">:</span>
        <span class="n">geojson_collection</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s2">&quot;to_string&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
                <span class="s2">&quot;source_raster_dimensions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Save to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">geojson_collection</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GeoJSON saved to </span><span class="si">{</span><span class="n">geojson_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.create_split_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_split_map</span><span class="p">(</span><span class="n">left_layer</span><span class="o">=</span><span class="s1">&#39;TERRAIN&#39;</span><span class="p">,</span> <span class="n">right_layer</span><span class="o">=</span><span class="s1">&#39;OpenTopoMap&#39;</span><span class="p">,</span> <span class="n">left_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_array_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_array_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fullscreen_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_close_button</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_position</span><span class="o">=</span><span class="s1">&#39;bottomleft&#39;</span><span class="p">,</span> <span class="n">right_position</span><span class="o">=</span><span class="s1">&#39;bottomright&#39;</span><span class="p">,</span> <span class="n">widget_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draggable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;600px&#39;</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basemap_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.create_split_map" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Adds split map.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left_layer</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The left tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to 'TERRAIN'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;TERRAIN&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_layer</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The right tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to 'OpenTopoMap'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;OpenTopoMap&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for the left tile layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for the right tile layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_array_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for array_to_image for the left layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_array_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for array_to_image for the right layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zoom_control</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add zoom control. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fullscreen_control</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add fullscreen control. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_control</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add layer control. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_close_button</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a close button. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label for the left layer. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label for the right layer. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position for the left label. Defaults to "bottomleft".</p>
              </div>
            </td>
            <td>
                  <code>&#39;bottomleft&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position for the right label. Defaults to "bottomright".</p>
              </div>
            </td>
            <td>
                  <code>&#39;bottomright&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>widget_layout</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The layout for the widget. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>draggable</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the split map is draggable. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_split_map</span><span class="p">(</span>
    <span class="n">left_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TERRAIN&quot;</span><span class="p">,</span>
    <span class="n">right_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OpenTopoMap&quot;</span><span class="p">,</span>
    <span class="n">left_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">left_array_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right_array_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">fullscreen_control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">layer_control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_close_button</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">left_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">left_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bottomleft&quot;</span><span class="p">,</span>
    <span class="n">right_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bottomright&quot;</span><span class="p">,</span>
    <span class="n">widget_layout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">draggable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">center</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">zoom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;600px&quot;</span><span class="p">,</span>
    <span class="n">basemap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">basemap_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds split map.</span>

<span class="sd">    Args:</span>
<span class="sd">        left_layer (str, optional): The left tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to &#39;TERRAIN&#39;.</span>
<span class="sd">        right_layer (str, optional): The right tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to &#39;OpenTopoMap&#39;.</span>
<span class="sd">        left_args (dict, optional): The arguments for the left tile layer. Defaults to {}.</span>
<span class="sd">        right_args (dict, optional): The arguments for the right tile layer. Defaults to {}.</span>
<span class="sd">        left_array_args (dict, optional): The arguments for array_to_image for the left layer. Defaults to {}.</span>
<span class="sd">        right_array_args (dict, optional): The arguments for array_to_image for the right layer. Defaults to {}.</span>
<span class="sd">        zoom_control (bool, optional): Whether to add zoom control. Defaults to True.</span>
<span class="sd">        fullscreen_control (bool, optional): Whether to add fullscreen control. Defaults to True.</span>
<span class="sd">        layer_control (bool, optional): Whether to add layer control. Defaults to True.</span>
<span class="sd">        add_close_button (bool, optional): Whether to add a close button. Defaults to False.</span>
<span class="sd">        left_label (str, optional): The label for the left layer. Defaults to None.</span>
<span class="sd">        right_label (str, optional): The label for the right layer. Defaults to None.</span>
<span class="sd">        left_position (str, optional): The position for the left label. Defaults to &quot;bottomleft&quot;.</span>
<span class="sd">        right_position (str, optional): The position for the right label. Defaults to &quot;bottomright&quot;.</span>
<span class="sd">        widget_layout (dict, optional): The layout for the widget. Defaults to None.</span>
<span class="sd">        draggable (bool, optional): Whether the split map is draggable. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">left_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">right_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">right_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">left_array_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_array_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">right_array_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">right_array_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">basemap_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basemap_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">clear_layers</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_cog_layer</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Basemap&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;Basemap&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">basemap</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">split_map</span><span class="p">(</span>
        <span class="n">left_layer</span><span class="o">=</span><span class="n">left_layer</span><span class="p">,</span>
        <span class="n">right_layer</span><span class="o">=</span><span class="n">right_layer</span><span class="p">,</span>
        <span class="n">left_args</span><span class="o">=</span><span class="n">left_args</span><span class="p">,</span>
        <span class="n">right_args</span><span class="o">=</span><span class="n">right_args</span><span class="p">,</span>
        <span class="n">left_array_args</span><span class="o">=</span><span class="n">left_array_args</span><span class="p">,</span>
        <span class="n">right_array_args</span><span class="o">=</span><span class="n">right_array_args</span><span class="p">,</span>
        <span class="n">zoom_control</span><span class="o">=</span><span class="n">zoom_control</span><span class="p">,</span>
        <span class="n">fullscreen_control</span><span class="o">=</span><span class="n">fullscreen_control</span><span class="p">,</span>
        <span class="n">layer_control</span><span class="o">=</span><span class="n">layer_control</span><span class="p">,</span>
        <span class="n">add_close_button</span><span class="o">=</span><span class="n">add_close_button</span><span class="p">,</span>
        <span class="n">left_label</span><span class="o">=</span><span class="n">left_label</span><span class="p">,</span>
        <span class="n">right_label</span><span class="o">=</span><span class="n">right_label</span><span class="p">,</span>
        <span class="n">left_position</span><span class="o">=</span><span class="n">left_position</span><span class="p">,</span>
        <span class="n">right_position</span><span class="o">=</span><span class="n">right_position</span><span class="p">,</span>
        <span class="n">widget_layout</span><span class="o">=</span><span class="n">widget_layout</span><span class="p">,</span>
        <span class="n">draggable</span><span class="o">=</span><span class="n">draggable</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.create_vector_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_vector_data</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">,</span> <span class="n">column_widths</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">map_height</span><span class="o">=</span><span class="s1">&#39;600px&#39;</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="s1">&#39;geojson&#39;</span><span class="p">,</span> <span class="n">add_mapillary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">5e-05</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">420</span><span class="p">,</span> <span class="n">frame_border</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.create_vector_data" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates a widget-based interface for creating and managing vector data on a map.</p>
<p>This function creates an interactive widget interface that allows users to draw features
(points, lines, polygons) on a map, assign properties to these features, and export them
as GeoJSON files. The interface includes a map, a sidebar for property management, and
buttons for saving, exporting, and resetting the data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>m</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Map (geoai.geoai.Map)" href="#geoai.geoai.Map">Map</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An existing Map object. If not provided, a default map with
basemaps and drawing controls will be created. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>properties</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Dict">Dict</span>[<span title="str">str</span>, <span title="geoai.utils.List">List</span>[<span title="geoai.utils.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are property names
and values are lists of possible values for each property. These properties can be
assigned to the drawn features. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The format string for the timestamp used in the exported
filename. Defaults to "%Y%m%dT%H%M%S".</p>
              </div>
            </td>
            <td>
                  <code>&#39;%Y%m%dT%H%M%S&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column_widths</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Optional">Optional</span>[<span title="geoai.utils.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of two integers specifying the
relative widths of the map and sidebar columns. Defaults to (9, 3).</p>
              </div>
            </td>
            <td>
                  <code>(9, 3)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>map_height</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The height of the map widget. Defaults to "600px".</p>
              </div>
            </td>
            <td>
                  <code>&#39;600px&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory where the exported GeoJSON files will be saved.
If not provided, the current working directory is used. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename_prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A prefix to be added to the exported filename.
Defaults to "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_ext</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file extension for the exported file. Defaults to "geojson".</p>
              </div>
            </td>
            <td>
                  <code>&#39;geojson&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_mapillary</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a Mapillary image widget that displays the
nearest image to the clicked point on the map. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>style</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The style of the Mapillary image widget. Can be "classic", "photo",
or "split". Defaults to "photo".</p>
              </div>
            </td>
            <td>
                  <code>&#39;photo&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The radius (in degrees) used to search for the nearest Mapillary
image. Defaults to 0.00005 degrees.</p>
              </div>
            </td>
            <td>
                  <code>5e-05</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of the Mapillary image widget. Defaults to 300.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The height of the Mapillary image widget. Defaults to 420.</p>
              </div>
            </td>
            <td>
                  <code>420</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_border</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of the frame border for the Mapillary image widget.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that may be passed to the function.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geoai.utils.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>widgets.VBox: A vertical box widget containing the map, sidebar, and control buttons.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>properties = {
...     "Type": ["Residential", "Commercial", "Industrial"],
...     "Area": [100, 200, 300],
... }
widget = create_vector_data(properties=properties)
display(widget)  # Display the widget in a Jupyter notebook</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>geoai/geoai.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_vector_data</span><span class="p">(</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LeafMap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">,</span>
    <span class="n">column_widths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">map_height</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;600px&quot;</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filename_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">file_ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
    <span class="n">add_mapillary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;photo&quot;</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00005</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">420</span><span class="p">,</span>
    <span class="n">frame_border</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates a widget-based interface for creating and managing vector data on a map.</span>

<span class="sd">    This function creates an interactive widget interface that allows users to draw features</span>
<span class="sd">    (points, lines, polygons) on a map, assign properties to these features, and export them</span>
<span class="sd">    as GeoJSON files. The interface includes a map, a sidebar for property management, and</span>
<span class="sd">    buttons for saving, exporting, and resetting the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        m (Map, optional): An existing Map object. If not provided, a default map with</span>
<span class="sd">            basemaps and drawing controls will be created. Defaults to None.</span>
<span class="sd">        properties (Dict[str, List[Any]], optional): A dictionary where keys are property names</span>
<span class="sd">            and values are lists of possible values for each property. These properties can be</span>
<span class="sd">            assigned to the drawn features. Defaults to None.</span>
<span class="sd">        time_format (str, optional): The format string for the timestamp used in the exported</span>
<span class="sd">            filename. Defaults to &quot;%Y%m%dT%H%M%S&quot;.</span>
<span class="sd">        column_widths (Optional[List[int]], optional): A list of two integers specifying the</span>
<span class="sd">            relative widths of the map and sidebar columns. Defaults to (9, 3).</span>
<span class="sd">        map_height (str, optional): The height of the map widget. Defaults to &quot;600px&quot;.</span>
<span class="sd">        out_dir (str, optional): The directory where the exported GeoJSON files will be saved.</span>
<span class="sd">            If not provided, the current working directory is used. Defaults to None.</span>
<span class="sd">        filename_prefix (str, optional): A prefix to be added to the exported filename.</span>
<span class="sd">            Defaults to &quot;&quot;.</span>
<span class="sd">        file_ext (str, optional): The file extension for the exported file. Defaults to &quot;geojson&quot;.</span>
<span class="sd">        add_mapillary (bool, optional): Whether to add a Mapillary image widget that displays the</span>
<span class="sd">            nearest image to the clicked point on the map. Defaults to False.</span>
<span class="sd">        style (str, optional): The style of the Mapillary image widget. Can be &quot;classic&quot;, &quot;photo&quot;,</span>
<span class="sd">            or &quot;split&quot;. Defaults to &quot;photo&quot;.</span>
<span class="sd">        radius (float, optional): The radius (in degrees) used to search for the nearest Mapillary</span>
<span class="sd">            image. Defaults to 0.00005 degrees.</span>
<span class="sd">        width (int, optional): The width of the Mapillary image widget. Defaults to 300.</span>
<span class="sd">        height (int, optional): The height of the Mapillary image widget. Defaults to 420.</span>
<span class="sd">        frame_border (int, optional): The width of the frame border for the Mapillary image widget.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments that may be passed to the function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        widgets.VBox: A vertical box widget containing the map, sidebar, and control buttons.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; properties = {</span>
<span class="sd">        ...     &quot;Type&quot;: [&quot;Residential&quot;, &quot;Commercial&quot;, &quot;Industrial&quot;],</span>
<span class="sd">        ...     &quot;Area&quot;: [100, 200, 300],</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; widget = create_vector_data(properties=properties)</span>
<span class="sd">        &gt;&gt;&gt; display(widget)  # Display the widget in a Jupyter notebook</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">maplibregl</span><span class="o">.</span><span class="n">create_vector_data</span><span class="p">(</span>
        <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">time_format</span><span class="o">=</span><span class="n">time_format</span><span class="p">,</span>
        <span class="n">column_widths</span><span class="o">=</span><span class="n">column_widths</span><span class="p">,</span>
        <span class="n">map_height</span><span class="o">=</span><span class="n">map_height</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
        <span class="n">filename_prefix</span><span class="o">=</span><span class="n">filename_prefix</span><span class="p">,</span>
        <span class="n">file_ext</span><span class="o">=</span><span class="n">file_ext</span><span class="p">,</span>
        <span class="n">add_mapillary</span><span class="o">=</span><span class="n">add_mapillary</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">frame_border</span><span class="o">=</span><span class="n">frame_border</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.dict_to_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dict_to_image</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.dict_to_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a dictionary containing spatial data to a rasterio dataset or save it to
a file. The dictionary should contain the following keys: "crs", "bounds", and "image".
It can be generated from a TorchGeo dataset sampler.</p>
<p>This function transforms a dictionary with CRS, bounding box, and image data
into a rasterio DatasetReader using leafmap's array_to_image utility after
first converting to a rioxarray DataArray.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing:
- 'crs': A pyproj CRS object
- 'bounds': A BoundingBox object with minx, maxx, miny, maxy attributes
  and optionally mint, maxt for temporal bounds
- 'image': A tensor or array-like object with image data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to save the image to a file. If not provided, the image
will be returned as a rasterio DatasetReader object.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to leafmap.array_to_image.
Common options include:
- colormap: str, name of the colormap (e.g., 'viridis', 'terrain')
- vmin: float, minimum value for colormap scaling
- vmax: float, maximum value for colormap scaling</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A rasterio DatasetReader object that can be used for visualization or</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>further processing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">image</span> <span class="o">=</span> <span class="n">dict_to_image</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="mi">26911</span><span class="p">),</span> <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dict_to_image</span><span class="p">(</span>
    <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dictionary containing spatial data to a rasterio dataset or save it to</span>
<span class="sd">    a file. The dictionary should contain the following keys: &quot;crs&quot;, &quot;bounds&quot;, and &quot;image&quot;.</span>
<span class="sd">    It can be generated from a TorchGeo dataset sampler.</span>

<span class="sd">    This function transforms a dictionary with CRS, bounding box, and image data</span>
<span class="sd">    into a rasterio DatasetReader using leafmap&#39;s array_to_image utility after</span>
<span class="sd">    first converting to a rioxarray DataArray.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict: A dictionary containing:</span>
<span class="sd">            - &#39;crs&#39;: A pyproj CRS object</span>
<span class="sd">            - &#39;bounds&#39;: A BoundingBox object with minx, maxx, miny, maxy attributes</span>
<span class="sd">              and optionally mint, maxt for temporal bounds</span>
<span class="sd">            - &#39;image&#39;: A tensor or array-like object with image data</span>
<span class="sd">        output: Optional path to save the image to a file. If not provided, the image</span>
<span class="sd">            will be returned as a rasterio DatasetReader object.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to leafmap.array_to_image.</span>
<span class="sd">            Common options include:</span>
<span class="sd">            - colormap: str, name of the colormap (e.g., &#39;viridis&#39;, &#39;terrain&#39;)</span>
<span class="sd">            - vmin: float, minimum value for colormap scaling</span>
<span class="sd">            - vmax: float, maximum value for colormap scaling</span>

<span class="sd">    Returns:</span>
<span class="sd">        A rasterio DatasetReader object that can be used for visualization or</span>
<span class="sd">        further processing.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; image = dict_to_image(</span>
<span class="sd">        ...     {&#39;crs&#39;: CRS.from_epsg(26911), &#39;bounds&#39;: bbox, &#39;image&#39;: tensor},</span>
<span class="sd">        ...     colormap=&#39;terrain&#39;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; fig, ax = plt.subplots(figsize=(10, 10))</span>
<span class="sd">        &gt;&gt;&gt; show(image, ax=ax)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">dict_to_rioxarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.dict_to_rioxarray" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dict_to_rioxarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></code>

<a href="#geoai.geoai.dict_to_rioxarray" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a dictionary to a xarray DataArray. The dictionary should contain the
following keys: "crs", "bounds", and "image". It can be generated from a TorchGeo
dataset sampler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary containing the data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataArray">DataArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>xr.DataArray: The xarray DataArray.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dict_to_rioxarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dictionary to a xarray DataArray. The dictionary should contain the</span>
<span class="sd">    following keys: &quot;crs&quot;, &quot;bounds&quot;, and &quot;image&quot;. It can be generated from a TorchGeo</span>
<span class="sd">    dataset sampler.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (Dict): The dictionary containing the data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xr.DataArray: The xarray DataArray.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">affine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine</span>

    <span class="n">BoundingBox</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;BoundingBox&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;minx&quot;</span><span class="p">,</span> <span class="s2">&quot;maxx&quot;</span><span class="p">,</span> <span class="s2">&quot;miny&quot;</span><span class="p">,</span> <span class="s2">&quot;maxy&quot;</span><span class="p">])</span>

    <span class="c1"># Extract components from the dictionary</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">):</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>

    <span class="c1"># Convert tensor to numpy array if needed</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
        <span class="c1"># For PyTorch tensors</span>
        <span class="n">image_array</span> <span class="o">=</span> <span class="n">image_tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If it&#39;s already a numpy array or similar</span>
        <span class="n">image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">)</span>

    <span class="c1"># Calculate pixel resolution</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Width is the size of the last dimension</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Height is the size of the middle dimension</span>

    <span class="n">res_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
    <span class="n">res_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>

    <span class="c1"># Create the transform matrix</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span><span class="n">res_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">res_y</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span><span class="p">)</span>

    <span class="c1"># Create dimensions</span>
    <span class="n">x_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">minx</span> <span class="o">+</span> <span class="n">res_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">res_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">res_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span> <span class="o">+</span> <span class="n">res_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

    <span class="c1"># If time dimension exists in the bounds</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;mint&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;maxt&quot;</span><span class="p">):</span>
        <span class="c1"># Create a single time value or range if needed</span>
        <span class="n">t_coords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">bounds</span><span class="o">.</span><span class="n">mint</span>
        <span class="p">]</span>  <span class="c1"># Or np.linspace(bounds.mint, bounds.maxt, num_time_steps)</span>

        <span class="c1"># Create DataArray with time dimension</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span>
            <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;band&quot;</span><span class="p">:</span>
            <span class="c1"># For multi-band single time</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">image_array</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For multi-time multi-band</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">image_array</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">t_coords</span><span class="p">,</span>
                    <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create DataArray without time dimension</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">image_array</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="c1"># Set spatial attributes</span>
    <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_transform</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">da</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.display_image_with_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">display_image_with_vector</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">vector_path</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">vector_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">vector_linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vector_facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.display_image_with_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Display a raster image alongside the same image with vector overlay.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to raster image file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file (GeoJSON, Shapefile, etc.)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height) in inches (default: (16, 8))</p>
              </div>
            </td>
            <td>
                  <code>(16, 8)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Edge color for vector features (default: 'red')</p>
              </div>
            </td>
            <td>
                  <code>&#39;red&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector_linewidth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line width for vector features (default: 1)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector_facecolor</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill color for vector features (default: 'none')</p>
              </div>
            </td>
            <td>
                  <code>&#39;none&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, save figure to this path instead of displaying</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(fig, axes, info_dict) where info_dict contains image and vector metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>fig, axes, info = display_image_with_vector(
...     'image.tif',
...     'buildings.geojson',
...     vector_color='blue'
... )
print(f"Number of features: {info['num_features']}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4783</span>
<span class="normal">4784</span>
<span class="normal">4785</span>
<span class="normal">4786</span>
<span class="normal">4787</span>
<span class="normal">4788</span>
<span class="normal">4789</span>
<span class="normal">4790</span>
<span class="normal">4791</span>
<span class="normal">4792</span>
<span class="normal">4793</span>
<span class="normal">4794</span>
<span class="normal">4795</span>
<span class="normal">4796</span>
<span class="normal">4797</span>
<span class="normal">4798</span>
<span class="normal">4799</span>
<span class="normal">4800</span>
<span class="normal">4801</span>
<span class="normal">4802</span>
<span class="normal">4803</span>
<span class="normal">4804</span>
<span class="normal">4805</span>
<span class="normal">4806</span>
<span class="normal">4807</span>
<span class="normal">4808</span>
<span class="normal">4809</span>
<span class="normal">4810</span>
<span class="normal">4811</span>
<span class="normal">4812</span>
<span class="normal">4813</span>
<span class="normal">4814</span>
<span class="normal">4815</span>
<span class="normal">4816</span>
<span class="normal">4817</span>
<span class="normal">4818</span>
<span class="normal">4819</span>
<span class="normal">4820</span>
<span class="normal">4821</span>
<span class="normal">4822</span>
<span class="normal">4823</span>
<span class="normal">4824</span>
<span class="normal">4825</span>
<span class="normal">4826</span>
<span class="normal">4827</span>
<span class="normal">4828</span>
<span class="normal">4829</span>
<span class="normal">4830</span>
<span class="normal">4831</span>
<span class="normal">4832</span>
<span class="normal">4833</span>
<span class="normal">4834</span>
<span class="normal">4835</span>
<span class="normal">4836</span>
<span class="normal">4837</span>
<span class="normal">4838</span>
<span class="normal">4839</span>
<span class="normal">4840</span>
<span class="normal">4841</span>
<span class="normal">4842</span>
<span class="normal">4843</span>
<span class="normal">4844</span>
<span class="normal">4845</span>
<span class="normal">4846</span>
<span class="normal">4847</span>
<span class="normal">4848</span>
<span class="normal">4849</span>
<span class="normal">4850</span>
<span class="normal">4851</span>
<span class="normal">4852</span>
<span class="normal">4853</span>
<span class="normal">4854</span>
<span class="normal">4855</span>
<span class="normal">4856</span>
<span class="normal">4857</span>
<span class="normal">4858</span>
<span class="normal">4859</span>
<span class="normal">4860</span>
<span class="normal">4861</span>
<span class="normal">4862</span>
<span class="normal">4863</span>
<span class="normal">4864</span>
<span class="normal">4865</span>
<span class="normal">4866</span>
<span class="normal">4867</span>
<span class="normal">4868</span>
<span class="normal">4869</span>
<span class="normal">4870</span>
<span class="normal">4871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">display_image_with_vector</span><span class="p">(</span>
    <span class="n">image_path</span><span class="p">,</span>
    <span class="n">vector_path</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">vector_color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">vector_linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vector_facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a raster image alongside the same image with vector overlay.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_path (str): Path to raster image file</span>
<span class="sd">        vector_path (str): Path to vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">        figsize (tuple): Figure size as (width, height) in inches (default: (16, 8))</span>
<span class="sd">        vector_color (str): Edge color for vector features (default: &#39;red&#39;)</span>
<span class="sd">        vector_linewidth (float): Line width for vector features (default: 1)</span>
<span class="sd">        vector_facecolor (str): Fill color for vector features (default: &#39;none&#39;)</span>
<span class="sd">        save_path (str, optional): If provided, save figure to this path instead of displaying</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (fig, axes, info_dict) where info_dict contains image and vector metadata</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; fig, axes, info = display_image_with_vector(</span>
<span class="sd">        ...     &#39;image.tif&#39;,</span>
<span class="sd">        ...     &#39;buildings.geojson&#39;,</span>
<span class="sd">        ...     vector_color=&#39;blue&#39;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Number of features: {info[&#39;num_features&#39;]}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file not found: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vector_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector file not found: </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Load and display image</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Plot image only</span>
        <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>

        <span class="c1"># Load vector data</span>
        <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Reproject to image CRS if needed</span>
        <span class="k">if</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="n">vector_data</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Plot image with vector overlay</span>
        <span class="n">show</span><span class="p">(</span>
            <span class="n">src</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Image with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> Vector Features&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">vector_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="n">vector_facecolor</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">vector_color</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">vector_linewidth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Collect metadata</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;image_shape&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;image_crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="s2">&quot;image_bounds&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="s2">&quot;num_features&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector_data</span><span class="p">),</span>
            <span class="s2">&quot;vector_crs&quot;</span><span class="p">:</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="s2">&quot;vector_bounds&quot;</span><span class="p">:</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save or show</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.display_training_tiles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">display_training_tiles</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">num_tiles</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.display_training_tiles" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Display image and mask tile pairs from training data output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output directory containing 'images' and 'masks' subdirectories</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_tiles</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tile pairs to display (default: 6)</p>
              </div>
            </td>
            <td>
                  <code>6</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height) in inches (default: (18, 6))</p>
              </div>
            </td>
            <td>
                  <code>(18, 6)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap for mask display (default: 'gray')</p>
              </div>
            </td>
            <td>
                  <code>&#39;gray&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, save figure to this path instead of displaying</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(fig, axes) matplotlib figure and axes objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>fig, axes = display_training_tiles('output/tiles', num_tiles=6)</p>
<h3 id="geoai.geoai.display_training_tiles--or-save-to-file">Or save to file<a class="headerlink" href="#geoai.geoai.display_training_tiles--or-save-to-file" title="Permanent link">&para;</a></h3>
<p>display_training_tiles('output/tiles', num_tiles=4, save_path='tiles_preview.png')</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4701</span>
<span class="normal">4702</span>
<span class="normal">4703</span>
<span class="normal">4704</span>
<span class="normal">4705</span>
<span class="normal">4706</span>
<span class="normal">4707</span>
<span class="normal">4708</span>
<span class="normal">4709</span>
<span class="normal">4710</span>
<span class="normal">4711</span>
<span class="normal">4712</span>
<span class="normal">4713</span>
<span class="normal">4714</span>
<span class="normal">4715</span>
<span class="normal">4716</span>
<span class="normal">4717</span>
<span class="normal">4718</span>
<span class="normal">4719</span>
<span class="normal">4720</span>
<span class="normal">4721</span>
<span class="normal">4722</span>
<span class="normal">4723</span>
<span class="normal">4724</span>
<span class="normal">4725</span>
<span class="normal">4726</span>
<span class="normal">4727</span>
<span class="normal">4728</span>
<span class="normal">4729</span>
<span class="normal">4730</span>
<span class="normal">4731</span>
<span class="normal">4732</span>
<span class="normal">4733</span>
<span class="normal">4734</span>
<span class="normal">4735</span>
<span class="normal">4736</span>
<span class="normal">4737</span>
<span class="normal">4738</span>
<span class="normal">4739</span>
<span class="normal">4740</span>
<span class="normal">4741</span>
<span class="normal">4742</span>
<span class="normal">4743</span>
<span class="normal">4744</span>
<span class="normal">4745</span>
<span class="normal">4746</span>
<span class="normal">4747</span>
<span class="normal">4748</span>
<span class="normal">4749</span>
<span class="normal">4750</span>
<span class="normal">4751</span>
<span class="normal">4752</span>
<span class="normal">4753</span>
<span class="normal">4754</span>
<span class="normal">4755</span>
<span class="normal">4756</span>
<span class="normal">4757</span>
<span class="normal">4758</span>
<span class="normal">4759</span>
<span class="normal">4760</span>
<span class="normal">4761</span>
<span class="normal">4762</span>
<span class="normal">4763</span>
<span class="normal">4764</span>
<span class="normal">4765</span>
<span class="normal">4766</span>
<span class="normal">4767</span>
<span class="normal">4768</span>
<span class="normal">4769</span>
<span class="normal">4770</span>
<span class="normal">4771</span>
<span class="normal">4772</span>
<span class="normal">4773</span>
<span class="normal">4774</span>
<span class="normal">4775</span>
<span class="normal">4776</span>
<span class="normal">4777</span>
<span class="normal">4778</span>
<span class="normal">4779</span>
<span class="normal">4780</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">display_training_tiles</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">num_tiles</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display image and mask tile pairs from training data output.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir (str): Path to output directory containing &#39;images&#39; and &#39;masks&#39; subdirectories</span>
<span class="sd">        num_tiles (int): Number of tile pairs to display (default: 6)</span>
<span class="sd">        figsize (tuple): Figure size as (width, height) in inches (default: (18, 6))</span>
<span class="sd">        cmap (str): Colormap for mask display (default: &#39;gray&#39;)</span>
<span class="sd">        save_path (str, optional): If provided, save figure to this path instead of displaying</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (fig, axes) matplotlib figure and axes objects</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; fig, axes = display_training_tiles(&#39;output/tiles&#39;, num_tiles=6)</span>
<span class="sd">        &gt;&gt;&gt; # Or save to file</span>
<span class="sd">        &gt;&gt;&gt; display_training_tiles(&#39;output/tiles&#39;, num_tiles=4, save_path=&#39;tiles_preview.png&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

    <span class="c1"># Get list of image tiles</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">images_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Images directory not found: </span><span class="si">{</span><span class="n">images_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">image_tiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">images_dir</span><span class="p">))[:</span><span class="n">num_tiles</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_tiles</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No image tiles found in </span><span class="si">{</span><span class="n">images_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Limit to available tiles</span>
    <span class="n">num_tiles</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_tiles</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_tiles</span><span class="p">))</span>

    <span class="c1"># Create figure with subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_tiles</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Handle case where num_tiles is 1</span>
    <span class="k">if</span> <span class="n">num_tiles</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tile_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_tiles</span><span class="p">):</span>
        <span class="c1"># Load and display image tile</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="n">tile_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load and display mask tile</span>
        <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="n">tile_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.5</span><span class="p">,</span>
                <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;Mask not found&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save or show</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.download_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.geoai.download_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Download a file from a given URL with a progress bar.
Optionally unzip the file if it's a ZIP archive.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The URL of the file to download.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path where the downloaded file will be saved.
If not provided, the filename from the URL will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overwrite</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to overwrite the file if it already exists.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unzip</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to unzip the file if it is a ZIP archive.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the downloaded file or the extracted directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unzip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a file from a given URL with a progress bar.</span>
<span class="sd">    Optionally unzip the file if it&#39;s a ZIP archive.</span>

<span class="sd">    Args:</span>
<span class="sd">        url (str): The URL of the file to download.</span>
<span class="sd">        output_path (str, optional): The path where the downloaded file will be saved.</span>
<span class="sd">            If not provided, the filename from the URL will be used.</span>
<span class="sd">        overwrite (bool, optional): Whether to overwrite the file if it already exists.</span>
<span class="sd">        unzip (bool, optional): Whether to unzip the file if it is a ZIP archive.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The path to the downloaded file or the extracted directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File already exists: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Download the file with a progress bar</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">with</span> <span class="p">(</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">,</span>
            <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span>
                <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">progress_bar</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

    <span class="c1"># If the file is a ZIP archive and unzip is True</span>
    <span class="k">if</span> <span class="n">unzip</span> <span class="ow">and</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
                <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted to: </span><span class="si">{</span><span class="n">extract_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">extract_dir</span>

    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.download_model_from_hf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.download_model_from_hf" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Download the object detection model from Hugging Face.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the model file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face repository ID.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the downloaded model file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8283</span>
<span class="normal">8284</span>
<span class="normal">8285</span>
<span class="normal">8286</span>
<span class="normal">8287</span>
<span class="normal">8288</span>
<span class="normal">8289</span>
<span class="normal">8290</span>
<span class="normal">8291</span>
<span class="normal">8292</span>
<span class="normal">8293</span>
<span class="normal">8294</span>
<span class="normal">8295</span>
<span class="normal">8296</span>
<span class="normal">8297</span>
<span class="normal">8298</span>
<span class="normal">8299</span>
<span class="normal">8300</span>
<span class="normal">8301</span>
<span class="normal">8302</span>
<span class="normal">8303</span>
<span class="normal">8304</span>
<span class="normal">8305</span>
<span class="normal">8306</span>
<span class="normal">8307</span>
<span class="normal">8308</span>
<span class="normal">8309</span>
<span class="normal">8310</span>
<span class="normal">8311</span>
<span class="normal">8312</span>
<span class="normal">8313</span>
<span class="normal">8314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the object detection model from Hugging Face.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the model file.</span>
<span class="sd">        repo_id: Hugging Face repository ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the downloaded model file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">hf_hub_download</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Define the repository ID and model filename</span>
        <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Repo is not specified, using default Hugging Face repo_id: giswqs/geoai&quot;</span>
            <span class="p">)</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="s2">&quot;giswqs/geoai&quot;</span>

        <span class="c1"># Download the model</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model downloaded to: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading model from Hugging Face: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify a local model path or ensure internet connectivity.&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.edit_vector_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">edit_vector_data</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">,</span> <span class="n">column_widths</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">map_height</span><span class="o">=</span><span class="s1">&#39;600px&#39;</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="s1">&#39;geojson&#39;</span><span class="p">,</span> <span class="n">add_mapillary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">5e-05</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">420</span><span class="p">,</span> <span class="n">frame_border</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">controls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;top-right&#39;</span><span class="p">,</span> <span class="n">fit_bounds_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.edit_vector_data" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates a widget-based interface for creating and managing vector data on a map.</p>
<p>This function creates an interactive widget interface that allows users to draw features
(points, lines, polygons) on a map, assign properties to these features, and export them
as GeoJSON files. The interface includes a map, a sidebar for property management, and
buttons for saving, exporting, and resetting the data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>m</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Map (geoai.geoai.Map)" href="#geoai.geoai.Map">Map</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An existing Map object. If not provided, a default map with
basemaps and drawing controls will be created. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="geoai.utils.gpd.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to a GeoJSON file or a GeoDataFrame
containing the vector data to be edited. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>properties</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Dict">Dict</span>[<span title="str">str</span>, <span title="geoai.utils.List">List</span>[<span title="geoai.utils.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are property names
and values are lists of possible values for each property. These properties can be
assigned to the drawn features. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The format string for the timestamp used in the exported
filename. Defaults to "%Y%m%dT%H%M%S".</p>
              </div>
            </td>
            <td>
                  <code>&#39;%Y%m%dT%H%M%S&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column_widths</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Optional">Optional</span>[<span title="geoai.utils.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of two integers specifying the
relative widths of the map and sidebar columns. Defaults to (9, 3).</p>
              </div>
            </td>
            <td>
                  <code>(9, 3)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>map_height</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The height of the map widget. Defaults to "600px".</p>
              </div>
            </td>
            <td>
                  <code>&#39;600px&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory where the exported GeoJSON files will be saved.
If not provided, the current working directory is used. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename_prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A prefix to be added to the exported filename.
Defaults to "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_ext</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file extension for the exported file. Defaults to "geojson".</p>
              </div>
            </td>
            <td>
                  <code>&#39;geojson&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_mapillary</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a Mapillary image widget that displays the
nearest image to the clicked point on the map. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>style</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The style of the Mapillary image widget. Can be "classic", "photo",
or "split". Defaults to "photo".</p>
              </div>
            </td>
            <td>
                  <code>&#39;photo&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The radius (in degrees) used to search for the nearest Mapillary
image. Defaults to 0.00005 degrees.</p>
              </div>
            </td>
            <td>
                  <code>5e-05</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of the Mapillary image widget. Defaults to 300.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The height of the Mapillary image widget. Defaults to 420.</p>
              </div>
            </td>
            <td>
                  <code>420</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_border</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of the frame border for the Mapillary image widget.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>controls</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Optional">Optional</span>[<span title="geoai.utils.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The drawing controls to be added to the map.
Defaults to ["point", "polygon", "line_string", "trash"].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position of the drawing controls on the map. Defaults to "top-right".</p>
              </div>
            </td>
            <td>
                  <code>&#39;top-right&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="geoai.utils.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that may be passed to the function.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geoai.utils.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>widgets.VBox: A vertical box widget containing the map, sidebar, and control buttons.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/geoai.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">edit_vector_data</span><span class="p">(</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LeafMap</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">,</span>
    <span class="n">column_widths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">map_height</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;600px&quot;</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filename_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">file_ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
    <span class="n">add_mapillary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;photo&quot;</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00005</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">420</span><span class="p">,</span>
    <span class="n">frame_border</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">controls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;top-right&quot;</span><span class="p">,</span>
    <span class="n">fit_bounds_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates a widget-based interface for creating and managing vector data on a map.</span>

<span class="sd">    This function creates an interactive widget interface that allows users to draw features</span>
<span class="sd">    (points, lines, polygons) on a map, assign properties to these features, and export them</span>
<span class="sd">    as GeoJSON files. The interface includes a map, a sidebar for property management, and</span>
<span class="sd">    buttons for saving, exporting, and resetting the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        m (Map, optional): An existing Map object. If not provided, a default map with</span>
<span class="sd">            basemaps and drawing controls will be created. Defaults to None.</span>
<span class="sd">        filename (str or gpd.GeoDataFrame): The path to a GeoJSON file or a GeoDataFrame</span>
<span class="sd">            containing the vector data to be edited. Defaults to None.</span>
<span class="sd">        properties (Dict[str, List[Any]], optional): A dictionary where keys are property names</span>
<span class="sd">            and values are lists of possible values for each property. These properties can be</span>
<span class="sd">            assigned to the drawn features. Defaults to None.</span>
<span class="sd">        time_format (str, optional): The format string for the timestamp used in the exported</span>
<span class="sd">            filename. Defaults to &quot;%Y%m%dT%H%M%S&quot;.</span>
<span class="sd">        column_widths (Optional[List[int]], optional): A list of two integers specifying the</span>
<span class="sd">            relative widths of the map and sidebar columns. Defaults to (9, 3).</span>
<span class="sd">        map_height (str, optional): The height of the map widget. Defaults to &quot;600px&quot;.</span>
<span class="sd">        out_dir (str, optional): The directory where the exported GeoJSON files will be saved.</span>
<span class="sd">            If not provided, the current working directory is used. Defaults to None.</span>
<span class="sd">        filename_prefix (str, optional): A prefix to be added to the exported filename.</span>
<span class="sd">            Defaults to &quot;&quot;.</span>
<span class="sd">        file_ext (str, optional): The file extension for the exported file. Defaults to &quot;geojson&quot;.</span>
<span class="sd">        add_mapillary (bool, optional): Whether to add a Mapillary image widget that displays the</span>
<span class="sd">            nearest image to the clicked point on the map. Defaults to False.</span>
<span class="sd">        style (str, optional): The style of the Mapillary image widget. Can be &quot;classic&quot;, &quot;photo&quot;,</span>
<span class="sd">            or &quot;split&quot;. Defaults to &quot;photo&quot;.</span>
<span class="sd">        radius (float, optional): The radius (in degrees) used to search for the nearest Mapillary</span>
<span class="sd">            image. Defaults to 0.00005 degrees.</span>
<span class="sd">        width (int, optional): The width of the Mapillary image widget. Defaults to 300.</span>
<span class="sd">        height (int, optional): The height of the Mapillary image widget. Defaults to 420.</span>
<span class="sd">        frame_border (int, optional): The width of the frame border for the Mapillary image widget.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        controls (Optional[List[str]], optional): The drawing controls to be added to the map.</span>
<span class="sd">            Defaults to [&quot;point&quot;, &quot;polygon&quot;, &quot;line_string&quot;, &quot;trash&quot;].</span>
<span class="sd">        position (str, optional): The position of the drawing controls on the map. Defaults to &quot;top-right&quot;.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments that may be passed to the function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        widgets.VBox: A vertical box widget containing the map, sidebar, and control buttons.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">maplibregl</span><span class="o">.</span><span class="n">edit_vector_data</span><span class="p">(</span>
        <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">time_format</span><span class="o">=</span><span class="n">time_format</span><span class="p">,</span>
        <span class="n">column_widths</span><span class="o">=</span><span class="n">column_widths</span><span class="p">,</span>
        <span class="n">map_height</span><span class="o">=</span><span class="n">map_height</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
        <span class="n">filename_prefix</span><span class="o">=</span><span class="n">filename_prefix</span><span class="p">,</span>
        <span class="n">file_ext</span><span class="o">=</span><span class="n">file_ext</span><span class="p">,</span>
        <span class="n">add_mapillary</span><span class="o">=</span><span class="n">add_mapillary</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">frame_border</span><span class="o">=</span><span class="n">frame_border</span><span class="p">,</span>
        <span class="n">controls</span><span class="o">=</span><span class="n">controls</span><span class="p">,</span>
        <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
        <span class="n">fit_bounds_options</span><span class="o">=</span><span class="n">fit_bounds_options</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.empty_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">empty_cache</span><span class="p">()</span></code>

<a href="#geoai.geoai.empty_cache" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Empty the cache of the current device.</p>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">9181</span>
<span class="normal">9182</span>
<span class="normal">9183</span>
<span class="normal">9184</span>
<span class="normal">9185</span>
<span class="normal">9186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">empty_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Empty the cache of the current device.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="p">,</span> <span class="s2">&quot;mps&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.export_geotiff_tiles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_geotiff_tiles</span><span class="p">(</span><span class="n">in_raster</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">in_class_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">class_value_field</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_overview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata_format</span><span class="o">=</span><span class="s1">&#39;PASCAL_VOC&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.export_geotiff_tiles" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export georeferenced GeoTIFF tiles and labels from raster and classification data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>in_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster image</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output folder</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_class_data</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to classification data - can be vector file or raster.
If None, only image tiles will be exported without labels. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles in pixels (square)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Step size between tiles</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field containing class values (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>buffer_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer to add around features (in units of the CRS)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_tiles</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of tiles to process (None for all)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress non-essential output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use all_touched=True in rasterization (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_overview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to create an overview image of all tiles</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_empty_tiles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, skip tiles with no features</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output metadata format (PASCAL_VOC, COCO, YOLO). Default: PASCAL_VOC</p>
              </div>
            </td>
            <td>
                  <code>&#39;PASCAL_VOC&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span>
<span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span>
<span class="normal">3559</span>
<span class="normal">3560</span>
<span class="normal">3561</span>
<span class="normal">3562</span>
<span class="normal">3563</span>
<span class="normal">3564</span>
<span class="normal">3565</span>
<span class="normal">3566</span>
<span class="normal">3567</span>
<span class="normal">3568</span>
<span class="normal">3569</span>
<span class="normal">3570</span>
<span class="normal">3571</span>
<span class="normal">3572</span>
<span class="normal">3573</span>
<span class="normal">3574</span>
<span class="normal">3575</span>
<span class="normal">3576</span>
<span class="normal">3577</span>
<span class="normal">3578</span>
<span class="normal">3579</span>
<span class="normal">3580</span>
<span class="normal">3581</span>
<span class="normal">3582</span>
<span class="normal">3583</span>
<span class="normal">3584</span>
<span class="normal">3585</span>
<span class="normal">3586</span>
<span class="normal">3587</span>
<span class="normal">3588</span>
<span class="normal">3589</span>
<span class="normal">3590</span>
<span class="normal">3591</span>
<span class="normal">3592</span>
<span class="normal">3593</span>
<span class="normal">3594</span>
<span class="normal">3595</span>
<span class="normal">3596</span>
<span class="normal">3597</span>
<span class="normal">3598</span>
<span class="normal">3599</span>
<span class="normal">3600</span>
<span class="normal">3601</span>
<span class="normal">3602</span>
<span class="normal">3603</span>
<span class="normal">3604</span>
<span class="normal">3605</span>
<span class="normal">3606</span>
<span class="normal">3607</span>
<span class="normal">3608</span>
<span class="normal">3609</span>
<span class="normal">3610</span>
<span class="normal">3611</span>
<span class="normal">3612</span>
<span class="normal">3613</span>
<span class="normal">3614</span>
<span class="normal">3615</span>
<span class="normal">3616</span>
<span class="normal">3617</span>
<span class="normal">3618</span>
<span class="normal">3619</span>
<span class="normal">3620</span>
<span class="normal">3621</span>
<span class="normal">3622</span>
<span class="normal">3623</span>
<span class="normal">3624</span>
<span class="normal">3625</span>
<span class="normal">3626</span>
<span class="normal">3627</span>
<span class="normal">3628</span>
<span class="normal">3629</span>
<span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span>
<span class="normal">3637</span>
<span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span>
<span class="normal">3660</span>
<span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span>
<span class="normal">3669</span>
<span class="normal">3670</span>
<span class="normal">3671</span>
<span class="normal">3672</span>
<span class="normal">3673</span>
<span class="normal">3674</span>
<span class="normal">3675</span>
<span class="normal">3676</span>
<span class="normal">3677</span>
<span class="normal">3678</span>
<span class="normal">3679</span>
<span class="normal">3680</span>
<span class="normal">3681</span>
<span class="normal">3682</span>
<span class="normal">3683</span>
<span class="normal">3684</span>
<span class="normal">3685</span>
<span class="normal">3686</span>
<span class="normal">3687</span>
<span class="normal">3688</span>
<span class="normal">3689</span>
<span class="normal">3690</span>
<span class="normal">3691</span>
<span class="normal">3692</span>
<span class="normal">3693</span>
<span class="normal">3694</span>
<span class="normal">3695</span>
<span class="normal">3696</span>
<span class="normal">3697</span>
<span class="normal">3698</span>
<span class="normal">3699</span>
<span class="normal">3700</span>
<span class="normal">3701</span>
<span class="normal">3702</span>
<span class="normal">3703</span>
<span class="normal">3704</span>
<span class="normal">3705</span>
<span class="normal">3706</span>
<span class="normal">3707</span>
<span class="normal">3708</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_geotiff_tiles</span><span class="p">(</span>
    <span class="n">in_raster</span><span class="p">,</span>
    <span class="n">out_folder</span><span class="p">,</span>
    <span class="n">in_class_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">class_value_field</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">create_overview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">metadata_format</span><span class="o">=</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export georeferenced GeoTIFF tiles and labels from raster and classification data.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_raster (str): Path to input raster image</span>
<span class="sd">        out_folder (str): Path to output folder</span>
<span class="sd">        in_class_data (str, optional): Path to classification data - can be vector file or raster.</span>
<span class="sd">            If None, only image tiles will be exported without labels. Defaults to None.</span>
<span class="sd">        tile_size (int): Size of tiles in pixels (square)</span>
<span class="sd">        stride (int): Step size between tiles</span>
<span class="sd">        class_value_field (str): Field containing class values (for vector data)</span>
<span class="sd">        buffer_radius (float): Buffer to add around features (in units of the CRS)</span>
<span class="sd">        max_tiles (int): Maximum number of tiles to process (None for all)</span>
<span class="sd">        quiet (bool): If True, suppress non-essential output</span>
<span class="sd">        all_touched (bool): Whether to use all_touched=True in rasterization (for vector data)</span>
<span class="sd">        create_overview (bool): Whether to create an overview image of all tiles</span>
<span class="sd">        skip_empty_tiles (bool): If True, skip tiles with no features</span>
<span class="sd">        metadata_format (str): Output metadata format (PASCAL_VOC, COCO, YOLO). Default: PASCAL_VOC</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;rasterio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Create output directories</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Only create label and annotation directories if class data is provided</span>
    <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create annotation directory based on metadata format</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span> <span class="s2">&quot;COCO&quot;</span><span class="p">]:</span>
            <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize COCO annotations dictionary</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
            <span class="n">coco_annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">ann_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Determine if class data is raster or vector (only if class data provided)</span>
    <span class="n">is_class_data_raster</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">file_ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># Common raster extensions</span>
            <span class="k">if</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.bmp&quot;</span><span class="p">,</span> <span class="s2">&quot;.gif&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                        <span class="n">is_class_data_raster</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected in_class_data as raster: </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster dimensions: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">is_class_data_raster</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unable to open </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2"> as raster, trying as vector&quot;</span>
                        <span class="p">)</span>

    <span class="c1"># Open the input raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raster info for </span><span class="si">{</span><span class="n">in_raster</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Dimensions: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Resolution: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bands: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bounds: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate number of tiles</span>
        <span class="n">num_tiles_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_tiles_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">num_tiles_x</span> <span class="o">*</span> <span class="n">num_tiles_y</span>

        <span class="k">if</span> <span class="n">max_tiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_tiles</span> <span class="o">=</span> <span class="n">total_tiles</span>

        <span class="c1"># Process classification data (only if class data provided)</span>
        <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">is_class_data_raster</span><span class="p">:</span>
            <span class="c1"># Load raster class data</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">class_src</span><span class="p">:</span>
                <span class="c1"># Check if raster CRS matches</span>
                <span class="k">if</span> <span class="n">class_src</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;CRS mismatch: Class raster (</span><span class="si">{</span><span class="n">class_src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">) doesn&#39;t match input raster (</span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Results may be misaligned.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Get unique values from raster</span>
                <span class="c1"># Sample to avoid loading huge rasters</span>
                <span class="n">sample_data</span> <span class="o">=</span> <span class="n">class_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">,</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">class_src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">class_src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>

                <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
                <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">unique_classes</span><span class="p">[</span>
                    <span class="n">unique_classes</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">]</span>  <span class="c1"># Remove 0 as it&#39;s typically background</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes in raster: </span><span class="si">{</span><span class="n">unique_classes</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Create class mapping</span>
                <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)}</span>

                <span class="c1"># Populate COCO categories</span>
                <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cls_val</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
                        <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">class_to_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cls_val</span><span class="p">)],</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cls_val</span><span class="p">)),</span>
                                <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
        <span class="k">elif</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Load vector class data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> features from </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector CRS: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Always reproject to match raster CRS</span>
                <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting features from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

                <span class="c1"># Apply buffer if specified</span>
                <span class="k">if</span> <span class="n">buffer_radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_radius</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied buffer of </span><span class="si">{</span><span class="n">buffer_radius</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>

                <span class="c1"># Check if class_value_field exists</span>
                <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes: </span><span class="si">{</span><span class="n">unique_classes</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># Create class mapping</span>
                    <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)}</span>

                    <span class="c1"># Populate COCO categories</span>
                    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">cls_val</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
                            <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">class_to_id</span><span class="p">[</span><span class="n">cls_val</span><span class="p">],</span>
                                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cls_val</span><span class="p">),</span>
                                    <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;WARNING: &#39;</span><span class="si">{</span><span class="n">class_value_field</span><span class="si">}</span><span class="s2">&#39; not found in vector data. Using default class ID 1.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Default mapping</span>

                    <span class="c1"># Populate COCO categories with default</span>
                    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
                        <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing vector data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create progress bar</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">total_tiles</span><span class="p">,</span> <span class="n">max_tiles</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating tiles&quot;</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> [</span><span class="si">{elapsed}</span><span class="s2">&lt;</span><span class="si">{remaining}</span><span class="s2">, </span><span class="si">{rate_fmt}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Track statistics for summary</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;feature_pixels&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;tile_coordinates&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># For overview image</span>
        <span class="p">}</span>

        <span class="c1"># Process tiles</span>
        <span class="n">tile_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_x</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tile_index</span> <span class="o">&gt;=</span> <span class="n">max_tiles</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Calculate window coordinates</span>
                <span class="n">window_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">stride</span>
                <span class="n">window_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">stride</span>

                <span class="c1"># Adjust for edge cases</span>
                <span class="k">if</span> <span class="n">window_x</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                    <span class="n">window_x</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size</span>
                <span class="k">if</span> <span class="n">window_y</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                    <span class="n">window_y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size</span>

                <span class="c1"># Define window</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">window_x</span><span class="p">,</span> <span class="n">window_y</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">)</span>

                <span class="c1"># Get window transform and bounds</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Calculate window bounds</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Upper left x</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Upper left y</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Add width</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># Add height</span>

                <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

                <span class="c1"># Store tile coordinates for overview</span>
                <span class="k">if</span> <span class="n">create_overview</span><span class="p">:</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">tile_index</span><span class="p">,</span>
                            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">window_x</span><span class="p">,</span>
                            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">window_y</span><span class="p">,</span>
                            <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">],</span>
                            <span class="s2">&quot;has_features&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                <span class="c1"># Create label mask</span>
                <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">has_features</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Process classification data to create labels (only if class data provided)</span>
                <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">is_class_data_raster</span><span class="p">:</span>
                    <span class="c1"># For raster class data</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">class_src</span><span class="p">:</span>
                        <span class="c1"># Calculate window in class raster</span>
                        <span class="n">src_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
                        <span class="n">class_bounds</span> <span class="o">=</span> <span class="n">class_src</span><span class="o">.</span><span class="n">bounds</span>

                        <span class="c1"># Check if windows overlap</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">src_bounds</span><span class="o">.</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">right</span>
                            <span class="ow">or</span> <span class="n">src_bounds</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">left</span>
                            <span class="ow">or</span> <span class="n">src_bounds</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">top</span>
                            <span class="ow">or</span> <span class="n">src_bounds</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">bottom</span>
                        <span class="p">):</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Class raster and input raster do not overlap.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Get corresponding window in class raster</span>
                            <span class="n">window_class</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
                                <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">class_src</span><span class="o">.</span><span class="n">transform</span>
                            <span class="p">)</span>

                            <span class="c1"># Read label data</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">label_data</span> <span class="o">=</span> <span class="n">class_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                                    <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="n">window_class</span><span class="p">,</span>
                                    <span class="n">boundless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">),</span>
                                <span class="p">)</span>

                                <span class="c1"># Remap class values if needed</span>
                                <span class="k">if</span> <span class="n">class_to_id</span><span class="p">:</span>
                                    <span class="n">remapped_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">label_data</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">orig_val</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="n">remapped_data</span><span class="p">[</span><span class="n">label_data</span> <span class="o">==</span> <span class="n">orig_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
                                    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">remapped_data</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">label_data</span>

                                <span class="c1"># Check if we have any features</span>
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">label_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="n">has_features</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;feature_pixels&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span>
                                        <span class="n">label_mask</span>
                                    <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading class raster window: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># For vector class data</span>
                    <span class="c1"># Find features that intersect with window</span>
                    <span class="n">window_features</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="c1"># Get class value</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">:</span>
                                <span class="n">class_val</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                                <span class="n">class_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">class_id</span> <span class="o">=</span> <span class="mi">1</span>

                            <span class="c1"># Get geometry in window coordinates</span>
                            <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Rasterize feature</span>
                                    <span class="n">feature_mask</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                                        <span class="p">[(</span><span class="n">geom</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)],</span>
                                        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">),</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">window_transform</span><span class="p">,</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                                    <span class="p">)</span>

                                    <span class="c1"># Add to label mask</span>
                                    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">label_mask</span><span class="p">,</span> <span class="n">feature_mask</span><span class="p">)</span>

                                    <span class="c1"># Check if the feature was actually rasterized</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_mask</span><span class="p">):</span>
                                        <span class="n">has_features</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="n">create_overview</span> <span class="ow">and</span> <span class="n">tile_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span>
                                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">]</span>
                                        <span class="p">):</span>
                                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">][</span><span class="n">tile_index</span><span class="p">][</span>
                                                <span class="s2">&quot;has_features&quot;</span>
                                            <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rasterizing feature </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Skip tile if no features and skip_empty_tiles is True (only when class data provided)</span>
                <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_empty_tiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_features</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">tile_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c1"># Read image data</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Export image as GeoTIFF</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

                <span class="c1"># Create profile for image GeoTIFF</span>
                <span class="n">image_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">image_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># Save image as GeoTIFF</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">image_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving image GeoTIFF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Export label as GeoTIFF (only if class data provided)</span>
                <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Create profile for label GeoTIFF</span>
                    <span class="n">label_profile</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">label_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">has_features</span><span class="p">:</span>
                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;feature_pixels&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">label_mask</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving label GeoTIFF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Create annotations for object detection if using vector class data</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_class_data_raster</span>
                    <span class="ow">and</span> <span class="s2">&quot;gdf&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">:</span>
                        <span class="c1"># Create XML annotation</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;folder&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;images&quot;</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                        <span class="p">)</span>

                        <span class="n">size</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># Add georeference information</span>
                        <span class="n">geo</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;georeference&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;crs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">window_transform</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                        <span class="c1"># Add objects</span>
                        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="c1"># Get feature class</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">:</span>
                                <span class="n">class_val</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">class_val</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span>

                            <span class="c1"># Get geometry bounds in pixel coordinates</span>
                            <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                                <span class="c1"># Get bounds in world coordinates</span>
                                <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>

                                <span class="c1"># Convert to pixel coordinates</span>
                                <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                                <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                                <span class="c1"># Ensure coordinates are within tile bounds</span>
                                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                                <span class="c1"># Only add if the box has non-zero area</span>
                                <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin</span> <span class="ow">and</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">ymin</span><span class="p">:</span>
                                    <span class="n">obj</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span>
                                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">class_val</span><span class="p">)</span>
                                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;difficult&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

                                    <span class="n">bbox</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;bndbox&quot;</span><span class="p">)</span>
                                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
                                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
                                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
                                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>

                        <span class="c1"># Save XML</span>
                        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                        <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
                        <span class="c1"># Add image info</span>
                        <span class="n">image_id</span> <span class="o">=</span> <span class="n">tile_index</span>
                        <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                                <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">),</span>
                                <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">window_transform</span><span class="p">),</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                        <span class="c1"># Add annotations for each feature</span>
                        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="c1"># Get feature class</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">:</span>
                                <span class="n">class_val</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                                <span class="n">category_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">category_id</span> <span class="o">=</span> <span class="mi">1</span>

                            <span class="c1"># Get geometry bounds</span>
                            <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                                <span class="c1"># Get bounds in world coordinates</span>
                                <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>

                                <span class="c1"># Convert to pixel coordinates</span>
                                <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                                <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                                <span class="c1"># Ensure coordinates are within tile bounds</span>
                                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                                <span class="c1"># Skip if box is too small</span>
                                <span class="k">if</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">continue</span>

                                <span class="n">width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
                                <span class="n">height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>

                                <span class="c1"># Add annotation</span>
                                <span class="n">ann_id</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ann_id</span><span class="p">,</span>
                                        <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                                        <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="n">category_id</span><span class="p">,</span>
                                        <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span>
                                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span>
                                        <span class="s2">&quot;iscrowd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>

                    <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;YOLO&quot;</span><span class="p">:</span>
                        <span class="c1"># Create YOLO format annotations</span>
                        <span class="n">yolo_annotations</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="c1"># Get feature class</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">:</span>
                                <span class="n">class_val</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                                <span class="c1"># YOLO uses 0-indexed class IDs</span>
                                <span class="n">class_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">class_id</span> <span class="o">=</span> <span class="mi">0</span>

                            <span class="c1"># Get geometry bounds</span>
                            <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                                <span class="c1"># Get bounds in world coordinates</span>
                                <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>

                                <span class="c1"># Convert to pixel coordinates</span>
                                <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                                <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                                <span class="c1"># Ensure coordinates are within tile bounds</span>
                                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">col_min</span><span class="p">))</span>
                                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">row_min</span><span class="p">))</span>
                                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">col_max</span><span class="p">))</span>
                                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">row_max</span><span class="p">))</span>

                                <span class="c1"># Skip if box is too small</span>
                                <span class="k">if</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">continue</span>

                                <span class="c1"># Calculate normalized coordinates (YOLO format)</span>
                                <span class="n">x_center</span> <span class="o">=</span> <span class="p">((</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tile_size</span>
                                <span class="n">y_center</span> <span class="o">=</span> <span class="p">((</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tile_size</span>
                                <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">tile_size</span>
                                <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">tile_size</span>

                                <span class="c1"># Add YOLO annotation line</span>
                                <span class="n">yolo_annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>

                        <span class="c1"># Save YOLO annotations to text file</span>
                        <span class="k">if</span> <span class="n">yolo_annotations</span><span class="p">:</span>
                            <span class="n">yolo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.txt&quot;</span>
                            <span class="p">)</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yolo_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">yolo_annotations</span><span class="p">))</span>

                <span class="c1"># Update progress bar</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, With features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">tile_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">tile_index</span> <span class="o">&gt;=</span> <span class="n">max_tiles</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">tile_index</span> <span class="o">&gt;=</span> <span class="n">max_tiles</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Close progress bar</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Save COCO annotations if applicable (only if class data provided)</span>
        <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="s2">&quot;instances.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Saved COCO annotations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> images, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> annotations, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> categories&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving COCO annotations: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Save YOLO classes file if applicable (only if class data provided)</span>
        <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;YOLO&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create classes.txt with class names</span>
                <span class="n">classes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;classes.txt&quot;</span><span class="p">)</span>
                <span class="c1"># Sort by class ID to ensure correct order</span>
                <span class="n">sorted_classes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">classes_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">class_val</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_classes</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved YOLO classes file with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_to_id</span><span class="p">)</span><span class="si">}</span><span class="s2"> classes&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving YOLO classes file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create overview image if requested</span>
        <span class="k">if</span> <span class="n">create_overview</span> <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">create_overview_image</span><span class="p">(</span>
                    <span class="n">src</span><span class="p">,</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">],</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;overview.png&quot;</span><span class="p">),</span>
                    <span class="n">tile_size</span><span class="p">,</span>
                    <span class="n">stride</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create overview image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Report results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Export Summary -------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles exported: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tiles with features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Average feature pixels per tile: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;feature_pixels&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors encountered: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to: </span><span class="si">{</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Verify georeference in a sample image and label</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Georeference Verification -------&quot;</span><span class="p">)</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_0.tif&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_image</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_image</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image CRS: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image transform: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Image has georeference: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying image georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Only verify label if class data was provided</span>
                <span class="k">if</span> <span class="n">in_class_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sample_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_0.tif&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_label</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_label</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbl</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label CRS: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label transform: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Label has georeference: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Label dimensions: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                                <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying label georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return statistics dictionary for further processing if needed</span>
        <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.export_geotiff_tiles_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_geotiff_tiles_batch</span><span class="p">(</span><span class="n">images_folder</span><span class="p">,</span> <span class="n">masks_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masks_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">class_value_field</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata_format</span><span class="o">=</span><span class="s1">&#39;PASCAL_VOC&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.export_geotiff_tiles_batch" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export georeferenced GeoTIFF tiles from images and optionally masks.</p>
<p>This function supports four modes:
1. Images only (no masks) - when neither masks_file nor masks_folder is provided
2. Single vector file covering all images (masks_file parameter)
3. Multiple vector files, one per image (masks_folder parameter)
4. Multiple raster mask files (masks_folder parameter)</p>
<p>For mode 1 (images only), only image tiles will be exported without labels.</p>
<p>For mode 2 (single vector file), specify masks_file path. The function will
use spatial intersection to determine which features apply to each image.</p>
<p>For mode 3/4 (multiple mask files), specify masks_folder path. Images and masks
are paired either by matching filenames (match_by_name=True) or by sorted order
(match_by_name=False).</p>
<p>All image tiles are saved to a single 'images' folder and all mask tiles (if provided)
to a single 'masks' folder within the output directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>images_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to folder containing raster images</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>masks_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to folder containing classification masks/vectors.
Use this for multiple mask files (one per image or raster masks). If not provided
and masks_file is also not provided, only image tiles will be exported.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>masks_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a single vector file covering all images.
Use this for a single GeoJSON/Shapefile that covers multiple images. If not provided
and masks_folder is also not provided, only image tiles will be exported.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output folder. If None, creates 'tiles'
subfolder in images_folder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles in pixels (square)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Step size between tiles</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field containing class values (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>buffer_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer to add around features (in units of the CRS)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_tiles</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of tiles to process per image (None for all)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress non-essential output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use all_touched=True in rasterization (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_overview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to create an overview image of all tiles</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_empty_tiles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, skip tiles with no features</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image_extensions</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of image file extensions to process (default: common raster formats)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_extensions</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of mask file extensions to process (default: common raster/vector formats)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>match_by_name</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, match image and mask files by base filename.
If False, match by sorted order (alphabetically). Only applies when masks_folder is used.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Annotation format - "PASCAL_VOC" (XML), "COCO" (JSON), or "YOLO" (TXT).
Default is "PASCAL_VOC".</p>
              </div>
            </td>
            <td>
                  <code>&#39;PASCAL_VOC&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Dictionary containing batch processing statistics</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no images found, or if masks_folder and masks_file are both specified,
or if counts don't match when using masks_folder with match_by_name=False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <h3 id="geoai.geoai.export_geotiff_tiles_batch--images-only-no-masks">Images only (no masks)<a class="headerlink" href="#geoai.geoai.export_geotiff_tiles_batch--images-only-no-masks" title="Permanent link">&para;</a></h3>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">export_geotiff_tiles_batch</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">images_folder</span><span class="o">=</span><span class="s1">&#39;data/images&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;output/tiles&#39;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <h3 id="geoai.geoai.export_geotiff_tiles_batch--single-vector-file-covering-all-images">Single vector file covering all images<a class="headerlink" href="#geoai.geoai.export_geotiff_tiles_batch--single-vector-file-covering-all-images" title="Permanent link">&para;</a></h3>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">export_geotiff_tiles_batch</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">images_folder</span><span class="o">=</span><span class="s1">&#39;data/images&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">masks_file</span><span class="o">=</span><span class="s1">&#39;data/buildings.geojson&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;output/tiles&#39;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <h3 id="geoai.geoai.export_geotiff_tiles_batch--multiple-vector-files-matched-by-filename">Multiple vector files, matched by filename<a class="headerlink" href="#geoai.geoai.export_geotiff_tiles_batch--multiple-vector-files-matched-by-filename" title="Permanent link">&para;</a></h3>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">export_geotiff_tiles_batch</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">images_folder</span><span class="o">=</span><span class="s1">&#39;data/images&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">masks_folder</span><span class="o">=</span><span class="s1">&#39;data/masks&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;output/tiles&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">match_by_name</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <h3 id="geoai.geoai.export_geotiff_tiles_batch--multiple-mask-files-matched-by-sorted-order">Multiple mask files, matched by sorted order<a class="headerlink" href="#geoai.geoai.export_geotiff_tiles_batch--multiple-mask-files-matched-by-sorted-order" title="Permanent link">&para;</a></h3>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">export_geotiff_tiles_batch</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">images_folder</span><span class="o">=</span><span class="s1">&#39;data/images&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">masks_folder</span><span class="o">=</span><span class="s1">&#39;data/masks&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;output/tiles&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">match_by_name</span><span class="o">=</span><span class="kc">False</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3711</span>
<span class="normal">3712</span>
<span class="normal">3713</span>
<span class="normal">3714</span>
<span class="normal">3715</span>
<span class="normal">3716</span>
<span class="normal">3717</span>
<span class="normal">3718</span>
<span class="normal">3719</span>
<span class="normal">3720</span>
<span class="normal">3721</span>
<span class="normal">3722</span>
<span class="normal">3723</span>
<span class="normal">3724</span>
<span class="normal">3725</span>
<span class="normal">3726</span>
<span class="normal">3727</span>
<span class="normal">3728</span>
<span class="normal">3729</span>
<span class="normal">3730</span>
<span class="normal">3731</span>
<span class="normal">3732</span>
<span class="normal">3733</span>
<span class="normal">3734</span>
<span class="normal">3735</span>
<span class="normal">3736</span>
<span class="normal">3737</span>
<span class="normal">3738</span>
<span class="normal">3739</span>
<span class="normal">3740</span>
<span class="normal">3741</span>
<span class="normal">3742</span>
<span class="normal">3743</span>
<span class="normal">3744</span>
<span class="normal">3745</span>
<span class="normal">3746</span>
<span class="normal">3747</span>
<span class="normal">3748</span>
<span class="normal">3749</span>
<span class="normal">3750</span>
<span class="normal">3751</span>
<span class="normal">3752</span>
<span class="normal">3753</span>
<span class="normal">3754</span>
<span class="normal">3755</span>
<span class="normal">3756</span>
<span class="normal">3757</span>
<span class="normal">3758</span>
<span class="normal">3759</span>
<span class="normal">3760</span>
<span class="normal">3761</span>
<span class="normal">3762</span>
<span class="normal">3763</span>
<span class="normal">3764</span>
<span class="normal">3765</span>
<span class="normal">3766</span>
<span class="normal">3767</span>
<span class="normal">3768</span>
<span class="normal">3769</span>
<span class="normal">3770</span>
<span class="normal">3771</span>
<span class="normal">3772</span>
<span class="normal">3773</span>
<span class="normal">3774</span>
<span class="normal">3775</span>
<span class="normal">3776</span>
<span class="normal">3777</span>
<span class="normal">3778</span>
<span class="normal">3779</span>
<span class="normal">3780</span>
<span class="normal">3781</span>
<span class="normal">3782</span>
<span class="normal">3783</span>
<span class="normal">3784</span>
<span class="normal">3785</span>
<span class="normal">3786</span>
<span class="normal">3787</span>
<span class="normal">3788</span>
<span class="normal">3789</span>
<span class="normal">3790</span>
<span class="normal">3791</span>
<span class="normal">3792</span>
<span class="normal">3793</span>
<span class="normal">3794</span>
<span class="normal">3795</span>
<span class="normal">3796</span>
<span class="normal">3797</span>
<span class="normal">3798</span>
<span class="normal">3799</span>
<span class="normal">3800</span>
<span class="normal">3801</span>
<span class="normal">3802</span>
<span class="normal">3803</span>
<span class="normal">3804</span>
<span class="normal">3805</span>
<span class="normal">3806</span>
<span class="normal">3807</span>
<span class="normal">3808</span>
<span class="normal">3809</span>
<span class="normal">3810</span>
<span class="normal">3811</span>
<span class="normal">3812</span>
<span class="normal">3813</span>
<span class="normal">3814</span>
<span class="normal">3815</span>
<span class="normal">3816</span>
<span class="normal">3817</span>
<span class="normal">3818</span>
<span class="normal">3819</span>
<span class="normal">3820</span>
<span class="normal">3821</span>
<span class="normal">3822</span>
<span class="normal">3823</span>
<span class="normal">3824</span>
<span class="normal">3825</span>
<span class="normal">3826</span>
<span class="normal">3827</span>
<span class="normal">3828</span>
<span class="normal">3829</span>
<span class="normal">3830</span>
<span class="normal">3831</span>
<span class="normal">3832</span>
<span class="normal">3833</span>
<span class="normal">3834</span>
<span class="normal">3835</span>
<span class="normal">3836</span>
<span class="normal">3837</span>
<span class="normal">3838</span>
<span class="normal">3839</span>
<span class="normal">3840</span>
<span class="normal">3841</span>
<span class="normal">3842</span>
<span class="normal">3843</span>
<span class="normal">3844</span>
<span class="normal">3845</span>
<span class="normal">3846</span>
<span class="normal">3847</span>
<span class="normal">3848</span>
<span class="normal">3849</span>
<span class="normal">3850</span>
<span class="normal">3851</span>
<span class="normal">3852</span>
<span class="normal">3853</span>
<span class="normal">3854</span>
<span class="normal">3855</span>
<span class="normal">3856</span>
<span class="normal">3857</span>
<span class="normal">3858</span>
<span class="normal">3859</span>
<span class="normal">3860</span>
<span class="normal">3861</span>
<span class="normal">3862</span>
<span class="normal">3863</span>
<span class="normal">3864</span>
<span class="normal">3865</span>
<span class="normal">3866</span>
<span class="normal">3867</span>
<span class="normal">3868</span>
<span class="normal">3869</span>
<span class="normal">3870</span>
<span class="normal">3871</span>
<span class="normal">3872</span>
<span class="normal">3873</span>
<span class="normal">3874</span>
<span class="normal">3875</span>
<span class="normal">3876</span>
<span class="normal">3877</span>
<span class="normal">3878</span>
<span class="normal">3879</span>
<span class="normal">3880</span>
<span class="normal">3881</span>
<span class="normal">3882</span>
<span class="normal">3883</span>
<span class="normal">3884</span>
<span class="normal">3885</span>
<span class="normal">3886</span>
<span class="normal">3887</span>
<span class="normal">3888</span>
<span class="normal">3889</span>
<span class="normal">3890</span>
<span class="normal">3891</span>
<span class="normal">3892</span>
<span class="normal">3893</span>
<span class="normal">3894</span>
<span class="normal">3895</span>
<span class="normal">3896</span>
<span class="normal">3897</span>
<span class="normal">3898</span>
<span class="normal">3899</span>
<span class="normal">3900</span>
<span class="normal">3901</span>
<span class="normal">3902</span>
<span class="normal">3903</span>
<span class="normal">3904</span>
<span class="normal">3905</span>
<span class="normal">3906</span>
<span class="normal">3907</span>
<span class="normal">3908</span>
<span class="normal">3909</span>
<span class="normal">3910</span>
<span class="normal">3911</span>
<span class="normal">3912</span>
<span class="normal">3913</span>
<span class="normal">3914</span>
<span class="normal">3915</span>
<span class="normal">3916</span>
<span class="normal">3917</span>
<span class="normal">3918</span>
<span class="normal">3919</span>
<span class="normal">3920</span>
<span class="normal">3921</span>
<span class="normal">3922</span>
<span class="normal">3923</span>
<span class="normal">3924</span>
<span class="normal">3925</span>
<span class="normal">3926</span>
<span class="normal">3927</span>
<span class="normal">3928</span>
<span class="normal">3929</span>
<span class="normal">3930</span>
<span class="normal">3931</span>
<span class="normal">3932</span>
<span class="normal">3933</span>
<span class="normal">3934</span>
<span class="normal">3935</span>
<span class="normal">3936</span>
<span class="normal">3937</span>
<span class="normal">3938</span>
<span class="normal">3939</span>
<span class="normal">3940</span>
<span class="normal">3941</span>
<span class="normal">3942</span>
<span class="normal">3943</span>
<span class="normal">3944</span>
<span class="normal">3945</span>
<span class="normal">3946</span>
<span class="normal">3947</span>
<span class="normal">3948</span>
<span class="normal">3949</span>
<span class="normal">3950</span>
<span class="normal">3951</span>
<span class="normal">3952</span>
<span class="normal">3953</span>
<span class="normal">3954</span>
<span class="normal">3955</span>
<span class="normal">3956</span>
<span class="normal">3957</span>
<span class="normal">3958</span>
<span class="normal">3959</span>
<span class="normal">3960</span>
<span class="normal">3961</span>
<span class="normal">3962</span>
<span class="normal">3963</span>
<span class="normal">3964</span>
<span class="normal">3965</span>
<span class="normal">3966</span>
<span class="normal">3967</span>
<span class="normal">3968</span>
<span class="normal">3969</span>
<span class="normal">3970</span>
<span class="normal">3971</span>
<span class="normal">3972</span>
<span class="normal">3973</span>
<span class="normal">3974</span>
<span class="normal">3975</span>
<span class="normal">3976</span>
<span class="normal">3977</span>
<span class="normal">3978</span>
<span class="normal">3979</span>
<span class="normal">3980</span>
<span class="normal">3981</span>
<span class="normal">3982</span>
<span class="normal">3983</span>
<span class="normal">3984</span>
<span class="normal">3985</span>
<span class="normal">3986</span>
<span class="normal">3987</span>
<span class="normal">3988</span>
<span class="normal">3989</span>
<span class="normal">3990</span>
<span class="normal">3991</span>
<span class="normal">3992</span>
<span class="normal">3993</span>
<span class="normal">3994</span>
<span class="normal">3995</span>
<span class="normal">3996</span>
<span class="normal">3997</span>
<span class="normal">3998</span>
<span class="normal">3999</span>
<span class="normal">4000</span>
<span class="normal">4001</span>
<span class="normal">4002</span>
<span class="normal">4003</span>
<span class="normal">4004</span>
<span class="normal">4005</span>
<span class="normal">4006</span>
<span class="normal">4007</span>
<span class="normal">4008</span>
<span class="normal">4009</span>
<span class="normal">4010</span>
<span class="normal">4011</span>
<span class="normal">4012</span>
<span class="normal">4013</span>
<span class="normal">4014</span>
<span class="normal">4015</span>
<span class="normal">4016</span>
<span class="normal">4017</span>
<span class="normal">4018</span>
<span class="normal">4019</span>
<span class="normal">4020</span>
<span class="normal">4021</span>
<span class="normal">4022</span>
<span class="normal">4023</span>
<span class="normal">4024</span>
<span class="normal">4025</span>
<span class="normal">4026</span>
<span class="normal">4027</span>
<span class="normal">4028</span>
<span class="normal">4029</span>
<span class="normal">4030</span>
<span class="normal">4031</span>
<span class="normal">4032</span>
<span class="normal">4033</span>
<span class="normal">4034</span>
<span class="normal">4035</span>
<span class="normal">4036</span>
<span class="normal">4037</span>
<span class="normal">4038</span>
<span class="normal">4039</span>
<span class="normal">4040</span>
<span class="normal">4041</span>
<span class="normal">4042</span>
<span class="normal">4043</span>
<span class="normal">4044</span>
<span class="normal">4045</span>
<span class="normal">4046</span>
<span class="normal">4047</span>
<span class="normal">4048</span>
<span class="normal">4049</span>
<span class="normal">4050</span>
<span class="normal">4051</span>
<span class="normal">4052</span>
<span class="normal">4053</span>
<span class="normal">4054</span>
<span class="normal">4055</span>
<span class="normal">4056</span>
<span class="normal">4057</span>
<span class="normal">4058</span>
<span class="normal">4059</span>
<span class="normal">4060</span>
<span class="normal">4061</span>
<span class="normal">4062</span>
<span class="normal">4063</span>
<span class="normal">4064</span>
<span class="normal">4065</span>
<span class="normal">4066</span>
<span class="normal">4067</span>
<span class="normal">4068</span>
<span class="normal">4069</span>
<span class="normal">4070</span>
<span class="normal">4071</span>
<span class="normal">4072</span>
<span class="normal">4073</span>
<span class="normal">4074</span>
<span class="normal">4075</span>
<span class="normal">4076</span>
<span class="normal">4077</span>
<span class="normal">4078</span>
<span class="normal">4079</span>
<span class="normal">4080</span>
<span class="normal">4081</span>
<span class="normal">4082</span>
<span class="normal">4083</span>
<span class="normal">4084</span>
<span class="normal">4085</span>
<span class="normal">4086</span>
<span class="normal">4087</span>
<span class="normal">4088</span>
<span class="normal">4089</span>
<span class="normal">4090</span>
<span class="normal">4091</span>
<span class="normal">4092</span>
<span class="normal">4093</span>
<span class="normal">4094</span>
<span class="normal">4095</span>
<span class="normal">4096</span>
<span class="normal">4097</span>
<span class="normal">4098</span>
<span class="normal">4099</span>
<span class="normal">4100</span>
<span class="normal">4101</span>
<span class="normal">4102</span>
<span class="normal">4103</span>
<span class="normal">4104</span>
<span class="normal">4105</span>
<span class="normal">4106</span>
<span class="normal">4107</span>
<span class="normal">4108</span>
<span class="normal">4109</span>
<span class="normal">4110</span>
<span class="normal">4111</span>
<span class="normal">4112</span>
<span class="normal">4113</span>
<span class="normal">4114</span>
<span class="normal">4115</span>
<span class="normal">4116</span>
<span class="normal">4117</span>
<span class="normal">4118</span>
<span class="normal">4119</span>
<span class="normal">4120</span>
<span class="normal">4121</span>
<span class="normal">4122</span>
<span class="normal">4123</span>
<span class="normal">4124</span>
<span class="normal">4125</span>
<span class="normal">4126</span>
<span class="normal">4127</span>
<span class="normal">4128</span>
<span class="normal">4129</span>
<span class="normal">4130</span>
<span class="normal">4131</span>
<span class="normal">4132</span>
<span class="normal">4133</span>
<span class="normal">4134</span>
<span class="normal">4135</span>
<span class="normal">4136</span>
<span class="normal">4137</span>
<span class="normal">4138</span>
<span class="normal">4139</span>
<span class="normal">4140</span>
<span class="normal">4141</span>
<span class="normal">4142</span>
<span class="normal">4143</span>
<span class="normal">4144</span>
<span class="normal">4145</span>
<span class="normal">4146</span>
<span class="normal">4147</span>
<span class="normal">4148</span>
<span class="normal">4149</span>
<span class="normal">4150</span>
<span class="normal">4151</span>
<span class="normal">4152</span>
<span class="normal">4153</span>
<span class="normal">4154</span>
<span class="normal">4155</span>
<span class="normal">4156</span>
<span class="normal">4157</span>
<span class="normal">4158</span>
<span class="normal">4159</span>
<span class="normal">4160</span>
<span class="normal">4161</span>
<span class="normal">4162</span>
<span class="normal">4163</span>
<span class="normal">4164</span>
<span class="normal">4165</span>
<span class="normal">4166</span>
<span class="normal">4167</span>
<span class="normal">4168</span>
<span class="normal">4169</span>
<span class="normal">4170</span>
<span class="normal">4171</span>
<span class="normal">4172</span>
<span class="normal">4173</span>
<span class="normal">4174</span>
<span class="normal">4175</span>
<span class="normal">4176</span>
<span class="normal">4177</span>
<span class="normal">4178</span>
<span class="normal">4179</span>
<span class="normal">4180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_geotiff_tiles_batch</span><span class="p">(</span>
    <span class="n">images_folder</span><span class="p">,</span>
    <span class="n">masks_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">masks_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">class_value_field</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">image_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">match_by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">metadata_format</span><span class="o">=</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export georeferenced GeoTIFF tiles from images and optionally masks.</span>

<span class="sd">    This function supports four modes:</span>
<span class="sd">    1. Images only (no masks) - when neither masks_file nor masks_folder is provided</span>
<span class="sd">    2. Single vector file covering all images (masks_file parameter)</span>
<span class="sd">    3. Multiple vector files, one per image (masks_folder parameter)</span>
<span class="sd">    4. Multiple raster mask files (masks_folder parameter)</span>

<span class="sd">    For mode 1 (images only), only image tiles will be exported without labels.</span>

<span class="sd">    For mode 2 (single vector file), specify masks_file path. The function will</span>
<span class="sd">    use spatial intersection to determine which features apply to each image.</span>

<span class="sd">    For mode 3/4 (multiple mask files), specify masks_folder path. Images and masks</span>
<span class="sd">    are paired either by matching filenames (match_by_name=True) or by sorted order</span>
<span class="sd">    (match_by_name=False).</span>

<span class="sd">    All image tiles are saved to a single &#39;images&#39; folder and all mask tiles (if provided)</span>
<span class="sd">    to a single &#39;masks&#39; folder within the output directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        images_folder (str): Path to folder containing raster images</span>
<span class="sd">        masks_folder (str, optional): Path to folder containing classification masks/vectors.</span>
<span class="sd">            Use this for multiple mask files (one per image or raster masks). If not provided</span>
<span class="sd">            and masks_file is also not provided, only image tiles will be exported.</span>
<span class="sd">        masks_file (str, optional): Path to a single vector file covering all images.</span>
<span class="sd">            Use this for a single GeoJSON/Shapefile that covers multiple images. If not provided</span>
<span class="sd">            and masks_folder is also not provided, only image tiles will be exported.</span>
<span class="sd">        output_folder (str, optional): Path to output folder. If None, creates &#39;tiles&#39;</span>
<span class="sd">            subfolder in images_folder.</span>
<span class="sd">        tile_size (int): Size of tiles in pixels (square)</span>
<span class="sd">        stride (int): Step size between tiles</span>
<span class="sd">        class_value_field (str): Field containing class values (for vector data)</span>
<span class="sd">        buffer_radius (float): Buffer to add around features (in units of the CRS)</span>
<span class="sd">        max_tiles (int): Maximum number of tiles to process per image (None for all)</span>
<span class="sd">        quiet (bool): If True, suppress non-essential output</span>
<span class="sd">        all_touched (bool): Whether to use all_touched=True in rasterization (for vector data)</span>
<span class="sd">        create_overview (bool): Whether to create an overview image of all tiles</span>
<span class="sd">        skip_empty_tiles (bool): If True, skip tiles with no features</span>
<span class="sd">        image_extensions (list): List of image file extensions to process (default: common raster formats)</span>
<span class="sd">        mask_extensions (list): List of mask file extensions to process (default: common raster/vector formats)</span>
<span class="sd">        match_by_name (bool): If True, match image and mask files by base filename.</span>
<span class="sd">            If False, match by sorted order (alphabetically). Only applies when masks_folder is used.</span>
<span class="sd">        metadata_format (str): Annotation format - &quot;PASCAL_VOC&quot; (XML), &quot;COCO&quot; (JSON), or &quot;YOLO&quot; (TXT).</span>
<span class="sd">            Default is &quot;PASCAL_VOC&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Dictionary containing batch processing statistics</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no images found, or if masks_folder and masks_file are both specified,</span>
<span class="sd">            or if counts don&#39;t match when using masks_folder with match_by_name=False.</span>

<span class="sd">    Examples:</span>
<span class="sd">        # Images only (no masks)</span>
<span class="sd">        &gt;&gt;&gt; stats = export_geotiff_tiles_batch(</span>
<span class="sd">        ...     images_folder=&#39;data/images&#39;,</span>
<span class="sd">        ...     output_folder=&#39;output/tiles&#39;</span>
<span class="sd">        ... )</span>

<span class="sd">        # Single vector file covering all images</span>
<span class="sd">        &gt;&gt;&gt; stats = export_geotiff_tiles_batch(</span>
<span class="sd">        ...     images_folder=&#39;data/images&#39;,</span>
<span class="sd">        ...     masks_file=&#39;data/buildings.geojson&#39;,</span>
<span class="sd">        ...     output_folder=&#39;output/tiles&#39;</span>
<span class="sd">        ... )</span>

<span class="sd">        # Multiple vector files, matched by filename</span>
<span class="sd">        &gt;&gt;&gt; stats = export_geotiff_tiles_batch(</span>
<span class="sd">        ...     images_folder=&#39;data/images&#39;,</span>
<span class="sd">        ...     masks_folder=&#39;data/masks&#39;,</span>
<span class="sd">        ...     output_folder=&#39;output/tiles&#39;,</span>
<span class="sd">        ...     match_by_name=True</span>
<span class="sd">        ... )</span>

<span class="sd">        # Multiple mask files, matched by sorted order</span>
<span class="sd">        &gt;&gt;&gt; stats = export_geotiff_tiles_batch(</span>
<span class="sd">        ...     images_folder=&#39;data/images&#39;,</span>
<span class="sd">        ...     masks_folder=&#39;data/masks&#39;,</span>
<span class="sd">        ...     output_folder=&#39;output/tiles&#39;,</span>
<span class="sd">        ...     match_by_name=False</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;rasterio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Validate input parameters</span>
    <span class="k">if</span> <span class="n">masks_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot specify both masks_folder and masks_file. Please use only one.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Default output folder if not specified</span>
    <span class="k">if</span> <span class="n">output_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_folder</span><span class="p">,</span> <span class="s2">&quot;tiles&quot;</span><span class="p">)</span>

    <span class="c1"># Default extensions if not provided</span>
    <span class="k">if</span> <span class="n">image_extensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mask_extensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_extensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.img&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.shp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.geojson&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.geoparquet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.json&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># Convert extensions to lowercase for comparison</span>
    <span class="n">image_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">image_extensions</span><span class="p">]</span>
    <span class="n">mask_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">mask_extensions</span><span class="p">]</span>

    <span class="c1"># Create output folder structure</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_images_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_images_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Only create masks directory if masks are provided</span>
    <span class="n">output_masks_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">masks_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_masks_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_masks_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create annotation directory based on metadata format (only if masks are provided)</span>
    <span class="n">ann_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">masks_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">metadata_format</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;COCO&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Initialize COCO annotations dictionary (only if masks are provided)</span>
    <span class="n">coco_annotations</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">masks_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="ow">and</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
        <span class="n">coco_annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1"># Initialize YOLO class set (only if masks are provided)</span>
    <span class="n">yolo_classes</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">masks_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;YOLO&quot;</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># Get list of image files</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">image_extensions</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

    <span class="c1"># Sort files for consistent processing</span>
    <span class="n">image_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No image files found in </span><span class="si">{</span><span class="n">images_folder</span><span class="si">}</span><span class="s2"> with extensions </span><span class="si">{</span><span class="n">image_extensions</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Handle different mask input modes</span>
    <span class="n">use_single_mask_file</span> <span class="o">=</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">has_masks</span> <span class="o">=</span> <span class="n">masks_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">masks_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">mask_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">image_mask_pairs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_masks</span><span class="p">:</span>
        <span class="c1"># Mode 0: No masks - create pairs with None for mask</span>
        <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
            <span class="n">image_mask_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_file</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">use_single_mask_file</span><span class="p">:</span>
        <span class="c1"># Mode 1: Single vector file covering all images</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">masks_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask file not found: </span><span class="si">{</span><span class="n">masks_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load the single mask file once - will be spatially filtered per image</span>
        <span class="n">single_mask_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">masks_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using single mask file: </span><span class="si">{</span><span class="n">masks_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mask contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">single_mask_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> features in CRS: </span><span class="si">{</span><span class="n">single_mask_gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create pairs with the same mask file for all images</span>
        <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
            <span class="n">image_mask_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_file</span><span class="p">,</span> <span class="n">masks_file</span><span class="p">,</span> <span class="n">single_mask_gdf</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Mode 2/3: Multiple mask files (vector or raster)</span>
        <span class="c1"># Get list of mask files</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">mask_extensions</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">masks_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mask_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

        <span class="c1"># Sort files for consistent processing</span>
        <span class="n">mask_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No mask files found in </span><span class="si">{</span><span class="n">masks_folder</span><span class="si">}</span><span class="s2"> with extensions </span><span class="si">{</span><span class="n">mask_extensions</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Match images to masks</span>
        <span class="k">if</span> <span class="n">match_by_name</span><span class="p">:</span>
            <span class="c1"># Match by base filename</span>
            <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span>
            <span class="p">}</span>
            <span class="n">mask_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mask_files</span>
            <span class="p">}</span>

            <span class="c1"># Find matching pairs</span>
            <span class="k">for</span> <span class="n">img_base</span><span class="p">,</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">image_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">img_base</span> <span class="ow">in</span> <span class="n">mask_dict</span><span class="p">:</span>
                    <span class="n">image_mask_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">mask_dict</span><span class="p">[</span><span class="n">img_base</span><span class="p">],</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No mask found for image </span><span class="si">{</span><span class="n">img_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">image_mask_pairs</span><span class="p">:</span>
                <span class="c1"># Provide detailed error message with found files</span>
                <span class="n">image_bases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">mask_bases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;No matching image-mask pairs found when matching by filename. &quot;</span>
                    <span class="s2">&quot;Check that image and mask files have matching base names.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_bases</span><span class="p">)</span><span class="si">}</span><span class="s2"> image(s): &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_bases</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">image_bases</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None found&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">image_bases</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_bases</span><span class="p">)</span><span class="si">}</span><span class="s2"> mask(s): &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_bases</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">mask_bases</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None found&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">mask_bases</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Tip: Set match_by_name=False to match by sorted order, or ensure filenames match.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Match by sorted order</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_files</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Number of image files (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span><span class="si">}</span><span class="s2">) does not match &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;number of mask files (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_files</span><span class="p">)</span><span class="si">}</span><span class="s2">) when matching by sorted order. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Use match_by_name=True for filename-based matching.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create pairs by sorted order</span>
            <span class="k">for</span> <span class="n">image_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">mask_files</span><span class="p">):</span>
                <span class="n">image_mask_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Initialize batch statistics</span>
    <span class="n">batch_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_image_pairs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;processed_pairs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;processed_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;failed_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_masks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> image files to process (images only, no masks)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_single_mask_file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> image files to process&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using single mask file: </span><span class="si">{</span><span class="n">masks_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_mask_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching image-mask pairs to process&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing batch from </span><span class="si">{</span><span class="n">images_folder</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">masks_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output folder: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="c1"># Global tile counter for unique naming</span>
    <span class="n">global_tile_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Process each image-mask pair</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">mask_gdf</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">image_mask_pairs</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing image pairs&quot;</span><span class="p">,</span>
            <span class="n">disable</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">):</span>
        <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_image_pairs&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Get base filename without extension for naming (use image filename)</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Image: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">use_single_mask_file</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;  Mask: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> (spatially filtered)&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mask: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mask: None (images only)&quot;</span><span class="p">)</span>

            <span class="c1"># Process the image-mask pair</span>
            <span class="n">tiles_generated</span> <span class="o">=</span> <span class="n">_process_image_mask_pair</span><span class="p">(</span>
                <span class="n">image_file</span><span class="o">=</span><span class="n">image_file</span><span class="p">,</span>
                <span class="n">mask_file</span><span class="o">=</span><span class="n">mask_file</span><span class="p">,</span>
                <span class="n">base_name</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span>
                <span class="n">output_images_dir</span><span class="o">=</span><span class="n">output_images_dir</span><span class="p">,</span>
                <span class="n">output_masks_dir</span><span class="o">=</span><span class="n">output_masks_dir</span><span class="p">,</span>
                <span class="n">global_tile_counter</span><span class="o">=</span><span class="n">global_tile_counter</span><span class="p">,</span>
                <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span>
                <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
                <span class="n">class_value_field</span><span class="o">=</span><span class="n">class_value_field</span><span class="p">,</span>
                <span class="n">buffer_radius</span><span class="o">=</span><span class="n">buffer_radius</span><span class="p">,</span>
                <span class="n">max_tiles</span><span class="o">=</span><span class="n">max_tiles</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="n">skip_empty_tiles</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                <span class="n">mask_gdf</span><span class="o">=</span><span class="n">mask_gdf</span><span class="p">,</span>  <span class="c1"># Pass pre-loaded GeoDataFrame if using single mask</span>
                <span class="n">use_single_mask_file</span><span class="o">=</span><span class="n">use_single_mask_file</span><span class="p">,</span>
                <span class="n">metadata_format</span><span class="o">=</span><span class="n">metadata_format</span><span class="p">,</span>
                <span class="n">ann_dir</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">ann_dir</span>
                    <span class="k">if</span> <span class="s2">&quot;ann_dir&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">metadata_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span> <span class="s2">&quot;COCO&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Update counters</span>
            <span class="n">global_tile_counter</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span>

            <span class="c1"># Update batch statistics</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;processed_pairs&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span>

            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;processed_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_file</span><span class="p">,</span>
                    <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_file</span><span class="p">,</span>
                    <span class="s2">&quot;base_name&quot;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                    <span class="s2">&quot;tiles_generated&quot;</span><span class="p">:</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Aggregate COCO annotations</span>
            <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span> <span class="ow">and</span> <span class="s2">&quot;coco_data&quot;</span> <span class="ow">in</span> <span class="n">tiles_generated</span><span class="p">:</span>
                <span class="n">coco_data</span> <span class="o">=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;coco_data&quot;</span><span class="p">]</span>
                <span class="c1"># Add images and annotations</span>
                <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">coco_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">coco_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annotations&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="c1"># Merge categories (avoid duplicates)</span>
                <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">coco_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">c</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>

            <span class="c1"># Aggregate YOLO classes</span>
            <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;YOLO&quot;</span> <span class="ow">and</span> <span class="s2">&quot;yolo_classes&quot;</span> <span class="ow">in</span> <span class="n">tiles_generated</span><span class="p">:</span>
                <span class="n">yolo_classes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;yolo_classes&quot;</span><span class="p">])</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR processing </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;failed_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_file</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="p">)</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Save aggregated COCO annotations</span>
    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span> <span class="ow">and</span> <span class="n">coco_annotations</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

        <span class="n">coco_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="s2">&quot;instances.json&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">coco_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved COCO annotations: </span><span class="si">{</span><span class="n">coco_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Images: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Annotations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Categories: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Save aggregated YOLO classes</span>
    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;YOLO&quot;</span> <span class="ow">and</span> <span class="n">yolo_classes</span><span class="p">:</span>
        <span class="n">classes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;classes.txt&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">classes_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sorted_classes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">yolo_classes</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">classes_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">sorted_classes</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved YOLO classes: </span><span class="si">{</span><span class="n">classes_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total classes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_classes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Print batch summary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BATCH PROCESSING SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total image pairs found: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;total_image_pairs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully processed: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;processed_pairs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;failed_files&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles generated: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiles with features: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">feature_percentage</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature percentage: </span><span class="si">{</span><span class="n">feature_percentage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total errors: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Images: </span><span class="si">{</span><span class="n">output_images_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_masks_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Masks: </span><span class="si">{</span><span class="n">output_masks_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span> <span class="s2">&quot;COCO&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ann_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annotations: </span><span class="si">{</span><span class="n">ann_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;YOLO&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Labels: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;labels&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># List failed files if any</span>
        <span class="k">if</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;failed_files&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed files:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">failed</span> <span class="ow">in</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;failed_files&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">failed</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">failed</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.export_tiles_to_geojson" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_tiles_to_geojson</span><span class="p">(</span><span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.export_tiles_to_geojson" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export tile rectangles directly to GeoJSON without creating an overview image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tile_coordinates</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries containing tile information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>src</code>
            </td>
            <td>
                  <code><span title="rasterio.io.DatasetReader">DatasetReader</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path where the GeoJSON will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of each tile in pixels. Only needed if not in tile_coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stride between tiles in pixels. Used to calculate overlaps between tiles.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved GeoJSON file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5025</span>
<span class="normal">5026</span>
<span class="normal">5027</span>
<span class="normal">5028</span>
<span class="normal">5029</span>
<span class="normal">5030</span>
<span class="normal">5031</span>
<span class="normal">5032</span>
<span class="normal">5033</span>
<span class="normal">5034</span>
<span class="normal">5035</span>
<span class="normal">5036</span>
<span class="normal">5037</span>
<span class="normal">5038</span>
<span class="normal">5039</span>
<span class="normal">5040</span>
<span class="normal">5041</span>
<span class="normal">5042</span>
<span class="normal">5043</span>
<span class="normal">5044</span>
<span class="normal">5045</span>
<span class="normal">5046</span>
<span class="normal">5047</span>
<span class="normal">5048</span>
<span class="normal">5049</span>
<span class="normal">5050</span>
<span class="normal">5051</span>
<span class="normal">5052</span>
<span class="normal">5053</span>
<span class="normal">5054</span>
<span class="normal">5055</span>
<span class="normal">5056</span>
<span class="normal">5057</span>
<span class="normal">5058</span>
<span class="normal">5059</span>
<span class="normal">5060</span>
<span class="normal">5061</span>
<span class="normal">5062</span>
<span class="normal">5063</span>
<span class="normal">5064</span>
<span class="normal">5065</span>
<span class="normal">5066</span>
<span class="normal">5067</span>
<span class="normal">5068</span>
<span class="normal">5069</span>
<span class="normal">5070</span>
<span class="normal">5071</span>
<span class="normal">5072</span>
<span class="normal">5073</span>
<span class="normal">5074</span>
<span class="normal">5075</span>
<span class="normal">5076</span>
<span class="normal">5077</span>
<span class="normal">5078</span>
<span class="normal">5079</span>
<span class="normal">5080</span>
<span class="normal">5081</span>
<span class="normal">5082</span>
<span class="normal">5083</span>
<span class="normal">5084</span>
<span class="normal">5085</span>
<span class="normal">5086</span>
<span class="normal">5087</span>
<span class="normal">5088</span>
<span class="normal">5089</span>
<span class="normal">5090</span>
<span class="normal">5091</span>
<span class="normal">5092</span>
<span class="normal">5093</span>
<span class="normal">5094</span>
<span class="normal">5095</span>
<span class="normal">5096</span>
<span class="normal">5097</span>
<span class="normal">5098</span>
<span class="normal">5099</span>
<span class="normal">5100</span>
<span class="normal">5101</span>
<span class="normal">5102</span>
<span class="normal">5103</span>
<span class="normal">5104</span>
<span class="normal">5105</span>
<span class="normal">5106</span>
<span class="normal">5107</span>
<span class="normal">5108</span>
<span class="normal">5109</span>
<span class="normal">5110</span>
<span class="normal">5111</span>
<span class="normal">5112</span>
<span class="normal">5113</span>
<span class="normal">5114</span>
<span class="normal">5115</span>
<span class="normal">5116</span>
<span class="normal">5117</span>
<span class="normal">5118</span>
<span class="normal">5119</span>
<span class="normal">5120</span>
<span class="normal">5121</span>
<span class="normal">5122</span>
<span class="normal">5123</span>
<span class="normal">5124</span>
<span class="normal">5125</span>
<span class="normal">5126</span>
<span class="normal">5127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_tiles_to_geojson</span><span class="p">(</span>
    <span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export tile rectangles directly to GeoJSON without creating an overview image.</span>

<span class="sd">    Args:</span>
<span class="sd">        tile_coordinates (list): A list of dictionaries containing tile information.</span>
<span class="sd">        src (rasterio.io.DatasetReader): The source raster dataset.</span>
<span class="sd">        output_path (str): The path where the GeoJSON will be saved.</span>
<span class="sd">        tile_size (int, optional): The size of each tile in pixels. Only needed if not in tile_coordinates.</span>
<span class="sd">        stride (int, optional): The stride between tiles in pixels. Used to calculate overlaps between tiles.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved GeoJSON file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tile_coordinates</span><span class="p">:</span>
        <span class="c1"># Get the size from the tile or use the provided parameter</span>
        <span class="n">tile_width</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span>
        <span class="n">tile_height</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">tile_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tile_height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Tile size not found in tile data and no tile_size parameter provided&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get bounds from the tile</span>
        <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">tile</span><span class="p">:</span>
            <span class="c1"># If bounds are already in geo coordinates</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to calculate bounds from transform if available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">):</span>
                <span class="c1"># Convert pixel coordinates to geo coordinates</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">tile_width</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">+</span> <span class="n">tile_height</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot determine bounds. Neither &#39;bounds&#39; in tile nor transform in src.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Calculate overlap with neighboring tiles if stride is provided</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stride</span> <span class="o">&lt;</span> <span class="n">tile_width</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">tile_width</span> <span class="o">-</span> <span class="n">stride</span>

        <span class="c1"># Create a polygon from the bounds</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

        <span class="c1"># Create a GeoJSON feature</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">polygon</span><span class="p">),</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span>
                <span class="s2">&quot;has_features&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;has_features&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s2">&quot;tile_width_px&quot;</span><span class="p">:</span> <span class="n">tile_width</span><span class="p">,</span>
                <span class="s2">&quot;tile_height_px&quot;</span><span class="p">:</span> <span class="n">tile_height</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Add overlap information if stride is provided</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;stride_px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stride</span>
            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;overlap_px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span>

        <span class="c1"># Add additional properties from the tile</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tile</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]:</span>
                <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="c1"># Create the GeoJSON collection</span>
    <span class="n">geojson_collection</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s2">&quot;to_string&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
            <span class="s2">&quot;source_raster_dimensions&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Create directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">geojson_collection</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GeoJSON saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.export_training_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_training_data</span><span class="p">(</span><span class="n">in_raster</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">in_class_data</span><span class="p">,</span> <span class="n">image_chip_format</span><span class="o">=</span><span class="s1">&#39;GEOTIFF&#39;</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">tile_size_y</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">stride_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_nofeature_tiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata_format</span><span class="o">=</span><span class="s1">&#39;PASCAL_VOC&#39;</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">class_value_field</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_mask_polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reference_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blacken_around_feature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_mode</span><span class="o">=</span><span class="s1">&#39;FIXED_SIZE&#39;</span><span class="p">,</span> <span class="n">in_raster2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_instance_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instance_class_value_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_polygon_overlap_ratio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.geoai.export_training_data" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export training data for deep learning using TorchGeo with progress bar.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>in_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output folder path where chips and labels will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_class_data</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file containing class polygons.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image_chip_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output image format (PNG, JPEG, TIFF, GEOTIFF).</p>
              </div>
            </td>
            <td>
                  <code>&#39;GEOTIFF&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width of image chips in pixels.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height of image chips in pixels.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Horizontal stride between chips. If None, uses tile_size_x.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical stride between chips. If None, uses tile_size_y.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_nofeature_tiles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to export chips without features.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output metadata format (PASCAL_VOC, KITTI, COCO).</p>
              </div>
            </td>
            <td>
                  <code>&#39;PASCAL_VOC&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting index for chip filenames.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in in_class_data containing class values.</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>buffer_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer radius around features (in CRS units).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_mask_polygons</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file containing mask polygons.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rotation_angle</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rotation angle in degrees.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_system</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference system code.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>blacken_around_feature</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to mask areas outside of features.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crop_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Crop mode (FIXED_SIZE, CENTERED_ON_FEATURE).</p>
              </div>
            </td>
            <td>
                  <code>&#39;FIXED_SIZE&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_raster2</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to secondary raster image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_instance_data</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file containing instance polygons.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance_class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in in_instance_data for instance classes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_polygon_overlap_ratio</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum overlap ratio for polygons.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use all_touched=True in rasterization.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_geotiff</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to save as GeoTIFF with georeferencing.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress most output messages.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5130</span>
<span class="normal">5131</span>
<span class="normal">5132</span>
<span class="normal">5133</span>
<span class="normal">5134</span>
<span class="normal">5135</span>
<span class="normal">5136</span>
<span class="normal">5137</span>
<span class="normal">5138</span>
<span class="normal">5139</span>
<span class="normal">5140</span>
<span class="normal">5141</span>
<span class="normal">5142</span>
<span class="normal">5143</span>
<span class="normal">5144</span>
<span class="normal">5145</span>
<span class="normal">5146</span>
<span class="normal">5147</span>
<span class="normal">5148</span>
<span class="normal">5149</span>
<span class="normal">5150</span>
<span class="normal">5151</span>
<span class="normal">5152</span>
<span class="normal">5153</span>
<span class="normal">5154</span>
<span class="normal">5155</span>
<span class="normal">5156</span>
<span class="normal">5157</span>
<span class="normal">5158</span>
<span class="normal">5159</span>
<span class="normal">5160</span>
<span class="normal">5161</span>
<span class="normal">5162</span>
<span class="normal">5163</span>
<span class="normal">5164</span>
<span class="normal">5165</span>
<span class="normal">5166</span>
<span class="normal">5167</span>
<span class="normal">5168</span>
<span class="normal">5169</span>
<span class="normal">5170</span>
<span class="normal">5171</span>
<span class="normal">5172</span>
<span class="normal">5173</span>
<span class="normal">5174</span>
<span class="normal">5175</span>
<span class="normal">5176</span>
<span class="normal">5177</span>
<span class="normal">5178</span>
<span class="normal">5179</span>
<span class="normal">5180</span>
<span class="normal">5181</span>
<span class="normal">5182</span>
<span class="normal">5183</span>
<span class="normal">5184</span>
<span class="normal">5185</span>
<span class="normal">5186</span>
<span class="normal">5187</span>
<span class="normal">5188</span>
<span class="normal">5189</span>
<span class="normal">5190</span>
<span class="normal">5191</span>
<span class="normal">5192</span>
<span class="normal">5193</span>
<span class="normal">5194</span>
<span class="normal">5195</span>
<span class="normal">5196</span>
<span class="normal">5197</span>
<span class="normal">5198</span>
<span class="normal">5199</span>
<span class="normal">5200</span>
<span class="normal">5201</span>
<span class="normal">5202</span>
<span class="normal">5203</span>
<span class="normal">5204</span>
<span class="normal">5205</span>
<span class="normal">5206</span>
<span class="normal">5207</span>
<span class="normal">5208</span>
<span class="normal">5209</span>
<span class="normal">5210</span>
<span class="normal">5211</span>
<span class="normal">5212</span>
<span class="normal">5213</span>
<span class="normal">5214</span>
<span class="normal">5215</span>
<span class="normal">5216</span>
<span class="normal">5217</span>
<span class="normal">5218</span>
<span class="normal">5219</span>
<span class="normal">5220</span>
<span class="normal">5221</span>
<span class="normal">5222</span>
<span class="normal">5223</span>
<span class="normal">5224</span>
<span class="normal">5225</span>
<span class="normal">5226</span>
<span class="normal">5227</span>
<span class="normal">5228</span>
<span class="normal">5229</span>
<span class="normal">5230</span>
<span class="normal">5231</span>
<span class="normal">5232</span>
<span class="normal">5233</span>
<span class="normal">5234</span>
<span class="normal">5235</span>
<span class="normal">5236</span>
<span class="normal">5237</span>
<span class="normal">5238</span>
<span class="normal">5239</span>
<span class="normal">5240</span>
<span class="normal">5241</span>
<span class="normal">5242</span>
<span class="normal">5243</span>
<span class="normal">5244</span>
<span class="normal">5245</span>
<span class="normal">5246</span>
<span class="normal">5247</span>
<span class="normal">5248</span>
<span class="normal">5249</span>
<span class="normal">5250</span>
<span class="normal">5251</span>
<span class="normal">5252</span>
<span class="normal">5253</span>
<span class="normal">5254</span>
<span class="normal">5255</span>
<span class="normal">5256</span>
<span class="normal">5257</span>
<span class="normal">5258</span>
<span class="normal">5259</span>
<span class="normal">5260</span>
<span class="normal">5261</span>
<span class="normal">5262</span>
<span class="normal">5263</span>
<span class="normal">5264</span>
<span class="normal">5265</span>
<span class="normal">5266</span>
<span class="normal">5267</span>
<span class="normal">5268</span>
<span class="normal">5269</span>
<span class="normal">5270</span>
<span class="normal">5271</span>
<span class="normal">5272</span>
<span class="normal">5273</span>
<span class="normal">5274</span>
<span class="normal">5275</span>
<span class="normal">5276</span>
<span class="normal">5277</span>
<span class="normal">5278</span>
<span class="normal">5279</span>
<span class="normal">5280</span>
<span class="normal">5281</span>
<span class="normal">5282</span>
<span class="normal">5283</span>
<span class="normal">5284</span>
<span class="normal">5285</span>
<span class="normal">5286</span>
<span class="normal">5287</span>
<span class="normal">5288</span>
<span class="normal">5289</span>
<span class="normal">5290</span>
<span class="normal">5291</span>
<span class="normal">5292</span>
<span class="normal">5293</span>
<span class="normal">5294</span>
<span class="normal">5295</span>
<span class="normal">5296</span>
<span class="normal">5297</span>
<span class="normal">5298</span>
<span class="normal">5299</span>
<span class="normal">5300</span>
<span class="normal">5301</span>
<span class="normal">5302</span>
<span class="normal">5303</span>
<span class="normal">5304</span>
<span class="normal">5305</span>
<span class="normal">5306</span>
<span class="normal">5307</span>
<span class="normal">5308</span>
<span class="normal">5309</span>
<span class="normal">5310</span>
<span class="normal">5311</span>
<span class="normal">5312</span>
<span class="normal">5313</span>
<span class="normal">5314</span>
<span class="normal">5315</span>
<span class="normal">5316</span>
<span class="normal">5317</span>
<span class="normal">5318</span>
<span class="normal">5319</span>
<span class="normal">5320</span>
<span class="normal">5321</span>
<span class="normal">5322</span>
<span class="normal">5323</span>
<span class="normal">5324</span>
<span class="normal">5325</span>
<span class="normal">5326</span>
<span class="normal">5327</span>
<span class="normal">5328</span>
<span class="normal">5329</span>
<span class="normal">5330</span>
<span class="normal">5331</span>
<span class="normal">5332</span>
<span class="normal">5333</span>
<span class="normal">5334</span>
<span class="normal">5335</span>
<span class="normal">5336</span>
<span class="normal">5337</span>
<span class="normal">5338</span>
<span class="normal">5339</span>
<span class="normal">5340</span>
<span class="normal">5341</span>
<span class="normal">5342</span>
<span class="normal">5343</span>
<span class="normal">5344</span>
<span class="normal">5345</span>
<span class="normal">5346</span>
<span class="normal">5347</span>
<span class="normal">5348</span>
<span class="normal">5349</span>
<span class="normal">5350</span>
<span class="normal">5351</span>
<span class="normal">5352</span>
<span class="normal">5353</span>
<span class="normal">5354</span>
<span class="normal">5355</span>
<span class="normal">5356</span>
<span class="normal">5357</span>
<span class="normal">5358</span>
<span class="normal">5359</span>
<span class="normal">5360</span>
<span class="normal">5361</span>
<span class="normal">5362</span>
<span class="normal">5363</span>
<span class="normal">5364</span>
<span class="normal">5365</span>
<span class="normal">5366</span>
<span class="normal">5367</span>
<span class="normal">5368</span>
<span class="normal">5369</span>
<span class="normal">5370</span>
<span class="normal">5371</span>
<span class="normal">5372</span>
<span class="normal">5373</span>
<span class="normal">5374</span>
<span class="normal">5375</span>
<span class="normal">5376</span>
<span class="normal">5377</span>
<span class="normal">5378</span>
<span class="normal">5379</span>
<span class="normal">5380</span>
<span class="normal">5381</span>
<span class="normal">5382</span>
<span class="normal">5383</span>
<span class="normal">5384</span>
<span class="normal">5385</span>
<span class="normal">5386</span>
<span class="normal">5387</span>
<span class="normal">5388</span>
<span class="normal">5389</span>
<span class="normal">5390</span>
<span class="normal">5391</span>
<span class="normal">5392</span>
<span class="normal">5393</span>
<span class="normal">5394</span>
<span class="normal">5395</span>
<span class="normal">5396</span>
<span class="normal">5397</span>
<span class="normal">5398</span>
<span class="normal">5399</span>
<span class="normal">5400</span>
<span class="normal">5401</span>
<span class="normal">5402</span>
<span class="normal">5403</span>
<span class="normal">5404</span>
<span class="normal">5405</span>
<span class="normal">5406</span>
<span class="normal">5407</span>
<span class="normal">5408</span>
<span class="normal">5409</span>
<span class="normal">5410</span>
<span class="normal">5411</span>
<span class="normal">5412</span>
<span class="normal">5413</span>
<span class="normal">5414</span>
<span class="normal">5415</span>
<span class="normal">5416</span>
<span class="normal">5417</span>
<span class="normal">5418</span>
<span class="normal">5419</span>
<span class="normal">5420</span>
<span class="normal">5421</span>
<span class="normal">5422</span>
<span class="normal">5423</span>
<span class="normal">5424</span>
<span class="normal">5425</span>
<span class="normal">5426</span>
<span class="normal">5427</span>
<span class="normal">5428</span>
<span class="normal">5429</span>
<span class="normal">5430</span>
<span class="normal">5431</span>
<span class="normal">5432</span>
<span class="normal">5433</span>
<span class="normal">5434</span>
<span class="normal">5435</span>
<span class="normal">5436</span>
<span class="normal">5437</span>
<span class="normal">5438</span>
<span class="normal">5439</span>
<span class="normal">5440</span>
<span class="normal">5441</span>
<span class="normal">5442</span>
<span class="normal">5443</span>
<span class="normal">5444</span>
<span class="normal">5445</span>
<span class="normal">5446</span>
<span class="normal">5447</span>
<span class="normal">5448</span>
<span class="normal">5449</span>
<span class="normal">5450</span>
<span class="normal">5451</span>
<span class="normal">5452</span>
<span class="normal">5453</span>
<span class="normal">5454</span>
<span class="normal">5455</span>
<span class="normal">5456</span>
<span class="normal">5457</span>
<span class="normal">5458</span>
<span class="normal">5459</span>
<span class="normal">5460</span>
<span class="normal">5461</span>
<span class="normal">5462</span>
<span class="normal">5463</span>
<span class="normal">5464</span>
<span class="normal">5465</span>
<span class="normal">5466</span>
<span class="normal">5467</span>
<span class="normal">5468</span>
<span class="normal">5469</span>
<span class="normal">5470</span>
<span class="normal">5471</span>
<span class="normal">5472</span>
<span class="normal">5473</span>
<span class="normal">5474</span>
<span class="normal">5475</span>
<span class="normal">5476</span>
<span class="normal">5477</span>
<span class="normal">5478</span>
<span class="normal">5479</span>
<span class="normal">5480</span>
<span class="normal">5481</span>
<span class="normal">5482</span>
<span class="normal">5483</span>
<span class="normal">5484</span>
<span class="normal">5485</span>
<span class="normal">5486</span>
<span class="normal">5487</span>
<span class="normal">5488</span>
<span class="normal">5489</span>
<span class="normal">5490</span>
<span class="normal">5491</span>
<span class="normal">5492</span>
<span class="normal">5493</span>
<span class="normal">5494</span>
<span class="normal">5495</span>
<span class="normal">5496</span>
<span class="normal">5497</span>
<span class="normal">5498</span>
<span class="normal">5499</span>
<span class="normal">5500</span>
<span class="normal">5501</span>
<span class="normal">5502</span>
<span class="normal">5503</span>
<span class="normal">5504</span>
<span class="normal">5505</span>
<span class="normal">5506</span>
<span class="normal">5507</span>
<span class="normal">5508</span>
<span class="normal">5509</span>
<span class="normal">5510</span>
<span class="normal">5511</span>
<span class="normal">5512</span>
<span class="normal">5513</span>
<span class="normal">5514</span>
<span class="normal">5515</span>
<span class="normal">5516</span>
<span class="normal">5517</span>
<span class="normal">5518</span>
<span class="normal">5519</span>
<span class="normal">5520</span>
<span class="normal">5521</span>
<span class="normal">5522</span>
<span class="normal">5523</span>
<span class="normal">5524</span>
<span class="normal">5525</span>
<span class="normal">5526</span>
<span class="normal">5527</span>
<span class="normal">5528</span>
<span class="normal">5529</span>
<span class="normal">5530</span>
<span class="normal">5531</span>
<span class="normal">5532</span>
<span class="normal">5533</span>
<span class="normal">5534</span>
<span class="normal">5535</span>
<span class="normal">5536</span>
<span class="normal">5537</span>
<span class="normal">5538</span>
<span class="normal">5539</span>
<span class="normal">5540</span>
<span class="normal">5541</span>
<span class="normal">5542</span>
<span class="normal">5543</span>
<span class="normal">5544</span>
<span class="normal">5545</span>
<span class="normal">5546</span>
<span class="normal">5547</span>
<span class="normal">5548</span>
<span class="normal">5549</span>
<span class="normal">5550</span>
<span class="normal">5551</span>
<span class="normal">5552</span>
<span class="normal">5553</span>
<span class="normal">5554</span>
<span class="normal">5555</span>
<span class="normal">5556</span>
<span class="normal">5557</span>
<span class="normal">5558</span>
<span class="normal">5559</span>
<span class="normal">5560</span>
<span class="normal">5561</span>
<span class="normal">5562</span>
<span class="normal">5563</span>
<span class="normal">5564</span>
<span class="normal">5565</span>
<span class="normal">5566</span>
<span class="normal">5567</span>
<span class="normal">5568</span>
<span class="normal">5569</span>
<span class="normal">5570</span>
<span class="normal">5571</span>
<span class="normal">5572</span>
<span class="normal">5573</span>
<span class="normal">5574</span>
<span class="normal">5575</span>
<span class="normal">5576</span>
<span class="normal">5577</span>
<span class="normal">5578</span>
<span class="normal">5579</span>
<span class="normal">5580</span>
<span class="normal">5581</span>
<span class="normal">5582</span>
<span class="normal">5583</span>
<span class="normal">5584</span>
<span class="normal">5585</span>
<span class="normal">5586</span>
<span class="normal">5587</span>
<span class="normal">5588</span>
<span class="normal">5589</span>
<span class="normal">5590</span>
<span class="normal">5591</span>
<span class="normal">5592</span>
<span class="normal">5593</span>
<span class="normal">5594</span>
<span class="normal">5595</span>
<span class="normal">5596</span>
<span class="normal">5597</span>
<span class="normal">5598</span>
<span class="normal">5599</span>
<span class="normal">5600</span>
<span class="normal">5601</span>
<span class="normal">5602</span>
<span class="normal">5603</span>
<span class="normal">5604</span>
<span class="normal">5605</span>
<span class="normal">5606</span>
<span class="normal">5607</span>
<span class="normal">5608</span>
<span class="normal">5609</span>
<span class="normal">5610</span>
<span class="normal">5611</span>
<span class="normal">5612</span>
<span class="normal">5613</span>
<span class="normal">5614</span>
<span class="normal">5615</span>
<span class="normal">5616</span>
<span class="normal">5617</span>
<span class="normal">5618</span>
<span class="normal">5619</span>
<span class="normal">5620</span>
<span class="normal">5621</span>
<span class="normal">5622</span>
<span class="normal">5623</span>
<span class="normal">5624</span>
<span class="normal">5625</span>
<span class="normal">5626</span>
<span class="normal">5627</span>
<span class="normal">5628</span>
<span class="normal">5629</span>
<span class="normal">5630</span>
<span class="normal">5631</span>
<span class="normal">5632</span>
<span class="normal">5633</span>
<span class="normal">5634</span>
<span class="normal">5635</span>
<span class="normal">5636</span>
<span class="normal">5637</span>
<span class="normal">5638</span>
<span class="normal">5639</span>
<span class="normal">5640</span>
<span class="normal">5641</span>
<span class="normal">5642</span>
<span class="normal">5643</span>
<span class="normal">5644</span>
<span class="normal">5645</span>
<span class="normal">5646</span>
<span class="normal">5647</span>
<span class="normal">5648</span>
<span class="normal">5649</span>
<span class="normal">5650</span>
<span class="normal">5651</span>
<span class="normal">5652</span>
<span class="normal">5653</span>
<span class="normal">5654</span>
<span class="normal">5655</span>
<span class="normal">5656</span>
<span class="normal">5657</span>
<span class="normal">5658</span>
<span class="normal">5659</span>
<span class="normal">5660</span>
<span class="normal">5661</span>
<span class="normal">5662</span>
<span class="normal">5663</span>
<span class="normal">5664</span>
<span class="normal">5665</span>
<span class="normal">5666</span>
<span class="normal">5667</span>
<span class="normal">5668</span>
<span class="normal">5669</span>
<span class="normal">5670</span>
<span class="normal">5671</span>
<span class="normal">5672</span>
<span class="normal">5673</span>
<span class="normal">5674</span>
<span class="normal">5675</span>
<span class="normal">5676</span>
<span class="normal">5677</span>
<span class="normal">5678</span>
<span class="normal">5679</span>
<span class="normal">5680</span>
<span class="normal">5681</span>
<span class="normal">5682</span>
<span class="normal">5683</span>
<span class="normal">5684</span>
<span class="normal">5685</span>
<span class="normal">5686</span>
<span class="normal">5687</span>
<span class="normal">5688</span>
<span class="normal">5689</span>
<span class="normal">5690</span>
<span class="normal">5691</span>
<span class="normal">5692</span>
<span class="normal">5693</span>
<span class="normal">5694</span>
<span class="normal">5695</span>
<span class="normal">5696</span>
<span class="normal">5697</span>
<span class="normal">5698</span>
<span class="normal">5699</span>
<span class="normal">5700</span>
<span class="normal">5701</span>
<span class="normal">5702</span>
<span class="normal">5703</span>
<span class="normal">5704</span>
<span class="normal">5705</span>
<span class="normal">5706</span>
<span class="normal">5707</span>
<span class="normal">5708</span>
<span class="normal">5709</span>
<span class="normal">5710</span>
<span class="normal">5711</span>
<span class="normal">5712</span>
<span class="normal">5713</span>
<span class="normal">5714</span>
<span class="normal">5715</span>
<span class="normal">5716</span>
<span class="normal">5717</span>
<span class="normal">5718</span>
<span class="normal">5719</span>
<span class="normal">5720</span>
<span class="normal">5721</span>
<span class="normal">5722</span>
<span class="normal">5723</span>
<span class="normal">5724</span>
<span class="normal">5725</span>
<span class="normal">5726</span>
<span class="normal">5727</span>
<span class="normal">5728</span>
<span class="normal">5729</span>
<span class="normal">5730</span>
<span class="normal">5731</span>
<span class="normal">5732</span>
<span class="normal">5733</span>
<span class="normal">5734</span>
<span class="normal">5735</span>
<span class="normal">5736</span>
<span class="normal">5737</span>
<span class="normal">5738</span>
<span class="normal">5739</span>
<span class="normal">5740</span>
<span class="normal">5741</span>
<span class="normal">5742</span>
<span class="normal">5743</span>
<span class="normal">5744</span>
<span class="normal">5745</span>
<span class="normal">5746</span>
<span class="normal">5747</span>
<span class="normal">5748</span>
<span class="normal">5749</span>
<span class="normal">5750</span>
<span class="normal">5751</span>
<span class="normal">5752</span>
<span class="normal">5753</span>
<span class="normal">5754</span>
<span class="normal">5755</span>
<span class="normal">5756</span>
<span class="normal">5757</span>
<span class="normal">5758</span>
<span class="normal">5759</span>
<span class="normal">5760</span>
<span class="normal">5761</span>
<span class="normal">5762</span>
<span class="normal">5763</span>
<span class="normal">5764</span>
<span class="normal">5765</span>
<span class="normal">5766</span>
<span class="normal">5767</span>
<span class="normal">5768</span>
<span class="normal">5769</span>
<span class="normal">5770</span>
<span class="normal">5771</span>
<span class="normal">5772</span>
<span class="normal">5773</span>
<span class="normal">5774</span>
<span class="normal">5775</span>
<span class="normal">5776</span>
<span class="normal">5777</span>
<span class="normal">5778</span>
<span class="normal">5779</span>
<span class="normal">5780</span>
<span class="normal">5781</span>
<span class="normal">5782</span>
<span class="normal">5783</span>
<span class="normal">5784</span>
<span class="normal">5785</span>
<span class="normal">5786</span>
<span class="normal">5787</span>
<span class="normal">5788</span>
<span class="normal">5789</span>
<span class="normal">5790</span>
<span class="normal">5791</span>
<span class="normal">5792</span>
<span class="normal">5793</span>
<span class="normal">5794</span>
<span class="normal">5795</span>
<span class="normal">5796</span>
<span class="normal">5797</span>
<span class="normal">5798</span>
<span class="normal">5799</span>
<span class="normal">5800</span>
<span class="normal">5801</span>
<span class="normal">5802</span>
<span class="normal">5803</span>
<span class="normal">5804</span>
<span class="normal">5805</span>
<span class="normal">5806</span>
<span class="normal">5807</span>
<span class="normal">5808</span>
<span class="normal">5809</span>
<span class="normal">5810</span>
<span class="normal">5811</span>
<span class="normal">5812</span>
<span class="normal">5813</span>
<span class="normal">5814</span>
<span class="normal">5815</span>
<span class="normal">5816</span>
<span class="normal">5817</span>
<span class="normal">5818</span>
<span class="normal">5819</span>
<span class="normal">5820</span>
<span class="normal">5821</span>
<span class="normal">5822</span>
<span class="normal">5823</span>
<span class="normal">5824</span>
<span class="normal">5825</span>
<span class="normal">5826</span>
<span class="normal">5827</span>
<span class="normal">5828</span>
<span class="normal">5829</span>
<span class="normal">5830</span>
<span class="normal">5831</span>
<span class="normal">5832</span>
<span class="normal">5833</span>
<span class="normal">5834</span>
<span class="normal">5835</span>
<span class="normal">5836</span>
<span class="normal">5837</span>
<span class="normal">5838</span>
<span class="normal">5839</span>
<span class="normal">5840</span>
<span class="normal">5841</span>
<span class="normal">5842</span>
<span class="normal">5843</span>
<span class="normal">5844</span>
<span class="normal">5845</span>
<span class="normal">5846</span>
<span class="normal">5847</span>
<span class="normal">5848</span>
<span class="normal">5849</span>
<span class="normal">5850</span>
<span class="normal">5851</span>
<span class="normal">5852</span>
<span class="normal">5853</span>
<span class="normal">5854</span>
<span class="normal">5855</span>
<span class="normal">5856</span>
<span class="normal">5857</span>
<span class="normal">5858</span>
<span class="normal">5859</span>
<span class="normal">5860</span>
<span class="normal">5861</span>
<span class="normal">5862</span>
<span class="normal">5863</span>
<span class="normal">5864</span>
<span class="normal">5865</span>
<span class="normal">5866</span>
<span class="normal">5867</span>
<span class="normal">5868</span>
<span class="normal">5869</span>
<span class="normal">5870</span>
<span class="normal">5871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_training_data</span><span class="p">(</span>
    <span class="n">in_raster</span><span class="p">,</span>
    <span class="n">out_folder</span><span class="p">,</span>
    <span class="n">in_class_data</span><span class="p">,</span>
    <span class="n">image_chip_format</span><span class="o">=</span><span class="s2">&quot;GEOTIFF&quot;</span><span class="p">,</span>
    <span class="n">tile_size_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">tile_size_y</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">stride_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stride_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_nofeature_tiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">metadata_format</span><span class="o">=</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span>
    <span class="n">start_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">class_value_field</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">in_mask_polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rotation_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">reference_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">blacken_around_feature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">crop_mode</span><span class="o">=</span><span class="s2">&quot;FIXED_SIZE&quot;</span><span class="p">,</span>  <span class="c1"># Implemented but not fully used yet</span>
    <span class="n">in_raster2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">in_instance_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">instance_class_value_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Implemented but not fully used yet</span>
    <span class="n">min_polygon_overlap_ratio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export training data for deep learning using TorchGeo with progress bar.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_raster (str): Path to input raster image.</span>
<span class="sd">        out_folder (str): Output folder path where chips and labels will be saved.</span>
<span class="sd">        in_class_data (str): Path to vector file containing class polygons.</span>
<span class="sd">        image_chip_format (str): Output image format (PNG, JPEG, TIFF, GEOTIFF).</span>
<span class="sd">        tile_size_x (int): Width of image chips in pixels.</span>
<span class="sd">        tile_size_y (int): Height of image chips in pixels.</span>
<span class="sd">        stride_x (int): Horizontal stride between chips. If None, uses tile_size_x.</span>
<span class="sd">        stride_y (int): Vertical stride between chips. If None, uses tile_size_y.</span>
<span class="sd">        output_nofeature_tiles (bool): Whether to export chips without features.</span>
<span class="sd">        metadata_format (str): Output metadata format (PASCAL_VOC, KITTI, COCO).</span>
<span class="sd">        start_index (int): Starting index for chip filenames.</span>
<span class="sd">        class_value_field (str): Field name in in_class_data containing class values.</span>
<span class="sd">        buffer_radius (float): Buffer radius around features (in CRS units).</span>
<span class="sd">        in_mask_polygons (str): Path to vector file containing mask polygons.</span>
<span class="sd">        rotation_angle (float): Rotation angle in degrees.</span>
<span class="sd">        reference_system (str): Reference system code.</span>
<span class="sd">        blacken_around_feature (bool): Whether to mask areas outside of features.</span>
<span class="sd">        crop_mode (str): Crop mode (FIXED_SIZE, CENTERED_ON_FEATURE).</span>
<span class="sd">        in_raster2 (str): Path to secondary raster image.</span>
<span class="sd">        in_instance_data (str): Path to vector file containing instance polygons.</span>
<span class="sd">        instance_class_value_field (str): Field name in in_instance_data for instance classes.</span>
<span class="sd">        min_polygon_overlap_ratio (float): Minimum overlap ratio for polygons.</span>
<span class="sd">        all_touched (bool): Whether to use all_touched=True in rasterization.</span>
<span class="sd">        save_geotiff (bool): Whether to save as GeoTIFF with georeferencing.</span>
<span class="sd">        quiet (bool): If True, suppress most output messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create output directories</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Define annotation directories based on metadata format</span>
    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">:</span>
        <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
        <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Initialize COCO annotations dictionary</span>
        <span class="n">coco_annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1"># Initialize statistics dictionary</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;feature_pixels&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Open raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raster info for </span><span class="si">{</span><span class="n">in_raster</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Dimensions: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bounds: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Set defaults for stride if not provided</span>
        <span class="k">if</span> <span class="n">stride_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stride_x</span> <span class="o">=</span> <span class="n">tile_size_x</span>
        <span class="k">if</span> <span class="n">stride_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stride_y</span> <span class="o">=</span> <span class="n">tile_size_y</span>

        <span class="c1"># Calculate number of tiles in x and y directions</span>
        <span class="n">num_tiles_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_tiles_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">num_tiles_x</span> <span class="o">*</span> <span class="n">num_tiles_y</span>

        <span class="c1"># Read class data</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> features from </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available columns: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GeoJSON CRS: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if class_value_field exists</span>
        <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;WARNING: &#39;</span><span class="si">{</span><span class="n">class_value_field</span><span class="si">}</span><span class="s2">&#39; field not found in the input data. Using default class value 1.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Add a default class column</span>
            <span class="n">gdf</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">unique_classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Print unique classes for debugging</span>
            <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes: </span><span class="si">{</span><span class="n">unique_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># CRITICAL: Always reproject to match raster CRS to ensure proper alignment</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting features from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reference_system</span> <span class="ow">and</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">reference_system</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reprojecting features to specified reference system </span><span class="si">{</span><span class="n">reference_system</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">reference_system</span><span class="p">)</span>

        <span class="c1"># Check overlap between raster and vector data</span>
        <span class="n">raster_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">vector_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_bounds</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">vector_bounds</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;WARNING: The vector data doesn&#39;t intersect with the raster extent!&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster bounds: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector bounds: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">raster_bounds</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">vector_bounds</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">vector_bounds</span><span class="o">.</span><span class="n">area</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap between raster and vector: </span><span class="si">{</span><span class="n">overlap</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Apply buffer if specified</span>
        <span class="k">if</span> <span class="n">buffer_radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_radius</span><span class="p">)</span>

        <span class="c1"># Initialize class mapping (ensure all classes are mapped to non-zero values)</span>
        <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)}</span>

        <span class="c1"># Store category info for COCO format</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cls_val</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
                <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">class_to_id</span><span class="p">[</span><span class="n">cls_val</span><span class="p">],</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cls_val</span><span class="p">),</span>
                        <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Load mask polygons if provided</span>
        <span class="n">mask_gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">in_mask_polygons</span><span class="p">:</span>
            <span class="n">mask_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_mask_polygons</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_system</span><span class="p">:</span>
                <span class="n">mask_gdf</span> <span class="o">=</span> <span class="n">mask_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">reference_system</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mask_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">mask_gdf</span> <span class="o">=</span> <span class="n">mask_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Process instance data if provided</span>
        <span class="n">instance_gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">in_instance_data</span><span class="p">:</span>
            <span class="n">instance_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_instance_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_system</span><span class="p">:</span>
                <span class="n">instance_gdf</span> <span class="o">=</span> <span class="n">instance_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">reference_system</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">instance_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">instance_gdf</span> <span class="o">=</span> <span class="n">instance_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Load secondary raster if provided</span>
        <span class="n">src2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">in_raster2</span><span class="p">:</span>
            <span class="n">src2</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_raster2</span><span class="p">)</span>

        <span class="c1"># Set up augmentation if rotation is specified</span>
        <span class="n">augmentation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rotation_angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Fixed: Added data_keys parameter to AugmentationSequential</span>
            <span class="n">augmentation</span> <span class="o">=</span> <span class="n">torchgeo</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AugmentationSequential</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">RandomRotation</span><span class="p">(</span><span class="n">rotation_angle</span><span class="p">)]),</span>
                <span class="n">data_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>  <span class="c1"># Add data_keys parameter</span>
            <span class="p">)</span>

        <span class="c1"># Initialize annotation ID for COCO format</span>
        <span class="n">ann_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Create progress bar</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_tiles</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generating tiles (with features: 0)&quot;</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> [</span><span class="si">{elapsed}</span><span class="s2">&lt;</span><span class="si">{remaining}</span><span class="s2">, </span><span class="si">{rate_fmt}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Generate tiles</span>
        <span class="n">chip_index</span> <span class="o">=</span> <span class="n">start_index</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_x</span><span class="p">):</span>
                <span class="c1"># Calculate window coordinates</span>
                <span class="n">window_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">stride_x</span>
                <span class="n">window_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">stride_y</span>

                <span class="c1"># Adjust for edge cases</span>
                <span class="k">if</span> <span class="n">window_x</span> <span class="o">+</span> <span class="n">tile_size_x</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                    <span class="n">window_x</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size_x</span>
                <span class="k">if</span> <span class="n">window_y</span> <span class="o">+</span> <span class="n">tile_size_y</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                    <span class="n">window_y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size_y</span>

                <span class="c1"># Adjust window based on crop_mode</span>
                <span class="k">if</span> <span class="n">crop_mode</span> <span class="o">==</span> <span class="s2">&quot;CENTERED_ON_FEATURE&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Find the nearest feature to the center of this window</span>
                    <span class="n">window_center_x</span> <span class="o">=</span> <span class="n">window_x</span> <span class="o">+</span> <span class="n">tile_size_x</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">window_center_y</span> <span class="o">=</span> <span class="n">window_y</span> <span class="o">+</span> <span class="n">tile_size_y</span> <span class="o">//</span> <span class="mi">2</span>

                    <span class="c1"># Convert center to world coordinates</span>
                    <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">window_center_y</span><span class="p">,</span> <span class="n">window_center_x</span><span class="p">)</span>
                    <span class="n">center_point</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">([</span><span class="n">center_x</span><span class="p">],</span> <span class="p">[</span><span class="n">center_y</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Find nearest feature</span>
                    <span class="n">distances</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">center_point</span><span class="p">)</span>
                    <span class="n">nearest_idx</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
                    <span class="n">nearest_feature</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">nearest_idx</span><span class="p">]</span>

                    <span class="c1"># Get centroid of nearest feature</span>
                    <span class="n">feature_centroid</span> <span class="o">=</span> <span class="n">nearest_feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>

                    <span class="c1"># Convert feature centroid to pixel coordinates</span>
                    <span class="n">feature_row</span><span class="p">,</span> <span class="n">feature_col</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                        <span class="n">feature_centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">feature_centroid</span><span class="o">.</span><span class="n">y</span>
                    <span class="p">)</span>

                    <span class="c1"># Adjust window to center on feature</span>
                    <span class="n">window_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size_x</span><span class="p">,</span> <span class="n">feature_col</span> <span class="o">-</span> <span class="n">tile_size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">window_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size_y</span><span class="p">,</span> <span class="n">feature_row</span> <span class="o">-</span> <span class="n">tile_size_y</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Define window</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">window_x</span><span class="p">,</span> <span class="n">window_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">,</span> <span class="n">tile_size_y</span><span class="p">)</span>

                <span class="c1"># Get window transform and bounds in source CRS</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Calculate window bounds more explicitly and accurately</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Upper left x</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Upper left y</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">tile_size_x</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Add width</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">maxy</span> <span class="o">+</span> <span class="n">tile_size_y</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">)</span>  <span class="c1"># Add height (note: transform[4] is typically negative)</span>

                <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

                <span class="c1"># Apply rotation if specified</span>
                <span class="k">if</span> <span class="n">rotation_angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span>
                        <span class="n">window_bounds</span><span class="p">,</span> <span class="n">rotation_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Find features that intersect with window</span>
                <span class="n">window_features</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)]</span>

                <span class="c1"># Process instance data if provided</span>
                <span class="n">window_instances</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">instance_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">instance_class_value_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">window_instances</span> <span class="o">=</span> <span class="n">instance_gdf</span><span class="p">[</span>
                        <span class="n">instance_gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">window_instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances in tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                <span class="c1"># Skip if no features and output_nofeature_tiles is False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">output_nofeature_tiles</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still update progress bar</span>
                    <span class="k">continue</span>

                <span class="c1"># Check polygon overlap ratio if specified</span>
                <span class="k">if</span> <span class="n">min_polygon_overlap_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">valid_features</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">overlap_ratio</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
                            <span class="o">/</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">overlap_ratio</span> <span class="o">&gt;=</span> <span class="n">min_polygon_overlap_ratio</span><span class="p">:</span>
                            <span class="n">valid_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">window_features</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">valid_features</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">output_nofeature_tiles</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still update progress bar</span>
                        <span class="k">continue</span>

                <span class="c1"># Apply mask if provided</span>
                <span class="k">if</span> <span class="n">mask_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mask_features</span> <span class="o">=</span> <span class="n">mask_gdf</span><span class="p">[</span><span class="n">mask_gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still update progress bar</span>
                        <span class="k">continue</span>

                <span class="c1"># Read image data - keep original for GeoTIFF export</span>
                <span class="n">orig_image_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Create a copy for processing</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">orig_image_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># Normalize image data for processing</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">band_max</span> <span class="o">&gt;</span> <span class="n">band_min</span><span class="p">:</span>
                        <span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">band_max</span> <span class="o">-</span> <span class="n">band_min</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                        <span class="p">)</span>

                <span class="c1"># Read secondary image data if provided</span>
                <span class="k">if</span> <span class="n">src2</span><span class="p">:</span>
                    <span class="n">image_data2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                    <span class="c1"># Stack the two images</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">image_data</span><span class="p">,</span> <span class="n">image_data2</span><span class="p">))</span>

                <span class="c1"># Apply blacken_around_feature if needed</span>
                <span class="k">if</span> <span class="n">blacken_around_feature</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Project feature to pixel coordinates</span>
                        <span class="n">feature_pixels</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                            <span class="p">[(</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
                            <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span>
                            <span class="n">transform</span><span class="o">=</span><span class="n">window_transform</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">feature_pixels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>

                    <span class="c1"># Apply mask to image</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">temp</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span>

                <span class="c1"># Apply rotation if specified</span>
                <span class="k">if</span> <span class="n">augmentation</span><span class="p">:</span>
                    <span class="c1"># Convert to torch tensor for augmentation</span>
                    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span>
                        <span class="mi">0</span>
                    <span class="p">)</span>  <span class="c1"># Add batch dimension</span>
                    <span class="c1"># Apply augmentation with proper data format</span>
                    <span class="n">augmented</span> <span class="o">=</span> <span class="n">augmentation</span><span class="p">({</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_tensor</span><span class="p">})</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">augmented</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="p">)</span>  <span class="c1"># Remove batch dimension</span>

                <span class="c1"># Create a processed version for regular image formats</span>
                <span class="n">processed_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_data</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="c1"># Create label mask</span>
                <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">has_features</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Get class value</span>
                        <span class="n">class_val</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span>
                            <span class="k">else</span> <span class="mi">1</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="c1"># If class is a string, use its position in the unique classes list</span>
                            <span class="n">class_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If class is already a number, use it directly</span>
                            <span class="n">class_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">class_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">class_val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                        <span class="c1"># Get the geometry in pixel coordinates</span>
                        <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Rasterize the feature</span>
                                <span class="n">feature_mask</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                                    <span class="p">[(</span><span class="n">geom</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)],</span>
                                    <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span>
                                    <span class="n">transform</span><span class="o">=</span><span class="n">window_transform</span><span class="p">,</span>
                                    <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="c1"># Update mask with higher class values taking precedence</span>
                                <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">label_mask</span><span class="p">,</span> <span class="n">feature_mask</span><span class="p">)</span>

                                <span class="c1"># Check if any pixels were added</span>
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_mask</span><span class="p">):</span>
                                    <span class="n">has_features</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rasterizing feature </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Save as GeoTIFF if requested</span>
                <span class="k">if</span> <span class="n">save_geotiff</span> <span class="ow">or</span> <span class="n">image_chip_format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;TIFF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TIF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;GEOTIFF&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="c1"># Standardize extension to .tif for GeoTIFF files</span>
                    <span class="n">image_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>

                    <span class="c1"># Create profile for the GeoTIFF</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size_y</span><span class="p">,</span>
                            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size_x</span><span class="p">,</span>
                            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">orig_image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="c1"># Save the GeoTIFF with original data</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">orig_image_data</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ERROR saving image GeoTIFF for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For non-GeoTIFF formats, use PIL to save the image</span>
                    <span class="n">image_filename</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">image_chip_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>

                    <span class="c1"># Create PIL image for saving</span>
                    <span class="k">if</span> <span class="n">processed_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">processed_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">processed_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># For RGB, need to transpose and make sure it&#39;s the right data type</span>
                        <span class="n">rgb_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">processed_image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For multiband images, save only RGB or first three bands</span>
                        <span class="n">rgb_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">processed_image</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_data</span><span class="p">)</span>

                    <span class="c1"># Save image</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving image for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Save label as GeoTIFF</span>
                <span class="n">label_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">label_filename</span><span class="p">)</span>

                <span class="c1"># Create profile for label GeoTIFF</span>
                <span class="n">label_profile</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size_y</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size_x</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Save label GeoTIFF</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">label_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">has_features</span><span class="p">:</span>
                        <span class="n">pixel_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">label_mask</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;feature_pixels&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pixel_count</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving label for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Also save a PNG version for easy visualization if requested</span>
                <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Ensure correct data type for PIL</span>
                        <span class="n">png_label</span> <span class="o">=</span> <span class="n">label_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                        <span class="n">label_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">png_label</span><span class="p">)</span>
                        <span class="n">label_png_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.png&quot;</span>
                        <span class="p">)</span>
                        <span class="n">label_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">label_png_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ERROR saving PNG label for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;  Label mask shape: </span><span class="si">{</span><span class="n">label_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">label_mask</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="c1"># Try again with explicit conversion</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Alternative approach for problematic arrays</span>
                                <span class="n">png_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                                <span class="p">)</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">png_data</span><span class="p">,</span> <span class="n">label_mask</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s2">&quot;unsafe&quot;</span><span class="p">)</span>
                                <span class="n">label_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">png_data</span><span class="p">)</span>
                                <span class="n">label_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">label_png_path</span><span class="p">)</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;  Succeeded using alternative conversion method&quot;</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Second attempt also failed: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Generate annotations</span>
                <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Create XML annotation</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;folder&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;images&quot;</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">image_filename</span>

                    <span class="n">size</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>

                    <span class="c1"># Add georeference information</span>
                    <span class="n">geo</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;georeference&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;crs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">window_transform</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Convert feature geometry to pixel coordinates</span>
                        <span class="n">feature_bounds</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get pixel coordinates of bounds</span>
                        <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">bounds</span>

                        <span class="c1"># Convert to pixel coordinates</span>
                        <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                        <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                        <span class="c1"># Ensure coordinates are within bounds</span>
                        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                        <span class="c1"># Skip if box is too small</span>
                        <span class="k">if</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;difficult&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

                        <span class="n">bbox</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;bndbox&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>

                    <span class="c1"># Save XML</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                        <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ERROR saving XML annotation for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Add image info</span>
                    <span class="n">image_id</span> <span class="o">=</span> <span class="n">chip_index</span>
                    <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">image_filename</span><span class="p">,</span>
                            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size_x</span><span class="p">,</span>
                            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size_y</span><span class="p">,</span>
                            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">),</span>
                            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">window_transform</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="c1"># Add annotations for each feature</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">feature_bounds</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get pixel coordinates of bounds</span>
                        <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">bounds</span>

                        <span class="c1"># Convert to pixel coordinates</span>
                        <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                        <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                        <span class="c1"># Ensure coordinates are within bounds</span>
                        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                        <span class="c1"># Skip if box is too small</span>
                        <span class="k">if</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
                        <span class="n">height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>

                        <span class="c1"># Add annotation</span>
                        <span class="n">ann_id</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">category_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]]</span>

                        <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ann_id</span><span class="p">,</span>
                                <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                                <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="n">category_id</span><span class="p">,</span>
                                <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span>
                                <span class="s2">&quot;iscrowd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                <span class="c1"># Update progress bar</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, With features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">chip_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Close progress bar</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Save COCO annotations if applicable</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="s2">&quot;instances.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving COCO annotations: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Close secondary raster if opened</span>
        <span class="k">if</span> <span class="n">src2</span><span class="p">:</span>
            <span class="n">src2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Print summary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Export Summary -------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles exported: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Tiles with features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Average feature pixels per tile: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;feature_pixels&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors encountered: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to: </span><span class="si">{</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Verify georeference in a sample image and label</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Georeference Verification -------&quot;</span><span class="p">)</span>
            <span class="n">sample_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
            <span class="n">sample_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_image</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_image</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image CRS: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image transform: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Image has georeference: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying image georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_label</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_label</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbl</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label CRS: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label transform: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Label has georeference: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Label dimensions: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying label georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return statistics</span>
    <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">out_folder</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.geojson_to_coords" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">geojson_to_coords</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">src_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.geojson_to_coords" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a geojson file or a dictionary of feature collection to a list of centroid coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>geojson</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The geojson file path or a dictionary of feature collection.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>src_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source CRS. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dst_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The destination CRS. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of centroid coordinates in the format of [[x1, y1], [x2, y2], ...]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8436</span>
<span class="normal">8437</span>
<span class="normal">8438</span>
<span class="normal">8439</span>
<span class="normal">8440</span>
<span class="normal">8441</span>
<span class="normal">8442</span>
<span class="normal">8443</span>
<span class="normal">8444</span>
<span class="normal">8445</span>
<span class="normal">8446</span>
<span class="normal">8447</span>
<span class="normal">8448</span>
<span class="normal">8449</span>
<span class="normal">8450</span>
<span class="normal">8451</span>
<span class="normal">8452</span>
<span class="normal">8453</span>
<span class="normal">8454</span>
<span class="normal">8455</span>
<span class="normal">8456</span>
<span class="normal">8457</span>
<span class="normal">8458</span>
<span class="normal">8459</span>
<span class="normal">8460</span>
<span class="normal">8461</span>
<span class="normal">8462</span>
<span class="normal">8463</span>
<span class="normal">8464</span>
<span class="normal">8465</span>
<span class="normal">8466</span>
<span class="normal">8467</span>
<span class="normal">8468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">geojson_to_coords</span><span class="p">(</span>
    <span class="n">geojson</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a geojson file or a dictionary of feature collection to a list of centroid coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        geojson (str | dict): The geojson file path or a dictionary of feature collection.</span>
<span class="sd">        src_crs (str, optional): The source CRS. Defaults to &quot;epsg:4326&quot;.</span>
<span class="sd">        dst_crs (str, optional): The destination CRS. Defaults to &quot;epsg:4326&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of centroid coordinates in the format of [[x1, y1], [x2, y2], ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">geojson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">geojson</span><span class="p">)</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>
    <span class="n">centroid_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">centroids</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">src_crs</span> <span class="o">!=</span> <span class="n">dst_crs</span><span class="p">:</span>
        <span class="n">centroid_list</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">centroid_list</span><span class="p">],</span>
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">centroid_list</span><span class="p">],</span>
            <span class="n">src_crs</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">centroid_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centroid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">centroid_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.geojson_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">geojson_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">geojson</span><span class="p">,</span> <span class="n">coord_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.geojson_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a geojson file or a dictionary of feature collection to a list of pixel coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>geojson</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The geojson file path or a dictionary of feature collection.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coord_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coordinate CRS of the input coordinates. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rasterio.transform.rowcol.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of pixel coordinates in the format of [[x1, y1], [x2, y2], ...]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8729</span>
<span class="normal">8730</span>
<span class="normal">8731</span>
<span class="normal">8732</span>
<span class="normal">8733</span>
<span class="normal">8734</span>
<span class="normal">8735</span>
<span class="normal">8736</span>
<span class="normal">8737</span>
<span class="normal">8738</span>
<span class="normal">8739</span>
<span class="normal">8740</span>
<span class="normal">8741</span>
<span class="normal">8742</span>
<span class="normal">8743</span>
<span class="normal">8744</span>
<span class="normal">8745</span>
<span class="normal">8746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">geojson_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">geojson</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a geojson file or a dictionary of feature collection to a list of pixel coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp: The source raster file path.</span>
<span class="sd">        geojson: The geojson file path or a dictionary of feature collection.</span>
<span class="sd">        coord_crs: The coordinate CRS of the input coordinates. Defaults to &quot;epsg:4326&quot;.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rasterio.transform.rowcol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of pixel coordinates in the format of [[x1, y1], [x2, y2], ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">src_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">geojson_to_coords</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coords_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_device" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_device</span><span class="p">()</span></code>

<a href="#geoai.geoai.get_device" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Returns the best available device for deep learning in the order:
CUDA (NVIDIA GPU) &gt; MPS (Apple Silicon GPU) &gt; CPU</p>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8941</span>
<span class="normal">8942</span>
<span class="normal">8943</span>
<span class="normal">8944</span>
<span class="normal">8945</span>
<span class="normal">8946</span>
<span class="normal">8947</span>
<span class="normal">8948</span>
<span class="normal">8949</span>
<span class="normal">8950</span>
<span class="normal">8951</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_device</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the best available device for deep learning in the order:</span>
<span class="sd">    CUDA (NVIDIA GPU) &gt; MPS (Apple Silicon GPU) &gt; CPU</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="p">,</span> <span class="s2">&quot;mps&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;mps&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_model_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_model_config</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_model_config" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the model configuration for a Hugging Face model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Hugging Face model ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="transformers.configuration_utils.PretrainedConfig">PretrainedConfig</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>transformers.configuration_utils.PretrainedConfig: The model configuration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_config</span><span class="p">(</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;transformers.configuration_utils.PretrainedConfig&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the model configuration for a Hugging Face model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_id (str): The Hugging Face model ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        transformers.configuration_utils.PretrainedConfig: The model configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_model_input_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_model_input_channels</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_model_input_channels" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Check the number of input channels supported by a Hugging Face model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Hugging Face model ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of input channels the model accepts.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to determine the number of input channels.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_input_channels</span><span class="p">(</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the number of input channels supported by a Hugging Face model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_id (str): The Hugging Face model ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of input channels the model accepts.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If unable to determine the number of input channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the model configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>

    <span class="c1"># For Mask2Former models</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;backbone_config&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">backbone_config</span><span class="p">,</span> <span class="s2">&quot;num_channels&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">backbone_config</span><span class="o">.</span><span class="n">num_channels</span>

    <span class="c1"># Try to load the model and inspect its architecture</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForMaskedImageModeling</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>

        <span class="c1"># For Swin Transformer-based models like Mask2Former</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;backbone&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="s2">&quot;embeddings&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span> <span class="s2">&quot;patch_embeddings&quot;</span><span class="p">):</span>
                <span class="c1"># Swin models typically have patch embeddings that indicate channel count</span>
                <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">patch_embeddings</span><span class="o">.</span><span class="n">in_channels</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t inspect model architecture: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Default for most vision models</span>
    <span class="k">return</span> <span class="mi">3</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_raster_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_raster_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Display basic information about a raster dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the raster</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display basic information about a raster dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the raster dataset</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get basic metadata</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span> <span class="k">else</span> <span class="s2">&quot;No CRS defined&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Calculate statistics for each band</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">band_stats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span>
            <span class="p">}</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_stats</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;band_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_raster_info_gdal" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_info_gdal</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_raster_info_gdal" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get basic information about a raster dataset using GDAL.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the raster,
or None if the file cannot be opened</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_info_gdal</span><span class="p">(</span><span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get basic information about a raster dataset using GDAL.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the raster,</span>
<span class="sd">            or None if the file cannot be opened</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">gdal</span>

    <span class="c1"># Open the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Could not open </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Get basic information</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span><span class="o">.</span><span class="n">ShortName</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">,</span>
        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">,</span>
        <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">(),</span>
        <span class="s2">&quot;geotransform&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># Calculate resolution</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gt</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Get band information</span>
    <span class="n">bands_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetStatistics</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">band_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDataTypeName</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">DataType</span><span class="p">),</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">bands_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_info</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands_info</span>

    <span class="c1"># Close the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_raster_resolution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_resolution</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_raster_resolution" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get pixel resolution from the raster using rasterio.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the raster image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of (x resolution, y resolution).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">9088</span>
<span class="normal">9089</span>
<span class="normal">9090</span>
<span class="normal">9091</span>
<span class="normal">9092</span>
<span class="normal">9093</span>
<span class="normal">9094</span>
<span class="normal">9095</span>
<span class="normal">9096</span>
<span class="normal">9097</span>
<span class="normal">9098</span>
<span class="normal">9099</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_resolution</span><span class="p">(</span><span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get pixel resolution from the raster using rasterio.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_path: The path to the raster image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of (x resolution, y resolution).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">res</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_raster_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_raster_stats" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate statistics for each band in a raster dataset.</p>
<p>This function computes min, max, mean, and standard deviation values
for each band in the provided raster, returning results in a dictionary
with lists for each statistic type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>divide_by</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to divide pixel values by.
Defaults to 1.0, which keeps the original pixel</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing lists of statistics with keys:
- 'min': List of minimum values for each band
- 'max': List of maximum values for each band
- 'mean': List of mean values for each band
- 'std': List of standard deviation values for each band</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">divide_by</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate statistics for each band in a raster dataset.</span>

<span class="sd">    This function computes min, max, mean, and standard deviation values</span>
<span class="sd">    for each band in the provided raster, returning results in a dictionary</span>
<span class="sd">    with lists for each statistic type.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>
<span class="sd">        divide_by (float, optional): Value to divide pixel values by.</span>
<span class="sd">            Defaults to 1.0, which keeps the original pixel</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing lists of statistics with keys:</span>
<span class="sd">            - &#39;min&#39;: List of minimum values for each band</span>
<span class="sd">            - &#39;max&#39;: List of maximum values for each band</span>
<span class="sd">            - &#39;mean&#39;: List of mean values for each band</span>
<span class="sd">            - &#39;std&#39;: List of standard deviation values for each band</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize the results dictionary with empty lists</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1"># Open the raster dataset</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Calculate statistics for each band</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Append statistics for this band to each list</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_vector_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_vector_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Display basic information about a vector dataset using GeoPandas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the vector dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display basic information about a vector dataset using GeoPandas.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the vector dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the vector dataset</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vector_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get basic metadata</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">vector_path</span><span class="p">,</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>  <span class="c1"># Format from extension</span>
        <span class="s2">&quot;feature_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">),</span>
        <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">),</span>
        <span class="s2">&quot;geometry_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()),</span>
        <span class="s2">&quot;attribute_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Subtract the geometry column</span>
        <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># Add statistics about numeric attributes</span>
    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">attribute_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span>
            <span class="n">attribute_stats</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                <span class="s2">&quot;null_count&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">}</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;attribute_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute_stats</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.get_vector_info_ogr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vector_info_ogr</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.get_vector_info_ogr" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get basic information about a vector dataset using OGR.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the vector dataset,
or None if the file cannot be opened</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_vector_info_ogr</span><span class="p">(</span><span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get basic information about a vector dataset using OGR.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the vector dataset,</span>
<span class="sd">            or None if the file cannot be opened</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">ogr</span>

    <span class="c1"># Register all OGR drivers</span>
    <span class="n">ogr</span><span class="o">.</span><span class="n">RegisterAll</span><span class="p">()</span>

    <span class="c1"># Open the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Could not open </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Basic dataset information</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">vector_path</span><span class="p">,</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
        <span class="s2">&quot;layer_count&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetLayerCount</span><span class="p">(),</span>
        <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># Extract information for each layer</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetLayerCount</span><span class="p">()):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetLayer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">layer_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
            <span class="s2">&quot;feature_count&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">(),</span>
            <span class="s2">&quot;geometry_type&quot;</span><span class="p">:</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GeometryTypeToName</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetGeomType</span><span class="p">()),</span>
            <span class="s2">&quot;spatial_ref&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">()</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">()</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetExtent</span><span class="p">(),</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Get field information</span>
        <span class="n">defn</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">defn</span><span class="o">.</span><span class="n">GetFieldCount</span><span class="p">()):</span>
            <span class="n">field_defn</span> <span class="o">=</span> <span class="n">defn</span><span class="o">.</span><span class="n">GetFieldDefn</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">field_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetTypeName</span><span class="p">(),</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetWidth</span><span class="p">(),</span>
                <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetPrecision</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="n">layer_info</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_info</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_info</span><span class="p">)</span>

    <span class="c1"># Close the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.hybrid_regularization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">hybrid_regularization</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">)</span></code>

<a href="#geoai.geoai.hybrid_regularization" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>A comprehensive hybrid approach to building footprint regularization.</p>
<p>Applies different strategies based on building characteristics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>building_polygons</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons containing building footprints</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hybrid_regularization</span><span class="p">(</span>
    <span class="n">building_polygons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A comprehensive hybrid approach to building footprint regularization.</span>

<span class="sd">    Applies different strategies based on building characteristics.</span>

<span class="sd">    Args:</span>
<span class="sd">        building_polygons: GeoDataFrame or list of shapely Polygons containing building footprints</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame or list of shapely Polygons with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Use minimum_rotated_rectangle instead of oriented_envelope</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.minimum_rotated_rectangle</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimum_rotated_rectangle</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># For older Shapely versions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">minimum_rotated_rectangle</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calculate the minimum rotated rectangle for a geometry&quot;&quot;&quot;</span>
            <span class="c1"># For older Shapely versions, implement a simple version</span>
            <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">minimum_rotated_rectangle</span>

    <span class="c1"># Determine input type for correct return</span>
    <span class="n">is_gdf</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)</span>

    <span class="c1"># Extract geometries if GeoDataFrame</span>
    <span class="k">if</span> <span class="n">is_gdf</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">geom_objects</span><span class="p">:</span>
        <span class="c1"># 1. Analyze building characteristics</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">building</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Calculate shape complexity metrics</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>

        <span class="c1"># Calculate dominant angle</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">segment_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">segment_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># Weight angles by segment length</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">segment_angles</span> <span class="o">%</span> <span class="mi">180</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">segment_lengths</span>
        <span class="p">)</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">dominant_angle</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">)]</span>

        <span class="c1"># Check if building is close to orthogonal</span>
        <span class="n">is_orthogonal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dominant_angle</span> <span class="o">%</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span> <span class="o">-</span> <span class="p">(</span><span class="n">dominant_angle</span> <span class="o">%</span> <span class="mi">45</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">5</span>

        <span class="c1"># 2. Apply appropriate regularization strategy</span>
        <span class="k">if</span> <span class="n">complexity</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="c1"># Complex buildings: use minimum rotated rectangle</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimum_rotated_rectangle</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_orthogonal</span><span class="p">:</span>
            <span class="c1"># Near-orthogonal buildings: orthogonalize in place</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Create orthogonal hull in rotated space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">ortho_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">ortho_hull</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Diagonal buildings: use custom approach for diagonal buildings</span>
            <span class="c1"># Rotate to align with axes</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Simplify in rotated space</span>
            <span class="n">simplified</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Get the bounds in rotated space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">simplified</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="c1"># Create a rectangular hull in rotated space</span>
            <span class="n">rect_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">),</span> <span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="c1"># Rotate back to original orientation</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">rect_poly</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Return in same format as input</span>
    <span class="k">if</span> <span class="n">is_gdf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">building_polygons</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.image_segmentation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">image_segmentation</span><span class="p">(</span><span class="n">tif_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">labels_to_extract</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">segmenter_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.image_segmentation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Segments an image with a Hugging Face segmentation model and saves the results
as a single georeferenced image where each class has a unique integer value.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tif_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input georeferenced TIF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the output georeferenced segmentation will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels_to_extract</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of labels to extract. If None, extracts all labels.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type to use for the output mask. Defaults to "uint8".</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint8&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the Hugging Face model to use for segmentation,
such as "facebook/mask2former-swin-large-cityscapes-semantic". Defaults to None.
See https://huggingface.co/models?pipeline_tag=image-segmentation&amp;sort=trending for options.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segmenter_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments to pass to the segmenter.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the segmentation pipeline</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(Path to saved image, dictionary mapping label names to their assigned values,
dictionary mapping label names to confidence scores)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">image_segmentation</span><span class="p">(</span>
    <span class="n">tif_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">labels_to_extract</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">segmenter_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segments an image with a Hugging Face segmentation model and saves the results</span>
<span class="sd">    as a single georeferenced image where each class has a unique integer value.</span>

<span class="sd">    Args:</span>
<span class="sd">        tif_path (str): Path to the input georeferenced TIF file.</span>
<span class="sd">        output_path (str): Path where the output georeferenced segmentation will be saved.</span>
<span class="sd">        labels_to_extract (list, optional): List of labels to extract. If None, extracts all labels.</span>
<span class="sd">        dtype (str, optional): Data type to use for the output mask. Defaults to &quot;uint8&quot;.</span>
<span class="sd">        model_name (str, optional): Name of the Hugging Face model to use for segmentation,</span>
<span class="sd">            such as &quot;facebook/mask2former-swin-large-cityscapes-semantic&quot;. Defaults to None.</span>
<span class="sd">            See https://huggingface.co/models?pipeline_tag=image-segmentation&amp;sort=trending for options.</span>
<span class="sd">        segmenter_args (dict, optional): Additional arguments to pass to the segmenter.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the segmentation pipeline</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Path to saved image, dictionary mapping label names to their assigned values,</span>
<span class="sd">            dictionary mapping label names to confidence scores)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the original georeferenced image to extract metadata</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tif_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Save the metadata for later use</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Get the dimensions</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="c1"># Get the transform and CRS for georeferencing</span>
        <span class="c1"># transform = src.transform</span>
        <span class="c1"># crs = src.crs</span>

    <span class="c1"># Initialize the segmentation pipeline</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;facebook/mask2former-swin-large-cityscapes-semantic&quot;</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;image-segmentation&quot;</span>

    <span class="n">segmenter</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Run the segmentation on the GeoTIFF</span>
    <span class="k">if</span> <span class="n">segmenter_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">segmenter_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">segments</span> <span class="o">=</span> <span class="n">segmenter</span><span class="p">(</span><span class="n">tif_path</span><span class="p">,</span> <span class="o">**</span><span class="n">segmenter_args</span><span class="p">)</span>

    <span class="c1"># If no specific labels are requested, extract all available ones</span>
    <span class="k">if</span> <span class="n">labels_to_extract</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels_to_extract</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>

    <span class="c1"># Create an empty mask to hold all the labels</span>
    <span class="c1"># Using uint8 for up to 255 classes, switch to uint16 for more</span>
    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Create a dictionary to map labels to values and store scores</span>
    <span class="n">label_to_value</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">label_to_score</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process each segment we want to keep</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">labels_to_extract</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="c1"># Assign a unique value to each label (starting from 1)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>

        <span class="n">label_to_value</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">label_to_score</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="c1"># Convert PIL image to numpy array</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">])</span>

        <span class="c1"># Apply a threshold if it&#39;s a probability mask (not binary)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Resize if needed to match original dimensions</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
            <span class="n">mask_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">mask_img</span> <span class="o">=</span> <span class="n">mask_img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_img</span><span class="p">)</span>

        <span class="c1"># Add this class to the combined mask</span>
        <span class="c1"># Only overwrite if the pixel isn&#39;t already assigned to another class</span>
        <span class="c1"># This handles overlapping segments by giving priority to earlier segments</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">combined_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">combined_mask</span>
        <span class="p">)</span>

    <span class="c1"># Update metadata for the output raster</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># One band for the mask</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>  <span class="c1"># Use uint8 for up to 255 classes</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0 represents no class</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Save the mask as a new georeferenced GeoTIFF</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>  <span class="c1"># Add channel dimension</span>

    <span class="c1"># Create a CSV colormap file with scores included</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_colormap.csv&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ClassValue&quot;</span><span class="p">,</span> <span class="s2">&quot;ClassName&quot;</span><span class="p">,</span> <span class="s2">&quot;ConfidenceScore&quot;</span><span class="p">]</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>

        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">label_to_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;ClassValue&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;ClassName&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                    <span class="s2">&quot;ConfidenceScore&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_to_score</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">label_to_value</span><span class="p">,</span> <span class="n">label_to_score</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.inspect_pth_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">inspect_pth_file</span><span class="p">(</span><span class="n">pth_path</span><span class="p">)</span></code>

<a href="#geoai.geoai.inspect_pth_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Inspect a PyTorch .pth model file to determine its architecture.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pth_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth file to inspect</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the model architecture</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7926</span>
<span class="normal">7927</span>
<span class="normal">7928</span>
<span class="normal">7929</span>
<span class="normal">7930</span>
<span class="normal">7931</span>
<span class="normal">7932</span>
<span class="normal">7933</span>
<span class="normal">7934</span>
<span class="normal">7935</span>
<span class="normal">7936</span>
<span class="normal">7937</span>
<span class="normal">7938</span>
<span class="normal">7939</span>
<span class="normal">7940</span>
<span class="normal">7941</span>
<span class="normal">7942</span>
<span class="normal">7943</span>
<span class="normal">7944</span>
<span class="normal">7945</span>
<span class="normal">7946</span>
<span class="normal">7947</span>
<span class="normal">7948</span>
<span class="normal">7949</span>
<span class="normal">7950</span>
<span class="normal">7951</span>
<span class="normal">7952</span>
<span class="normal">7953</span>
<span class="normal">7954</span>
<span class="normal">7955</span>
<span class="normal">7956</span>
<span class="normal">7957</span>
<span class="normal">7958</span>
<span class="normal">7959</span>
<span class="normal">7960</span>
<span class="normal">7961</span>
<span class="normal">7962</span>
<span class="normal">7963</span>
<span class="normal">7964</span>
<span class="normal">7965</span>
<span class="normal">7966</span>
<span class="normal">7967</span>
<span class="normal">7968</span>
<span class="normal">7969</span>
<span class="normal">7970</span>
<span class="normal">7971</span>
<span class="normal">7972</span>
<span class="normal">7973</span>
<span class="normal">7974</span>
<span class="normal">7975</span>
<span class="normal">7976</span>
<span class="normal">7977</span>
<span class="normal">7978</span>
<span class="normal">7979</span>
<span class="normal">7980</span>
<span class="normal">7981</span>
<span class="normal">7982</span>
<span class="normal">7983</span>
<span class="normal">7984</span>
<span class="normal">7985</span>
<span class="normal">7986</span>
<span class="normal">7987</span>
<span class="normal">7988</span>
<span class="normal">7989</span>
<span class="normal">7990</span>
<span class="normal">7991</span>
<span class="normal">7992</span>
<span class="normal">7993</span>
<span class="normal">7994</span>
<span class="normal">7995</span>
<span class="normal">7996</span>
<span class="normal">7997</span>
<span class="normal">7998</span>
<span class="normal">7999</span>
<span class="normal">8000</span>
<span class="normal">8001</span>
<span class="normal">8002</span>
<span class="normal">8003</span>
<span class="normal">8004</span>
<span class="normal">8005</span>
<span class="normal">8006</span>
<span class="normal">8007</span>
<span class="normal">8008</span>
<span class="normal">8009</span>
<span class="normal">8010</span>
<span class="normal">8011</span>
<span class="normal">8012</span>
<span class="normal">8013</span>
<span class="normal">8014</span>
<span class="normal">8015</span>
<span class="normal">8016</span>
<span class="normal">8017</span>
<span class="normal">8018</span>
<span class="normal">8019</span>
<span class="normal">8020</span>
<span class="normal">8021</span>
<span class="normal">8022</span>
<span class="normal">8023</span>
<span class="normal">8024</span>
<span class="normal">8025</span>
<span class="normal">8026</span>
<span class="normal">8027</span>
<span class="normal">8028</span>
<span class="normal">8029</span>
<span class="normal">8030</span>
<span class="normal">8031</span>
<span class="normal">8032</span>
<span class="normal">8033</span>
<span class="normal">8034</span>
<span class="normal">8035</span>
<span class="normal">8036</span>
<span class="normal">8037</span>
<span class="normal">8038</span>
<span class="normal">8039</span>
<span class="normal">8040</span>
<span class="normal">8041</span>
<span class="normal">8042</span>
<span class="normal">8043</span>
<span class="normal">8044</span>
<span class="normal">8045</span>
<span class="normal">8046</span>
<span class="normal">8047</span>
<span class="normal">8048</span>
<span class="normal">8049</span>
<span class="normal">8050</span>
<span class="normal">8051</span>
<span class="normal">8052</span>
<span class="normal">8053</span>
<span class="normal">8054</span>
<span class="normal">8055</span>
<span class="normal">8056</span>
<span class="normal">8057</span>
<span class="normal">8058</span>
<span class="normal">8059</span>
<span class="normal">8060</span>
<span class="normal">8061</span>
<span class="normal">8062</span>
<span class="normal">8063</span>
<span class="normal">8064</span>
<span class="normal">8065</span>
<span class="normal">8066</span>
<span class="normal">8067</span>
<span class="normal">8068</span>
<span class="normal">8069</span>
<span class="normal">8070</span>
<span class="normal">8071</span>
<span class="normal">8072</span>
<span class="normal">8073</span>
<span class="normal">8074</span>
<span class="normal">8075</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inspect_pth_file</span><span class="p">(</span><span class="n">pth_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect a PyTorch .pth model file to determine its architecture.</span>

<span class="sd">    Args:</span>
<span class="sd">        pth_path: Path to the .pth file to inspect</span>

<span class="sd">    Returns:</span>
<span class="sd">        Information about the model architecture</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pth_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: File </span><span class="si">{</span><span class="n">pth_path</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Load the checkpoint</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pth_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inspecting model file: </span><span class="si">{</span><span class="n">pth_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if it&#39;s a state_dict or a complete model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;state_dict&quot;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &#39;state_dict&#39; key in the checkpoint.&quot;</span><span class="p">)</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;model_state_dict&quot;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &#39;model_state_dict&#39; key in the checkpoint.&quot;</span><span class="p">)</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assuming file contains a direct state_dict.&quot;</span><span class="p">)</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span>

            <span class="c1"># Print the keys in the checkpoint</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checkpoint contains the following keys:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (dictionary with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">}</span><span class="s2"> items)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (shape/size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="w"> </span><span class="nb">tuple</span><span class="p">))</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Try to infer the model architecture from the state_dict keys</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analyzing model architecture from state_dict...&quot;</span><span class="p">)</span>

            <span class="c1"># Extract layer keys for analysis</span>
            <span class="n">layer_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Print the first few layer keys to understand naming pattern</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 10 layer names in state_dict:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer_keys</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (shape: </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Look for architecture indicators in the keys</span>
            <span class="n">architecture_indicators</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;conv&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;bn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;layer&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;fc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;backbone&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;encoder&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;decoder&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;unet&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;resnet&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;classifier&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;deeplab&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;fcn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layer_keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">architecture_indicators</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">architecture_indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Architecture indicators found in layer names:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">architecture_indicators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- &#39;</span><span class="si">{</span><span class="n">indicator</span><span class="si">}</span><span class="s2">&#39; appears </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> times&quot;</span><span class="p">)</span>

            <span class="c1"># Count total parameters</span>
            <span class="n">total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total parameters: </span><span class="si">{</span><span class="n">total_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Try to load the model with different architectures</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attempting to match with common architectures...&quot;</span><span class="p">)</span>

            <span class="c1"># Try to identify if it&#39;s a segmentation model</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;out&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">layer_keys</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model appears to be a segmentation model.&quot;</span><span class="p">)</span>

                <span class="c1"># Check if it might be a UNet</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;encoder&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;decoder&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Architecture seems to be a UNet-based model with encoder-decoder structure.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Check for FCN or DeepLab indicators</span>
                <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;fcn&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Architecture seems to be FCN-based (Fully Convolutional Network).&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;deeplab&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Architecture seems to be DeepLab-based.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;backbone&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Model has a backbone architecture, likely a modern segmentation model.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Try to infer output classes from the final layer</span>
            <span class="n">output_layer_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">layer_keys</span> <span class="k">if</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.out.weight&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">output_layer_keys</span><span class="p">:</span>
                <span class="n">output_shape</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">output_layer_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">num_classes</span> <span class="o">=</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model likely has </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2"> output classes.&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SUMMARY:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model appears to be&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;unet&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a UNet architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;fcn&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;an FCN architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;deeplab&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a DeepLab architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;resnet&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ResNet-based.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a custom architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

            <span class="c1"># Try to load with common models</span>
            <span class="n">try_common_architectures</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;The file contains an entire model object rather than just a state dictionary.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># If it&#39;s a complete model, we can directly examine its architecture</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading the model file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.install_package" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">install_package</span><span class="p">(</span><span class="n">package</span><span class="p">)</span></code>

<a href="#geoai.geoai.install_package" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Install a Python package.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>package</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The package name or a GitHub URL or a list of package names or GitHub URLs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">install_package</span><span class="p">(</span><span class="n">package</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Install a Python package.</span>

<span class="sd">    Args:</span>
<span class="sd">        package (str | list): The package name or a GitHub URL or a list of package names or GitHub URLs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">package</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">package</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The package argument must be a string or a list of strings.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">):</span>
            <span class="n">package</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;git+</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Execute pip install command and show output in real-time</span>
        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pip install </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="c1"># Print output in real-time</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Wait for process to complete</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.mask_generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mask_generation</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_mask_path</span><span class="p">,</span> <span class="n">output_csv_path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;facebook/sam-vit-base&#39;</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">points_per_side</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">band_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_object_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">generator_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.mask_generation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Process a GeoTIFF using SAM mask generation and save results as a GeoTIFF and CSV.</p>
<p>The function reads a GeoTIFF image, applies the SAM mask generator from the
Hugging Face transformers pipeline, rasterizes the resulting masks to create
a labeled mask GeoTIFF, and saves mask scores and geometries to a CSV file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input GeoTIFF image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_mask_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the output mask GeoTIFF will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_csv_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the mask scores CSV will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HuggingFace model checkpoint for the SAM model.</p>
              </div>
            </td>
            <td>
                  <code>&#39;facebook/sam-vit-base&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence score for masks to be included.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>points_per_side</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of points to sample along each side of the image.</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crop_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of image crops for processing. If None, process the full image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band_indices</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices to use. If None, use all bands.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for inference.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_object_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum size in pixels for objects to be included. Smaller masks will be filtered out.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generator_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the mask generator.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing the paths to the saved mask GeoTIFF and CSV file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input file cannot be opened or processed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If mask generation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mask_generation</span><span class="p">(</span>
    <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_mask_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;facebook/sam-vit-base&quot;</span><span class="p">,</span>
    <span class="n">confidence_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">points_per_side</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">crop_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">band_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_object_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">generator_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a GeoTIFF using SAM mask generation and save results as a GeoTIFF and CSV.</span>

<span class="sd">    The function reads a GeoTIFF image, applies the SAM mask generator from the</span>
<span class="sd">    Hugging Face transformers pipeline, rasterizes the resulting masks to create</span>
<span class="sd">    a labeled mask GeoTIFF, and saves mask scores and geometries to a CSV file.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_path: Path to the input GeoTIFF image.</span>
<span class="sd">        output_mask_path: Path where the output mask GeoTIFF will be saved.</span>
<span class="sd">        output_csv_path: Path where the mask scores CSV will be saved.</span>
<span class="sd">        model: HuggingFace model checkpoint for the SAM model.</span>
<span class="sd">        confidence_threshold: Minimum confidence score for masks to be included.</span>
<span class="sd">        points_per_side: Number of points to sample along each side of the image.</span>
<span class="sd">        crop_size: Size of image crops for processing. If None, process the full image.</span>
<span class="sd">        band_indices: List of band indices to use. If None, use all bands.</span>
<span class="sd">        batch_size: Batch size for inference.</span>
<span class="sd">        min_object_size: Minimum size in pixels for objects to be included. Smaller masks will be filtered out.</span>
<span class="sd">        generator_kwargs: Additional keyword arguments to pass to the mask generator.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple containing the paths to the saved mask GeoTIFF and CSV file.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input file cannot be opened or processed.</span>
<span class="sd">        RuntimeError: If mask generation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up the mask generator</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up mask generator...&quot;</span><span class="p">)</span>
    <span class="n">mask_generator</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;mask-generation&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Open the GeoTIFF file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading input GeoTIFF: </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># Read metadata</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
            <span class="c1"># transform = src.transform</span>
            <span class="c1"># crs = src.crs</span>

            <span class="c1"># Read the image data</span>
            <span class="k">if</span> <span class="n">band_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using specified bands: </span><span class="si">{</span><span class="n">band_indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">band_indices</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using all bands&quot;</span><span class="p">)</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="c1"># Handle image with more than 3 bands (convert to RGB for visualization)</span>
            <span class="k">if</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Converting </span><span class="si">{</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bands to RGB (using first 3 bands)&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Select first three bands or perform other band combination</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Duplicating single band to create 3-band image&quot;</span><span class="p">)</span>
                <span class="c1"># Duplicate single band to create a 3-band image</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">image_data</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Transpose to HWC format for the model</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="c1"># Normalize the image if needed</span>
            <span class="k">if</span> <span class="n">image_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalizing image from </span><span class="si">{</span><span class="n">image_data</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> to uint8&quot;</span><span class="p">)</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_data</span> <span class="o">/</span> <span class="n">image_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open or process input GeoTIFF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Process the image with the mask generator</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Convert numpy array to PIL Image for the pipeline</span>
        <span class="c1"># Ensure the array is in the right format (HWC and uint8)</span>
        <span class="k">if</span> <span class="n">image_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_data</span> <span class="o">/</span> <span class="n">image_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Create a PIL Image from the numpy array</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting to PIL Image for mask generation&quot;</span><span class="p">)</span>
        <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>

        <span class="c1"># Use the SAM pipeline for mask generation</span>
        <span class="k">if</span> <span class="n">generator_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generator_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running mask generation...&quot;</span><span class="p">)</span>
        <span class="n">mask_results</span> <span class="o">=</span> <span class="n">mask_generator</span><span class="p">(</span>
            <span class="n">pil_image</span><span class="p">,</span>
            <span class="n">points_per_side</span><span class="o">=</span><span class="n">points_per_side</span><span class="p">,</span>
            <span class="n">crop_n_points_downscale_factor</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">point_grids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">pred_iou_thresh</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">stability_score_thresh</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">crops_n_layers</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">crop_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">crop_overlap_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="o">**</span><span class="n">generator_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of initial masks: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_results</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_results</span><span class="p">,</span><span class="w"> </span><span class="nb">dict</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s1">&#39;masks&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">mask_results</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">mask_results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create a mask raster with unique IDs for each mask</span>
    <span class="n">mask_raster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">mask_records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each mask based on the structure of mask_results</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="ow">and</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">in</span> <span class="n">mask_results</span>
        <span class="ow">and</span> <span class="s2">&quot;scores&quot;</span> <span class="ow">in</span> <span class="n">mask_results</span>
    <span class="p">):</span>
        <span class="c1"># Handle dictionary with &#39;masks&#39; and &#39;scores&#39; lists</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing masks...&quot;</span><span class="p">)</span>
        <span class="n">total_masks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_results</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">])</span>

        <span class="c1"># Create progress bar</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">tqdm</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">mask_results</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">],</span> <span class="n">mask_results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]),</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total_masks</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing masks&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">mask_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Start IDs at 1</span>

            <span class="c1"># Convert to numpy if not already</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="c1"># Try to convert from tensor or other format if needed</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert mask at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to numpy array&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">mask_binary</span> <span class="o">=</span> <span class="n">mask_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">area_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_binary</span><span class="p">)</span>

            <span class="c1"># Skip if mask is smaller than the minimum size</span>
            <span class="k">if</span> <span class="n">area_pixels</span> <span class="o">&lt;</span> <span class="n">min_object_size</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Add the mask to the raster with a unique ID</span>
            <span class="n">mask_raster</span><span class="p">[</span><span class="n">mask_binary</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>

            <span class="c1"># Create a record for the CSV - without geometry calculation</span>
            <span class="n">mask_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;mask_id&quot;</span><span class="p">:</span> <span class="n">mask_id</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="s2">&quot;area_pixels&quot;</span><span class="p">:</span> <span class="n">area_pixels</span><span class="p">}</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Handle list of dictionaries format (SAM original format)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing masks...&quot;</span><span class="p">)</span>
        <span class="n">total_masks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_results</span><span class="p">)</span>

        <span class="c1"># Create progress bar</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask_result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">mask_results</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing masks&quot;</span><span class="p">)):</span>
            <span class="n">mask_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Start IDs at 1</span>

            <span class="c1"># Try different possible key names for masks and scores</span>
            <span class="n">mask_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Try to find mask data</span>
                <span class="k">if</span> <span class="s2">&quot;segmentation&quot;</span> <span class="ow">in</span> <span class="n">mask_result</span><span class="p">:</span>
                    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">mask_result</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">mask_result</span><span class="p">:</span>
                    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">mask_result</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>

                <span class="c1"># Try to find score</span>
                <span class="k">if</span> <span class="s2">&quot;score&quot;</span> <span class="ow">in</span> <span class="n">mask_result</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">mask_result</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;predicted_iou&quot;</span> <span class="ow">in</span> <span class="n">mask_result</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">mask_result</span><span class="p">[</span><span class="s2">&quot;predicted_iou&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;stability_score&quot;</span> <span class="ow">in</span> <span class="n">mask_result</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">mask_result</span><span class="p">[</span><span class="s2">&quot;stability_score&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Default score if none found</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If mask_result is not a dict, it might be the mask directly</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_result</span><span class="p">)</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Default score</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not process mask at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">mask_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Convert to numpy if not already</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert mask at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to numpy array&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                <span class="n">mask_binary</span> <span class="o">=</span> <span class="n">mask_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">area_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_binary</span><span class="p">)</span>

                <span class="c1"># Skip if mask is smaller than the minimum size</span>
                <span class="k">if</span> <span class="n">area_pixels</span> <span class="o">&lt;</span> <span class="n">min_object_size</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add the mask to the raster with a unique ID</span>
                <span class="n">mask_raster</span><span class="p">[</span><span class="n">mask_binary</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>

                <span class="c1"># Create a record for the CSV - without geometry calculation</span>
                <span class="n">mask_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;mask_id&quot;</span><span class="p">:</span> <span class="n">mask_id</span><span class="p">,</span>
                        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
                        <span class="s2">&quot;area_pixels&quot;</span><span class="p">:</span> <span class="n">area_pixels</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If we couldn&#39;t figure out the format, raise an error</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected format for mask_results: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mask_results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of final masks (after size filtering): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_records</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Save the mask raster as a GeoTIFF</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving mask GeoTIFF to </span><span class="si">{</span><span class="n">output_mask_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output_profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">output_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_mask_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">output_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_raster</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Save the mask data as a CSV</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving mask metadata to </span><span class="si">{</span><span class="n">output_csv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mask_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mask_records</span><span class="p">)</span>
    <span class="n">mask_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing complete!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_mask_path</span><span class="p">,</span> <span class="n">output_csv_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.masks_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">masks_to_vector</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mask_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_object_area</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_object_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

<a href="#geoai.geoai.masks_to_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a building mask GeoTIFF to vector polygons and save as a vector dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the building masks GeoTIFF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoJSON (default: mask_path with .geojson extension)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for polygon simplification (default: self.simplify_tolerance)</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for mask binarization (default: self.mask_threshold)</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_object_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in pixels to keep a building (default: self.min_object_area)</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_object_area</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum area in pixels to keep a building (default: self.max_object_area)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nms_iou_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5874</span>
<span class="normal">5875</span>
<span class="normal">5876</span>
<span class="normal">5877</span>
<span class="normal">5878</span>
<span class="normal">5879</span>
<span class="normal">5880</span>
<span class="normal">5881</span>
<span class="normal">5882</span>
<span class="normal">5883</span>
<span class="normal">5884</span>
<span class="normal">5885</span>
<span class="normal">5886</span>
<span class="normal">5887</span>
<span class="normal">5888</span>
<span class="normal">5889</span>
<span class="normal">5890</span>
<span class="normal">5891</span>
<span class="normal">5892</span>
<span class="normal">5893</span>
<span class="normal">5894</span>
<span class="normal">5895</span>
<span class="normal">5896</span>
<span class="normal">5897</span>
<span class="normal">5898</span>
<span class="normal">5899</span>
<span class="normal">5900</span>
<span class="normal">5901</span>
<span class="normal">5902</span>
<span class="normal">5903</span>
<span class="normal">5904</span>
<span class="normal">5905</span>
<span class="normal">5906</span>
<span class="normal">5907</span>
<span class="normal">5908</span>
<span class="normal">5909</span>
<span class="normal">5910</span>
<span class="normal">5911</span>
<span class="normal">5912</span>
<span class="normal">5913</span>
<span class="normal">5914</span>
<span class="normal">5915</span>
<span class="normal">5916</span>
<span class="normal">5917</span>
<span class="normal">5918</span>
<span class="normal">5919</span>
<span class="normal">5920</span>
<span class="normal">5921</span>
<span class="normal">5922</span>
<span class="normal">5923</span>
<span class="normal">5924</span>
<span class="normal">5925</span>
<span class="normal">5926</span>
<span class="normal">5927</span>
<span class="normal">5928</span>
<span class="normal">5929</span>
<span class="normal">5930</span>
<span class="normal">5931</span>
<span class="normal">5932</span>
<span class="normal">5933</span>
<span class="normal">5934</span>
<span class="normal">5935</span>
<span class="normal">5936</span>
<span class="normal">5937</span>
<span class="normal">5938</span>
<span class="normal">5939</span>
<span class="normal">5940</span>
<span class="normal">5941</span>
<span class="normal">5942</span>
<span class="normal">5943</span>
<span class="normal">5944</span>
<span class="normal">5945</span>
<span class="normal">5946</span>
<span class="normal">5947</span>
<span class="normal">5948</span>
<span class="normal">5949</span>
<span class="normal">5950</span>
<span class="normal">5951</span>
<span class="normal">5952</span>
<span class="normal">5953</span>
<span class="normal">5954</span>
<span class="normal">5955</span>
<span class="normal">5956</span>
<span class="normal">5957</span>
<span class="normal">5958</span>
<span class="normal">5959</span>
<span class="normal">5960</span>
<span class="normal">5961</span>
<span class="normal">5962</span>
<span class="normal">5963</span>
<span class="normal">5964</span>
<span class="normal">5965</span>
<span class="normal">5966</span>
<span class="normal">5967</span>
<span class="normal">5968</span>
<span class="normal">5969</span>
<span class="normal">5970</span>
<span class="normal">5971</span>
<span class="normal">5972</span>
<span class="normal">5973</span>
<span class="normal">5974</span>
<span class="normal">5975</span>
<span class="normal">5976</span>
<span class="normal">5977</span>
<span class="normal">5978</span>
<span class="normal">5979</span>
<span class="normal">5980</span>
<span class="normal">5981</span>
<span class="normal">5982</span>
<span class="normal">5983</span>
<span class="normal">5984</span>
<span class="normal">5985</span>
<span class="normal">5986</span>
<span class="normal">5987</span>
<span class="normal">5988</span>
<span class="normal">5989</span>
<span class="normal">5990</span>
<span class="normal">5991</span>
<span class="normal">5992</span>
<span class="normal">5993</span>
<span class="normal">5994</span>
<span class="normal">5995</span>
<span class="normal">5996</span>
<span class="normal">5997</span>
<span class="normal">5998</span>
<span class="normal">5999</span>
<span class="normal">6000</span>
<span class="normal">6001</span>
<span class="normal">6002</span>
<span class="normal">6003</span>
<span class="normal">6004</span>
<span class="normal">6005</span>
<span class="normal">6006</span>
<span class="normal">6007</span>
<span class="normal">6008</span>
<span class="normal">6009</span>
<span class="normal">6010</span>
<span class="normal">6011</span>
<span class="normal">6012</span>
<span class="normal">6013</span>
<span class="normal">6014</span>
<span class="normal">6015</span>
<span class="normal">6016</span>
<span class="normal">6017</span>
<span class="normal">6018</span>
<span class="normal">6019</span>
<span class="normal">6020</span>
<span class="normal">6021</span>
<span class="normal">6022</span>
<span class="normal">6023</span>
<span class="normal">6024</span>
<span class="normal">6025</span>
<span class="normal">6026</span>
<span class="normal">6027</span>
<span class="normal">6028</span>
<span class="normal">6029</span>
<span class="normal">6030</span>
<span class="normal">6031</span>
<span class="normal">6032</span>
<span class="normal">6033</span>
<span class="normal">6034</span>
<span class="normal">6035</span>
<span class="normal">6036</span>
<span class="normal">6037</span>
<span class="normal">6038</span>
<span class="normal">6039</span>
<span class="normal">6040</span>
<span class="normal">6041</span>
<span class="normal">6042</span>
<span class="normal">6043</span>
<span class="normal">6044</span>
<span class="normal">6045</span>
<span class="normal">6046</span>
<span class="normal">6047</span>
<span class="normal">6048</span>
<span class="normal">6049</span>
<span class="normal">6050</span>
<span class="normal">6051</span>
<span class="normal">6052</span>
<span class="normal">6053</span>
<span class="normal">6054</span>
<span class="normal">6055</span>
<span class="normal">6056</span>
<span class="normal">6057</span>
<span class="normal">6058</span>
<span class="normal">6059</span>
<span class="normal">6060</span>
<span class="normal">6061</span>
<span class="normal">6062</span>
<span class="normal">6063</span>
<span class="normal">6064</span>
<span class="normal">6065</span>
<span class="normal">6066</span>
<span class="normal">6067</span>
<span class="normal">6068</span>
<span class="normal">6069</span>
<span class="normal">6070</span>
<span class="normal">6071</span>
<span class="normal">6072</span>
<span class="normal">6073</span>
<span class="normal">6074</span>
<span class="normal">6075</span>
<span class="normal">6076</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">masks_to_vector</span><span class="p">(</span>
    <span class="n">mask_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nms_iou_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a building mask GeoTIFF to vector polygons and save as a vector dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask_path: Path to the building masks GeoTIFF</span>
<span class="sd">        output_path: Path to save the output GeoJSON (default: mask_path with .geojson extension)</span>
<span class="sd">        simplify_tolerance: Tolerance for polygon simplification (default: self.simplify_tolerance)</span>
<span class="sd">        mask_threshold: Threshold for mask binarization (default: self.mask_threshold)</span>
<span class="sd">        min_object_area: Minimum area in pixels to keep a building (default: self.min_object_area)</span>
<span class="sd">        max_object_area: Maximum area in pixels to keep a building (default: self.max_object_area)</span>
<span class="sd">        nms_iou_threshold: IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: GeoDataFrame with building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set default output path if not provided</span>
    <span class="c1"># if output_path is None:</span>
    <span class="c1">#     output_path = os.path.splitext(mask_path)[0] + &quot;.geojson&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting mask to GeoJSON with parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min building area: </span><span class="si">{</span><span class="n">min_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Simplify tolerance: </span><span class="si">{</span><span class="n">simplify_tolerance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- NMS IoU threshold: </span><span class="si">{</span><span class="n">nms_iou_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Open the mask raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the mask data</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Print mask statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask dimensions: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask value range: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare for connected component analysis</span>
        <span class="c1"># Binarize the mask based on threshold</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mask_threshold</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Apply morphological operations for better results (optional)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># Find connected components</span>
        <span class="n">num_labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span>
            <span class="n">binary_mask</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_labels</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> potential buildings&quot;</span><span class="p">)</span>  <span class="c1"># Subtract 1 for background</span>

        <span class="c1"># Create list to store polygons and confidence values</span>
        <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_confidences</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each component (skip the first one which is background)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">)):</span>
            <span class="c1"># Extract this building</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CC_STAT_AREA</span><span class="p">]</span>

            <span class="c1"># Skip if too small</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Skip if too large</span>
            <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Create a mask for this building</span>
            <span class="n">building_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Find contours</span>
            <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                <span class="n">building_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
            <span class="p">)</span>

            <span class="c1"># Process each contour</span>
            <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                <span class="c1"># Skip if too few points</span>
                <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Simplify contour if it has many points</span>
                <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">simplify_tolerance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Convert to list of (x, y) coordinates</span>
                <span class="n">polygon_points</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Convert pixel coordinates to geographic coordinates</span>
                <span class="n">geo_points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">polygon_points</span><span class="p">:</span>
                    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">geo_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                <span class="c1"># Create Shapely polygon</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shapely_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely_poly</span><span class="p">)</span>

                            <span class="c1"># Calculate &quot;confidence&quot; as normalized size</span>
                            <span class="c1"># This is a proxy since we don&#39;t have model confidence scores</span>
                            <span class="n">normalized_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">area</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Cap at 1.0</span>
                            <span class="n">all_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_size</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid polygons&quot;</span><span class="p">)</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_polygons</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">all_polygons</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">all_confidences</span><span class="p">,</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Building class</span>
            <span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Filter overlapping polygons using non-maximum suppression.</span>

<span class="sd">            Args:</span>
<span class="sd">                gdf: GeoDataFrame with polygons</span>
<span class="sd">                **kwargs: Optional parameters:</span>
<span class="sd">                    nms_iou_threshold: IoU threshold for filtering</span>

<span class="sd">            Returns:</span>
<span class="sd">                Filtered GeoDataFrame</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gdf</span>

            <span class="c1"># Get parameters from kwargs or use instance defaults</span>
            <span class="n">iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="p">)</span>

            <span class="c1"># Sort by confidence</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Fix any invalid geometries</span>
            <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_valid</span> <span class="k">else</span> <span class="n">geom</span>
            <span class="p">)</span>

            <span class="n">keep_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">polygons</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
                    <span class="c1"># Skip invalid geometries</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Calculate IoU</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">intersection</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">area</span>
                        <span class="n">union</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">-</span> <span class="n">intersection</span>
                        <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span> <span class="k">if</span> <span class="n">union</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">iou_threshold</span><span class="p">:</span>
                            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># Skip on topology exceptions</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>

        <span class="c1"># Apply non-maximum suppression to remove overlapping polygons</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final building count after filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save to file</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> building footprints to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.mosaic_geotiffs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mosaic_geotiffs</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.mosaic_geotiffs" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a mosaic from all GeoTIFF files as a Cloud Optimized GeoTIFF (COG).</p>
<p>This function identifies all GeoTIFF files in the specified directory,
creates a seamless mosaic with proper handling of nodata values, and saves
as a Cloud Optimized GeoTIFF format. If a mask file is provided, the output
will be clipped to the extent of the mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the directory containing GeoTIFF files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output Cloud Optimized GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a mask file to clip the output.
If provided, the output will be clipped to the extent of this mask.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the mosaic was created successfully, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">mosaic_geotiffs</span><span class="p">(</span><span class="s1">&#39;naip&#39;</span><span class="p">,</span> <span class="s1">&#39;merged_naip.tif&#39;</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mosaic_geotiffs</span><span class="p">(</span><span class="s1">&#39;naip&#39;</span><span class="p">,</span> <span class="s1">&#39;merged_naip.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;boundary.tif&#39;</span><span class="p">)</span>
<span class="go">True</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8118</span>
<span class="normal">8119</span>
<span class="normal">8120</span>
<span class="normal">8121</span>
<span class="normal">8122</span>
<span class="normal">8123</span>
<span class="normal">8124</span>
<span class="normal">8125</span>
<span class="normal">8126</span>
<span class="normal">8127</span>
<span class="normal">8128</span>
<span class="normal">8129</span>
<span class="normal">8130</span>
<span class="normal">8131</span>
<span class="normal">8132</span>
<span class="normal">8133</span>
<span class="normal">8134</span>
<span class="normal">8135</span>
<span class="normal">8136</span>
<span class="normal">8137</span>
<span class="normal">8138</span>
<span class="normal">8139</span>
<span class="normal">8140</span>
<span class="normal">8141</span>
<span class="normal">8142</span>
<span class="normal">8143</span>
<span class="normal">8144</span>
<span class="normal">8145</span>
<span class="normal">8146</span>
<span class="normal">8147</span>
<span class="normal">8148</span>
<span class="normal">8149</span>
<span class="normal">8150</span>
<span class="normal">8151</span>
<span class="normal">8152</span>
<span class="normal">8153</span>
<span class="normal">8154</span>
<span class="normal">8155</span>
<span class="normal">8156</span>
<span class="normal">8157</span>
<span class="normal">8158</span>
<span class="normal">8159</span>
<span class="normal">8160</span>
<span class="normal">8161</span>
<span class="normal">8162</span>
<span class="normal">8163</span>
<span class="normal">8164</span>
<span class="normal">8165</span>
<span class="normal">8166</span>
<span class="normal">8167</span>
<span class="normal">8168</span>
<span class="normal">8169</span>
<span class="normal">8170</span>
<span class="normal">8171</span>
<span class="normal">8172</span>
<span class="normal">8173</span>
<span class="normal">8174</span>
<span class="normal">8175</span>
<span class="normal">8176</span>
<span class="normal">8177</span>
<span class="normal">8178</span>
<span class="normal">8179</span>
<span class="normal">8180</span>
<span class="normal">8181</span>
<span class="normal">8182</span>
<span class="normal">8183</span>
<span class="normal">8184</span>
<span class="normal">8185</span>
<span class="normal">8186</span>
<span class="normal">8187</span>
<span class="normal">8188</span>
<span class="normal">8189</span>
<span class="normal">8190</span>
<span class="normal">8191</span>
<span class="normal">8192</span>
<span class="normal">8193</span>
<span class="normal">8194</span>
<span class="normal">8195</span>
<span class="normal">8196</span>
<span class="normal">8197</span>
<span class="normal">8198</span>
<span class="normal">8199</span>
<span class="normal">8200</span>
<span class="normal">8201</span>
<span class="normal">8202</span>
<span class="normal">8203</span>
<span class="normal">8204</span>
<span class="normal">8205</span>
<span class="normal">8206</span>
<span class="normal">8207</span>
<span class="normal">8208</span>
<span class="normal">8209</span>
<span class="normal">8210</span>
<span class="normal">8211</span>
<span class="normal">8212</span>
<span class="normal">8213</span>
<span class="normal">8214</span>
<span class="normal">8215</span>
<span class="normal">8216</span>
<span class="normal">8217</span>
<span class="normal">8218</span>
<span class="normal">8219</span>
<span class="normal">8220</span>
<span class="normal">8221</span>
<span class="normal">8222</span>
<span class="normal">8223</span>
<span class="normal">8224</span>
<span class="normal">8225</span>
<span class="normal">8226</span>
<span class="normal">8227</span>
<span class="normal">8228</span>
<span class="normal">8229</span>
<span class="normal">8230</span>
<span class="normal">8231</span>
<span class="normal">8232</span>
<span class="normal">8233</span>
<span class="normal">8234</span>
<span class="normal">8235</span>
<span class="normal">8236</span>
<span class="normal">8237</span>
<span class="normal">8238</span>
<span class="normal">8239</span>
<span class="normal">8240</span>
<span class="normal">8241</span>
<span class="normal">8242</span>
<span class="normal">8243</span>
<span class="normal">8244</span>
<span class="normal">8245</span>
<span class="normal">8246</span>
<span class="normal">8247</span>
<span class="normal">8248</span>
<span class="normal">8249</span>
<span class="normal">8250</span>
<span class="normal">8251</span>
<span class="normal">8252</span>
<span class="normal">8253</span>
<span class="normal">8254</span>
<span class="normal">8255</span>
<span class="normal">8256</span>
<span class="normal">8257</span>
<span class="normal">8258</span>
<span class="normal">8259</span>
<span class="normal">8260</span>
<span class="normal">8261</span>
<span class="normal">8262</span>
<span class="normal">8263</span>
<span class="normal">8264</span>
<span class="normal">8265</span>
<span class="normal">8266</span>
<span class="normal">8267</span>
<span class="normal">8268</span>
<span class="normal">8269</span>
<span class="normal">8270</span>
<span class="normal">8271</span>
<span class="normal">8272</span>
<span class="normal">8273</span>
<span class="normal">8274</span>
<span class="normal">8275</span>
<span class="normal">8276</span>
<span class="normal">8277</span>
<span class="normal">8278</span>
<span class="normal">8279</span>
<span class="normal">8280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mosaic_geotiffs</span><span class="p">(</span>
    <span class="n">input_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mosaic from all GeoTIFF files as a Cloud Optimized GeoTIFF (COG).</span>

<span class="sd">    This function identifies all GeoTIFF files in the specified directory,</span>
<span class="sd">    creates a seamless mosaic with proper handling of nodata values, and saves</span>
<span class="sd">    as a Cloud Optimized GeoTIFF format. If a mask file is provided, the output</span>
<span class="sd">    will be clipped to the extent of the mask.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_dir (str): Path to the directory containing GeoTIFF files.</span>
<span class="sd">        output_file (str): Path to the output Cloud Optimized GeoTIFF file.</span>
<span class="sd">        mask_file (str, optional): Path to a mask file to clip the output.</span>
<span class="sd">            If provided, the output will be clipped to the extent of this mask.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the mosaic was created successfully, False otherwise.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; mosaic_geotiffs(&#39;naip&#39;, &#39;merged_naip.tif&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; mosaic_geotiffs(&#39;naip&#39;, &#39;merged_naip.tif&#39;, &#39;boundary.tif&#39;)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">gdal</span>

    <span class="n">gdal</span><span class="o">.</span><span class="n">UseExceptions</span><span class="p">()</span>
    <span class="c1"># Get all tif files in the directory</span>
    <span class="n">tif_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s2">&quot;*.tif&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tif_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GeoTIFF files found in the specified directory.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Analyze the first input file to determine compression and nodata settings</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">tif_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to open </span><span class="si">{</span><span class="n">tif_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Get driver metadata from the first file</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span>
    <span class="n">creation_options</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check compression type</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetMetadata</span><span class="p">(</span><span class="s2">&quot;IMAGE_STRUCTURE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;COMPRESSION&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">compression</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;COMPRESSION&quot;</span><span class="p">]</span>
        <span class="n">creation_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COMPRESS=</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default compression if none detected</span>
        <span class="n">creation_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;COMPRESS=LZW&quot;</span><span class="p">)</span>

    <span class="c1"># Add COG-specific creation options</span>
    <span class="n">creation_options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;TILED=YES&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOCKXSIZE=512&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOCKYSIZE=512&quot;</span><span class="p">])</span>

    <span class="c1"># Check for nodata value in the first band of the first file</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">has_nodata</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Close the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create a temporary VRT (Virtual Dataset)</span>
    <span class="n">vrt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s2">&quot;temp_mosaic.vrt&quot;</span><span class="p">)</span>

    <span class="c1"># Build VRT from input files with proper nodata handling</span>
    <span class="n">vrt_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">BuildVRTOptions</span><span class="p">(</span>
        <span class="n">resampleAlg</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="n">srcNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">VRTNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">vrt_dataset</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">BuildVRT</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">,</span> <span class="n">tif_files</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">vrt_options</span><span class="p">)</span>

    <span class="c1"># Close the VRT dataset to flush it to disk</span>
    <span class="n">vrt_dataset</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create temp mosaic</span>
    <span class="n">temp_mosaic</span> <span class="o">=</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot;.temp.tif&quot;</span>

    <span class="c1"># Convert VRT to GeoTIFF with the same compression as input</span>
    <span class="n">translate_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">TranslateOptions</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">creationOptions</span><span class="o">=</span><span class="n">creation_options</span><span class="p">,</span>
        <span class="n">noData</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">vrt_path</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">translate_options</span><span class="p">)</span>

    <span class="c1"># Apply mask if provided</span>
    <span class="k">if</span> <span class="n">mask_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipping mosaic to mask: </span><span class="si">{</span><span class="n">mask_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a temporary clipped file</span>
        <span class="n">clipped_mosaic</span> <span class="o">=</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot;.clipped.tif&quot;</span>

        <span class="c1"># Open mask file</span>
        <span class="n">mask_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to open mask file: </span><span class="si">{</span><span class="n">mask_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Continue without clipping</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get mask extent</span>
            <span class="n">mask_geotransform</span> <span class="o">=</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
            <span class="n">mask_projection</span> <span class="o">=</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
            <span class="n">mask_ulx</span> <span class="o">=</span> <span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mask_uly</span> <span class="o">=</span> <span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">mask_lrx</span> <span class="o">=</span> <span class="n">mask_ulx</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">)</span>
            <span class="n">mask_lry</span> <span class="o">=</span> <span class="n">mask_uly</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">)</span>

            <span class="c1"># Close mask dataset</span>
            <span class="n">mask_ds</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Use warp options to clip</span>
            <span class="n">warp_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">WarpOptions</span><span class="p">(</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                <span class="n">outputBounds</span><span class="o">=</span><span class="p">[</span><span class="n">mask_ulx</span><span class="p">,</span> <span class="n">mask_lry</span><span class="p">,</span> <span class="n">mask_lrx</span><span class="p">,</span> <span class="n">mask_uly</span><span class="p">],</span>
                <span class="n">dstSRS</span><span class="o">=</span><span class="n">mask_projection</span><span class="p">,</span>
                <span class="n">creationOptions</span><span class="o">=</span><span class="n">creation_options</span><span class="p">,</span>
                <span class="n">srcNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">dstNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Apply clipping</span>
            <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">clipped_mosaic</span><span class="p">,</span> <span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">warp_options</span><span class="p">)</span>

            <span class="c1"># Remove the unclipped temp mosaic and use the clipped one</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">)</span>
            <span class="n">temp_mosaic</span> <span class="o">=</span> <span class="n">clipped_mosaic</span>

    <span class="c1"># Create internal overviews for the temp mosaic</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_Update</span><span class="p">)</span>
    <span class="n">overview_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">BuildOverviews</span><span class="p">(</span><span class="s2">&quot;NEAREST&quot;</span><span class="p">,</span> <span class="n">overview_list</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Close the dataset to ensure overviews are written</span>

    <span class="c1"># Convert the temp mosaic to a proper COG</span>
    <span class="n">cog_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">TranslateOptions</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;TILED=YES&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COPY_SRC_OVERVIEWS=YES&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PREDICTOR=2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BLOCKXSIZE=512&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BLOCKYSIZE=512&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">noData</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">cog_options</span><span class="p">)</span>

    <span class="c1"># Clean up temporary files</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloud Optimized GeoTIFF mosaic created successfully: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.orthogonalize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">orthogonalize</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_segments</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">area_tolerance</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">detect_triangles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.geoai.orthogonalize" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Orthogonalizes object masks in a GeoTIFF file.</p>
<p>This function reads a GeoTIFF containing object masks (binary or labeled regions),
converts the raster masks to vector polygons, applies orthogonalization to each polygon,
and optionally writes the result to a GeoJSON file.
The source code is adapted from the Solar Panel Detection algorithm by Esri.
See https://www.arcgis.com/home/item.html?id=c2508d72f2614104bfcfd5ccf1429284.
Credits to Esri for the original code.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoJSON file. If None, no file is saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Simplification tolerance for the Douglas-Peucker algorithm.
Higher values result in more simplification. Default is 0.2.</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area of polygons to process (smaller ones are kept as-is).</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_segments</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum number of segments to keep after simplification.
Default is 4 (for rectangular shapes).</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Allowed ratio of area change. Values less than 1.0 restrict
area change. Default is 0.7 (allows reduction to 70% of original area).</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detect_triangles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, performs additional check to avoid creating triangular shapes.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A GeoDataFrame containing the orthogonalized features.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6891</span>
<span class="normal">6892</span>
<span class="normal">6893</span>
<span class="normal">6894</span>
<span class="normal">6895</span>
<span class="normal">6896</span>
<span class="normal">6897</span>
<span class="normal">6898</span>
<span class="normal">6899</span>
<span class="normal">6900</span>
<span class="normal">6901</span>
<span class="normal">6902</span>
<span class="normal">6903</span>
<span class="normal">6904</span>
<span class="normal">6905</span>
<span class="normal">6906</span>
<span class="normal">6907</span>
<span class="normal">6908</span>
<span class="normal">6909</span>
<span class="normal">6910</span>
<span class="normal">6911</span>
<span class="normal">6912</span>
<span class="normal">6913</span>
<span class="normal">6914</span>
<span class="normal">6915</span>
<span class="normal">6916</span>
<span class="normal">6917</span>
<span class="normal">6918</span>
<span class="normal">6919</span>
<span class="normal">6920</span>
<span class="normal">6921</span>
<span class="normal">6922</span>
<span class="normal">6923</span>
<span class="normal">6924</span>
<span class="normal">6925</span>
<span class="normal">6926</span>
<span class="normal">6927</span>
<span class="normal">6928</span>
<span class="normal">6929</span>
<span class="normal">6930</span>
<span class="normal">6931</span>
<span class="normal">6932</span>
<span class="normal">6933</span>
<span class="normal">6934</span>
<span class="normal">6935</span>
<span class="normal">6936</span>
<span class="normal">6937</span>
<span class="normal">6938</span>
<span class="normal">6939</span>
<span class="normal">6940</span>
<span class="normal">6941</span>
<span class="normal">6942</span>
<span class="normal">6943</span>
<span class="normal">6944</span>
<span class="normal">6945</span>
<span class="normal">6946</span>
<span class="normal">6947</span>
<span class="normal">6948</span>
<span class="normal">6949</span>
<span class="normal">6950</span>
<span class="normal">6951</span>
<span class="normal">6952</span>
<span class="normal">6953</span>
<span class="normal">6954</span>
<span class="normal">6955</span>
<span class="normal">6956</span>
<span class="normal">6957</span>
<span class="normal">6958</span>
<span class="normal">6959</span>
<span class="normal">6960</span>
<span class="normal">6961</span>
<span class="normal">6962</span>
<span class="normal">6963</span>
<span class="normal">6964</span>
<span class="normal">6965</span>
<span class="normal">6966</span>
<span class="normal">6967</span>
<span class="normal">6968</span>
<span class="normal">6969</span>
<span class="normal">6970</span>
<span class="normal">6971</span>
<span class="normal">6972</span>
<span class="normal">6973</span>
<span class="normal">6974</span>
<span class="normal">6975</span>
<span class="normal">6976</span>
<span class="normal">6977</span>
<span class="normal">6978</span>
<span class="normal">6979</span>
<span class="normal">6980</span>
<span class="normal">6981</span>
<span class="normal">6982</span>
<span class="normal">6983</span>
<span class="normal">6984</span>
<span class="normal">6985</span>
<span class="normal">6986</span>
<span class="normal">6987</span>
<span class="normal">6988</span>
<span class="normal">6989</span>
<span class="normal">6990</span>
<span class="normal">6991</span>
<span class="normal">6992</span>
<span class="normal">6993</span>
<span class="normal">6994</span>
<span class="normal">6995</span>
<span class="normal">6996</span>
<span class="normal">6997</span>
<span class="normal">6998</span>
<span class="normal">6999</span>
<span class="normal">7000</span>
<span class="normal">7001</span>
<span class="normal">7002</span>
<span class="normal">7003</span>
<span class="normal">7004</span>
<span class="normal">7005</span>
<span class="normal">7006</span>
<span class="normal">7007</span>
<span class="normal">7008</span>
<span class="normal">7009</span>
<span class="normal">7010</span>
<span class="normal">7011</span>
<span class="normal">7012</span>
<span class="normal">7013</span>
<span class="normal">7014</span>
<span class="normal">7015</span>
<span class="normal">7016</span>
<span class="normal">7017</span>
<span class="normal">7018</span>
<span class="normal">7019</span>
<span class="normal">7020</span>
<span class="normal">7021</span>
<span class="normal">7022</span>
<span class="normal">7023</span>
<span class="normal">7024</span>
<span class="normal">7025</span>
<span class="normal">7026</span>
<span class="normal">7027</span>
<span class="normal">7028</span>
<span class="normal">7029</span>
<span class="normal">7030</span>
<span class="normal">7031</span>
<span class="normal">7032</span>
<span class="normal">7033</span>
<span class="normal">7034</span>
<span class="normal">7035</span>
<span class="normal">7036</span>
<span class="normal">7037</span>
<span class="normal">7038</span>
<span class="normal">7039</span>
<span class="normal">7040</span>
<span class="normal">7041</span>
<span class="normal">7042</span>
<span class="normal">7043</span>
<span class="normal">7044</span>
<span class="normal">7045</span>
<span class="normal">7046</span>
<span class="normal">7047</span>
<span class="normal">7048</span>
<span class="normal">7049</span>
<span class="normal">7050</span>
<span class="normal">7051</span>
<span class="normal">7052</span>
<span class="normal">7053</span>
<span class="normal">7054</span>
<span class="normal">7055</span>
<span class="normal">7056</span>
<span class="normal">7057</span>
<span class="normal">7058</span>
<span class="normal">7059</span>
<span class="normal">7060</span>
<span class="normal">7061</span>
<span class="normal">7062</span>
<span class="normal">7063</span>
<span class="normal">7064</span>
<span class="normal">7065</span>
<span class="normal">7066</span>
<span class="normal">7067</span>
<span class="normal">7068</span>
<span class="normal">7069</span>
<span class="normal">7070</span>
<span class="normal">7071</span>
<span class="normal">7072</span>
<span class="normal">7073</span>
<span class="normal">7074</span>
<span class="normal">7075</span>
<span class="normal">7076</span>
<span class="normal">7077</span>
<span class="normal">7078</span>
<span class="normal">7079</span>
<span class="normal">7080</span>
<span class="normal">7081</span>
<span class="normal">7082</span>
<span class="normal">7083</span>
<span class="normal">7084</span>
<span class="normal">7085</span>
<span class="normal">7086</span>
<span class="normal">7087</span>
<span class="normal">7088</span>
<span class="normal">7089</span>
<span class="normal">7090</span>
<span class="normal">7091</span>
<span class="normal">7092</span>
<span class="normal">7093</span>
<span class="normal">7094</span>
<span class="normal">7095</span>
<span class="normal">7096</span>
<span class="normal">7097</span>
<span class="normal">7098</span>
<span class="normal">7099</span>
<span class="normal">7100</span>
<span class="normal">7101</span>
<span class="normal">7102</span>
<span class="normal">7103</span>
<span class="normal">7104</span>
<span class="normal">7105</span>
<span class="normal">7106</span>
<span class="normal">7107</span>
<span class="normal">7108</span>
<span class="normal">7109</span>
<span class="normal">7110</span>
<span class="normal">7111</span>
<span class="normal">7112</span>
<span class="normal">7113</span>
<span class="normal">7114</span>
<span class="normal">7115</span>
<span class="normal">7116</span>
<span class="normal">7117</span>
<span class="normal">7118</span>
<span class="normal">7119</span>
<span class="normal">7120</span>
<span class="normal">7121</span>
<span class="normal">7122</span>
<span class="normal">7123</span>
<span class="normal">7124</span>
<span class="normal">7125</span>
<span class="normal">7126</span>
<span class="normal">7127</span>
<span class="normal">7128</span>
<span class="normal">7129</span>
<span class="normal">7130</span>
<span class="normal">7131</span>
<span class="normal">7132</span>
<span class="normal">7133</span>
<span class="normal">7134</span>
<span class="normal">7135</span>
<span class="normal">7136</span>
<span class="normal">7137</span>
<span class="normal">7138</span>
<span class="normal">7139</span>
<span class="normal">7140</span>
<span class="normal">7141</span>
<span class="normal">7142</span>
<span class="normal">7143</span>
<span class="normal">7144</span>
<span class="normal">7145</span>
<span class="normal">7146</span>
<span class="normal">7147</span>
<span class="normal">7148</span>
<span class="normal">7149</span>
<span class="normal">7150</span>
<span class="normal">7151</span>
<span class="normal">7152</span>
<span class="normal">7153</span>
<span class="normal">7154</span>
<span class="normal">7155</span>
<span class="normal">7156</span>
<span class="normal">7157</span>
<span class="normal">7158</span>
<span class="normal">7159</span>
<span class="normal">7160</span>
<span class="normal">7161</span>
<span class="normal">7162</span>
<span class="normal">7163</span>
<span class="normal">7164</span>
<span class="normal">7165</span>
<span class="normal">7166</span>
<span class="normal">7167</span>
<span class="normal">7168</span>
<span class="normal">7169</span>
<span class="normal">7170</span>
<span class="normal">7171</span>
<span class="normal">7172</span>
<span class="normal">7173</span>
<span class="normal">7174</span>
<span class="normal">7175</span>
<span class="normal">7176</span>
<span class="normal">7177</span>
<span class="normal">7178</span>
<span class="normal">7179</span>
<span class="normal">7180</span>
<span class="normal">7181</span>
<span class="normal">7182</span>
<span class="normal">7183</span>
<span class="normal">7184</span>
<span class="normal">7185</span>
<span class="normal">7186</span>
<span class="normal">7187</span>
<span class="normal">7188</span>
<span class="normal">7189</span>
<span class="normal">7190</span>
<span class="normal">7191</span>
<span class="normal">7192</span>
<span class="normal">7193</span>
<span class="normal">7194</span>
<span class="normal">7195</span>
<span class="normal">7196</span>
<span class="normal">7197</span>
<span class="normal">7198</span>
<span class="normal">7199</span>
<span class="normal">7200</span>
<span class="normal">7201</span>
<span class="normal">7202</span>
<span class="normal">7203</span>
<span class="normal">7204</span>
<span class="normal">7205</span>
<span class="normal">7206</span>
<span class="normal">7207</span>
<span class="normal">7208</span>
<span class="normal">7209</span>
<span class="normal">7210</span>
<span class="normal">7211</span>
<span class="normal">7212</span>
<span class="normal">7213</span>
<span class="normal">7214</span>
<span class="normal">7215</span>
<span class="normal">7216</span>
<span class="normal">7217</span>
<span class="normal">7218</span>
<span class="normal">7219</span>
<span class="normal">7220</span>
<span class="normal">7221</span>
<span class="normal">7222</span>
<span class="normal">7223</span>
<span class="normal">7224</span>
<span class="normal">7225</span>
<span class="normal">7226</span>
<span class="normal">7227</span>
<span class="normal">7228</span>
<span class="normal">7229</span>
<span class="normal">7230</span>
<span class="normal">7231</span>
<span class="normal">7232</span>
<span class="normal">7233</span>
<span class="normal">7234</span>
<span class="normal">7235</span>
<span class="normal">7236</span>
<span class="normal">7237</span>
<span class="normal">7238</span>
<span class="normal">7239</span>
<span class="normal">7240</span>
<span class="normal">7241</span>
<span class="normal">7242</span>
<span class="normal">7243</span>
<span class="normal">7244</span>
<span class="normal">7245</span>
<span class="normal">7246</span>
<span class="normal">7247</span>
<span class="normal">7248</span>
<span class="normal">7249</span>
<span class="normal">7250</span>
<span class="normal">7251</span>
<span class="normal">7252</span>
<span class="normal">7253</span>
<span class="normal">7254</span>
<span class="normal">7255</span>
<span class="normal">7256</span>
<span class="normal">7257</span>
<span class="normal">7258</span>
<span class="normal">7259</span>
<span class="normal">7260</span>
<span class="normal">7261</span>
<span class="normal">7262</span>
<span class="normal">7263</span>
<span class="normal">7264</span>
<span class="normal">7265</span>
<span class="normal">7266</span>
<span class="normal">7267</span>
<span class="normal">7268</span>
<span class="normal">7269</span>
<span class="normal">7270</span>
<span class="normal">7271</span>
<span class="normal">7272</span>
<span class="normal">7273</span>
<span class="normal">7274</span>
<span class="normal">7275</span>
<span class="normal">7276</span>
<span class="normal">7277</span>
<span class="normal">7278</span>
<span class="normal">7279</span>
<span class="normal">7280</span>
<span class="normal">7281</span>
<span class="normal">7282</span>
<span class="normal">7283</span>
<span class="normal">7284</span>
<span class="normal">7285</span>
<span class="normal">7286</span>
<span class="normal">7287</span>
<span class="normal">7288</span>
<span class="normal">7289</span>
<span class="normal">7290</span>
<span class="normal">7291</span>
<span class="normal">7292</span>
<span class="normal">7293</span>
<span class="normal">7294</span>
<span class="normal">7295</span>
<span class="normal">7296</span>
<span class="normal">7297</span>
<span class="normal">7298</span>
<span class="normal">7299</span>
<span class="normal">7300</span>
<span class="normal">7301</span>
<span class="normal">7302</span>
<span class="normal">7303</span>
<span class="normal">7304</span>
<span class="normal">7305</span>
<span class="normal">7306</span>
<span class="normal">7307</span>
<span class="normal">7308</span>
<span class="normal">7309</span>
<span class="normal">7310</span>
<span class="normal">7311</span>
<span class="normal">7312</span>
<span class="normal">7313</span>
<span class="normal">7314</span>
<span class="normal">7315</span>
<span class="normal">7316</span>
<span class="normal">7317</span>
<span class="normal">7318</span>
<span class="normal">7319</span>
<span class="normal">7320</span>
<span class="normal">7321</span>
<span class="normal">7322</span>
<span class="normal">7323</span>
<span class="normal">7324</span>
<span class="normal">7325</span>
<span class="normal">7326</span>
<span class="normal">7327</span>
<span class="normal">7328</span>
<span class="normal">7329</span>
<span class="normal">7330</span>
<span class="normal">7331</span>
<span class="normal">7332</span>
<span class="normal">7333</span>
<span class="normal">7334</span>
<span class="normal">7335</span>
<span class="normal">7336</span>
<span class="normal">7337</span>
<span class="normal">7338</span>
<span class="normal">7339</span>
<span class="normal">7340</span>
<span class="normal">7341</span>
<span class="normal">7342</span>
<span class="normal">7343</span>
<span class="normal">7344</span>
<span class="normal">7345</span>
<span class="normal">7346</span>
<span class="normal">7347</span>
<span class="normal">7348</span>
<span class="normal">7349</span>
<span class="normal">7350</span>
<span class="normal">7351</span>
<span class="normal">7352</span>
<span class="normal">7353</span>
<span class="normal">7354</span>
<span class="normal">7355</span>
<span class="normal">7356</span>
<span class="normal">7357</span>
<span class="normal">7358</span>
<span class="normal">7359</span>
<span class="normal">7360</span>
<span class="normal">7361</span>
<span class="normal">7362</span>
<span class="normal">7363</span>
<span class="normal">7364</span>
<span class="normal">7365</span>
<span class="normal">7366</span>
<span class="normal">7367</span>
<span class="normal">7368</span>
<span class="normal">7369</span>
<span class="normal">7370</span>
<span class="normal">7371</span>
<span class="normal">7372</span>
<span class="normal">7373</span>
<span class="normal">7374</span>
<span class="normal">7375</span>
<span class="normal">7376</span>
<span class="normal">7377</span>
<span class="normal">7378</span>
<span class="normal">7379</span>
<span class="normal">7380</span>
<span class="normal">7381</span>
<span class="normal">7382</span>
<span class="normal">7383</span>
<span class="normal">7384</span>
<span class="normal">7385</span>
<span class="normal">7386</span>
<span class="normal">7387</span>
<span class="normal">7388</span>
<span class="normal">7389</span>
<span class="normal">7390</span>
<span class="normal">7391</span>
<span class="normal">7392</span>
<span class="normal">7393</span>
<span class="normal">7394</span>
<span class="normal">7395</span>
<span class="normal">7396</span>
<span class="normal">7397</span>
<span class="normal">7398</span>
<span class="normal">7399</span>
<span class="normal">7400</span>
<span class="normal">7401</span>
<span class="normal">7402</span>
<span class="normal">7403</span>
<span class="normal">7404</span>
<span class="normal">7405</span>
<span class="normal">7406</span>
<span class="normal">7407</span>
<span class="normal">7408</span>
<span class="normal">7409</span>
<span class="normal">7410</span>
<span class="normal">7411</span>
<span class="normal">7412</span>
<span class="normal">7413</span>
<span class="normal">7414</span>
<span class="normal">7415</span>
<span class="normal">7416</span>
<span class="normal">7417</span>
<span class="normal">7418</span>
<span class="normal">7419</span>
<span class="normal">7420</span>
<span class="normal">7421</span>
<span class="normal">7422</span>
<span class="normal">7423</span>
<span class="normal">7424</span>
<span class="normal">7425</span>
<span class="normal">7426</span>
<span class="normal">7427</span>
<span class="normal">7428</span>
<span class="normal">7429</span>
<span class="normal">7430</span>
<span class="normal">7431</span>
<span class="normal">7432</span>
<span class="normal">7433</span>
<span class="normal">7434</span>
<span class="normal">7435</span>
<span class="normal">7436</span>
<span class="normal">7437</span>
<span class="normal">7438</span>
<span class="normal">7439</span>
<span class="normal">7440</span>
<span class="normal">7441</span>
<span class="normal">7442</span>
<span class="normal">7443</span>
<span class="normal">7444</span>
<span class="normal">7445</span>
<span class="normal">7446</span>
<span class="normal">7447</span>
<span class="normal">7448</span>
<span class="normal">7449</span>
<span class="normal">7450</span>
<span class="normal">7451</span>
<span class="normal">7452</span>
<span class="normal">7453</span>
<span class="normal">7454</span>
<span class="normal">7455</span>
<span class="normal">7456</span>
<span class="normal">7457</span>
<span class="normal">7458</span>
<span class="normal">7459</span>
<span class="normal">7460</span>
<span class="normal">7461</span>
<span class="normal">7462</span>
<span class="normal">7463</span>
<span class="normal">7464</span>
<span class="normal">7465</span>
<span class="normal">7466</span>
<span class="normal">7467</span>
<span class="normal">7468</span>
<span class="normal">7469</span>
<span class="normal">7470</span>
<span class="normal">7471</span>
<span class="normal">7472</span>
<span class="normal">7473</span>
<span class="normal">7474</span>
<span class="normal">7475</span>
<span class="normal">7476</span>
<span class="normal">7477</span>
<span class="normal">7478</span>
<span class="normal">7479</span>
<span class="normal">7480</span>
<span class="normal">7481</span>
<span class="normal">7482</span>
<span class="normal">7483</span>
<span class="normal">7484</span>
<span class="normal">7485</span>
<span class="normal">7486</span>
<span class="normal">7487</span>
<span class="normal">7488</span>
<span class="normal">7489</span>
<span class="normal">7490</span>
<span class="normal">7491</span>
<span class="normal">7492</span>
<span class="normal">7493</span>
<span class="normal">7494</span>
<span class="normal">7495</span>
<span class="normal">7496</span>
<span class="normal">7497</span>
<span class="normal">7498</span>
<span class="normal">7499</span>
<span class="normal">7500</span>
<span class="normal">7501</span>
<span class="normal">7502</span>
<span class="normal">7503</span>
<span class="normal">7504</span>
<span class="normal">7505</span>
<span class="normal">7506</span>
<span class="normal">7507</span>
<span class="normal">7508</span>
<span class="normal">7509</span>
<span class="normal">7510</span>
<span class="normal">7511</span>
<span class="normal">7512</span>
<span class="normal">7513</span>
<span class="normal">7514</span>
<span class="normal">7515</span>
<span class="normal">7516</span>
<span class="normal">7517</span>
<span class="normal">7518</span>
<span class="normal">7519</span>
<span class="normal">7520</span>
<span class="normal">7521</span>
<span class="normal">7522</span>
<span class="normal">7523</span>
<span class="normal">7524</span>
<span class="normal">7525</span>
<span class="normal">7526</span>
<span class="normal">7527</span>
<span class="normal">7528</span>
<span class="normal">7529</span>
<span class="normal">7530</span>
<span class="normal">7531</span>
<span class="normal">7532</span>
<span class="normal">7533</span>
<span class="normal">7534</span>
<span class="normal">7535</span>
<span class="normal">7536</span>
<span class="normal">7537</span>
<span class="normal">7538</span>
<span class="normal">7539</span>
<span class="normal">7540</span>
<span class="normal">7541</span>
<span class="normal">7542</span>
<span class="normal">7543</span>
<span class="normal">7544</span>
<span class="normal">7545</span>
<span class="normal">7546</span>
<span class="normal">7547</span>
<span class="normal">7548</span>
<span class="normal">7549</span>
<span class="normal">7550</span>
<span class="normal">7551</span>
<span class="normal">7552</span>
<span class="normal">7553</span>
<span class="normal">7554</span>
<span class="normal">7555</span>
<span class="normal">7556</span>
<span class="normal">7557</span>
<span class="normal">7558</span>
<span class="normal">7559</span>
<span class="normal">7560</span>
<span class="normal">7561</span>
<span class="normal">7562</span>
<span class="normal">7563</span>
<span class="normal">7564</span>
<span class="normal">7565</span>
<span class="normal">7566</span>
<span class="normal">7567</span>
<span class="normal">7568</span>
<span class="normal">7569</span>
<span class="normal">7570</span>
<span class="normal">7571</span>
<span class="normal">7572</span>
<span class="normal">7573</span>
<span class="normal">7574</span>
<span class="normal">7575</span>
<span class="normal">7576</span>
<span class="normal">7577</span>
<span class="normal">7578</span>
<span class="normal">7579</span>
<span class="normal">7580</span>
<span class="normal">7581</span>
<span class="normal">7582</span>
<span class="normal">7583</span>
<span class="normal">7584</span>
<span class="normal">7585</span>
<span class="normal">7586</span>
<span class="normal">7587</span>
<span class="normal">7588</span>
<span class="normal">7589</span>
<span class="normal">7590</span>
<span class="normal">7591</span>
<span class="normal">7592</span>
<span class="normal">7593</span>
<span class="normal">7594</span>
<span class="normal">7595</span>
<span class="normal">7596</span>
<span class="normal">7597</span>
<span class="normal">7598</span>
<span class="normal">7599</span>
<span class="normal">7600</span>
<span class="normal">7601</span>
<span class="normal">7602</span>
<span class="normal">7603</span>
<span class="normal">7604</span>
<span class="normal">7605</span>
<span class="normal">7606</span>
<span class="normal">7607</span>
<span class="normal">7608</span>
<span class="normal">7609</span>
<span class="normal">7610</span>
<span class="normal">7611</span>
<span class="normal">7612</span>
<span class="normal">7613</span>
<span class="normal">7614</span>
<span class="normal">7615</span>
<span class="normal">7616</span>
<span class="normal">7617</span>
<span class="normal">7618</span>
<span class="normal">7619</span>
<span class="normal">7620</span>
<span class="normal">7621</span>
<span class="normal">7622</span>
<span class="normal">7623</span>
<span class="normal">7624</span>
<span class="normal">7625</span>
<span class="normal">7626</span>
<span class="normal">7627</span>
<span class="normal">7628</span>
<span class="normal">7629</span>
<span class="normal">7630</span>
<span class="normal">7631</span>
<span class="normal">7632</span>
<span class="normal">7633</span>
<span class="normal">7634</span>
<span class="normal">7635</span>
<span class="normal">7636</span>
<span class="normal">7637</span>
<span class="normal">7638</span>
<span class="normal">7639</span>
<span class="normal">7640</span>
<span class="normal">7641</span>
<span class="normal">7642</span>
<span class="normal">7643</span>
<span class="normal">7644</span>
<span class="normal">7645</span>
<span class="normal">7646</span>
<span class="normal">7647</span>
<span class="normal">7648</span>
<span class="normal">7649</span>
<span class="normal">7650</span>
<span class="normal">7651</span>
<span class="normal">7652</span>
<span class="normal">7653</span>
<span class="normal">7654</span>
<span class="normal">7655</span>
<span class="normal">7656</span>
<span class="normal">7657</span>
<span class="normal">7658</span>
<span class="normal">7659</span>
<span class="normal">7660</span>
<span class="normal">7661</span>
<span class="normal">7662</span>
<span class="normal">7663</span>
<span class="normal">7664</span>
<span class="normal">7665</span>
<span class="normal">7666</span>
<span class="normal">7667</span>
<span class="normal">7668</span>
<span class="normal">7669</span>
<span class="normal">7670</span>
<span class="normal">7671</span>
<span class="normal">7672</span>
<span class="normal">7673</span>
<span class="normal">7674</span>
<span class="normal">7675</span>
<span class="normal">7676</span>
<span class="normal">7677</span>
<span class="normal">7678</span>
<span class="normal">7679</span>
<span class="normal">7680</span>
<span class="normal">7681</span>
<span class="normal">7682</span>
<span class="normal">7683</span>
<span class="normal">7684</span>
<span class="normal">7685</span>
<span class="normal">7686</span>
<span class="normal">7687</span>
<span class="normal">7688</span>
<span class="normal">7689</span>
<span class="normal">7690</span>
<span class="normal">7691</span>
<span class="normal">7692</span>
<span class="normal">7693</span>
<span class="normal">7694</span>
<span class="normal">7695</span>
<span class="normal">7696</span>
<span class="normal">7697</span>
<span class="normal">7698</span>
<span class="normal">7699</span>
<span class="normal">7700</span>
<span class="normal">7701</span>
<span class="normal">7702</span>
<span class="normal">7703</span>
<span class="normal">7704</span>
<span class="normal">7705</span>
<span class="normal">7706</span>
<span class="normal">7707</span>
<span class="normal">7708</span>
<span class="normal">7709</span>
<span class="normal">7710</span>
<span class="normal">7711</span>
<span class="normal">7712</span>
<span class="normal">7713</span>
<span class="normal">7714</span>
<span class="normal">7715</span>
<span class="normal">7716</span>
<span class="normal">7717</span>
<span class="normal">7718</span>
<span class="normal">7719</span>
<span class="normal">7720</span>
<span class="normal">7721</span>
<span class="normal">7722</span>
<span class="normal">7723</span>
<span class="normal">7724</span>
<span class="normal">7725</span>
<span class="normal">7726</span>
<span class="normal">7727</span>
<span class="normal">7728</span>
<span class="normal">7729</span>
<span class="normal">7730</span>
<span class="normal">7731</span>
<span class="normal">7732</span>
<span class="normal">7733</span>
<span class="normal">7734</span>
<span class="normal">7735</span>
<span class="normal">7736</span>
<span class="normal">7737</span>
<span class="normal">7738</span>
<span class="normal">7739</span>
<span class="normal">7740</span>
<span class="normal">7741</span>
<span class="normal">7742</span>
<span class="normal">7743</span>
<span class="normal">7744</span>
<span class="normal">7745</span>
<span class="normal">7746</span>
<span class="normal">7747</span>
<span class="normal">7748</span>
<span class="normal">7749</span>
<span class="normal">7750</span>
<span class="normal">7751</span>
<span class="normal">7752</span>
<span class="normal">7753</span>
<span class="normal">7754</span>
<span class="normal">7755</span>
<span class="normal">7756</span>
<span class="normal">7757</span>
<span class="normal">7758</span>
<span class="normal">7759</span>
<span class="normal">7760</span>
<span class="normal">7761</span>
<span class="normal">7762</span>
<span class="normal">7763</span>
<span class="normal">7764</span>
<span class="normal">7765</span>
<span class="normal">7766</span>
<span class="normal">7767</span>
<span class="normal">7768</span>
<span class="normal">7769</span>
<span class="normal">7770</span>
<span class="normal">7771</span>
<span class="normal">7772</span>
<span class="normal">7773</span>
<span class="normal">7774</span>
<span class="normal">7775</span>
<span class="normal">7776</span>
<span class="normal">7777</span>
<span class="normal">7778</span>
<span class="normal">7779</span>
<span class="normal">7780</span>
<span class="normal">7781</span>
<span class="normal">7782</span>
<span class="normal">7783</span>
<span class="normal">7784</span>
<span class="normal">7785</span>
<span class="normal">7786</span>
<span class="normal">7787</span>
<span class="normal">7788</span>
<span class="normal">7789</span>
<span class="normal">7790</span>
<span class="normal">7791</span>
<span class="normal">7792</span>
<span class="normal">7793</span>
<span class="normal">7794</span>
<span class="normal">7795</span>
<span class="normal">7796</span>
<span class="normal">7797</span>
<span class="normal">7798</span>
<span class="normal">7799</span>
<span class="normal">7800</span>
<span class="normal">7801</span>
<span class="normal">7802</span>
<span class="normal">7803</span>
<span class="normal">7804</span>
<span class="normal">7805</span>
<span class="normal">7806</span>
<span class="normal">7807</span>
<span class="normal">7808</span>
<span class="normal">7809</span>
<span class="normal">7810</span>
<span class="normal">7811</span>
<span class="normal">7812</span>
<span class="normal">7813</span>
<span class="normal">7814</span>
<span class="normal">7815</span>
<span class="normal">7816</span>
<span class="normal">7817</span>
<span class="normal">7818</span>
<span class="normal">7819</span>
<span class="normal">7820</span>
<span class="normal">7821</span>
<span class="normal">7822</span>
<span class="normal">7823</span>
<span class="normal">7824</span>
<span class="normal">7825</span>
<span class="normal">7826</span>
<span class="normal">7827</span>
<span class="normal">7828</span>
<span class="normal">7829</span>
<span class="normal">7830</span>
<span class="normal">7831</span>
<span class="normal">7832</span>
<span class="normal">7833</span>
<span class="normal">7834</span>
<span class="normal">7835</span>
<span class="normal">7836</span>
<span class="normal">7837</span>
<span class="normal">7838</span>
<span class="normal">7839</span>
<span class="normal">7840</span>
<span class="normal">7841</span>
<span class="normal">7842</span>
<span class="normal">7843</span>
<span class="normal">7844</span>
<span class="normal">7845</span>
<span class="normal">7846</span>
<span class="normal">7847</span>
<span class="normal">7848</span>
<span class="normal">7849</span>
<span class="normal">7850</span>
<span class="normal">7851</span>
<span class="normal">7852</span>
<span class="normal">7853</span>
<span class="normal">7854</span>
<span class="normal">7855</span>
<span class="normal">7856</span>
<span class="normal">7857</span>
<span class="normal">7858</span>
<span class="normal">7859</span>
<span class="normal">7860</span>
<span class="normal">7861</span>
<span class="normal">7862</span>
<span class="normal">7863</span>
<span class="normal">7864</span>
<span class="normal">7865</span>
<span class="normal">7866</span>
<span class="normal">7867</span>
<span class="normal">7868</span>
<span class="normal">7869</span>
<span class="normal">7870</span>
<span class="normal">7871</span>
<span class="normal">7872</span>
<span class="normal">7873</span>
<span class="normal">7874</span>
<span class="normal">7875</span>
<span class="normal">7876</span>
<span class="normal">7877</span>
<span class="normal">7878</span>
<span class="normal">7879</span>
<span class="normal">7880</span>
<span class="normal">7881</span>
<span class="normal">7882</span>
<span class="normal">7883</span>
<span class="normal">7884</span>
<span class="normal">7885</span>
<span class="normal">7886</span>
<span class="normal">7887</span>
<span class="normal">7888</span>
<span class="normal">7889</span>
<span class="normal">7890</span>
<span class="normal">7891</span>
<span class="normal">7892</span>
<span class="normal">7893</span>
<span class="normal">7894</span>
<span class="normal">7895</span>
<span class="normal">7896</span>
<span class="normal">7897</span>
<span class="normal">7898</span>
<span class="normal">7899</span>
<span class="normal">7900</span>
<span class="normal">7901</span>
<span class="normal">7902</span>
<span class="normal">7903</span>
<span class="normal">7904</span>
<span class="normal">7905</span>
<span class="normal">7906</span>
<span class="normal">7907</span>
<span class="normal">7908</span>
<span class="normal">7909</span>
<span class="normal">7910</span>
<span class="normal">7911</span>
<span class="normal">7912</span>
<span class="normal">7913</span>
<span class="normal">7914</span>
<span class="normal">7915</span>
<span class="normal">7916</span>
<span class="normal">7917</span>
<span class="normal">7918</span>
<span class="normal">7919</span>
<span class="normal">7920</span>
<span class="normal">7921</span>
<span class="normal">7922</span>
<span class="normal">7923</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">orthogonalize</span><span class="p">(</span>
    <span class="n">input_path</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">min_segments</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">area_tolerance</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">detect_triangles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orthogonalizes object masks in a GeoTIFF file.</span>

<span class="sd">    This function reads a GeoTIFF containing object masks (binary or labeled regions),</span>
<span class="sd">    converts the raster masks to vector polygons, applies orthogonalization to each polygon,</span>
<span class="sd">    and optionally writes the result to a GeoJSON file.</span>
<span class="sd">    The source code is adapted from the Solar Panel Detection algorithm by Esri.</span>
<span class="sd">    See https://www.arcgis.com/home/item.html?id=c2508d72f2614104bfcfd5ccf1429284.</span>
<span class="sd">    Credits to Esri for the original code.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_path (str): Path to the input GeoTIFF file.</span>
<span class="sd">        output_path (str, optional): Path to save the output GeoJSON file. If None, no file is saved.</span>
<span class="sd">        epsilon (float, optional): Simplification tolerance for the Douglas-Peucker algorithm.</span>
<span class="sd">            Higher values result in more simplification. Default is 0.2.</span>
<span class="sd">        min_area (float, optional): Minimum area of polygons to process (smaller ones are kept as-is).</span>
<span class="sd">        min_segments (int, optional): Minimum number of segments to keep after simplification.</span>
<span class="sd">            Default is 4 (for rectangular shapes).</span>
<span class="sd">        area_tolerance (float, optional): Allowed ratio of area change. Values less than 1.0 restrict</span>
<span class="sd">            area change. Default is 0.7 (allows reduction to 70% of original area).</span>
<span class="sd">        detect_triangles (bool, optional): If True, performs additional check to avoid creating triangular shapes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: A GeoDataFrame containing the orthogonalized features.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">orthogonalize_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">min_segments</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orthogonalizes a ring (list of coordinates).</span>

<span class="sd">        Args:</span>
<span class="sd">            ring (list): List of [x, y] coordinates forming a ring</span>
<span class="sd">            epsilon (float, optional): Simplification tolerance</span>
<span class="sd">            min_segments (int, optional): Minimum number of segments to keep</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Orthogonalized list of coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Convert to numpy array</span>
        <span class="n">ring_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>

        <span class="c1"># Get orientation</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">get_orientation</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">))</span>

        <span class="c1"># Simplify using Ramer-Douglas-Peucker algorithm</span>
        <span class="n">ring_arr</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

        <span class="c1"># If simplified too much, adjust epsilon to maintain minimum segments</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_segments</span><span class="p">:</span>
            <span class="c1"># Try with smaller epsilon until we get at least min_segments points</span>
            <span class="k">for</span> <span class="n">adjust_factor</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]:</span>
                <span class="n">test_arr</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">adjust_factor</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_segments</span><span class="p">:</span>
                    <span class="n">ring_arr</span> <span class="o">=</span> <span class="n">test_arr</span>
                    <span class="k">break</span>

        <span class="c1"># Convert to dataframe for processing</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">to_dataframe</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">)</span>

        <span class="c1"># Add orientation information</span>
        <span class="n">add_orientation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

        <span class="c1"># Align segments to orthogonal directions</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Merge collinear line segments</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">merge_lines</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># If we have a triangle-like result (3 segments or less), return the original shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Join the orthogonalized segments back into a ring</span>
        <span class="n">joined_ring</span> <span class="o">=</span> <span class="n">join_ring</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># If the join operation didn&#39;t produce a valid ring, return the original</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_ring</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Enhanced validation: check for triangular result and geometric validity</span>
        <span class="n">result_coords</span> <span class="o">=</span> <span class="n">joined_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If result has 3 or fewer points (triangle), use original</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># 2 points + closing point (degenerate)</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Additional validation: check for degenerate geometry</span>
        <span class="c1"># Calculate area ratio to detect if the shape got severely distorted</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">calculate_polygon_area</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
                <span class="n">area</span> <span class="o">+=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">area</span> <span class="o">-=</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">original_area</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="n">result_area</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span>

        <span class="c1"># If the area changed dramatically (more than 30% shrinkage or 300% growth), use original</span>
        <span class="k">if</span> <span class="n">original_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">area_ratio</span> <span class="o">=</span> <span class="n">result_area</span> <span class="o">/</span> <span class="n">original_area</span>
            <span class="k">if</span> <span class="n">area_ratio</span> <span class="o">&lt;</span> <span class="mf">0.3</span> <span class="ow">or</span> <span class="n">area_ratio</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Check for triangular spikes and problematic artifacts</span>
        <span class="n">very_acute_angle_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">triangular_spike_detected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># -1 to exclude closing point</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">result_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

            <span class="c1"># Calculate angle at p2</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="n">v1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="n">v2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1_norm</span> <span class="o">*</span> <span class="n">v2_norm</span><span class="p">)</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>

                <span class="c1"># Count very acute angles (&lt; 20 degrees) - these are likely spikes</span>
                <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">9</span><span class="p">:</span>  <span class="c1"># 20 degrees</span>
                    <span class="n">very_acute_angle_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># If it&#39;s very acute with short sides, it&#39;s definitely a spike</span>
                    <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">v2_norm</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">triangular_spike_detected</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check for excessively long edges that might be artifacts</span>
        <span class="n">edge_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">edge_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">result_coords</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">result_coords</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">edge_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_len</span><span class="p">)</span>

        <span class="n">excessive_edge_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avg_edge_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span>
            <span class="n">max_edge_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span>
            <span class="c1"># Only reject if edge is extremely disproportionate (8x average)</span>
            <span class="k">if</span> <span class="n">max_edge_length</span> <span class="o">&gt;</span> <span class="n">avg_edge_length</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">excessive_edge_detected</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check for triangular artifacts by detecting spikes that extend beyond bounds</span>
        <span class="c1"># Calculate original bounds</span>
        <span class="n">orig_xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">]</span>
        <span class="n">orig_ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">]</span>
        <span class="n">orig_min_x</span><span class="p">,</span> <span class="n">orig_max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orig_xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_xs</span><span class="p">)</span>
        <span class="n">orig_min_y</span><span class="p">,</span> <span class="n">orig_max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orig_ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_ys</span><span class="p">)</span>
        <span class="n">orig_width</span> <span class="o">=</span> <span class="n">orig_max_x</span> <span class="o">-</span> <span class="n">orig_min_x</span>
        <span class="n">orig_height</span> <span class="o">=</span> <span class="n">orig_max_y</span> <span class="o">-</span> <span class="n">orig_min_y</span>

        <span class="c1"># Calculate result bounds</span>
        <span class="n">result_xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result_coords</span><span class="p">]</span>
        <span class="n">result_ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result_coords</span><span class="p">]</span>
        <span class="n">result_min_x</span><span class="p">,</span> <span class="n">result_max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">result_xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_xs</span><span class="p">)</span>
        <span class="n">result_min_y</span><span class="p">,</span> <span class="n">result_max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">result_ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_ys</span><span class="p">)</span>

        <span class="c1"># Stricter bounds checking to catch triangular artifacts</span>
        <span class="n">bounds_extension_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># More conservative: only allow 10% extension</span>
        <span class="n">tolerance_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_width</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 10% tolerance, at least 1 unit</span>
        <span class="n">tolerance_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_height</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 10% tolerance, at least 1 unit</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">result_min_x</span> <span class="o">&lt;</span> <span class="n">orig_min_x</span> <span class="o">-</span> <span class="n">tolerance_x</span>
            <span class="ow">or</span> <span class="n">result_max_x</span> <span class="o">&gt;</span> <span class="n">orig_max_x</span> <span class="o">+</span> <span class="n">tolerance_x</span>
            <span class="ow">or</span> <span class="n">result_min_y</span> <span class="o">&lt;</span> <span class="n">orig_min_y</span> <span class="o">-</span> <span class="n">tolerance_y</span>
            <span class="ow">or</span> <span class="n">result_max_y</span> <span class="o">&gt;</span> <span class="n">orig_max_y</span> <span class="o">+</span> <span class="n">tolerance_y</span>
        <span class="p">):</span>
            <span class="n">bounds_extension_detected</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Reject if we detect triangular spikes, excessive edges, or bounds violations</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">triangular_spike_detected</span>
            <span class="ow">or</span> <span class="n">very_acute_angle_count</span> <span class="o">&gt;</span> <span class="mi">2</span>  <span class="c1"># Multiple very acute angles</span>
            <span class="ow">or</span> <span class="n">excessive_edge_detected</span>
            <span class="ow">or</span> <span class="n">bounds_extension_detected</span>
        <span class="p">):</span>  <span class="c1"># Any significant bounds extension</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Convert back to a list and ensure it&#39;s closed</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">joined_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vectorize_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a binary mask to vector polygons.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (numpy.ndarray): Binary mask where non-zero values represent objects</span>
<span class="sd">            transform (rasterio.transform.Affine): Affine transformation matrix</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of GeoJSON features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only process non-zero values (actual objects)</span>
                <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">features_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rasterize_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts vector features back to a raster mask.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (list): List of GeoJSON features</span>
<span class="sd">            shape (tuple): Shape of the output raster (height, width)</span>
<span class="sd">            transform (rasterio.transform.Affine): Affine transformation matrix</span>
<span class="sd">            dtype (numpy.dtype, optional): Data type of the output raster</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Rasterized mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span>
            <span class="p">],</span>
            <span class="n">out_shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="c1"># The following helper functions are from the original code</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_orientation</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the orientation angle of a contour.</span>

<span class="sd">        Args:</span>
<span class="sd">            contour (numpy.ndarray): Array of shape (n, 2) containing point coordinates</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Orientation angle in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">box</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simplify a contour using the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            contour (numpy.ndarray): Array of shape (n, 2) containing point coordinates</span>
<span class="sd">            eps (float, optional): Epsilon value for simplification</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Simplified contour</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rdp</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataframe</span><span class="p">(</span><span class="n">ring</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a ring to a pandas DataFrame with line segment information.</span>

<span class="sd">        Args:</span>
<span class="sd">            ring (numpy.ndarray): Array of shape (n, 2) containing point coordinates</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame with line segment information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]))</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">57.2958</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_orientation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add orientation information to the DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame with line segment information</span>
<span class="sd">            angle (float): Orientation angle in degrees</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Modifies the DataFrame in-place</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rtangle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">+</span> <span class="mi">90</span>
        <span class="n">is_parallel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">45</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="mi">45</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">45</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="mi">45</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_parallel</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">rtangle</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">align</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align line segments to their nearest orthogonal direction.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame with line segment information</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame with aligned line segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle edge case with empty dataframe</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df_clone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Ensure angle column exists and has valid values</span>
        <span class="k">if</span> <span class="s2">&quot;angle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># If angle data is missing, add default angles based on atan2</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;angle_atan&quot;</span><span class="p">]</span>

        <span class="c1"># Ensure length and center point data is valid</span>
        <span class="k">if</span> <span class="s2">&quot;len&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Recalculate lengths if missing</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;cx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">if</span> <span class="s2">&quot;cy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Apply orthogonal alignment</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">df_clone</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_lines</span><span class="p">(</span><span class="n">df_aligned</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge collinear line segments.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_aligned (pandas.DataFrame): DataFrame with aligned line segments</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame with merged line segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ortho_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">df_aligned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">(</span><span class="n">df_aligned</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">!=</span> <span class="n">df_aligned</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">group_cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">cumlen</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">ortho_lines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">group_cx</span><span class="p">,</span> <span class="n">group_cy</span><span class="p">,</span> <span class="n">cumlen</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">ortho_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">rot_angle</span> <span class="ow">in</span> <span class="n">ortho_lines</span><span class="p">:</span>
            <span class="n">X1</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
            <span class="n">X2</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
            <span class="n">Y1</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
            <span class="n">Y2</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>

            <span class="n">ortho_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">X1</span><span class="p">,</span>
                    <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">Y1</span><span class="p">,</span>
                    <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">X2</span><span class="p">,</span>
                    <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">Y2</span><span class="p">,</span>
                    <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
                    <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">cx</span><span class="p">,</span>
                    <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">cy</span><span class="p">,</span>
                    <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">rot_angle</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Improved fix: Prevent merging that would create triangular or problematic shapes</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span>
        <span class="p">):</span>  <span class="c1"># join first and last segment if they&#39;re in same direction</span>
            <span class="c1"># Check if merging would result in 3 or 4 segments (potentially triangular)</span>
            <span class="n">resulting_segments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">resulting_segments</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># For very small polygons, be extra cautious about merging</span>
                <span class="c1"># Calculate the spatial relationship between first and last segments</span>
                <span class="n">first_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">],</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]])</span>
                <span class="n">last_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">],</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]])</span>
                <span class="n">center_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">first_center</span> <span class="o">-</span> <span class="n">last_center</span><span class="p">)</span>

                <span class="c1"># Get average segment length for comparison</span>
                <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">ortho_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span>

                <span class="c1"># Only merge if segments are close enough and it won&#39;t create degenerate shapes</span>
                <span class="k">if</span> <span class="n">center_distance</span> <span class="o">&gt;</span> <span class="n">avg_length</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="c1"># Skip merging - segments are too far apart</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Proceed with merging only for well-connected segments</span>
                    <span class="n">totlen</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
                    <span class="n">merge_cx</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                    <span class="n">merge_cy</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                    <span class="n">rot_angle</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span>
                    <span class="n">X1</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                    <span class="n">X2</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                    <span class="n">Y1</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                    <span class="n">Y2</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>

                    <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">X1</span><span class="p">,</span>
                        <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">Y1</span><span class="p">,</span>
                        <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">X2</span><span class="p">,</span>
                        <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">Y2</span><span class="p">,</span>
                        <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="n">totlen</span><span class="p">,</span>
                        <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">merge_cx</span><span class="p">,</span>
                        <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">merge_cy</span><span class="p">,</span>
                        <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">rot_angle</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">ortho_list</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For larger polygons, proceed with standard merging</span>
                <span class="n">totlen</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
                <span class="n">merge_cx</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                <span class="n">merge_cy</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                <span class="n">rot_angle</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span>
                <span class="n">X1</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                <span class="n">X2</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                <span class="n">Y1</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                <span class="n">Y2</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>

                <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">X1</span><span class="p">,</span>
                    <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">Y1</span><span class="p">,</span>
                    <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">X2</span><span class="p">,</span>
                    <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">Y2</span><span class="p">,</span>
                    <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="n">totlen</span><span class="p">,</span>
                    <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">merge_cx</span><span class="p">,</span>
                    <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">merge_cy</span><span class="p">,</span>
                    <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">rot_angle</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ortho_list</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ortho_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ortho_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_intersection</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the intersection point of two line segments.</span>

<span class="sd">        Args:</span>
<span class="sd">            x1, y1, x2, y2: Coordinates of the first line segment</span>
<span class="sd">            x3, y3, x4, y4: Coordinates of the second line segment</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: [x, y] coordinates of the intersection point</span>

<span class="sd">        Raises:</span>
<span class="sd">            ZeroDivisionError: If the lines are parallel or collinear</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the denominator of the intersection formula</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span>

        <span class="c1"># Check if lines are parallel or collinear (denominator close to zero)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">denominator</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">(</span><span class="s2">&quot;Lines are parallel or collinear&quot;</span><span class="p">)</span>

        <span class="n">px</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">*</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span> <span class="o">*</span> <span class="n">x4</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="n">py</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">*</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span> <span class="o">*</span> <span class="n">x4</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">denominator</span>

        <span class="c1"># Check if the intersection point is within a reasonable distance</span>
        <span class="c1"># from both line segments to avoid extreme extrapolation</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">point_on_segment</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="c1"># Check if point (x,y) is near the line segment from (x1,y1) to (x2,y2)</span>
            <span class="c1"># First check if it&#39;s near the infinite line</span>
            <span class="n">line_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_len</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tolerance</span>

            <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">line_len</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Check distance to the infinite line</span>
            <span class="n">proj_x</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">proj_y</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>
            <span class="n">dist_to_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">proj_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">proj_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Check if the projection is near the segment, not just the infinite line</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tolerance</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="c1"># If far from the segment, compute distance to the nearest endpoint</span>
                <span class="n">dist_to_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">dist_to_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">dist_to_start</span><span class="p">,</span> <span class="n">dist_to_end</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tolerance</span> <span class="o">*</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">dist_to_line</span> <span class="o">&lt;=</span> <span class="n">tolerance</span>

        <span class="c1"># Check if intersection is reasonably close to both line segments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">point_on_segment</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">point_on_segment</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># If intersection is far from segments, it&#39;s probably extrapolating too much</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intersection point too far from line segments&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">join_ring</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join line segments to form a closed ring.</span>

<span class="sd">        Args:</span>
<span class="sd">            merged_df (pandas.DataFrame): DataFrame with merged line segments</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Array of shape (1, n, 2) containing the ring coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle edge cases</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Not enough segments to form a valid polygon</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>

        <span class="n">ring</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Find intersections between adjacent line segments</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">intersection</span> <span class="o">=</span> <span class="n">find_intersection</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>

                <span class="c1"># Check if the intersection point is too far from either line segment</span>
                <span class="c1"># This helps prevent extending edges beyond reasonable bounds</span>
                <span class="n">dist_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">dist_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Use the maximum of line segment lengths as a reference</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Improved intersection validation</span>
                <span class="c1"># Calculate angle between segments to detect sharp corners</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">])</span>
                <span class="n">v1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
                <span class="n">v2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1_norm</span> <span class="o">*</span> <span class="n">v2_norm</span><span class="p">)</span>
                    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>

                    <span class="c1"># Check for very sharp angles that could create triangular artifacts</span>
                    <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span>
                    <span class="p">)</span>  <span class="c1"># &lt;30° or &gt;150°</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Determine whether to use intersection or segment endpoint</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">dist_to_seg1</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                    <span class="ow">or</span> <span class="n">dist_to_seg2</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                    <span class="ow">or</span> <span class="n">is_sharp_angle</span>
                <span class="p">):</span>
                    <span class="c1"># Use a more conservative approach for problematic intersections</span>
                    <span class="c1"># Use the closer endpoint between segments</span>
                    <span class="n">dist_x2_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">dist_x3_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">dist_x2_to_seg2</span> <span class="o">&lt;=</span> <span class="n">dist_x3_to_seg1</span><span class="p">:</span>
                        <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If intersection calculation fails, use the endpoint of the first segment</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>

        <span class="c1"># Connect last segment with first segment</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="n">find_intersection</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>

            <span class="c1"># Check if the intersection point is too far from either line segment</span>
            <span class="n">dist_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">dist_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Apply same sharp angle detection for closing segment</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">])</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">])</span>
            <span class="n">v1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="n">v2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1_norm</span> <span class="o">*</span> <span class="n">v2_norm</span><span class="p">)</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>
                <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">dist_to_seg1</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="ow">or</span> <span class="n">dist_to_seg2</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="ow">or</span> <span class="n">is_sharp_angle</span>
            <span class="p">):</span>
                <span class="c1"># Use conservative approach for closing segment</span>
                <span class="n">dist_x2_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">dist_x3_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">dist_x2_to_seg2</span> <span class="o">&lt;=</span> <span class="n">dist_x3_to_seg1</span><span class="p">:</span>
                    <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If intersection calculation fails, use the endpoint of the last segment</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>

        <span class="c1"># Ensure the ring is closed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ring</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rdp</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simplifies a given array of points using the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            epsilon (float, optional): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>
<span class="sd">            algo (str, optional): Algorithm to use (&#39;iter&#39; or &#39;rec&#39;)</span>
<span class="sd">            return_mask (bool, optional): Whether to return a mask instead of the simplified array</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray or list: Simplified points or mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">pldist</span>

        <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;iter&quot;</span><span class="p">:</span>
            <span class="n">algo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">rdp_iter</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="n">return_mask</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;rec&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_mask</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;return_mask=True not supported with algo=&quot;rec&quot;&#39;</span>
                <span class="p">)</span>
            <span class="n">algo</span> <span class="o">=</span> <span class="n">rdp_rec</span>

        <span class="k">if</span> <span class="s2">&quot;numpy&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">M</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">algo</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">algo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pldist</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the distance from &#39;point&#39; to the line given by &#39;start&#39; and &#39;end&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            point (numpy.ndarray): Point coordinates</span>
<span class="sd">            start (numpy.ndarray): Start point of the line</span>
<span class="sd">            end (numpy.ndarray): End point of the line</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Distance from point to line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="c1"># Fix for NumPy 2.0 deprecation warning - handle 2D vectors properly</span>
        <span class="c1"># Instead of using cross product directly, calculate the area of the</span>
        <span class="c1"># parallelogram formed by the vectors and divide by the length of the line</span>
        <span class="n">line_vec</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">point_vec</span> <span class="o">=</span> <span class="n">point</span> <span class="o">-</span> <span class="n">start</span>

        <span class="c1"># Area of parallelogram = |a|*|b|*sin(θ)</span>
        <span class="c1"># For 2D vectors: |a×b| = |a|*|b|*sin(θ) = determinant([ax, ay], [bx, by])</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">line_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">point_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">point_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Distance = Area / |line_vec|</span>
        <span class="k">return</span> <span class="n">area</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rdp_rec</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">pldist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursive implementation of the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            epsilon (float): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Simplified points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">dmax</span> <span class="o">=</span> <span class="n">d</span>

        <span class="k">if</span> <span class="n">dmax</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">rdp_rec</span><span class="p">(</span><span class="n">M</span><span class="p">[:</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rdp_rec</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">index</span><span class="p">:],</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rdp_iter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">pldist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal iterative implementation of the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            start_index (int): Start index</span>
<span class="sd">            last_index (int): Last index</span>
<span class="sd">            epsilon (float): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Boolean mask of points to keep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">])</span>
        <span class="n">global_start_index</span> <span class="o">=</span> <span class="n">start_index</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">last_index</span> <span class="o">-</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">stk</span><span class="p">:</span>
            <span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="n">dmax</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">start_index</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">global_start_index</span><span class="p">]:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">start_index</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">last_index</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">dmax</span> <span class="o">=</span> <span class="n">d</span>

            <span class="k">if</span> <span class="n">dmax</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_index</span><span class="p">,</span> <span class="n">index</span><span class="p">])</span>
                <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="p">):</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">global_start_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">indices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rdp_iter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">pldist</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterative implementation of the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            epsilon (float): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>
<span class="sd">            return_mask (bool, optional): Whether to return a mask instead of the simplified array</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Simplified points or boolean mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">_rdp_iter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">M</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Read the raster data</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the first band (assuming it contains the mask)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Extract shapes from the raster mask</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">))</span>

        <span class="c1"># Initialize progress bar</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span><span class="si">}</span><span class="s2"> features...&quot;</span><span class="p">)</span>

        <span class="c1"># Convert shapes to GeoJSON features</span>
        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting features&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;shape&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only process non-zero values (actual objects)</span>
                <span class="c1"># Convert GeoJSON geometry to Shapely polygon</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Skip tiny polygons</span>
                <span class="k">if</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
                    <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Check if shape is triangular and if we want to avoid triangular shapes</span>
                <span class="k">if</span> <span class="n">detect_triangles</span><span class="p">:</span>
                    <span class="c1"># Create a simplified version to check number of vertices</span>
                    <span class="n">simple_polygon</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">simple_polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span>
                    <span class="p">):</span>  <span class="c1"># 3 points + closing point</span>
                        <span class="c1"># Likely a triangular shape - skip orthogonalization</span>
                        <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                <span class="c1"># Process larger, non-triangular polygons</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Convert shapely polygon to a ring format for orthogonalization</span>
                    <span class="n">exterior_ring</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
                    <span class="n">interior_rings</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">interior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">interior</span> <span class="ow">in</span> <span class="n">polygon</span><span class="o">.</span><span class="n">interiors</span>
                    <span class="p">]</span>

                    <span class="c1"># Calculate bounding box aspect ratio to help with parameter tuning</span>
                    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span>
                    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

                    <span class="c1"># Determine if this shape is likely to be a building/rectangular object</span>
                    <span class="c1"># Long thin objects might require different treatment</span>
                    <span class="n">is_rectangular</span> <span class="o">=</span> <span class="n">aspect_ratio</span> <span class="o">&lt;</span> <span class="mf">3.0</span>

                    <span class="c1"># Rectangular objects usually need more careful orthogonalization</span>
                    <span class="n">epsilon_adjusted</span> <span class="o">=</span> <span class="n">epsilon</span>
                    <span class="n">min_segments_adjusted</span> <span class="o">=</span> <span class="n">min_segments</span>

                    <span class="k">if</span> <span class="n">is_rectangular</span><span class="p">:</span>
                        <span class="c1"># For rectangular objects, use more conservative epsilon</span>
                        <span class="n">epsilon_adjusted</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="mf">0.75</span>
                        <span class="c1"># Ensure we get at least 4 points for a proper rectangle</span>
                        <span class="n">min_segments_adjusted</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_segments</span><span class="p">)</span>

                    <span class="c1"># Orthogonalize the exterior and interior rings</span>
                    <span class="n">orthogonalized_exterior</span> <span class="o">=</span> <span class="n">orthogonalize_ring</span><span class="p">(</span>
                        <span class="n">exterior_ring</span><span class="p">,</span>
                        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon_adjusted</span><span class="p">,</span>
                        <span class="n">min_segments</span><span class="o">=</span><span class="n">min_segments_adjusted</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">orthogonalized_interiors</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">orthogonalize_ring</span><span class="p">(</span>
                            <span class="n">ring</span><span class="p">,</span>
                            <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon_adjusted</span><span class="p">,</span>
                            <span class="n">min_segments</span><span class="o">=</span><span class="n">min_segments_adjusted</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">interior_rings</span>
                    <span class="p">]</span>

                    <span class="c1"># Validate the result - calculate area change</span>
                    <span class="n">original_area</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">orthogonalized_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">orthogonalized_exterior</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">orthogonalized_poly</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                        <span class="n">area_ratio</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">orthogonalized_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">original_area</span>
                            <span class="k">if</span> <span class="n">original_area</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>

                        <span class="c1"># If area changed too much, revert to original</span>
                        <span class="k">if</span> <span class="n">area_ratio</span> <span class="o">&lt;</span> <span class="n">area_tolerance</span> <span class="ow">or</span> <span class="n">area_ratio</span> <span class="o">&gt;</span> <span class="p">(</span>
                            <span class="mf">1.0</span> <span class="o">/</span> <span class="n">area_tolerance</span>
                        <span class="p">):</span>
                            <span class="c1"># Use original polygon instead</span>
                            <span class="n">geometry</span> <span class="o">=</span> <span class="n">shape</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Create a new geometry with orthogonalized rings</span>
                            <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">orthogonalized_exterior</span><span class="p">],</span>
                            <span class="p">}</span>

                            <span class="c1"># Add interior rings if they exist</span>
                            <span class="k">if</span> <span class="n">orthogonalized_interiors</span><span class="p">:</span>
                                <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">ring</span> <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">orthogonalized_interiors</span><span class="p">]</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If resulting polygon is invalid, use original</span>
                        <span class="n">geometry</span> <span class="o">=</span> <span class="n">shape</span>

                    <span class="c1"># Add the feature to the list</span>
                    <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Keep the original shape if orthogonalization fails</span>
                    <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="c1"># Create the final GeoJSON structure</span>
        <span class="n">geojson</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)}},</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features_list</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Convert to GeoDataFrame and set the CRS</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Save to file if output_path is provided</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.plot_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">bright</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chnls</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.plot_batch" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot a batch of images and masks. This function is adapted from the plot_batch()
function in the torchgeo library at
https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html
Credit to the torchgeo developers for the original implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The batch containing images and masks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bright</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The brightness factor. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cols</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of columns in the plot grid. Defaults to 4.</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of each plot. Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chnls</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The channels to use for RGB. Defaults to [2, 1, 0].</p>
              </div>
            </td>
            <td>
                  <code>[2, 1, 0]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to use for masks. Defaults to "Blues".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Blues&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_batch</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">bright</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">chnls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a batch of images and masks. This function is adapted from the plot_batch()</span>
<span class="sd">    function in the torchgeo library at</span>
<span class="sd">    https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html</span>
<span class="sd">    Credit to the torchgeo developers for the original implementation.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (Dict[str, Any]): The batch containing images and masks.</span>
<span class="sd">        bright (float, optional): The brightness factor. Defaults to 1.0.</span>
<span class="sd">        cols (int, optional): The number of columns in the plot grid. Defaults to 4.</span>
<span class="sd">        width (int, optional): The width of each plot. Defaults to 5.</span>
<span class="sd">        chnls (List[int], optional): The channels to use for RGB. Defaults to [2, 1, 0].</span>
<span class="sd">        cmap (str, optional): The colormap to use for masks. Defaults to &quot;Blues&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">unbind_samples</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Your torchgeo version is too old. Please upgrade to the latest version using &#39;pip install -U torchgeo&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get the samples and the number of items in the batch</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">unbind_samples</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="c1"># if batch contains images and masks, the number of images will be doubled</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># calculate the number of rows in the grid</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">cols</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">cols</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># create a grid</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">):</span>
        <span class="c1"># plot the images on the even axis</span>
        <span class="n">plot_images</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span>
            <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[::</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">chnls</span><span class="o">=</span><span class="n">chnls</span><span class="p">,</span>
            <span class="n">bright</span><span class="o">=</span><span class="n">bright</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># plot the masks on the odd axis</span>
        <span class="n">plot_masks</span><span class="p">(</span><span class="n">masks</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span> <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">plot_images</span><span class="p">(</span>
                <span class="n">images</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span>
                <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">chnls</span><span class="o">=</span><span class="n">chnls</span><span class="p">,</span>
                <span class="n">bright</span><span class="o">=</span><span class="n">bright</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">plot_masks</span><span class="p">(</span>
                <span class="n">masks</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span> <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.plot_images" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">chnls</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bright</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.geoai.plot_images" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot a list of images.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>images</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The images to plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axs</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="matplotlib.pyplot.Axes">Axes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axes to plot the images on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chnls</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The channels to use for RGB. Defaults to [2, 1, 0].</p>
              </div>
            </td>
            <td>
                  <code>[2, 1, 0]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bright</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The brightness factor. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_images</span><span class="p">(</span>
    <span class="n">images</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">axs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span>
    <span class="n">chnls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">bright</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a list of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        images (Iterable[torch.Tensor]): The images to plot.</span>
<span class="sd">        axs (Iterable[plt.Axes]): The axes to plot the images on.</span>
<span class="sd">        chnls (List[int], optional): The channels to use for RGB. Defaults to [2, 1, 0].</span>
<span class="sd">        bright (float, optional): The brightness factor. Defaults to 1.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">bright</span> <span class="o">*</span> <span class="n">img</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">chnls</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.plot_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_masks</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.plot_masks" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot a list of masks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>masks</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The masks to plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axs</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="matplotlib.pyplot.Axes">Axes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axes to plot the masks on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to use. Defaults to "Blues".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Blues&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_masks</span><span class="p">(</span>
    <span class="n">masks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">axs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span> <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Blues&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a list of masks.</span>

<span class="sd">    Args:</span>
<span class="sd">        masks (Iterable[torch.Tensor]): The masks to plot.</span>
<span class="sd">        axs (Iterable[plt.Axes]): The axes to plot the masks on.</span>
<span class="sd">        cmap (str, optional): The colormap to use. Defaults to &quot;Blues&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.plot_performance_metrics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_performance_metrics</span><span class="p">(</span><span class="n">history_path</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">csv_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.plot_performance_metrics" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot performance metrics from a training history object and return as DataFrame.</p>
<p>This function loads training history, plots available metrics (loss, IoU, F1,
precision, recall), optionally exports to CSV, and returns all metrics as a
pandas DataFrame for further analysis.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>history_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved training history (.pth file).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size in inches. If None,
automatically determined based on number of metrics.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print best and final metric values. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the plot image. If None, plot is not saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>csv_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to export metrics as CSV. If None, CSV is not exported.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for plt.savefig().</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: DataFrame containing all metrics with columns for epoch and each metric.
Columns include: 'epoch', 'train_loss', 'val_loss', 'val_iou', 'val_f1',
'val_precision', 'val_recall' (depending on availability in history).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>df = plot_performance_metrics(
...     'training_history.pth',
...     save_path='metrics_plot.png',
...     csv_path='metrics.csv'
... )
print(df.head())</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8766</span>
<span class="normal">8767</span>
<span class="normal">8768</span>
<span class="normal">8769</span>
<span class="normal">8770</span>
<span class="normal">8771</span>
<span class="normal">8772</span>
<span class="normal">8773</span>
<span class="normal">8774</span>
<span class="normal">8775</span>
<span class="normal">8776</span>
<span class="normal">8777</span>
<span class="normal">8778</span>
<span class="normal">8779</span>
<span class="normal">8780</span>
<span class="normal">8781</span>
<span class="normal">8782</span>
<span class="normal">8783</span>
<span class="normal">8784</span>
<span class="normal">8785</span>
<span class="normal">8786</span>
<span class="normal">8787</span>
<span class="normal">8788</span>
<span class="normal">8789</span>
<span class="normal">8790</span>
<span class="normal">8791</span>
<span class="normal">8792</span>
<span class="normal">8793</span>
<span class="normal">8794</span>
<span class="normal">8795</span>
<span class="normal">8796</span>
<span class="normal">8797</span>
<span class="normal">8798</span>
<span class="normal">8799</span>
<span class="normal">8800</span>
<span class="normal">8801</span>
<span class="normal">8802</span>
<span class="normal">8803</span>
<span class="normal">8804</span>
<span class="normal">8805</span>
<span class="normal">8806</span>
<span class="normal">8807</span>
<span class="normal">8808</span>
<span class="normal">8809</span>
<span class="normal">8810</span>
<span class="normal">8811</span>
<span class="normal">8812</span>
<span class="normal">8813</span>
<span class="normal">8814</span>
<span class="normal">8815</span>
<span class="normal">8816</span>
<span class="normal">8817</span>
<span class="normal">8818</span>
<span class="normal">8819</span>
<span class="normal">8820</span>
<span class="normal">8821</span>
<span class="normal">8822</span>
<span class="normal">8823</span>
<span class="normal">8824</span>
<span class="normal">8825</span>
<span class="normal">8826</span>
<span class="normal">8827</span>
<span class="normal">8828</span>
<span class="normal">8829</span>
<span class="normal">8830</span>
<span class="normal">8831</span>
<span class="normal">8832</span>
<span class="normal">8833</span>
<span class="normal">8834</span>
<span class="normal">8835</span>
<span class="normal">8836</span>
<span class="normal">8837</span>
<span class="normal">8838</span>
<span class="normal">8839</span>
<span class="normal">8840</span>
<span class="normal">8841</span>
<span class="normal">8842</span>
<span class="normal">8843</span>
<span class="normal">8844</span>
<span class="normal">8845</span>
<span class="normal">8846</span>
<span class="normal">8847</span>
<span class="normal">8848</span>
<span class="normal">8849</span>
<span class="normal">8850</span>
<span class="normal">8851</span>
<span class="normal">8852</span>
<span class="normal">8853</span>
<span class="normal">8854</span>
<span class="normal">8855</span>
<span class="normal">8856</span>
<span class="normal">8857</span>
<span class="normal">8858</span>
<span class="normal">8859</span>
<span class="normal">8860</span>
<span class="normal">8861</span>
<span class="normal">8862</span>
<span class="normal">8863</span>
<span class="normal">8864</span>
<span class="normal">8865</span>
<span class="normal">8866</span>
<span class="normal">8867</span>
<span class="normal">8868</span>
<span class="normal">8869</span>
<span class="normal">8870</span>
<span class="normal">8871</span>
<span class="normal">8872</span>
<span class="normal">8873</span>
<span class="normal">8874</span>
<span class="normal">8875</span>
<span class="normal">8876</span>
<span class="normal">8877</span>
<span class="normal">8878</span>
<span class="normal">8879</span>
<span class="normal">8880</span>
<span class="normal">8881</span>
<span class="normal">8882</span>
<span class="normal">8883</span>
<span class="normal">8884</span>
<span class="normal">8885</span>
<span class="normal">8886</span>
<span class="normal">8887</span>
<span class="normal">8888</span>
<span class="normal">8889</span>
<span class="normal">8890</span>
<span class="normal">8891</span>
<span class="normal">8892</span>
<span class="normal">8893</span>
<span class="normal">8894</span>
<span class="normal">8895</span>
<span class="normal">8896</span>
<span class="normal">8897</span>
<span class="normal">8898</span>
<span class="normal">8899</span>
<span class="normal">8900</span>
<span class="normal">8901</span>
<span class="normal">8902</span>
<span class="normal">8903</span>
<span class="normal">8904</span>
<span class="normal">8905</span>
<span class="normal">8906</span>
<span class="normal">8907</span>
<span class="normal">8908</span>
<span class="normal">8909</span>
<span class="normal">8910</span>
<span class="normal">8911</span>
<span class="normal">8912</span>
<span class="normal">8913</span>
<span class="normal">8914</span>
<span class="normal">8915</span>
<span class="normal">8916</span>
<span class="normal">8917</span>
<span class="normal">8918</span>
<span class="normal">8919</span>
<span class="normal">8920</span>
<span class="normal">8921</span>
<span class="normal">8922</span>
<span class="normal">8923</span>
<span class="normal">8924</span>
<span class="normal">8925</span>
<span class="normal">8926</span>
<span class="normal">8927</span>
<span class="normal">8928</span>
<span class="normal">8929</span>
<span class="normal">8930</span>
<span class="normal">8931</span>
<span class="normal">8932</span>
<span class="normal">8933</span>
<span class="normal">8934</span>
<span class="normal">8935</span>
<span class="normal">8936</span>
<span class="normal">8937</span>
<span class="normal">8938</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_performance_metrics</span><span class="p">(</span>
    <span class="n">history_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">csv_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot performance metrics from a training history object and return as DataFrame.</span>

<span class="sd">    This function loads training history, plots available metrics (loss, IoU, F1,</span>
<span class="sd">    precision, recall), optionally exports to CSV, and returns all metrics as a</span>
<span class="sd">    pandas DataFrame for further analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        history_path (str): Path to the saved training history (.pth file).</span>
<span class="sd">        figsize (Optional[Tuple[int, int]]): Figure size in inches. If None,</span>
<span class="sd">            automatically determined based on number of metrics.</span>
<span class="sd">        verbose (bool): Whether to print best and final metric values. Defaults to True.</span>
<span class="sd">        save_path (Optional[str]): Path to save the plot image. If None, plot is not saved.</span>
<span class="sd">        csv_path (Optional[str]): Path to export metrics as CSV. If None, CSV is not exported.</span>
<span class="sd">        kwargs (Optional[Dict]): Additional keyword arguments for plt.savefig().</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame containing all metrics with columns for epoch and each metric.</span>
<span class="sd">            Columns include: &#39;epoch&#39;, &#39;train_loss&#39;, &#39;val_loss&#39;, &#39;val_iou&#39;, &#39;val_f1&#39;,</span>
<span class="sd">            &#39;val_precision&#39;, &#39;val_recall&#39; (depending on availability in history).</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; df = plot_performance_metrics(</span>
<span class="sd">        ...     &#39;training_history.pth&#39;,</span>
<span class="sd">        ...     save_path=&#39;metrics_plot.png&#39;,</span>
<span class="sd">        ...     csv_path=&#39;metrics.csv&#39;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(df.head())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">history_path</span><span class="p">)</span>

    <span class="c1"># Handle different key naming conventions</span>
    <span class="n">train_loss_key</span> <span class="o">=</span> <span class="s2">&quot;train_losses&quot;</span> <span class="k">if</span> <span class="s2">&quot;train_losses&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;train_loss&quot;</span>
    <span class="n">val_loss_key</span> <span class="o">=</span> <span class="s2">&quot;val_losses&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_losses&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_loss&quot;</span>
    <span class="n">val_iou_key</span> <span class="o">=</span> <span class="s2">&quot;val_ious&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_ious&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_iou&quot;</span>
    <span class="c1"># Support both new (f1) and old (dice) key formats for backward compatibility</span>
    <span class="n">val_f1_key</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;val_f1s&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;val_f1s&quot;</span> <span class="ow">in</span> <span class="n">history</span>
        <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;val_dices&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_dices&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_dice&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Add support for precision and recall</span>
    <span class="n">val_precision_key</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;val_precisions&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_precisions&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_precision&quot;</span>
    <span class="p">)</span>
    <span class="n">val_recall_key</span> <span class="o">=</span> <span class="s2">&quot;val_recalls&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_recalls&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_recall&quot;</span>

    <span class="c1"># Collect available metrics for plotting</span>
    <span class="n">available_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metric_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Loss&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">train_loss_key</span><span class="p">,</span> <span class="n">val_loss_key</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Train Loss&quot;</span><span class="p">,</span> <span class="s2">&quot;Val Loss&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;IoU&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">val_iou_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Val IoU&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;F1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">val_f1_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Val F1&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;Precision&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">val_precision_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Val Precision&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;Recall&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">val_recall_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Val Recall&quot;</span><span class="p">]),</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metric_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key1</span> <span class="ow">in</span> <span class="n">history</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key2</span> <span class="ow">and</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">history</span><span class="p">):</span>
            <span class="n">available_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>

    <span class="c1"># Determine number of subplots and figure size</span>
    <span class="n">n_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_metrics</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">n_plots</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Create DataFrame for all metrics</span>
    <span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Add epochs</span>
    <span class="k">if</span> <span class="s2">&quot;epochs&quot;</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>
        <span class="n">n_epochs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">train_loss_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">n_epochs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">train_loss_key</span><span class="p">])</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Add all available metrics to DataFrame</span>
    <span class="k">if</span> <span class="n">train_loss_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">train_loss_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">val_loss_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">val_loss_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">val_iou_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;val_iou&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">val_iou_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">val_f1_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;val_f1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">val_f1_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">val_precision_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;val_precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">val_precision_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">val_recall_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">df_data</span><span class="p">[</span><span class="s2">&quot;val_recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">val_recall_key</span><span class="p">]</span>

    <span class="c1"># Create DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_data</span><span class="p">)</span>

    <span class="c1"># Export to CSV if requested</span>
    <span class="k">if</span> <span class="n">csv_path</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metrics exported to: </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create plots</span>
    <span class="k">if</span> <span class="n">n_plots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">available_metrics</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;Loss&quot;</span><span class="p">:</span>
                <span class="c1"># Special handling for loss (has both train and val)</span>
                <span class="k">if</span> <span class="n">key1</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">key1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">key2</span> <span class="ow">and</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">key2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Single metric plots</span>
                <span class="k">if</span> <span class="n">key1</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">key1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;dpi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
            <span class="k">if</span> <span class="s2">&quot;bbox_inches&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;bbox_inches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tight&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Print summary statistics</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Performance Metrics Summary ===&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_iou_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;IoU     - Best: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_iou_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Final: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_iou_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_f1_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;F1      - Best: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_f1_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Final: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_f1_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_precision_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Precision - Best: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_precision_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Final: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_precision_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_recall_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Recall  - Best: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_recall_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Final: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_recall_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_loss_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Val Loss - Best: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_loss_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Final: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_loss_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===================================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.plot_prediction_comparison" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_prediction_comparison</span><span class="p">(</span><span class="n">original_image</span><span class="p">,</span> <span class="n">prediction_image</span><span class="p">,</span> <span class="n">ground_truth_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prediction_colormap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ground_truth_colormap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">original_colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.plot_prediction_comparison" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot original image, prediction, and optional ground truth side by side.</p>
<p>Supports input as file paths, NumPy arrays, or PIL Images. For multi-band
images, selected channels can be specified via <code>indexes</code>. If the image data
is not normalized (e.g., Sentinel-2 [0, 10000]), the <code>divider</code> can be used
to scale values for visualization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>original_image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original input image as a file path, NumPy array, or PIL Image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted segmentation mask image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth_image</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image.Image">Image</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth mask image. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>titles</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of titles for the subplots. If not provided, default titles are used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the entire figure in inches. Defaults to (15, 5).</p>
              </div>
            </td>
            <td>
                  <code>(15, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified, saves the figure to this path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_plot</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display the figure using plt.show(). Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_colormap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for the prediction mask. Defaults to "gray".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gray&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth_colormap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for the ground truth mask. Defaults to "gray".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gray&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_colormap</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for the original image if it's grayscale. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band/channel indexes (0-based for NumPy, 1-based for rasterio) to extract from the original image.
Useful for multi-band imagery like Sentinel-2. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>divider</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to divide the original image by for normalization (e.g., 10000 for reflectance). Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>matplotlib.figure.Figure:
The generated matplotlib figure object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8954</span>
<span class="normal">8955</span>
<span class="normal">8956</span>
<span class="normal">8957</span>
<span class="normal">8958</span>
<span class="normal">8959</span>
<span class="normal">8960</span>
<span class="normal">8961</span>
<span class="normal">8962</span>
<span class="normal">8963</span>
<span class="normal">8964</span>
<span class="normal">8965</span>
<span class="normal">8966</span>
<span class="normal">8967</span>
<span class="normal">8968</span>
<span class="normal">8969</span>
<span class="normal">8970</span>
<span class="normal">8971</span>
<span class="normal">8972</span>
<span class="normal">8973</span>
<span class="normal">8974</span>
<span class="normal">8975</span>
<span class="normal">8976</span>
<span class="normal">8977</span>
<span class="normal">8978</span>
<span class="normal">8979</span>
<span class="normal">8980</span>
<span class="normal">8981</span>
<span class="normal">8982</span>
<span class="normal">8983</span>
<span class="normal">8984</span>
<span class="normal">8985</span>
<span class="normal">8986</span>
<span class="normal">8987</span>
<span class="normal">8988</span>
<span class="normal">8989</span>
<span class="normal">8990</span>
<span class="normal">8991</span>
<span class="normal">8992</span>
<span class="normal">8993</span>
<span class="normal">8994</span>
<span class="normal">8995</span>
<span class="normal">8996</span>
<span class="normal">8997</span>
<span class="normal">8998</span>
<span class="normal">8999</span>
<span class="normal">9000</span>
<span class="normal">9001</span>
<span class="normal">9002</span>
<span class="normal">9003</span>
<span class="normal">9004</span>
<span class="normal">9005</span>
<span class="normal">9006</span>
<span class="normal">9007</span>
<span class="normal">9008</span>
<span class="normal">9009</span>
<span class="normal">9010</span>
<span class="normal">9011</span>
<span class="normal">9012</span>
<span class="normal">9013</span>
<span class="normal">9014</span>
<span class="normal">9015</span>
<span class="normal">9016</span>
<span class="normal">9017</span>
<span class="normal">9018</span>
<span class="normal">9019</span>
<span class="normal">9020</span>
<span class="normal">9021</span>
<span class="normal">9022</span>
<span class="normal">9023</span>
<span class="normal">9024</span>
<span class="normal">9025</span>
<span class="normal">9026</span>
<span class="normal">9027</span>
<span class="normal">9028</span>
<span class="normal">9029</span>
<span class="normal">9030</span>
<span class="normal">9031</span>
<span class="normal">9032</span>
<span class="normal">9033</span>
<span class="normal">9034</span>
<span class="normal">9035</span>
<span class="normal">9036</span>
<span class="normal">9037</span>
<span class="normal">9038</span>
<span class="normal">9039</span>
<span class="normal">9040</span>
<span class="normal">9041</span>
<span class="normal">9042</span>
<span class="normal">9043</span>
<span class="normal">9044</span>
<span class="normal">9045</span>
<span class="normal">9046</span>
<span class="normal">9047</span>
<span class="normal">9048</span>
<span class="normal">9049</span>
<span class="normal">9050</span>
<span class="normal">9051</span>
<span class="normal">9052</span>
<span class="normal">9053</span>
<span class="normal">9054</span>
<span class="normal">9055</span>
<span class="normal">9056</span>
<span class="normal">9057</span>
<span class="normal">9058</span>
<span class="normal">9059</span>
<span class="normal">9060</span>
<span class="normal">9061</span>
<span class="normal">9062</span>
<span class="normal">9063</span>
<span class="normal">9064</span>
<span class="normal">9065</span>
<span class="normal">9066</span>
<span class="normal">9067</span>
<span class="normal">9068</span>
<span class="normal">9069</span>
<span class="normal">9070</span>
<span class="normal">9071</span>
<span class="normal">9072</span>
<span class="normal">9073</span>
<span class="normal">9074</span>
<span class="normal">9075</span>
<span class="normal">9076</span>
<span class="normal">9077</span>
<span class="normal">9078</span>
<span class="normal">9079</span>
<span class="normal">9080</span>
<span class="normal">9081</span>
<span class="normal">9082</span>
<span class="normal">9083</span>
<span class="normal">9084</span>
<span class="normal">9085</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_prediction_comparison</span><span class="p">(</span>
    <span class="n">original_image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span>
    <span class="n">prediction_image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span>
    <span class="n">ground_truth_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">titles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">prediction_colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ground_truth_colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">original_colormap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">divider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot original image, prediction, and optional ground truth side by side.</span>

<span class="sd">    Supports input as file paths, NumPy arrays, or PIL Images. For multi-band</span>
<span class="sd">    images, selected channels can be specified via `indexes`. If the image data</span>
<span class="sd">    is not normalized (e.g., Sentinel-2 [0, 10000]), the `divider` can be used</span>
<span class="sd">    to scale values for visualization.</span>

<span class="sd">    Args:</span>
<span class="sd">        original_image (Union[str, np.ndarray, Image.Image]):</span>
<span class="sd">            Original input image as a file path, NumPy array, or PIL Image.</span>
<span class="sd">        prediction_image (Union[str, np.ndarray, Image.Image]):</span>
<span class="sd">            Predicted segmentation mask image.</span>
<span class="sd">        ground_truth_image (Optional[Union[str, np.ndarray, Image.Image]], optional):</span>
<span class="sd">            Ground truth mask image. Defaults to None.</span>
<span class="sd">        titles (Optional[List[str]], optional):</span>
<span class="sd">            List of titles for the subplots. If not provided, default titles are used.</span>
<span class="sd">        figsize (Tuple[int, int], optional):</span>
<span class="sd">            Size of the entire figure in inches. Defaults to (15, 5).</span>
<span class="sd">        save_path (Optional[str], optional):</span>
<span class="sd">            If specified, saves the figure to this path. Defaults to None.</span>
<span class="sd">        show_plot (bool, optional):</span>
<span class="sd">            Whether to display the figure using plt.show(). Defaults to True.</span>
<span class="sd">        prediction_colormap (str, optional):</span>
<span class="sd">            Colormap to use for the prediction mask. Defaults to &quot;gray&quot;.</span>
<span class="sd">        ground_truth_colormap (str, optional):</span>
<span class="sd">            Colormap to use for the ground truth mask. Defaults to &quot;gray&quot;.</span>
<span class="sd">        original_colormap (Optional[str], optional):</span>
<span class="sd">            Colormap to use for the original image if it&#39;s grayscale. Defaults to None.</span>
<span class="sd">        indexes (Optional[List[int]], optional):</span>
<span class="sd">            List of band/channel indexes (0-based for NumPy, 1-based for rasterio) to extract from the original image.</span>
<span class="sd">            Useful for multi-band imagery like Sentinel-2. Defaults to None.</span>
<span class="sd">        divider (Optional[float], optional):</span>
<span class="sd">            Value to divide the original image by for normalization (e.g., 10000 for reflectance). Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.figure.Figure:</span>
<span class="sd">            The generated matplotlib figure object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_image</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to load image from various input types.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">img_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indexes</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>  <span class="c1"># 1-based</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_input</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img_input</span>
            <span class="k">if</span> <span class="n">indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indexes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported image type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="c1"># Load images</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">original_image</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">prediction_image</span><span class="p">)</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_load_image</span><span class="p">(</span><span class="n">ground_truth_image</span><span class="p">)</span> <span class="k">if</span> <span class="n">ground_truth_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># Apply divider normalization if requested</span>
    <span class="k">if</span> <span class="n">divider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">original</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Determine layout</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original Image&quot;</span><span class="p">,</span> <span class="s2">&quot;Prediction&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ground Truth&quot;</span><span class="p">)</span>

    <span class="c1"># Plot original</span>
    <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">original</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">original_colormap</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Prediction</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">prediction_colormap</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Ground truth</span>
    <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">ground_truth_colormap</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.print_raster_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">show_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></code>

<a href="#geoai.geoai.print_raster_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Print formatted information about a raster dataset and optionally show a preview.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_preview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a visual preview of the raster.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height). Defaults to (10, 8).</p>
              </div>
            </td>
            <td>
                  <code>(10, 8)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing raster information if successful, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_raster_info</span><span class="p">(</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">show_preview</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print formatted information about a raster dataset and optionally show a preview.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>
<span class="sd">        show_preview (bool, optional): Whether to display a visual preview of the raster.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height). Defaults to (10, 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing raster information if successful, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">get_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span>

        <span class="c1"># Print basic information</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;===== RASTER INFORMATION: </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2"> =====&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Driver: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimensions: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of bands: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data type: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate Reference System: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Georeferenced Bounds: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel Resolution: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NoData Value: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print band statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- Band Statistics -----&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band_stat</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;band_stats&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std Dev: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Show a preview if requested</span>
        <span class="k">if</span> <span class="n">show_preview</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># For multi-band images, show RGB composite or first band</span>
                <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># Try to show RGB composite</span>
                    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RGB Preview: </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Show first band for single-band images</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="n">show</span><span class="p">(</span>
                        <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Band 1 Preview: </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pixel Value&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading raster: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.print_vector_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">show_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></code>

<a href="#geoai.geoai.print_vector_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Print formatted information about a vector dataset and optionally show a preview.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_preview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a visual preview of the vector data.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height). Defaults to (10, 8).</p>
              </div>
            </td>
            <td>
                  <code>(10, 8)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing vector information if successful, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_vector_info</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">show_preview</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print formatted information about a vector dataset and optionally show a preview.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>
<span class="sd">        show_preview (bool, optional): Whether to display a visual preview of the vector data.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height). Defaults to (10, 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing vector information if successful, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">get_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Print basic information</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;===== VECTOR INFORMATION: </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2"> =====&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Driver: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature count: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;feature_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Geometry types: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate Reference System: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bounds: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of attributes: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;attribute_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute names: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;attribute_names&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print attribute statistics</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;attribute_stats&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- Attribute Statistics -----&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;attribute_stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute: </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">stat_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stat_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stat_value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">stat_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stat_value</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Show a preview if requested</span>
        <span class="k">if</span> <span class="n">show_preview</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vector_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview: </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># # Show a sample of the attribute table</span>
            <span class="c1"># if not gdf.empty:</span>
            <span class="c1">#     print(&quot;\n----- Sample of attribute table (first 5 rows) -----&quot;)</span>
            <span class="c1">#     print(gdf.head().to_string())</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading vector data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.raster_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">raster_to_vector</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">class_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">unique_attribute_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;geojson&#39;</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.geoai.raster_to_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a raster label mask to vector polygons.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input raster file (e.g., GeoTIFF).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output vector file. If None, returns GeoDataFrame without saving.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span> / <span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel values greater than this threshold will be vectorized.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum polygon area in square map units to keep.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for geometry simplification. None for no simplification.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_values</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute field for the class values.</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique_attribute_value</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to generate unique values for each shape within a class.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Format for output file - 'geojson', 'shapefile', 'gpkg'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;geojson&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_result</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to plot the resulting polygons overlaid on the raster.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame: A GeoDataFrame containing the vectorized polygons.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raster_to_vector</span><span class="p">(</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">min_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">class_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">unique_attribute_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
    <span class="n">plot_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a raster label mask to vector polygons.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the input raster file (e.g., GeoTIFF).</span>
<span class="sd">        output_path (str): Path to save the output vector file. If None, returns GeoDataFrame without saving.</span>
<span class="sd">        threshold (int/float): Pixel values greater than this threshold will be vectorized.</span>
<span class="sd">        min_area (float): Minimum polygon area in square map units to keep.</span>
<span class="sd">        simplify_tolerance (float): Tolerance for geometry simplification. None for no simplification.</span>
<span class="sd">        class_values (list): Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</span>
<span class="sd">        attribute_name (str): Name of the attribute field for the class values.</span>
<span class="sd">        unique_attribute_value (bool): Whether to generate unique values for each shape within a class.</span>
<span class="sd">        output_format (str): Format for output file - &#39;geojson&#39;, &#39;shapefile&#39;, &#39;gpkg&#39;.</span>
<span class="sd">        plot_result (bool): Whether to plot the resulting polygons overlaid on the raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: A GeoDataFrame containing the vectorized polygons.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the raster file</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get metadata</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Create mask based on threshold and class values</span>
        <span class="k">if</span> <span class="n">class_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a mask for each specified class value</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">class_values</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create a mask for values above threshold</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)}</span>
            <span class="n">class_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Default class</span>

        <span class="c1"># Initialize list to store features</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each class value</span>
        <span class="k">for</span> <span class="n">class_val</span> <span class="ow">in</span> <span class="n">class_values</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">class_val</span><span class="p">]</span>
            <span class="n">shape_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Vectorize the mask</span>
            <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
            <span class="p">):</span>
                <span class="c1"># Convert to shapely geometry</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>

                <span class="c1"># Skip small polygons</span>
                <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Simplify geometry if requested</span>
                <span class="k">if</span> <span class="n">simplify_tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tolerance</span><span class="p">)</span>

                <span class="c1"># Add to features list with class value</span>
                <span class="k">if</span> <span class="n">unique_attribute_value</span><span class="p">:</span>
                    <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="n">class_val</span> <span class="o">*</span> <span class="n">shape_count</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="n">class_val</span><span class="p">})</span>

                <span class="n">shape_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="n">all_features</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No features were extracted from the raster.&quot;</span><span class="p">)</span>
            <span class="c1"># Return empty GeoDataFrame with correct CRS</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">([],</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Save to file if requested</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create directory if it doesn&#39;t exist</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Save to file based on format</span>
            <span class="k">if</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;shapefile&quot;</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gpkg&quot;</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported output format: </span><span class="si">{</span><span class="n">output_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vectorized data saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Plot result if requested</span>
        <span class="k">if</span> <span class="n">plot_result</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

            <span class="c1"># Plot raster</span>
            <span class="n">raster_img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">raster_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use first 3 bands for RGB display</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="n">raster_img</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Normalize for display</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span> <span class="o">/</span> <span class="n">rgb</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>

            <span class="c1"># Plot vector boundaries</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raster with Vectorized Boundaries&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.raster_to_vector_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">raster_to_vector_batch</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;*.tif&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">class_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;geojson&#39;</span><span class="p">,</span> <span class="n">merge_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">merge_filename</span><span class="o">=</span><span class="s1">&#39;merged_vectors&#39;</span><span class="p">)</span></code>

<a href="#geoai.geoai.raster_to_vector_batch" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Batch convert multiple raster files to vector polygons.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory containing input raster files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save output vector files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pattern to match raster files (e.g., '*.tif').</p>
              </div>
            </td>
            <td>
                  <code>&#39;*.tif&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span> / <span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel values greater than this threshold will be vectorized.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum polygon area in square map units to keep.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for geometry simplification. None for no simplification.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_values</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute field for the class values.</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Format for output files - 'geojson', 'shapefile', 'gpkg'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;geojson&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to merge all output vectors into a single file.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filename for the merged output (without extension).</p>
              </div>
            </td>
            <td>
                  <code>&#39;merged_vectors&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame or None: If merge_output is True, returns the merged GeoDataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raster_to_vector_batch</span><span class="p">(</span>
    <span class="n">input_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*.tif&quot;</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">min_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">class_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
    <span class="n">merge_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">merge_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;merged_vectors&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch convert multiple raster files to vector polygons.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_dir (str): Directory containing input raster files.</span>
<span class="sd">        output_dir (str): Directory to save output vector files.</span>
<span class="sd">        pattern (str): Pattern to match raster files (e.g., &#39;*.tif&#39;).</span>
<span class="sd">        threshold (int/float): Pixel values greater than this threshold will be vectorized.</span>
<span class="sd">        min_area (float): Minimum polygon area in square map units to keep.</span>
<span class="sd">        simplify_tolerance (float): Tolerance for geometry simplification. None for no simplification.</span>
<span class="sd">        class_values (list): Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</span>
<span class="sd">        attribute_name (str): Name of the attribute field for the class values.</span>
<span class="sd">        output_format (str): Format for output files - &#39;geojson&#39;, &#39;shapefile&#39;, &#39;gpkg&#39;.</span>
<span class="sd">        merge_output (bool): Whether to merge all output vectors into a single file.</span>
<span class="sd">        merge_filename (str): Filename for the merged output (without extension).</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame or None: If merge_output is True, returns the merged GeoDataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>

    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get list of raster files</span>
    <span class="n">raster_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files matching pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in </span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raster_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> raster files to process&quot;</span><span class="p">)</span>

    <span class="c1"># Process each raster file</span>
    <span class="n">gdfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">raster_file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing rasters&quot;</span><span class="p">):</span>
        <span class="c1"># Get output filename</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">raster_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;shapefile&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.shp&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gpkg&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.gpkg&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported output format: </span><span class="si">{</span><span class="n">output_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Convert raster to vector</span>
        <span class="k">if</span> <span class="n">merge_output</span><span class="p">:</span>
            <span class="c1"># Don&#39;t save individual files if merging</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">raster_to_vector</span><span class="p">(</span>
                <span class="n">raster_file</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">min_area</span><span class="o">=</span><span class="n">min_area</span><span class="p">,</span>
                <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
                <span class="n">class_values</span><span class="o">=</span><span class="n">class_values</span><span class="p">,</span>
                <span class="n">attribute_name</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add filename as attribute</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;source_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
                <span class="n">gdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Save individual files</span>
            <span class="n">raster_to_vector</span><span class="p">(</span>
                <span class="n">raster_file</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">out_file</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">min_area</span><span class="o">=</span><span class="n">min_area</span><span class="p">,</span>
                <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
                <span class="n">class_values</span><span class="o">=</span><span class="n">class_values</span><span class="p">,</span>
                <span class="n">attribute_name</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span>
                <span class="n">output_format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Merge output if requested</span>
    <span class="k">if</span> <span class="n">merge_output</span> <span class="ow">and</span> <span class="n">gdfs</span><span class="p">:</span>
        <span class="n">merged_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gdfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Set CRS to the CRS of the first GeoDataFrame</span>
        <span class="k">if</span> <span class="n">merged_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gdfs</span><span class="p">:</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">gdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Save merged output</span>
        <span class="k">if</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span>
            <span class="n">merged_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">merge_filename</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">merged_file</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;shapefile&quot;</span><span class="p">:</span>
            <span class="n">merged_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">merge_filename</span><span class="si">}</span><span class="s2">.shp&quot;</span><span class="p">)</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">merged_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gpkg&quot;</span><span class="p">:</span>
            <span class="n">merged_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">merge_filename</span><span class="si">}</span><span class="s2">.gpkg&quot;</span><span class="p">)</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">merged_file</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merged vector data saved to </span><span class="si">{</span><span class="n">merged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged_gdf</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.read_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_raster</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.read_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Reads raster data from various formats using rioxarray.</p>
<p>This function reads raster data from local files or URLs into a rioxarray
data structure with preserved geospatial metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String path to the raster file or URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Integer or list of integers specifying which band(s) to read.
Defaults to None (all bands).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>masked</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean indicating whether to mask nodata values.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rioxarray.open_rasterio.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataArray">DataArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>xarray.DataArray: A DataArray containing the raster data with geospatial
metadata preserved.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file format is not supported or source cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Read a local GeoTIFF</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">raster</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;path/to/data.tif&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read only band 1 from a remote GeoTIFF</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">raster</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;https://example.com/data.tif&quot;</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read a raster without masking nodata values</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">raster</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;path/to/data.tif&quot;</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6156</span>
<span class="normal">6157</span>
<span class="normal">6158</span>
<span class="normal">6159</span>
<span class="normal">6160</span>
<span class="normal">6161</span>
<span class="normal">6162</span>
<span class="normal">6163</span>
<span class="normal">6164</span>
<span class="normal">6165</span>
<span class="normal">6166</span>
<span class="normal">6167</span>
<span class="normal">6168</span>
<span class="normal">6169</span>
<span class="normal">6170</span>
<span class="normal">6171</span>
<span class="normal">6172</span>
<span class="normal">6173</span>
<span class="normal">6174</span>
<span class="normal">6175</span>
<span class="normal">6176</span>
<span class="normal">6177</span>
<span class="normal">6178</span>
<span class="normal">6179</span>
<span class="normal">6180</span>
<span class="normal">6181</span>
<span class="normal">6182</span>
<span class="normal">6183</span>
<span class="normal">6184</span>
<span class="normal">6185</span>
<span class="normal">6186</span>
<span class="normal">6187</span>
<span class="normal">6188</span>
<span class="normal">6189</span>
<span class="normal">6190</span>
<span class="normal">6191</span>
<span class="normal">6192</span>
<span class="normal">6193</span>
<span class="normal">6194</span>
<span class="normal">6195</span>
<span class="normal">6196</span>
<span class="normal">6197</span>
<span class="normal">6198</span>
<span class="normal">6199</span>
<span class="normal">6200</span>
<span class="normal">6201</span>
<span class="normal">6202</span>
<span class="normal">6203</span>
<span class="normal">6204</span>
<span class="normal">6205</span>
<span class="normal">6206</span>
<span class="normal">6207</span>
<span class="normal">6208</span>
<span class="normal">6209</span>
<span class="normal">6210</span>
<span class="normal">6211</span>
<span class="normal">6212</span>
<span class="normal">6213</span>
<span class="normal">6214</span>
<span class="normal">6215</span>
<span class="normal">6216</span>
<span class="normal">6217</span>
<span class="normal">6218</span>
<span class="normal">6219</span>
<span class="normal">6220</span>
<span class="normal">6221</span>
<span class="normal">6222</span>
<span class="normal">6223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_raster</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">band</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">masked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads raster data from various formats using rioxarray.</span>

<span class="sd">    This function reads raster data from local files or URLs into a rioxarray</span>
<span class="sd">    data structure with preserved geospatial metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        source: String path to the raster file or URL.</span>
<span class="sd">        band: Integer or list of integers specifying which band(s) to read.</span>
<span class="sd">            Defaults to None (all bands).</span>
<span class="sd">        masked: Boolean indicating whether to mask nodata values.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rioxarray.open_rasterio.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.DataArray: A DataArray containing the raster data with geospatial</span>
<span class="sd">            metadata preserved.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the file format is not supported or source cannot be accessed.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Read a local GeoTIFF</span>
<span class="sd">        &gt;&gt;&gt; raster = read_raster(&quot;path/to/data.tif&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read only band 1 from a remote GeoTIFF</span>
<span class="sd">        &gt;&gt;&gt; raster = read_raster(&quot;https://example.com/data.tif&quot;, band=1)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read a raster without masking nodata values</span>
<span class="sd">        &gt;&gt;&gt; raster = read_raster(&quot;path/to/data.tif&quot;, masked=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RasterioIOError</span>

    <span class="c1"># Determine if source is a URL or local file</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">is_url</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]</span>

    <span class="c1"># If it&#39;s a local file, check if it exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster file does not exist: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Open the raster with rioxarray</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="n">masked</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Handle band selection if specified</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># Convert from 1-based indexing to 0-based indexing</span>
                <span class="n">band_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">band</span><span class="p">]</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">band_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Single band selection (convert from 1-based to 0-based indexing)</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">band</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">raster</span>

    <span class="k">except</span> <span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read raster from source &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading raster data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.read_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_vector</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.read_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Reads vector data from various formats including GeoParquet.</p>
<p>This function dynamically determines the file type based on extension
and reads it into a GeoDataFrame. It supports both local files and HTTP/HTTPS URLs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String path to the vector file or URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String or integer specifying which layer to read from multi-layer
files (only applicable for formats like GPKG, GeoJSON, etc.).
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the underlying reader.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame: A GeoDataFrame containing the vector data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file format is not supported or source cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Read a local shapefile</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;path/to/data.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read a GeoParquet file from URL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;https://example.com/data.parquet&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read a specific layer from a GeoPackage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;path/to/data.gpkg&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;layer_name&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6079</span>
<span class="normal">6080</span>
<span class="normal">6081</span>
<span class="normal">6082</span>
<span class="normal">6083</span>
<span class="normal">6084</span>
<span class="normal">6085</span>
<span class="normal">6086</span>
<span class="normal">6087</span>
<span class="normal">6088</span>
<span class="normal">6089</span>
<span class="normal">6090</span>
<span class="normal">6091</span>
<span class="normal">6092</span>
<span class="normal">6093</span>
<span class="normal">6094</span>
<span class="normal">6095</span>
<span class="normal">6096</span>
<span class="normal">6097</span>
<span class="normal">6098</span>
<span class="normal">6099</span>
<span class="normal">6100</span>
<span class="normal">6101</span>
<span class="normal">6102</span>
<span class="normal">6103</span>
<span class="normal">6104</span>
<span class="normal">6105</span>
<span class="normal">6106</span>
<span class="normal">6107</span>
<span class="normal">6108</span>
<span class="normal">6109</span>
<span class="normal">6110</span>
<span class="normal">6111</span>
<span class="normal">6112</span>
<span class="normal">6113</span>
<span class="normal">6114</span>
<span class="normal">6115</span>
<span class="normal">6116</span>
<span class="normal">6117</span>
<span class="normal">6118</span>
<span class="normal">6119</span>
<span class="normal">6120</span>
<span class="normal">6121</span>
<span class="normal">6122</span>
<span class="normal">6123</span>
<span class="normal">6124</span>
<span class="normal">6125</span>
<span class="normal">6126</span>
<span class="normal">6127</span>
<span class="normal">6128</span>
<span class="normal">6129</span>
<span class="normal">6130</span>
<span class="normal">6131</span>
<span class="normal">6132</span>
<span class="normal">6133</span>
<span class="normal">6134</span>
<span class="normal">6135</span>
<span class="normal">6136</span>
<span class="normal">6137</span>
<span class="normal">6138</span>
<span class="normal">6139</span>
<span class="normal">6140</span>
<span class="normal">6141</span>
<span class="normal">6142</span>
<span class="normal">6143</span>
<span class="normal">6144</span>
<span class="normal">6145</span>
<span class="normal">6146</span>
<span class="normal">6147</span>
<span class="normal">6148</span>
<span class="normal">6149</span>
<span class="normal">6150</span>
<span class="normal">6151</span>
<span class="normal">6152</span>
<span class="normal">6153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_vector</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads vector data from various formats including GeoParquet.</span>

<span class="sd">    This function dynamically determines the file type based on extension</span>
<span class="sd">    and reads it into a GeoDataFrame. It supports both local files and HTTP/HTTPS URLs.</span>

<span class="sd">    Args:</span>
<span class="sd">        source: String path to the vector file or URL.</span>
<span class="sd">        layer: String or integer specifying which layer to read from multi-layer</span>
<span class="sd">            files (only applicable for formats like GPKG, GeoJSON, etc.).</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the underlying reader.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: A GeoDataFrame containing the vector data.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the file format is not supported or source cannot be accessed.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Read a local shapefile</span>
<span class="sd">        &gt;&gt;&gt; gdf = read_vector(&quot;path/to/data.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read a GeoParquet file from URL</span>
<span class="sd">        &gt;&gt;&gt; gdf = read_vector(&quot;https://example.com/data.parquet&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read a specific layer from a GeoPackage</span>
<span class="sd">        &gt;&gt;&gt; gdf = read_vector(&quot;path/to/data.gpkg&quot;, layer=&quot;layer_name&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">fiona</span>

    <span class="c1"># Determine if source is a URL or local file</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">is_url</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]</span>

    <span class="c1"># If it&#39;s a local file, check if it exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File does not exist: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get file extension</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Handle GeoParquet files</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;.pq&quot;</span><span class="p">,</span> <span class="s2">&quot;.geoparquet&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Handle common vector formats</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.shp&quot;</span><span class="p">,</span> <span class="s2">&quot;.geojson&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;.gml&quot;</span><span class="p">,</span> <span class="s2">&quot;.kml&quot;</span><span class="p">,</span> <span class="s2">&quot;.gpx&quot;</span><span class="p">]:</span>
        <span class="c1"># For formats that might have multiple layers</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;.gml&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Try to use fiona to identify valid layers for formats that might have them</span>
    <span class="c1"># Only attempt this for local files as fiona.listlayers might not work with URLs</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;.gml&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_url</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">listlayers</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If listing layers fails, we&#39;ll fall through to the generic read attempt</span>
            <span class="k">pass</span>

    <span class="c1"># For other formats or when layer listing fails, attempt to read using GeoPandas</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read from source &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.region_groups" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">region_groups</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.region_groups" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Segment regions in an image and filter them based on size.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="xarray.DataArray">DataArray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input image, can be a file
path, xarray DataArray, or numpy array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>connectivity</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Connectivity for labeling. Defaults to 1
for 4-connectivity. Use 2 for 8-connectivity.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum size of regions to keep. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum size of regions to keep.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for filling holes.
Defaults to None, which is equal to min_size.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>properties</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of properties to measure.
See https://scikit-image.org/docs/stable/api/skimage.measure.html#skimage.measure.regionprops
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intensity_image</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="xarray.DataArray">DataArray</span>, <span title="numpy.ndarray">ndarray</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intensity image to measure properties. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_csv</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the properties as a CSV file.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_vector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the vector file.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_image</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output image.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="pandas.DataFrame">DataFrame</span>], <span title="typing.Tuple">Tuple</span>[<span title="xarray.DataArray">DataArray</span>, <span title="pandas.DataFrame">DataFrame</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union[Tuple[np.ndarray, pd.DataFrame], Tuple[xr.DataArray, pd.DataFrame]]: Labeled image and properties DataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6247</span>
<span class="normal">6248</span>
<span class="normal">6249</span>
<span class="normal">6250</span>
<span class="normal">6251</span>
<span class="normal">6252</span>
<span class="normal">6253</span>
<span class="normal">6254</span>
<span class="normal">6255</span>
<span class="normal">6256</span>
<span class="normal">6257</span>
<span class="normal">6258</span>
<span class="normal">6259</span>
<span class="normal">6260</span>
<span class="normal">6261</span>
<span class="normal">6262</span>
<span class="normal">6263</span>
<span class="normal">6264</span>
<span class="normal">6265</span>
<span class="normal">6266</span>
<span class="normal">6267</span>
<span class="normal">6268</span>
<span class="normal">6269</span>
<span class="normal">6270</span>
<span class="normal">6271</span>
<span class="normal">6272</span>
<span class="normal">6273</span>
<span class="normal">6274</span>
<span class="normal">6275</span>
<span class="normal">6276</span>
<span class="normal">6277</span>
<span class="normal">6278</span>
<span class="normal">6279</span>
<span class="normal">6280</span>
<span class="normal">6281</span>
<span class="normal">6282</span>
<span class="normal">6283</span>
<span class="normal">6284</span>
<span class="normal">6285</span>
<span class="normal">6286</span>
<span class="normal">6287</span>
<span class="normal">6288</span>
<span class="normal">6289</span>
<span class="normal">6290</span>
<span class="normal">6291</span>
<span class="normal">6292</span>
<span class="normal">6293</span>
<span class="normal">6294</span>
<span class="normal">6295</span>
<span class="normal">6296</span>
<span class="normal">6297</span>
<span class="normal">6298</span>
<span class="normal">6299</span>
<span class="normal">6300</span>
<span class="normal">6301</span>
<span class="normal">6302</span>
<span class="normal">6303</span>
<span class="normal">6304</span>
<span class="normal">6305</span>
<span class="normal">6306</span>
<span class="normal">6307</span>
<span class="normal">6308</span>
<span class="normal">6309</span>
<span class="normal">6310</span>
<span class="normal">6311</span>
<span class="normal">6312</span>
<span class="normal">6313</span>
<span class="normal">6314</span>
<span class="normal">6315</span>
<span class="normal">6316</span>
<span class="normal">6317</span>
<span class="normal">6318</span>
<span class="normal">6319</span>
<span class="normal">6320</span>
<span class="normal">6321</span>
<span class="normal">6322</span>
<span class="normal">6323</span>
<span class="normal">6324</span>
<span class="normal">6325</span>
<span class="normal">6326</span>
<span class="normal">6327</span>
<span class="normal">6328</span>
<span class="normal">6329</span>
<span class="normal">6330</span>
<span class="normal">6331</span>
<span class="normal">6332</span>
<span class="normal">6333</span>
<span class="normal">6334</span>
<span class="normal">6335</span>
<span class="normal">6336</span>
<span class="normal">6337</span>
<span class="normal">6338</span>
<span class="normal">6339</span>
<span class="normal">6340</span>
<span class="normal">6341</span>
<span class="normal">6342</span>
<span class="normal">6343</span>
<span class="normal">6344</span>
<span class="normal">6345</span>
<span class="normal">6346</span>
<span class="normal">6347</span>
<span class="normal">6348</span>
<span class="normal">6349</span>
<span class="normal">6350</span>
<span class="normal">6351</span>
<span class="normal">6352</span>
<span class="normal">6353</span>
<span class="normal">6354</span>
<span class="normal">6355</span>
<span class="normal">6356</span>
<span class="normal">6357</span>
<span class="normal">6358</span>
<span class="normal">6359</span>
<span class="normal">6360</span>
<span class="normal">6361</span>
<span class="normal">6362</span>
<span class="normal">6363</span>
<span class="normal">6364</span>
<span class="normal">6365</span>
<span class="normal">6366</span>
<span class="normal">6367</span>
<span class="normal">6368</span>
<span class="normal">6369</span>
<span class="normal">6370</span>
<span class="normal">6371</span>
<span class="normal">6372</span>
<span class="normal">6373</span>
<span class="normal">6374</span>
<span class="normal">6375</span>
<span class="normal">6376</span>
<span class="normal">6377</span>
<span class="normal">6378</span>
<span class="normal">6379</span>
<span class="normal">6380</span>
<span class="normal">6381</span>
<span class="normal">6382</span>
<span class="normal">6383</span>
<span class="normal">6384</span>
<span class="normal">6385</span>
<span class="normal">6386</span>
<span class="normal">6387</span>
<span class="normal">6388</span>
<span class="normal">6389</span>
<span class="normal">6390</span>
<span class="normal">6391</span>
<span class="normal">6392</span>
<span class="normal">6393</span>
<span class="normal">6394</span>
<span class="normal">6395</span>
<span class="normal">6396</span>
<span class="normal">6397</span>
<span class="normal">6398</span>
<span class="normal">6399</span>
<span class="normal">6400</span>
<span class="normal">6401</span>
<span class="normal">6402</span>
<span class="normal">6403</span>
<span class="normal">6404</span>
<span class="normal">6405</span>
<span class="normal">6406</span>
<span class="normal">6407</span>
<span class="normal">6408</span>
<span class="normal">6409</span>
<span class="normal">6410</span>
<span class="normal">6411</span>
<span class="normal">6412</span>
<span class="normal">6413</span>
<span class="normal">6414</span>
<span class="normal">6415</span>
<span class="normal">6416</span>
<span class="normal">6417</span>
<span class="normal">6418</span>
<span class="normal">6419</span>
<span class="normal">6420</span>
<span class="normal">6421</span>
<span class="normal">6422</span>
<span class="normal">6423</span>
<span class="normal">6424</span>
<span class="normal">6425</span>
<span class="normal">6426</span>
<span class="normal">6427</span>
<span class="normal">6428</span>
<span class="normal">6429</span>
<span class="normal">6430</span>
<span class="normal">6431</span>
<span class="normal">6432</span>
<span class="normal">6433</span>
<span class="normal">6434</span>
<span class="normal">6435</span>
<span class="normal">6436</span>
<span class="normal">6437</span>
<span class="normal">6438</span>
<span class="normal">6439</span>
<span class="normal">6440</span>
<span class="normal">6441</span>
<span class="normal">6442</span>
<span class="normal">6443</span>
<span class="normal">6444</span>
<span class="normal">6445</span>
<span class="normal">6446</span>
<span class="normal">6447</span>
<span class="normal">6448</span>
<span class="normal">6449</span>
<span class="normal">6450</span>
<span class="normal">6451</span>
<span class="normal">6452</span>
<span class="normal">6453</span>
<span class="normal">6454</span>
<span class="normal">6455</span>
<span class="normal">6456</span>
<span class="normal">6457</span>
<span class="normal">6458</span>
<span class="normal">6459</span>
<span class="normal">6460</span>
<span class="normal">6461</span>
<span class="normal">6462</span>
<span class="normal">6463</span>
<span class="normal">6464</span>
<span class="normal">6465</span>
<span class="normal">6466</span>
<span class="normal">6467</span>
<span class="normal">6468</span>
<span class="normal">6469</span>
<span class="normal">6470</span>
<span class="normal">6471</span>
<span class="normal">6472</span>
<span class="normal">6473</span>
<span class="normal">6474</span>
<span class="normal">6475</span>
<span class="normal">6476</span>
<span class="normal">6477</span>
<span class="normal">6478</span>
<span class="normal">6479</span>
<span class="normal">6480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">region_groups</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">intensity_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_csv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segment regions in an image and filter them based on size.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Union[str, xr.DataArray, np.ndarray]): Input image, can be a file</span>
<span class="sd">            path, xarray DataArray, or numpy array.</span>
<span class="sd">        connectivity (int, optional): Connectivity for labeling. Defaults to 1</span>
<span class="sd">            for 4-connectivity. Use 2 for 8-connectivity.</span>
<span class="sd">        min_size (int, optional): Minimum size of regions to keep. Defaults to 10.</span>
<span class="sd">        max_size (Optional[int], optional): Maximum size of regions to keep.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        threshold (Optional[int], optional): Threshold for filling holes.</span>
<span class="sd">            Defaults to None, which is equal to min_size.</span>
<span class="sd">        properties (Optional[List[str]], optional): List of properties to measure.</span>
<span class="sd">            See https://scikit-image.org/docs/stable/api/skimage.measure.html#skimage.measure.regionprops</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        intensity_image (Optional[Union[str, xr.DataArray, np.ndarray]], optional):</span>
<span class="sd">            Intensity image to measure properties. Defaults to None.</span>
<span class="sd">        out_csv (Optional[str], optional): Path to save the properties as a CSV file.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        out_vector (Optional[str], optional): Path to save the vector file.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        out_image (Optional[str], optional): Path to save the output image.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[Tuple[np.ndarray, pd.DataFrame], Tuple[xr.DataArray, pd.DataFrame]]: Labeled image and properties DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ndi</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">measure</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The input image must be a file path, xarray DataArray, or numpy array.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">min_size</span>

    <span class="c1"># Define a custom function to calculate median intensity</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity_median</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">intensity_image</span><span class="p">):</span>
        <span class="c1"># Extract the intensity values for the region</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>

    <span class="c1"># Add your custom function to the list of extra properties</span>
    <span class="k">if</span> <span class="n">intensity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_props</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity_median</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extra_props</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_bbox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_convex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_filled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;axis_major_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;axis_minor_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diameter_areagth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">intensity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">properties</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;intensity_max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_min&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_std&quot;</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">if</span> <span class="n">intensity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">)</span>
            <span class="n">intensity_da</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">intensity_image</span> <span class="o">=</span> <span class="n">intensity_da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="n">intensity_image</span> <span class="o">=</span> <span class="n">intensity_image</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The intensity_image must be a file path, xarray DataArray, or numpy array.&quot;</span>
            <span class="p">)</span>

    <span class="n">label_image</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span>
        <span class="n">label_image</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">intensity_image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>

    <span class="c1"># Get the labels of regions with area smaller than the threshold</span>
    <span class="n">small_regions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># Set the corresponding labels in the label_image to zero</span>
    <span class="k">for</span> <span class="n">region_label</span> <span class="ow">in</span> <span class="n">small_regions</span><span class="p">:</span>
        <span class="n">label_image</span><span class="p">[</span><span class="n">label_image</span> <span class="o">==</span> <span class="n">region_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">large_regions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">region_label</span> <span class="ow">in</span> <span class="n">large_regions</span><span class="p">:</span>
            <span class="n">label_image</span><span class="p">[</span><span class="n">label_image</span> <span class="o">==</span> <span class="n">region_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Find the background (holes) which are zeros</span>
    <span class="n">holes</span> <span class="o">=</span> <span class="n">label_image</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Label the holes (connected components in the background)</span>
    <span class="n">labeled_holes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">holes</span><span class="p">)</span>

    <span class="c1"># Measure properties of the labeled holes, including area and bounding box</span>
    <span class="n">hole_props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">labeled_holes</span><span class="p">)</span>

    <span class="c1"># Loop through each hole and fill it if it is smaller than the threshold</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">hole_props</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="c1"># Get the coordinates of the small hole</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">coords</span>

            <span class="c1"># Find the surrounding region&#39;s ID (non-zero value near the hole)</span>
            <span class="n">surrounding_region_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coord</span>
                <span class="c1"># Get a 3x3 neighborhood around the hole pixel</span>
                <span class="n">neighbors</span> <span class="o">=</span> <span class="n">label_image</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="c1"># Exclude the hole pixels (zeros) and get region values</span>
                <span class="n">region_values</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">neighbors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">region_values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">surrounding_region_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">region_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># Take the first non-zero value</span>

            <span class="k">if</span> <span class="n">surrounding_region_values</span><span class="p">:</span>
                <span class="c1"># Fill the hole with the mode (most frequent) of the surrounding region values</span>
                <span class="n">fill_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">surrounding_region_values</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">surrounding_region_values</span><span class="o">.</span><span class="n">count</span>
                <span class="p">)</span>
                <span class="n">label_image</span><span class="p">[</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fill_value</span>

    <span class="n">label_image</span><span class="p">,</span> <span class="n">num_labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span>
        <span class="n">label_image</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">,</span> <span class="n">return_num</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span>
        <span class="n">label_image</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">intensity_image</span><span class="o">=</span><span class="n">intensity_image</span><span class="p">,</span>
        <span class="n">extra_properties</span><span class="o">=</span><span class="n">extra_props</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;elongation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;axis_major_length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;axis_minor_length&quot;</span><span class="p">]</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span>
    <span class="k">if</span> <span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">num_labels</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;uint16&quot;</span>
    <span class="k">elif</span> <span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;uint32&quot;</span>

    <span class="k">if</span> <span class="n">out_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">label_image</span><span class="p">,</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">da</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">label_image</span>
        <span class="k">if</span> <span class="n">out_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">out_image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp_raster</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_vector</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp_raster</span> <span class="o">=</span> <span class="n">temp_file_path</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                    <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">tmp_raster</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">tmp_vector</span> <span class="o">=</span> <span class="n">temp_file_path</span><span class="p">(</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">)</span>
                    <span class="n">raster_to_vector</span><span class="p">(</span>
                        <span class="n">tmp_raster</span><span class="p">,</span>
                        <span class="n">tmp_vector</span><span class="p">,</span>
                        <span class="n">attribute_name</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                        <span class="n">unique_attribute_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_vector</span> <span class="o">=</span> <span class="n">temp_file_path</span><span class="p">(</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">)</span>
                    <span class="n">raster_to_vector</span><span class="p">(</span>
                        <span class="n">out_image</span><span class="p">,</span>
                        <span class="n">tmp_vector</span><span class="p">,</span>
                        <span class="n">attribute_name</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                        <span class="n">unique_attribute_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">tmp_vector</span><span class="p">)</span>
                <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">gdf2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="n">gdf2</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">out_vector</span><span class="p">)</span>
                <span class="n">gdf2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">gdf2</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tmp_raster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_raster</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_raster</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tmp_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_vector</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_vector</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to delete temporary files: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">da</span><span class="p">,</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.regularization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regularization</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">angle_tolerance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.geoai.regularization" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Regularizes building footprint polygons with multiple techniques beyond minimum
rotated rectangles.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>building_polygons</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons containing building footprints</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Degrees within which angles will be regularized to 90/180 degrees</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distance tolerance for Douglas-Peucker simplification</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orthogonalize</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enforce orthogonal angles in the final polygons</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_topology</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to preserve topology during simplification</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">regularization</span><span class="p">(</span>
    <span class="n">building_polygons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
    <span class="n">angle_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">orthogonalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">preserve_topology</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regularizes building footprint polygons with multiple techniques beyond minimum</span>
<span class="sd">    rotated rectangles.</span>

<span class="sd">    Args:</span>
<span class="sd">        building_polygons: GeoDataFrame or list of shapely Polygons containing building footprints</span>
<span class="sd">        angle_tolerance: Degrees within which angles will be regularized to 90/180 degrees</span>
<span class="sd">        simplify_tolerance: Distance tolerance for Douglas-Peucker simplification</span>
<span class="sd">        orthogonalize: Whether to enforce orthogonal angles in the final polygons</span>
<span class="sd">        preserve_topology: Whether to preserve topology during simplification</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame or list of shapely Polygons with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely</span><span class="w"> </span><span class="kn">import</span> <span class="n">wkt</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">translate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">shape</span>

    <span class="n">regularized_buildings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check if we&#39;re dealing with a GeoDataFrame</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span>

    <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">geom_objects</span><span class="p">:</span>
        <span class="c1"># Handle potential string representations of geometries</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to parse as WKT</span>
                <span class="n">building</span> <span class="o">=</span> <span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse geometry string: </span><span class="si">{</span><span class="n">building</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Ensure we have a valid geometry</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="s2">&quot;simplify&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid geometry type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">building</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Step 1: Simplify to remove noise and small vertices</span>
        <span class="n">simplified</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span>
            <span class="n">simplify_tolerance</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="n">preserve_topology</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">orthogonalize</span><span class="p">:</span>
            <span class="c1"># Make sure we have a valid polygon with an exterior</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">simplified</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">simplified</span><span class="o">.</span><span class="n">exterior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simplified geometry has no exterior: </span><span class="si">{</span><span class="n">simplified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">regularized_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>  <span class="c1"># Use original instead</span>
                <span class="k">continue</span>

            <span class="c1"># Step 2: Get the dominant angle to rotate building</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simplified</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

            <span class="c1"># Make sure we have enough coordinates for angle calculation</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough coordinates for angle calculation: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">regularized_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>  <span class="c1"># Use original instead</span>
                <span class="k">continue</span>

            <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="c1"># Find most common angle classes (0, 90, 180, 270 degrees)</span>
            <span class="n">binned_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">angles</span> <span class="o">/</span> <span class="mi">90</span><span class="p">)</span> <span class="o">*</span> <span class="mi">90</span>
            <span class="n">dominant_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">binned_angles</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span> <span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

            <span class="c1"># Step 3: Rotate to align with axes, regularize, then rotate back</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">simplified</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Step 4: Rectify coordinates to enforce right angles</span>
            <span class="n">ext_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotated</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">rect_coords</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Regularize each vertex to create orthogonal corners</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">rect_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># Check if we need to add a right-angle vertex</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                        <span class="n">ext_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">ext_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="mi">180</span>
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">%</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">angle_tolerance</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">%</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span>
                    <span class="mi">90</span> <span class="o">-</span> <span class="n">angle_tolerance</span>
                <span class="p">):</span>
                    <span class="c1"># Add intermediate point to create right angle</span>
                    <span class="n">rect_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">ext_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

            <span class="c1"># Close the polygon by adding the first point again</span>
            <span class="n">rect_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Create regularized polygon and rotate back</span>
            <span class="n">regularized</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">rect_coords</span><span class="p">)</span>
            <span class="n">final_building</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">regularized</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_building</span> <span class="o">=</span> <span class="n">simplified</span>

        <span class="n">regularized_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_building</span><span class="p">)</span>

    <span class="c1"># If input was a GeoDataFrame, return a GeoDataFrame</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">regularized_buildings</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">building_polygons</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">regularized_buildings</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.regularize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regularize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">parallel_threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">target_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">allow_45_degree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">diagonal_threshold_reduction</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">allow_circles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">circle_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">include_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.regularize" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Regularizes polygon geometries in a GeoDataFrame by aligning edges.</p>
<p>Aligns edges to be parallel or perpendicular (optionally also 45 degrees)
to their main direction. Handles reprojection, initial simplification,
regularization, geometry cleanup, and parallel processing.</p>
<p>This function is a wrapper around the <code>regularize_geodataframe</code> function
from the <code>buildingregulariser</code> package. Credits to the original author
Nick Wright. Check out the repo at https://github.com/DPIRD-DMA/Building-Regulariser.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input GeoDataFrame with polygon or multipolygon geometries,
or a file path to the GeoDataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parallel_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distance threshold for merging nearly parallel adjacent edges
during regularization. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_crs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pyproj.CRS">CRS</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target Coordinate Reference System for
processing. If None, uses the input GeoDataFrame's CRS. Processing is more reliable in a
projected CRS. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, applies initial simplification to the geometry before
regularization. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for the initial simplification step (if <code>simplify</code>
is True). Also used for geometry cleanup steps. Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_45_degree</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, allows edges to be oriented at 45-degree angles relative
to the main direction during regularization. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>diagonal_threshold_reduction</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reduction factor in degrees to reduce the likelihood
of diagonal edges being created. Larger values reduce the likelihood of diagonal edges.
Defaults to 15.</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_circles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, attempts to detect polygons that are nearly circular and
replaces them with perfect circles. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>circle_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intersection over Union (IoU) threshold used for circle detection
(if <code>allow_circles</code> is True). Value between 0 and 1. Defaults to 0.9.</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_cores</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of CPU cores to use for parallel processing. If 1, processing is
done sequentially. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_metadata</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, includes metadata about the regularization process in the
output GeoDataFrame. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoDataFrame. If None, the output is
not saved. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the <code>to_file</code> method when saving the output.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>gpd.GeoDataFrame: A new GeoDataFrame with regularized polygon geometries. Original attributes are</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>preserved. Geometries that failed processing might be dropped.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input data is not a GeoDataFrame or a file path, or if the input GeoDataFrame is empty.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8317</span>
<span class="normal">8318</span>
<span class="normal">8319</span>
<span class="normal">8320</span>
<span class="normal">8321</span>
<span class="normal">8322</span>
<span class="normal">8323</span>
<span class="normal">8324</span>
<span class="normal">8325</span>
<span class="normal">8326</span>
<span class="normal">8327</span>
<span class="normal">8328</span>
<span class="normal">8329</span>
<span class="normal">8330</span>
<span class="normal">8331</span>
<span class="normal">8332</span>
<span class="normal">8333</span>
<span class="normal">8334</span>
<span class="normal">8335</span>
<span class="normal">8336</span>
<span class="normal">8337</span>
<span class="normal">8338</span>
<span class="normal">8339</span>
<span class="normal">8340</span>
<span class="normal">8341</span>
<span class="normal">8342</span>
<span class="normal">8343</span>
<span class="normal">8344</span>
<span class="normal">8345</span>
<span class="normal">8346</span>
<span class="normal">8347</span>
<span class="normal">8348</span>
<span class="normal">8349</span>
<span class="normal">8350</span>
<span class="normal">8351</span>
<span class="normal">8352</span>
<span class="normal">8353</span>
<span class="normal">8354</span>
<span class="normal">8355</span>
<span class="normal">8356</span>
<span class="normal">8357</span>
<span class="normal">8358</span>
<span class="normal">8359</span>
<span class="normal">8360</span>
<span class="normal">8361</span>
<span class="normal">8362</span>
<span class="normal">8363</span>
<span class="normal">8364</span>
<span class="normal">8365</span>
<span class="normal">8366</span>
<span class="normal">8367</span>
<span class="normal">8368</span>
<span class="normal">8369</span>
<span class="normal">8370</span>
<span class="normal">8371</span>
<span class="normal">8372</span>
<span class="normal">8373</span>
<span class="normal">8374</span>
<span class="normal">8375</span>
<span class="normal">8376</span>
<span class="normal">8377</span>
<span class="normal">8378</span>
<span class="normal">8379</span>
<span class="normal">8380</span>
<span class="normal">8381</span>
<span class="normal">8382</span>
<span class="normal">8383</span>
<span class="normal">8384</span>
<span class="normal">8385</span>
<span class="normal">8386</span>
<span class="normal">8387</span>
<span class="normal">8388</span>
<span class="normal">8389</span>
<span class="normal">8390</span>
<span class="normal">8391</span>
<span class="normal">8392</span>
<span class="normal">8393</span>
<span class="normal">8394</span>
<span class="normal">8395</span>
<span class="normal">8396</span>
<span class="normal">8397</span>
<span class="normal">8398</span>
<span class="normal">8399</span>
<span class="normal">8400</span>
<span class="normal">8401</span>
<span class="normal">8402</span>
<span class="normal">8403</span>
<span class="normal">8404</span>
<span class="normal">8405</span>
<span class="normal">8406</span>
<span class="normal">8407</span>
<span class="normal">8408</span>
<span class="normal">8409</span>
<span class="normal">8410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">regularize</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">parallel_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">target_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;pyproj.CRS&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">allow_45_degree</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">diagonal_threshold_reduction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">allow_circles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">circle_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">include_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularizes polygon geometries in a GeoDataFrame by aligning edges.</span>

<span class="sd">    Aligns edges to be parallel or perpendicular (optionally also 45 degrees)</span>
<span class="sd">    to their main direction. Handles reprojection, initial simplification,</span>
<span class="sd">    regularization, geometry cleanup, and parallel processing.</span>

<span class="sd">    This function is a wrapper around the `regularize_geodataframe` function</span>
<span class="sd">    from the `buildingregulariser` package. Credits to the original author</span>
<span class="sd">    Nick Wright. Check out the repo at https://github.com/DPIRD-DMA/Building-Regulariser.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (Union[gpd.GeoDataFrame, str]): Input GeoDataFrame with polygon or multipolygon geometries,</span>
<span class="sd">            or a file path to the GeoDataFrame.</span>
<span class="sd">        parallel_threshold (float, optional): Distance threshold for merging nearly parallel adjacent edges</span>
<span class="sd">            during regularization. Defaults to 1.0.</span>
<span class="sd">        target_crs (Optional[Union[str, &quot;pyproj.CRS&quot;]], optional): Target Coordinate Reference System for</span>
<span class="sd">            processing. If None, uses the input GeoDataFrame&#39;s CRS. Processing is more reliable in a</span>
<span class="sd">            projected CRS. Defaults to None.</span>
<span class="sd">        simplify (bool, optional): If True, applies initial simplification to the geometry before</span>
<span class="sd">            regularization. Defaults to True.</span>
<span class="sd">        simplify_tolerance (float, optional): Tolerance for the initial simplification step (if `simplify`</span>
<span class="sd">            is True). Also used for geometry cleanup steps. Defaults to 0.5.</span>
<span class="sd">        allow_45_degree (bool, optional): If True, allows edges to be oriented at 45-degree angles relative</span>
<span class="sd">            to the main direction during regularization. Defaults to True.</span>
<span class="sd">        diagonal_threshold_reduction (float, optional): Reduction factor in degrees to reduce the likelihood</span>
<span class="sd">            of diagonal edges being created. Larger values reduce the likelihood of diagonal edges.</span>
<span class="sd">            Defaults to 15.</span>
<span class="sd">        allow_circles (bool, optional): If True, attempts to detect polygons that are nearly circular and</span>
<span class="sd">            replaces them with perfect circles. Defaults to True.</span>
<span class="sd">        circle_threshold (float, optional): Intersection over Union (IoU) threshold used for circle detection</span>
<span class="sd">            (if `allow_circles` is True). Value between 0 and 1. Defaults to 0.9.</span>
<span class="sd">        num_cores (int, optional): Number of CPU cores to use for parallel processing. If 1, processing is</span>
<span class="sd">            done sequentially. Defaults to 1.</span>
<span class="sd">        include_metadata (bool, optional): If True, includes metadata about the regularization process in the</span>
<span class="sd">            output GeoDataFrame. Defaults to False.</span>
<span class="sd">        output_path (Optional[str], optional): Path to save the output GeoDataFrame. If None, the output is</span>
<span class="sd">            not saved. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the `to_file` method when saving the output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        gpd.GeoDataFrame: A new GeoDataFrame with regularized polygon geometries. Original attributes are</span>
<span class="sd">        preserved. Geometries that failed processing might be dropped.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input data is not a GeoDataFrame or a file path, or if the input GeoDataFrame is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">buildingregulariser</span><span class="w"> </span><span class="kn">import</span> <span class="n">regularize_geodataframe</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">install_package</span><span class="p">(</span><span class="s2">&quot;buildingregulariser&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">buildingregulariser</span><span class="w"> </span><span class="kn">import</span> <span class="n">regularize_geodataframe</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data must be a GeoDataFrame or a file path.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the input data is empty</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input GeoDataFrame is empty.&quot;</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">regularize_geodataframe</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">parallel_threshold</span><span class="o">=</span><span class="n">parallel_threshold</span><span class="p">,</span>
        <span class="n">target_crs</span><span class="o">=</span><span class="n">target_crs</span><span class="p">,</span>
        <span class="n">simplify</span><span class="o">=</span><span class="n">simplify</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
        <span class="n">allow_45_degree</span><span class="o">=</span><span class="n">allow_45_degree</span><span class="p">,</span>
        <span class="n">diagonal_threshold_reduction</span><span class="o">=</span><span class="n">diagonal_threshold_reduction</span><span class="p">,</span>
        <span class="n">allow_circles</span><span class="o">=</span><span class="n">allow_circles</span><span class="p">,</span>
        <span class="n">circle_threshold</span><span class="o">=</span><span class="n">circle_threshold</span><span class="p">,</span>
        <span class="n">num_cores</span><span class="o">=</span><span class="n">num_cores</span><span class="p">,</span>
        <span class="n">include_metadata</span><span class="o">=</span><span class="n">include_metadata</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.rowcol_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rowcol_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.rowcol_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a list of (row, col) coordinates to (x, y) coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rows</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of row coordinates. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cols</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of col coordinates. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boxes</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of (row, col) coordinates in the format of [[left, top, right, bottom], [left, top, right, bottom], ...]</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zs (list or float, optional): Height associated with coordinates. Primarily used for RPC based coordinate transformations.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offset</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Determines if the returned coordinates are for the center of the pixel or for a corner.</p>
              </div>
            </td>
            <td>
                  <code>&#39;center&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output vector file path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dst_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The destination CRS. Defaults to "EPSG:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;EPSG:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rasterio.transform.xy.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="float">float</span>], <span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of (x, y) coordinates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8582</span>
<span class="normal">8583</span>
<span class="normal">8584</span>
<span class="normal">8585</span>
<span class="normal">8586</span>
<span class="normal">8587</span>
<span class="normal">8588</span>
<span class="normal">8589</span>
<span class="normal">8590</span>
<span class="normal">8591</span>
<span class="normal">8592</span>
<span class="normal">8593</span>
<span class="normal">8594</span>
<span class="normal">8595</span>
<span class="normal">8596</span>
<span class="normal">8597</span>
<span class="normal">8598</span>
<span class="normal">8599</span>
<span class="normal">8600</span>
<span class="normal">8601</span>
<span class="normal">8602</span>
<span class="normal">8603</span>
<span class="normal">8604</span>
<span class="normal">8605</span>
<span class="normal">8606</span>
<span class="normal">8607</span>
<span class="normal">8608</span>
<span class="normal">8609</span>
<span class="normal">8610</span>
<span class="normal">8611</span>
<span class="normal">8612</span>
<span class="normal">8613</span>
<span class="normal">8614</span>
<span class="normal">8615</span>
<span class="normal">8616</span>
<span class="normal">8617</span>
<span class="normal">8618</span>
<span class="normal">8619</span>
<span class="normal">8620</span>
<span class="normal">8621</span>
<span class="normal">8622</span>
<span class="normal">8623</span>
<span class="normal">8624</span>
<span class="normal">8625</span>
<span class="normal">8626</span>
<span class="normal">8627</span>
<span class="normal">8628</span>
<span class="normal">8629</span>
<span class="normal">8630</span>
<span class="normal">8631</span>
<span class="normal">8632</span>
<span class="normal">8633</span>
<span class="normal">8634</span>
<span class="normal">8635</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rowcol_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">boxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dst_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a list of (row, col) coordinates to (x, y) coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp (str): The source raster file path.</span>
<span class="sd">        rows (list, optional): A list of row coordinates. Defaults to None.</span>
<span class="sd">        cols (list, optional): A list of col coordinates. Defaults to None.</span>
<span class="sd">        boxes (list, optional): A list of (row, col) coordinates in the format of [[left, top, right, bottom], [left, top, right, bottom], ...]</span>
<span class="sd">        zs: zs (list or float, optional): Height associated with coordinates. Primarily used for RPC based coordinate transformations.</span>
<span class="sd">        offset (str, optional): Determines if the returned coordinates are for the center of the pixel or for a corner.</span>
<span class="sd">        output (str, optional): The output vector file path. Defaults to None.</span>
<span class="sd">        dst_crs (str, optional): The destination CRS. Defaults to &quot;EPSG:4326&quot;.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rasterio.transform.xy.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of (x, y) coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rows and cols must be provided.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">src_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

    <span class="k">if</span> <span class="n">boxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">boxes_to_vector</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.stack_bands" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stack_bands</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp_vrt</span><span class="o">=</span><span class="s1">&#39;stack.vrt&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s1">&#39;DEFLATE&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;COG&#39;</span><span class="p">,</span> <span class="n">extra_gdal_translate_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.stack_bands" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Stack bands from multiple images into a single multi-band GeoTIFF.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_files</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of input image paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output stacked image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output resolution. If None, inferred from first image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data type (e.g., "UInt16", "Float32").</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temp_vrt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Temporary VRT filename.</p>
              </div>
            </td>
            <td>
                  <code>&#39;stack.vrt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overwrite</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to overwrite the output file.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compress</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression method.</p>
              </div>
            </td>
            <td>
                  <code>&#39;DEFLATE&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GDAL output format (default is "COG").</p>
              </div>
            </td>
            <td>
                  <code>&#39;COG&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extra_gdal_translate_args</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extra arguments for gdal_translate.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">9102</span>
<span class="normal">9103</span>
<span class="normal">9104</span>
<span class="normal">9105</span>
<span class="normal">9106</span>
<span class="normal">9107</span>
<span class="normal">9108</span>
<span class="normal">9109</span>
<span class="normal">9110</span>
<span class="normal">9111</span>
<span class="normal">9112</span>
<span class="normal">9113</span>
<span class="normal">9114</span>
<span class="normal">9115</span>
<span class="normal">9116</span>
<span class="normal">9117</span>
<span class="normal">9118</span>
<span class="normal">9119</span>
<span class="normal">9120</span>
<span class="normal">9121</span>
<span class="normal">9122</span>
<span class="normal">9123</span>
<span class="normal">9124</span>
<span class="normal">9125</span>
<span class="normal">9126</span>
<span class="normal">9127</span>
<span class="normal">9128</span>
<span class="normal">9129</span>
<span class="normal">9130</span>
<span class="normal">9131</span>
<span class="normal">9132</span>
<span class="normal">9133</span>
<span class="normal">9134</span>
<span class="normal">9135</span>
<span class="normal">9136</span>
<span class="normal">9137</span>
<span class="normal">9138</span>
<span class="normal">9139</span>
<span class="normal">9140</span>
<span class="normal">9141</span>
<span class="normal">9142</span>
<span class="normal">9143</span>
<span class="normal">9144</span>
<span class="normal">9145</span>
<span class="normal">9146</span>
<span class="normal">9147</span>
<span class="normal">9148</span>
<span class="normal">9149</span>
<span class="normal">9150</span>
<span class="normal">9151</span>
<span class="normal">9152</span>
<span class="normal">9153</span>
<span class="normal">9154</span>
<span class="normal">9155</span>
<span class="normal">9156</span>
<span class="normal">9157</span>
<span class="normal">9158</span>
<span class="normal">9159</span>
<span class="normal">9160</span>
<span class="normal">9161</span>
<span class="normal">9162</span>
<span class="normal">9163</span>
<span class="normal">9164</span>
<span class="normal">9165</span>
<span class="normal">9166</span>
<span class="normal">9167</span>
<span class="normal">9168</span>
<span class="normal">9169</span>
<span class="normal">9170</span>
<span class="normal">9171</span>
<span class="normal">9172</span>
<span class="normal">9173</span>
<span class="normal">9174</span>
<span class="normal">9175</span>
<span class="normal">9176</span>
<span class="normal">9177</span>
<span class="normal">9178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stack_bands</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># e.g., &quot;UInt16&quot;, &quot;Float32&quot;</span>
    <span class="n">temp_vrt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;stack.vrt&quot;</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;COG&quot;</span><span class="p">,</span>
    <span class="n">extra_gdal_translate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stack bands from multiple images into a single multi-band GeoTIFF.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_files (List[str]): List of input image paths.</span>
<span class="sd">        output_file (str): Path to the output stacked image.</span>
<span class="sd">        resolution (float, optional): Output resolution. If None, inferred from first image.</span>
<span class="sd">        dtype (str, optional): Output data type (e.g., &quot;UInt16&quot;, &quot;Float32&quot;).</span>
<span class="sd">        temp_vrt (str): Temporary VRT filename.</span>
<span class="sd">        overwrite (bool): Whether to overwrite the output file.</span>
<span class="sd">        compress (str): Compression method.</span>
<span class="sd">        output_format (str): GDAL output format (default is &quot;COG&quot;).</span>
<span class="sd">        extra_gdal_translate_args (List[str], optional): Extra arguments for gdal_translate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">leafmap</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No input files provided.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">input_files</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output file already exists: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_file</span>

    <span class="c1"># Infer resolution if not provided</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resolution_x</span><span class="p">,</span> <span class="n">resolution_y</span> <span class="o">=</span> <span class="n">get_raster_resolution</span><span class="p">(</span><span class="n">input_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resolution_x</span> <span class="o">=</span> <span class="n">resolution_y</span> <span class="o">=</span> <span class="n">resolution</span>

    <span class="c1"># Step 1: Build VRT</span>
    <span class="n">vrt_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdalbuildvrt&quot;</span><span class="p">,</span> <span class="s2">&quot;-separate&quot;</span><span class="p">,</span> <span class="n">temp_vrt</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_files</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">vrt_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Step 2: Translate VRT to output GeoTIFF</span>
    <span class="n">translate_cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;gdal_translate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-tr&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">resolution_x</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">resolution_y</span><span class="p">),</span>
        <span class="n">temp_vrt</span><span class="p">,</span>
        <span class="n">output_file</span><span class="p">,</span>
        <span class="s2">&quot;-of&quot;</span><span class="p">,</span>
        <span class="n">output_format</span><span class="p">,</span>
        <span class="s2">&quot;-co&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;COMPRESS=</span><span class="si">{</span><span class="n">compress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">dtype</span><span class="p">:</span>
        <span class="n">translate_cmd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;-ot&quot;</span><span class="p">)</span>
        <span class="n">translate_cmd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extra_gdal_translate_args</span><span class="p">:</span>
        <span class="n">translate_cmd</span> <span class="o">+=</span> <span class="n">extra_gdal_translate_args</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">translate_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Step 3: Clean up VRT</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_vrt</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_vrt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.temp_file_path" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">temp_file_path</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span></code>

<a href="#geoai.geoai.temp_file_path" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Returns a temporary file path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ext</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file extension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temporary file path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6226</span>
<span class="normal">6227</span>
<span class="normal">6228</span>
<span class="normal">6229</span>
<span class="normal">6230</span>
<span class="normal">6231</span>
<span class="normal">6232</span>
<span class="normal">6233</span>
<span class="normal">6234</span>
<span class="normal">6235</span>
<span class="normal">6236</span>
<span class="normal">6237</span>
<span class="normal">6238</span>
<span class="normal">6239</span>
<span class="normal">6240</span>
<span class="normal">6241</span>
<span class="normal">6242</span>
<span class="normal">6243</span>
<span class="normal">6244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">temp_file_path</span><span class="p">(</span><span class="n">ext</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a temporary file path.</span>

<span class="sd">    Args:</span>
<span class="sd">        ext (str): The file extension.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The temporary file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_id</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">file_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.try_common_architectures" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">try_common_architectures</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span></code>

<a href="#geoai.geoai.try_common_architectures" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Try to load the state_dict into common architectures to see which one fits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model's state dictionary</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8078</span>
<span class="normal">8079</span>
<span class="normal">8080</span>
<span class="normal">8081</span>
<span class="normal">8082</span>
<span class="normal">8083</span>
<span class="normal">8084</span>
<span class="normal">8085</span>
<span class="normal">8086</span>
<span class="normal">8087</span>
<span class="normal">8088</span>
<span class="normal">8089</span>
<span class="normal">8090</span>
<span class="normal">8091</span>
<span class="normal">8092</span>
<span class="normal">8093</span>
<span class="normal">8094</span>
<span class="normal">8095</span>
<span class="normal">8096</span>
<span class="normal">8097</span>
<span class="normal">8098</span>
<span class="normal">8099</span>
<span class="normal">8100</span>
<span class="normal">8101</span>
<span class="normal">8102</span>
<span class="normal">8103</span>
<span class="normal">8104</span>
<span class="normal">8105</span>
<span class="normal">8106</span>
<span class="normal">8107</span>
<span class="normal">8108</span>
<span class="normal">8109</span>
<span class="normal">8110</span>
<span class="normal">8111</span>
<span class="normal">8112</span>
<span class="normal">8113</span>
<span class="normal">8114</span>
<span class="normal">8115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">try_common_architectures</span><span class="p">(</span><span class="n">state_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to load the state_dict into common architectures to see which one fits.</span>

<span class="sd">    Args:</span>
<span class="sd">        state_dict: The model&#39;s state dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torchinfo</span>

    <span class="c1"># Test models and their initializations</span>
    <span class="n">models_to_try</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;FCN-ResNet50&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">fcn_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
        <span class="s2">&quot;DeepLabV3-ResNet50&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">deeplabv3_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trying to load state_dict into common architectures:&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model_fn</span> <span class="ow">in</span> <span class="n">models_to_try</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">()</span>
            <span class="c1"># Sometimes state_dict keys have &#39;model.&#39; prefix</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;model.&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">cleaned_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">6</span><span class="p">:]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">cleaned_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Successfully loaded (may have missing or unexpected keys)&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Generate model summary</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> architecture:&quot;</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">torchinfo</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Failed to load - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.vector_to_geojson" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vector_to_geojson</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.vector_to_geojson" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a vector file to a geojson file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output geojson file path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The geojson dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8413</span>
<span class="normal">8414</span>
<span class="normal">8415</span>
<span class="normal">8416</span>
<span class="normal">8417</span>
<span class="normal">8418</span>
<span class="normal">8419</span>
<span class="normal">8420</span>
<span class="normal">8421</span>
<span class="normal">8422</span>
<span class="normal">8423</span>
<span class="normal">8424</span>
<span class="normal">8425</span>
<span class="normal">8426</span>
<span class="normal">8427</span>
<span class="normal">8428</span>
<span class="normal">8429</span>
<span class="normal">8430</span>
<span class="normal">8431</span>
<span class="normal">8432</span>
<span class="normal">8433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">vector_to_geojson</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a vector file to a geojson file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): The vector file path.</span>
<span class="sd">        output (str, optional): The output geojson file path. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The geojson dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdf</span><span class="o">.</span><span class="n">__geo_interface__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.vector_to_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vector_to_raster</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_raster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.geoai.vector_to_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert vector data to a raster.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input vector file or a GeoDataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output raster file. If None, returns the array without saving.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a reference raster for dimensions, transform and CRS.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in the vector data to use for pixel values.
If None, all vector features will be burned with value 1.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shape of the output raster as (height, width).
Required if reference_raster is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform</code>
            </td>
            <td>
                  <code><span title="affine.Affine">Affine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Affine transformation matrix.
Required if reference_raster is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pixel_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size (resolution) as single value or (x_res, y_res).
Used to calculate transform if transform is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounds of the output raster as (left, bottom, right, top).
Used to calculate transform if transform is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crs</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="CRS">CRS</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system of the output raster.
Required if reference_raster is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, all pixels touched by geometries will be burned in.
If False, only pixels whose center is within the geometry will be burned in.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fill_value</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to fill the raster with before burning in features.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="numpy.dtype">dtype</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type of the output raster.</p>
              </div>
            </td>
            <td>
                  <code><span title="numpy.uint8">uint8</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nodata</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>No data value for the output raster.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_result</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to plot the resulting raster.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: The rasterized data array if output_path is None, else None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">vector_to_raster</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_raster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pixel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="n">nodata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert vector data to a raster.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str or GeoDataFrame): Path to the input vector file or a GeoDataFrame.</span>
<span class="sd">        output_path (str): Path to save the output raster file. If None, returns the array without saving.</span>
<span class="sd">        reference_raster (str): Path to a reference raster for dimensions, transform and CRS.</span>
<span class="sd">        attribute_field (str): Field name in the vector data to use for pixel values.</span>
<span class="sd">            If None, all vector features will be burned with value 1.</span>
<span class="sd">        output_shape (tuple): Shape of the output raster as (height, width).</span>
<span class="sd">            Required if reference_raster is not provided.</span>
<span class="sd">        transform (affine.Affine): Affine transformation matrix.</span>
<span class="sd">            Required if reference_raster is not provided.</span>
<span class="sd">        pixel_size (float or tuple): Pixel size (resolution) as single value or (x_res, y_res).</span>
<span class="sd">            Used to calculate transform if transform is not provided.</span>
<span class="sd">        bounds (tuple): Bounds of the output raster as (left, bottom, right, top).</span>
<span class="sd">            Used to calculate transform if transform is not provided.</span>
<span class="sd">        crs (str or CRS): Coordinate reference system of the output raster.</span>
<span class="sd">            Required if reference_raster is not provided.</span>
<span class="sd">        all_touched (bool): If True, all pixels touched by geometries will be burned in.</span>
<span class="sd">            If False, only pixels whose center is within the geometry will be burned in.</span>
<span class="sd">        fill_value (int): Value to fill the raster with before burning in features.</span>
<span class="sd">        dtype (numpy.dtype): Data type of the output raster.</span>
<span class="sd">        nodata (int): No data value for the output raster.</span>
<span class="sd">        plot_result (bool): Whether to plot the resulting raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The rasterized data array if output_path is None, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load vector data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">vector_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

    <span class="c1"># Check if vector data is empty</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The input vector data is empty. Creating an empty raster.&quot;</span><span class="p">)</span>

    <span class="c1"># Get CRS from vector data if not provided</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reference_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Get transform and output shape from reference raster if provided</span>
    <span class="k">if</span> <span class="n">reference_raster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reference_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
            <span class="k">if</span> <span class="n">nodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nodata</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if we have all required parameters</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pixel_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either reference_raster, transform, or both pixel_size and bounds must be provided.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Calculate transform from pixel size and bounds</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">x_res</span> <span class="o">=</span> <span class="n">y_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span> <span class="o">=</span> <span class="n">pixel_size</span>
                <span class="n">y_res</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_res</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Convert to negative for north-up raster</span>

            <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
                <span class="n">left</span><span class="p">,</span>
                <span class="n">bottom</span><span class="p">,</span>
                <span class="n">right</span><span class="p">,</span>
                <span class="n">top</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">((</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_res</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">((</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_res</span><span class="p">)),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Calculate output shape from bounds and pixel size</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pixel_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;output_shape must be provided if reference_raster is not provided and &quot;</span>
                    <span class="s2">&quot;cannot be calculated from bounds and pixel_size.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">x_res</span> <span class="o">=</span> <span class="n">y_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span> <span class="o">=</span> <span class="n">pixel_size</span>

            <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_res</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_res</span><span class="p">))</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="c1"># Ensure CRS is set</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;CRS must be provided either directly, from reference_raster, or from input vector data.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Reproject vector data if its CRS doesn&#39;t match the output CRS</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">crs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting vector data from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Create empty raster filled with fill_value</span>
    <span class="n">raster_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Burn vector features into raster</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># Prepare shapes for burning</span>
        <span class="k">if</span> <span class="n">attribute_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attribute_field</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Use attribute field for values</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">attribute_field</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Burn with value 1</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">geom</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

        <span class="c1"># Burn shapes into raster</span>
        <span class="n">burned</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
            <span class="n">shapes</span><span class="o">=</span><span class="n">shapes</span><span class="p">,</span>
            <span class="n">out_shape</span><span class="o">=</span><span class="n">output_shape</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update raster data</span>
        <span class="n">raster_data</span> <span class="o">=</span> <span class="n">burned</span>

    <span class="c1"># Save raster if output path is provided</span>
    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create directory if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Define metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">raster_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">crs</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add nodata value if provided</span>
        <span class="k">if</span> <span class="n">nodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata</span>

        <span class="c1"># Write raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raster_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rasterized data saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot result if requested</span>
    <span class="k">if</span> <span class="n">plot_result</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Plot raster</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">attribute_field</span> <span class="k">if</span> <span class="n">attribute_field</span> <span class="k">else</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span>

        <span class="c1"># Plot vector boundaries for reference</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get the extent of the raster</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">raster_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate extent from transform and shape</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">output_shape</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">raster_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>

        <span class="c1"># Clip vector to raster extent for clarity in plot</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">gdf_clipped</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">raster_bbox</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf_clipped</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">gdf_clipped</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Rasterized Vector Data&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">raster_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.view_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bdx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">axis_off</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.view_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize an image using matplotlib.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The image to visualize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transpose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to transpose the image. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bdx</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The band index to visualize. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of the figure. Defaults to (10, 5).</p>
              </div>
            </td>
            <td>
                  <code>(10, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis_off</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to turn off the axis. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The title of the plot. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for plt.imshow().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_image</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bdx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clip_percentiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">axis_off</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize an image using matplotlib.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Union[np.ndarray, torch.Tensor]): The image to visualize.</span>
<span class="sd">        transpose (bool, optional): Whether to transpose the image. Defaults to False.</span>
<span class="sd">        bdx (Optional[int], optional): The band index to visualize. Defaults to None.</span>
<span class="sd">        figsize (Tuple[int, int], optional): The size of the figure. Defaults to (10, 5).</span>
<span class="sd">        axis_off (bool, optional): Whether to turn off the axis. Defaults to True.</span>
<span class="sd">        title (Optional[str], optional): The title of the plot. Defaults to None.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments for plt.imshow().</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bdx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bdx</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">clip_percentiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_low</span><span class="p">,</span> <span class="n">p_high</span> <span class="o">=</span> <span class="n">clip_percentiles</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">p_low</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">p_high</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">image</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis_off</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.view_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_raster</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s1">&#39;Raster&#39;</span><span class="p">,</span> <span class="n">layer_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom_to_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">array_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cors_all&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">basemap</span><span class="o">=</span><span class="s1">&#39;OpenStreetMap&#39;</span><span class="p">,</span> <span class="n">basemap_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;ipyleaflet&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.view_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize a raster using leafmap.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source of the raster.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The band indexes to visualize. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>colormap</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to apply. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vmin</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum value for colormap scaling. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vmax</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum value for colormap scaling. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nodata</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The nodata value. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The attribution for the raster. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the layer. Defaults to "Raster".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Raster&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_index</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the layer. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zoom_to_layer</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to zoom to the layer. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visible</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the layer is visible. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>opacity</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The opacity of the layer. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>array_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for array processing. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>client_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the client. Defaults to {"cors_all": False}.</p>
              </div>
            </td>
            <td>
                  <code>{&#39;cors_all&#39;: False}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The basemap to use. Defaults to "OpenStreetMap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;OpenStreetMap&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the basemap. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>backend</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The backend to use. Defaults to "ipyleaflet".</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipyleaflet&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>leafmap.Map: The map object with the raster layer added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_raster</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nodata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">layer_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Raster&quot;</span><span class="p">,</span>
    <span class="n">layer_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_to_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">visible</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">opacity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">array_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">client_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cors_all&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="n">basemap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OpenStreetMap&quot;</span><span class="p">,</span>
    <span class="n">basemap_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ipyleaflet&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize a raster using leafmap.</span>

<span class="sd">    Args:</span>
<span class="sd">        source (str): The source of the raster.</span>
<span class="sd">        indexes (Optional[int], optional): The band indexes to visualize. Defaults to None.</span>
<span class="sd">        colormap (Optional[str], optional): The colormap to apply. Defaults to None.</span>
<span class="sd">        vmin (Optional[float], optional): The minimum value for colormap scaling. Defaults to None.</span>
<span class="sd">        vmax (Optional[float], optional): The maximum value for colormap scaling. Defaults to None.</span>
<span class="sd">        nodata (Optional[float], optional): The nodata value. Defaults to None.</span>
<span class="sd">        attribution (Optional[str], optional): The attribution for the raster. Defaults to None.</span>
<span class="sd">        layer_name (Optional[str], optional): The name of the layer. Defaults to &quot;Raster&quot;.</span>
<span class="sd">        layer_index (Optional[int], optional): The index of the layer. Defaults to None.</span>
<span class="sd">        zoom_to_layer (Optional[bool], optional): Whether to zoom to the layer. Defaults to True.</span>
<span class="sd">        visible (Optional[bool], optional): Whether the layer is visible. Defaults to True.</span>
<span class="sd">        opacity (Optional[float], optional): The opacity of the layer. Defaults to 1.0.</span>
<span class="sd">        array_args (Optional[Dict], optional): Additional arguments for array processing. Defaults to {}.</span>
<span class="sd">        client_args (Optional[Dict], optional): Additional arguments for the client. Defaults to {&quot;cors_all&quot;: False}.</span>
<span class="sd">        basemap (Optional[str], optional): The basemap to use. Defaults to &quot;OpenStreetMap&quot;.</span>
<span class="sd">        basemap_args (Optional[Dict], optional): Additional arguments for the basemap. Defaults to None.</span>
<span class="sd">        backend (Optional[str], optional): The backend to use. Defaults to &quot;ipyleaflet&quot;.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        leafmap.Map: The map object with the raster layer added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;folium&quot;</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">leafmap.foliumap</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">leafmap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">leafmap.leafmap</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">leafmap</span>

    <span class="k">if</span> <span class="n">basemap_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basemap_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">array_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basemap_args</span><span class="p">:</span>
                    <span class="n">basemap_args</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basemap&quot;</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_cog_layer</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;layer_name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basemap_args</span><span class="p">:</span>
                    <span class="n">basemap_args</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basemap&quot;</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">dict_to_image</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;bidx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexes</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;colormap_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colormap</span>
        <span class="k">if</span> <span class="n">attribution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attribution</span> <span class="o">=</span> <span class="s2">&quot;TiTiler&quot;</span>

        <span class="n">m</span><span class="o">.</span><span class="n">add_cog_layer</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
            <span class="n">attribution</span><span class="o">=</span><span class="n">attribution</span><span class="p">,</span>
            <span class="n">zoom_to_layer</span><span class="o">=</span><span class="n">zoom_to_layer</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span>
            <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
            <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
            <span class="n">attribution</span><span class="o">=</span><span class="n">attribution</span><span class="p">,</span>
            <span class="n">layer_name</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span>
            <span class="n">layer_index</span><span class="o">=</span><span class="n">layer_index</span><span class="p">,</span>
            <span class="n">zoom_to_layer</span><span class="o">=</span><span class="n">zoom_to_layer</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="n">visible</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
            <span class="n">array_args</span><span class="o">=</span><span class="n">array_args</span><span class="p">,</span>
            <span class="n">client_args</span><span class="o">=</span><span class="n">client_args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.view_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_vector</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">basemap_type</span><span class="o">=</span><span class="s1">&#39;streets&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">classification</span><span class="o">=</span><span class="s1">&#39;quantiles&#39;</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">highlight_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">highlight_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></code>

<a href="#geoai.geoai.view_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize vector datasets with options for styling, classification, basemaps and more.</p>
<p>This function visualizes GeoDataFrame objects with customizable symbology.
It supports different vector types (points, lines, polygons), attribute-based
classification, and background basemaps.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_data</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector dataset to visualize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column to use for choropleth mapping. If None,
a single color will be used. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="matplotlib.colors.Colormap">Colormap</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for
choropleth mapping. Defaults to "viridis".</p>
              </div>
            </td>
            <td>
                  <code>&#39;viridis&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height) in inches.
Defaults to (10, 10).</p>
              </div>
            </td>
            <td>
                  <code>(10, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title for the plot. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a legend. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a web basemap. Requires contextily.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of basemap to use. Options: 'streets', 'satellite'.
Defaults to 'streets'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;streets&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transparency of the vector features, between 0-1.
Defaults to 0.7.</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edge_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color for feature edges. Defaults to "black".</p>
              </div>
            </td>
            <td>
                  <code>&#39;black&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>classification</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Classification method for choropleth maps.
Options: "quantiles", "equal_interval", "natural_breaks".
Defaults to "quantiles".</p>
              </div>
            </td>
            <td>
                  <code>&#39;quantiles&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_classes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for choropleth maps.
Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highlight_index</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices to highlight.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highlight_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color to use for highlighted features.
Defaults to "red".</p>
              </div>
            </td>
            <td>
                  <code>&#39;red&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scheme</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>MapClassify classification scheme. Overrides
classification parameter if provided. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the figure. If None, the figure
is not saved. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dpi</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI for saved figure. Defaults to 300.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>matplotlib.axes.Axes: The Axes object containing the plot.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cities</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;cities.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector</span><span class="p">(</span><span class="n">cities</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">roads</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;roads.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector</span><span class="p">(</span><span class="n">roads</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_vector</span><span class="p">(</span>
    <span class="n">vector_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">basemap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">basemap_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;streets&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">classification</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;quantiles&quot;</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">highlight_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">highlight_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">scheme</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize vector datasets with options for styling, classification, basemaps and more.</span>

<span class="sd">    This function visualizes GeoDataFrame objects with customizable symbology.</span>
<span class="sd">    It supports different vector types (points, lines, polygons), attribute-based</span>
<span class="sd">    classification, and background basemaps.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_data (geopandas.GeoDataFrame): The vector dataset to visualize.</span>
<span class="sd">        column (str, optional): Column to use for choropleth mapping. If None,</span>
<span class="sd">            a single color will be used. Defaults to None.</span>
<span class="sd">        cmap (str or matplotlib.colors.Colormap, optional): Colormap to use for</span>
<span class="sd">            choropleth mapping. Defaults to &quot;viridis&quot;.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height) in inches.</span>
<span class="sd">            Defaults to (10, 10).</span>
<span class="sd">        title (str, optional): Title for the plot. Defaults to None.</span>
<span class="sd">        legend (bool, optional): Whether to display a legend. Defaults to True.</span>
<span class="sd">        basemap (bool, optional): Whether to add a web basemap. Requires contextily.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        basemap_type (str, optional): Type of basemap to use. Options: &#39;streets&#39;, &#39;satellite&#39;.</span>
<span class="sd">            Defaults to &#39;streets&#39;.</span>
<span class="sd">        alpha (float, optional): Transparency of the vector features, between 0-1.</span>
<span class="sd">            Defaults to 0.7.</span>
<span class="sd">        edge_color (str, optional): Color for feature edges. Defaults to &quot;black&quot;.</span>
<span class="sd">        classification (str, optional): Classification method for choropleth maps.</span>
<span class="sd">            Options: &quot;quantiles&quot;, &quot;equal_interval&quot;, &quot;natural_breaks&quot;.</span>
<span class="sd">            Defaults to &quot;quantiles&quot;.</span>
<span class="sd">        n_classes (int, optional): Number of classes for choropleth maps.</span>
<span class="sd">            Defaults to 5.</span>
<span class="sd">        highlight_index (list, optional): List of indices to highlight.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        highlight_color (str, optional): Color to use for highlighted features.</span>
<span class="sd">            Defaults to &quot;red&quot;.</span>
<span class="sd">        scheme (str, optional): MapClassify classification scheme. Overrides</span>
<span class="sd">            classification parameter if provided. Defaults to None.</span>
<span class="sd">        save_path (str, optional): Path to save the figure. If None, the figure</span>
<span class="sd">            is not saved. Defaults to None.</span>
<span class="sd">        dpi (int, optional): DPI for saved figure. Defaults to 300.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.axes.Axes: The Axes object containing the plot.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">        &gt;&gt;&gt; cities = gpd.read_file(&quot;cities.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector(cities, &quot;population&quot;, cmap=&quot;Reds&quot;, basemap=True)</span>

<span class="sd">        &gt;&gt;&gt; roads = gpd.read_file(&quot;roads.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector(roads, &quot;type&quot;, basemap=True, figsize=(12, 8))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">contextily</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ctx</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>

    <span class="c1"># Check if input is a GeoDataFrame</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input data must be a GeoDataFrame&quot;</span><span class="p">)</span>

    <span class="c1"># Make a copy to avoid changing the original data</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Set up figure and axis</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Determine geometry type</span>
    <span class="n">geom_type</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geom_type</span>

    <span class="c1"># Plotting parameters</span>
    <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;ax&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="p">}</span>

    <span class="c1"># Set up keyword arguments based on geometry type</span>
    <span class="k">if</span> <span class="s2">&quot;Point&quot;</span> <span class="ow">in</span> <span class="n">geom_type</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_color</span>
    <span class="k">elif</span> <span class="s2">&quot;Line&quot;</span> <span class="ow">in</span> <span class="n">geom_type</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="s2">&quot;Polygon&quot;</span> <span class="ow">in</span> <span class="n">geom_type</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_color</span>

    <span class="c1"># Classification options</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use mapclassify scheme if provided</span>
            <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scheme</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use classification parameter</span>
            <span class="k">if</span> <span class="n">classification</span> <span class="o">==</span> <span class="s2">&quot;quantiles&quot;</span><span class="p">:</span>
                <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;quantiles&quot;</span>
            <span class="k">elif</span> <span class="n">classification</span> <span class="o">==</span> <span class="s2">&quot;equal_interval&quot;</span><span class="p">:</span>
                <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;equal_interval&quot;</span>
            <span class="k">elif</span> <span class="n">classification</span> <span class="o">==</span> <span class="s2">&quot;natural_breaks&quot;</span><span class="p">:</span>
                <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fisher_jenks&quot;</span>

        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_classes</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend</span>

    <span class="c1"># Plot the main data</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># Highlight specific features if requested</span>
    <span class="k">if</span> <span class="n">highlight_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">highlight_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">highlight_color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">basemap</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">basemap_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;streets&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span>
                <span class="s2">&quot;satellite&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">Esri</span><span class="o">.</span><span class="n">WorldImagery</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">basemap_options</span><span class="p">[</span><span class="n">basemap_type</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add basemap: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set title if provided</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Remove axes if not needed</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

    <span class="c1"># Adjust layout</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save figure if a path is provided</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.view_vector_interactive" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_vector_interactive</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s1">&#39;Vector Layer&#39;</span><span class="p">,</span> <span class="n">tiles_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.geoai.view_vector_interactive" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize vector datasets with options for styling, classification, basemaps and more.</p>
<p>This function visualizes GeoDataFrame objects with customizable symbology.
It supports different vector types (points, lines, polygons), attribute-based
classification, and background basemaps.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_data</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector dataset to visualize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the layer. Defaults to "Vector Layer".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Vector Layer&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tiles_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the localtileserver client.
get_folium_tile_layer function. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to GeoDataFrame.explore() function.
See https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folium.Map: The map object with the vector data added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cities</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;cities.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector_interactive</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">roads</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;roads.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector_interactive</span><span class="p">(</span><span class="n">roads</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_vector_interactive</span><span class="p">(</span>
    <span class="n">vector_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">layer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Vector Layer&quot;</span><span class="p">,</span>
    <span class="n">tiles_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize vector datasets with options for styling, classification, basemaps and more.</span>

<span class="sd">    This function visualizes GeoDataFrame objects with customizable symbology.</span>
<span class="sd">    It supports different vector types (points, lines, polygons), attribute-based</span>
<span class="sd">    classification, and background basemaps.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_data (geopandas.GeoDataFrame): The vector dataset to visualize.</span>
<span class="sd">        layer_name (str, optional): The name of the layer. Defaults to &quot;Vector Layer&quot;.</span>
<span class="sd">        tiles_args (dict, optional): Additional arguments for the localtileserver client.</span>
<span class="sd">            get_folium_tile_layer function. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to GeoDataFrame.explore() function.</span>
<span class="sd">            See https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html</span>

<span class="sd">    Returns:</span>
<span class="sd">        folium.Map: The map object with the vector data added.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">        &gt;&gt;&gt; cities = gpd.read_file(&quot;cities.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector_interactive(cities)</span>

<span class="sd">        &gt;&gt;&gt; roads = gpd.read_file(&quot;roads.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector_interactive(roads, figsize=(12, 8))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">folium.plugins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plugins</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">leafmap</span><span class="w"> </span><span class="kn">import</span> <span class="n">cog_tile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">localtileserver</span><span class="w"> </span><span class="kn">import</span> <span class="n">TileClient</span><span class="p">,</span> <span class="n">get_folium_tile_layer</span>

    <span class="n">google_tiles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Roadmap&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=m&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Maps&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;Satellite&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=s&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Satellite&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;Terrain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=p&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Terrain&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;Hybrid&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=y&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Hybrid&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Make it compatible with binder and JupyterHub</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;JUPYTERHUB_SERVICE_PREFIX&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LOCALTILESERVER_CLIENT_PREFIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JUPYTERHUB_SERVICE_PREFIX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/proxy/</span><span class="se">{{</span><span class="s2">port</span><span class="se">}}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">raster_layer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;tiles&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="ow">in</span> <span class="n">google_tiles</span><span class="p">:</span>
            <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="n">google_tiles</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">google_tiles</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Google&quot;</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tiles_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tiles_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="s2">&quot;Remote Raster&quot;</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cog_tile</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">tiles_args</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TiTiler&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="s2">&quot;Local Raster&quot;</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">TileClient</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">])</span>
                <span class="n">raster_layer</span> <span class="o">=</span> <span class="n">get_folium_tile_layer</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">**</span><span class="n">tiles_args</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raster_layer</span><span class="o">.</span><span class="n">tiles</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;localtileserver&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;max_zoom&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_zoom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
            <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>

    <span class="c1"># Check if input is a GeoDataFrame</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input data must be a GeoDataFrame&quot;</span><span class="p">)</span>

    <span class="n">layer_control</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;layer_control&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">fullscreen_control</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fullscreen_control&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Change the layer name</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">):</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">basemap_layer_name</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">layer_name</span> <span class="o">=</span> <span class="n">basemap_layer_name</span>

    <span class="k">if</span> <span class="n">layer_control</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">fullscreen_control</span><span class="p">:</span>
        <span class="n">plugins</span><span class="o">.</span><span class="n">Fullscreen</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.visualize_vector_by_attribute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visualize_vector_by_attribute</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></code>

<a href="#geoai.geoai.visualize_vector_by_attribute" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a thematic map visualization of vector data based on an attribute.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute to visualize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Matplotlib colormap name. Defaults to 'viridis'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;viridis&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height). Defaults to (10, 8).</p>
              </div>
            </td>
            <td>
                  <code>(10, 8)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if visualization was successful, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_vector_by_attribute</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a thematic map visualization of vector data based on an attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>
<span class="sd">        attribute_name (str): Name of the attribute to visualize</span>
<span class="sd">        cmap (str, optional): Matplotlib colormap name. Defaults to &#39;viridis&#39;.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height). Defaults to (10, 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if visualization was successful, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read the vector data</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Check if attribute exists</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; not found in the dataset&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Create the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Determine plot type based on data type</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]):</span>
            <span class="c1"># Continuous data</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Categorical data</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Add title and labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>

        <span class="c1"># Add basemap or additional elements if available</span>
        <span class="c1"># Note: Additional options could be added here for more complex maps</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error visualizing data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.geoai.write_colormap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_colormap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.geoai.write_colormap" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Write a colormap to an image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The image to write the colormap to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>colormap</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to write to the image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output file path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">8749</span>
<span class="normal">8750</span>
<span class="normal">8751</span>
<span class="normal">8752</span>
<span class="normal">8753</span>
<span class="normal">8754</span>
<span class="normal">8755</span>
<span class="normal">8756</span>
<span class="normal">8757</span>
<span class="normal">8758</span>
<span class="normal">8759</span>
<span class="normal">8760</span>
<span class="normal">8761</span>
<span class="normal">8762</span>
<span class="normal">8763</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_colormap</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a colormap to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The image to write the colormap to.</span>
<span class="sd">        colormap: The colormap to write to the image.</span>
<span class="sd">        output: The output file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">get_image_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
    <span class="n">leafmap</span><span class="o">.</span><span class="n">write_image_colormap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="July 27, 2024 16:50:48 UTC"><span class="timeago" datetime="2024-07-27T16:50:48+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="July 27, 2024 16:50:48 UTC">2024-07-27</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="August 11, 2023 20:22:47 UTC"><span class="timeago" datetime="2023-08-11T20:22:47+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="August 11, 2023 20:22:47 UTC">2023-08-11</span>
  </span>

    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2025 Qiusheng Wu
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../js/timeago.min.js"></script>
      
        <script src="../js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>