
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A Python package for using Artificial Intelligence (AI) with geospatial data">
      
      
        <meta name="author" content="opengeos">
      
      
        <link rel="canonical" href="https://opengeoai.org/utils/">
      
      
        <link rel="prev" href="../train/">
      
      
      
        
      
      
      <link rel="icon" href="../assets/logo.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>utils module - GeoAI</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../css/timeago.css">
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#utils-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GeoAI" class="md-header__button md-logo" aria-label="GeoAI" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GeoAI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              utils module
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/opengeos/geoai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GeoAI" class="md-nav__button md-logo" aria-label="GeoAI" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    GeoAI
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/opengeos/geoai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../qgis_plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QGIS Plugin
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/opengeos/geoai/releases" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/opengeos/geoai/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Report Issues
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/download_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Download data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/download_sentinel2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Download sentinel2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/download_naip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Download naip
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/planetary_computer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Planetary computer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/view_metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    View metadata
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/create_vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create vector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/edit_vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Edit vector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/image_chips/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image chips
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/image_tiling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image tiling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/create_training_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create training data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/export_training_data_formats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Export training data formats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/data_augmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data augmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_footprints_usa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building footprints usa
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_footprints_africa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building footprints africa
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_footprints_china/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building footprints china
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_regularization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building regularization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/geometric_properties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Geometric properties
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/car_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Car detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/ship_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ship detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/solar_panel_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Solar panel detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/text_prompt_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text prompt segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/parking_spot_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parking spot detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/data_visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_object_detection_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train object detection model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_segmentation_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train segmentation model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_instance_segmentation_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train instance segmentation model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_landcover_classification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train landcover classification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_building_footprints_usa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train building footprints usa
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_solar_panel_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train solar panel detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_car_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train car detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_ship_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train ship detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_water_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train water detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/water_dynamics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Water dynamics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/wetland_mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wetland mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/wetland_dynamics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wetland dynamics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/wetland_sam3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wetland sam3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/regularization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Regularization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/globe_projection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Globe projection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/samgeo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Samgeo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/grounded_sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Grounded sam
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/load_model_checkpoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Load model checkpoint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/water_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Water detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/water_detection_s2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Water detection s2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/batch_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Batch segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/building_detection_lidar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building detection lidar
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/instance_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Instance segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/change_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Change detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/JPEG2000/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JPEG2000
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/DINOv3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DINOv3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/DINOv3_visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DINOv3 visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/DINOv3_wetlands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DINOv3 wetlands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/AlphaEarth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AlphaEarth
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/AI_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/STAC_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STAC agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/catalog_search_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Catalog search agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_timm_classifier/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train timm classifier
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/train_timm_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Train timm segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/lightly_train_self_supervised/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lightly train self supervised
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/clean_segmentation_results/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clean segmentation results
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/cloud_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cloud detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/moondream/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Moondream
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/moondream_gui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Moondream gui
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/AutoModel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AutoModel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/smooth_vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Smooth vector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/timelapse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Timelapse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Workshops
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workshops
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/GeoAI_Workshop_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GeoAI Workshop 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/AWS_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/TNView_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TNView 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/CANVAS_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CANVAS 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/AGU_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AGU 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../auto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    auto module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../change_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    change_detection module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../classify/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    classify module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../detectron2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    detectron2 module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dinov3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DINOv3 module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../geo_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    geo_agents module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../geoai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    geoai module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../download/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    download module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    extract module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hf module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../map_tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    map_tools module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../map_widgets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    map_widgets module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moondream/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    moondream module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    sam module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    segmentation module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../timm_train/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    timm_train module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../timm_segment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    timm_segment module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../train/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    train module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    utils module
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    utils module
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#geoai.utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        utils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.adaptive_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      
        adaptive_regularization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.add_geometric_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_geometric_properties
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.analyze_vector_attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyze_vector_attributes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.batch_vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_vector_to_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.bbox_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        bbox_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.boxes_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        boxes_to_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.calc_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        calc_stats
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.clip_raster_by_bbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        clip_raster_by_bbox
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.coords_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        coords_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.create_overview_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_overview_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.create_split_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_split_map
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.dict_to_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        dict_to_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.dict_to_rioxarray" class="md-nav__link">
    <span class="md-ellipsis">
      
        dict_to_rioxarray
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.download_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        download_file
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.download_model_from_hf" class="md-nav__link">
    <span class="md-ellipsis">
      
        download_model_from_hf
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.empty_cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        empty_cache
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_geotiff_tiles" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_geotiff_tiles
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_geotiff_tiles_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_geotiff_tiles_batch
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_tiles_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_tiles_to_geojson
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_training_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_training_data
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.geojson_to_coords" class="md-nav__link">
    <span class="md-ellipsis">
      
        geojson_to_coords
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.geojson_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        geojson_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_device" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_device
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_info_gdal" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_info_gdal
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_resolution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_stats
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vector_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_vector_info_ogr" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vector_info_ogr
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.hybrid_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      
        hybrid_regularization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.inspect_pth_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        inspect_pth_file
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.install_package" class="md-nav__link">
    <span class="md-ellipsis">
      
        install_package
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.masks_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        masks_to_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.mosaic_geotiffs" class="md-nav__link">
    <span class="md-ellipsis">
      
        mosaic_geotiffs
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.orthogonalize" class="md-nav__link">
    <span class="md-ellipsis">
      
        orthogonalize
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_batch
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_images" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_images
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_masks
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_performance_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_performance_metrics
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_prediction_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_prediction_comparison
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.print_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_raster_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.print_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_vector_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.raster_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        raster_to_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.raster_to_vector_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        raster_to_vector_batch
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.read_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.read_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.region_groups" class="md-nav__link">
    <span class="md-ellipsis">
      
        region_groups
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.regularization" class="md-nav__link">
    <span class="md-ellipsis">
      
        regularization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.regularize" class="md-nav__link">
    <span class="md-ellipsis">
      
        regularize
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.rowcol_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        rowcol_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.smooth_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        smooth_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.stack_bands" class="md-nav__link">
    <span class="md-ellipsis">
      
        stack_bands
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.temp_file_path" class="md-nav__link">
    <span class="md-ellipsis">
      
        temp_file_path
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.try_common_architectures" class="md-nav__link">
    <span class="md-ellipsis">
      
        try_common_architectures
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.vector_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      
        vector_to_geojson
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        vector_to_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_vector_interactive" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_vector_interactive
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.visualize_vector_by_attribute" class="md-nav__link">
    <span class="md-ellipsis">
      
        visualize_vector_by_attribute
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.write_colormap" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_colormap
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#geoai.utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        utils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.adaptive_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      
        adaptive_regularization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.add_geometric_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_geometric_properties
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.analyze_vector_attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyze_vector_attributes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.batch_vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_vector_to_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.bbox_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        bbox_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.boxes_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        boxes_to_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.calc_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        calc_stats
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.clip_raster_by_bbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        clip_raster_by_bbox
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.coords_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        coords_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.create_overview_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_overview_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.create_split_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_split_map
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.dict_to_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        dict_to_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.dict_to_rioxarray" class="md-nav__link">
    <span class="md-ellipsis">
      
        dict_to_rioxarray
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.download_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        download_file
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.download_model_from_hf" class="md-nav__link">
    <span class="md-ellipsis">
      
        download_model_from_hf
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.empty_cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        empty_cache
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_geotiff_tiles" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_geotiff_tiles
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_geotiff_tiles_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_geotiff_tiles_batch
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_tiles_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_tiles_to_geojson
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.export_training_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_training_data
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.geojson_to_coords" class="md-nav__link">
    <span class="md-ellipsis">
      
        geojson_to_coords
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.geojson_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        geojson_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_device" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_device
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_info_gdal" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_info_gdal
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_resolution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_raster_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_raster_stats
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vector_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.get_vector_info_ogr" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vector_info_ogr
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.hybrid_regularization" class="md-nav__link">
    <span class="md-ellipsis">
      
        hybrid_regularization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.inspect_pth_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        inspect_pth_file
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.install_package" class="md-nav__link">
    <span class="md-ellipsis">
      
        install_package
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.masks_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        masks_to_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.mosaic_geotiffs" class="md-nav__link">
    <span class="md-ellipsis">
      
        mosaic_geotiffs
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.orthogonalize" class="md-nav__link">
    <span class="md-ellipsis">
      
        orthogonalize
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_batch
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_images" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_images
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_masks
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_performance_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_performance_metrics
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.plot_prediction_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_prediction_comparison
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.print_raster_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_raster_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.print_vector_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_vector_info
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.raster_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        raster_to_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.raster_to_vector_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        raster_to_vector_batch
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.read_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.read_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.region_groups" class="md-nav__link">
    <span class="md-ellipsis">
      
        region_groups
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.regularization" class="md-nav__link">
    <span class="md-ellipsis">
      
        regularization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.regularize" class="md-nav__link">
    <span class="md-ellipsis">
      
        regularize
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.rowcol_to_xy" class="md-nav__link">
    <span class="md-ellipsis">
      
        rowcol_to_xy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.smooth_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        smooth_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.stack_bands" class="md-nav__link">
    <span class="md-ellipsis">
      
        stack_bands
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.temp_file_path" class="md-nav__link">
    <span class="md-ellipsis">
      
        temp_file_path
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.try_common_architectures" class="md-nav__link">
    <span class="md-ellipsis">
      
        try_common_architectures
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.vector_to_geojson" class="md-nav__link">
    <span class="md-ellipsis">
      
        vector_to_geojson
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.vector_to_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        vector_to_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_raster" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_raster
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.view_vector_interactive" class="md-nav__link">
    <span class="md-ellipsis">
      
        view_vector_interactive
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.visualize_vector_by_attribute" class="md-nav__link">
    <span class="md-ellipsis">
      
        visualize_vector_by_attribute
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoai.utils.write_colormap" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_colormap
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="utils-module">utils module<a class="headerlink" href="#utils-module" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="geoai.utils"></a>
    <div class="doc doc-contents first">

        <p>The utils module contains common functions and classes used by the other modules.</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="geoai.utils.adaptive_regularization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">adaptive_regularization</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">area_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">preserve_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.utils.adaptive_regularization" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Adaptively regularizes building footprints based on their characteristics.</p>
<p>This approach determines the best regularization method for each building.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>building_polygons</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distance tolerance for simplification</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum acceptable area ratio</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_shape</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to preserve overall shape for complex buildings</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">adaptive_regularization</span><span class="p">(</span>
    <span class="n">building_polygons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">area_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">preserve_shape</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptively regularizes building footprints based on their characteristics.</span>

<span class="sd">    This approach determines the best regularization method for each building.</span>

<span class="sd">    Args:</span>
<span class="sd">        building_polygons: GeoDataFrame or list of shapely Polygons</span>
<span class="sd">        simplify_tolerance: Distance tolerance for simplification</span>
<span class="sd">        area_threshold: Minimum acceptable area ratio</span>
<span class="sd">        preserve_shape: Whether to preserve overall shape for complex buildings</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame or list of shapely Polygons with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Analyze the overall dataset to set appropriate parameters</span>
    <span class="k">if</span> <span class="n">is_gdf</span> <span class="o">:=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">geom_objects</span><span class="p">:</span>
        <span class="c1"># Skip invalid geometries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">building</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Measure building complexity</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>

        <span class="c1"># Determine if the building has a clear principal direction</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">segment_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># Normalize angles to 0-180 range and get histogram</span>
        <span class="n">norm_angles</span> <span class="o">=</span> <span class="n">angles</span> <span class="o">%</span> <span class="mi">180</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">norm_angles</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">segment_lengths</span>
        <span class="p">)</span>

        <span class="c1"># Calculate direction clarity (ratio of longest direction to total)</span>
        <span class="n">direction_clarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Choose regularization method based on building characteristics</span>
        <span class="k">if</span> <span class="n">complexity</span> <span class="o">&lt;</span> <span class="mf">1.2</span> <span class="ow">and</span> <span class="n">direction_clarity</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># Simple building with clear direction: use rotated rectangle</span>
            <span class="n">bin_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
            <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">dominant_angle</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">bin_max</span><span class="p">]</span>

            <span class="c1"># Rotate to align with coordinate system</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Create bounding box in rotated space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Rotate back</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Quality check</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">building</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">area_threshold</span>
                <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">building</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">area_threshold</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># Too much area change, use simplified original</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tolerance</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Complex building or no clear direction: preserve shape</span>
            <span class="k">if</span> <span class="n">preserve_shape</span><span class="p">:</span>
                <span class="c1"># Simplify with topology preservation</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tolerance</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fall back to convex hull for very complex shapes</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">convex_hull</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Return in same format as input</span>
    <span class="k">if</span> <span class="n">is_gdf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">building_polygons</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.add_geometric_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_geometric_properties</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">area_unit</span><span class="o">=</span><span class="s1">&#39;m2&#39;</span><span class="p">,</span> <span class="n">length_unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span></code>

<a href="#geoai.utils.add_geometric_properties" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculates geometric properties and adds them to the GeoDataFrame.</p>
<p>This function calculates various geometric properties of features in a
GeoDataFrame and adds them as new columns without modifying existing attributes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame containing vector features.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>properties</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of geometric properties to calculate. Options include:
'area', 'length', 'perimeter', 'centroid_x', 'centroid_y', 'bounds',
'convex_hull_area', 'orientation', 'complexity', 'area_bbox',
'area_convex', 'area_filled', 'major_length', 'minor_length',
'eccentricity', 'diameter_areagth', 'extent', 'solidity',
'elongation'.
Defaults to ['area', 'length'] if None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String specifying the unit for area calculation ('m2', 'km2',
'ha'). Defaults to 'm2'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;m2&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>length_unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String specifying the unit for length calculation ('m', 'km').
Defaults to 'm'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;m&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame: A copy of the input GeoDataFrame with added</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geometric property columns.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5239</span>
<span class="normal">5240</span>
<span class="normal">5241</span>
<span class="normal">5242</span>
<span class="normal">5243</span>
<span class="normal">5244</span>
<span class="normal">5245</span>
<span class="normal">5246</span>
<span class="normal">5247</span>
<span class="normal">5248</span>
<span class="normal">5249</span>
<span class="normal">5250</span>
<span class="normal">5251</span>
<span class="normal">5252</span>
<span class="normal">5253</span>
<span class="normal">5254</span>
<span class="normal">5255</span>
<span class="normal">5256</span>
<span class="normal">5257</span>
<span class="normal">5258</span>
<span class="normal">5259</span>
<span class="normal">5260</span>
<span class="normal">5261</span>
<span class="normal">5262</span>
<span class="normal">5263</span>
<span class="normal">5264</span>
<span class="normal">5265</span>
<span class="normal">5266</span>
<span class="normal">5267</span>
<span class="normal">5268</span>
<span class="normal">5269</span>
<span class="normal">5270</span>
<span class="normal">5271</span>
<span class="normal">5272</span>
<span class="normal">5273</span>
<span class="normal">5274</span>
<span class="normal">5275</span>
<span class="normal">5276</span>
<span class="normal">5277</span>
<span class="normal">5278</span>
<span class="normal">5279</span>
<span class="normal">5280</span>
<span class="normal">5281</span>
<span class="normal">5282</span>
<span class="normal">5283</span>
<span class="normal">5284</span>
<span class="normal">5285</span>
<span class="normal">5286</span>
<span class="normal">5287</span>
<span class="normal">5288</span>
<span class="normal">5289</span>
<span class="normal">5290</span>
<span class="normal">5291</span>
<span class="normal">5292</span>
<span class="normal">5293</span>
<span class="normal">5294</span>
<span class="normal">5295</span>
<span class="normal">5296</span>
<span class="normal">5297</span>
<span class="normal">5298</span>
<span class="normal">5299</span>
<span class="normal">5300</span>
<span class="normal">5301</span>
<span class="normal">5302</span>
<span class="normal">5303</span>
<span class="normal">5304</span>
<span class="normal">5305</span>
<span class="normal">5306</span>
<span class="normal">5307</span>
<span class="normal">5308</span>
<span class="normal">5309</span>
<span class="normal">5310</span>
<span class="normal">5311</span>
<span class="normal">5312</span>
<span class="normal">5313</span>
<span class="normal">5314</span>
<span class="normal">5315</span>
<span class="normal">5316</span>
<span class="normal">5317</span>
<span class="normal">5318</span>
<span class="normal">5319</span>
<span class="normal">5320</span>
<span class="normal">5321</span>
<span class="normal">5322</span>
<span class="normal">5323</span>
<span class="normal">5324</span>
<span class="normal">5325</span>
<span class="normal">5326</span>
<span class="normal">5327</span>
<span class="normal">5328</span>
<span class="normal">5329</span>
<span class="normal">5330</span>
<span class="normal">5331</span>
<span class="normal">5332</span>
<span class="normal">5333</span>
<span class="normal">5334</span>
<span class="normal">5335</span>
<span class="normal">5336</span>
<span class="normal">5337</span>
<span class="normal">5338</span>
<span class="normal">5339</span>
<span class="normal">5340</span>
<span class="normal">5341</span>
<span class="normal">5342</span>
<span class="normal">5343</span>
<span class="normal">5344</span>
<span class="normal">5345</span>
<span class="normal">5346</span>
<span class="normal">5347</span>
<span class="normal">5348</span>
<span class="normal">5349</span>
<span class="normal">5350</span>
<span class="normal">5351</span>
<span class="normal">5352</span>
<span class="normal">5353</span>
<span class="normal">5354</span>
<span class="normal">5355</span>
<span class="normal">5356</span>
<span class="normal">5357</span>
<span class="normal">5358</span>
<span class="normal">5359</span>
<span class="normal">5360</span>
<span class="normal">5361</span>
<span class="normal">5362</span>
<span class="normal">5363</span>
<span class="normal">5364</span>
<span class="normal">5365</span>
<span class="normal">5366</span>
<span class="normal">5367</span>
<span class="normal">5368</span>
<span class="normal">5369</span>
<span class="normal">5370</span>
<span class="normal">5371</span>
<span class="normal">5372</span>
<span class="normal">5373</span>
<span class="normal">5374</span>
<span class="normal">5375</span>
<span class="normal">5376</span>
<span class="normal">5377</span>
<span class="normal">5378</span>
<span class="normal">5379</span>
<span class="normal">5380</span>
<span class="normal">5381</span>
<span class="normal">5382</span>
<span class="normal">5383</span>
<span class="normal">5384</span>
<span class="normal">5385</span>
<span class="normal">5386</span>
<span class="normal">5387</span>
<span class="normal">5388</span>
<span class="normal">5389</span>
<span class="normal">5390</span>
<span class="normal">5391</span>
<span class="normal">5392</span>
<span class="normal">5393</span>
<span class="normal">5394</span>
<span class="normal">5395</span>
<span class="normal">5396</span>
<span class="normal">5397</span>
<span class="normal">5398</span>
<span class="normal">5399</span>
<span class="normal">5400</span>
<span class="normal">5401</span>
<span class="normal">5402</span>
<span class="normal">5403</span>
<span class="normal">5404</span>
<span class="normal">5405</span>
<span class="normal">5406</span>
<span class="normal">5407</span>
<span class="normal">5408</span>
<span class="normal">5409</span>
<span class="normal">5410</span>
<span class="normal">5411</span>
<span class="normal">5412</span>
<span class="normal">5413</span>
<span class="normal">5414</span>
<span class="normal">5415</span>
<span class="normal">5416</span>
<span class="normal">5417</span>
<span class="normal">5418</span>
<span class="normal">5419</span>
<span class="normal">5420</span>
<span class="normal">5421</span>
<span class="normal">5422</span>
<span class="normal">5423</span>
<span class="normal">5424</span>
<span class="normal">5425</span>
<span class="normal">5426</span>
<span class="normal">5427</span>
<span class="normal">5428</span>
<span class="normal">5429</span>
<span class="normal">5430</span>
<span class="normal">5431</span>
<span class="normal">5432</span>
<span class="normal">5433</span>
<span class="normal">5434</span>
<span class="normal">5435</span>
<span class="normal">5436</span>
<span class="normal">5437</span>
<span class="normal">5438</span>
<span class="normal">5439</span>
<span class="normal">5440</span>
<span class="normal">5441</span>
<span class="normal">5442</span>
<span class="normal">5443</span>
<span class="normal">5444</span>
<span class="normal">5445</span>
<span class="normal">5446</span>
<span class="normal">5447</span>
<span class="normal">5448</span>
<span class="normal">5449</span>
<span class="normal">5450</span>
<span class="normal">5451</span>
<span class="normal">5452</span>
<span class="normal">5453</span>
<span class="normal">5454</span>
<span class="normal">5455</span>
<span class="normal">5456</span>
<span class="normal">5457</span>
<span class="normal">5458</span>
<span class="normal">5459</span>
<span class="normal">5460</span>
<span class="normal">5461</span>
<span class="normal">5462</span>
<span class="normal">5463</span>
<span class="normal">5464</span>
<span class="normal">5465</span>
<span class="normal">5466</span>
<span class="normal">5467</span>
<span class="normal">5468</span>
<span class="normal">5469</span>
<span class="normal">5470</span>
<span class="normal">5471</span>
<span class="normal">5472</span>
<span class="normal">5473</span>
<span class="normal">5474</span>
<span class="normal">5475</span>
<span class="normal">5476</span>
<span class="normal">5477</span>
<span class="normal">5478</span>
<span class="normal">5479</span>
<span class="normal">5480</span>
<span class="normal">5481</span>
<span class="normal">5482</span>
<span class="normal">5483</span>
<span class="normal">5484</span>
<span class="normal">5485</span>
<span class="normal">5486</span>
<span class="normal">5487</span>
<span class="normal">5488</span>
<span class="normal">5489</span>
<span class="normal">5490</span>
<span class="normal">5491</span>
<span class="normal">5492</span>
<span class="normal">5493</span>
<span class="normal">5494</span>
<span class="normal">5495</span>
<span class="normal">5496</span>
<span class="normal">5497</span>
<span class="normal">5498</span>
<span class="normal">5499</span>
<span class="normal">5500</span>
<span class="normal">5501</span>
<span class="normal">5502</span>
<span class="normal">5503</span>
<span class="normal">5504</span>
<span class="normal">5505</span>
<span class="normal">5506</span>
<span class="normal">5507</span>
<span class="normal">5508</span>
<span class="normal">5509</span>
<span class="normal">5510</span>
<span class="normal">5511</span>
<span class="normal">5512</span>
<span class="normal">5513</span>
<span class="normal">5514</span>
<span class="normal">5515</span>
<span class="normal">5516</span>
<span class="normal">5517</span>
<span class="normal">5518</span>
<span class="normal">5519</span>
<span class="normal">5520</span>
<span class="normal">5521</span>
<span class="normal">5522</span>
<span class="normal">5523</span>
<span class="normal">5524</span>
<span class="normal">5525</span>
<span class="normal">5526</span>
<span class="normal">5527</span>
<span class="normal">5528</span>
<span class="normal">5529</span>
<span class="normal">5530</span>
<span class="normal">5531</span>
<span class="normal">5532</span>
<span class="normal">5533</span>
<span class="normal">5534</span>
<span class="normal">5535</span>
<span class="normal">5536</span>
<span class="normal">5537</span>
<span class="normal">5538</span>
<span class="normal">5539</span>
<span class="normal">5540</span>
<span class="normal">5541</span>
<span class="normal">5542</span>
<span class="normal">5543</span>
<span class="normal">5544</span>
<span class="normal">5545</span>
<span class="normal">5546</span>
<span class="normal">5547</span>
<span class="normal">5548</span>
<span class="normal">5549</span>
<span class="normal">5550</span>
<span class="normal">5551</span>
<span class="normal">5552</span>
<span class="normal">5553</span>
<span class="normal">5554</span>
<span class="normal">5555</span>
<span class="normal">5556</span>
<span class="normal">5557</span>
<span class="normal">5558</span>
<span class="normal">5559</span>
<span class="normal">5560</span>
<span class="normal">5561</span>
<span class="normal">5562</span>
<span class="normal">5563</span>
<span class="normal">5564</span>
<span class="normal">5565</span>
<span class="normal">5566</span>
<span class="normal">5567</span>
<span class="normal">5568</span>
<span class="normal">5569</span>
<span class="normal">5570</span>
<span class="normal">5571</span>
<span class="normal">5572</span>
<span class="normal">5573</span>
<span class="normal">5574</span>
<span class="normal">5575</span>
<span class="normal">5576</span>
<span class="normal">5577</span>
<span class="normal">5578</span>
<span class="normal">5579</span>
<span class="normal">5580</span>
<span class="normal">5581</span>
<span class="normal">5582</span>
<span class="normal">5583</span>
<span class="normal">5584</span>
<span class="normal">5585</span>
<span class="normal">5586</span>
<span class="normal">5587</span>
<span class="normal">5588</span>
<span class="normal">5589</span>
<span class="normal">5590</span>
<span class="normal">5591</span>
<span class="normal">5592</span>
<span class="normal">5593</span>
<span class="normal">5594</span>
<span class="normal">5595</span>
<span class="normal">5596</span>
<span class="normal">5597</span>
<span class="normal">5598</span>
<span class="normal">5599</span>
<span class="normal">5600</span>
<span class="normal">5601</span>
<span class="normal">5602</span>
<span class="normal">5603</span>
<span class="normal">5604</span>
<span class="normal">5605</span>
<span class="normal">5606</span>
<span class="normal">5607</span>
<span class="normal">5608</span>
<span class="normal">5609</span>
<span class="normal">5610</span>
<span class="normal">5611</span>
<span class="normal">5612</span>
<span class="normal">5613</span>
<span class="normal">5614</span>
<span class="normal">5615</span>
<span class="normal">5616</span>
<span class="normal">5617</span>
<span class="normal">5618</span>
<span class="normal">5619</span>
<span class="normal">5620</span>
<span class="normal">5621</span>
<span class="normal">5622</span>
<span class="normal">5623</span>
<span class="normal">5624</span>
<span class="normal">5625</span>
<span class="normal">5626</span>
<span class="normal">5627</span>
<span class="normal">5628</span>
<span class="normal">5629</span>
<span class="normal">5630</span>
<span class="normal">5631</span>
<span class="normal">5632</span>
<span class="normal">5633</span>
<span class="normal">5634</span>
<span class="normal">5635</span>
<span class="normal">5636</span>
<span class="normal">5637</span>
<span class="normal">5638</span>
<span class="normal">5639</span>
<span class="normal">5640</span>
<span class="normal">5641</span>
<span class="normal">5642</span>
<span class="normal">5643</span>
<span class="normal">5644</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_geometric_properties</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">area_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m2&quot;</span><span class="p">,</span>
    <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates geometric properties and adds them to the GeoDataFrame.</span>

<span class="sd">    This function calculates various geometric properties of features in a</span>
<span class="sd">    GeoDataFrame and adds them as new columns without modifying existing attributes.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: GeoDataFrame containing vector features.</span>
<span class="sd">        properties: List of geometric properties to calculate. Options include:</span>
<span class="sd">            &#39;area&#39;, &#39;length&#39;, &#39;perimeter&#39;, &#39;centroid_x&#39;, &#39;centroid_y&#39;, &#39;bounds&#39;,</span>
<span class="sd">            &#39;convex_hull_area&#39;, &#39;orientation&#39;, &#39;complexity&#39;, &#39;area_bbox&#39;,</span>
<span class="sd">            &#39;area_convex&#39;, &#39;area_filled&#39;, &#39;major_length&#39;, &#39;minor_length&#39;,</span>
<span class="sd">            &#39;eccentricity&#39;, &#39;diameter_areagth&#39;, &#39;extent&#39;, &#39;solidity&#39;,</span>
<span class="sd">            &#39;elongation&#39;.</span>
<span class="sd">            Defaults to [&#39;area&#39;, &#39;length&#39;] if None.</span>
<span class="sd">        area_unit: String specifying the unit for area calculation (&#39;m2&#39;, &#39;km2&#39;,</span>
<span class="sd">            &#39;ha&#39;). Defaults to &#39;m2&#39;.</span>
<span class="sd">        length_unit: String specifying the unit for length calculation (&#39;m&#39;, &#39;km&#39;).</span>
<span class="sd">            Defaults to &#39;m&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: A copy of the input GeoDataFrame with added</span>
<span class="sd">        geometric property columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">unary_union</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Make a copy to avoid modifying the original</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Default properties to calculate</span>
    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convex_hull_area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;complexity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_bbox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_convex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_filled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;major_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minor_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diameter_area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elongation&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># Make sure we&#39;re working with a GeoDataFrame with a valid CRS</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input must be a GeoDataFrame&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;GeoDataFrame must have a defined coordinate reference system (CRS)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Ensure we&#39;re working with a projected CRS for accurate measurements</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
        <span class="c1"># Reproject to a suitable projected CRS for accurate measurements</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">estimate_utm_crs</span><span class="p">())</span>

    <span class="c1"># Basic area calculation with unit conversion</span>
    <span class="k">if</span> <span class="s2">&quot;area&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="c1"># Calculate area (only for polygons)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>  <span class="c1"># m to km</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>  <span class="c1"># m to hectares</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Length calculation with unit conversion</span>
    <span class="k">if</span> <span class="s2">&quot;length&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="c1"># Calculate length (works for lines and polygon boundaries)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>  <span class="c1"># m to km</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;length_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;length_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Perimeter calculation (for polygons)</span>
    <span class="k">if</span> <span class="s2">&quot;perimeter&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;perimeter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">length</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;perimeter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;perimeter&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>  <span class="c1"># m to km</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perimeter&quot;</span><span class="p">:</span> <span class="s2">&quot;perimeter_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perimeter&quot;</span><span class="p">:</span> <span class="s2">&quot;perimeter_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Centroid coordinates</span>
    <span class="k">if</span> <span class="s2">&quot;centroid_x&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="ow">or</span> <span class="s2">&quot;centroid_y&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>

        <span class="k">if</span> <span class="s2">&quot;centroid_x&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">x</span>

        <span class="k">if</span> <span class="s2">&quot;centroid_y&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">y</span>

    <span class="c1"># Bounding box properties</span>
    <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;miny&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;maxx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;maxy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span>

    <span class="c1"># Area of bounding box</span>
    <span class="k">if</span> <span class="s2">&quot;area_bbox&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;area_bbox_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;area_bbox_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;area_bbox_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Area of convex hull</span>
    <span class="k">if</span> <span class="s2">&quot;area_convex&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="ow">or</span> <span class="s2">&quot;convex_hull_area&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">convex_hull</span><span class="o">.</span><span class="n">area</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_convex&quot;</span><span class="p">:</span> <span class="s2">&quot;area_convex_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_convex&quot;</span><span class="p">:</span> <span class="s2">&quot;area_convex_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_convex&quot;</span><span class="p">:</span> <span class="s2">&quot;area_convex_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For backward compatibility</span>
        <span class="k">if</span> <span class="s2">&quot;convex_hull_area&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="ow">and</span> <span class="s2">&quot;area_convex&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_convex&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">:</span> <span class="s2">&quot;convex_hull_area_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">:</span> <span class="s2">&quot;convex_hull_area_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;convex_hull_area&quot;</span><span class="p">:</span> <span class="s2">&quot;convex_hull_area_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

    <span class="c1"># Area of filled geometry (no holes)</span>
    <span class="k">if</span> <span class="s2">&quot;area_filled&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_filled_area</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">)):</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">):</span>
                <span class="c1"># For MultiPolygon, fill all constituent polygons</span>
                <span class="n">filled_polys</span> <span class="o">=</span> <span class="p">[</span><span class="n">Polygon</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">unary_union</span><span class="p">(</span><span class="n">filled_polys</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For single Polygon, create a new one with just the exterior ring</span>
                <span class="k">return</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_filled_area</span><span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;km2&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_filled&quot;</span><span class="p">:</span> <span class="s2">&quot;area_filled_km2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">area_unit</span> <span class="o">==</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;area_filled&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_filled&quot;</span><span class="p">:</span> <span class="s2">&quot;area_filled_ha&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default is m</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;area_filled&quot;</span><span class="p">:</span> <span class="s2">&quot;area_filled_m2&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Axes lengths, eccentricity, orientation, and elongation</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;major_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minor_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elongation&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_axes_properties</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="c1"># Skip non-polygons</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Handle multipolygons by using the largest polygon</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">):</span>
                <span class="c1"># Get the polygon with the largest area</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">geoms</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the minimum rotated rectangle</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">minimum_rotated_rectangle</span>

                <span class="c1"># Extract coordinates</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span>
                    <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
                <span class="p">]</span>  <span class="c1"># Remove the duplicated last point</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

                <span class="c1"># Calculate lengths of all four sides</span>
                <span class="n">sides</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">p2</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span> <span class="o">%</span> <span class="mi">180</span>
                    <span class="n">sides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>

                <span class="c1"># Group sides by length (allowing for small differences due to floating point precision)</span>
                <span class="c1"># This ensures we correctly identify the rectangle&#39;s dimensions</span>
                <span class="n">sides_grouped</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># Tolerance for length comparison</span>

                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
                    <span class="n">length</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sides_grouped</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                            <span class="n">sides_grouped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                            <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                        <span class="n">sides_grouped</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>

                <span class="c1"># Get unique lengths (should be 2 for a rectangle, parallel sides have equal length)</span>
                <span class="n">unique_lengths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sides_grouped</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_lengths</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># If we don&#39;t get exactly 2 unique lengths, something is wrong with the rectangle</span>
                    <span class="c1"># Fall back to simpler method using bounds</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">bounds</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">major_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">minor_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span> <span class="k">else</span> <span class="mi">90</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">major_length</span> <span class="o">=</span> <span class="n">unique_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">minor_length</span> <span class="o">=</span> <span class="n">unique_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Get orientation from the major axis</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">sides_grouped</span><span class="p">[</span><span class="n">major_length</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Calculate eccentricity</span>
                <span class="k">if</span> <span class="n">major_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Eccentricity for an ellipse: e = sqrt(1 - (b/a))</span>
                    <span class="c1"># where a is the semi-major axis and b is the semi-minor axis</span>
                    <span class="n">eccentricity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">minor_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">major_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eccentricity</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Calculate elongation (ratio of minor to major axis)</span>
                <span class="n">elongation</span> <span class="o">=</span> <span class="n">major_length</span> <span class="o">/</span> <span class="n">minor_length</span> <span class="k">if</span> <span class="n">major_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                <span class="k">return</span> <span class="n">major_length</span><span class="p">,</span> <span class="n">minor_length</span><span class="p">,</span> <span class="n">eccentricity</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">elongation</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># For debugging</span>
                <span class="c1"># print(f&quot;Error calculating axes: {e}&quot;)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Apply the function and split the results</span>
        <span class="n">axes_data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_axes_properties</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;major_length&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;major_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Convert to requested units</span>
            <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;major_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;major_length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;major_length&quot;</span><span class="p">:</span> <span class="s2">&quot;major_length_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;major_length&quot;</span><span class="p">:</span> <span class="s2">&quot;major_length_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;minor_length&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minor_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Convert to requested units</span>
            <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minor_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;minor_length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;minor_length&quot;</span><span class="p">:</span> <span class="s2">&quot;minor_length_km&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;minor_length&quot;</span><span class="p">:</span> <span class="s2">&quot;minor_length_m&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;eccentricity&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;eccentricity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;elongation&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;elongation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Equivalent diameter based on area</span>
    <span class="k">if</span> <span class="s2">&quot;diameter_areagth&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_equivalent_diameter</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># Diameter of a circle with the same area: d = 2 * sqrt(A / )</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_equivalent_diameter</span><span class="p">)</span>

        <span class="c1"># Convert to requested units</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s2">&quot;km&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1_000</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">:</span> <span class="s2">&quot;equivalent_diameter_area_km&quot;</span><span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;diameter_areagth&quot;</span><span class="p">:</span> <span class="s2">&quot;equivalent_diameter_area_m&quot;</span><span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Extent (ratio of shape area to bounding box area)</span>
    <span class="k">if</span> <span class="s2">&quot;extent&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_extent</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">bbox_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">bbox_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">bbox_area</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;extent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_extent</span><span class="p">)</span>

    <span class="c1"># Solidity (ratio of shape area to convex hull area)</span>
    <span class="k">if</span> <span class="s2">&quot;solidity&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_solidity</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">or</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">convex_hull_area</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">convex_hull</span><span class="o">.</span><span class="n">area</span>

            <span class="k">if</span> <span class="n">convex_hull_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">convex_hull_area</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;solidity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_solidity</span><span class="p">)</span>

    <span class="c1"># Complexity (ratio of perimeter to area)</span>
    <span class="k">if</span> <span class="s2">&quot;complexity&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">calc_complexity</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">))</span> <span class="ow">and</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Shape index: P / (2 * sqrt( * A))</span>
                <span class="c1"># Normalized to 1 for a circle, higher for more complex shapes</span>
                <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;complexity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_complexity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.analyze_vector_attributes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_vector_attributes</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">)</span></code>

<a href="#geoai.utils.analyze_vector_attributes" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Analyze a specific attribute in a vector dataset and create a histogram.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing analysis results for the attribute</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_vector_attributes</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze a specific attribute in a vector dataset and create a histogram.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>
<span class="sd">        attribute_name (str): Name of the attribute to analyze</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing analysis results for the attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Check if attribute exists</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; not found in the dataset&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get the attribute series</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]</span>

        <span class="c1"># Perform different analyses based on data type</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="c1"># Numeric attribute</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attribute_name</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;numeric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="s2">&quot;null_count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="c1"># Create histogram</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram of </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Categorical attribute</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attribute_name</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="s2">&quot;null_count&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;unique_values&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
                <span class="s2">&quot;value_counts&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="c1"># Create bar plot for top categories</span>
            <span class="n">top_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s2"> values for </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">analysis</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing attribute: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.batch_vector_to_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_vector_to_raster</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">attribute_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_rasters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_filename_pattern</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{vector_name}</span><span class="s1">_</span><span class="si">{index}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.batch_vector_to_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Batch convert vector data to multiple rasters based on different extents or reference rasters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input vector file or a GeoDataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save output raster files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in the vector data to use for pixel values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_rasters</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of paths to reference rasters for dimensions, transform and CRS.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bounds_list</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of bounds tuples (left, bottom, right, top) to use if reference_rasters not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_filename_pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pattern for output filenames.
Can include {vector_name} and {index} placeholders.</p>
              </div>
            </td>
            <td>
                  <code>&#39;{vector_name}_{index}&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pixel_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size to use if reference_rasters not provided.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, all pixels touched by geometries will be burned in.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fill_value</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to fill the raster with before burning in features.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="numpy.dtype">dtype</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type of the output raster.</p>
              </div>
            </td>
            <td>
                  <code><span title="numpy.uint8">uint8</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nodata</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>No data value for the output raster.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: List of paths to the created raster files.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">batch_vector_to_raster</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">attribute_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_rasters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bounds_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_filename_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{vector_name}</span><span class="s2">_</span><span class="si">{index}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">pixel_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch convert vector data to multiple rasters based on different extents or reference rasters.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str or GeoDataFrame): Path to the input vector file or a GeoDataFrame.</span>
<span class="sd">        output_dir (str): Directory to save output raster files.</span>
<span class="sd">        attribute_field (str): Field name in the vector data to use for pixel values.</span>
<span class="sd">        reference_rasters (list): List of paths to reference rasters for dimensions, transform and CRS.</span>
<span class="sd">        bounds_list (list): List of bounds tuples (left, bottom, right, top) to use if reference_rasters not provided.</span>
<span class="sd">        output_filename_pattern (str): Pattern for output filenames.</span>
<span class="sd">            Can include {vector_name} and {index} placeholders.</span>
<span class="sd">        pixel_size (float or tuple): Pixel size to use if reference_rasters not provided.</span>
<span class="sd">        all_touched (bool): If True, all pixels touched by geometries will be burned in.</span>
<span class="sd">        fill_value (int): Value to fill the raster with before burning in features.</span>
<span class="sd">        dtype (numpy.dtype): Data type of the output raster.</span>
<span class="sd">        nodata (int): No data value for the output raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: List of paths to the created raster files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load vector data if it&#39;s a path</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
        <span class="n">vector_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vector_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">vector_path</span>
        <span class="n">vector_name</span> <span class="o">=</span> <span class="s2">&quot;vector&quot;</span>

    <span class="c1"># Check input parameters</span>
    <span class="k">if</span> <span class="n">reference_rasters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bounds_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either reference_rasters or bounds_list must be provided.&quot;</span><span class="p">)</span>

    <span class="c1"># Use reference_rasters if provided, otherwise use bounds_list</span>
    <span class="k">if</span> <span class="n">reference_rasters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">reference_rasters</span>
        <span class="n">is_raster_reference</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">bounds_list</span>
        <span class="n">is_raster_reference</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Create output filenames</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each source (reference raster or bounds)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing&quot;</span><span class="p">)):</span>
        <span class="c1"># Generate output filename</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">output_filename_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">vector_name</span><span class="o">=</span><span class="n">vector_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="n">output_filename</span> <span class="o">+=</span> <span class="s2">&quot;.tif&quot;</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_raster_reference</span><span class="p">:</span>
            <span class="c1"># Use reference raster</span>
            <span class="n">vector_to_raster</span><span class="p">(</span>
                <span class="n">vector_path</span><span class="o">=</span><span class="n">gdf</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">reference_raster</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="n">attribute_field</span><span class="o">=</span><span class="n">attribute_field</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use bounds</span>
            <span class="n">vector_to_raster</span><span class="p">(</span>
                <span class="n">vector_path</span><span class="o">=</span><span class="n">gdf</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                <span class="n">attribute_field</span><span class="o">=</span><span class="n">attribute_field</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.bbox_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">bbox_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">coord_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.bbox_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a list of coordinates to pixel coordinates, i.e., (col, row) coordinates.
    Note that map bbox coords is [minx, miny, maxx, maxy] from bottomleft to topright
    While rasterio bbox coords is [minx, max, maxx, min] from topleft to bottomright</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of coordinates in the format of [[minx, miny, maxx, maxy], [minx, miny, maxx, maxy], ...]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coord_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coordinate CRS of the input coordinates. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of pixel coordinates in the format of [[minx, maxy, maxx, miny], ...] from top left to bottom right.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7394</span>
<span class="normal">7395</span>
<span class="normal">7396</span>
<span class="normal">7397</span>
<span class="normal">7398</span>
<span class="normal">7399</span>
<span class="normal">7400</span>
<span class="normal">7401</span>
<span class="normal">7402</span>
<span class="normal">7403</span>
<span class="normal">7404</span>
<span class="normal">7405</span>
<span class="normal">7406</span>
<span class="normal">7407</span>
<span class="normal">7408</span>
<span class="normal">7409</span>
<span class="normal">7410</span>
<span class="normal">7411</span>
<span class="normal">7412</span>
<span class="normal">7413</span>
<span class="normal">7414</span>
<span class="normal">7415</span>
<span class="normal">7416</span>
<span class="normal">7417</span>
<span class="normal">7418</span>
<span class="normal">7419</span>
<span class="normal">7420</span>
<span class="normal">7421</span>
<span class="normal">7422</span>
<span class="normal">7423</span>
<span class="normal">7424</span>
<span class="normal">7425</span>
<span class="normal">7426</span>
<span class="normal">7427</span>
<span class="normal">7428</span>
<span class="normal">7429</span>
<span class="normal">7430</span>
<span class="normal">7431</span>
<span class="normal">7432</span>
<span class="normal">7433</span>
<span class="normal">7434</span>
<span class="normal">7435</span>
<span class="normal">7436</span>
<span class="normal">7437</span>
<span class="normal">7438</span>
<span class="normal">7439</span>
<span class="normal">7440</span>
<span class="normal">7441</span>
<span class="normal">7442</span>
<span class="normal">7443</span>
<span class="normal">7444</span>
<span class="normal">7445</span>
<span class="normal">7446</span>
<span class="normal">7447</span>
<span class="normal">7448</span>
<span class="normal">7449</span>
<span class="normal">7450</span>
<span class="normal">7451</span>
<span class="normal">7452</span>
<span class="normal">7453</span>
<span class="normal">7454</span>
<span class="normal">7455</span>
<span class="normal">7456</span>
<span class="normal">7457</span>
<span class="normal">7458</span>
<span class="normal">7459</span>
<span class="normal">7460</span>
<span class="normal">7461</span>
<span class="normal">7462</span>
<span class="normal">7463</span>
<span class="normal">7464</span>
<span class="normal">7465</span>
<span class="normal">7466</span>
<span class="normal">7467</span>
<span class="normal">7468</span>
<span class="normal">7469</span>
<span class="normal">7470</span>
<span class="normal">7471</span>
<span class="normal">7472</span>
<span class="normal">7473</span>
<span class="normal">7474</span>
<span class="normal">7475</span>
<span class="normal">7476</span>
<span class="normal">7477</span>
<span class="normal">7478</span>
<span class="normal">7479</span>
<span class="normal">7480</span>
<span class="normal">7481</span>
<span class="normal">7482</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bbox_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">coord_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a list of coordinates to pixel coordinates, i.e., (col, row) coordinates.</span>
<span class="sd">        Note that map bbox coords is [minx, miny, maxx, maxy] from bottomleft to topright</span>
<span class="sd">        While rasterio bbox coords is [minx, max, maxx, min] from topleft to bottomright</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp (str): The source raster file path.</span>
<span class="sd">        coords (list): A list of coordinates in the format of [[minx, miny, maxx, maxy], [minx, miny, maxx, maxy], ...]</span>
<span class="sd">        coord_crs (str, optional): The coordinate CRS of the input coordinates. Defaults to &quot;epsg:4326&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of pixel coordinates in the format of [[minx, maxy, maxx, miny], ...] from top left to bottom right.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coord_crs</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epsg:</span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

        <span class="n">geojson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coords must be a list of coordinates.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">coords</span><span class="p">]</span>

    <span class="n">new_coords</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>

        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">coord</span>

            <span class="k">if</span> <span class="n">coord_crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="n">rows1</span><span class="p">,</span> <span class="n">cols1</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="n">rows2</span><span class="p">,</span> <span class="n">cols2</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

                <span class="n">new_coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cols1</span><span class="p">,</span> <span class="n">rows1</span><span class="p">,</span> <span class="n">cols2</span><span class="p">,</span> <span class="n">rows2</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">new_coords</span><span class="p">:</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">coord</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">minx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">miny</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">maxx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">maxy</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">minx</span> <span class="o">&lt;</span> <span class="n">width</span>
            <span class="ow">and</span> <span class="n">miny</span> <span class="o">&lt;</span> <span class="n">height</span>
            <span class="ow">and</span> <span class="n">maxx</span> <span class="o">&lt;</span> <span class="n">width</span>
            <span class="ow">and</span> <span class="n">maxy</span> <span class="o">&lt;</span> <span class="n">height</span>
        <span class="p">):</span>
            <span class="c1"># Note that map bbox coords is [minx, miny, maxx, maxy] from bottomleft to topright</span>
            <span class="c1"># While rasterio bbox coords is [minx, max, maxx, min] from topleft to bottomright</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">miny</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pixel coordinates found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some coordinates are out of the image boundary.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.boxes_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">boxes_to_vector</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.boxes_to_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a list of bounding box coordinates to vector data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of bounding box coordinates in the format [[left, top, right, bottom], [left, top, right, bottom], ...].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>src_crs</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The EPSG code or proj4 string representing the source coordinate reference system (CRS) of the input coordinates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dst_crs</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The EPSG code or proj4 string representing the destination CRS to reproject the data (default is "EPSG:4326").</p>
              </div>
            </td>
            <td>
                  <code>&#39;EPSG:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The full file path (including the directory and filename without the extension) where the vector data should be saved.
                           If None (default), the function returns the GeoDataFrame without saving it to a file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to geopandas.GeoDataFrame.to_file() when saving the vector data.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame or None: The GeoDataFrame with the converted vector data if output is None, otherwise None if the data is saved to a file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7299</span>
<span class="normal">7300</span>
<span class="normal">7301</span>
<span class="normal">7302</span>
<span class="normal">7303</span>
<span class="normal">7304</span>
<span class="normal">7305</span>
<span class="normal">7306</span>
<span class="normal">7307</span>
<span class="normal">7308</span>
<span class="normal">7309</span>
<span class="normal">7310</span>
<span class="normal">7311</span>
<span class="normal">7312</span>
<span class="normal">7313</span>
<span class="normal">7314</span>
<span class="normal">7315</span>
<span class="normal">7316</span>
<span class="normal">7317</span>
<span class="normal">7318</span>
<span class="normal">7319</span>
<span class="normal">7320</span>
<span class="normal">7321</span>
<span class="normal">7322</span>
<span class="normal">7323</span>
<span class="normal">7324</span>
<span class="normal">7325</span>
<span class="normal">7326</span>
<span class="normal">7327</span>
<span class="normal">7328</span>
<span class="normal">7329</span>
<span class="normal">7330</span>
<span class="normal">7331</span>
<span class="normal">7332</span>
<span class="normal">7333</span>
<span class="normal">7334</span>
<span class="normal">7335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">boxes_to_vector</span><span class="p">(</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">src_crs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dst_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of bounding box coordinates to vector data.</span>

<span class="sd">    Args:</span>
<span class="sd">        coords (list): A list of bounding box coordinates in the format [[left, top, right, bottom], [left, top, right, bottom], ...].</span>
<span class="sd">        src_crs (int or str): The EPSG code or proj4 string representing the source coordinate reference system (CRS) of the input coordinates.</span>
<span class="sd">        dst_crs (int or str, optional): The EPSG code or proj4 string representing the destination CRS to reproject the data (default is &quot;EPSG:4326&quot;).</span>
<span class="sd">        output (str or None, optional): The full file path (including the directory and filename without the extension) where the vector data should be saved.</span>
<span class="sd">                                       If None (default), the function returns the GeoDataFrame without saving it to a file.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to geopandas.GeoDataFrame.to_file() when saving the vector data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame or None: The GeoDataFrame with the converted vector data if output is None, otherwise None if the data is saved to a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>

    <span class="c1"># Create a list of Shapely Polygon objects based on the provided coordinates</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>

    <span class="c1"># Create a GeoDataFrame with the Shapely Polygon objects</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">polygons</span><span class="p">},</span> <span class="n">crs</span><span class="o">=</span><span class="n">src_crs</span><span class="p">)</span>

    <span class="c1"># Reproject the GeoDataFrame to the specified EPSG code</span>
    <span class="n">gdf_reprojected</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">dst_crs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gdf_reprojected</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdf_reprojected</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.calc_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_stats</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.utils.calc_stats" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate the statistics (mean and std) for the entire dataset.</p>
<p>This function is adapted from the plot_batch() function in the torchgeo library at
https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html.
Credit to the torchgeo developers for the original implementation.</p>
<p>Warning: This is an approximation. The correct value should take into account the
mean for the whole dataset for computing individual stds.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
                  <code><span title="RasterDataset">RasterDataset</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to calculate statistics for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>divide_by</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to divide the image data by. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[np.ndarray, np.ndarray]: The mean and standard deviation for each band.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_stats</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">divide_by</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the statistics (mean and std) for the entire dataset.</span>

<span class="sd">    This function is adapted from the plot_batch() function in the torchgeo library at</span>
<span class="sd">    https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html.</span>
<span class="sd">    Credit to the torchgeo developers for the original implementation.</span>

<span class="sd">    Warning: This is an approximation. The correct value should take into account the</span>
<span class="sd">    mean for the whole dataset for computing individual stds.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset (RasterDataset): The dataset to calculate statistics for.</span>
<span class="sd">        divide_by (float, optional): The value to divide the image data by. Defaults to 1.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray]: The mean and standard deviation for each band.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># To avoid loading the entire dataset in memory, we will loop through each img</span>
    <span class="c1"># The filenames will be retrieved from the dataset&#39;s rtree index</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">item</span><span class="o">.</span><span class="n">object</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Resetting statistics</span>
    <span class="n">accum_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">accum_std</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">/</span> <span class="n">divide_by</span>  <span class="c1"># type: ignore</span>
        <span class="n">accum_mean</span> <span class="o">+=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">accum_std</span> <span class="o">+=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># at the end, we shall have 2 vectors with length n=chnls</span>
    <span class="c1"># we will average them considering the number of images</span>
    <span class="k">return</span> <span class="n">accum_mean</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">accum_std</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.clip_raster_by_bbox" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="n">input_raster</span><span class="p">,</span> <span class="n">output_raster</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bbox_type</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="n">bbox_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.clip_raster_by_bbox" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Clip a raster dataset using a bounding box and optionally select specific bands.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input raster file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the clipped raster will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box coordinates either as:
         - Geographic coordinates (minx, miny, maxx, maxy) if bbox_type="geo"
         - Pixel indices (min_row, min_col, max_row, max_col) if bbox_type="pixel"</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bands</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices to keep (1-based indexing).
                   If None, all bands will be kept.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of bounding box coordinates. Either "geo" for
                      geographic coordinates or "pixel" for row/column indices.
                      Default is "geo".</p>
              </div>
            </td>
            <td>
                  <code>&#39;geo&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CRS of the bbox if different from the raster CRS.
                             Can be provided as EPSG code (e.g., "EPSG:4326") or
                             as a proj4 string. Only applies when bbox_type="geo".
                             If None, assumes bbox is in the same CRS as the raster.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the clipped output raster.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required dependencies are not installed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the bbox is invalid, bands are out of range, or bbox_type is invalid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the clipping operation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Clip using geographic coordinates in the same CRS as the raster</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_geo.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="go">&#39;clipped_geo.tif&#39;</span>
</code></pre></div></td></tr></table></div>
    <p>Clip using WGS84 coordinates when the raster is in a different CRS</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_wgs84.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">122.5</span><span class="p">,</span> <span class="mf">37.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.4</span><span class="p">,</span> <span class="mf">37.8</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">bbox_crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="go">&#39;clipped_wgs84.tif&#39;</span>
</code></pre></div></td></tr></table></div>
    <p>Clip using row/column indices</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_pixel.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">bbox_type</span><span class="o">=</span><span class="s2">&quot;pixel&quot;</span><span class="p">)</span>
<span class="go">&#39;clipped_pixel.tif&#39;</span>
</code></pre></div></td></tr></table></div>
    <p>Clip with band selection</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">clip_raster_by_bbox</span><span class="p">(</span><span class="s1">&#39;input.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;clipped_bands.tif&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="go">&#39;clipped_bands.tif&#39;</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clip_raster_by_bbox</span><span class="p">(</span>
    <span class="n">input_raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bbox_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geo&quot;</span><span class="p">,</span>
    <span class="n">bbox_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip a raster dataset using a bounding box and optionally select specific bands.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_raster (str): Path to the input raster file.</span>
<span class="sd">        output_raster (str): Path where the clipped raster will be saved.</span>
<span class="sd">        bbox (tuple): Bounding box coordinates either as:</span>
<span class="sd">                     - Geographic coordinates (minx, miny, maxx, maxy) if bbox_type=&quot;geo&quot;</span>
<span class="sd">                     - Pixel indices (min_row, min_col, max_row, max_col) if bbox_type=&quot;pixel&quot;</span>
<span class="sd">        bands (list, optional): List of band indices to keep (1-based indexing).</span>
<span class="sd">                               If None, all bands will be kept.</span>
<span class="sd">        bbox_type (str, optional): Type of bounding box coordinates. Either &quot;geo&quot; for</span>
<span class="sd">                                  geographic coordinates or &quot;pixel&quot; for row/column indices.</span>
<span class="sd">                                  Default is &quot;geo&quot;.</span>
<span class="sd">        bbox_crs (str or dict, optional): CRS of the bbox if different from the raster CRS.</span>
<span class="sd">                                         Can be provided as EPSG code (e.g., &quot;EPSG:4326&quot;) or</span>
<span class="sd">                                         as a proj4 string. Only applies when bbox_type=&quot;geo&quot;.</span>
<span class="sd">                                         If None, assumes bbox is in the same CRS as the raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the clipped output raster.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If required dependencies are not installed.</span>
<span class="sd">        ValueError: If the bbox is invalid, bands are out of range, or bbox_type is invalid.</span>
<span class="sd">        RuntimeError: If the clipping operation fails.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Clip using geographic coordinates in the same CRS as the raster</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_geo.tif&#39;, (100, 200, 300, 400))</span>
<span class="sd">        &#39;clipped_geo.tif&#39;</span>

<span class="sd">        Clip using WGS84 coordinates when the raster is in a different CRS</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_wgs84.tif&#39;, (-122.5, 37.7, -122.4, 37.8),</span>
<span class="sd">        ...                     bbox_crs=&quot;EPSG:4326&quot;)</span>
<span class="sd">        &#39;clipped_wgs84.tif&#39;</span>

<span class="sd">        Clip using row/column indices</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_pixel.tif&#39;, (50, 100, 150, 200),</span>
<span class="sd">        ...                     bbox_type=&quot;pixel&quot;)</span>
<span class="sd">        &#39;clipped_pixel.tif&#39;</span>

<span class="sd">        Clip with band selection</span>
<span class="sd">        &gt;&gt;&gt; clip_raster_by_bbox(&#39;input.tif&#39;, &#39;clipped_bands.tif&#39;, (100, 200, 300, 400),</span>
<span class="sd">        ...                     bands=[1, 3])</span>
<span class="sd">        &#39;clipped_bands.tif&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_bounds</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform_bounds</span>

    <span class="c1"># Validate bbox_type</span>
    <span class="k">if</span> <span class="n">bbox_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;geo&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bbox_type must be either &#39;geo&#39; or &#39;pixel&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Validate bbox</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bbox must contain exactly 4 values&quot;</span><span class="p">)</span>

    <span class="c1"># Open the source raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get the source CRS</span>
        <span class="n">src_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Handle different bbox types</span>
        <span class="k">if</span> <span class="n">bbox_type</span> <span class="o">==</span> <span class="s2">&quot;geo&quot;</span><span class="p">:</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span>

            <span class="c1"># Validate geographic bbox</span>
            <span class="k">if</span> <span class="n">minx</span> <span class="o">&gt;=</span> <span class="n">maxx</span> <span class="ow">or</span> <span class="n">miny</span> <span class="o">&gt;=</span> <span class="n">maxy</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid geographic bbox. Expected (minx, miny, maxx, maxy) where minx &lt; maxx and miny &lt; maxy&quot;</span>
                <span class="p">)</span>

            <span class="c1"># If bbox_crs is provided and different from the source CRS, transform the bbox</span>
            <span class="k">if</span> <span class="n">bbox_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bbox_crs</span> <span class="o">!=</span> <span class="n">src_crs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Transform bbox coordinates from bbox_crs to src_crs</span>
                    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">transform_bounds</span><span class="p">(</span>
                        <span class="n">bbox_crs</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to transform bbox from </span><span class="si">{</span><span class="n">bbox_crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">src_crs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Calculate the pixel window from geographic coordinates</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

            <span class="c1"># Use the same bounds for the output transform</span>
            <span class="n">output_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># bbox_type == &quot;pixel&quot;</span>
            <span class="n">min_row</span><span class="p">,</span> <span class="n">min_col</span><span class="p">,</span> <span class="n">max_row</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">=</span> <span class="n">bbox</span>

            <span class="c1"># Validate pixel bbox</span>
            <span class="k">if</span> <span class="n">min_row</span> <span class="o">&gt;=</span> <span class="n">max_row</span> <span class="ow">or</span> <span class="n">min_col</span> <span class="o">&gt;=</span> <span class="n">max_col</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid pixel bbox. Expected (min_row, min_col, max_row, max_col) where min_row &lt; max_row and min_col &lt; max_col&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">min_row</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">min_col</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">max_row</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
                <span class="ow">or</span> <span class="n">max_col</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Pixel indices out of bounds. Raster dimensions are </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> rows x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> columns&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create a window from pixel coordinates</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">min_col</span><span class="p">,</span> <span class="n">min_row</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">-</span> <span class="n">min_col</span><span class="p">,</span> <span class="n">max_row</span> <span class="o">-</span> <span class="n">min_row</span><span class="p">)</span>

            <span class="c1"># Calculate the geographic bounds for this window</span>
            <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">output_bounds</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">array_bounds</span><span class="p">(</span>
                <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">window_transform</span>
            <span class="p">)</span>
            <span class="c1"># Reorder to (minx, miny, maxx, maxy)</span>
            <span class="n">output_bounds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">output_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Get window dimensions</span>
        <span class="n">window_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">window_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

        <span class="c1"># Check if the window is valid</span>
        <span class="k">if</span> <span class="n">window_width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">window_height</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bounding box results in an empty window&quot;</span><span class="p">)</span>

        <span class="c1"># Handle band selection</span>
        <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use all bands</span>
            <span class="n">bands_to_read</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate band indices</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band indices must be between 1 and </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">bands_to_read</span> <span class="o">=</span> <span class="n">bands</span>

        <span class="c1"># Calculate new transform for the clipped raster</span>
        <span class="n">new_transform</span> <span class="o">=</span> <span class="n">from_bounds</span><span class="p">(</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">output_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">window_width</span><span class="p">,</span>
            <span class="n">window_height</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create a metadata dictionary for the output</span>
        <span class="n">out_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">window_height</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">window_width</span><span class="p">,</span>
                <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">new_transform</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands_to_read</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Read the data for the selected bands</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">band_idx</span> <span class="ow">in</span> <span class="n">bands_to_read</span><span class="p">:</span>
            <span class="n">band_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band_idx</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_data</span><span class="p">)</span>

        <span class="c1"># Stack the bands into a single array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">clipped_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clipped_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># Write the output raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clipped_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_raster</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.coords_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coords_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">coord_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.coords_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a list or array of coordinates to pixel coordinates, i.e., (col, row) coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2D or 3D array of coordinates. Can be of shape [[x1, y1], [x2, y2], ...]
    or [[[x1, y1]], [[x2, y2]], ...].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coord_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coordinate CRS of the input coordinates. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_out_of_bounds</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return out-of-bounds coordinates. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rasterio.transform.rowcol.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2D or 3D array of pixel coordinates in the same format as the input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7227</span>
<span class="normal">7228</span>
<span class="normal">7229</span>
<span class="normal">7230</span>
<span class="normal">7231</span>
<span class="normal">7232</span>
<span class="normal">7233</span>
<span class="normal">7234</span>
<span class="normal">7235</span>
<span class="normal">7236</span>
<span class="normal">7237</span>
<span class="normal">7238</span>
<span class="normal">7239</span>
<span class="normal">7240</span>
<span class="normal">7241</span>
<span class="normal">7242</span>
<span class="normal">7243</span>
<span class="normal">7244</span>
<span class="normal">7245</span>
<span class="normal">7246</span>
<span class="normal">7247</span>
<span class="normal">7248</span>
<span class="normal">7249</span>
<span class="normal">7250</span>
<span class="normal">7251</span>
<span class="normal">7252</span>
<span class="normal">7253</span>
<span class="normal">7254</span>
<span class="normal">7255</span>
<span class="normal">7256</span>
<span class="normal">7257</span>
<span class="normal">7258</span>
<span class="normal">7259</span>
<span class="normal">7260</span>
<span class="normal">7261</span>
<span class="normal">7262</span>
<span class="normal">7263</span>
<span class="normal">7264</span>
<span class="normal">7265</span>
<span class="normal">7266</span>
<span class="normal">7267</span>
<span class="normal">7268</span>
<span class="normal">7269</span>
<span class="normal">7270</span>
<span class="normal">7271</span>
<span class="normal">7272</span>
<span class="normal">7273</span>
<span class="normal">7274</span>
<span class="normal">7275</span>
<span class="normal">7276</span>
<span class="normal">7277</span>
<span class="normal">7278</span>
<span class="normal">7279</span>
<span class="normal">7280</span>
<span class="normal">7281</span>
<span class="normal">7282</span>
<span class="normal">7283</span>
<span class="normal">7284</span>
<span class="normal">7285</span>
<span class="normal">7286</span>
<span class="normal">7287</span>
<span class="normal">7288</span>
<span class="normal">7289</span>
<span class="normal">7290</span>
<span class="normal">7291</span>
<span class="normal">7292</span>
<span class="normal">7293</span>
<span class="normal">7294</span>
<span class="normal">7295</span>
<span class="normal">7296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">coords_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">coord_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span>
    <span class="n">return_out_of_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a list or array of coordinates to pixel coordinates, i.e., (col, row) coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp: The source raster file path.</span>
<span class="sd">        coords: A 2D or 3D array of coordinates. Can be of shape [[x1, y1], [x2, y2], ...]</span>
<span class="sd">                or [[[x1, y1]], [[x2, y2]], ...].</span>
<span class="sd">        coord_crs: The coordinate CRS of the input coordinates. Defaults to &quot;epsg:4326&quot;.</span>
<span class="sd">        return_out_of_bounds: Whether to return out-of-bounds coordinates. Defaults to False.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rasterio.transform.rowcol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A 2D or 3D array of pixel coordinates in the same format as the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform</span> <span class="k">as</span> <span class="n">transform_coords</span>

    <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">input_is_3d</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Check if the input is a 3D array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">input_is_3d</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Flatten the 3D array to 2D if necessary</span>
    <span class="k">if</span> <span class="n">input_is_3d</span><span class="p">:</span>
        <span class="n">original_shape</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Store the original shape</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Flatten to 2D</span>

    <span class="c1"># Convert ndarray to a list if necessary</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="k">if</span> <span class="n">coord_crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">coord_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">)]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_of_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Convert the output back to the original shape if input was 3D</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_is_3d</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>

    <span class="c1"># Handle cases where no valid pixel coordinates are found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pixel coordinates found.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some coordinates are out of the image boundary.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_out_of_bounds</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">out_of_bounds</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.create_overview_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_overview_image</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">geojson_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.create_overview_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create an overview image showing all tiles and their status, with optional GeoJSON export.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src</code>
            </td>
            <td>
                  <code><span title="rasterio.io.DatasetReader">DatasetReader</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_coordinates</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries containing tile information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path where the overview image will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of each tile in pixels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stride between tiles in pixels. Controls overlap between adjacent tiles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>geojson_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, exports the tile rectangles as GeoJSON to this path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved overview image.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span>
<span class="normal">3637</span>
<span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span>
<span class="normal">3660</span>
<span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span>
<span class="normal">3669</span>
<span class="normal">3670</span>
<span class="normal">3671</span>
<span class="normal">3672</span>
<span class="normal">3673</span>
<span class="normal">3674</span>
<span class="normal">3675</span>
<span class="normal">3676</span>
<span class="normal">3677</span>
<span class="normal">3678</span>
<span class="normal">3679</span>
<span class="normal">3680</span>
<span class="normal">3681</span>
<span class="normal">3682</span>
<span class="normal">3683</span>
<span class="normal">3684</span>
<span class="normal">3685</span>
<span class="normal">3686</span>
<span class="normal">3687</span>
<span class="normal">3688</span>
<span class="normal">3689</span>
<span class="normal">3690</span>
<span class="normal">3691</span>
<span class="normal">3692</span>
<span class="normal">3693</span>
<span class="normal">3694</span>
<span class="normal">3695</span>
<span class="normal">3696</span>
<span class="normal">3697</span>
<span class="normal">3698</span>
<span class="normal">3699</span>
<span class="normal">3700</span>
<span class="normal">3701</span>
<span class="normal">3702</span>
<span class="normal">3703</span>
<span class="normal">3704</span>
<span class="normal">3705</span>
<span class="normal">3706</span>
<span class="normal">3707</span>
<span class="normal">3708</span>
<span class="normal">3709</span>
<span class="normal">3710</span>
<span class="normal">3711</span>
<span class="normal">3712</span>
<span class="normal">3713</span>
<span class="normal">3714</span>
<span class="normal">3715</span>
<span class="normal">3716</span>
<span class="normal">3717</span>
<span class="normal">3718</span>
<span class="normal">3719</span>
<span class="normal">3720</span>
<span class="normal">3721</span>
<span class="normal">3722</span>
<span class="normal">3723</span>
<span class="normal">3724</span>
<span class="normal">3725</span>
<span class="normal">3726</span>
<span class="normal">3727</span>
<span class="normal">3728</span>
<span class="normal">3729</span>
<span class="normal">3730</span>
<span class="normal">3731</span>
<span class="normal">3732</span>
<span class="normal">3733</span>
<span class="normal">3734</span>
<span class="normal">3735</span>
<span class="normal">3736</span>
<span class="normal">3737</span>
<span class="normal">3738</span>
<span class="normal">3739</span>
<span class="normal">3740</span>
<span class="normal">3741</span>
<span class="normal">3742</span>
<span class="normal">3743</span>
<span class="normal">3744</span>
<span class="normal">3745</span>
<span class="normal">3746</span>
<span class="normal">3747</span>
<span class="normal">3748</span>
<span class="normal">3749</span>
<span class="normal">3750</span>
<span class="normal">3751</span>
<span class="normal">3752</span>
<span class="normal">3753</span>
<span class="normal">3754</span>
<span class="normal">3755</span>
<span class="normal">3756</span>
<span class="normal">3757</span>
<span class="normal">3758</span>
<span class="normal">3759</span>
<span class="normal">3760</span>
<span class="normal">3761</span>
<span class="normal">3762</span>
<span class="normal">3763</span>
<span class="normal">3764</span>
<span class="normal">3765</span>
<span class="normal">3766</span>
<span class="normal">3767</span>
<span class="normal">3768</span>
<span class="normal">3769</span>
<span class="normal">3770</span>
<span class="normal">3771</span>
<span class="normal">3772</span>
<span class="normal">3773</span>
<span class="normal">3774</span>
<span class="normal">3775</span>
<span class="normal">3776</span>
<span class="normal">3777</span>
<span class="normal">3778</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_overview_image</span><span class="p">(</span>
    <span class="n">src</span><span class="p">,</span> <span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">geojson_path</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an overview image showing all tiles and their status, with optional GeoJSON export.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (rasterio.io.DatasetReader): The source raster dataset.</span>
<span class="sd">        tile_coordinates (list): A list of dictionaries containing tile information.</span>
<span class="sd">        output_path (str): The path where the overview image will be saved.</span>
<span class="sd">        tile_size (int): The size of each tile in pixels.</span>
<span class="sd">        stride (int): The stride between tiles in pixels. Controls overlap between adjacent tiles.</span>
<span class="sd">        geojson_path (str, optional): If provided, exports the tile rectangles as GeoJSON to this path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved overview image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read a reduced version of the source image</span>
    <span class="n">overview_scale</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># Scale to max ~2000px</span>
    <span class="n">overview_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="n">overview_scale</span>
    <span class="n">overview_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="n">overview_scale</span>

    <span class="c1"># Read downsampled image</span>
    <span class="n">overview_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">overview_height</span><span class="p">,</span> <span class="n">overview_width</span><span class="p">),</span>
        <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">average</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create RGB image for display</span>
    <span class="k">if</span> <span class="n">overview_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">overview_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For single band, create grayscale RGB</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">overview_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">overview_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">overview_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Normalize for display</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">non_zero</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="n">band</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p2</span><span class="p">,</span> <span class="n">p98</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">))</span>
            <span class="n">rgb</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">band</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p98</span> <span class="o">-</span> <span class="n">p2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>

    <span class="c1"># If GeoJSON export is requested, prepare GeoJSON structures</span>
    <span class="k">if</span> <span class="n">geojson_path</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Draw tile boundaries</span>
    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tile_coordinates</span><span class="p">:</span>
        <span class="c1"># Convert bounds to pixel coordinates in overview</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="c1"># Calculate scaled pixel coordinates</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_size</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_size</span> <span class="o">/</span> <span class="n">overview_scale</span><span class="p">)</span>

        <span class="c1"># Draw rectangle</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lime&quot;</span> <span class="k">if</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;has_features&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

        <span class="c1"># Add tile number if not too crowded</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x_min</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">y_min</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Add to GeoJSON features if exporting</span>
        <span class="k">if</span> <span class="n">geojson_path</span><span class="p">:</span>
            <span class="c1"># Create a polygon from the bounds (already in geo-coordinates)</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

            <span class="c1"># Calculate overlap with neighboring tiles</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">stride</span> <span class="o">&lt;</span> <span class="n">tile_size</span><span class="p">:</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="n">tile_size</span> <span class="o">-</span> <span class="n">stride</span>

            <span class="c1"># Create a GeoJSON feature</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">polygon</span><span class="p">),</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;has_features&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;has_features&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;bounds_pixel&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;tile_size_px&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                    <span class="s2">&quot;stride_px&quot;</span><span class="p">:</span> <span class="n">stride</span><span class="p">,</span>
                    <span class="s2">&quot;overlap_px&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># Add any additional properties from the tile</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tile</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;has_features&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">]:</span>
                    <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tile Overview (Green = Contains Features, Red = Empty)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overview image saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Export GeoJSON if requested</span>
    <span class="k">if</span> <span class="n">geojson_path</span><span class="p">:</span>
        <span class="n">geojson_collection</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s2">&quot;to_string&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
                <span class="s2">&quot;source_raster_dimensions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Save to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">geojson_collection</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GeoJSON saved to </span><span class="si">{</span><span class="n">geojson_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.create_split_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_split_map</span><span class="p">(</span><span class="n">left_layer</span><span class="o">=</span><span class="s1">&#39;TERRAIN&#39;</span><span class="p">,</span> <span class="n">right_layer</span><span class="o">=</span><span class="s1">&#39;OpenTopoMap&#39;</span><span class="p">,</span> <span class="n">left_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_array_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_array_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fullscreen_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_close_button</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_position</span><span class="o">=</span><span class="s1">&#39;bottomleft&#39;</span><span class="p">,</span> <span class="n">right_position</span><span class="o">=</span><span class="s1">&#39;bottomright&#39;</span><span class="p">,</span> <span class="n">widget_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draggable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;600px&#39;</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basemap_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.create_split_map" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Adds split map.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left_layer</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The left tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to 'TERRAIN'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;TERRAIN&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_layer</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The right tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to 'OpenTopoMap'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;OpenTopoMap&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for the left tile layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for the right tile layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_array_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for array_to_image for the left layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_array_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments for array_to_image for the right layer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zoom_control</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add zoom control. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fullscreen_control</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add fullscreen control. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_control</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add layer control. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_close_button</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a close button. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label for the left layer. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label for the right layer. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position for the left label. Defaults to "bottomleft".</p>
              </div>
            </td>
            <td>
                  <code>&#39;bottomleft&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position for the right label. Defaults to "bottomright".</p>
              </div>
            </td>
            <td>
                  <code>&#39;bottomright&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>widget_layout</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The layout for the widget. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>draggable</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the split map is draggable. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_split_map</span><span class="p">(</span>
    <span class="n">left_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TERRAIN&quot;</span><span class="p">,</span>
    <span class="n">right_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OpenTopoMap&quot;</span><span class="p">,</span>
    <span class="n">left_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">left_array_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right_array_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">fullscreen_control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">layer_control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_close_button</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">left_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">left_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bottomleft&quot;</span><span class="p">,</span>
    <span class="n">right_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bottomright&quot;</span><span class="p">,</span>
    <span class="n">widget_layout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">draggable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">center</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">zoom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;600px&quot;</span><span class="p">,</span>
    <span class="n">basemap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">basemap_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds split map.</span>

<span class="sd">    Args:</span>
<span class="sd">        left_layer (str, optional): The left tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to &#39;TERRAIN&#39;.</span>
<span class="sd">        right_layer (str, optional): The right tile layer. Can be a local file path, HTTP URL, or a basemap name. Defaults to &#39;OpenTopoMap&#39;.</span>
<span class="sd">        left_args (dict, optional): The arguments for the left tile layer. Defaults to {}.</span>
<span class="sd">        right_args (dict, optional): The arguments for the right tile layer. Defaults to {}.</span>
<span class="sd">        left_array_args (dict, optional): The arguments for array_to_image for the left layer. Defaults to {}.</span>
<span class="sd">        right_array_args (dict, optional): The arguments for array_to_image for the right layer. Defaults to {}.</span>
<span class="sd">        zoom_control (bool, optional): Whether to add zoom control. Defaults to True.</span>
<span class="sd">        fullscreen_control (bool, optional): Whether to add fullscreen control. Defaults to True.</span>
<span class="sd">        layer_control (bool, optional): Whether to add layer control. Defaults to True.</span>
<span class="sd">        add_close_button (bool, optional): Whether to add a close button. Defaults to False.</span>
<span class="sd">        left_label (str, optional): The label for the left layer. Defaults to None.</span>
<span class="sd">        right_label (str, optional): The label for the right layer. Defaults to None.</span>
<span class="sd">        left_position (str, optional): The position for the left label. Defaults to &quot;bottomleft&quot;.</span>
<span class="sd">        right_position (str, optional): The position for the right label. Defaults to &quot;bottomright&quot;.</span>
<span class="sd">        widget_layout (dict, optional): The layout for the widget. Defaults to None.</span>
<span class="sd">        draggable (bool, optional): Whether the split map is draggable. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">left_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">right_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">right_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">left_array_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_array_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">right_array_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">right_array_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">basemap_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basemap_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">clear_layers</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_cog_layer</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Basemap&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;Basemap&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">basemap</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">split_map</span><span class="p">(</span>
        <span class="n">left_layer</span><span class="o">=</span><span class="n">left_layer</span><span class="p">,</span>
        <span class="n">right_layer</span><span class="o">=</span><span class="n">right_layer</span><span class="p">,</span>
        <span class="n">left_args</span><span class="o">=</span><span class="n">left_args</span><span class="p">,</span>
        <span class="n">right_args</span><span class="o">=</span><span class="n">right_args</span><span class="p">,</span>
        <span class="n">left_array_args</span><span class="o">=</span><span class="n">left_array_args</span><span class="p">,</span>
        <span class="n">right_array_args</span><span class="o">=</span><span class="n">right_array_args</span><span class="p">,</span>
        <span class="n">zoom_control</span><span class="o">=</span><span class="n">zoom_control</span><span class="p">,</span>
        <span class="n">fullscreen_control</span><span class="o">=</span><span class="n">fullscreen_control</span><span class="p">,</span>
        <span class="n">layer_control</span><span class="o">=</span><span class="n">layer_control</span><span class="p">,</span>
        <span class="n">add_close_button</span><span class="o">=</span><span class="n">add_close_button</span><span class="p">,</span>
        <span class="n">left_label</span><span class="o">=</span><span class="n">left_label</span><span class="p">,</span>
        <span class="n">right_label</span><span class="o">=</span><span class="n">right_label</span><span class="p">,</span>
        <span class="n">left_position</span><span class="o">=</span><span class="n">left_position</span><span class="p">,</span>
        <span class="n">right_position</span><span class="o">=</span><span class="n">right_position</span><span class="p">,</span>
        <span class="n">widget_layout</span><span class="o">=</span><span class="n">widget_layout</span><span class="p">,</span>
        <span class="n">draggable</span><span class="o">=</span><span class="n">draggable</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.dict_to_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dict_to_image</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.dict_to_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a dictionary containing spatial data to a rasterio dataset or save it to
a file. The dictionary should contain the following keys: "crs", "bounds", and "image".
It can be generated from a TorchGeo dataset sampler.</p>
<p>This function transforms a dictionary with CRS, bounding box, and image data
into a rasterio DatasetReader using leafmap's array_to_image utility after
first converting to a rioxarray DataArray.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing:
- 'crs': A pyproj CRS object
- 'bounds': A BoundingBox object with minx, maxx, miny, maxy attributes
  and optionally mint, maxt for temporal bounds
- 'image': A tensor or array-like object with image data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to save the image to a file. If not provided, the image
will be returned as a rasterio DatasetReader object.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to leafmap.array_to_image.
Common options include:
- colormap: str, name of the colormap (e.g., 'viridis', 'terrain')
- vmin: float, minimum value for colormap scaling
- vmax: float, maximum value for colormap scaling</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A rasterio DatasetReader object that can be used for visualization or</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>further processing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">image</span> <span class="o">=</span> <span class="n">dict_to_image</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="mi">26911</span><span class="p">),</span> <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dict_to_image</span><span class="p">(</span>
    <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dictionary containing spatial data to a rasterio dataset or save it to</span>
<span class="sd">    a file. The dictionary should contain the following keys: &quot;crs&quot;, &quot;bounds&quot;, and &quot;image&quot;.</span>
<span class="sd">    It can be generated from a TorchGeo dataset sampler.</span>

<span class="sd">    This function transforms a dictionary with CRS, bounding box, and image data</span>
<span class="sd">    into a rasterio DatasetReader using leafmap&#39;s array_to_image utility after</span>
<span class="sd">    first converting to a rioxarray DataArray.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict: A dictionary containing:</span>
<span class="sd">            - &#39;crs&#39;: A pyproj CRS object</span>
<span class="sd">            - &#39;bounds&#39;: A BoundingBox object with minx, maxx, miny, maxy attributes</span>
<span class="sd">              and optionally mint, maxt for temporal bounds</span>
<span class="sd">            - &#39;image&#39;: A tensor or array-like object with image data</span>
<span class="sd">        output: Optional path to save the image to a file. If not provided, the image</span>
<span class="sd">            will be returned as a rasterio DatasetReader object.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to leafmap.array_to_image.</span>
<span class="sd">            Common options include:</span>
<span class="sd">            - colormap: str, name of the colormap (e.g., &#39;viridis&#39;, &#39;terrain&#39;)</span>
<span class="sd">            - vmin: float, minimum value for colormap scaling</span>
<span class="sd">            - vmax: float, maximum value for colormap scaling</span>

<span class="sd">    Returns:</span>
<span class="sd">        A rasterio DatasetReader object that can be used for visualization or</span>
<span class="sd">        further processing.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; image = dict_to_image(</span>
<span class="sd">        ...     {&#39;crs&#39;: CRS.from_epsg(26911), &#39;bounds&#39;: bbox, &#39;image&#39;: tensor},</span>
<span class="sd">        ...     colormap=&#39;terrain&#39;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; fig, ax = plt.subplots(figsize=(10, 10))</span>
<span class="sd">        &gt;&gt;&gt; show(image, ax=ax)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">dict_to_rioxarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.dict_to_rioxarray" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dict_to_rioxarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></code>

<a href="#geoai.utils.dict_to_rioxarray" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a dictionary to a xarray DataArray. The dictionary should contain the
following keys: "crs", "bounds", and "image". It can be generated from a TorchGeo
dataset sampler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary containing the data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataArray">DataArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>xr.DataArray: The xarray DataArray.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dict_to_rioxarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dictionary to a xarray DataArray. The dictionary should contain the</span>
<span class="sd">    following keys: &quot;crs&quot;, &quot;bounds&quot;, and &quot;image&quot;. It can be generated from a TorchGeo</span>
<span class="sd">    dataset sampler.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (Dict): The dictionary containing the data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xr.DataArray: The xarray DataArray.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">affine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine</span>

    <span class="n">BoundingBox</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;BoundingBox&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;minx&quot;</span><span class="p">,</span> <span class="s2">&quot;maxx&quot;</span><span class="p">,</span> <span class="s2">&quot;miny&quot;</span><span class="p">,</span> <span class="s2">&quot;maxy&quot;</span><span class="p">])</span>

    <span class="c1"># Extract components from the dictionary</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">):</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>

    <span class="c1"># Convert tensor to numpy array if needed</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
        <span class="c1"># For PyTorch tensors</span>
        <span class="n">image_array</span> <span class="o">=</span> <span class="n">image_tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If it&#39;s already a numpy array or similar</span>
        <span class="n">image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">)</span>

    <span class="c1"># Calculate pixel resolution</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Width is the size of the last dimension</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Height is the size of the middle dimension</span>

    <span class="n">res_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
    <span class="n">res_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>

    <span class="c1"># Create the transform matrix</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span><span class="n">res_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">res_y</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span><span class="p">)</span>

    <span class="c1"># Create dimensions</span>
    <span class="n">x_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">minx</span> <span class="o">+</span> <span class="n">res_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">res_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">res_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">miny</span> <span class="o">+</span> <span class="n">res_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

    <span class="c1"># If time dimension exists in the bounds</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;mint&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;maxt&quot;</span><span class="p">):</span>
        <span class="c1"># Create a single time value or range if needed</span>
        <span class="n">t_coords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">bounds</span><span class="o">.</span><span class="n">mint</span>
        <span class="p">]</span>  <span class="c1"># Or np.linspace(bounds.mint, bounds.maxt, num_time_steps)</span>

        <span class="c1"># Create DataArray with time dimension</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span>
            <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;band&quot;</span><span class="p">:</span>
            <span class="c1"># For multi-band single time</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">image_array</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For multi-time multi-band</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">image_array</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">t_coords</span><span class="p">,</span>
                    <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create DataArray without time dimension</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">image_array</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="c1"># Set spatial attributes</span>
    <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_transform</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">da</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.download_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.utils.download_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Download a file from a given URL with a progress bar.
Optionally unzip the file if it's a ZIP archive.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The URL of the file to download.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path where the downloaded file will be saved.
If not provided, the filename from the URL will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overwrite</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to overwrite the file if it already exists.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unzip</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to unzip the file if it is a ZIP archive.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the downloaded file or the extracted directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unzip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a file from a given URL with a progress bar.</span>
<span class="sd">    Optionally unzip the file if it&#39;s a ZIP archive.</span>

<span class="sd">    Args:</span>
<span class="sd">        url (str): The URL of the file to download.</span>
<span class="sd">        output_path (str, optional): The path where the downloaded file will be saved.</span>
<span class="sd">            If not provided, the filename from the URL will be used.</span>
<span class="sd">        overwrite (bool, optional): Whether to overwrite the file if it already exists.</span>
<span class="sd">        unzip (bool, optional): Whether to unzip the file if it is a ZIP archive.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The path to the downloaded file or the extracted directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File already exists: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Download the file with a progress bar</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">with</span> <span class="p">(</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">,</span>
            <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span>
                <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">progress_bar</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

    <span class="c1"># If the file is a ZIP archive and unzip is True</span>
    <span class="k">if</span> <span class="n">unzip</span> <span class="ow">and</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
                <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted to: </span><span class="si">{</span><span class="n">extract_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">extract_dir</span>

    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.download_model_from_hf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">repo_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.download_model_from_hf" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Download the object detection model from Hugging Face.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the model file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face repository ID.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the downloaded model file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7039</span>
<span class="normal">7040</span>
<span class="normal">7041</span>
<span class="normal">7042</span>
<span class="normal">7043</span>
<span class="normal">7044</span>
<span class="normal">7045</span>
<span class="normal">7046</span>
<span class="normal">7047</span>
<span class="normal">7048</span>
<span class="normal">7049</span>
<span class="normal">7050</span>
<span class="normal">7051</span>
<span class="normal">7052</span>
<span class="normal">7053</span>
<span class="normal">7054</span>
<span class="normal">7055</span>
<span class="normal">7056</span>
<span class="normal">7057</span>
<span class="normal">7058</span>
<span class="normal">7059</span>
<span class="normal">7060</span>
<span class="normal">7061</span>
<span class="normal">7062</span>
<span class="normal">7063</span>
<span class="normal">7064</span>
<span class="normal">7065</span>
<span class="normal">7066</span>
<span class="normal">7067</span>
<span class="normal">7068</span>
<span class="normal">7069</span>
<span class="normal">7070</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">download_model_from_hf</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the object detection model from Hugging Face.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: Path to the model file.</span>
<span class="sd">        repo_id: Hugging Face repository ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the downloaded model file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">hf_hub_download</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Define the repository ID and model filename</span>
        <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Repo is not specified, using default Hugging Face repo_id: giswqs/geoai&quot;</span>
            <span class="p">)</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="s2">&quot;giswqs/geoai&quot;</span>

        <span class="c1"># Download the model</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model downloaded to: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading model from Hugging Face: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify a local model path or ensure internet connectivity.&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.empty_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">empty_cache</span><span class="p">()</span></code>

<a href="#geoai.utils.empty_cache" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Empty the cache of the current device.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7845</span>
<span class="normal">7846</span>
<span class="normal">7847</span>
<span class="normal">7848</span>
<span class="normal">7849</span>
<span class="normal">7850</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">empty_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Empty the cache of the current device.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="p">,</span> <span class="s2">&quot;mps&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.export_geotiff_tiles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_geotiff_tiles</span><span class="p">(</span><span class="n">in_raster</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">in_class_data</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">class_value_field</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_overview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.utils.export_geotiff_tiles" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export georeferenced GeoTIFF tiles and labels from raster and classification data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>in_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster image</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output folder</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_class_data</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to classification data - can be vector file or raster</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles in pixels (square)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Step size between tiles</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field containing class values (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>buffer_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer to add around features (in units of the CRS)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_tiles</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of tiles to process (None for all)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress non-essential output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use all_touched=True in rasterization (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_overview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to create an overview image of all tiles</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_empty_tiles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, skip tiles with no features</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_geotiff_tiles</span><span class="p">(</span>
    <span class="n">in_raster</span><span class="p">,</span>
    <span class="n">out_folder</span><span class="p">,</span>
    <span class="n">in_class_data</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">class_value_field</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">create_overview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export georeferenced GeoTIFF tiles and labels from raster and classification data.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_raster (str): Path to input raster image</span>
<span class="sd">        out_folder (str): Path to output folder</span>
<span class="sd">        in_class_data (str): Path to classification data - can be vector file or raster</span>
<span class="sd">        tile_size (int): Size of tiles in pixels (square)</span>
<span class="sd">        stride (int): Step size between tiles</span>
<span class="sd">        class_value_field (str): Field containing class values (for vector data)</span>
<span class="sd">        buffer_radius (float): Buffer to add around features (in units of the CRS)</span>
<span class="sd">        max_tiles (int): Maximum number of tiles to process (None for all)</span>
<span class="sd">        quiet (bool): If True, suppress non-essential output</span>
<span class="sd">        all_touched (bool): Whether to use all_touched=True in rasterization (for vector data)</span>
<span class="sd">        create_overview (bool): Whether to create an overview image of all tiles</span>
<span class="sd">        skip_empty_tiles (bool): If True, skip tiles with no features</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;rasterio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Create output directories</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Determine if class data is raster or vector</span>
    <span class="n">is_class_data_raster</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">file_ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Common raster extensions</span>
        <span class="k">if</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.bmp&quot;</span><span class="p">,</span> <span class="s2">&quot;.gif&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">is_class_data_raster</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected in_class_data as raster: </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster dimensions: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">is_class_data_raster</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to open </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2"> as raster, trying as vector&quot;</span><span class="p">)</span>

    <span class="c1"># Open the input raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raster info for </span><span class="si">{</span><span class="n">in_raster</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Dimensions: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Resolution: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bands: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bounds: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate number of tiles</span>
        <span class="n">num_tiles_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_tiles_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">num_tiles_x</span> <span class="o">*</span> <span class="n">num_tiles_y</span>

        <span class="k">if</span> <span class="n">max_tiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_tiles</span> <span class="o">=</span> <span class="n">total_tiles</span>

        <span class="c1"># Process classification data</span>
        <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">is_class_data_raster</span><span class="p">:</span>
            <span class="c1"># Load raster class data</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">class_src</span><span class="p">:</span>
                <span class="c1"># Check if raster CRS matches</span>
                <span class="k">if</span> <span class="n">class_src</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;CRS mismatch: Class raster (</span><span class="si">{</span><span class="n">class_src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">) doesn&#39;t match input raster (</span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Results may be misaligned.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Get unique values from raster</span>
                <span class="c1"># Sample to avoid loading huge rasters</span>
                <span class="n">sample_data</span> <span class="o">=</span> <span class="n">class_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">,</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">class_src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">class_src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>

                <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
                <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">unique_classes</span><span class="p">[</span>
                    <span class="n">unique_classes</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">]</span>  <span class="c1"># Remove 0 as it&#39;s typically background</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes in raster: </span><span class="si">{</span><span class="n">unique_classes</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Create class mapping</span>
                <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load vector class data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> features from </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector CRS: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Always reproject to match raster CRS</span>
                <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting features from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

                <span class="c1"># Apply buffer if specified</span>
                <span class="k">if</span> <span class="n">buffer_radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_radius</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied buffer of </span><span class="si">{</span><span class="n">buffer_radius</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>

                <span class="c1"># Check if class_value_field exists</span>
                <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes: </span><span class="si">{</span><span class="n">unique_classes</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># Create class mapping</span>
                    <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;WARNING: &#39;</span><span class="si">{</span><span class="n">class_value_field</span><span class="si">}</span><span class="s2">&#39; not found in vector data. Using default class ID 1.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Default mapping</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing vector data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create progress bar</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">total_tiles</span><span class="p">,</span> <span class="n">max_tiles</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating tiles&quot;</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> [</span><span class="si">{elapsed}</span><span class="s2">&lt;</span><span class="si">{remaining}</span><span class="s2">, </span><span class="si">{rate_fmt}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Track statistics for summary</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;feature_pixels&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;tile_coordinates&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># For overview image</span>
        <span class="p">}</span>

        <span class="c1"># Process tiles</span>
        <span class="n">tile_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_x</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tile_index</span> <span class="o">&gt;=</span> <span class="n">max_tiles</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Calculate window coordinates</span>
                <span class="n">window_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">stride</span>
                <span class="n">window_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">stride</span>

                <span class="c1"># Adjust for edge cases</span>
                <span class="k">if</span> <span class="n">window_x</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                    <span class="n">window_x</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size</span>
                <span class="k">if</span> <span class="n">window_y</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                    <span class="n">window_y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size</span>

                <span class="c1"># Define window</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">window_x</span><span class="p">,</span> <span class="n">window_y</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">)</span>

                <span class="c1"># Get window transform and bounds</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Calculate window bounds</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Upper left x</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Upper left y</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Add width</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># Add height</span>

                <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

                <span class="c1"># Store tile coordinates for overview</span>
                <span class="k">if</span> <span class="n">create_overview</span><span class="p">:</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">tile_index</span><span class="p">,</span>
                            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">window_x</span><span class="p">,</span>
                            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">window_y</span><span class="p">,</span>
                            <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">],</span>
                            <span class="s2">&quot;has_features&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                <span class="c1"># Create label mask</span>
                <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">has_features</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Process classification data to create labels</span>
                <span class="k">if</span> <span class="n">is_class_data_raster</span><span class="p">:</span>
                    <span class="c1"># For raster class data</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">class_src</span><span class="p">:</span>
                        <span class="c1"># Calculate window in class raster</span>
                        <span class="n">src_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
                        <span class="n">class_bounds</span> <span class="o">=</span> <span class="n">class_src</span><span class="o">.</span><span class="n">bounds</span>

                        <span class="c1"># Check if windows overlap</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">src_bounds</span><span class="o">.</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">right</span>
                            <span class="ow">or</span> <span class="n">src_bounds</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">left</span>
                            <span class="ow">or</span> <span class="n">src_bounds</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">top</span>
                            <span class="ow">or</span> <span class="n">src_bounds</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">class_bounds</span><span class="o">.</span><span class="n">bottom</span>
                        <span class="p">):</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Class raster and input raster do not overlap.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Get corresponding window in class raster</span>
                            <span class="n">window_class</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
                                <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">class_src</span><span class="o">.</span><span class="n">transform</span>
                            <span class="p">)</span>

                            <span class="c1"># Read label data</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">label_data</span> <span class="o">=</span> <span class="n">class_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                                    <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="n">window_class</span><span class="p">,</span>
                                    <span class="n">boundless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">),</span>
                                <span class="p">)</span>

                                <span class="c1"># Remap class values if needed</span>
                                <span class="k">if</span> <span class="n">class_to_id</span><span class="p">:</span>
                                    <span class="n">remapped_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">label_data</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">orig_val</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="n">remapped_data</span><span class="p">[</span><span class="n">label_data</span> <span class="o">==</span> <span class="n">orig_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
                                    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">remapped_data</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">label_data</span>

                                <span class="c1"># Check if we have any features</span>
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">label_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="n">has_features</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;feature_pixels&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span>
                                        <span class="n">label_mask</span>
                                    <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading class raster window: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For vector class data</span>
                    <span class="c1"># Find features that intersect with window</span>
                    <span class="n">window_features</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="c1"># Get class value</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">:</span>
                                <span class="n">class_val</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                                <span class="n">class_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">class_id</span> <span class="o">=</span> <span class="mi">1</span>

                            <span class="c1"># Get geometry in window coordinates</span>
                            <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Rasterize feature</span>
                                    <span class="n">feature_mask</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                                        <span class="p">[(</span><span class="n">geom</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)],</span>
                                        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">),</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">window_transform</span><span class="p">,</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                                    <span class="p">)</span>

                                    <span class="c1"># Add to label mask</span>
                                    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">label_mask</span><span class="p">,</span> <span class="n">feature_mask</span><span class="p">)</span>

                                    <span class="c1"># Check if the feature was actually rasterized</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_mask</span><span class="p">):</span>
                                        <span class="n">has_features</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="n">create_overview</span> <span class="ow">and</span> <span class="n">tile_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span>
                                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">]</span>
                                        <span class="p">):</span>
                                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">][</span><span class="n">tile_index</span><span class="p">][</span>
                                                <span class="s2">&quot;has_features&quot;</span>
                                            <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rasterizing feature </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Skip tile if no features and skip_empty_tiles is True</span>
                <span class="k">if</span> <span class="n">skip_empty_tiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_features</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">tile_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c1"># Read image data</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Export image as GeoTIFF</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

                <span class="c1"># Create profile for image GeoTIFF</span>
                <span class="n">image_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">image_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># Save image as GeoTIFF</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">image_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving image GeoTIFF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Create profile for label GeoTIFF</span>
                <span class="n">label_profile</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Export label as GeoTIFF</span>
                <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">label_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">has_features</span><span class="p">:</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;feature_pixels&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">label_mask</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving label GeoTIFF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Create XML annotation for object detection if using vector class data</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">is_class_data_raster</span>
                    <span class="ow">and</span> <span class="s2">&quot;gdf&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="c1"># Create XML annotation</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;folder&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;images&quot;</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span>

                    <span class="n">size</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># Add georeference information</span>
                    <span class="n">geo</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;georeference&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;crs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">window_transform</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># Add objects</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Get feature class</span>
                        <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">:</span>
                            <span class="n">class_val</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">class_val</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span>

                        <span class="c1"># Get geometry bounds in pixel coordinates</span>
                        <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="c1"># Get bounds in world coordinates</span>
                            <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>

                            <span class="c1"># Convert to pixel coordinates</span>
                            <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                            <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                            <span class="c1"># Ensure coordinates are within tile bounds</span>
                            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                            <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                            <span class="c1"># Only add if the box has non-zero area</span>
                            <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin</span> <span class="ow">and</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">ymin</span><span class="p">:</span>
                                <span class="n">obj</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span>
                                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">class_val</span><span class="p">)</span>
                                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;difficult&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

                                <span class="n">bbox</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;bndbox&quot;</span><span class="p">)</span>
                                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
                                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
                                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
                                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>

                    <span class="c1"># Save XML</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                    <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">tile_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                    <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>

                <span class="c1"># Update progress bar</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, With features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">tile_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">tile_index</span> <span class="o">&gt;=</span> <span class="n">max_tiles</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">tile_index</span> <span class="o">&gt;=</span> <span class="n">max_tiles</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Close progress bar</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Create overview image if requested</span>
        <span class="k">if</span> <span class="n">create_overview</span> <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">create_overview_image</span><span class="p">(</span>
                    <span class="n">src</span><span class="p">,</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tile_coordinates&quot;</span><span class="p">],</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;overview.png&quot;</span><span class="p">),</span>
                    <span class="n">tile_size</span><span class="p">,</span>
                    <span class="n">stride</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create overview image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Report results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Export Summary -------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles exported: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tiles with features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Average feature pixels per tile: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;feature_pixels&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors encountered: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to: </span><span class="si">{</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Verify georeference in a sample image and label</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Georeference Verification -------&quot;</span><span class="p">)</span>
                <span class="n">sample_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_0.tif&quot;</span><span class="p">)</span>
                <span class="n">sample_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_0.tif&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_image</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_image</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image CRS: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image transform: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Image has georeference: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying image georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_label</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_label</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbl</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label CRS: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label transform: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Label has georeference: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Label dimensions: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying label georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return statistics dictionary for further processing if needed</span>
        <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.export_geotiff_tiles_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_geotiff_tiles_batch</span><span class="p">(</span><span class="n">images_folder</span><span class="p">,</span> <span class="n">masks_folder</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">class_value_field</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_overview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.export_geotiff_tiles_batch" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export georeferenced GeoTIFF tiles from folders of images and masks.</p>
<p>This function processes multiple image-mask pairs from input folders,
generating tiles for each pair. All image tiles are saved to a single
'images' folder and all mask tiles to a single 'masks' folder.</p>
<p>Images and masks are paired by their sorted order (alphabetically), not by
filename matching. The number of images and masks must be equal.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>images_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to folder containing raster images</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>masks_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to folder containing classification masks/vectors</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output folder</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of tiles in pixels (square)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Step size between tiles</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field containing class values (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>buffer_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer to add around features (in units of the CRS)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_tiles</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of tiles to process per image (None for all)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress non-essential output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use all_touched=True in rasterization (for vector data)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_overview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to create an overview image of all tiles</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_empty_tiles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, skip tiles with no features</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image_extensions</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of image file extensions to process (default: common raster formats)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_extensions</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of mask file extensions to process (default: common raster/vector formats)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Dictionary containing batch processing statistics</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no images or masks found, or if counts don't match</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_geotiff_tiles_batch</span><span class="p">(</span>
    <span class="n">images_folder</span><span class="p">,</span>
    <span class="n">masks_folder</span><span class="p">,</span>
    <span class="n">output_folder</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">class_value_field</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">create_overview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">image_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export georeferenced GeoTIFF tiles from folders of images and masks.</span>

<span class="sd">    This function processes multiple image-mask pairs from input folders,</span>
<span class="sd">    generating tiles for each pair. All image tiles are saved to a single</span>
<span class="sd">    &#39;images&#39; folder and all mask tiles to a single &#39;masks&#39; folder.</span>

<span class="sd">    Images and masks are paired by their sorted order (alphabetically), not by</span>
<span class="sd">    filename matching. The number of images and masks must be equal.</span>

<span class="sd">    Args:</span>
<span class="sd">        images_folder (str): Path to folder containing raster images</span>
<span class="sd">        masks_folder (str): Path to folder containing classification masks/vectors</span>
<span class="sd">        output_folder (str): Path to output folder</span>
<span class="sd">        tile_size (int): Size of tiles in pixels (square)</span>
<span class="sd">        stride (int): Step size between tiles</span>
<span class="sd">        class_value_field (str): Field containing class values (for vector data)</span>
<span class="sd">        buffer_radius (float): Buffer to add around features (in units of the CRS)</span>
<span class="sd">        max_tiles (int): Maximum number of tiles to process per image (None for all)</span>
<span class="sd">        quiet (bool): If True, suppress non-essential output</span>
<span class="sd">        all_touched (bool): Whether to use all_touched=True in rasterization (for vector data)</span>
<span class="sd">        create_overview (bool): Whether to create an overview image of all tiles</span>
<span class="sd">        skip_empty_tiles (bool): If True, skip tiles with no features</span>
<span class="sd">        image_extensions (list): List of image file extensions to process (default: common raster formats)</span>
<span class="sd">        mask_extensions (list): List of mask file extensions to process (default: common raster/vector formats)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Dictionary containing batch processing statistics</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no images or masks found, or if counts don&#39;t match</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;rasterio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Default extensions if not provided</span>
    <span class="k">if</span> <span class="n">image_extensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span> <span class="s2">&quot;.img&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mask_extensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_extensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.img&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.shp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.geojson&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.geoparquet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.json&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># Convert extensions to lowercase for comparison</span>
    <span class="n">image_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">image_extensions</span><span class="p">]</span>
    <span class="n">mask_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">mask_extensions</span><span class="p">]</span>

    <span class="c1"># Create output folder structure</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_images_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="n">output_masks_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_images_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_masks_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get list of image files</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">image_extensions</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

    <span class="c1"># Get list of mask files</span>
    <span class="n">mask_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">mask_extensions</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">masks_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mask_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

    <span class="c1"># Sort files for consistent processing</span>
    <span class="n">image_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">mask_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No image files found in </span><span class="si">{</span><span class="n">images_folder</span><span class="si">}</span><span class="s2"> with extensions </span><span class="si">{</span><span class="n">image_extensions</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No mask files found in </span><span class="si">{</span><span class="n">masks_folder</span><span class="si">}</span><span class="s2"> with extensions </span><span class="si">{</span><span class="n">mask_extensions</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_files</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of image files (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span><span class="si">}</span><span class="s2">) does not match number of mask files (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_files</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Initialize batch statistics</span>
    <span class="n">batch_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_image_pairs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;processed_pairs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;processed_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;failed_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> image files and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> mask files to process&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing batch from </span><span class="si">{</span><span class="n">images_folder</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">masks_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output folder: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="c1"># Global tile counter for unique naming</span>
    <span class="n">global_tile_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Process each image-mask pair by sorted order</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">mask_files</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing image pairs&quot;</span><span class="p">,</span>
            <span class="n">disable</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">):</span>
        <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_image_pairs&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Get base filename without extension for naming (use image filename)</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Image: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mask: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Process the image-mask pair manually to get direct control over tile saving</span>
            <span class="n">tiles_generated</span> <span class="o">=</span> <span class="n">_process_image_mask_pair</span><span class="p">(</span>
                <span class="n">image_file</span><span class="o">=</span><span class="n">image_file</span><span class="p">,</span>
                <span class="n">mask_file</span><span class="o">=</span><span class="n">mask_file</span><span class="p">,</span>
                <span class="n">base_name</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span>
                <span class="n">output_images_dir</span><span class="o">=</span><span class="n">output_images_dir</span><span class="p">,</span>
                <span class="n">output_masks_dir</span><span class="o">=</span><span class="n">output_masks_dir</span><span class="p">,</span>
                <span class="n">global_tile_counter</span><span class="o">=</span><span class="n">global_tile_counter</span><span class="p">,</span>
                <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span>
                <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
                <span class="n">class_value_field</span><span class="o">=</span><span class="n">class_value_field</span><span class="p">,</span>
                <span class="n">buffer_radius</span><span class="o">=</span><span class="n">buffer_radius</span><span class="p">,</span>
                <span class="n">max_tiles</span><span class="o">=</span><span class="n">max_tiles</span><span class="p">,</span>
                <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                <span class="n">skip_empty_tiles</span><span class="o">=</span><span class="n">skip_empty_tiles</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Update counters</span>
            <span class="n">global_tile_counter</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span>

            <span class="c1"># Update batch statistics</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;processed_pairs&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span>

            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;processed_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_file</span><span class="p">,</span>
                    <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_file</span><span class="p">,</span>
                    <span class="s2">&quot;base_name&quot;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                    <span class="s2">&quot;tiles_generated&quot;</span><span class="p">:</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="n">tiles_generated</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR processing </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;failed_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_file</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="p">)</span>
            <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Print batch summary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BATCH PROCESSING SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total image pairs found: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;total_image_pairs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully processed: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;processed_pairs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;failed_files&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles generated: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiles with features: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">feature_percentage</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature percentage: </span><span class="si">{</span><span class="n">feature_percentage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total errors: </span><span class="si">{</span><span class="n">batch_stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Images: </span><span class="si">{</span><span class="n">output_images_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Masks: </span><span class="si">{</span><span class="n">output_masks_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># List failed files if any</span>
        <span class="k">if</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;failed_files&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed files:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">failed</span> <span class="ow">in</span> <span class="n">batch_stats</span><span class="p">[</span><span class="s2">&quot;failed_files&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">failed</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">failed</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.export_tiles_to_geojson" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_tiles_to_geojson</span><span class="p">(</span><span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.export_tiles_to_geojson" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export tile rectangles directly to GeoJSON without creating an overview image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tile_coordinates</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries containing tile information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>src</code>
            </td>
            <td>
                  <code><span title="rasterio.io.DatasetReader">DatasetReader</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path where the GeoJSON will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of each tile in pixels. Only needed if not in tile_coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stride between tiles in pixels. Used to calculate overlaps between tiles.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved GeoJSON file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3781</span>
<span class="normal">3782</span>
<span class="normal">3783</span>
<span class="normal">3784</span>
<span class="normal">3785</span>
<span class="normal">3786</span>
<span class="normal">3787</span>
<span class="normal">3788</span>
<span class="normal">3789</span>
<span class="normal">3790</span>
<span class="normal">3791</span>
<span class="normal">3792</span>
<span class="normal">3793</span>
<span class="normal">3794</span>
<span class="normal">3795</span>
<span class="normal">3796</span>
<span class="normal">3797</span>
<span class="normal">3798</span>
<span class="normal">3799</span>
<span class="normal">3800</span>
<span class="normal">3801</span>
<span class="normal">3802</span>
<span class="normal">3803</span>
<span class="normal">3804</span>
<span class="normal">3805</span>
<span class="normal">3806</span>
<span class="normal">3807</span>
<span class="normal">3808</span>
<span class="normal">3809</span>
<span class="normal">3810</span>
<span class="normal">3811</span>
<span class="normal">3812</span>
<span class="normal">3813</span>
<span class="normal">3814</span>
<span class="normal">3815</span>
<span class="normal">3816</span>
<span class="normal">3817</span>
<span class="normal">3818</span>
<span class="normal">3819</span>
<span class="normal">3820</span>
<span class="normal">3821</span>
<span class="normal">3822</span>
<span class="normal">3823</span>
<span class="normal">3824</span>
<span class="normal">3825</span>
<span class="normal">3826</span>
<span class="normal">3827</span>
<span class="normal">3828</span>
<span class="normal">3829</span>
<span class="normal">3830</span>
<span class="normal">3831</span>
<span class="normal">3832</span>
<span class="normal">3833</span>
<span class="normal">3834</span>
<span class="normal">3835</span>
<span class="normal">3836</span>
<span class="normal">3837</span>
<span class="normal">3838</span>
<span class="normal">3839</span>
<span class="normal">3840</span>
<span class="normal">3841</span>
<span class="normal">3842</span>
<span class="normal">3843</span>
<span class="normal">3844</span>
<span class="normal">3845</span>
<span class="normal">3846</span>
<span class="normal">3847</span>
<span class="normal">3848</span>
<span class="normal">3849</span>
<span class="normal">3850</span>
<span class="normal">3851</span>
<span class="normal">3852</span>
<span class="normal">3853</span>
<span class="normal">3854</span>
<span class="normal">3855</span>
<span class="normal">3856</span>
<span class="normal">3857</span>
<span class="normal">3858</span>
<span class="normal">3859</span>
<span class="normal">3860</span>
<span class="normal">3861</span>
<span class="normal">3862</span>
<span class="normal">3863</span>
<span class="normal">3864</span>
<span class="normal">3865</span>
<span class="normal">3866</span>
<span class="normal">3867</span>
<span class="normal">3868</span>
<span class="normal">3869</span>
<span class="normal">3870</span>
<span class="normal">3871</span>
<span class="normal">3872</span>
<span class="normal">3873</span>
<span class="normal">3874</span>
<span class="normal">3875</span>
<span class="normal">3876</span>
<span class="normal">3877</span>
<span class="normal">3878</span>
<span class="normal">3879</span>
<span class="normal">3880</span>
<span class="normal">3881</span>
<span class="normal">3882</span>
<span class="normal">3883</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_tiles_to_geojson</span><span class="p">(</span>
    <span class="n">tile_coordinates</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export tile rectangles directly to GeoJSON without creating an overview image.</span>

<span class="sd">    Args:</span>
<span class="sd">        tile_coordinates (list): A list of dictionaries containing tile information.</span>
<span class="sd">        src (rasterio.io.DatasetReader): The source raster dataset.</span>
<span class="sd">        output_path (str): The path where the GeoJSON will be saved.</span>
<span class="sd">        tile_size (int, optional): The size of each tile in pixels. Only needed if not in tile_coordinates.</span>
<span class="sd">        stride (int, optional): The stride between tiles in pixels. Used to calculate overlaps between tiles.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved GeoJSON file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tile_coordinates</span><span class="p">:</span>
        <span class="c1"># Get the size from the tile or use the provided parameter</span>
        <span class="n">tile_width</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span>
        <span class="n">tile_height</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">tile_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tile_height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Tile size not found in tile data and no tile_size parameter provided&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get bounds from the tile</span>
        <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">tile</span><span class="p">:</span>
            <span class="c1"># If bounds are already in geo coordinates</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to calculate bounds from transform if available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">):</span>
                <span class="c1"># Convert pixel coordinates to geo coordinates</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">tile_width</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">+</span> <span class="n">tile_height</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot determine bounds. Neither &#39;bounds&#39; in tile nor transform in src.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Calculate overlap with neighboring tiles if stride is provided</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stride</span> <span class="o">&lt;</span> <span class="n">tile_width</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">tile_width</span> <span class="o">-</span> <span class="n">stride</span>

        <span class="c1"># Create a polygon from the bounds</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

        <span class="c1"># Create a GeoJSON feature</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">polygon</span><span class="p">),</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span>
                <span class="s2">&quot;has_features&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;has_features&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s2">&quot;tile_width_px&quot;</span><span class="p">:</span> <span class="n">tile_width</span><span class="p">,</span>
                <span class="s2">&quot;tile_height_px&quot;</span><span class="p">:</span> <span class="n">tile_height</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Add overlap information if stride is provided</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;stride_px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stride</span>
            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;overlap_px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span>

        <span class="c1"># Add additional properties from the tile</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tile</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]:</span>
                <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="c1"># Create the GeoJSON collection</span>
    <span class="n">geojson_collection</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s2">&quot;to_string&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
            <span class="s2">&quot;source_raster_dimensions&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Create directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">geojson_collection</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GeoJSON saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.export_training_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_training_data</span><span class="p">(</span><span class="n">in_raster</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">in_class_data</span><span class="p">,</span> <span class="n">image_chip_format</span><span class="o">=</span><span class="s1">&#39;GEOTIFF&#39;</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">tile_size_y</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">stride_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_nofeature_tiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata_format</span><span class="o">=</span><span class="s1">&#39;PASCAL_VOC&#39;</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">class_value_field</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_mask_polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reference_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blacken_around_feature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_mode</span><span class="o">=</span><span class="s1">&#39;FIXED_SIZE&#39;</span><span class="p">,</span> <span class="n">in_raster2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_instance_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instance_class_value_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_polygon_overlap_ratio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.utils.export_training_data" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Export training data for deep learning using TorchGeo with progress bar.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>in_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to input raster image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output folder path where chips and labels will be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_class_data</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file containing class polygons.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image_chip_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output image format (PNG, JPEG, TIFF, GEOTIFF).</p>
              </div>
            </td>
            <td>
                  <code>&#39;GEOTIFF&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width of image chips in pixels.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height of image chips in pixels.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Horizontal stride between chips. If None, uses tile_size_x.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stride_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vertical stride between chips. If None, uses tile_size_y.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_nofeature_tiles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to export chips without features.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output metadata format (PASCAL_VOC, KITTI, COCO).</p>
              </div>
            </td>
            <td>
                  <code>&#39;PASCAL_VOC&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting index for chip filenames.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in in_class_data containing class values.</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>buffer_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Buffer radius around features (in CRS units).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_mask_polygons</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file containing mask polygons.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rotation_angle</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rotation angle in degrees.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_system</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference system code.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>blacken_around_feature</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to mask areas outside of features.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crop_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Crop mode (FIXED_SIZE, CENTERED_ON_FEATURE).</p>
              </div>
            </td>
            <td>
                  <code>&#39;FIXED_SIZE&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_raster2</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to secondary raster image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_instance_data</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to vector file containing instance polygons.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance_class_value_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in in_instance_data for instance classes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_polygon_overlap_ratio</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum overlap ratio for polygons.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use all_touched=True in rasterization.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_geotiff</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to save as GeoTIFF with georeferencing.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress most output messages.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3886</span>
<span class="normal">3887</span>
<span class="normal">3888</span>
<span class="normal">3889</span>
<span class="normal">3890</span>
<span class="normal">3891</span>
<span class="normal">3892</span>
<span class="normal">3893</span>
<span class="normal">3894</span>
<span class="normal">3895</span>
<span class="normal">3896</span>
<span class="normal">3897</span>
<span class="normal">3898</span>
<span class="normal">3899</span>
<span class="normal">3900</span>
<span class="normal">3901</span>
<span class="normal">3902</span>
<span class="normal">3903</span>
<span class="normal">3904</span>
<span class="normal">3905</span>
<span class="normal">3906</span>
<span class="normal">3907</span>
<span class="normal">3908</span>
<span class="normal">3909</span>
<span class="normal">3910</span>
<span class="normal">3911</span>
<span class="normal">3912</span>
<span class="normal">3913</span>
<span class="normal">3914</span>
<span class="normal">3915</span>
<span class="normal">3916</span>
<span class="normal">3917</span>
<span class="normal">3918</span>
<span class="normal">3919</span>
<span class="normal">3920</span>
<span class="normal">3921</span>
<span class="normal">3922</span>
<span class="normal">3923</span>
<span class="normal">3924</span>
<span class="normal">3925</span>
<span class="normal">3926</span>
<span class="normal">3927</span>
<span class="normal">3928</span>
<span class="normal">3929</span>
<span class="normal">3930</span>
<span class="normal">3931</span>
<span class="normal">3932</span>
<span class="normal">3933</span>
<span class="normal">3934</span>
<span class="normal">3935</span>
<span class="normal">3936</span>
<span class="normal">3937</span>
<span class="normal">3938</span>
<span class="normal">3939</span>
<span class="normal">3940</span>
<span class="normal">3941</span>
<span class="normal">3942</span>
<span class="normal">3943</span>
<span class="normal">3944</span>
<span class="normal">3945</span>
<span class="normal">3946</span>
<span class="normal">3947</span>
<span class="normal">3948</span>
<span class="normal">3949</span>
<span class="normal">3950</span>
<span class="normal">3951</span>
<span class="normal">3952</span>
<span class="normal">3953</span>
<span class="normal">3954</span>
<span class="normal">3955</span>
<span class="normal">3956</span>
<span class="normal">3957</span>
<span class="normal">3958</span>
<span class="normal">3959</span>
<span class="normal">3960</span>
<span class="normal">3961</span>
<span class="normal">3962</span>
<span class="normal">3963</span>
<span class="normal">3964</span>
<span class="normal">3965</span>
<span class="normal">3966</span>
<span class="normal">3967</span>
<span class="normal">3968</span>
<span class="normal">3969</span>
<span class="normal">3970</span>
<span class="normal">3971</span>
<span class="normal">3972</span>
<span class="normal">3973</span>
<span class="normal">3974</span>
<span class="normal">3975</span>
<span class="normal">3976</span>
<span class="normal">3977</span>
<span class="normal">3978</span>
<span class="normal">3979</span>
<span class="normal">3980</span>
<span class="normal">3981</span>
<span class="normal">3982</span>
<span class="normal">3983</span>
<span class="normal">3984</span>
<span class="normal">3985</span>
<span class="normal">3986</span>
<span class="normal">3987</span>
<span class="normal">3988</span>
<span class="normal">3989</span>
<span class="normal">3990</span>
<span class="normal">3991</span>
<span class="normal">3992</span>
<span class="normal">3993</span>
<span class="normal">3994</span>
<span class="normal">3995</span>
<span class="normal">3996</span>
<span class="normal">3997</span>
<span class="normal">3998</span>
<span class="normal">3999</span>
<span class="normal">4000</span>
<span class="normal">4001</span>
<span class="normal">4002</span>
<span class="normal">4003</span>
<span class="normal">4004</span>
<span class="normal">4005</span>
<span class="normal">4006</span>
<span class="normal">4007</span>
<span class="normal">4008</span>
<span class="normal">4009</span>
<span class="normal">4010</span>
<span class="normal">4011</span>
<span class="normal">4012</span>
<span class="normal">4013</span>
<span class="normal">4014</span>
<span class="normal">4015</span>
<span class="normal">4016</span>
<span class="normal">4017</span>
<span class="normal">4018</span>
<span class="normal">4019</span>
<span class="normal">4020</span>
<span class="normal">4021</span>
<span class="normal">4022</span>
<span class="normal">4023</span>
<span class="normal">4024</span>
<span class="normal">4025</span>
<span class="normal">4026</span>
<span class="normal">4027</span>
<span class="normal">4028</span>
<span class="normal">4029</span>
<span class="normal">4030</span>
<span class="normal">4031</span>
<span class="normal">4032</span>
<span class="normal">4033</span>
<span class="normal">4034</span>
<span class="normal">4035</span>
<span class="normal">4036</span>
<span class="normal">4037</span>
<span class="normal">4038</span>
<span class="normal">4039</span>
<span class="normal">4040</span>
<span class="normal">4041</span>
<span class="normal">4042</span>
<span class="normal">4043</span>
<span class="normal">4044</span>
<span class="normal">4045</span>
<span class="normal">4046</span>
<span class="normal">4047</span>
<span class="normal">4048</span>
<span class="normal">4049</span>
<span class="normal">4050</span>
<span class="normal">4051</span>
<span class="normal">4052</span>
<span class="normal">4053</span>
<span class="normal">4054</span>
<span class="normal">4055</span>
<span class="normal">4056</span>
<span class="normal">4057</span>
<span class="normal">4058</span>
<span class="normal">4059</span>
<span class="normal">4060</span>
<span class="normal">4061</span>
<span class="normal">4062</span>
<span class="normal">4063</span>
<span class="normal">4064</span>
<span class="normal">4065</span>
<span class="normal">4066</span>
<span class="normal">4067</span>
<span class="normal">4068</span>
<span class="normal">4069</span>
<span class="normal">4070</span>
<span class="normal">4071</span>
<span class="normal">4072</span>
<span class="normal">4073</span>
<span class="normal">4074</span>
<span class="normal">4075</span>
<span class="normal">4076</span>
<span class="normal">4077</span>
<span class="normal">4078</span>
<span class="normal">4079</span>
<span class="normal">4080</span>
<span class="normal">4081</span>
<span class="normal">4082</span>
<span class="normal">4083</span>
<span class="normal">4084</span>
<span class="normal">4085</span>
<span class="normal">4086</span>
<span class="normal">4087</span>
<span class="normal">4088</span>
<span class="normal">4089</span>
<span class="normal">4090</span>
<span class="normal">4091</span>
<span class="normal">4092</span>
<span class="normal">4093</span>
<span class="normal">4094</span>
<span class="normal">4095</span>
<span class="normal">4096</span>
<span class="normal">4097</span>
<span class="normal">4098</span>
<span class="normal">4099</span>
<span class="normal">4100</span>
<span class="normal">4101</span>
<span class="normal">4102</span>
<span class="normal">4103</span>
<span class="normal">4104</span>
<span class="normal">4105</span>
<span class="normal">4106</span>
<span class="normal">4107</span>
<span class="normal">4108</span>
<span class="normal">4109</span>
<span class="normal">4110</span>
<span class="normal">4111</span>
<span class="normal">4112</span>
<span class="normal">4113</span>
<span class="normal">4114</span>
<span class="normal">4115</span>
<span class="normal">4116</span>
<span class="normal">4117</span>
<span class="normal">4118</span>
<span class="normal">4119</span>
<span class="normal">4120</span>
<span class="normal">4121</span>
<span class="normal">4122</span>
<span class="normal">4123</span>
<span class="normal">4124</span>
<span class="normal">4125</span>
<span class="normal">4126</span>
<span class="normal">4127</span>
<span class="normal">4128</span>
<span class="normal">4129</span>
<span class="normal">4130</span>
<span class="normal">4131</span>
<span class="normal">4132</span>
<span class="normal">4133</span>
<span class="normal">4134</span>
<span class="normal">4135</span>
<span class="normal">4136</span>
<span class="normal">4137</span>
<span class="normal">4138</span>
<span class="normal">4139</span>
<span class="normal">4140</span>
<span class="normal">4141</span>
<span class="normal">4142</span>
<span class="normal">4143</span>
<span class="normal">4144</span>
<span class="normal">4145</span>
<span class="normal">4146</span>
<span class="normal">4147</span>
<span class="normal">4148</span>
<span class="normal">4149</span>
<span class="normal">4150</span>
<span class="normal">4151</span>
<span class="normal">4152</span>
<span class="normal">4153</span>
<span class="normal">4154</span>
<span class="normal">4155</span>
<span class="normal">4156</span>
<span class="normal">4157</span>
<span class="normal">4158</span>
<span class="normal">4159</span>
<span class="normal">4160</span>
<span class="normal">4161</span>
<span class="normal">4162</span>
<span class="normal">4163</span>
<span class="normal">4164</span>
<span class="normal">4165</span>
<span class="normal">4166</span>
<span class="normal">4167</span>
<span class="normal">4168</span>
<span class="normal">4169</span>
<span class="normal">4170</span>
<span class="normal">4171</span>
<span class="normal">4172</span>
<span class="normal">4173</span>
<span class="normal">4174</span>
<span class="normal">4175</span>
<span class="normal">4176</span>
<span class="normal">4177</span>
<span class="normal">4178</span>
<span class="normal">4179</span>
<span class="normal">4180</span>
<span class="normal">4181</span>
<span class="normal">4182</span>
<span class="normal">4183</span>
<span class="normal">4184</span>
<span class="normal">4185</span>
<span class="normal">4186</span>
<span class="normal">4187</span>
<span class="normal">4188</span>
<span class="normal">4189</span>
<span class="normal">4190</span>
<span class="normal">4191</span>
<span class="normal">4192</span>
<span class="normal">4193</span>
<span class="normal">4194</span>
<span class="normal">4195</span>
<span class="normal">4196</span>
<span class="normal">4197</span>
<span class="normal">4198</span>
<span class="normal">4199</span>
<span class="normal">4200</span>
<span class="normal">4201</span>
<span class="normal">4202</span>
<span class="normal">4203</span>
<span class="normal">4204</span>
<span class="normal">4205</span>
<span class="normal">4206</span>
<span class="normal">4207</span>
<span class="normal">4208</span>
<span class="normal">4209</span>
<span class="normal">4210</span>
<span class="normal">4211</span>
<span class="normal">4212</span>
<span class="normal">4213</span>
<span class="normal">4214</span>
<span class="normal">4215</span>
<span class="normal">4216</span>
<span class="normal">4217</span>
<span class="normal">4218</span>
<span class="normal">4219</span>
<span class="normal">4220</span>
<span class="normal">4221</span>
<span class="normal">4222</span>
<span class="normal">4223</span>
<span class="normal">4224</span>
<span class="normal">4225</span>
<span class="normal">4226</span>
<span class="normal">4227</span>
<span class="normal">4228</span>
<span class="normal">4229</span>
<span class="normal">4230</span>
<span class="normal">4231</span>
<span class="normal">4232</span>
<span class="normal">4233</span>
<span class="normal">4234</span>
<span class="normal">4235</span>
<span class="normal">4236</span>
<span class="normal">4237</span>
<span class="normal">4238</span>
<span class="normal">4239</span>
<span class="normal">4240</span>
<span class="normal">4241</span>
<span class="normal">4242</span>
<span class="normal">4243</span>
<span class="normal">4244</span>
<span class="normal">4245</span>
<span class="normal">4246</span>
<span class="normal">4247</span>
<span class="normal">4248</span>
<span class="normal">4249</span>
<span class="normal">4250</span>
<span class="normal">4251</span>
<span class="normal">4252</span>
<span class="normal">4253</span>
<span class="normal">4254</span>
<span class="normal">4255</span>
<span class="normal">4256</span>
<span class="normal">4257</span>
<span class="normal">4258</span>
<span class="normal">4259</span>
<span class="normal">4260</span>
<span class="normal">4261</span>
<span class="normal">4262</span>
<span class="normal">4263</span>
<span class="normal">4264</span>
<span class="normal">4265</span>
<span class="normal">4266</span>
<span class="normal">4267</span>
<span class="normal">4268</span>
<span class="normal">4269</span>
<span class="normal">4270</span>
<span class="normal">4271</span>
<span class="normal">4272</span>
<span class="normal">4273</span>
<span class="normal">4274</span>
<span class="normal">4275</span>
<span class="normal">4276</span>
<span class="normal">4277</span>
<span class="normal">4278</span>
<span class="normal">4279</span>
<span class="normal">4280</span>
<span class="normal">4281</span>
<span class="normal">4282</span>
<span class="normal">4283</span>
<span class="normal">4284</span>
<span class="normal">4285</span>
<span class="normal">4286</span>
<span class="normal">4287</span>
<span class="normal">4288</span>
<span class="normal">4289</span>
<span class="normal">4290</span>
<span class="normal">4291</span>
<span class="normal">4292</span>
<span class="normal">4293</span>
<span class="normal">4294</span>
<span class="normal">4295</span>
<span class="normal">4296</span>
<span class="normal">4297</span>
<span class="normal">4298</span>
<span class="normal">4299</span>
<span class="normal">4300</span>
<span class="normal">4301</span>
<span class="normal">4302</span>
<span class="normal">4303</span>
<span class="normal">4304</span>
<span class="normal">4305</span>
<span class="normal">4306</span>
<span class="normal">4307</span>
<span class="normal">4308</span>
<span class="normal">4309</span>
<span class="normal">4310</span>
<span class="normal">4311</span>
<span class="normal">4312</span>
<span class="normal">4313</span>
<span class="normal">4314</span>
<span class="normal">4315</span>
<span class="normal">4316</span>
<span class="normal">4317</span>
<span class="normal">4318</span>
<span class="normal">4319</span>
<span class="normal">4320</span>
<span class="normal">4321</span>
<span class="normal">4322</span>
<span class="normal">4323</span>
<span class="normal">4324</span>
<span class="normal">4325</span>
<span class="normal">4326</span>
<span class="normal">4327</span>
<span class="normal">4328</span>
<span class="normal">4329</span>
<span class="normal">4330</span>
<span class="normal">4331</span>
<span class="normal">4332</span>
<span class="normal">4333</span>
<span class="normal">4334</span>
<span class="normal">4335</span>
<span class="normal">4336</span>
<span class="normal">4337</span>
<span class="normal">4338</span>
<span class="normal">4339</span>
<span class="normal">4340</span>
<span class="normal">4341</span>
<span class="normal">4342</span>
<span class="normal">4343</span>
<span class="normal">4344</span>
<span class="normal">4345</span>
<span class="normal">4346</span>
<span class="normal">4347</span>
<span class="normal">4348</span>
<span class="normal">4349</span>
<span class="normal">4350</span>
<span class="normal">4351</span>
<span class="normal">4352</span>
<span class="normal">4353</span>
<span class="normal">4354</span>
<span class="normal">4355</span>
<span class="normal">4356</span>
<span class="normal">4357</span>
<span class="normal">4358</span>
<span class="normal">4359</span>
<span class="normal">4360</span>
<span class="normal">4361</span>
<span class="normal">4362</span>
<span class="normal">4363</span>
<span class="normal">4364</span>
<span class="normal">4365</span>
<span class="normal">4366</span>
<span class="normal">4367</span>
<span class="normal">4368</span>
<span class="normal">4369</span>
<span class="normal">4370</span>
<span class="normal">4371</span>
<span class="normal">4372</span>
<span class="normal">4373</span>
<span class="normal">4374</span>
<span class="normal">4375</span>
<span class="normal">4376</span>
<span class="normal">4377</span>
<span class="normal">4378</span>
<span class="normal">4379</span>
<span class="normal">4380</span>
<span class="normal">4381</span>
<span class="normal">4382</span>
<span class="normal">4383</span>
<span class="normal">4384</span>
<span class="normal">4385</span>
<span class="normal">4386</span>
<span class="normal">4387</span>
<span class="normal">4388</span>
<span class="normal">4389</span>
<span class="normal">4390</span>
<span class="normal">4391</span>
<span class="normal">4392</span>
<span class="normal">4393</span>
<span class="normal">4394</span>
<span class="normal">4395</span>
<span class="normal">4396</span>
<span class="normal">4397</span>
<span class="normal">4398</span>
<span class="normal">4399</span>
<span class="normal">4400</span>
<span class="normal">4401</span>
<span class="normal">4402</span>
<span class="normal">4403</span>
<span class="normal">4404</span>
<span class="normal">4405</span>
<span class="normal">4406</span>
<span class="normal">4407</span>
<span class="normal">4408</span>
<span class="normal">4409</span>
<span class="normal">4410</span>
<span class="normal">4411</span>
<span class="normal">4412</span>
<span class="normal">4413</span>
<span class="normal">4414</span>
<span class="normal">4415</span>
<span class="normal">4416</span>
<span class="normal">4417</span>
<span class="normal">4418</span>
<span class="normal">4419</span>
<span class="normal">4420</span>
<span class="normal">4421</span>
<span class="normal">4422</span>
<span class="normal">4423</span>
<span class="normal">4424</span>
<span class="normal">4425</span>
<span class="normal">4426</span>
<span class="normal">4427</span>
<span class="normal">4428</span>
<span class="normal">4429</span>
<span class="normal">4430</span>
<span class="normal">4431</span>
<span class="normal">4432</span>
<span class="normal">4433</span>
<span class="normal">4434</span>
<span class="normal">4435</span>
<span class="normal">4436</span>
<span class="normal">4437</span>
<span class="normal">4438</span>
<span class="normal">4439</span>
<span class="normal">4440</span>
<span class="normal">4441</span>
<span class="normal">4442</span>
<span class="normal">4443</span>
<span class="normal">4444</span>
<span class="normal">4445</span>
<span class="normal">4446</span>
<span class="normal">4447</span>
<span class="normal">4448</span>
<span class="normal">4449</span>
<span class="normal">4450</span>
<span class="normal">4451</span>
<span class="normal">4452</span>
<span class="normal">4453</span>
<span class="normal">4454</span>
<span class="normal">4455</span>
<span class="normal">4456</span>
<span class="normal">4457</span>
<span class="normal">4458</span>
<span class="normal">4459</span>
<span class="normal">4460</span>
<span class="normal">4461</span>
<span class="normal">4462</span>
<span class="normal">4463</span>
<span class="normal">4464</span>
<span class="normal">4465</span>
<span class="normal">4466</span>
<span class="normal">4467</span>
<span class="normal">4468</span>
<span class="normal">4469</span>
<span class="normal">4470</span>
<span class="normal">4471</span>
<span class="normal">4472</span>
<span class="normal">4473</span>
<span class="normal">4474</span>
<span class="normal">4475</span>
<span class="normal">4476</span>
<span class="normal">4477</span>
<span class="normal">4478</span>
<span class="normal">4479</span>
<span class="normal">4480</span>
<span class="normal">4481</span>
<span class="normal">4482</span>
<span class="normal">4483</span>
<span class="normal">4484</span>
<span class="normal">4485</span>
<span class="normal">4486</span>
<span class="normal">4487</span>
<span class="normal">4488</span>
<span class="normal">4489</span>
<span class="normal">4490</span>
<span class="normal">4491</span>
<span class="normal">4492</span>
<span class="normal">4493</span>
<span class="normal">4494</span>
<span class="normal">4495</span>
<span class="normal">4496</span>
<span class="normal">4497</span>
<span class="normal">4498</span>
<span class="normal">4499</span>
<span class="normal">4500</span>
<span class="normal">4501</span>
<span class="normal">4502</span>
<span class="normal">4503</span>
<span class="normal">4504</span>
<span class="normal">4505</span>
<span class="normal">4506</span>
<span class="normal">4507</span>
<span class="normal">4508</span>
<span class="normal">4509</span>
<span class="normal">4510</span>
<span class="normal">4511</span>
<span class="normal">4512</span>
<span class="normal">4513</span>
<span class="normal">4514</span>
<span class="normal">4515</span>
<span class="normal">4516</span>
<span class="normal">4517</span>
<span class="normal">4518</span>
<span class="normal">4519</span>
<span class="normal">4520</span>
<span class="normal">4521</span>
<span class="normal">4522</span>
<span class="normal">4523</span>
<span class="normal">4524</span>
<span class="normal">4525</span>
<span class="normal">4526</span>
<span class="normal">4527</span>
<span class="normal">4528</span>
<span class="normal">4529</span>
<span class="normal">4530</span>
<span class="normal">4531</span>
<span class="normal">4532</span>
<span class="normal">4533</span>
<span class="normal">4534</span>
<span class="normal">4535</span>
<span class="normal">4536</span>
<span class="normal">4537</span>
<span class="normal">4538</span>
<span class="normal">4539</span>
<span class="normal">4540</span>
<span class="normal">4541</span>
<span class="normal">4542</span>
<span class="normal">4543</span>
<span class="normal">4544</span>
<span class="normal">4545</span>
<span class="normal">4546</span>
<span class="normal">4547</span>
<span class="normal">4548</span>
<span class="normal">4549</span>
<span class="normal">4550</span>
<span class="normal">4551</span>
<span class="normal">4552</span>
<span class="normal">4553</span>
<span class="normal">4554</span>
<span class="normal">4555</span>
<span class="normal">4556</span>
<span class="normal">4557</span>
<span class="normal">4558</span>
<span class="normal">4559</span>
<span class="normal">4560</span>
<span class="normal">4561</span>
<span class="normal">4562</span>
<span class="normal">4563</span>
<span class="normal">4564</span>
<span class="normal">4565</span>
<span class="normal">4566</span>
<span class="normal">4567</span>
<span class="normal">4568</span>
<span class="normal">4569</span>
<span class="normal">4570</span>
<span class="normal">4571</span>
<span class="normal">4572</span>
<span class="normal">4573</span>
<span class="normal">4574</span>
<span class="normal">4575</span>
<span class="normal">4576</span>
<span class="normal">4577</span>
<span class="normal">4578</span>
<span class="normal">4579</span>
<span class="normal">4580</span>
<span class="normal">4581</span>
<span class="normal">4582</span>
<span class="normal">4583</span>
<span class="normal">4584</span>
<span class="normal">4585</span>
<span class="normal">4586</span>
<span class="normal">4587</span>
<span class="normal">4588</span>
<span class="normal">4589</span>
<span class="normal">4590</span>
<span class="normal">4591</span>
<span class="normal">4592</span>
<span class="normal">4593</span>
<span class="normal">4594</span>
<span class="normal">4595</span>
<span class="normal">4596</span>
<span class="normal">4597</span>
<span class="normal">4598</span>
<span class="normal">4599</span>
<span class="normal">4600</span>
<span class="normal">4601</span>
<span class="normal">4602</span>
<span class="normal">4603</span>
<span class="normal">4604</span>
<span class="normal">4605</span>
<span class="normal">4606</span>
<span class="normal">4607</span>
<span class="normal">4608</span>
<span class="normal">4609</span>
<span class="normal">4610</span>
<span class="normal">4611</span>
<span class="normal">4612</span>
<span class="normal">4613</span>
<span class="normal">4614</span>
<span class="normal">4615</span>
<span class="normal">4616</span>
<span class="normal">4617</span>
<span class="normal">4618</span>
<span class="normal">4619</span>
<span class="normal">4620</span>
<span class="normal">4621</span>
<span class="normal">4622</span>
<span class="normal">4623</span>
<span class="normal">4624</span>
<span class="normal">4625</span>
<span class="normal">4626</span>
<span class="normal">4627</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_training_data</span><span class="p">(</span>
    <span class="n">in_raster</span><span class="p">,</span>
    <span class="n">out_folder</span><span class="p">,</span>
    <span class="n">in_class_data</span><span class="p">,</span>
    <span class="n">image_chip_format</span><span class="o">=</span><span class="s2">&quot;GEOTIFF&quot;</span><span class="p">,</span>
    <span class="n">tile_size_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">tile_size_y</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">stride_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stride_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_nofeature_tiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">metadata_format</span><span class="o">=</span><span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">,</span>
    <span class="n">start_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">class_value_field</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">buffer_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">in_mask_polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rotation_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">reference_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">blacken_around_feature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">crop_mode</span><span class="o">=</span><span class="s2">&quot;FIXED_SIZE&quot;</span><span class="p">,</span>  <span class="c1"># Implemented but not fully used yet</span>
    <span class="n">in_raster2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">in_instance_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">instance_class_value_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Implemented but not fully used yet</span>
    <span class="n">min_polygon_overlap_ratio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export training data for deep learning using TorchGeo with progress bar.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_raster (str): Path to input raster image.</span>
<span class="sd">        out_folder (str): Output folder path where chips and labels will be saved.</span>
<span class="sd">        in_class_data (str): Path to vector file containing class polygons.</span>
<span class="sd">        image_chip_format (str): Output image format (PNG, JPEG, TIFF, GEOTIFF).</span>
<span class="sd">        tile_size_x (int): Width of image chips in pixels.</span>
<span class="sd">        tile_size_y (int): Height of image chips in pixels.</span>
<span class="sd">        stride_x (int): Horizontal stride between chips. If None, uses tile_size_x.</span>
<span class="sd">        stride_y (int): Vertical stride between chips. If None, uses tile_size_y.</span>
<span class="sd">        output_nofeature_tiles (bool): Whether to export chips without features.</span>
<span class="sd">        metadata_format (str): Output metadata format (PASCAL_VOC, KITTI, COCO).</span>
<span class="sd">        start_index (int): Starting index for chip filenames.</span>
<span class="sd">        class_value_field (str): Field name in in_class_data containing class values.</span>
<span class="sd">        buffer_radius (float): Buffer radius around features (in CRS units).</span>
<span class="sd">        in_mask_polygons (str): Path to vector file containing mask polygons.</span>
<span class="sd">        rotation_angle (float): Rotation angle in degrees.</span>
<span class="sd">        reference_system (str): Reference system code.</span>
<span class="sd">        blacken_around_feature (bool): Whether to mask areas outside of features.</span>
<span class="sd">        crop_mode (str): Crop mode (FIXED_SIZE, CENTERED_ON_FEATURE).</span>
<span class="sd">        in_raster2 (str): Path to secondary raster image.</span>
<span class="sd">        in_instance_data (str): Path to vector file containing instance polygons.</span>
<span class="sd">        instance_class_value_field (str): Field name in in_instance_data for instance classes.</span>
<span class="sd">        min_polygon_overlap_ratio (float): Minimum overlap ratio for polygons.</span>
<span class="sd">        all_touched (bool): Whether to use all_touched=True in rasterization.</span>
<span class="sd">        save_geotiff (bool): Whether to save as GeoTIFF with georeferencing.</span>
<span class="sd">        quiet (bool): If True, suppress most output messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create output directories</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Define annotation directories based on metadata format</span>
    <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">:</span>
        <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
        <span class="n">ann_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Initialize COCO annotations dictionary</span>
        <span class="n">coco_annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1"># Initialize statistics dictionary</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;tiles_with_features&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;feature_pixels&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Open raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raster info for </span><span class="si">{</span><span class="n">in_raster</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CRS: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Dimensions: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bounds: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Set defaults for stride if not provided</span>
        <span class="k">if</span> <span class="n">stride_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stride_x</span> <span class="o">=</span> <span class="n">tile_size_x</span>
        <span class="k">if</span> <span class="n">stride_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stride_y</span> <span class="o">=</span> <span class="n">tile_size_y</span>

        <span class="c1"># Calculate number of tiles in x and y directions</span>
        <span class="n">num_tiles_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_tiles_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">num_tiles_x</span> <span class="o">*</span> <span class="n">num_tiles_y</span>

        <span class="c1"># Read class data</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_class_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> features from </span><span class="si">{</span><span class="n">in_class_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available columns: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GeoJSON CRS: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if class_value_field exists</span>
        <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;WARNING: &#39;</span><span class="si">{</span><span class="n">class_value_field</span><span class="si">}</span><span class="s2">&#39; field not found in the input data. Using default class value 1.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Add a default class column</span>
            <span class="n">gdf</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">unique_classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Print unique classes for debugging</span>
            <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes: </span><span class="si">{</span><span class="n">unique_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># CRITICAL: Always reproject to match raster CRS to ensure proper alignment</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting features from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reference_system</span> <span class="ow">and</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">reference_system</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reprojecting features to specified reference system </span><span class="si">{</span><span class="n">reference_system</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">reference_system</span><span class="p">)</span>

        <span class="c1"># Check overlap between raster and vector data</span>
        <span class="n">raster_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">vector_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_bounds</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">vector_bounds</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;WARNING: The vector data doesn&#39;t intersect with the raster extent!&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster bounds: </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector bounds: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">raster_bounds</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">vector_bounds</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">vector_bounds</span><span class="o">.</span><span class="n">area</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap between raster and vector: </span><span class="si">{</span><span class="n">overlap</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Apply buffer if specified</span>
        <span class="k">if</span> <span class="n">buffer_radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_radius</span><span class="p">)</span>

        <span class="c1"># Initialize class mapping (ensure all classes are mapped to non-zero values)</span>
        <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)}</span>

        <span class="c1"># Store category info for COCO format</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cls_val</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
                <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">class_to_id</span><span class="p">[</span><span class="n">cls_val</span><span class="p">],</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cls_val</span><span class="p">),</span>
                        <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Load mask polygons if provided</span>
        <span class="n">mask_gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">in_mask_polygons</span><span class="p">:</span>
            <span class="n">mask_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_mask_polygons</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_system</span><span class="p">:</span>
                <span class="n">mask_gdf</span> <span class="o">=</span> <span class="n">mask_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">reference_system</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mask_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">mask_gdf</span> <span class="o">=</span> <span class="n">mask_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Process instance data if provided</span>
        <span class="n">instance_gdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">in_instance_data</span><span class="p">:</span>
            <span class="n">instance_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">in_instance_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_system</span><span class="p">:</span>
                <span class="n">instance_gdf</span> <span class="o">=</span> <span class="n">instance_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">reference_system</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">instance_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">instance_gdf</span> <span class="o">=</span> <span class="n">instance_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Load secondary raster if provided</span>
        <span class="n">src2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">in_raster2</span><span class="p">:</span>
            <span class="n">src2</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_raster2</span><span class="p">)</span>

        <span class="c1"># Set up augmentation if rotation is specified</span>
        <span class="n">augmentation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rotation_angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Fixed: Added data_keys parameter to AugmentationSequential</span>
            <span class="n">augmentation</span> <span class="o">=</span> <span class="n">torchgeo</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AugmentationSequential</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">RandomRotation</span><span class="p">(</span><span class="n">rotation_angle</span><span class="p">)]),</span>
                <span class="n">data_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>  <span class="c1"># Add data_keys parameter</span>
            <span class="p">)</span>

        <span class="c1"># Initialize annotation ID for COCO format</span>
        <span class="n">ann_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Create progress bar</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_tiles</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generating tiles (with features: 0)&quot;</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> [</span><span class="si">{elapsed}</span><span class="s2">&lt;</span><span class="si">{remaining}</span><span class="s2">, </span><span class="si">{rate_fmt}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Generate tiles</span>
        <span class="n">chip_index</span> <span class="o">=</span> <span class="n">start_index</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tiles_x</span><span class="p">):</span>
                <span class="c1"># Calculate window coordinates</span>
                <span class="n">window_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">stride_x</span>
                <span class="n">window_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">stride_y</span>

                <span class="c1"># Adjust for edge cases</span>
                <span class="k">if</span> <span class="n">window_x</span> <span class="o">+</span> <span class="n">tile_size_x</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                    <span class="n">window_x</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size_x</span>
                <span class="k">if</span> <span class="n">window_y</span> <span class="o">+</span> <span class="n">tile_size_y</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                    <span class="n">window_y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size_y</span>

                <span class="c1"># Adjust window based on crop_mode</span>
                <span class="k">if</span> <span class="n">crop_mode</span> <span class="o">==</span> <span class="s2">&quot;CENTERED_ON_FEATURE&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Find the nearest feature to the center of this window</span>
                    <span class="n">window_center_x</span> <span class="o">=</span> <span class="n">window_x</span> <span class="o">+</span> <span class="n">tile_size_x</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">window_center_y</span> <span class="o">=</span> <span class="n">window_y</span> <span class="o">+</span> <span class="n">tile_size_y</span> <span class="o">//</span> <span class="mi">2</span>

                    <span class="c1"># Convert center to world coordinates</span>
                    <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">window_center_y</span><span class="p">,</span> <span class="n">window_center_x</span><span class="p">)</span>
                    <span class="n">center_point</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">([</span><span class="n">center_x</span><span class="p">],</span> <span class="p">[</span><span class="n">center_y</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Find nearest feature</span>
                    <span class="n">distances</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">center_point</span><span class="p">)</span>
                    <span class="n">nearest_idx</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
                    <span class="n">nearest_feature</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">nearest_idx</span><span class="p">]</span>

                    <span class="c1"># Get centroid of nearest feature</span>
                    <span class="n">feature_centroid</span> <span class="o">=</span> <span class="n">nearest_feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>

                    <span class="c1"># Convert feature centroid to pixel coordinates</span>
                    <span class="n">feature_row</span><span class="p">,</span> <span class="n">feature_col</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                        <span class="n">feature_centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">feature_centroid</span><span class="o">.</span><span class="n">y</span>
                    <span class="p">)</span>

                    <span class="c1"># Adjust window to center on feature</span>
                    <span class="n">window_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size_x</span><span class="p">,</span> <span class="n">feature_col</span> <span class="o">-</span> <span class="n">tile_size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">window_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size_y</span><span class="p">,</span> <span class="n">feature_row</span> <span class="o">-</span> <span class="n">tile_size_y</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Define window</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">window_x</span><span class="p">,</span> <span class="n">window_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">,</span> <span class="n">tile_size_y</span><span class="p">)</span>

                <span class="c1"># Get window transform and bounds in source CRS</span>
                <span class="n">window_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Calculate window bounds more explicitly and accurately</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Upper left x</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Upper left y</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">tile_size_x</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Add width</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">maxy</span> <span class="o">+</span> <span class="n">tile_size_y</span> <span class="o">*</span> <span class="n">window_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">)</span>  <span class="c1"># Add height (note: transform[4] is typically negative)</span>

                <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

                <span class="c1"># Apply rotation if specified</span>
                <span class="k">if</span> <span class="n">rotation_angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">window_bounds</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span>
                        <span class="n">window_bounds</span><span class="p">,</span> <span class="n">rotation_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Find features that intersect with window</span>
                <span class="n">window_features</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)]</span>

                <span class="c1"># Process instance data if provided</span>
                <span class="n">window_instances</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">instance_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">instance_class_value_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">window_instances</span> <span class="o">=</span> <span class="n">instance_gdf</span><span class="p">[</span>
                        <span class="n">instance_gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">window_instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances in tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                <span class="c1"># Skip if no features and output_nofeature_tiles is False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">output_nofeature_tiles</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still update progress bar</span>
                    <span class="k">continue</span>

                <span class="c1"># Check polygon overlap ratio if specified</span>
                <span class="k">if</span> <span class="n">min_polygon_overlap_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">valid_features</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">overlap_ratio</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
                            <span class="o">/</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">overlap_ratio</span> <span class="o">&gt;=</span> <span class="n">min_polygon_overlap_ratio</span><span class="p">:</span>
                            <span class="n">valid_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">window_features</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">valid_features</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">output_nofeature_tiles</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still update progress bar</span>
                        <span class="k">continue</span>

                <span class="c1"># Apply mask if provided</span>
                <span class="k">if</span> <span class="n">mask_gdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mask_features</span> <span class="o">=</span> <span class="n">mask_gdf</span><span class="p">[</span><span class="n">mask_gdf</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still update progress bar</span>
                        <span class="k">continue</span>

                <span class="c1"># Read image data - keep original for GeoTIFF export</span>
                <span class="n">orig_image_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># Create a copy for processing</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">orig_image_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># Normalize image data for processing</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">band_max</span> <span class="o">&gt;</span> <span class="n">band_min</span><span class="p">:</span>
                        <span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">band_max</span> <span class="o">-</span> <span class="n">band_min</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                        <span class="p">)</span>

                <span class="c1"># Read secondary image data if provided</span>
                <span class="k">if</span> <span class="n">src2</span><span class="p">:</span>
                    <span class="n">image_data2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                    <span class="c1"># Stack the two images</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">image_data</span><span class="p">,</span> <span class="n">image_data2</span><span class="p">))</span>

                <span class="c1"># Apply blacken_around_feature if needed</span>
                <span class="k">if</span> <span class="n">blacken_around_feature</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Project feature to pixel coordinates</span>
                        <span class="n">feature_pixels</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                            <span class="p">[(</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
                            <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span>
                            <span class="n">transform</span><span class="o">=</span><span class="n">window_transform</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">feature_pixels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>

                    <span class="c1"># Apply mask to image</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">temp</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">image_data</span><span class="p">[</span><span class="n">band</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span>

                <span class="c1"># Apply rotation if specified</span>
                <span class="k">if</span> <span class="n">augmentation</span><span class="p">:</span>
                    <span class="c1"># Convert to torch tensor for augmentation</span>
                    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span>
                        <span class="mi">0</span>
                    <span class="p">)</span>  <span class="c1"># Add batch dimension</span>
                    <span class="c1"># Apply augmentation with proper data format</span>
                    <span class="n">augmented</span> <span class="o">=</span> <span class="n">augmentation</span><span class="p">({</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_tensor</span><span class="p">})</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">augmented</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="p">)</span>  <span class="c1"># Remove batch dimension</span>

                <span class="c1"># Create a processed version for regular image formats</span>
                <span class="n">processed_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_data</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="c1"># Create label mask</span>
                <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">has_features</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Get class value</span>
                        <span class="n">class_val</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">class_value_field</span> <span class="ow">in</span> <span class="n">feature</span>
                            <span class="k">else</span> <span class="mi">1</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="c1"># If class is a string, use its position in the unique classes list</span>
                            <span class="n">class_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If class is already a number, use it directly</span>
                            <span class="n">class_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">class_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">class_val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                        <span class="c1"># Get the geometry in pixel coordinates</span>
                        <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Rasterize the feature</span>
                                <span class="n">feature_mask</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                                    <span class="p">[(</span><span class="n">geom</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)],</span>
                                    <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span>
                                    <span class="n">transform</span><span class="o">=</span><span class="n">window_transform</span><span class="p">,</span>
                                    <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="c1"># Update mask with higher class values taking precedence</span>
                                <span class="n">label_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">label_mask</span><span class="p">,</span> <span class="n">feature_mask</span><span class="p">)</span>

                                <span class="c1"># Check if any pixels were added</span>
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">feature_mask</span><span class="p">):</span>
                                    <span class="n">has_features</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rasterizing feature </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Save as GeoTIFF if requested</span>
                <span class="k">if</span> <span class="n">save_geotiff</span> <span class="ow">or</span> <span class="n">image_chip_format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;TIFF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TIF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;GEOTIFF&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="c1"># Standardize extension to .tif for GeoTIFF files</span>
                    <span class="n">image_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>

                    <span class="c1"># Create profile for the GeoTIFF</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size_y</span><span class="p">,</span>
                            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size_x</span><span class="p">,</span>
                            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">orig_image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="c1"># Save the GeoTIFF with original data</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">orig_image_data</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ERROR saving image GeoTIFF for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For non-GeoTIFF formats, use PIL to save the image</span>
                    <span class="n">image_filename</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">image_chip_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>

                    <span class="c1"># Create PIL image for saving</span>
                    <span class="k">if</span> <span class="n">processed_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">processed_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">processed_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># For RGB, need to transpose and make sure it&#39;s the right data type</span>
                        <span class="n">rgb_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">processed_image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For multiband images, save only RGB or first three bands</span>
                        <span class="n">rgb_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">processed_image</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_data</span><span class="p">)</span>

                    <span class="c1"># Save image</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving image for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Save label as GeoTIFF</span>
                <span class="n">label_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">label_filename</span><span class="p">)</span>

                <span class="c1"># Create profile for label GeoTIFF</span>
                <span class="n">label_profile</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size_y</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size_x</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">window_transform</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Save label GeoTIFF</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">label_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">has_features</span><span class="p">:</span>
                        <span class="n">pixel_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">label_mask</span><span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;feature_pixels&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pixel_count</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving label for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Also save a PNG version for easy visualization if requested</span>
                <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Ensure correct data type for PIL</span>
                        <span class="n">png_label</span> <span class="o">=</span> <span class="n">label_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                        <span class="n">label_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">png_label</span><span class="p">)</span>
                        <span class="n">label_png_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.png&quot;</span>
                        <span class="p">)</span>
                        <span class="n">label_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">label_png_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ERROR saving PNG label for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;  Label mask shape: </span><span class="si">{</span><span class="n">label_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">label_mask</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="c1"># Try again with explicit conversion</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Alternative approach for problematic arrays</span>
                                <span class="n">png_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="n">tile_size_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                                <span class="p">)</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">png_data</span><span class="p">,</span> <span class="n">label_mask</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s2">&quot;unsafe&quot;</span><span class="p">)</span>
                                <span class="n">label_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">png_data</span><span class="p">)</span>
                                <span class="n">label_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">label_png_path</span><span class="p">)</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;  Succeeded using alternative conversion method&quot;</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                                <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Second attempt also failed: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Generate annotations</span>
                <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;PASCAL_VOC&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Create XML annotation</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;folder&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;images&quot;</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">image_filename</span>

                    <span class="n">size</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>

                    <span class="c1"># Add georeference information</span>
                    <span class="n">geo</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;georeference&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;crs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">window_transform</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1"># Convert feature geometry to pixel coordinates</span>
                        <span class="n">feature_bounds</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get pixel coordinates of bounds</span>
                        <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">bounds</span>

                        <span class="c1"># Convert to pixel coordinates</span>
                        <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                        <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                        <span class="c1"># Ensure coordinates are within bounds</span>
                        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                        <span class="c1"># Skip if box is too small</span>
                        <span class="k">if</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;difficult&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

                        <span class="n">bbox</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;bndbox&quot;</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
                        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>

                    <span class="c1"># Save XML</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                        <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">chip_index</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ERROR saving XML annotation for tile </span><span class="si">{</span><span class="n">chip_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Add image info</span>
                    <span class="n">image_id</span> <span class="o">=</span> <span class="n">chip_index</span>
                    <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">image_filename</span><span class="p">,</span>
                            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">tile_size_x</span><span class="p">,</span>
                            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">tile_size_y</span><span class="p">,</span>
                            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">),</span>
                            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">window_transform</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="c1"># Add annotations for each feature</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">window_features</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">feature_bounds</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">window_bounds</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Get pixel coordinates of bounds</span>
                        <span class="n">minx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">,</span> <span class="n">maxx_f</span><span class="p">,</span> <span class="n">maxy_f</span> <span class="o">=</span> <span class="n">feature_bounds</span><span class="o">.</span><span class="n">bounds</span>

                        <span class="c1"># Convert to pixel coordinates</span>
                        <span class="n">col_min</span><span class="p">,</span> <span class="n">row_min</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">minx_f</span><span class="p">,</span> <span class="n">maxy_f</span><span class="p">)</span>
                        <span class="n">col_max</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="o">~</span><span class="n">window_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxx_f</span><span class="p">,</span> <span class="n">miny_f</span><span class="p">)</span>

                        <span class="c1"># Ensure coordinates are within bounds</span>
                        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_min</span><span class="p">)))</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_min</span><span class="p">)))</span>
                        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_max</span><span class="p">)))</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_size_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_max</span><span class="p">)))</span>

                        <span class="c1"># Skip if box is too small</span>
                        <span class="k">if</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
                        <span class="n">height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>

                        <span class="c1"># Add annotation</span>
                        <span class="n">ann_id</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">category_id</span> <span class="o">=</span> <span class="n">class_to_id</span><span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="n">class_value_field</span><span class="p">]]</span>

                        <span class="n">coco_annotations</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ann_id</span><span class="p">,</span>
                                <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                                <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="n">category_id</span><span class="p">,</span>
                                <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span>
                                <span class="s2">&quot;iscrowd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                <span class="c1"># Update progress bar</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, With features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">chip_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Close progress bar</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Save COCO annotations if applicable</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s2">&quot;COCO&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir</span><span class="p">,</span> <span class="s2">&quot;instances.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coco_annotations</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR saving COCO annotations: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Close secondary raster if opened</span>
        <span class="k">if</span> <span class="n">src2</span><span class="p">:</span>
            <span class="n">src2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Print summary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Export Summary -------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles exported: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Tiles with features: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tiles&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;tiles_with_features&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Average feature pixels per tile: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;feature_pixels&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tiles_with_features&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors encountered: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to: </span><span class="si">{</span><span class="n">out_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Verify georeference in a sample image and label</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_tiles&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">------- Georeference Verification -------&quot;</span><span class="p">)</span>
            <span class="n">sample_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
            <span class="n">sample_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_image</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_image</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image CRS: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image transform: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Image has georeference: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Image dimensions: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying image georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sample_label</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_label</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbl</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label CRS: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label transform: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Label has georeference: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">crs</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Label dimensions: </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands, </span><span class="si">{</span><span class="n">lbl</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> type&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying label georeference: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return statistics</span>
    <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">out_folder</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.geojson_to_coords" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">geojson_to_coords</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">src_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">)</span></code>

<a href="#geoai.utils.geojson_to_coords" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a geojson file or a dictionary of feature collection to a list of centroid coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>geojson</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The geojson file path or a dictionary of feature collection.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>src_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source CRS. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dst_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The destination CRS. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of centroid coordinates in the format of [[x1, y1], [x2, y2], ...]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7192</span>
<span class="normal">7193</span>
<span class="normal">7194</span>
<span class="normal">7195</span>
<span class="normal">7196</span>
<span class="normal">7197</span>
<span class="normal">7198</span>
<span class="normal">7199</span>
<span class="normal">7200</span>
<span class="normal">7201</span>
<span class="normal">7202</span>
<span class="normal">7203</span>
<span class="normal">7204</span>
<span class="normal">7205</span>
<span class="normal">7206</span>
<span class="normal">7207</span>
<span class="normal">7208</span>
<span class="normal">7209</span>
<span class="normal">7210</span>
<span class="normal">7211</span>
<span class="normal">7212</span>
<span class="normal">7213</span>
<span class="normal">7214</span>
<span class="normal">7215</span>
<span class="normal">7216</span>
<span class="normal">7217</span>
<span class="normal">7218</span>
<span class="normal">7219</span>
<span class="normal">7220</span>
<span class="normal">7221</span>
<span class="normal">7222</span>
<span class="normal">7223</span>
<span class="normal">7224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">geojson_to_coords</span><span class="p">(</span>
    <span class="n">geojson</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a geojson file or a dictionary of feature collection to a list of centroid coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        geojson (str | dict): The geojson file path or a dictionary of feature collection.</span>
<span class="sd">        src_crs (str, optional): The source CRS. Defaults to &quot;epsg:4326&quot;.</span>
<span class="sd">        dst_crs (str, optional): The destination CRS. Defaults to &quot;epsg:4326&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of centroid coordinates in the format of [[x1, y1], [x2, y2], ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">geojson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">geojson</span><span class="p">)</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>
    <span class="n">centroid_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">centroids</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">src_crs</span> <span class="o">!=</span> <span class="n">dst_crs</span><span class="p">:</span>
        <span class="n">centroid_list</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">centroid_list</span><span class="p">],</span>
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">centroid_list</span><span class="p">],</span>
            <span class="n">src_crs</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">centroid_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centroid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">centroid_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.geojson_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">geojson_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">geojson</span><span class="p">,</span> <span class="n">coord_crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.geojson_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a geojson file or a dictionary of feature collection to a list of pixel coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>geojson</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The geojson file path or a dictionary of feature collection.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coord_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coordinate CRS of the input coordinates. Defaults to "epsg:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;epsg:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rasterio.transform.rowcol.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of pixel coordinates in the format of [[x1, y1], [x2, y2], ...]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7485</span>
<span class="normal">7486</span>
<span class="normal">7487</span>
<span class="normal">7488</span>
<span class="normal">7489</span>
<span class="normal">7490</span>
<span class="normal">7491</span>
<span class="normal">7492</span>
<span class="normal">7493</span>
<span class="normal">7494</span>
<span class="normal">7495</span>
<span class="normal">7496</span>
<span class="normal">7497</span>
<span class="normal">7498</span>
<span class="normal">7499</span>
<span class="normal">7500</span>
<span class="normal">7501</span>
<span class="normal">7502</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">geojson_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">geojson</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a geojson file or a dictionary of feature collection to a list of pixel coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp: The source raster file path.</span>
<span class="sd">        geojson: The geojson file path or a dictionary of feature collection.</span>
<span class="sd">        coord_crs: The coordinate CRS of the input coordinates. Defaults to &quot;epsg:4326&quot;.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rasterio.transform.rowcol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of pixel coordinates in the format of [[x1, y1], [x2, y2], ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">src_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">geojson_to_coords</span><span class="p">(</span><span class="n">geojson</span><span class="p">,</span> <span class="n">coord_crs</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coords_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_device" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_device</span><span class="p">()</span></code>

<a href="#geoai.utils.get_device" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Returns the best available device for deep learning in the order:
CUDA (NVIDIA GPU) &gt; MPS (Apple Silicon GPU) &gt; CPU</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7605</span>
<span class="normal">7606</span>
<span class="normal">7607</span>
<span class="normal">7608</span>
<span class="normal">7609</span>
<span class="normal">7610</span>
<span class="normal">7611</span>
<span class="normal">7612</span>
<span class="normal">7613</span>
<span class="normal">7614</span>
<span class="normal">7615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_device</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the best available device for deep learning in the order:</span>
<span class="sd">    CUDA (NVIDIA GPU) &gt; MPS (Apple Silicon GPU) &gt; CPU</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="p">,</span> <span class="s2">&quot;mps&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;mps&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_raster_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span></code>

<a href="#geoai.utils.get_raster_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Display basic information about a raster dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the raster</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display basic information about a raster dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the raster dataset</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get basic metadata</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span> <span class="k">else</span> <span class="s2">&quot;No CRS defined&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Calculate statistics for each band</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">band_stats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span>
            <span class="p">}</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_stats</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;band_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_raster_info_gdal" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_info_gdal</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span></code>

<a href="#geoai.utils.get_raster_info_gdal" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get basic information about a raster dataset using GDAL.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the raster,
or None if the file cannot be opened</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_info_gdal</span><span class="p">(</span><span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get basic information about a raster dataset using GDAL.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the raster,</span>
<span class="sd">            or None if the file cannot be opened</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">gdal</span>

    <span class="c1"># Open the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Could not open </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Get basic information</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span><span class="o">.</span><span class="n">ShortName</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">,</span>
        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">,</span>
        <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">(),</span>
        <span class="s2">&quot;geotransform&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># Calculate resolution</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gt</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Get band information</span>
    <span class="n">bands_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetStatistics</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">band_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDataTypeName</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">DataType</span><span class="p">),</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">bands_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_info</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands_info</span>

    <span class="c1"># Close the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_raster_resolution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_resolution</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span></code>

<a href="#geoai.utils.get_raster_resolution" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get pixel resolution from the raster using rasterio.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the raster image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of (x resolution, y resolution).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7752</span>
<span class="normal">7753</span>
<span class="normal">7754</span>
<span class="normal">7755</span>
<span class="normal">7756</span>
<span class="normal">7757</span>
<span class="normal">7758</span>
<span class="normal">7759</span>
<span class="normal">7760</span>
<span class="normal">7761</span>
<span class="normal">7762</span>
<span class="normal">7763</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_resolution</span><span class="p">(</span><span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get pixel resolution from the raster using rasterio.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_path: The path to the raster image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of (x resolution, y resolution).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">res</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_raster_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_raster_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.utils.get_raster_stats" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate statistics for each band in a raster dataset.</p>
<p>This function computes min, max, mean, and standard deviation values
for each band in the provided raster, returning results in a dictionary
with lists for each statistic type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>divide_by</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to divide pixel values by.
Defaults to 1.0, which keeps the original pixel</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing lists of statistics with keys:
- 'min': List of minimum values for each band
- 'max': List of maximum values for each band
- 'mean': List of mean values for each band
- 'std': List of standard deviation values for each band</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_raster_stats</span><span class="p">(</span><span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">divide_by</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate statistics for each band in a raster dataset.</span>

<span class="sd">    This function computes min, max, mean, and standard deviation values</span>
<span class="sd">    for each band in the provided raster, returning results in a dictionary</span>
<span class="sd">    with lists for each statistic type.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>
<span class="sd">        divide_by (float, optional): Value to divide pixel values by.</span>
<span class="sd">            Defaults to 1.0, which keeps the original pixel</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing lists of statistics with keys:</span>
<span class="sd">            - &#39;min&#39;: List of minimum values for each band</span>
<span class="sd">            - &#39;max&#39;: List of maximum values for each band</span>
<span class="sd">            - &#39;mean&#39;: List of mean values for each band</span>
<span class="sd">            - &#39;std&#39;: List of standard deviation values for each band</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize the results dictionary with empty lists</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1"># Open the raster dataset</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Calculate statistics for each band</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Append statistics for this band to each list</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">/</span> <span class="n">divide_by</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_vector_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span></code>

<a href="#geoai.utils.get_vector_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Display basic information about a vector dataset using GeoPandas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the vector dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display basic information about a vector dataset using GeoPandas.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the vector dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the vector dataset</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vector_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get basic metadata</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">vector_path</span><span class="p">,</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>  <span class="c1"># Format from extension</span>
        <span class="s2">&quot;feature_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">),</span>
        <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">),</span>
        <span class="s2">&quot;geometry_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()),</span>
        <span class="s2">&quot;attribute_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Subtract the geometry column</span>
        <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># Add statistics about numeric attributes</span>
    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">attribute_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span>
            <span class="n">attribute_stats</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                <span class="s2">&quot;null_count&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">}</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;attribute_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute_stats</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.get_vector_info_ogr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vector_info_ogr</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span></code>

<a href="#geoai.utils.get_vector_info_ogr" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get basic information about a vector dataset using OGR.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the basic information about the vector dataset,
or None if the file cannot be opened</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_vector_info_ogr</span><span class="p">(</span><span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get basic information about a vector dataset using OGR.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the basic information about the vector dataset,</span>
<span class="sd">            or None if the file cannot be opened</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">ogr</span>

    <span class="c1"># Register all OGR drivers</span>
    <span class="n">ogr</span><span class="o">.</span><span class="n">RegisterAll</span><span class="p">()</span>

    <span class="c1"># Open the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Could not open </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Basic dataset information</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">vector_path</span><span class="p">,</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
        <span class="s2">&quot;layer_count&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetLayerCount</span><span class="p">(),</span>
        <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># Extract information for each layer</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetLayerCount</span><span class="p">()):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetLayer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">layer_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
            <span class="s2">&quot;feature_count&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">(),</span>
            <span class="s2">&quot;geometry_type&quot;</span><span class="p">:</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GeometryTypeToName</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetGeomType</span><span class="p">()),</span>
            <span class="s2">&quot;spatial_ref&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">()</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">()</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetExtent</span><span class="p">(),</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Get field information</span>
        <span class="n">defn</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">defn</span><span class="o">.</span><span class="n">GetFieldCount</span><span class="p">()):</span>
            <span class="n">field_defn</span> <span class="o">=</span> <span class="n">defn</span><span class="o">.</span><span class="n">GetFieldDefn</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">field_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetTypeName</span><span class="p">(),</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetWidth</span><span class="p">(),</span>
                <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">field_defn</span><span class="o">.</span><span class="n">GetPrecision</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="n">layer_info</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_info</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_info</span><span class="p">)</span>

    <span class="c1"># Close the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.hybrid_regularization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">hybrid_regularization</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">)</span></code>

<a href="#geoai.utils.hybrid_regularization" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>A comprehensive hybrid approach to building footprint regularization.</p>
<p>Applies different strategies based on building characteristics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>building_polygons</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons containing building footprints</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hybrid_regularization</span><span class="p">(</span>
    <span class="n">building_polygons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A comprehensive hybrid approach to building footprint regularization.</span>

<span class="sd">    Applies different strategies based on building characteristics.</span>

<span class="sd">    Args:</span>
<span class="sd">        building_polygons: GeoDataFrame or list of shapely Polygons containing building footprints</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame or list of shapely Polygons with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Use minimum_rotated_rectangle instead of oriented_envelope</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.minimum_rotated_rectangle</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimum_rotated_rectangle</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># For older Shapely versions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">minimum_rotated_rectangle</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calculate the minimum rotated rectangle for a geometry&quot;&quot;&quot;</span>
            <span class="c1"># For older Shapely versions, implement a simple version</span>
            <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">minimum_rotated_rectangle</span>

    <span class="c1"># Determine input type for correct return</span>
    <span class="n">is_gdf</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)</span>

    <span class="c1"># Extract geometries if GeoDataFrame</span>
    <span class="k">if</span> <span class="n">is_gdf</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">geom_objects</span><span class="p">:</span>
        <span class="c1"># 1. Analyze building characteristics</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">building</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Calculate shape complexity metrics</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>

        <span class="c1"># Calculate dominant angle</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">segment_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">segment_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># Weight angles by segment length</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">segment_angles</span> <span class="o">%</span> <span class="mi">180</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">segment_lengths</span>
        <span class="p">)</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">dominant_angle</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">)]</span>

        <span class="c1"># Check if building is close to orthogonal</span>
        <span class="n">is_orthogonal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dominant_angle</span> <span class="o">%</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span> <span class="o">-</span> <span class="p">(</span><span class="n">dominant_angle</span> <span class="o">%</span> <span class="mi">45</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">5</span>

        <span class="c1"># 2. Apply appropriate regularization strategy</span>
        <span class="k">if</span> <span class="n">complexity</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="c1"># Complex buildings: use minimum rotated rectangle</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimum_rotated_rectangle</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_orthogonal</span><span class="p">:</span>
            <span class="c1"># Near-orthogonal buildings: orthogonalize in place</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Create orthogonal hull in rotated space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">ortho_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">ortho_hull</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Diagonal buildings: use custom approach for diagonal buildings</span>
            <span class="c1"># Rotate to align with axes</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Simplify in rotated space</span>
            <span class="n">simplified</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Get the bounds in rotated space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">simplified</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="c1"># Create a rectangular hull in rotated space</span>
            <span class="n">rect_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">),</span> <span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="c1"># Rotate back to original orientation</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">rect_poly</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Return in same format as input</span>
    <span class="k">if</span> <span class="n">is_gdf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">building_polygons</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.inspect_pth_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">inspect_pth_file</span><span class="p">(</span><span class="n">pth_path</span><span class="p">)</span></code>

<a href="#geoai.utils.inspect_pth_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Inspect a PyTorch .pth model file to determine its architecture.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pth_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the .pth file to inspect</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the model architecture</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6682</span>
<span class="normal">6683</span>
<span class="normal">6684</span>
<span class="normal">6685</span>
<span class="normal">6686</span>
<span class="normal">6687</span>
<span class="normal">6688</span>
<span class="normal">6689</span>
<span class="normal">6690</span>
<span class="normal">6691</span>
<span class="normal">6692</span>
<span class="normal">6693</span>
<span class="normal">6694</span>
<span class="normal">6695</span>
<span class="normal">6696</span>
<span class="normal">6697</span>
<span class="normal">6698</span>
<span class="normal">6699</span>
<span class="normal">6700</span>
<span class="normal">6701</span>
<span class="normal">6702</span>
<span class="normal">6703</span>
<span class="normal">6704</span>
<span class="normal">6705</span>
<span class="normal">6706</span>
<span class="normal">6707</span>
<span class="normal">6708</span>
<span class="normal">6709</span>
<span class="normal">6710</span>
<span class="normal">6711</span>
<span class="normal">6712</span>
<span class="normal">6713</span>
<span class="normal">6714</span>
<span class="normal">6715</span>
<span class="normal">6716</span>
<span class="normal">6717</span>
<span class="normal">6718</span>
<span class="normal">6719</span>
<span class="normal">6720</span>
<span class="normal">6721</span>
<span class="normal">6722</span>
<span class="normal">6723</span>
<span class="normal">6724</span>
<span class="normal">6725</span>
<span class="normal">6726</span>
<span class="normal">6727</span>
<span class="normal">6728</span>
<span class="normal">6729</span>
<span class="normal">6730</span>
<span class="normal">6731</span>
<span class="normal">6732</span>
<span class="normal">6733</span>
<span class="normal">6734</span>
<span class="normal">6735</span>
<span class="normal">6736</span>
<span class="normal">6737</span>
<span class="normal">6738</span>
<span class="normal">6739</span>
<span class="normal">6740</span>
<span class="normal">6741</span>
<span class="normal">6742</span>
<span class="normal">6743</span>
<span class="normal">6744</span>
<span class="normal">6745</span>
<span class="normal">6746</span>
<span class="normal">6747</span>
<span class="normal">6748</span>
<span class="normal">6749</span>
<span class="normal">6750</span>
<span class="normal">6751</span>
<span class="normal">6752</span>
<span class="normal">6753</span>
<span class="normal">6754</span>
<span class="normal">6755</span>
<span class="normal">6756</span>
<span class="normal">6757</span>
<span class="normal">6758</span>
<span class="normal">6759</span>
<span class="normal">6760</span>
<span class="normal">6761</span>
<span class="normal">6762</span>
<span class="normal">6763</span>
<span class="normal">6764</span>
<span class="normal">6765</span>
<span class="normal">6766</span>
<span class="normal">6767</span>
<span class="normal">6768</span>
<span class="normal">6769</span>
<span class="normal">6770</span>
<span class="normal">6771</span>
<span class="normal">6772</span>
<span class="normal">6773</span>
<span class="normal">6774</span>
<span class="normal">6775</span>
<span class="normal">6776</span>
<span class="normal">6777</span>
<span class="normal">6778</span>
<span class="normal">6779</span>
<span class="normal">6780</span>
<span class="normal">6781</span>
<span class="normal">6782</span>
<span class="normal">6783</span>
<span class="normal">6784</span>
<span class="normal">6785</span>
<span class="normal">6786</span>
<span class="normal">6787</span>
<span class="normal">6788</span>
<span class="normal">6789</span>
<span class="normal">6790</span>
<span class="normal">6791</span>
<span class="normal">6792</span>
<span class="normal">6793</span>
<span class="normal">6794</span>
<span class="normal">6795</span>
<span class="normal">6796</span>
<span class="normal">6797</span>
<span class="normal">6798</span>
<span class="normal">6799</span>
<span class="normal">6800</span>
<span class="normal">6801</span>
<span class="normal">6802</span>
<span class="normal">6803</span>
<span class="normal">6804</span>
<span class="normal">6805</span>
<span class="normal">6806</span>
<span class="normal">6807</span>
<span class="normal">6808</span>
<span class="normal">6809</span>
<span class="normal">6810</span>
<span class="normal">6811</span>
<span class="normal">6812</span>
<span class="normal">6813</span>
<span class="normal">6814</span>
<span class="normal">6815</span>
<span class="normal">6816</span>
<span class="normal">6817</span>
<span class="normal">6818</span>
<span class="normal">6819</span>
<span class="normal">6820</span>
<span class="normal">6821</span>
<span class="normal">6822</span>
<span class="normal">6823</span>
<span class="normal">6824</span>
<span class="normal">6825</span>
<span class="normal">6826</span>
<span class="normal">6827</span>
<span class="normal">6828</span>
<span class="normal">6829</span>
<span class="normal">6830</span>
<span class="normal">6831</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inspect_pth_file</span><span class="p">(</span><span class="n">pth_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect a PyTorch .pth model file to determine its architecture.</span>

<span class="sd">    Args:</span>
<span class="sd">        pth_path: Path to the .pth file to inspect</span>

<span class="sd">    Returns:</span>
<span class="sd">        Information about the model architecture</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pth_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: File </span><span class="si">{</span><span class="n">pth_path</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Load the checkpoint</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pth_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inspecting model file: </span><span class="si">{</span><span class="n">pth_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if it&#39;s a state_dict or a complete model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;state_dict&quot;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &#39;state_dict&#39; key in the checkpoint.&quot;</span><span class="p">)</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;model_state_dict&quot;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &#39;model_state_dict&#39; key in the checkpoint.&quot;</span><span class="p">)</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assuming file contains a direct state_dict.&quot;</span><span class="p">)</span>
                <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span>

            <span class="c1"># Print the keys in the checkpoint</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checkpoint contains the following keys:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (dictionary with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">}</span><span class="s2"> items)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (shape/size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="w"> </span><span class="nb">tuple</span><span class="p">))</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Try to infer the model architecture from the state_dict keys</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analyzing model architecture from state_dict...&quot;</span><span class="p">)</span>

            <span class="c1"># Extract layer keys for analysis</span>
            <span class="n">layer_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Print the first few layer keys to understand naming pattern</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 10 layer names in state_dict:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer_keys</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (shape: </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Look for architecture indicators in the keys</span>
            <span class="n">architecture_indicators</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;conv&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;bn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;layer&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;fc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;backbone&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;encoder&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;decoder&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;unet&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;resnet&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;classifier&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;deeplab&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;fcn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layer_keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">architecture_indicators</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">architecture_indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Architecture indicators found in layer names:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">architecture_indicators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- &#39;</span><span class="si">{</span><span class="n">indicator</span><span class="si">}</span><span class="s2">&#39; appears </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> times&quot;</span><span class="p">)</span>

            <span class="c1"># Count total parameters</span>
            <span class="n">total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total parameters: </span><span class="si">{</span><span class="n">total_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Try to load the model with different architectures</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attempting to match with common architectures...&quot;</span><span class="p">)</span>

            <span class="c1"># Try to identify if it&#39;s a segmentation model</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;out&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">layer_keys</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model appears to be a segmentation model.&quot;</span><span class="p">)</span>

                <span class="c1"># Check if it might be a UNet</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;encoder&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;decoder&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Architecture seems to be a UNet-based model with encoder-decoder structure.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Check for FCN or DeepLab indicators</span>
                <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;fcn&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Architecture seems to be FCN-based (Fully Convolutional Network).&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;deeplab&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Architecture seems to be DeepLab-based.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;backbone&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Model has a backbone architecture, likely a modern segmentation model.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Try to infer output classes from the final layer</span>
            <span class="n">output_layer_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">layer_keys</span> <span class="k">if</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.out.weight&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">output_layer_keys</span><span class="p">:</span>
                <span class="n">output_shape</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">output_layer_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">num_classes</span> <span class="o">=</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model likely has </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2"> output classes.&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SUMMARY:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model appears to be&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;unet&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a UNet architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;fcn&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;an FCN architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;deeplab&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a DeepLab architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">architecture_indicators</span><span class="p">[</span><span class="s2">&quot;resnet&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ResNet-based.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a custom architecture.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

            <span class="c1"># Try to load with common models</span>
            <span class="n">try_common_architectures</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;The file contains an entire model object rather than just a state dictionary.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># If it&#39;s a complete model, we can directly examine its architecture</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading the model file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.install_package" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">install_package</span><span class="p">(</span><span class="n">package</span><span class="p">)</span></code>

<a href="#geoai.utils.install_package" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Install a Python package.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>package</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The package name or a GitHub URL or a list of package names or GitHub URLs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">install_package</span><span class="p">(</span><span class="n">package</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Install a Python package.</span>

<span class="sd">    Args:</span>
<span class="sd">        package (str | list): The package name or a GitHub URL or a list of package names or GitHub URLs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">package</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">package</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The package argument must be a string or a list of strings.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">):</span>
            <span class="n">package</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;git+</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Execute pip install command and show output in real-time</span>
        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pip install </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="c1"># Print output in real-time</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Wait for process to complete</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.masks_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">masks_to_vector</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mask_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_object_area</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_object_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

<a href="#geoai.utils.masks_to_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a building mask GeoTIFF to vector polygons and save as a vector dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the building masks GeoTIFF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoJSON (default: mask_path with .geojson extension)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for polygon simplification (default: self.simplify_tolerance)</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for mask binarization (default: self.mask_threshold)</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_object_area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area in pixels to keep a building (default: self.min_object_area)</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_object_area</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum area in pixels to keep a building (default: self.max_object_area)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nms_iou_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame with building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4630</span>
<span class="normal">4631</span>
<span class="normal">4632</span>
<span class="normal">4633</span>
<span class="normal">4634</span>
<span class="normal">4635</span>
<span class="normal">4636</span>
<span class="normal">4637</span>
<span class="normal">4638</span>
<span class="normal">4639</span>
<span class="normal">4640</span>
<span class="normal">4641</span>
<span class="normal">4642</span>
<span class="normal">4643</span>
<span class="normal">4644</span>
<span class="normal">4645</span>
<span class="normal">4646</span>
<span class="normal">4647</span>
<span class="normal">4648</span>
<span class="normal">4649</span>
<span class="normal">4650</span>
<span class="normal">4651</span>
<span class="normal">4652</span>
<span class="normal">4653</span>
<span class="normal">4654</span>
<span class="normal">4655</span>
<span class="normal">4656</span>
<span class="normal">4657</span>
<span class="normal">4658</span>
<span class="normal">4659</span>
<span class="normal">4660</span>
<span class="normal">4661</span>
<span class="normal">4662</span>
<span class="normal">4663</span>
<span class="normal">4664</span>
<span class="normal">4665</span>
<span class="normal">4666</span>
<span class="normal">4667</span>
<span class="normal">4668</span>
<span class="normal">4669</span>
<span class="normal">4670</span>
<span class="normal">4671</span>
<span class="normal">4672</span>
<span class="normal">4673</span>
<span class="normal">4674</span>
<span class="normal">4675</span>
<span class="normal">4676</span>
<span class="normal">4677</span>
<span class="normal">4678</span>
<span class="normal">4679</span>
<span class="normal">4680</span>
<span class="normal">4681</span>
<span class="normal">4682</span>
<span class="normal">4683</span>
<span class="normal">4684</span>
<span class="normal">4685</span>
<span class="normal">4686</span>
<span class="normal">4687</span>
<span class="normal">4688</span>
<span class="normal">4689</span>
<span class="normal">4690</span>
<span class="normal">4691</span>
<span class="normal">4692</span>
<span class="normal">4693</span>
<span class="normal">4694</span>
<span class="normal">4695</span>
<span class="normal">4696</span>
<span class="normal">4697</span>
<span class="normal">4698</span>
<span class="normal">4699</span>
<span class="normal">4700</span>
<span class="normal">4701</span>
<span class="normal">4702</span>
<span class="normal">4703</span>
<span class="normal">4704</span>
<span class="normal">4705</span>
<span class="normal">4706</span>
<span class="normal">4707</span>
<span class="normal">4708</span>
<span class="normal">4709</span>
<span class="normal">4710</span>
<span class="normal">4711</span>
<span class="normal">4712</span>
<span class="normal">4713</span>
<span class="normal">4714</span>
<span class="normal">4715</span>
<span class="normal">4716</span>
<span class="normal">4717</span>
<span class="normal">4718</span>
<span class="normal">4719</span>
<span class="normal">4720</span>
<span class="normal">4721</span>
<span class="normal">4722</span>
<span class="normal">4723</span>
<span class="normal">4724</span>
<span class="normal">4725</span>
<span class="normal">4726</span>
<span class="normal">4727</span>
<span class="normal">4728</span>
<span class="normal">4729</span>
<span class="normal">4730</span>
<span class="normal">4731</span>
<span class="normal">4732</span>
<span class="normal">4733</span>
<span class="normal">4734</span>
<span class="normal">4735</span>
<span class="normal">4736</span>
<span class="normal">4737</span>
<span class="normal">4738</span>
<span class="normal">4739</span>
<span class="normal">4740</span>
<span class="normal">4741</span>
<span class="normal">4742</span>
<span class="normal">4743</span>
<span class="normal">4744</span>
<span class="normal">4745</span>
<span class="normal">4746</span>
<span class="normal">4747</span>
<span class="normal">4748</span>
<span class="normal">4749</span>
<span class="normal">4750</span>
<span class="normal">4751</span>
<span class="normal">4752</span>
<span class="normal">4753</span>
<span class="normal">4754</span>
<span class="normal">4755</span>
<span class="normal">4756</span>
<span class="normal">4757</span>
<span class="normal">4758</span>
<span class="normal">4759</span>
<span class="normal">4760</span>
<span class="normal">4761</span>
<span class="normal">4762</span>
<span class="normal">4763</span>
<span class="normal">4764</span>
<span class="normal">4765</span>
<span class="normal">4766</span>
<span class="normal">4767</span>
<span class="normal">4768</span>
<span class="normal">4769</span>
<span class="normal">4770</span>
<span class="normal">4771</span>
<span class="normal">4772</span>
<span class="normal">4773</span>
<span class="normal">4774</span>
<span class="normal">4775</span>
<span class="normal">4776</span>
<span class="normal">4777</span>
<span class="normal">4778</span>
<span class="normal">4779</span>
<span class="normal">4780</span>
<span class="normal">4781</span>
<span class="normal">4782</span>
<span class="normal">4783</span>
<span class="normal">4784</span>
<span class="normal">4785</span>
<span class="normal">4786</span>
<span class="normal">4787</span>
<span class="normal">4788</span>
<span class="normal">4789</span>
<span class="normal">4790</span>
<span class="normal">4791</span>
<span class="normal">4792</span>
<span class="normal">4793</span>
<span class="normal">4794</span>
<span class="normal">4795</span>
<span class="normal">4796</span>
<span class="normal">4797</span>
<span class="normal">4798</span>
<span class="normal">4799</span>
<span class="normal">4800</span>
<span class="normal">4801</span>
<span class="normal">4802</span>
<span class="normal">4803</span>
<span class="normal">4804</span>
<span class="normal">4805</span>
<span class="normal">4806</span>
<span class="normal">4807</span>
<span class="normal">4808</span>
<span class="normal">4809</span>
<span class="normal">4810</span>
<span class="normal">4811</span>
<span class="normal">4812</span>
<span class="normal">4813</span>
<span class="normal">4814</span>
<span class="normal">4815</span>
<span class="normal">4816</span>
<span class="normal">4817</span>
<span class="normal">4818</span>
<span class="normal">4819</span>
<span class="normal">4820</span>
<span class="normal">4821</span>
<span class="normal">4822</span>
<span class="normal">4823</span>
<span class="normal">4824</span>
<span class="normal">4825</span>
<span class="normal">4826</span>
<span class="normal">4827</span>
<span class="normal">4828</span>
<span class="normal">4829</span>
<span class="normal">4830</span>
<span class="normal">4831</span>
<span class="normal">4832</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">masks_to_vector</span><span class="p">(</span>
    <span class="n">mask_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">min_object_area</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">max_object_area</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nms_iou_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a building mask GeoTIFF to vector polygons and save as a vector dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask_path: Path to the building masks GeoTIFF</span>
<span class="sd">        output_path: Path to save the output GeoJSON (default: mask_path with .geojson extension)</span>
<span class="sd">        simplify_tolerance: Tolerance for polygon simplification (default: self.simplify_tolerance)</span>
<span class="sd">        mask_threshold: Threshold for mask binarization (default: self.mask_threshold)</span>
<span class="sd">        min_object_area: Minimum area in pixels to keep a building (default: self.min_object_area)</span>
<span class="sd">        max_object_area: Maximum area in pixels to keep a building (default: self.max_object_area)</span>
<span class="sd">        nms_iou_threshold: IoU threshold for non-maximum suppression (default: self.nms_iou_threshold)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: GeoDataFrame with building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set default output path if not provided</span>
    <span class="c1"># if output_path is None:</span>
    <span class="c1">#     output_path = os.path.splitext(mask_path)[0] + &quot;.geojson&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting mask to GeoJSON with parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Mask threshold: </span><span class="si">{</span><span class="n">mask_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Min building area: </span><span class="si">{</span><span class="n">min_object_area</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Simplify tolerance: </span><span class="si">{</span><span class="n">simplify_tolerance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- NMS IoU threshold: </span><span class="si">{</span><span class="n">nms_iou_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Open the mask raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the mask data</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Print mask statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask dimensions: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask value range: </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">mask_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare for connected component analysis</span>
        <span class="c1"># Binarize the mask based on threshold</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mask_threshold</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Apply morphological operations for better results (optional)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># Find connected components</span>
        <span class="n">num_labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span>
            <span class="n">binary_mask</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_labels</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> potential buildings&quot;</span><span class="p">)</span>  <span class="c1"># Subtract 1 for background</span>

        <span class="c1"># Create list to store polygons and confidence values</span>
        <span class="n">all_polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_confidences</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each component (skip the first one which is background)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">)):</span>
            <span class="c1"># Extract this building</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CC_STAT_AREA</span><span class="p">]</span>

            <span class="c1"># Skip if too small</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Skip if too large</span>
            <span class="k">if</span> <span class="n">max_object_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="n">max_object_area</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Create a mask for this building</span>
            <span class="n">building_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Find contours</span>
            <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                <span class="n">building_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span>
            <span class="p">)</span>

            <span class="c1"># Process each contour</span>
            <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                <span class="c1"># Skip if too few points</span>
                <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Simplify contour if it has many points</span>
                <span class="k">if</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">simplify_tolerance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">simplify_tolerance</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">contour</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Convert to list of (x, y) coordinates</span>
                <span class="n">polygon_points</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Convert pixel coordinates to geographic coordinates</span>
                <span class="n">geo_points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">polygon_points</span><span class="p">:</span>
                    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">geo_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">))</span>

                <span class="c1"># Create Shapely polygon</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shapely_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">geo_points</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="n">shapely_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">all_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely_poly</span><span class="p">)</span>

                            <span class="c1"># Calculate &quot;confidence&quot; as normalized size</span>
                            <span class="c1"># This is a proxy since we don&#39;t have model confidence scores</span>
                            <span class="n">normalized_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">area</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Cap at 1.0</span>
                            <span class="n">all_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_size</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating polygon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid polygons&quot;</span><span class="p">)</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_polygons</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid polygons found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">all_polygons</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">all_confidences</span><span class="p">,</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Building class</span>
            <span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Filter overlapping polygons using non-maximum suppression.</span>

<span class="sd">            Args:</span>
<span class="sd">                gdf: GeoDataFrame with polygons</span>
<span class="sd">                **kwargs: Optional parameters:</span>
<span class="sd">                    nms_iou_threshold: IoU threshold for filtering</span>

<span class="sd">            Returns:</span>
<span class="sd">                Filtered GeoDataFrame</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gdf</span>

            <span class="c1"># Get parameters from kwargs or use instance defaults</span>
            <span class="n">iou_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nms_iou_threshold&quot;</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="p">)</span>

            <span class="c1"># Sort by confidence</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Fix any invalid geometries</span>
            <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_valid</span> <span class="k">else</span> <span class="n">geom</span>
            <span class="p">)</span>

            <span class="n">keep_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">polygons</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">:</span>
                    <span class="c1"># Skip invalid geometries</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Calculate IoU</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">intersection</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">area</span>
                        <span class="n">union</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">-</span> <span class="n">intersection</span>
                        <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span> <span class="k">if</span> <span class="n">union</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">iou_threshold</span><span class="p">:</span>
                            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># Skip on topology exceptions</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>

        <span class="c1"># Apply non-maximum suppression to remove overlapping polygons</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">filter_overlapping_polygons</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">nms_iou_threshold</span><span class="o">=</span><span class="n">nms_iou_threshold</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final building count after filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save to file</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> building footprints to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.mosaic_geotiffs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mosaic_geotiffs</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.mosaic_geotiffs" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a mosaic from all GeoTIFF files as a Cloud Optimized GeoTIFF (COG).</p>
<p>This function identifies all GeoTIFF files in the specified directory,
creates a seamless mosaic with proper handling of nodata values, and saves
as a Cloud Optimized GeoTIFF format. If a mask file is provided, the output
will be clipped to the extent of the mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the directory containing GeoTIFF files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output Cloud Optimized GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a mask file to clip the output.
If provided, the output will be clipped to the extent of this mask.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the mosaic was created successfully, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">mosaic_geotiffs</span><span class="p">(</span><span class="s1">&#39;naip&#39;</span><span class="p">,</span> <span class="s1">&#39;merged_naip.tif&#39;</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mosaic_geotiffs</span><span class="p">(</span><span class="s1">&#39;naip&#39;</span><span class="p">,</span> <span class="s1">&#39;merged_naip.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;boundary.tif&#39;</span><span class="p">)</span>
<span class="go">True</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6874</span>
<span class="normal">6875</span>
<span class="normal">6876</span>
<span class="normal">6877</span>
<span class="normal">6878</span>
<span class="normal">6879</span>
<span class="normal">6880</span>
<span class="normal">6881</span>
<span class="normal">6882</span>
<span class="normal">6883</span>
<span class="normal">6884</span>
<span class="normal">6885</span>
<span class="normal">6886</span>
<span class="normal">6887</span>
<span class="normal">6888</span>
<span class="normal">6889</span>
<span class="normal">6890</span>
<span class="normal">6891</span>
<span class="normal">6892</span>
<span class="normal">6893</span>
<span class="normal">6894</span>
<span class="normal">6895</span>
<span class="normal">6896</span>
<span class="normal">6897</span>
<span class="normal">6898</span>
<span class="normal">6899</span>
<span class="normal">6900</span>
<span class="normal">6901</span>
<span class="normal">6902</span>
<span class="normal">6903</span>
<span class="normal">6904</span>
<span class="normal">6905</span>
<span class="normal">6906</span>
<span class="normal">6907</span>
<span class="normal">6908</span>
<span class="normal">6909</span>
<span class="normal">6910</span>
<span class="normal">6911</span>
<span class="normal">6912</span>
<span class="normal">6913</span>
<span class="normal">6914</span>
<span class="normal">6915</span>
<span class="normal">6916</span>
<span class="normal">6917</span>
<span class="normal">6918</span>
<span class="normal">6919</span>
<span class="normal">6920</span>
<span class="normal">6921</span>
<span class="normal">6922</span>
<span class="normal">6923</span>
<span class="normal">6924</span>
<span class="normal">6925</span>
<span class="normal">6926</span>
<span class="normal">6927</span>
<span class="normal">6928</span>
<span class="normal">6929</span>
<span class="normal">6930</span>
<span class="normal">6931</span>
<span class="normal">6932</span>
<span class="normal">6933</span>
<span class="normal">6934</span>
<span class="normal">6935</span>
<span class="normal">6936</span>
<span class="normal">6937</span>
<span class="normal">6938</span>
<span class="normal">6939</span>
<span class="normal">6940</span>
<span class="normal">6941</span>
<span class="normal">6942</span>
<span class="normal">6943</span>
<span class="normal">6944</span>
<span class="normal">6945</span>
<span class="normal">6946</span>
<span class="normal">6947</span>
<span class="normal">6948</span>
<span class="normal">6949</span>
<span class="normal">6950</span>
<span class="normal">6951</span>
<span class="normal">6952</span>
<span class="normal">6953</span>
<span class="normal">6954</span>
<span class="normal">6955</span>
<span class="normal">6956</span>
<span class="normal">6957</span>
<span class="normal">6958</span>
<span class="normal">6959</span>
<span class="normal">6960</span>
<span class="normal">6961</span>
<span class="normal">6962</span>
<span class="normal">6963</span>
<span class="normal">6964</span>
<span class="normal">6965</span>
<span class="normal">6966</span>
<span class="normal">6967</span>
<span class="normal">6968</span>
<span class="normal">6969</span>
<span class="normal">6970</span>
<span class="normal">6971</span>
<span class="normal">6972</span>
<span class="normal">6973</span>
<span class="normal">6974</span>
<span class="normal">6975</span>
<span class="normal">6976</span>
<span class="normal">6977</span>
<span class="normal">6978</span>
<span class="normal">6979</span>
<span class="normal">6980</span>
<span class="normal">6981</span>
<span class="normal">6982</span>
<span class="normal">6983</span>
<span class="normal">6984</span>
<span class="normal">6985</span>
<span class="normal">6986</span>
<span class="normal">6987</span>
<span class="normal">6988</span>
<span class="normal">6989</span>
<span class="normal">6990</span>
<span class="normal">6991</span>
<span class="normal">6992</span>
<span class="normal">6993</span>
<span class="normal">6994</span>
<span class="normal">6995</span>
<span class="normal">6996</span>
<span class="normal">6997</span>
<span class="normal">6998</span>
<span class="normal">6999</span>
<span class="normal">7000</span>
<span class="normal">7001</span>
<span class="normal">7002</span>
<span class="normal">7003</span>
<span class="normal">7004</span>
<span class="normal">7005</span>
<span class="normal">7006</span>
<span class="normal">7007</span>
<span class="normal">7008</span>
<span class="normal">7009</span>
<span class="normal">7010</span>
<span class="normal">7011</span>
<span class="normal">7012</span>
<span class="normal">7013</span>
<span class="normal">7014</span>
<span class="normal">7015</span>
<span class="normal">7016</span>
<span class="normal">7017</span>
<span class="normal">7018</span>
<span class="normal">7019</span>
<span class="normal">7020</span>
<span class="normal">7021</span>
<span class="normal">7022</span>
<span class="normal">7023</span>
<span class="normal">7024</span>
<span class="normal">7025</span>
<span class="normal">7026</span>
<span class="normal">7027</span>
<span class="normal">7028</span>
<span class="normal">7029</span>
<span class="normal">7030</span>
<span class="normal">7031</span>
<span class="normal">7032</span>
<span class="normal">7033</span>
<span class="normal">7034</span>
<span class="normal">7035</span>
<span class="normal">7036</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mosaic_geotiffs</span><span class="p">(</span>
    <span class="n">input_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mosaic from all GeoTIFF files as a Cloud Optimized GeoTIFF (COG).</span>

<span class="sd">    This function identifies all GeoTIFF files in the specified directory,</span>
<span class="sd">    creates a seamless mosaic with proper handling of nodata values, and saves</span>
<span class="sd">    as a Cloud Optimized GeoTIFF format. If a mask file is provided, the output</span>
<span class="sd">    will be clipped to the extent of the mask.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_dir (str): Path to the directory containing GeoTIFF files.</span>
<span class="sd">        output_file (str): Path to the output Cloud Optimized GeoTIFF file.</span>
<span class="sd">        mask_file (str, optional): Path to a mask file to clip the output.</span>
<span class="sd">            If provided, the output will be clipped to the extent of this mask.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the mosaic was created successfully, False otherwise.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; mosaic_geotiffs(&#39;naip&#39;, &#39;merged_naip.tif&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; mosaic_geotiffs(&#39;naip&#39;, &#39;merged_naip.tif&#39;, &#39;boundary.tif&#39;)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">gdal</span>

    <span class="n">gdal</span><span class="o">.</span><span class="n">UseExceptions</span><span class="p">()</span>
    <span class="c1"># Get all tif files in the directory</span>
    <span class="n">tif_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s2">&quot;*.tif&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tif_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GeoTIFF files found in the specified directory.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Analyze the first input file to determine compression and nodata settings</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">tif_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to open </span><span class="si">{</span><span class="n">tif_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Get driver metadata from the first file</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span>
    <span class="n">creation_options</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check compression type</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetMetadata</span><span class="p">(</span><span class="s2">&quot;IMAGE_STRUCTURE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;COMPRESSION&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">compression</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;COMPRESSION&quot;</span><span class="p">]</span>
        <span class="n">creation_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COMPRESS=</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default compression if none detected</span>
        <span class="n">creation_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;COMPRESS=LZW&quot;</span><span class="p">)</span>

    <span class="c1"># Add COG-specific creation options</span>
    <span class="n">creation_options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;TILED=YES&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOCKXSIZE=512&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOCKYSIZE=512&quot;</span><span class="p">])</span>

    <span class="c1"># Check for nodata value in the first band of the first file</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">has_nodata</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Close the dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create a temporary VRT (Virtual Dataset)</span>
    <span class="n">vrt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s2">&quot;temp_mosaic.vrt&quot;</span><span class="p">)</span>

    <span class="c1"># Build VRT from input files with proper nodata handling</span>
    <span class="n">vrt_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">BuildVRTOptions</span><span class="p">(</span>
        <span class="n">resampleAlg</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="n">srcNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">VRTNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">vrt_dataset</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">BuildVRT</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">,</span> <span class="n">tif_files</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">vrt_options</span><span class="p">)</span>

    <span class="c1"># Close the VRT dataset to flush it to disk</span>
    <span class="n">vrt_dataset</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create temp mosaic</span>
    <span class="n">temp_mosaic</span> <span class="o">=</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot;.temp.tif&quot;</span>

    <span class="c1"># Convert VRT to GeoTIFF with the same compression as input</span>
    <span class="n">translate_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">TranslateOptions</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">creationOptions</span><span class="o">=</span><span class="n">creation_options</span><span class="p">,</span>
        <span class="n">noData</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">vrt_path</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">translate_options</span><span class="p">)</span>

    <span class="c1"># Apply mask if provided</span>
    <span class="k">if</span> <span class="n">mask_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipping mosaic to mask: </span><span class="si">{</span><span class="n">mask_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a temporary clipped file</span>
        <span class="n">clipped_mosaic</span> <span class="o">=</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot;.clipped.tif&quot;</span>

        <span class="c1"># Open mask file</span>
        <span class="n">mask_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to open mask file: </span><span class="si">{</span><span class="n">mask_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Continue without clipping</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get mask extent</span>
            <span class="n">mask_geotransform</span> <span class="o">=</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
            <span class="n">mask_projection</span> <span class="o">=</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
            <span class="n">mask_ulx</span> <span class="o">=</span> <span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mask_uly</span> <span class="o">=</span> <span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">mask_lrx</span> <span class="o">=</span> <span class="n">mask_ulx</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">)</span>
            <span class="n">mask_lry</span> <span class="o">=</span> <span class="n">mask_uly</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask_geotransform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">)</span>

            <span class="c1"># Close mask dataset</span>
            <span class="n">mask_ds</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Use warp options to clip</span>
            <span class="n">warp_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">WarpOptions</span><span class="p">(</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                <span class="n">outputBounds</span><span class="o">=</span><span class="p">[</span><span class="n">mask_ulx</span><span class="p">,</span> <span class="n">mask_lry</span><span class="p">,</span> <span class="n">mask_lrx</span><span class="p">,</span> <span class="n">mask_uly</span><span class="p">],</span>
                <span class="n">dstSRS</span><span class="o">=</span><span class="n">mask_projection</span><span class="p">,</span>
                <span class="n">creationOptions</span><span class="o">=</span><span class="n">creation_options</span><span class="p">,</span>
                <span class="n">srcNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">dstNodata</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Apply clipping</span>
            <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">clipped_mosaic</span><span class="p">,</span> <span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">warp_options</span><span class="p">)</span>

            <span class="c1"># Remove the unclipped temp mosaic and use the clipped one</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">)</span>
            <span class="n">temp_mosaic</span> <span class="o">=</span> <span class="n">clipped_mosaic</span>

    <span class="c1"># Create internal overviews for the temp mosaic</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_Update</span><span class="p">)</span>
    <span class="n">overview_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">BuildOverviews</span><span class="p">(</span><span class="s2">&quot;NEAREST&quot;</span><span class="p">,</span> <span class="n">overview_list</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Close the dataset to ensure overviews are written</span>

    <span class="c1"># Convert the temp mosaic to a proper COG</span>
    <span class="n">cog_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">TranslateOptions</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;TILED=YES&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COPY_SRC_OVERVIEWS=YES&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PREDICTOR=2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BLOCKXSIZE=512&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BLOCKYSIZE=512&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">noData</span><span class="o">=</span><span class="n">nodata_value</span> <span class="k">if</span> <span class="n">has_nodata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">temp_mosaic</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">cog_options</span><span class="p">)</span>

    <span class="c1"># Clean up temporary files</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_mosaic</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloud Optimized GeoTIFF mosaic created successfully: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.orthogonalize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">orthogonalize</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_segments</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">area_tolerance</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">detect_triangles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.utils.orthogonalize" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Orthogonalizes object masks in a GeoTIFF file.</p>
<p>This function reads a GeoTIFF containing object masks (binary or labeled regions),
converts the raster masks to vector polygons, applies orthogonalization to each polygon,
and optionally writes the result to a GeoJSON file.
The source code is adapted from the Solar Panel Detection algorithm by Esri.
See https://www.arcgis.com/home/item.html?id=c2508d72f2614104bfcfd5ccf1429284.
Credits to Esri for the original code.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoJSON file. If None, no file is saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epsilon</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Simplification tolerance for the Douglas-Peucker algorithm.
Higher values result in more simplification. Default is 0.2.</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum area of polygons to process (smaller ones are kept as-is).</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_segments</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum number of segments to keep after simplification.
Default is 4 (for rectangular shapes).</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Allowed ratio of area change. Values less than 1.0 restrict
area change. Default is 0.7 (allows reduction to 70% of original area).</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detect_triangles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, performs additional check to avoid creating triangular shapes.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A GeoDataFrame containing the orthogonalized features.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5647</span>
<span class="normal">5648</span>
<span class="normal">5649</span>
<span class="normal">5650</span>
<span class="normal">5651</span>
<span class="normal">5652</span>
<span class="normal">5653</span>
<span class="normal">5654</span>
<span class="normal">5655</span>
<span class="normal">5656</span>
<span class="normal">5657</span>
<span class="normal">5658</span>
<span class="normal">5659</span>
<span class="normal">5660</span>
<span class="normal">5661</span>
<span class="normal">5662</span>
<span class="normal">5663</span>
<span class="normal">5664</span>
<span class="normal">5665</span>
<span class="normal">5666</span>
<span class="normal">5667</span>
<span class="normal">5668</span>
<span class="normal">5669</span>
<span class="normal">5670</span>
<span class="normal">5671</span>
<span class="normal">5672</span>
<span class="normal">5673</span>
<span class="normal">5674</span>
<span class="normal">5675</span>
<span class="normal">5676</span>
<span class="normal">5677</span>
<span class="normal">5678</span>
<span class="normal">5679</span>
<span class="normal">5680</span>
<span class="normal">5681</span>
<span class="normal">5682</span>
<span class="normal">5683</span>
<span class="normal">5684</span>
<span class="normal">5685</span>
<span class="normal">5686</span>
<span class="normal">5687</span>
<span class="normal">5688</span>
<span class="normal">5689</span>
<span class="normal">5690</span>
<span class="normal">5691</span>
<span class="normal">5692</span>
<span class="normal">5693</span>
<span class="normal">5694</span>
<span class="normal">5695</span>
<span class="normal">5696</span>
<span class="normal">5697</span>
<span class="normal">5698</span>
<span class="normal">5699</span>
<span class="normal">5700</span>
<span class="normal">5701</span>
<span class="normal">5702</span>
<span class="normal">5703</span>
<span class="normal">5704</span>
<span class="normal">5705</span>
<span class="normal">5706</span>
<span class="normal">5707</span>
<span class="normal">5708</span>
<span class="normal">5709</span>
<span class="normal">5710</span>
<span class="normal">5711</span>
<span class="normal">5712</span>
<span class="normal">5713</span>
<span class="normal">5714</span>
<span class="normal">5715</span>
<span class="normal">5716</span>
<span class="normal">5717</span>
<span class="normal">5718</span>
<span class="normal">5719</span>
<span class="normal">5720</span>
<span class="normal">5721</span>
<span class="normal">5722</span>
<span class="normal">5723</span>
<span class="normal">5724</span>
<span class="normal">5725</span>
<span class="normal">5726</span>
<span class="normal">5727</span>
<span class="normal">5728</span>
<span class="normal">5729</span>
<span class="normal">5730</span>
<span class="normal">5731</span>
<span class="normal">5732</span>
<span class="normal">5733</span>
<span class="normal">5734</span>
<span class="normal">5735</span>
<span class="normal">5736</span>
<span class="normal">5737</span>
<span class="normal">5738</span>
<span class="normal">5739</span>
<span class="normal">5740</span>
<span class="normal">5741</span>
<span class="normal">5742</span>
<span class="normal">5743</span>
<span class="normal">5744</span>
<span class="normal">5745</span>
<span class="normal">5746</span>
<span class="normal">5747</span>
<span class="normal">5748</span>
<span class="normal">5749</span>
<span class="normal">5750</span>
<span class="normal">5751</span>
<span class="normal">5752</span>
<span class="normal">5753</span>
<span class="normal">5754</span>
<span class="normal">5755</span>
<span class="normal">5756</span>
<span class="normal">5757</span>
<span class="normal">5758</span>
<span class="normal">5759</span>
<span class="normal">5760</span>
<span class="normal">5761</span>
<span class="normal">5762</span>
<span class="normal">5763</span>
<span class="normal">5764</span>
<span class="normal">5765</span>
<span class="normal">5766</span>
<span class="normal">5767</span>
<span class="normal">5768</span>
<span class="normal">5769</span>
<span class="normal">5770</span>
<span class="normal">5771</span>
<span class="normal">5772</span>
<span class="normal">5773</span>
<span class="normal">5774</span>
<span class="normal">5775</span>
<span class="normal">5776</span>
<span class="normal">5777</span>
<span class="normal">5778</span>
<span class="normal">5779</span>
<span class="normal">5780</span>
<span class="normal">5781</span>
<span class="normal">5782</span>
<span class="normal">5783</span>
<span class="normal">5784</span>
<span class="normal">5785</span>
<span class="normal">5786</span>
<span class="normal">5787</span>
<span class="normal">5788</span>
<span class="normal">5789</span>
<span class="normal">5790</span>
<span class="normal">5791</span>
<span class="normal">5792</span>
<span class="normal">5793</span>
<span class="normal">5794</span>
<span class="normal">5795</span>
<span class="normal">5796</span>
<span class="normal">5797</span>
<span class="normal">5798</span>
<span class="normal">5799</span>
<span class="normal">5800</span>
<span class="normal">5801</span>
<span class="normal">5802</span>
<span class="normal">5803</span>
<span class="normal">5804</span>
<span class="normal">5805</span>
<span class="normal">5806</span>
<span class="normal">5807</span>
<span class="normal">5808</span>
<span class="normal">5809</span>
<span class="normal">5810</span>
<span class="normal">5811</span>
<span class="normal">5812</span>
<span class="normal">5813</span>
<span class="normal">5814</span>
<span class="normal">5815</span>
<span class="normal">5816</span>
<span class="normal">5817</span>
<span class="normal">5818</span>
<span class="normal">5819</span>
<span class="normal">5820</span>
<span class="normal">5821</span>
<span class="normal">5822</span>
<span class="normal">5823</span>
<span class="normal">5824</span>
<span class="normal">5825</span>
<span class="normal">5826</span>
<span class="normal">5827</span>
<span class="normal">5828</span>
<span class="normal">5829</span>
<span class="normal">5830</span>
<span class="normal">5831</span>
<span class="normal">5832</span>
<span class="normal">5833</span>
<span class="normal">5834</span>
<span class="normal">5835</span>
<span class="normal">5836</span>
<span class="normal">5837</span>
<span class="normal">5838</span>
<span class="normal">5839</span>
<span class="normal">5840</span>
<span class="normal">5841</span>
<span class="normal">5842</span>
<span class="normal">5843</span>
<span class="normal">5844</span>
<span class="normal">5845</span>
<span class="normal">5846</span>
<span class="normal">5847</span>
<span class="normal">5848</span>
<span class="normal">5849</span>
<span class="normal">5850</span>
<span class="normal">5851</span>
<span class="normal">5852</span>
<span class="normal">5853</span>
<span class="normal">5854</span>
<span class="normal">5855</span>
<span class="normal">5856</span>
<span class="normal">5857</span>
<span class="normal">5858</span>
<span class="normal">5859</span>
<span class="normal">5860</span>
<span class="normal">5861</span>
<span class="normal">5862</span>
<span class="normal">5863</span>
<span class="normal">5864</span>
<span class="normal">5865</span>
<span class="normal">5866</span>
<span class="normal">5867</span>
<span class="normal">5868</span>
<span class="normal">5869</span>
<span class="normal">5870</span>
<span class="normal">5871</span>
<span class="normal">5872</span>
<span class="normal">5873</span>
<span class="normal">5874</span>
<span class="normal">5875</span>
<span class="normal">5876</span>
<span class="normal">5877</span>
<span class="normal">5878</span>
<span class="normal">5879</span>
<span class="normal">5880</span>
<span class="normal">5881</span>
<span class="normal">5882</span>
<span class="normal">5883</span>
<span class="normal">5884</span>
<span class="normal">5885</span>
<span class="normal">5886</span>
<span class="normal">5887</span>
<span class="normal">5888</span>
<span class="normal">5889</span>
<span class="normal">5890</span>
<span class="normal">5891</span>
<span class="normal">5892</span>
<span class="normal">5893</span>
<span class="normal">5894</span>
<span class="normal">5895</span>
<span class="normal">5896</span>
<span class="normal">5897</span>
<span class="normal">5898</span>
<span class="normal">5899</span>
<span class="normal">5900</span>
<span class="normal">5901</span>
<span class="normal">5902</span>
<span class="normal">5903</span>
<span class="normal">5904</span>
<span class="normal">5905</span>
<span class="normal">5906</span>
<span class="normal">5907</span>
<span class="normal">5908</span>
<span class="normal">5909</span>
<span class="normal">5910</span>
<span class="normal">5911</span>
<span class="normal">5912</span>
<span class="normal">5913</span>
<span class="normal">5914</span>
<span class="normal">5915</span>
<span class="normal">5916</span>
<span class="normal">5917</span>
<span class="normal">5918</span>
<span class="normal">5919</span>
<span class="normal">5920</span>
<span class="normal">5921</span>
<span class="normal">5922</span>
<span class="normal">5923</span>
<span class="normal">5924</span>
<span class="normal">5925</span>
<span class="normal">5926</span>
<span class="normal">5927</span>
<span class="normal">5928</span>
<span class="normal">5929</span>
<span class="normal">5930</span>
<span class="normal">5931</span>
<span class="normal">5932</span>
<span class="normal">5933</span>
<span class="normal">5934</span>
<span class="normal">5935</span>
<span class="normal">5936</span>
<span class="normal">5937</span>
<span class="normal">5938</span>
<span class="normal">5939</span>
<span class="normal">5940</span>
<span class="normal">5941</span>
<span class="normal">5942</span>
<span class="normal">5943</span>
<span class="normal">5944</span>
<span class="normal">5945</span>
<span class="normal">5946</span>
<span class="normal">5947</span>
<span class="normal">5948</span>
<span class="normal">5949</span>
<span class="normal">5950</span>
<span class="normal">5951</span>
<span class="normal">5952</span>
<span class="normal">5953</span>
<span class="normal">5954</span>
<span class="normal">5955</span>
<span class="normal">5956</span>
<span class="normal">5957</span>
<span class="normal">5958</span>
<span class="normal">5959</span>
<span class="normal">5960</span>
<span class="normal">5961</span>
<span class="normal">5962</span>
<span class="normal">5963</span>
<span class="normal">5964</span>
<span class="normal">5965</span>
<span class="normal">5966</span>
<span class="normal">5967</span>
<span class="normal">5968</span>
<span class="normal">5969</span>
<span class="normal">5970</span>
<span class="normal">5971</span>
<span class="normal">5972</span>
<span class="normal">5973</span>
<span class="normal">5974</span>
<span class="normal">5975</span>
<span class="normal">5976</span>
<span class="normal">5977</span>
<span class="normal">5978</span>
<span class="normal">5979</span>
<span class="normal">5980</span>
<span class="normal">5981</span>
<span class="normal">5982</span>
<span class="normal">5983</span>
<span class="normal">5984</span>
<span class="normal">5985</span>
<span class="normal">5986</span>
<span class="normal">5987</span>
<span class="normal">5988</span>
<span class="normal">5989</span>
<span class="normal">5990</span>
<span class="normal">5991</span>
<span class="normal">5992</span>
<span class="normal">5993</span>
<span class="normal">5994</span>
<span class="normal">5995</span>
<span class="normal">5996</span>
<span class="normal">5997</span>
<span class="normal">5998</span>
<span class="normal">5999</span>
<span class="normal">6000</span>
<span class="normal">6001</span>
<span class="normal">6002</span>
<span class="normal">6003</span>
<span class="normal">6004</span>
<span class="normal">6005</span>
<span class="normal">6006</span>
<span class="normal">6007</span>
<span class="normal">6008</span>
<span class="normal">6009</span>
<span class="normal">6010</span>
<span class="normal">6011</span>
<span class="normal">6012</span>
<span class="normal">6013</span>
<span class="normal">6014</span>
<span class="normal">6015</span>
<span class="normal">6016</span>
<span class="normal">6017</span>
<span class="normal">6018</span>
<span class="normal">6019</span>
<span class="normal">6020</span>
<span class="normal">6021</span>
<span class="normal">6022</span>
<span class="normal">6023</span>
<span class="normal">6024</span>
<span class="normal">6025</span>
<span class="normal">6026</span>
<span class="normal">6027</span>
<span class="normal">6028</span>
<span class="normal">6029</span>
<span class="normal">6030</span>
<span class="normal">6031</span>
<span class="normal">6032</span>
<span class="normal">6033</span>
<span class="normal">6034</span>
<span class="normal">6035</span>
<span class="normal">6036</span>
<span class="normal">6037</span>
<span class="normal">6038</span>
<span class="normal">6039</span>
<span class="normal">6040</span>
<span class="normal">6041</span>
<span class="normal">6042</span>
<span class="normal">6043</span>
<span class="normal">6044</span>
<span class="normal">6045</span>
<span class="normal">6046</span>
<span class="normal">6047</span>
<span class="normal">6048</span>
<span class="normal">6049</span>
<span class="normal">6050</span>
<span class="normal">6051</span>
<span class="normal">6052</span>
<span class="normal">6053</span>
<span class="normal">6054</span>
<span class="normal">6055</span>
<span class="normal">6056</span>
<span class="normal">6057</span>
<span class="normal">6058</span>
<span class="normal">6059</span>
<span class="normal">6060</span>
<span class="normal">6061</span>
<span class="normal">6062</span>
<span class="normal">6063</span>
<span class="normal">6064</span>
<span class="normal">6065</span>
<span class="normal">6066</span>
<span class="normal">6067</span>
<span class="normal">6068</span>
<span class="normal">6069</span>
<span class="normal">6070</span>
<span class="normal">6071</span>
<span class="normal">6072</span>
<span class="normal">6073</span>
<span class="normal">6074</span>
<span class="normal">6075</span>
<span class="normal">6076</span>
<span class="normal">6077</span>
<span class="normal">6078</span>
<span class="normal">6079</span>
<span class="normal">6080</span>
<span class="normal">6081</span>
<span class="normal">6082</span>
<span class="normal">6083</span>
<span class="normal">6084</span>
<span class="normal">6085</span>
<span class="normal">6086</span>
<span class="normal">6087</span>
<span class="normal">6088</span>
<span class="normal">6089</span>
<span class="normal">6090</span>
<span class="normal">6091</span>
<span class="normal">6092</span>
<span class="normal">6093</span>
<span class="normal">6094</span>
<span class="normal">6095</span>
<span class="normal">6096</span>
<span class="normal">6097</span>
<span class="normal">6098</span>
<span class="normal">6099</span>
<span class="normal">6100</span>
<span class="normal">6101</span>
<span class="normal">6102</span>
<span class="normal">6103</span>
<span class="normal">6104</span>
<span class="normal">6105</span>
<span class="normal">6106</span>
<span class="normal">6107</span>
<span class="normal">6108</span>
<span class="normal">6109</span>
<span class="normal">6110</span>
<span class="normal">6111</span>
<span class="normal">6112</span>
<span class="normal">6113</span>
<span class="normal">6114</span>
<span class="normal">6115</span>
<span class="normal">6116</span>
<span class="normal">6117</span>
<span class="normal">6118</span>
<span class="normal">6119</span>
<span class="normal">6120</span>
<span class="normal">6121</span>
<span class="normal">6122</span>
<span class="normal">6123</span>
<span class="normal">6124</span>
<span class="normal">6125</span>
<span class="normal">6126</span>
<span class="normal">6127</span>
<span class="normal">6128</span>
<span class="normal">6129</span>
<span class="normal">6130</span>
<span class="normal">6131</span>
<span class="normal">6132</span>
<span class="normal">6133</span>
<span class="normal">6134</span>
<span class="normal">6135</span>
<span class="normal">6136</span>
<span class="normal">6137</span>
<span class="normal">6138</span>
<span class="normal">6139</span>
<span class="normal">6140</span>
<span class="normal">6141</span>
<span class="normal">6142</span>
<span class="normal">6143</span>
<span class="normal">6144</span>
<span class="normal">6145</span>
<span class="normal">6146</span>
<span class="normal">6147</span>
<span class="normal">6148</span>
<span class="normal">6149</span>
<span class="normal">6150</span>
<span class="normal">6151</span>
<span class="normal">6152</span>
<span class="normal">6153</span>
<span class="normal">6154</span>
<span class="normal">6155</span>
<span class="normal">6156</span>
<span class="normal">6157</span>
<span class="normal">6158</span>
<span class="normal">6159</span>
<span class="normal">6160</span>
<span class="normal">6161</span>
<span class="normal">6162</span>
<span class="normal">6163</span>
<span class="normal">6164</span>
<span class="normal">6165</span>
<span class="normal">6166</span>
<span class="normal">6167</span>
<span class="normal">6168</span>
<span class="normal">6169</span>
<span class="normal">6170</span>
<span class="normal">6171</span>
<span class="normal">6172</span>
<span class="normal">6173</span>
<span class="normal">6174</span>
<span class="normal">6175</span>
<span class="normal">6176</span>
<span class="normal">6177</span>
<span class="normal">6178</span>
<span class="normal">6179</span>
<span class="normal">6180</span>
<span class="normal">6181</span>
<span class="normal">6182</span>
<span class="normal">6183</span>
<span class="normal">6184</span>
<span class="normal">6185</span>
<span class="normal">6186</span>
<span class="normal">6187</span>
<span class="normal">6188</span>
<span class="normal">6189</span>
<span class="normal">6190</span>
<span class="normal">6191</span>
<span class="normal">6192</span>
<span class="normal">6193</span>
<span class="normal">6194</span>
<span class="normal">6195</span>
<span class="normal">6196</span>
<span class="normal">6197</span>
<span class="normal">6198</span>
<span class="normal">6199</span>
<span class="normal">6200</span>
<span class="normal">6201</span>
<span class="normal">6202</span>
<span class="normal">6203</span>
<span class="normal">6204</span>
<span class="normal">6205</span>
<span class="normal">6206</span>
<span class="normal">6207</span>
<span class="normal">6208</span>
<span class="normal">6209</span>
<span class="normal">6210</span>
<span class="normal">6211</span>
<span class="normal">6212</span>
<span class="normal">6213</span>
<span class="normal">6214</span>
<span class="normal">6215</span>
<span class="normal">6216</span>
<span class="normal">6217</span>
<span class="normal">6218</span>
<span class="normal">6219</span>
<span class="normal">6220</span>
<span class="normal">6221</span>
<span class="normal">6222</span>
<span class="normal">6223</span>
<span class="normal">6224</span>
<span class="normal">6225</span>
<span class="normal">6226</span>
<span class="normal">6227</span>
<span class="normal">6228</span>
<span class="normal">6229</span>
<span class="normal">6230</span>
<span class="normal">6231</span>
<span class="normal">6232</span>
<span class="normal">6233</span>
<span class="normal">6234</span>
<span class="normal">6235</span>
<span class="normal">6236</span>
<span class="normal">6237</span>
<span class="normal">6238</span>
<span class="normal">6239</span>
<span class="normal">6240</span>
<span class="normal">6241</span>
<span class="normal">6242</span>
<span class="normal">6243</span>
<span class="normal">6244</span>
<span class="normal">6245</span>
<span class="normal">6246</span>
<span class="normal">6247</span>
<span class="normal">6248</span>
<span class="normal">6249</span>
<span class="normal">6250</span>
<span class="normal">6251</span>
<span class="normal">6252</span>
<span class="normal">6253</span>
<span class="normal">6254</span>
<span class="normal">6255</span>
<span class="normal">6256</span>
<span class="normal">6257</span>
<span class="normal">6258</span>
<span class="normal">6259</span>
<span class="normal">6260</span>
<span class="normal">6261</span>
<span class="normal">6262</span>
<span class="normal">6263</span>
<span class="normal">6264</span>
<span class="normal">6265</span>
<span class="normal">6266</span>
<span class="normal">6267</span>
<span class="normal">6268</span>
<span class="normal">6269</span>
<span class="normal">6270</span>
<span class="normal">6271</span>
<span class="normal">6272</span>
<span class="normal">6273</span>
<span class="normal">6274</span>
<span class="normal">6275</span>
<span class="normal">6276</span>
<span class="normal">6277</span>
<span class="normal">6278</span>
<span class="normal">6279</span>
<span class="normal">6280</span>
<span class="normal">6281</span>
<span class="normal">6282</span>
<span class="normal">6283</span>
<span class="normal">6284</span>
<span class="normal">6285</span>
<span class="normal">6286</span>
<span class="normal">6287</span>
<span class="normal">6288</span>
<span class="normal">6289</span>
<span class="normal">6290</span>
<span class="normal">6291</span>
<span class="normal">6292</span>
<span class="normal">6293</span>
<span class="normal">6294</span>
<span class="normal">6295</span>
<span class="normal">6296</span>
<span class="normal">6297</span>
<span class="normal">6298</span>
<span class="normal">6299</span>
<span class="normal">6300</span>
<span class="normal">6301</span>
<span class="normal">6302</span>
<span class="normal">6303</span>
<span class="normal">6304</span>
<span class="normal">6305</span>
<span class="normal">6306</span>
<span class="normal">6307</span>
<span class="normal">6308</span>
<span class="normal">6309</span>
<span class="normal">6310</span>
<span class="normal">6311</span>
<span class="normal">6312</span>
<span class="normal">6313</span>
<span class="normal">6314</span>
<span class="normal">6315</span>
<span class="normal">6316</span>
<span class="normal">6317</span>
<span class="normal">6318</span>
<span class="normal">6319</span>
<span class="normal">6320</span>
<span class="normal">6321</span>
<span class="normal">6322</span>
<span class="normal">6323</span>
<span class="normal">6324</span>
<span class="normal">6325</span>
<span class="normal">6326</span>
<span class="normal">6327</span>
<span class="normal">6328</span>
<span class="normal">6329</span>
<span class="normal">6330</span>
<span class="normal">6331</span>
<span class="normal">6332</span>
<span class="normal">6333</span>
<span class="normal">6334</span>
<span class="normal">6335</span>
<span class="normal">6336</span>
<span class="normal">6337</span>
<span class="normal">6338</span>
<span class="normal">6339</span>
<span class="normal">6340</span>
<span class="normal">6341</span>
<span class="normal">6342</span>
<span class="normal">6343</span>
<span class="normal">6344</span>
<span class="normal">6345</span>
<span class="normal">6346</span>
<span class="normal">6347</span>
<span class="normal">6348</span>
<span class="normal">6349</span>
<span class="normal">6350</span>
<span class="normal">6351</span>
<span class="normal">6352</span>
<span class="normal">6353</span>
<span class="normal">6354</span>
<span class="normal">6355</span>
<span class="normal">6356</span>
<span class="normal">6357</span>
<span class="normal">6358</span>
<span class="normal">6359</span>
<span class="normal">6360</span>
<span class="normal">6361</span>
<span class="normal">6362</span>
<span class="normal">6363</span>
<span class="normal">6364</span>
<span class="normal">6365</span>
<span class="normal">6366</span>
<span class="normal">6367</span>
<span class="normal">6368</span>
<span class="normal">6369</span>
<span class="normal">6370</span>
<span class="normal">6371</span>
<span class="normal">6372</span>
<span class="normal">6373</span>
<span class="normal">6374</span>
<span class="normal">6375</span>
<span class="normal">6376</span>
<span class="normal">6377</span>
<span class="normal">6378</span>
<span class="normal">6379</span>
<span class="normal">6380</span>
<span class="normal">6381</span>
<span class="normal">6382</span>
<span class="normal">6383</span>
<span class="normal">6384</span>
<span class="normal">6385</span>
<span class="normal">6386</span>
<span class="normal">6387</span>
<span class="normal">6388</span>
<span class="normal">6389</span>
<span class="normal">6390</span>
<span class="normal">6391</span>
<span class="normal">6392</span>
<span class="normal">6393</span>
<span class="normal">6394</span>
<span class="normal">6395</span>
<span class="normal">6396</span>
<span class="normal">6397</span>
<span class="normal">6398</span>
<span class="normal">6399</span>
<span class="normal">6400</span>
<span class="normal">6401</span>
<span class="normal">6402</span>
<span class="normal">6403</span>
<span class="normal">6404</span>
<span class="normal">6405</span>
<span class="normal">6406</span>
<span class="normal">6407</span>
<span class="normal">6408</span>
<span class="normal">6409</span>
<span class="normal">6410</span>
<span class="normal">6411</span>
<span class="normal">6412</span>
<span class="normal">6413</span>
<span class="normal">6414</span>
<span class="normal">6415</span>
<span class="normal">6416</span>
<span class="normal">6417</span>
<span class="normal">6418</span>
<span class="normal">6419</span>
<span class="normal">6420</span>
<span class="normal">6421</span>
<span class="normal">6422</span>
<span class="normal">6423</span>
<span class="normal">6424</span>
<span class="normal">6425</span>
<span class="normal">6426</span>
<span class="normal">6427</span>
<span class="normal">6428</span>
<span class="normal">6429</span>
<span class="normal">6430</span>
<span class="normal">6431</span>
<span class="normal">6432</span>
<span class="normal">6433</span>
<span class="normal">6434</span>
<span class="normal">6435</span>
<span class="normal">6436</span>
<span class="normal">6437</span>
<span class="normal">6438</span>
<span class="normal">6439</span>
<span class="normal">6440</span>
<span class="normal">6441</span>
<span class="normal">6442</span>
<span class="normal">6443</span>
<span class="normal">6444</span>
<span class="normal">6445</span>
<span class="normal">6446</span>
<span class="normal">6447</span>
<span class="normal">6448</span>
<span class="normal">6449</span>
<span class="normal">6450</span>
<span class="normal">6451</span>
<span class="normal">6452</span>
<span class="normal">6453</span>
<span class="normal">6454</span>
<span class="normal">6455</span>
<span class="normal">6456</span>
<span class="normal">6457</span>
<span class="normal">6458</span>
<span class="normal">6459</span>
<span class="normal">6460</span>
<span class="normal">6461</span>
<span class="normal">6462</span>
<span class="normal">6463</span>
<span class="normal">6464</span>
<span class="normal">6465</span>
<span class="normal">6466</span>
<span class="normal">6467</span>
<span class="normal">6468</span>
<span class="normal">6469</span>
<span class="normal">6470</span>
<span class="normal">6471</span>
<span class="normal">6472</span>
<span class="normal">6473</span>
<span class="normal">6474</span>
<span class="normal">6475</span>
<span class="normal">6476</span>
<span class="normal">6477</span>
<span class="normal">6478</span>
<span class="normal">6479</span>
<span class="normal">6480</span>
<span class="normal">6481</span>
<span class="normal">6482</span>
<span class="normal">6483</span>
<span class="normal">6484</span>
<span class="normal">6485</span>
<span class="normal">6486</span>
<span class="normal">6487</span>
<span class="normal">6488</span>
<span class="normal">6489</span>
<span class="normal">6490</span>
<span class="normal">6491</span>
<span class="normal">6492</span>
<span class="normal">6493</span>
<span class="normal">6494</span>
<span class="normal">6495</span>
<span class="normal">6496</span>
<span class="normal">6497</span>
<span class="normal">6498</span>
<span class="normal">6499</span>
<span class="normal">6500</span>
<span class="normal">6501</span>
<span class="normal">6502</span>
<span class="normal">6503</span>
<span class="normal">6504</span>
<span class="normal">6505</span>
<span class="normal">6506</span>
<span class="normal">6507</span>
<span class="normal">6508</span>
<span class="normal">6509</span>
<span class="normal">6510</span>
<span class="normal">6511</span>
<span class="normal">6512</span>
<span class="normal">6513</span>
<span class="normal">6514</span>
<span class="normal">6515</span>
<span class="normal">6516</span>
<span class="normal">6517</span>
<span class="normal">6518</span>
<span class="normal">6519</span>
<span class="normal">6520</span>
<span class="normal">6521</span>
<span class="normal">6522</span>
<span class="normal">6523</span>
<span class="normal">6524</span>
<span class="normal">6525</span>
<span class="normal">6526</span>
<span class="normal">6527</span>
<span class="normal">6528</span>
<span class="normal">6529</span>
<span class="normal">6530</span>
<span class="normal">6531</span>
<span class="normal">6532</span>
<span class="normal">6533</span>
<span class="normal">6534</span>
<span class="normal">6535</span>
<span class="normal">6536</span>
<span class="normal">6537</span>
<span class="normal">6538</span>
<span class="normal">6539</span>
<span class="normal">6540</span>
<span class="normal">6541</span>
<span class="normal">6542</span>
<span class="normal">6543</span>
<span class="normal">6544</span>
<span class="normal">6545</span>
<span class="normal">6546</span>
<span class="normal">6547</span>
<span class="normal">6548</span>
<span class="normal">6549</span>
<span class="normal">6550</span>
<span class="normal">6551</span>
<span class="normal">6552</span>
<span class="normal">6553</span>
<span class="normal">6554</span>
<span class="normal">6555</span>
<span class="normal">6556</span>
<span class="normal">6557</span>
<span class="normal">6558</span>
<span class="normal">6559</span>
<span class="normal">6560</span>
<span class="normal">6561</span>
<span class="normal">6562</span>
<span class="normal">6563</span>
<span class="normal">6564</span>
<span class="normal">6565</span>
<span class="normal">6566</span>
<span class="normal">6567</span>
<span class="normal">6568</span>
<span class="normal">6569</span>
<span class="normal">6570</span>
<span class="normal">6571</span>
<span class="normal">6572</span>
<span class="normal">6573</span>
<span class="normal">6574</span>
<span class="normal">6575</span>
<span class="normal">6576</span>
<span class="normal">6577</span>
<span class="normal">6578</span>
<span class="normal">6579</span>
<span class="normal">6580</span>
<span class="normal">6581</span>
<span class="normal">6582</span>
<span class="normal">6583</span>
<span class="normal">6584</span>
<span class="normal">6585</span>
<span class="normal">6586</span>
<span class="normal">6587</span>
<span class="normal">6588</span>
<span class="normal">6589</span>
<span class="normal">6590</span>
<span class="normal">6591</span>
<span class="normal">6592</span>
<span class="normal">6593</span>
<span class="normal">6594</span>
<span class="normal">6595</span>
<span class="normal">6596</span>
<span class="normal">6597</span>
<span class="normal">6598</span>
<span class="normal">6599</span>
<span class="normal">6600</span>
<span class="normal">6601</span>
<span class="normal">6602</span>
<span class="normal">6603</span>
<span class="normal">6604</span>
<span class="normal">6605</span>
<span class="normal">6606</span>
<span class="normal">6607</span>
<span class="normal">6608</span>
<span class="normal">6609</span>
<span class="normal">6610</span>
<span class="normal">6611</span>
<span class="normal">6612</span>
<span class="normal">6613</span>
<span class="normal">6614</span>
<span class="normal">6615</span>
<span class="normal">6616</span>
<span class="normal">6617</span>
<span class="normal">6618</span>
<span class="normal">6619</span>
<span class="normal">6620</span>
<span class="normal">6621</span>
<span class="normal">6622</span>
<span class="normal">6623</span>
<span class="normal">6624</span>
<span class="normal">6625</span>
<span class="normal">6626</span>
<span class="normal">6627</span>
<span class="normal">6628</span>
<span class="normal">6629</span>
<span class="normal">6630</span>
<span class="normal">6631</span>
<span class="normal">6632</span>
<span class="normal">6633</span>
<span class="normal">6634</span>
<span class="normal">6635</span>
<span class="normal">6636</span>
<span class="normal">6637</span>
<span class="normal">6638</span>
<span class="normal">6639</span>
<span class="normal">6640</span>
<span class="normal">6641</span>
<span class="normal">6642</span>
<span class="normal">6643</span>
<span class="normal">6644</span>
<span class="normal">6645</span>
<span class="normal">6646</span>
<span class="normal">6647</span>
<span class="normal">6648</span>
<span class="normal">6649</span>
<span class="normal">6650</span>
<span class="normal">6651</span>
<span class="normal">6652</span>
<span class="normal">6653</span>
<span class="normal">6654</span>
<span class="normal">6655</span>
<span class="normal">6656</span>
<span class="normal">6657</span>
<span class="normal">6658</span>
<span class="normal">6659</span>
<span class="normal">6660</span>
<span class="normal">6661</span>
<span class="normal">6662</span>
<span class="normal">6663</span>
<span class="normal">6664</span>
<span class="normal">6665</span>
<span class="normal">6666</span>
<span class="normal">6667</span>
<span class="normal">6668</span>
<span class="normal">6669</span>
<span class="normal">6670</span>
<span class="normal">6671</span>
<span class="normal">6672</span>
<span class="normal">6673</span>
<span class="normal">6674</span>
<span class="normal">6675</span>
<span class="normal">6676</span>
<span class="normal">6677</span>
<span class="normal">6678</span>
<span class="normal">6679</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">orthogonalize</span><span class="p">(</span>
    <span class="n">input_path</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">min_segments</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">area_tolerance</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">detect_triangles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orthogonalizes object masks in a GeoTIFF file.</span>

<span class="sd">    This function reads a GeoTIFF containing object masks (binary or labeled regions),</span>
<span class="sd">    converts the raster masks to vector polygons, applies orthogonalization to each polygon,</span>
<span class="sd">    and optionally writes the result to a GeoJSON file.</span>
<span class="sd">    The source code is adapted from the Solar Panel Detection algorithm by Esri.</span>
<span class="sd">    See https://www.arcgis.com/home/item.html?id=c2508d72f2614104bfcfd5ccf1429284.</span>
<span class="sd">    Credits to Esri for the original code.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_path (str): Path to the input GeoTIFF file.</span>
<span class="sd">        output_path (str, optional): Path to save the output GeoJSON file. If None, no file is saved.</span>
<span class="sd">        epsilon (float, optional): Simplification tolerance for the Douglas-Peucker algorithm.</span>
<span class="sd">            Higher values result in more simplification. Default is 0.2.</span>
<span class="sd">        min_area (float, optional): Minimum area of polygons to process (smaller ones are kept as-is).</span>
<span class="sd">        min_segments (int, optional): Minimum number of segments to keep after simplification.</span>
<span class="sd">            Default is 4 (for rectangular shapes).</span>
<span class="sd">        area_tolerance (float, optional): Allowed ratio of area change. Values less than 1.0 restrict</span>
<span class="sd">            area change. Default is 0.7 (allows reduction to 70% of original area).</span>
<span class="sd">        detect_triangles (bool, optional): If True, performs additional check to avoid creating triangular shapes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: A GeoDataFrame containing the orthogonalized features.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">orthogonalize_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">min_segments</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orthogonalizes a ring (list of coordinates).</span>

<span class="sd">        Args:</span>
<span class="sd">            ring (list): List of [x, y] coordinates forming a ring</span>
<span class="sd">            epsilon (float, optional): Simplification tolerance</span>
<span class="sd">            min_segments (int, optional): Minimum number of segments to keep</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Orthogonalized list of coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Convert to numpy array</span>
        <span class="n">ring_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>

        <span class="c1"># Get orientation</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">get_orientation</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">))</span>

        <span class="c1"># Simplify using Ramer-Douglas-Peucker algorithm</span>
        <span class="n">ring_arr</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

        <span class="c1"># If simplified too much, adjust epsilon to maintain minimum segments</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_segments</span><span class="p">:</span>
            <span class="c1"># Try with smaller epsilon until we get at least min_segments points</span>
            <span class="k">for</span> <span class="n">adjust_factor</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]:</span>
                <span class="n">test_arr</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">adjust_factor</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_segments</span><span class="p">:</span>
                    <span class="n">ring_arr</span> <span class="o">=</span> <span class="n">test_arr</span>
                    <span class="k">break</span>

        <span class="c1"># Convert to dataframe for processing</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">to_dataframe</span><span class="p">(</span><span class="n">ring_arr</span><span class="p">)</span>

        <span class="c1"># Add orientation information</span>
        <span class="n">add_orientation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

        <span class="c1"># Align segments to orthogonal directions</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Merge collinear line segments</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">merge_lines</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># If we have a triangle-like result (3 segments or less), return the original shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Join the orthogonalized segments back into a ring</span>
        <span class="n">joined_ring</span> <span class="o">=</span> <span class="n">join_ring</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># If the join operation didn&#39;t produce a valid ring, return the original</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_ring</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">joined_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Enhanced validation: check for triangular result and geometric validity</span>
        <span class="n">result_coords</span> <span class="o">=</span> <span class="n">joined_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If result has 3 or fewer points (triangle), use original</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># 2 points + closing point (degenerate)</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Additional validation: check for degenerate geometry</span>
        <span class="c1"># Calculate area ratio to detect if the shape got severely distorted</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">calculate_polygon_area</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
                <span class="n">area</span> <span class="o">+=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">area</span> <span class="o">-=</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">original_area</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="n">result_area</span> <span class="o">=</span> <span class="n">calculate_polygon_area</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span>

        <span class="c1"># If the area changed dramatically (more than 30% shrinkage or 300% growth), use original</span>
        <span class="k">if</span> <span class="n">original_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">area_ratio</span> <span class="o">=</span> <span class="n">result_area</span> <span class="o">/</span> <span class="n">original_area</span>
            <span class="k">if</span> <span class="n">area_ratio</span> <span class="o">&lt;</span> <span class="mf">0.3</span> <span class="ow">or</span> <span class="n">area_ratio</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Check for triangular spikes and problematic artifacts</span>
        <span class="n">very_acute_angle_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">triangular_spike_detected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># -1 to exclude closing point</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">result_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

            <span class="c1"># Calculate angle at p2</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="n">v1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="n">v2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1_norm</span> <span class="o">*</span> <span class="n">v2_norm</span><span class="p">)</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>

                <span class="c1"># Count very acute angles (&lt; 20 degrees) - these are likely spikes</span>
                <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">9</span><span class="p">:</span>  <span class="c1"># 20 degrees</span>
                    <span class="n">very_acute_angle_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># If it&#39;s very acute with short sides, it&#39;s definitely a spike</span>
                    <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">v2_norm</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">triangular_spike_detected</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check for excessively long edges that might be artifacts</span>
        <span class="n">edge_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">edge_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">result_coords</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">result_coords</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">edge_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_len</span><span class="p">)</span>

        <span class="n">excessive_edge_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avg_edge_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span>
            <span class="n">max_edge_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span>
            <span class="c1"># Only reject if edge is extremely disproportionate (8x average)</span>
            <span class="k">if</span> <span class="n">max_edge_length</span> <span class="o">&gt;</span> <span class="n">avg_edge_length</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">excessive_edge_detected</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check for triangular artifacts by detecting spikes that extend beyond bounds</span>
        <span class="c1"># Calculate original bounds</span>
        <span class="n">orig_xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">]</span>
        <span class="n">orig_ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">]</span>
        <span class="n">orig_min_x</span><span class="p">,</span> <span class="n">orig_max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orig_xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_xs</span><span class="p">)</span>
        <span class="n">orig_min_y</span><span class="p">,</span> <span class="n">orig_max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orig_ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_ys</span><span class="p">)</span>
        <span class="n">orig_width</span> <span class="o">=</span> <span class="n">orig_max_x</span> <span class="o">-</span> <span class="n">orig_min_x</span>
        <span class="n">orig_height</span> <span class="o">=</span> <span class="n">orig_max_y</span> <span class="o">-</span> <span class="n">orig_min_y</span>

        <span class="c1"># Calculate result bounds</span>
        <span class="n">result_xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result_coords</span><span class="p">]</span>
        <span class="n">result_ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result_coords</span><span class="p">]</span>
        <span class="n">result_min_x</span><span class="p">,</span> <span class="n">result_max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">result_xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_xs</span><span class="p">)</span>
        <span class="n">result_min_y</span><span class="p">,</span> <span class="n">result_max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">result_ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_ys</span><span class="p">)</span>

        <span class="c1"># Stricter bounds checking to catch triangular artifacts</span>
        <span class="n">bounds_extension_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># More conservative: only allow 10% extension</span>
        <span class="n">tolerance_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_width</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 10% tolerance, at least 1 unit</span>
        <span class="n">tolerance_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">orig_height</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 10% tolerance, at least 1 unit</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">result_min_x</span> <span class="o">&lt;</span> <span class="n">orig_min_x</span> <span class="o">-</span> <span class="n">tolerance_x</span>
            <span class="ow">or</span> <span class="n">result_max_x</span> <span class="o">&gt;</span> <span class="n">orig_max_x</span> <span class="o">+</span> <span class="n">tolerance_x</span>
            <span class="ow">or</span> <span class="n">result_min_y</span> <span class="o">&lt;</span> <span class="n">orig_min_y</span> <span class="o">-</span> <span class="n">tolerance_y</span>
            <span class="ow">or</span> <span class="n">result_max_y</span> <span class="o">&gt;</span> <span class="n">orig_max_y</span> <span class="o">+</span> <span class="n">tolerance_y</span>
        <span class="p">):</span>
            <span class="n">bounds_extension_detected</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Reject if we detect triangular spikes, excessive edges, or bounds violations</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">triangular_spike_detected</span>
            <span class="ow">or</span> <span class="n">very_acute_angle_count</span> <span class="o">&gt;</span> <span class="mi">2</span>  <span class="c1"># Multiple very acute angles</span>
            <span class="ow">or</span> <span class="n">excessive_edge_detected</span>
            <span class="ow">or</span> <span class="n">bounds_extension_detected</span>
        <span class="p">):</span>  <span class="c1"># Any significant bounds extension</span>
            <span class="k">return</span> <span class="n">ring</span>

        <span class="c1"># Convert back to a list and ensure it&#39;s closed</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">joined_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vectorize_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a binary mask to vector polygons.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (numpy.ndarray): Binary mask where non-zero values represent objects</span>
<span class="sd">            transform (rasterio.transform.Affine): Affine transformation matrix</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of GeoJSON features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only process non-zero values (actual objects)</span>
                <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">features_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rasterize_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts vector features back to a raster mask.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (list): List of GeoJSON features</span>
<span class="sd">            shape (tuple): Shape of the output raster (height, width)</span>
<span class="sd">            transform (rasterio.transform.Affine): Affine transformation matrix</span>
<span class="sd">            dtype (numpy.dtype, optional): Data type of the output raster</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Rasterized mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span>
            <span class="p">],</span>
            <span class="n">out_shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="c1"># The following helper functions are from the original code</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_orientation</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the orientation angle of a contour.</span>

<span class="sd">        Args:</span>
<span class="sd">            contour (numpy.ndarray): Array of shape (n, 2) containing point coordinates</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Orientation angle in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">box</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simplify a contour using the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            contour (numpy.ndarray): Array of shape (n, 2) containing point coordinates</span>
<span class="sd">            eps (float, optional): Epsilon value for simplification</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Simplified contour</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rdp</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataframe</span><span class="p">(</span><span class="n">ring</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a ring to a pandas DataFrame with line segment information.</span>

<span class="sd">        Args:</span>
<span class="sd">            ring (numpy.ndarray): Array of shape (n, 2) containing point coordinates</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame with line segment information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]))</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">57.2958</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_orientation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add orientation information to the DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame with line segment information</span>
<span class="sd">            angle (float): Orientation angle in degrees</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Modifies the DataFrame in-place</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rtangle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">+</span> <span class="mi">90</span>
        <span class="n">is_parallel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">45</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="mi">45</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">45</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle_atan_deg&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="mi">45</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_parallel</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">rtangle</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">align</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align line segments to their nearest orthogonal direction.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame with line segment information</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame with aligned line segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle edge case with empty dataframe</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df_clone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Ensure angle column exists and has valid values</span>
        <span class="k">if</span> <span class="s2">&quot;angle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># If angle data is missing, add default angles based on atan2</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;angle_atan&quot;</span><span class="p">]</span>

        <span class="c1"># Ensure length and center point data is valid</span>
        <span class="k">if</span> <span class="s2">&quot;len&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Recalculate lengths if missing</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;cx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">if</span> <span class="s2">&quot;cy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clone</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Apply orthogonal alignment</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">df_clone</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">df_clone</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_lines</span><span class="p">(</span><span class="n">df_aligned</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge collinear line segments.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_aligned (pandas.DataFrame): DataFrame with aligned line segments</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame with merged line segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ortho_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">df_aligned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">(</span><span class="n">df_aligned</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">!=</span> <span class="n">df_aligned</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">group_cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">cumlen</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">ortho_lines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">group_cx</span><span class="p">,</span> <span class="n">group_cy</span><span class="p">,</span> <span class="n">cumlen</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">ortho_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">rot_angle</span> <span class="ow">in</span> <span class="n">ortho_lines</span><span class="p">:</span>
            <span class="n">X1</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
            <span class="n">X2</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
            <span class="n">Y1</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
            <span class="n">Y2</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>

            <span class="n">ortho_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">X1</span><span class="p">,</span>
                    <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">Y1</span><span class="p">,</span>
                    <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">X2</span><span class="p">,</span>
                    <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">Y2</span><span class="p">,</span>
                    <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
                    <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">cx</span><span class="p">,</span>
                    <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">cy</span><span class="p">,</span>
                    <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">rot_angle</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Improved fix: Prevent merging that would create triangular or problematic shapes</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span>
        <span class="p">):</span>  <span class="c1"># join first and last segment if they&#39;re in same direction</span>
            <span class="c1"># Check if merging would result in 3 or 4 segments (potentially triangular)</span>
            <span class="n">resulting_segments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">resulting_segments</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># For very small polygons, be extra cautious about merging</span>
                <span class="c1"># Calculate the spatial relationship between first and last segments</span>
                <span class="n">first_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">],</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]])</span>
                <span class="n">last_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">],</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]])</span>
                <span class="n">center_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">first_center</span> <span class="o">-</span> <span class="n">last_center</span><span class="p">)</span>

                <span class="c1"># Get average segment length for comparison</span>
                <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">ortho_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span>

                <span class="c1"># Only merge if segments are close enough and it won&#39;t create degenerate shapes</span>
                <span class="k">if</span> <span class="n">center_distance</span> <span class="o">&gt;</span> <span class="n">avg_length</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="c1"># Skip merging - segments are too far apart</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Proceed with merging only for well-connected segments</span>
                    <span class="n">totlen</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
                    <span class="n">merge_cx</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                    <span class="n">merge_cy</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                    <span class="n">rot_angle</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span>
                    <span class="n">X1</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                    <span class="n">X2</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                    <span class="n">Y1</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                    <span class="n">Y2</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>

                    <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">X1</span><span class="p">,</span>
                        <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">Y1</span><span class="p">,</span>
                        <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">X2</span><span class="p">,</span>
                        <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">Y2</span><span class="p">,</span>
                        <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="n">totlen</span><span class="p">,</span>
                        <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">merge_cx</span><span class="p">,</span>
                        <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">merge_cy</span><span class="p">,</span>
                        <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">rot_angle</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">ortho_list</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For larger polygons, proceed with standard merging</span>
                <span class="n">totlen</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
                <span class="n">merge_cx</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                <span class="n">merge_cy</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;len&quot;</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">totlen</span>

                <span class="n">rot_angle</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span>
                <span class="n">X1</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                <span class="n">X2</span> <span class="o">=</span> <span class="n">merge_cx</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                <span class="n">Y1</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">-</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>
                <span class="n">Y2</span> <span class="o">=</span> <span class="n">merge_cy</span> <span class="o">+</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span>

                <span class="n">ortho_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">X1</span><span class="p">,</span>
                    <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">Y1</span><span class="p">,</span>
                    <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">X2</span><span class="p">,</span>
                    <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">Y2</span><span class="p">,</span>
                    <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="n">totlen</span><span class="p">,</span>
                    <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">merge_cx</span><span class="p">,</span>
                    <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">merge_cy</span><span class="p">,</span>
                    <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="n">rot_angle</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ortho_list</span> <span class="o">=</span> <span class="n">ortho_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ortho_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ortho_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ortho_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_intersection</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the intersection point of two line segments.</span>

<span class="sd">        Args:</span>
<span class="sd">            x1, y1, x2, y2: Coordinates of the first line segment</span>
<span class="sd">            x3, y3, x4, y4: Coordinates of the second line segment</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: [x, y] coordinates of the intersection point</span>

<span class="sd">        Raises:</span>
<span class="sd">            ZeroDivisionError: If the lines are parallel or collinear</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the denominator of the intersection formula</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span>

        <span class="c1"># Check if lines are parallel or collinear (denominator close to zero)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">denominator</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">(</span><span class="s2">&quot;Lines are parallel or collinear&quot;</span><span class="p">)</span>

        <span class="n">px</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">*</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span> <span class="o">*</span> <span class="n">x4</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="n">py</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">*</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span> <span class="o">*</span> <span class="n">x4</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">denominator</span>

        <span class="c1"># Check if the intersection point is within a reasonable distance</span>
        <span class="c1"># from both line segments to avoid extreme extrapolation</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">point_on_segment</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="c1"># Check if point (x,y) is near the line segment from (x1,y1) to (x2,y2)</span>
            <span class="c1"># First check if it&#39;s near the infinite line</span>
            <span class="n">line_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_len</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tolerance</span>

            <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">line_len</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Check distance to the infinite line</span>
            <span class="n">proj_x</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">proj_y</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>
            <span class="n">dist_to_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">proj_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">proj_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Check if the projection is near the segment, not just the infinite line</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tolerance</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="c1"># If far from the segment, compute distance to the nearest endpoint</span>
                <span class="n">dist_to_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">dist_to_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">dist_to_start</span><span class="p">,</span> <span class="n">dist_to_end</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tolerance</span> <span class="o">*</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">dist_to_line</span> <span class="o">&lt;=</span> <span class="n">tolerance</span>

        <span class="c1"># Check if intersection is reasonably close to both line segments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">point_on_segment</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">point_on_segment</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># If intersection is far from segments, it&#39;s probably extrapolating too much</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intersection point too far from line segments&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">join_ring</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join line segments to form a closed ring.</span>

<span class="sd">        Args:</span>
<span class="sd">            merged_df (pandas.DataFrame): DataFrame with merged line segments</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Array of shape (1, n, 2) containing the ring coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle edge cases</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Not enough segments to form a valid polygon</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>

        <span class="n">ring</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Find intersections between adjacent line segments</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">intersection</span> <span class="o">=</span> <span class="n">find_intersection</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>

                <span class="c1"># Check if the intersection point is too far from either line segment</span>
                <span class="c1"># This helps prevent extending edges beyond reasonable bounds</span>
                <span class="n">dist_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">dist_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Use the maximum of line segment lengths as a reference</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Improved intersection validation</span>
                <span class="c1"># Calculate angle between segments to detect sharp corners</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">])</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">])</span>
                <span class="n">v1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
                <span class="n">v2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1_norm</span> <span class="o">*</span> <span class="n">v2_norm</span><span class="p">)</span>
                    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>

                    <span class="c1"># Check for very sharp angles that could create triangular artifacts</span>
                    <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span>
                    <span class="p">)</span>  <span class="c1"># &lt;30 or &gt;150</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Determine whether to use intersection or segment endpoint</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">dist_to_seg1</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                    <span class="ow">or</span> <span class="n">dist_to_seg2</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                    <span class="ow">or</span> <span class="n">is_sharp_angle</span>
                <span class="p">):</span>
                    <span class="c1"># Use a more conservative approach for problematic intersections</span>
                    <span class="c1"># Use the closer endpoint between segments</span>
                    <span class="n">dist_x2_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">dist_x3_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">dist_x2_to_seg2</span> <span class="o">&lt;=</span> <span class="n">dist_x3_to_seg1</span><span class="p">:</span>
                        <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If intersection calculation fails, use the endpoint of the first segment</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>

        <span class="c1"># Connect last segment with first segment</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="n">find_intersection</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>

            <span class="c1"># Check if the intersection point is too far from either line segment</span>
            <span class="n">dist_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">dist_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Apply same sharp angle detection for closing segment</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">])</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">])</span>
            <span class="n">v1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="n">v2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v1_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1_norm</span> <span class="o">*</span> <span class="n">v2_norm</span><span class="p">)</span>
                <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>
                <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_sharp_angle</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">dist_to_seg1</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="ow">or</span> <span class="n">dist_to_seg2</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="ow">or</span> <span class="n">is_sharp_angle</span>
            <span class="p">):</span>
                <span class="c1"># Use conservative approach for closing segment</span>
                <span class="n">dist_x2_to_seg2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y4</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">dist_x3_to_seg1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">dist_x2_to_seg2</span> <span class="o">&lt;=</span> <span class="n">dist_x3_to_seg1</span><span class="p">:</span>
                    <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If intersection calculation fails, use the endpoint of the last segment</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>

        <span class="c1"># Ensure the ring is closed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ring</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rdp</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simplifies a given array of points using the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            epsilon (float, optional): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>
<span class="sd">            algo (str, optional): Algorithm to use (&#39;iter&#39; or &#39;rec&#39;)</span>
<span class="sd">            return_mask (bool, optional): Whether to return a mask instead of the simplified array</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray or list: Simplified points or mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">pldist</span>

        <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;iter&quot;</span><span class="p">:</span>
            <span class="n">algo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">rdp_iter</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="n">return_mask</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;rec&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_mask</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;return_mask=True not supported with algo=&quot;rec&quot;&#39;</span>
                <span class="p">)</span>
            <span class="n">algo</span> <span class="o">=</span> <span class="n">rdp_rec</span>

        <span class="k">if</span> <span class="s2">&quot;numpy&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">M</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">algo</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">algo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pldist</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the distance from &#39;point&#39; to the line given by &#39;start&#39; and &#39;end&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            point (numpy.ndarray): Point coordinates</span>
<span class="sd">            start (numpy.ndarray): Start point of the line</span>
<span class="sd">            end (numpy.ndarray): End point of the line</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Distance from point to line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="c1"># Fix for NumPy 2.0 deprecation warning - handle 2D vectors properly</span>
        <span class="c1"># Instead of using cross product directly, calculate the area of the</span>
        <span class="c1"># parallelogram formed by the vectors and divide by the length of the line</span>
        <span class="n">line_vec</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">point_vec</span> <span class="o">=</span> <span class="n">point</span> <span class="o">-</span> <span class="n">start</span>

        <span class="c1"># Area of parallelogram = |a|*|b|*sin()</span>
        <span class="c1"># For 2D vectors: |ab| = |a|*|b|*sin() = determinant([ax, ay], [bx, by])</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">line_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">point_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">point_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Distance = Area / |line_vec|</span>
        <span class="k">return</span> <span class="n">area</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rdp_rec</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">pldist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursive implementation of the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            epsilon (float): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Simplified points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">dmax</span> <span class="o">=</span> <span class="n">d</span>

        <span class="k">if</span> <span class="n">dmax</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">rdp_rec</span><span class="p">(</span><span class="n">M</span><span class="p">[:</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rdp_rec</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">index</span><span class="p">:],</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rdp_iter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">pldist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal iterative implementation of the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            start_index (int): Start index</span>
<span class="sd">            last_index (int): Last index</span>
<span class="sd">            epsilon (float): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Boolean mask of points to keep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">])</span>
        <span class="n">global_start_index</span> <span class="o">=</span> <span class="n">start_index</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">last_index</span> <span class="o">-</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">stk</span><span class="p">:</span>
            <span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="n">dmax</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">start_index</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">global_start_index</span><span class="p">]:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">start_index</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">last_index</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">dmax</span> <span class="o">=</span> <span class="n">d</span>

            <span class="k">if</span> <span class="n">dmax</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start_index</span><span class="p">,</span> <span class="n">index</span><span class="p">])</span>
                <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="p">):</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">global_start_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">indices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rdp_iter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">pldist</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterative implementation of the Ramer-Douglas-Peucker algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            M (numpy.ndarray): Array of shape (n, d) containing point coordinates</span>
<span class="sd">            epsilon (float): Epsilon value for simplification</span>
<span class="sd">            dist (callable, optional): Distance function</span>
<span class="sd">            return_mask (bool, optional): Whether to return a mask instead of the simplified array</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Simplified points or boolean mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">_rdp_iter</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">M</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Read the raster data</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the first band (assuming it contains the mask)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Extract shapes from the raster mask</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">))</span>

        <span class="c1"># Initialize progress bar</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span><span class="si">}</span><span class="s2"> features...&quot;</span><span class="p">)</span>

        <span class="c1"># Convert shapes to GeoJSON features</span>
        <span class="n">features_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting features&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;shape&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only process non-zero values (actual objects)</span>
                <span class="c1"># Convert GeoJSON geometry to Shapely polygon</span>
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Skip tiny polygons</span>
                <span class="k">if</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
                    <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Check if shape is triangular and if we want to avoid triangular shapes</span>
                <span class="k">if</span> <span class="n">detect_triangles</span><span class="p">:</span>
                    <span class="c1"># Create a simplified version to check number of vertices</span>
                    <span class="n">simple_polygon</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">simple_polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span>
                    <span class="p">):</span>  <span class="c1"># 3 points + closing point</span>
                        <span class="c1"># Likely a triangular shape - skip orthogonalization</span>
                        <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                <span class="c1"># Process larger, non-triangular polygons</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Convert shapely polygon to a ring format for orthogonalization</span>
                    <span class="n">exterior_ring</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
                    <span class="n">interior_rings</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">interior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">interior</span> <span class="ow">in</span> <span class="n">polygon</span><span class="o">.</span><span class="n">interiors</span>
                    <span class="p">]</span>

                    <span class="c1"># Calculate bounding box aspect ratio to help with parameter tuning</span>
                    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span>
                    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

                    <span class="c1"># Determine if this shape is likely to be a building/rectangular object</span>
                    <span class="c1"># Long thin objects might require different treatment</span>
                    <span class="n">is_rectangular</span> <span class="o">=</span> <span class="n">aspect_ratio</span> <span class="o">&lt;</span> <span class="mf">3.0</span>

                    <span class="c1"># Rectangular objects usually need more careful orthogonalization</span>
                    <span class="n">epsilon_adjusted</span> <span class="o">=</span> <span class="n">epsilon</span>
                    <span class="n">min_segments_adjusted</span> <span class="o">=</span> <span class="n">min_segments</span>

                    <span class="k">if</span> <span class="n">is_rectangular</span><span class="p">:</span>
                        <span class="c1"># For rectangular objects, use more conservative epsilon</span>
                        <span class="n">epsilon_adjusted</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="mf">0.75</span>
                        <span class="c1"># Ensure we get at least 4 points for a proper rectangle</span>
                        <span class="n">min_segments_adjusted</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_segments</span><span class="p">)</span>

                    <span class="c1"># Orthogonalize the exterior and interior rings</span>
                    <span class="n">orthogonalized_exterior</span> <span class="o">=</span> <span class="n">orthogonalize_ring</span><span class="p">(</span>
                        <span class="n">exterior_ring</span><span class="p">,</span>
                        <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon_adjusted</span><span class="p">,</span>
                        <span class="n">min_segments</span><span class="o">=</span><span class="n">min_segments_adjusted</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">orthogonalized_interiors</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">orthogonalize_ring</span><span class="p">(</span>
                            <span class="n">ring</span><span class="p">,</span>
                            <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon_adjusted</span><span class="p">,</span>
                            <span class="n">min_segments</span><span class="o">=</span><span class="n">min_segments_adjusted</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">interior_rings</span>
                    <span class="p">]</span>

                    <span class="c1"># Validate the result - calculate area change</span>
                    <span class="n">original_area</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">orthogonalized_poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">orthogonalized_exterior</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">orthogonalized_poly</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                        <span class="n">area_ratio</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">orthogonalized_poly</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">original_area</span>
                            <span class="k">if</span> <span class="n">original_area</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>

                        <span class="c1"># If area changed too much, revert to original</span>
                        <span class="k">if</span> <span class="n">area_ratio</span> <span class="o">&lt;</span> <span class="n">area_tolerance</span> <span class="ow">or</span> <span class="n">area_ratio</span> <span class="o">&gt;</span> <span class="p">(</span>
                            <span class="mf">1.0</span> <span class="o">/</span> <span class="n">area_tolerance</span>
                        <span class="p">):</span>
                            <span class="c1"># Use original polygon instead</span>
                            <span class="n">geometry</span> <span class="o">=</span> <span class="n">shape</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Create a new geometry with orthogonalized rings</span>
                            <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">orthogonalized_exterior</span><span class="p">],</span>
                            <span class="p">}</span>

                            <span class="c1"># Add interior rings if they exist</span>
                            <span class="k">if</span> <span class="n">orthogonalized_interiors</span><span class="p">:</span>
                                <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">ring</span> <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">orthogonalized_interiors</span><span class="p">]</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If resulting polygon is invalid, use original</span>
                        <span class="n">geometry</span> <span class="o">=</span> <span class="n">shape</span>

                    <span class="c1"># Add the feature to the list</span>
                    <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Keep the original shape if orthogonalization fails</span>
                    <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)},</span>
                            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="c1"># Create the final GeoJSON structure</span>
        <span class="n">geojson</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)}},</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features_list</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Convert to GeoDataFrame and set the CRS</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Save to file if output_path is provided</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.plot_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">bright</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chnls</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span></code>

<a href="#geoai.utils.plot_batch" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot a batch of images and masks. This function is adapted from the plot_batch()
function in the torchgeo library at
https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html
Credit to the torchgeo developers for the original implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The batch containing images and masks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bright</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The brightness factor. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cols</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of columns in the plot grid. Defaults to 4.</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of each plot. Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chnls</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The channels to use for RGB. Defaults to [2, 1, 0].</p>
              </div>
            </td>
            <td>
                  <code>[2, 1, 0]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to use for masks. Defaults to "Blues".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Blues&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_batch</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">bright</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">chnls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a batch of images and masks. This function is adapted from the plot_batch()</span>
<span class="sd">    function in the torchgeo library at</span>
<span class="sd">    https://torchgeo.readthedocs.io/en/stable/tutorials/earth_surface_water.html</span>
<span class="sd">    Credit to the torchgeo developers for the original implementation.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (Dict[str, Any]): The batch containing images and masks.</span>
<span class="sd">        bright (float, optional): The brightness factor. Defaults to 1.0.</span>
<span class="sd">        cols (int, optional): The number of columns in the plot grid. Defaults to 4.</span>
<span class="sd">        width (int, optional): The width of each plot. Defaults to 5.</span>
<span class="sd">        chnls (List[int], optional): The channels to use for RGB. Defaults to [2, 1, 0].</span>
<span class="sd">        cmap (str, optional): The colormap to use for masks. Defaults to &quot;Blues&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">torchgeo.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">unbind_samples</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Your torchgeo version is too old. Please upgrade to the latest version using &#39;pip install -U torchgeo&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get the samples and the number of items in the batch</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">unbind_samples</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="c1"># if batch contains images and masks, the number of images will be doubled</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># calculate the number of rows in the grid</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">cols</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">cols</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># create a grid</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">):</span>
        <span class="c1"># plot the images on the even axis</span>
        <span class="n">plot_images</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span>
            <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[::</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">chnls</span><span class="o">=</span><span class="n">chnls</span><span class="p">,</span>
            <span class="n">bright</span><span class="o">=</span><span class="n">bright</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># plot the masks on the odd axis</span>
        <span class="n">plot_masks</span><span class="p">(</span><span class="n">masks</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span> <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">plot_images</span><span class="p">(</span>
                <span class="n">images</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span>
                <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">chnls</span><span class="o">=</span><span class="n">chnls</span><span class="p">,</span>
                <span class="n">bright</span><span class="o">=</span><span class="n">bright</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">plot_masks</span><span class="p">(</span>
                <span class="n">masks</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="n">samples</span><span class="p">),</span> <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.plot_images" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">chnls</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bright</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

<a href="#geoai.utils.plot_images" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot a list of images.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>images</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The images to plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axs</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="matplotlib.pyplot.Axes">Axes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axes to plot the images on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chnls</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The channels to use for RGB. Defaults to [2, 1, 0].</p>
              </div>
            </td>
            <td>
                  <code>[2, 1, 0]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bright</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The brightness factor. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_images</span><span class="p">(</span>
    <span class="n">images</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">axs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span>
    <span class="n">chnls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">bright</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a list of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        images (Iterable[torch.Tensor]): The images to plot.</span>
<span class="sd">        axs (Iterable[plt.Axes]): The axes to plot the images on.</span>
<span class="sd">        chnls (List[int], optional): The channels to use for RGB. Defaults to [2, 1, 0].</span>
<span class="sd">        bright (float, optional): The brightness factor. Defaults to 1.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">bright</span> <span class="o">*</span> <span class="n">img</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">chnls</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.plot_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_masks</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span></code>

<a href="#geoai.utils.plot_masks" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot a list of masks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>masks</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The masks to plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axs</code>
            </td>
            <td>
                  <code><span title="collections.abc.Iterable">Iterable</span>[<span title="matplotlib.pyplot.Axes">Axes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axes to plot the masks on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to use. Defaults to "Blues".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Blues&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_masks</span><span class="p">(</span>
    <span class="n">masks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">axs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span> <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Blues&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a list of masks.</span>

<span class="sd">    Args:</span>
<span class="sd">        masks (Iterable[torch.Tensor]): The masks to plot.</span>
<span class="sd">        axs (Iterable[plt.Axes]): The axes to plot the masks on.</span>
<span class="sd">        cmap (str, optional): The colormap to use. Defaults to &quot;Blues&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.plot_performance_metrics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_performance_metrics</span><span class="p">(</span><span class="n">history_path</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.plot_performance_metrics" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot performance metrics from a history object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>history_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The history object to plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure size.</p>
              </div>
            </td>
            <td>
                  <code>(15, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print the best and final metrics.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7522</span>
<span class="normal">7523</span>
<span class="normal">7524</span>
<span class="normal">7525</span>
<span class="normal">7526</span>
<span class="normal">7527</span>
<span class="normal">7528</span>
<span class="normal">7529</span>
<span class="normal">7530</span>
<span class="normal">7531</span>
<span class="normal">7532</span>
<span class="normal">7533</span>
<span class="normal">7534</span>
<span class="normal">7535</span>
<span class="normal">7536</span>
<span class="normal">7537</span>
<span class="normal">7538</span>
<span class="normal">7539</span>
<span class="normal">7540</span>
<span class="normal">7541</span>
<span class="normal">7542</span>
<span class="normal">7543</span>
<span class="normal">7544</span>
<span class="normal">7545</span>
<span class="normal">7546</span>
<span class="normal">7547</span>
<span class="normal">7548</span>
<span class="normal">7549</span>
<span class="normal">7550</span>
<span class="normal">7551</span>
<span class="normal">7552</span>
<span class="normal">7553</span>
<span class="normal">7554</span>
<span class="normal">7555</span>
<span class="normal">7556</span>
<span class="normal">7557</span>
<span class="normal">7558</span>
<span class="normal">7559</span>
<span class="normal">7560</span>
<span class="normal">7561</span>
<span class="normal">7562</span>
<span class="normal">7563</span>
<span class="normal">7564</span>
<span class="normal">7565</span>
<span class="normal">7566</span>
<span class="normal">7567</span>
<span class="normal">7568</span>
<span class="normal">7569</span>
<span class="normal">7570</span>
<span class="normal">7571</span>
<span class="normal">7572</span>
<span class="normal">7573</span>
<span class="normal">7574</span>
<span class="normal">7575</span>
<span class="normal">7576</span>
<span class="normal">7577</span>
<span class="normal">7578</span>
<span class="normal">7579</span>
<span class="normal">7580</span>
<span class="normal">7581</span>
<span class="normal">7582</span>
<span class="normal">7583</span>
<span class="normal">7584</span>
<span class="normal">7585</span>
<span class="normal">7586</span>
<span class="normal">7587</span>
<span class="normal">7588</span>
<span class="normal">7589</span>
<span class="normal">7590</span>
<span class="normal">7591</span>
<span class="normal">7592</span>
<span class="normal">7593</span>
<span class="normal">7594</span>
<span class="normal">7595</span>
<span class="normal">7596</span>
<span class="normal">7597</span>
<span class="normal">7598</span>
<span class="normal">7599</span>
<span class="normal">7600</span>
<span class="normal">7601</span>
<span class="normal">7602</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_performance_metrics</span><span class="p">(</span>
    <span class="n">history_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot performance metrics from a history object.</span>

<span class="sd">    Args:</span>
<span class="sd">        history_path: The history object to plot.</span>
<span class="sd">        figsize: The figure size.</span>
<span class="sd">        verbose: Whether to print the best and final metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">history_path</span><span class="p">)</span>

    <span class="c1"># Handle different key naming conventions</span>
    <span class="n">train_loss_key</span> <span class="o">=</span> <span class="s2">&quot;train_losses&quot;</span> <span class="k">if</span> <span class="s2">&quot;train_losses&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;train_loss&quot;</span>
    <span class="n">val_loss_key</span> <span class="o">=</span> <span class="s2">&quot;val_losses&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_losses&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_loss&quot;</span>
    <span class="n">val_iou_key</span> <span class="o">=</span> <span class="s2">&quot;val_ious&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_ious&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_iou&quot;</span>
    <span class="n">val_dice_key</span> <span class="o">=</span> <span class="s2">&quot;val_dices&quot;</span> <span class="k">if</span> <span class="s2">&quot;val_dices&quot;</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">else</span> <span class="s2">&quot;val_dice&quot;</span>

    <span class="c1"># Determine number of subplots based on available metrics</span>
    <span class="n">has_dice</span> <span class="o">=</span> <span class="n">val_dice_key</span> <span class="ow">in</span> <span class="n">history</span>
    <span class="n">n_plots</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">has_dice</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_dice</span> <span class="k">else</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Plot loss</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">train_loss_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">train_loss_key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train Loss&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val_loss_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_loss_key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Val Loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Plot IoU</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val_iou_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_iou_key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Val IoU&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;IoU Score&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;IoU&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Plot Dice if available</span>
    <span class="k">if</span> <span class="n">has_dice</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_dice_key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Val Dice&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Dice Score&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dice&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;dpi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="k">if</span> <span class="s2">&quot;bbox_inches&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;bbox_inches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tight&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val_iou_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best IoU: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_iou_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final IoU: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_iou_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_dice_key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best Dice: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">val_dice_key</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Dice: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">val_dice_key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.plot_prediction_comparison" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_prediction_comparison</span><span class="p">(</span><span class="n">original_image</span><span class="p">,</span> <span class="n">prediction_image</span><span class="p">,</span> <span class="n">ground_truth_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prediction_colormap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ground_truth_colormap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">original_colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.plot_prediction_comparison" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot original image, prediction, and optional ground truth side by side.</p>
<p>Supports input as file paths, NumPy arrays, or PIL Images. For multi-band
images, selected channels can be specified via <code>indexes</code>. If the image data
is not normalized (e.g., Sentinel-2 [0, 10000]), the <code>divider</code> can be used
to scale values for visualization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>original_image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original input image as a file path, NumPy array, or PIL Image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Predicted segmentation mask image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth_image</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image.Image">Image</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth mask image. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>titles</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of titles for the subplots. If not provided, default titles are used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the entire figure in inches. Defaults to (15, 5).</p>
              </div>
            </td>
            <td>
                  <code>(15, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified, saves the figure to this path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_plot</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display the figure using plt.show(). Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prediction_colormap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for the prediction mask. Defaults to "gray".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gray&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth_colormap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for the ground truth mask. Defaults to "gray".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gray&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_colormap</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for the original image if it's grayscale. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band/channel indexes (0-based for NumPy, 1-based for rasterio) to extract from the original image.
Useful for multi-band imagery like Sentinel-2. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>divider</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to divide the original image by for normalization (e.g., 10000 for reflectance). Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>matplotlib.figure.Figure:
The generated matplotlib figure object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7618</span>
<span class="normal">7619</span>
<span class="normal">7620</span>
<span class="normal">7621</span>
<span class="normal">7622</span>
<span class="normal">7623</span>
<span class="normal">7624</span>
<span class="normal">7625</span>
<span class="normal">7626</span>
<span class="normal">7627</span>
<span class="normal">7628</span>
<span class="normal">7629</span>
<span class="normal">7630</span>
<span class="normal">7631</span>
<span class="normal">7632</span>
<span class="normal">7633</span>
<span class="normal">7634</span>
<span class="normal">7635</span>
<span class="normal">7636</span>
<span class="normal">7637</span>
<span class="normal">7638</span>
<span class="normal">7639</span>
<span class="normal">7640</span>
<span class="normal">7641</span>
<span class="normal">7642</span>
<span class="normal">7643</span>
<span class="normal">7644</span>
<span class="normal">7645</span>
<span class="normal">7646</span>
<span class="normal">7647</span>
<span class="normal">7648</span>
<span class="normal">7649</span>
<span class="normal">7650</span>
<span class="normal">7651</span>
<span class="normal">7652</span>
<span class="normal">7653</span>
<span class="normal">7654</span>
<span class="normal">7655</span>
<span class="normal">7656</span>
<span class="normal">7657</span>
<span class="normal">7658</span>
<span class="normal">7659</span>
<span class="normal">7660</span>
<span class="normal">7661</span>
<span class="normal">7662</span>
<span class="normal">7663</span>
<span class="normal">7664</span>
<span class="normal">7665</span>
<span class="normal">7666</span>
<span class="normal">7667</span>
<span class="normal">7668</span>
<span class="normal">7669</span>
<span class="normal">7670</span>
<span class="normal">7671</span>
<span class="normal">7672</span>
<span class="normal">7673</span>
<span class="normal">7674</span>
<span class="normal">7675</span>
<span class="normal">7676</span>
<span class="normal">7677</span>
<span class="normal">7678</span>
<span class="normal">7679</span>
<span class="normal">7680</span>
<span class="normal">7681</span>
<span class="normal">7682</span>
<span class="normal">7683</span>
<span class="normal">7684</span>
<span class="normal">7685</span>
<span class="normal">7686</span>
<span class="normal">7687</span>
<span class="normal">7688</span>
<span class="normal">7689</span>
<span class="normal">7690</span>
<span class="normal">7691</span>
<span class="normal">7692</span>
<span class="normal">7693</span>
<span class="normal">7694</span>
<span class="normal">7695</span>
<span class="normal">7696</span>
<span class="normal">7697</span>
<span class="normal">7698</span>
<span class="normal">7699</span>
<span class="normal">7700</span>
<span class="normal">7701</span>
<span class="normal">7702</span>
<span class="normal">7703</span>
<span class="normal">7704</span>
<span class="normal">7705</span>
<span class="normal">7706</span>
<span class="normal">7707</span>
<span class="normal">7708</span>
<span class="normal">7709</span>
<span class="normal">7710</span>
<span class="normal">7711</span>
<span class="normal">7712</span>
<span class="normal">7713</span>
<span class="normal">7714</span>
<span class="normal">7715</span>
<span class="normal">7716</span>
<span class="normal">7717</span>
<span class="normal">7718</span>
<span class="normal">7719</span>
<span class="normal">7720</span>
<span class="normal">7721</span>
<span class="normal">7722</span>
<span class="normal">7723</span>
<span class="normal">7724</span>
<span class="normal">7725</span>
<span class="normal">7726</span>
<span class="normal">7727</span>
<span class="normal">7728</span>
<span class="normal">7729</span>
<span class="normal">7730</span>
<span class="normal">7731</span>
<span class="normal">7732</span>
<span class="normal">7733</span>
<span class="normal">7734</span>
<span class="normal">7735</span>
<span class="normal">7736</span>
<span class="normal">7737</span>
<span class="normal">7738</span>
<span class="normal">7739</span>
<span class="normal">7740</span>
<span class="normal">7741</span>
<span class="normal">7742</span>
<span class="normal">7743</span>
<span class="normal">7744</span>
<span class="normal">7745</span>
<span class="normal">7746</span>
<span class="normal">7747</span>
<span class="normal">7748</span>
<span class="normal">7749</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_prediction_comparison</span><span class="p">(</span>
    <span class="n">original_image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span>
    <span class="n">prediction_image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span>
    <span class="n">ground_truth_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">titles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">prediction_colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ground_truth_colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">original_colormap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">divider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot original image, prediction, and optional ground truth side by side.</span>

<span class="sd">    Supports input as file paths, NumPy arrays, or PIL Images. For multi-band</span>
<span class="sd">    images, selected channels can be specified via `indexes`. If the image data</span>
<span class="sd">    is not normalized (e.g., Sentinel-2 [0, 10000]), the `divider` can be used</span>
<span class="sd">    to scale values for visualization.</span>

<span class="sd">    Args:</span>
<span class="sd">        original_image (Union[str, np.ndarray, Image.Image]):</span>
<span class="sd">            Original input image as a file path, NumPy array, or PIL Image.</span>
<span class="sd">        prediction_image (Union[str, np.ndarray, Image.Image]):</span>
<span class="sd">            Predicted segmentation mask image.</span>
<span class="sd">        ground_truth_image (Optional[Union[str, np.ndarray, Image.Image]], optional):</span>
<span class="sd">            Ground truth mask image. Defaults to None.</span>
<span class="sd">        titles (Optional[List[str]], optional):</span>
<span class="sd">            List of titles for the subplots. If not provided, default titles are used.</span>
<span class="sd">        figsize (Tuple[int, int], optional):</span>
<span class="sd">            Size of the entire figure in inches. Defaults to (15, 5).</span>
<span class="sd">        save_path (Optional[str], optional):</span>
<span class="sd">            If specified, saves the figure to this path. Defaults to None.</span>
<span class="sd">        show_plot (bool, optional):</span>
<span class="sd">            Whether to display the figure using plt.show(). Defaults to True.</span>
<span class="sd">        prediction_colormap (str, optional):</span>
<span class="sd">            Colormap to use for the prediction mask. Defaults to &quot;gray&quot;.</span>
<span class="sd">        ground_truth_colormap (str, optional):</span>
<span class="sd">            Colormap to use for the ground truth mask. Defaults to &quot;gray&quot;.</span>
<span class="sd">        original_colormap (Optional[str], optional):</span>
<span class="sd">            Colormap to use for the original image if it&#39;s grayscale. Defaults to None.</span>
<span class="sd">        indexes (Optional[List[int]], optional):</span>
<span class="sd">            List of band/channel indexes (0-based for NumPy, 1-based for rasterio) to extract from the original image.</span>
<span class="sd">            Useful for multi-band imagery like Sentinel-2. Defaults to None.</span>
<span class="sd">        divider (Optional[float], optional):</span>
<span class="sd">            Value to divide the original image by for normalization (e.g., 10000 for reflectance). Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.figure.Figure:</span>
<span class="sd">            The generated matplotlib figure object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_image</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to load image from various input types.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">img_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indexes</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>  <span class="c1"># 1-based</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_input</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_input</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img_input</span>
            <span class="k">if</span> <span class="n">indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indexes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported image type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="c1"># Load images</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">original_image</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">prediction_image</span><span class="p">)</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_load_image</span><span class="p">(</span><span class="n">ground_truth_image</span><span class="p">)</span> <span class="k">if</span> <span class="n">ground_truth_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># Apply divider normalization if requested</span>
    <span class="k">if</span> <span class="n">divider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">original</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Determine layout</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original Image&quot;</span><span class="p">,</span> <span class="s2">&quot;Prediction&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ground Truth&quot;</span><span class="p">)</span>

    <span class="c1"># Plot original</span>
    <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">original</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">original_colormap</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Prediction</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">prediction_colormap</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Ground truth</span>
    <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">ground_truth_colormap</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.print_raster_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">show_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></code>

<a href="#geoai.utils.print_raster_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Print formatted information about a raster dataset and optionally show a preview.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the raster file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_preview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a visual preview of the raster.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height). Defaults to (10, 8).</p>
              </div>
            </td>
            <td>
                  <code>(10, 8)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing raster information if successful, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_raster_info</span><span class="p">(</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">show_preview</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print formatted information about a raster dataset and optionally show a preview.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the raster file</span>
<span class="sd">        show_preview (bool, optional): Whether to display a visual preview of the raster.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height). Defaults to (10, 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing raster information if successful, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">get_raster_info</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span>

        <span class="c1"># Print basic information</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;===== RASTER INFORMATION: </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2"> =====&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Driver: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimensions: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of bands: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data type: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate Reference System: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Georeferenced Bounds: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel Resolution: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NoData Value: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print band statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- Band Statistics -----&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band_stat</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;band_stats&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std Dev: </span><span class="si">{</span><span class="n">band_stat</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Show a preview if requested</span>
        <span class="k">if</span> <span class="n">show_preview</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># For multi-band images, show RGB composite or first band</span>
                <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># Try to show RGB composite</span>
                    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RGB Preview: </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Show first band for single-band images</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="n">show</span><span class="p">(</span>
                        <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Band 1 Preview: </span><span class="si">{</span><span class="n">raster_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pixel Value&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading raster: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.print_vector_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">show_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></code>

<a href="#geoai.utils.print_vector_info" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Print formatted information about a vector dataset and optionally show a preview.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_preview</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a visual preview of the vector data.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height). Defaults to (10, 8).</p>
              </div>
            </td>
            <td>
                  <code>(10, 8)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing vector information if successful, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_vector_info</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">show_preview</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print formatted information about a vector dataset and optionally show a preview.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>
<span class="sd">        show_preview (bool, optional): Whether to display a visual preview of the vector data.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height). Defaults to (10, 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing vector information if successful, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">get_vector_info</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Print basic information</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;===== VECTOR INFORMATION: </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2"> =====&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Driver: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature count: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;feature_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Geometry types: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;geometry_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate Reference System: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bounds: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of attributes: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;attribute_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute names: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;attribute_names&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print attribute statistics</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;attribute_stats&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- Attribute Statistics -----&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;attribute_stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute: </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">stat_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stat_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stat_value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">stat_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stat_value</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Show a preview if requested</span>
        <span class="k">if</span> <span class="n">show_preview</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vector_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview: </span><span class="si">{</span><span class="n">vector_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># # Show a sample of the attribute table</span>
            <span class="c1"># if not gdf.empty:</span>
            <span class="c1">#     print(&quot;\n----- Sample of attribute table (first 5 rows) -----&quot;)</span>
            <span class="c1">#     print(gdf.head().to_string())</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading vector data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.raster_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">raster_to_vector</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">class_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">unique_attribute_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;geojson&#39;</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.utils.raster_to_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a raster label mask to vector polygons.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input raster file (e.g., GeoTIFF).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output vector file. If None, returns GeoDataFrame without saving.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span> / <span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel values greater than this threshold will be vectorized.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum polygon area in square map units to keep.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for geometry simplification. None for no simplification.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_values</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute field for the class values.</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique_attribute_value</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to generate unique values for each shape within a class.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Format for output file - 'geojson', 'shapefile', 'gpkg'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;geojson&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_result</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to plot the resulting polygons overlaid on the raster.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame: A GeoDataFrame containing the vectorized polygons.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raster_to_vector</span><span class="p">(</span>
    <span class="n">raster_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">min_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">class_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">unique_attribute_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
    <span class="n">plot_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a raster label mask to vector polygons.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_path (str): Path to the input raster file (e.g., GeoTIFF).</span>
<span class="sd">        output_path (str): Path to save the output vector file. If None, returns GeoDataFrame without saving.</span>
<span class="sd">        threshold (int/float): Pixel values greater than this threshold will be vectorized.</span>
<span class="sd">        min_area (float): Minimum polygon area in square map units to keep.</span>
<span class="sd">        simplify_tolerance (float): Tolerance for geometry simplification. None for no simplification.</span>
<span class="sd">        class_values (list): Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</span>
<span class="sd">        attribute_name (str): Name of the attribute field for the class values.</span>
<span class="sd">        unique_attribute_value (bool): Whether to generate unique values for each shape within a class.</span>
<span class="sd">        output_format (str): Format for output file - &#39;geojson&#39;, &#39;shapefile&#39;, &#39;gpkg&#39;.</span>
<span class="sd">        plot_result (bool): Whether to plot the resulting polygons overlaid on the raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: A GeoDataFrame containing the vectorized polygons.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the raster file</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Read the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get metadata</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Create mask based on threshold and class values</span>
        <span class="k">if</span> <span class="n">class_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a mask for each specified class value</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">class_values</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create a mask for values above threshold</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)}</span>
            <span class="n">class_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Default class</span>

        <span class="c1"># Initialize list to store features</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each class value</span>
        <span class="k">for</span> <span class="n">class_val</span> <span class="ow">in</span> <span class="n">class_values</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">class_val</span><span class="p">]</span>
            <span class="n">shape_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Vectorize the mask</span>
            <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
            <span class="p">):</span>
                <span class="c1"># Convert to shapely geometry</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>

                <span class="c1"># Skip small polygons</span>
                <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">min_area</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Simplify geometry if requested</span>
                <span class="k">if</span> <span class="n">simplify_tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tolerance</span><span class="p">)</span>

                <span class="c1"># Add to features list with class value</span>
                <span class="k">if</span> <span class="n">unique_attribute_value</span><span class="p">:</span>
                    <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="n">class_val</span> <span class="o">*</span> <span class="n">shape_count</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="n">class_val</span><span class="p">})</span>

                <span class="n">shape_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create GeoDataFrame</span>
        <span class="k">if</span> <span class="n">all_features</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No features were extracted from the raster.&quot;</span><span class="p">)</span>
            <span class="c1"># Return empty GeoDataFrame with correct CRS</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">([],</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Save to file if requested</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create directory if it doesn&#39;t exist</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Save to file based on format</span>
            <span class="k">if</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;shapefile&quot;</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gpkg&quot;</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported output format: </span><span class="si">{</span><span class="n">output_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vectorized data saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Plot result if requested</span>
        <span class="k">if</span> <span class="n">plot_result</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

            <span class="c1"># Plot raster</span>
            <span class="n">raster_img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">raster_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use first 3 bands for RGB display</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="n">raster_img</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Normalize for display</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span> <span class="o">/</span> <span class="n">rgb</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>

            <span class="c1"># Plot vector boundaries</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raster with Vectorized Boundaries&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.raster_to_vector_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">raster_to_vector_batch</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;*.tif&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">class_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;geojson&#39;</span><span class="p">,</span> <span class="n">merge_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">merge_filename</span><span class="o">=</span><span class="s1">&#39;merged_vectors&#39;</span><span class="p">)</span></code>

<a href="#geoai.utils.raster_to_vector_batch" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Batch convert multiple raster files to vector polygons.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory containing input raster files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save output vector files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pattern to match raster files (e.g., '*.tif').</p>
              </div>
            </td>
            <td>
                  <code>&#39;*.tif&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span> / <span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel values greater than this threshold will be vectorized.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_area</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum polygon area in square map units to keep.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for geometry simplification. None for no simplification.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_values</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute field for the class values.</p>
              </div>
            </td>
            <td>
                  <code>&#39;class&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Format for output files - 'geojson', 'shapefile', 'gpkg'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;geojson&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to merge all output vectors into a single file.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filename for the merged output (without extension).</p>
              </div>
            </td>
            <td>
                  <code>&#39;merged_vectors&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame or None: If merge_output is True, returns the merged GeoDataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raster_to_vector_batch</span><span class="p">(</span>
    <span class="n">input_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*.tif&quot;</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">min_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">class_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
    <span class="n">merge_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">merge_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;merged_vectors&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch convert multiple raster files to vector polygons.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_dir (str): Directory containing input raster files.</span>
<span class="sd">        output_dir (str): Directory to save output vector files.</span>
<span class="sd">        pattern (str): Pattern to match raster files (e.g., &#39;*.tif&#39;).</span>
<span class="sd">        threshold (int/float): Pixel values greater than this threshold will be vectorized.</span>
<span class="sd">        min_area (float): Minimum polygon area in square map units to keep.</span>
<span class="sd">        simplify_tolerance (float): Tolerance for geometry simplification. None for no simplification.</span>
<span class="sd">        class_values (list): Specific pixel values to vectorize. If None, all values &gt; threshold are vectorized.</span>
<span class="sd">        attribute_name (str): Name of the attribute field for the class values.</span>
<span class="sd">        output_format (str): Format for output files - &#39;geojson&#39;, &#39;shapefile&#39;, &#39;gpkg&#39;.</span>
<span class="sd">        merge_output (bool): Whether to merge all output vectors into a single file.</span>
<span class="sd">        merge_filename (str): Filename for the merged output (without extension).</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame or None: If merge_output is True, returns the merged GeoDataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>

    <span class="c1"># Create output directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get list of raster files</span>
    <span class="n">raster_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files matching pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; found in </span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raster_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> raster files to process&quot;</span><span class="p">)</span>

    <span class="c1"># Process each raster file</span>
    <span class="n">gdfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">raster_file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing rasters&quot;</span><span class="p">):</span>
        <span class="c1"># Get output filename</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">raster_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;shapefile&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.shp&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gpkg&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.gpkg&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported output format: </span><span class="si">{</span><span class="n">output_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Convert raster to vector</span>
        <span class="k">if</span> <span class="n">merge_output</span><span class="p">:</span>
            <span class="c1"># Don&#39;t save individual files if merging</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">raster_to_vector</span><span class="p">(</span>
                <span class="n">raster_file</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">min_area</span><span class="o">=</span><span class="n">min_area</span><span class="p">,</span>
                <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
                <span class="n">class_values</span><span class="o">=</span><span class="n">class_values</span><span class="p">,</span>
                <span class="n">attribute_name</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add filename as attribute</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;source_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
                <span class="n">gdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Save individual files</span>
            <span class="n">raster_to_vector</span><span class="p">(</span>
                <span class="n">raster_file</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">out_file</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">min_area</span><span class="o">=</span><span class="n">min_area</span><span class="p">,</span>
                <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
                <span class="n">class_values</span><span class="o">=</span><span class="n">class_values</span><span class="p">,</span>
                <span class="n">attribute_name</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span>
                <span class="n">output_format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Merge output if requested</span>
    <span class="k">if</span> <span class="n">merge_output</span> <span class="ow">and</span> <span class="n">gdfs</span><span class="p">:</span>
        <span class="n">merged_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gdfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Set CRS to the CRS of the first GeoDataFrame</span>
        <span class="k">if</span> <span class="n">merged_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gdfs</span><span class="p">:</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">gdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Save merged output</span>
        <span class="k">if</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">:</span>
            <span class="n">merged_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">merge_filename</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">merged_file</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;shapefile&quot;</span><span class="p">:</span>
            <span class="n">merged_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">merge_filename</span><span class="si">}</span><span class="s2">.shp&quot;</span><span class="p">)</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">merged_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gpkg&quot;</span><span class="p">:</span>
            <span class="n">merged_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">merge_filename</span><span class="si">}</span><span class="s2">.gpkg&quot;</span><span class="p">)</span>
            <span class="n">merged_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">merged_file</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merged vector data saved to </span><span class="si">{</span><span class="n">merged_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged_gdf</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.read_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_raster</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.read_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Reads raster data from various formats using rioxarray.</p>
<p>This function reads raster data from local files or URLs into a rioxarray
data structure with preserved geospatial metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String path to the raster file or URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>band</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Integer or list of integers specifying which band(s) to read.
Defaults to None (all bands).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>masked</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean indicating whether to mask nodata values.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rioxarray.open_rasterio.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataArray">DataArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>xarray.DataArray: A DataArray containing the raster data with geospatial
metadata preserved.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file format is not supported or source cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Read a local GeoTIFF</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">raster</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;path/to/data.tif&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read only band 1 from a remote GeoTIFF</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">raster</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;https://example.com/data.tif&quot;</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read a raster without masking nodata values</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">raster</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;path/to/data.tif&quot;</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4912</span>
<span class="normal">4913</span>
<span class="normal">4914</span>
<span class="normal">4915</span>
<span class="normal">4916</span>
<span class="normal">4917</span>
<span class="normal">4918</span>
<span class="normal">4919</span>
<span class="normal">4920</span>
<span class="normal">4921</span>
<span class="normal">4922</span>
<span class="normal">4923</span>
<span class="normal">4924</span>
<span class="normal">4925</span>
<span class="normal">4926</span>
<span class="normal">4927</span>
<span class="normal">4928</span>
<span class="normal">4929</span>
<span class="normal">4930</span>
<span class="normal">4931</span>
<span class="normal">4932</span>
<span class="normal">4933</span>
<span class="normal">4934</span>
<span class="normal">4935</span>
<span class="normal">4936</span>
<span class="normal">4937</span>
<span class="normal">4938</span>
<span class="normal">4939</span>
<span class="normal">4940</span>
<span class="normal">4941</span>
<span class="normal">4942</span>
<span class="normal">4943</span>
<span class="normal">4944</span>
<span class="normal">4945</span>
<span class="normal">4946</span>
<span class="normal">4947</span>
<span class="normal">4948</span>
<span class="normal">4949</span>
<span class="normal">4950</span>
<span class="normal">4951</span>
<span class="normal">4952</span>
<span class="normal">4953</span>
<span class="normal">4954</span>
<span class="normal">4955</span>
<span class="normal">4956</span>
<span class="normal">4957</span>
<span class="normal">4958</span>
<span class="normal">4959</span>
<span class="normal">4960</span>
<span class="normal">4961</span>
<span class="normal">4962</span>
<span class="normal">4963</span>
<span class="normal">4964</span>
<span class="normal">4965</span>
<span class="normal">4966</span>
<span class="normal">4967</span>
<span class="normal">4968</span>
<span class="normal">4969</span>
<span class="normal">4970</span>
<span class="normal">4971</span>
<span class="normal">4972</span>
<span class="normal">4973</span>
<span class="normal">4974</span>
<span class="normal">4975</span>
<span class="normal">4976</span>
<span class="normal">4977</span>
<span class="normal">4978</span>
<span class="normal">4979</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_raster</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">band</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">masked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads raster data from various formats using rioxarray.</span>

<span class="sd">    This function reads raster data from local files or URLs into a rioxarray</span>
<span class="sd">    data structure with preserved geospatial metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        source: String path to the raster file or URL.</span>
<span class="sd">        band: Integer or list of integers specifying which band(s) to read.</span>
<span class="sd">            Defaults to None (all bands).</span>
<span class="sd">        masked: Boolean indicating whether to mask nodata values.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rioxarray.open_rasterio.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.DataArray: A DataArray containing the raster data with geospatial</span>
<span class="sd">            metadata preserved.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the file format is not supported or source cannot be accessed.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Read a local GeoTIFF</span>
<span class="sd">        &gt;&gt;&gt; raster = read_raster(&quot;path/to/data.tif&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read only band 1 from a remote GeoTIFF</span>
<span class="sd">        &gt;&gt;&gt; raster = read_raster(&quot;https://example.com/data.tif&quot;, band=1)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read a raster without masking nodata values</span>
<span class="sd">        &gt;&gt;&gt; raster = read_raster(&quot;path/to/data.tif&quot;, masked=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RasterioIOError</span>

    <span class="c1"># Determine if source is a URL or local file</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">is_url</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]</span>

    <span class="c1"># If it&#39;s a local file, check if it exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster file does not exist: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Open the raster with rioxarray</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="n">masked</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Handle band selection if specified</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># Convert from 1-based indexing to 0-based indexing</span>
                <span class="n">band_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">band</span><span class="p">]</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">band_indices</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Single band selection (convert from 1-based to 0-based indexing)</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="n">band</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">raster</span>

    <span class="k">except</span> <span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read raster from source &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading raster data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.read_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_vector</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.read_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Reads vector data from various formats including GeoParquet.</p>
<p>This function dynamically determines the file type based on extension
and reads it into a GeoDataFrame. It supports both local files and HTTP/HTTPS URLs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String path to the vector file or URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String or integer specifying which layer to read from multi-layer
files (only applicable for formats like GPKG, GeoJSON, etc.).
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the underlying reader.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>geopandas.GeoDataFrame: A GeoDataFrame containing the vector data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file format is not supported or source cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Read a local shapefile</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;path/to/data.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read a GeoParquet file from URL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;https://example.com/data.parquet&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="go">Read a specific layer from a GeoPackage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;path/to/data.gpkg&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;layer_name&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4835</span>
<span class="normal">4836</span>
<span class="normal">4837</span>
<span class="normal">4838</span>
<span class="normal">4839</span>
<span class="normal">4840</span>
<span class="normal">4841</span>
<span class="normal">4842</span>
<span class="normal">4843</span>
<span class="normal">4844</span>
<span class="normal">4845</span>
<span class="normal">4846</span>
<span class="normal">4847</span>
<span class="normal">4848</span>
<span class="normal">4849</span>
<span class="normal">4850</span>
<span class="normal">4851</span>
<span class="normal">4852</span>
<span class="normal">4853</span>
<span class="normal">4854</span>
<span class="normal">4855</span>
<span class="normal">4856</span>
<span class="normal">4857</span>
<span class="normal">4858</span>
<span class="normal">4859</span>
<span class="normal">4860</span>
<span class="normal">4861</span>
<span class="normal">4862</span>
<span class="normal">4863</span>
<span class="normal">4864</span>
<span class="normal">4865</span>
<span class="normal">4866</span>
<span class="normal">4867</span>
<span class="normal">4868</span>
<span class="normal">4869</span>
<span class="normal">4870</span>
<span class="normal">4871</span>
<span class="normal">4872</span>
<span class="normal">4873</span>
<span class="normal">4874</span>
<span class="normal">4875</span>
<span class="normal">4876</span>
<span class="normal">4877</span>
<span class="normal">4878</span>
<span class="normal">4879</span>
<span class="normal">4880</span>
<span class="normal">4881</span>
<span class="normal">4882</span>
<span class="normal">4883</span>
<span class="normal">4884</span>
<span class="normal">4885</span>
<span class="normal">4886</span>
<span class="normal">4887</span>
<span class="normal">4888</span>
<span class="normal">4889</span>
<span class="normal">4890</span>
<span class="normal">4891</span>
<span class="normal">4892</span>
<span class="normal">4893</span>
<span class="normal">4894</span>
<span class="normal">4895</span>
<span class="normal">4896</span>
<span class="normal">4897</span>
<span class="normal">4898</span>
<span class="normal">4899</span>
<span class="normal">4900</span>
<span class="normal">4901</span>
<span class="normal">4902</span>
<span class="normal">4903</span>
<span class="normal">4904</span>
<span class="normal">4905</span>
<span class="normal">4906</span>
<span class="normal">4907</span>
<span class="normal">4908</span>
<span class="normal">4909</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_vector</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads vector data from various formats including GeoParquet.</span>

<span class="sd">    This function dynamically determines the file type based on extension</span>
<span class="sd">    and reads it into a GeoDataFrame. It supports both local files and HTTP/HTTPS URLs.</span>

<span class="sd">    Args:</span>
<span class="sd">        source: String path to the vector file or URL.</span>
<span class="sd">        layer: String or integer specifying which layer to read from multi-layer</span>
<span class="sd">            files (only applicable for formats like GPKG, GeoJSON, etc.).</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the underlying reader.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: A GeoDataFrame containing the vector data.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the file format is not supported or source cannot be accessed.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Read a local shapefile</span>
<span class="sd">        &gt;&gt;&gt; gdf = read_vector(&quot;path/to/data.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read a GeoParquet file from URL</span>
<span class="sd">        &gt;&gt;&gt; gdf = read_vector(&quot;https://example.com/data.parquet&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        Read a specific layer from a GeoPackage</span>
<span class="sd">        &gt;&gt;&gt; gdf = read_vector(&quot;path/to/data.gpkg&quot;, layer=&quot;layer_name&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">fiona</span>

    <span class="c1"># Determine if source is a URL or local file</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">is_url</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]</span>

    <span class="c1"># If it&#39;s a local file, check if it exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File does not exist: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get file extension</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Handle GeoParquet files</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;.pq&quot;</span><span class="p">,</span> <span class="s2">&quot;.geoparquet&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Handle common vector formats</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.shp&quot;</span><span class="p">,</span> <span class="s2">&quot;.geojson&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;.gml&quot;</span><span class="p">,</span> <span class="s2">&quot;.kml&quot;</span><span class="p">,</span> <span class="s2">&quot;.gpx&quot;</span><span class="p">]:</span>
        <span class="c1"># For formats that might have multiple layers</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;.gml&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Try to use fiona to identify valid layers for formats that might have them</span>
    <span class="c1"># Only attempt this for local files as fiona.listlayers might not work with URLs</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">,</span> <span class="s2">&quot;.gml&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_url</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">listlayers</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If listing layers fails, we&#39;ll fall through to the generic read attempt</span>
            <span class="k">pass</span>

    <span class="c1"># For other formats or when layer listing fails, attempt to read using GeoPandas</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read from source &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.region_groups" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">region_groups</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.region_groups" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Segment regions in an image and filter them based on size.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="xarray.DataArray">DataArray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input image, can be a file
path, xarray DataArray, or numpy array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>connectivity</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Connectivity for labeling. Defaults to 1
for 4-connectivity. Use 2 for 8-connectivity.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum size of regions to keep. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum size of regions to keep.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for filling holes.
Defaults to None, which is equal to min_size.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>properties</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of properties to measure.
See https://scikit-image.org/docs/stable/api/skimage.measure.html#skimage.measure.regionprops
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intensity_image</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="xarray.DataArray">DataArray</span>, <span title="numpy.ndarray">ndarray</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intensity image to measure properties. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_csv</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the properties as a CSV file.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_vector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the vector file.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_image</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output image.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="pandas.DataFrame">DataFrame</span>], <span title="typing.Tuple">Tuple</span>[<span title="xarray.DataArray">DataArray</span>, <span title="pandas.DataFrame">DataFrame</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union[Tuple[np.ndarray, pd.DataFrame], Tuple[xr.DataArray, pd.DataFrame]]: Labeled image and properties DataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5003</span>
<span class="normal">5004</span>
<span class="normal">5005</span>
<span class="normal">5006</span>
<span class="normal">5007</span>
<span class="normal">5008</span>
<span class="normal">5009</span>
<span class="normal">5010</span>
<span class="normal">5011</span>
<span class="normal">5012</span>
<span class="normal">5013</span>
<span class="normal">5014</span>
<span class="normal">5015</span>
<span class="normal">5016</span>
<span class="normal">5017</span>
<span class="normal">5018</span>
<span class="normal">5019</span>
<span class="normal">5020</span>
<span class="normal">5021</span>
<span class="normal">5022</span>
<span class="normal">5023</span>
<span class="normal">5024</span>
<span class="normal">5025</span>
<span class="normal">5026</span>
<span class="normal">5027</span>
<span class="normal">5028</span>
<span class="normal">5029</span>
<span class="normal">5030</span>
<span class="normal">5031</span>
<span class="normal">5032</span>
<span class="normal">5033</span>
<span class="normal">5034</span>
<span class="normal">5035</span>
<span class="normal">5036</span>
<span class="normal">5037</span>
<span class="normal">5038</span>
<span class="normal">5039</span>
<span class="normal">5040</span>
<span class="normal">5041</span>
<span class="normal">5042</span>
<span class="normal">5043</span>
<span class="normal">5044</span>
<span class="normal">5045</span>
<span class="normal">5046</span>
<span class="normal">5047</span>
<span class="normal">5048</span>
<span class="normal">5049</span>
<span class="normal">5050</span>
<span class="normal">5051</span>
<span class="normal">5052</span>
<span class="normal">5053</span>
<span class="normal">5054</span>
<span class="normal">5055</span>
<span class="normal">5056</span>
<span class="normal">5057</span>
<span class="normal">5058</span>
<span class="normal">5059</span>
<span class="normal">5060</span>
<span class="normal">5061</span>
<span class="normal">5062</span>
<span class="normal">5063</span>
<span class="normal">5064</span>
<span class="normal">5065</span>
<span class="normal">5066</span>
<span class="normal">5067</span>
<span class="normal">5068</span>
<span class="normal">5069</span>
<span class="normal">5070</span>
<span class="normal">5071</span>
<span class="normal">5072</span>
<span class="normal">5073</span>
<span class="normal">5074</span>
<span class="normal">5075</span>
<span class="normal">5076</span>
<span class="normal">5077</span>
<span class="normal">5078</span>
<span class="normal">5079</span>
<span class="normal">5080</span>
<span class="normal">5081</span>
<span class="normal">5082</span>
<span class="normal">5083</span>
<span class="normal">5084</span>
<span class="normal">5085</span>
<span class="normal">5086</span>
<span class="normal">5087</span>
<span class="normal">5088</span>
<span class="normal">5089</span>
<span class="normal">5090</span>
<span class="normal">5091</span>
<span class="normal">5092</span>
<span class="normal">5093</span>
<span class="normal">5094</span>
<span class="normal">5095</span>
<span class="normal">5096</span>
<span class="normal">5097</span>
<span class="normal">5098</span>
<span class="normal">5099</span>
<span class="normal">5100</span>
<span class="normal">5101</span>
<span class="normal">5102</span>
<span class="normal">5103</span>
<span class="normal">5104</span>
<span class="normal">5105</span>
<span class="normal">5106</span>
<span class="normal">5107</span>
<span class="normal">5108</span>
<span class="normal">5109</span>
<span class="normal">5110</span>
<span class="normal">5111</span>
<span class="normal">5112</span>
<span class="normal">5113</span>
<span class="normal">5114</span>
<span class="normal">5115</span>
<span class="normal">5116</span>
<span class="normal">5117</span>
<span class="normal">5118</span>
<span class="normal">5119</span>
<span class="normal">5120</span>
<span class="normal">5121</span>
<span class="normal">5122</span>
<span class="normal">5123</span>
<span class="normal">5124</span>
<span class="normal">5125</span>
<span class="normal">5126</span>
<span class="normal">5127</span>
<span class="normal">5128</span>
<span class="normal">5129</span>
<span class="normal">5130</span>
<span class="normal">5131</span>
<span class="normal">5132</span>
<span class="normal">5133</span>
<span class="normal">5134</span>
<span class="normal">5135</span>
<span class="normal">5136</span>
<span class="normal">5137</span>
<span class="normal">5138</span>
<span class="normal">5139</span>
<span class="normal">5140</span>
<span class="normal">5141</span>
<span class="normal">5142</span>
<span class="normal">5143</span>
<span class="normal">5144</span>
<span class="normal">5145</span>
<span class="normal">5146</span>
<span class="normal">5147</span>
<span class="normal">5148</span>
<span class="normal">5149</span>
<span class="normal">5150</span>
<span class="normal">5151</span>
<span class="normal">5152</span>
<span class="normal">5153</span>
<span class="normal">5154</span>
<span class="normal">5155</span>
<span class="normal">5156</span>
<span class="normal">5157</span>
<span class="normal">5158</span>
<span class="normal">5159</span>
<span class="normal">5160</span>
<span class="normal">5161</span>
<span class="normal">5162</span>
<span class="normal">5163</span>
<span class="normal">5164</span>
<span class="normal">5165</span>
<span class="normal">5166</span>
<span class="normal">5167</span>
<span class="normal">5168</span>
<span class="normal">5169</span>
<span class="normal">5170</span>
<span class="normal">5171</span>
<span class="normal">5172</span>
<span class="normal">5173</span>
<span class="normal">5174</span>
<span class="normal">5175</span>
<span class="normal">5176</span>
<span class="normal">5177</span>
<span class="normal">5178</span>
<span class="normal">5179</span>
<span class="normal">5180</span>
<span class="normal">5181</span>
<span class="normal">5182</span>
<span class="normal">5183</span>
<span class="normal">5184</span>
<span class="normal">5185</span>
<span class="normal">5186</span>
<span class="normal">5187</span>
<span class="normal">5188</span>
<span class="normal">5189</span>
<span class="normal">5190</span>
<span class="normal">5191</span>
<span class="normal">5192</span>
<span class="normal">5193</span>
<span class="normal">5194</span>
<span class="normal">5195</span>
<span class="normal">5196</span>
<span class="normal">5197</span>
<span class="normal">5198</span>
<span class="normal">5199</span>
<span class="normal">5200</span>
<span class="normal">5201</span>
<span class="normal">5202</span>
<span class="normal">5203</span>
<span class="normal">5204</span>
<span class="normal">5205</span>
<span class="normal">5206</span>
<span class="normal">5207</span>
<span class="normal">5208</span>
<span class="normal">5209</span>
<span class="normal">5210</span>
<span class="normal">5211</span>
<span class="normal">5212</span>
<span class="normal">5213</span>
<span class="normal">5214</span>
<span class="normal">5215</span>
<span class="normal">5216</span>
<span class="normal">5217</span>
<span class="normal">5218</span>
<span class="normal">5219</span>
<span class="normal">5220</span>
<span class="normal">5221</span>
<span class="normal">5222</span>
<span class="normal">5223</span>
<span class="normal">5224</span>
<span class="normal">5225</span>
<span class="normal">5226</span>
<span class="normal">5227</span>
<span class="normal">5228</span>
<span class="normal">5229</span>
<span class="normal">5230</span>
<span class="normal">5231</span>
<span class="normal">5232</span>
<span class="normal">5233</span>
<span class="normal">5234</span>
<span class="normal">5235</span>
<span class="normal">5236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">region_groups</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">connectivity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">intensity_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_csv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Segment regions in an image and filter them based on size.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Union[str, xr.DataArray, np.ndarray]): Input image, can be a file</span>
<span class="sd">            path, xarray DataArray, or numpy array.</span>
<span class="sd">        connectivity (int, optional): Connectivity for labeling. Defaults to 1</span>
<span class="sd">            for 4-connectivity. Use 2 for 8-connectivity.</span>
<span class="sd">        min_size (int, optional): Minimum size of regions to keep. Defaults to 10.</span>
<span class="sd">        max_size (Optional[int], optional): Maximum size of regions to keep.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        threshold (Optional[int], optional): Threshold for filling holes.</span>
<span class="sd">            Defaults to None, which is equal to min_size.</span>
<span class="sd">        properties (Optional[List[str]], optional): List of properties to measure.</span>
<span class="sd">            See https://scikit-image.org/docs/stable/api/skimage.measure.html#skimage.measure.regionprops</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        intensity_image (Optional[Union[str, xr.DataArray, np.ndarray]], optional):</span>
<span class="sd">            Intensity image to measure properties. Defaults to None.</span>
<span class="sd">        out_csv (Optional[str], optional): Path to save the properties as a CSV file.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        out_vector (Optional[str], optional): Path to save the vector file.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        out_image (Optional[str], optional): Path to save the output image.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[Tuple[np.ndarray, pd.DataFrame], Tuple[xr.DataArray, pd.DataFrame]]: Labeled image and properties DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ndi</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">measure</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The input image must be a file path, xarray DataArray, or numpy array.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">min_size</span>

    <span class="c1"># Define a custom function to calculate median intensity</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity_median</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">intensity_image</span><span class="p">):</span>
        <span class="c1"># Extract the intensity values for the region</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>

    <span class="c1"># Add your custom function to the list of extra properties</span>
    <span class="k">if</span> <span class="n">intensity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_props</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity_median</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extra_props</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_bbox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_convex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_filled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;axis_major_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;axis_minor_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diameter_areagth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">intensity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">properties</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;intensity_max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_min&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity_std&quot;</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">if</span> <span class="n">intensity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">)</span>
            <span class="n">intensity_da</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">intensity_image</span> <span class="o">=</span> <span class="n">intensity_da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="n">intensity_image</span> <span class="o">=</span> <span class="n">intensity_image</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intensity_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The intensity_image must be a file path, xarray DataArray, or numpy array.&quot;</span>
            <span class="p">)</span>

    <span class="n">label_image</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span>
        <span class="n">label_image</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">intensity_image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>

    <span class="c1"># Get the labels of regions with area smaller than the threshold</span>
    <span class="n">small_regions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># Set the corresponding labels in the label_image to zero</span>
    <span class="k">for</span> <span class="n">region_label</span> <span class="ow">in</span> <span class="n">small_regions</span><span class="p">:</span>
        <span class="n">label_image</span><span class="p">[</span><span class="n">label_image</span> <span class="o">==</span> <span class="n">region_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">large_regions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">region_label</span> <span class="ow">in</span> <span class="n">large_regions</span><span class="p">:</span>
            <span class="n">label_image</span><span class="p">[</span><span class="n">label_image</span> <span class="o">==</span> <span class="n">region_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Find the background (holes) which are zeros</span>
    <span class="n">holes</span> <span class="o">=</span> <span class="n">label_image</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Label the holes (connected components in the background)</span>
    <span class="n">labeled_holes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">holes</span><span class="p">)</span>

    <span class="c1"># Measure properties of the labeled holes, including area and bounding box</span>
    <span class="n">hole_props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">labeled_holes</span><span class="p">)</span>

    <span class="c1"># Loop through each hole and fill it if it is smaller than the threshold</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">hole_props</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="c1"># Get the coordinates of the small hole</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">coords</span>

            <span class="c1"># Find the surrounding region&#39;s ID (non-zero value near the hole)</span>
            <span class="n">surrounding_region_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coord</span>
                <span class="c1"># Get a 3x3 neighborhood around the hole pixel</span>
                <span class="n">neighbors</span> <span class="o">=</span> <span class="n">label_image</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="c1"># Exclude the hole pixels (zeros) and get region values</span>
                <span class="n">region_values</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">neighbors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">region_values</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">surrounding_region_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">region_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># Take the first non-zero value</span>

            <span class="k">if</span> <span class="n">surrounding_region_values</span><span class="p">:</span>
                <span class="c1"># Fill the hole with the mode (most frequent) of the surrounding region values</span>
                <span class="n">fill_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">surrounding_region_values</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">surrounding_region_values</span><span class="o">.</span><span class="n">count</span>
                <span class="p">)</span>
                <span class="n">label_image</span><span class="p">[</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fill_value</span>

    <span class="n">label_image</span><span class="p">,</span> <span class="n">num_labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span>
        <span class="n">label_image</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">,</span> <span class="n">return_num</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span>
        <span class="n">label_image</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">intensity_image</span><span class="o">=</span><span class="n">intensity_image</span><span class="p">,</span>
        <span class="n">extra_properties</span><span class="o">=</span><span class="n">extra_props</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;elongation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;axis_major_length&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;axis_minor_length&quot;</span><span class="p">]</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span>
    <span class="k">if</span> <span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">num_labels</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;uint16&quot;</span>
    <span class="k">elif</span> <span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;uint32&quot;</span>

    <span class="k">if</span> <span class="n">out_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">label_image</span><span class="p">,</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">da</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">label_image</span>
        <span class="k">if</span> <span class="n">out_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">out_image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp_raster</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_vector</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp_raster</span> <span class="o">=</span> <span class="n">temp_file_path</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                    <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">tmp_raster</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">tmp_vector</span> <span class="o">=</span> <span class="n">temp_file_path</span><span class="p">(</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">)</span>
                    <span class="n">raster_to_vector</span><span class="p">(</span>
                        <span class="n">tmp_raster</span><span class="p">,</span>
                        <span class="n">tmp_vector</span><span class="p">,</span>
                        <span class="n">attribute_name</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                        <span class="n">unique_attribute_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_vector</span> <span class="o">=</span> <span class="n">temp_file_path</span><span class="p">(</span><span class="s2">&quot;.gpkg&quot;</span><span class="p">)</span>
                    <span class="n">raster_to_vector</span><span class="p">(</span>
                        <span class="n">out_image</span><span class="p">,</span>
                        <span class="n">tmp_vector</span><span class="p">,</span>
                        <span class="n">attribute_name</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                        <span class="n">unique_attribute_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">tmp_vector</span><span class="p">)</span>
                <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">gdf2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="n">gdf2</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">out_vector</span><span class="p">)</span>
                <span class="n">gdf2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">gdf2</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tmp_raster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_raster</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_raster</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tmp_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_vector</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_vector</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to delete temporary files: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">da</span><span class="p">,</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.regularization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regularization</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">angle_tolerance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#geoai.utils.regularization" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Regularizes building footprint polygons with multiple techniques beyond minimum
rotated rectangles.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>building_polygons</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons containing building footprints</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Degrees within which angles will be regularized to 90/180 degrees</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distance tolerance for Douglas-Peucker simplification</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orthogonalize</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enforce orthogonal angles in the final polygons</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_topology</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to preserve topology during simplification</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="typing.List">List</span>[<span title="shapely.geometry.Polygon">Polygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame or list of shapely Polygons with regularized building footprints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">regularization</span><span class="p">(</span>
    <span class="n">building_polygons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
    <span class="n">angle_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">orthogonalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">preserve_topology</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regularizes building footprint polygons with multiple techniques beyond minimum</span>
<span class="sd">    rotated rectangles.</span>

<span class="sd">    Args:</span>
<span class="sd">        building_polygons: GeoDataFrame or list of shapely Polygons containing building footprints</span>
<span class="sd">        angle_tolerance: Degrees within which angles will be regularized to 90/180 degrees</span>
<span class="sd">        simplify_tolerance: Distance tolerance for Douglas-Peucker simplification</span>
<span class="sd">        orthogonalize: Whether to enforce orthogonal angles in the final polygons</span>
<span class="sd">        preserve_topology: Whether to preserve topology during simplification</span>

<span class="sd">    Returns:</span>
<span class="sd">        GeoDataFrame or list of shapely Polygons with regularized building footprints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely</span><span class="w"> </span><span class="kn">import</span> <span class="n">wkt</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">translate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">shape</span>

    <span class="n">regularized_buildings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check if we&#39;re dealing with a GeoDataFrame</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom_objects</span> <span class="o">=</span> <span class="n">building_polygons</span>

    <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">geom_objects</span><span class="p">:</span>
        <span class="c1"># Handle potential string representations of geometries</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to parse as WKT</span>
                <span class="n">building</span> <span class="o">=</span> <span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse geometry string: </span><span class="si">{</span><span class="n">building</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Ensure we have a valid geometry</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">building</span><span class="p">,</span> <span class="s2">&quot;simplify&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid geometry type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">building</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Step 1: Simplify to remove noise and small vertices</span>
        <span class="n">simplified</span> <span class="o">=</span> <span class="n">building</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span>
            <span class="n">simplify_tolerance</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="n">preserve_topology</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">orthogonalize</span><span class="p">:</span>
            <span class="c1"># Make sure we have a valid polygon with an exterior</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">simplified</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">simplified</span><span class="o">.</span><span class="n">exterior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simplified geometry has no exterior: </span><span class="si">{</span><span class="n">simplified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">regularized_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>  <span class="c1"># Use original instead</span>
                <span class="k">continue</span>

            <span class="c1"># Step 2: Get the dominant angle to rotate building</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simplified</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

            <span class="c1"># Make sure we have enough coordinates for angle calculation</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough coordinates for angle calculation: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">regularized_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>  <span class="c1"># Use original instead</span>
                <span class="k">continue</span>

            <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="c1"># Find most common angle classes (0, 90, 180, 270 degrees)</span>
            <span class="n">binned_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">angles</span> <span class="o">/</span> <span class="mi">90</span><span class="p">)</span> <span class="o">*</span> <span class="mi">90</span>
            <span class="n">dominant_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">binned_angles</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span> <span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

            <span class="c1"># Step 3: Rotate to align with axes, regularize, then rotate back</span>
            <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">simplified</span><span class="p">,</span> <span class="o">-</span><span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>

            <span class="c1"># Step 4: Rectify coordinates to enforce right angles</span>
            <span class="n">ext_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rotated</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">rect_coords</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Regularize each vertex to create orthogonal corners</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">rect_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># Check if we need to add a right-angle vertex</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                        <span class="n">ext_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">ext_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="mi">180</span>
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">%</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">angle_tolerance</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">%</span> <span class="mi">90</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span>
                    <span class="mi">90</span> <span class="o">-</span> <span class="n">angle_tolerance</span>
                <span class="p">):</span>
                    <span class="c1"># Add intermediate point to create right angle</span>
                    <span class="n">rect_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">ext_coords</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">ext_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

            <span class="c1"># Close the polygon by adding the first point again</span>
            <span class="n">rect_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Create regularized polygon and rotate back</span>
            <span class="n">regularized</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">rect_coords</span><span class="p">)</span>
            <span class="n">final_building</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">regularized</span><span class="p">,</span> <span class="n">dominant_angle</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_building</span> <span class="o">=</span> <span class="n">simplified</span>

        <span class="n">regularized_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_building</span><span class="p">)</span>

    <span class="c1"># If input was a GeoDataFrame, return a GeoDataFrame</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">building_polygons</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">regularized_buildings</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">building_polygons</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">regularized_buildings</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.regularize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regularize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">parallel_threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">target_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">allow_45_degree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">diagonal_threshold_reduction</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">allow_circles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">circle_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">include_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.regularize" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Regularizes polygon geometries in a GeoDataFrame by aligning edges.</p>
<p>Aligns edges to be parallel or perpendicular (optionally also 45 degrees)
to their main direction. Handles reprojection, initial simplification,
regularization, geometry cleanup, and parallel processing.</p>
<p>This function is a wrapper around the <code>regularize_geodataframe</code> function
from the <code>buildingregulariser</code> package. Credits to the original author
Nick Wright. Check out the repo at https://github.com/DPIRD-DMA/Building-Regulariser.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="geopandas.GeoDataFrame">GeoDataFrame</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input GeoDataFrame with polygon or multipolygon geometries,
or a file path to the GeoDataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parallel_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distance threshold for merging nearly parallel adjacent edges
during regularization. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_crs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pyproj.CRS">CRS</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target Coordinate Reference System for
processing. If None, uses the input GeoDataFrame's CRS. Processing is more reliable in a
projected CRS. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, applies initial simplification to the geometry before
regularization. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for the initial simplification step (if <code>simplify</code>
is True). Also used for geometry cleanup steps. Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_45_degree</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, allows edges to be oriented at 45-degree angles relative
to the main direction during regularization. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>diagonal_threshold_reduction</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reduction factor in degrees to reduce the likelihood
of diagonal edges being created. Larger values reduce the likelihood of diagonal edges.
Defaults to 15.</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_circles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, attempts to detect polygons that are nearly circular and
replaces them with perfect circles. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>circle_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intersection over Union (IoU) threshold used for circle detection
(if <code>allow_circles</code> is True). Value between 0 and 1. Defaults to 0.9.</p>
              </div>
            </td>
            <td>
                  <code>0.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_cores</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of CPU cores to use for parallel processing. If 1, processing is
done sequentially. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_metadata</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, includes metadata about the regularization process in the
output GeoDataFrame. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output GeoDataFrame. If None, the output is
not saved. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the <code>to_file</code> method when saving the output.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>gpd.GeoDataFrame: A new GeoDataFrame with regularized polygon geometries. Original attributes are</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>preserved. Geometries that failed processing might be dropped.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input data is not a GeoDataFrame or a file path, or if the input GeoDataFrame is empty.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7073</span>
<span class="normal">7074</span>
<span class="normal">7075</span>
<span class="normal">7076</span>
<span class="normal">7077</span>
<span class="normal">7078</span>
<span class="normal">7079</span>
<span class="normal">7080</span>
<span class="normal">7081</span>
<span class="normal">7082</span>
<span class="normal">7083</span>
<span class="normal">7084</span>
<span class="normal">7085</span>
<span class="normal">7086</span>
<span class="normal">7087</span>
<span class="normal">7088</span>
<span class="normal">7089</span>
<span class="normal">7090</span>
<span class="normal">7091</span>
<span class="normal">7092</span>
<span class="normal">7093</span>
<span class="normal">7094</span>
<span class="normal">7095</span>
<span class="normal">7096</span>
<span class="normal">7097</span>
<span class="normal">7098</span>
<span class="normal">7099</span>
<span class="normal">7100</span>
<span class="normal">7101</span>
<span class="normal">7102</span>
<span class="normal">7103</span>
<span class="normal">7104</span>
<span class="normal">7105</span>
<span class="normal">7106</span>
<span class="normal">7107</span>
<span class="normal">7108</span>
<span class="normal">7109</span>
<span class="normal">7110</span>
<span class="normal">7111</span>
<span class="normal">7112</span>
<span class="normal">7113</span>
<span class="normal">7114</span>
<span class="normal">7115</span>
<span class="normal">7116</span>
<span class="normal">7117</span>
<span class="normal">7118</span>
<span class="normal">7119</span>
<span class="normal">7120</span>
<span class="normal">7121</span>
<span class="normal">7122</span>
<span class="normal">7123</span>
<span class="normal">7124</span>
<span class="normal">7125</span>
<span class="normal">7126</span>
<span class="normal">7127</span>
<span class="normal">7128</span>
<span class="normal">7129</span>
<span class="normal">7130</span>
<span class="normal">7131</span>
<span class="normal">7132</span>
<span class="normal">7133</span>
<span class="normal">7134</span>
<span class="normal">7135</span>
<span class="normal">7136</span>
<span class="normal">7137</span>
<span class="normal">7138</span>
<span class="normal">7139</span>
<span class="normal">7140</span>
<span class="normal">7141</span>
<span class="normal">7142</span>
<span class="normal">7143</span>
<span class="normal">7144</span>
<span class="normal">7145</span>
<span class="normal">7146</span>
<span class="normal">7147</span>
<span class="normal">7148</span>
<span class="normal">7149</span>
<span class="normal">7150</span>
<span class="normal">7151</span>
<span class="normal">7152</span>
<span class="normal">7153</span>
<span class="normal">7154</span>
<span class="normal">7155</span>
<span class="normal">7156</span>
<span class="normal">7157</span>
<span class="normal">7158</span>
<span class="normal">7159</span>
<span class="normal">7160</span>
<span class="normal">7161</span>
<span class="normal">7162</span>
<span class="normal">7163</span>
<span class="normal">7164</span>
<span class="normal">7165</span>
<span class="normal">7166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">regularize</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">parallel_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">target_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;pyproj.CRS&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">allow_45_degree</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">diagonal_threshold_reduction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">allow_circles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">circle_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">include_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularizes polygon geometries in a GeoDataFrame by aligning edges.</span>

<span class="sd">    Aligns edges to be parallel or perpendicular (optionally also 45 degrees)</span>
<span class="sd">    to their main direction. Handles reprojection, initial simplification,</span>
<span class="sd">    regularization, geometry cleanup, and parallel processing.</span>

<span class="sd">    This function is a wrapper around the `regularize_geodataframe` function</span>
<span class="sd">    from the `buildingregulariser` package. Credits to the original author</span>
<span class="sd">    Nick Wright. Check out the repo at https://github.com/DPIRD-DMA/Building-Regulariser.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (Union[gpd.GeoDataFrame, str]): Input GeoDataFrame with polygon or multipolygon geometries,</span>
<span class="sd">            or a file path to the GeoDataFrame.</span>
<span class="sd">        parallel_threshold (float, optional): Distance threshold for merging nearly parallel adjacent edges</span>
<span class="sd">            during regularization. Defaults to 1.0.</span>
<span class="sd">        target_crs (Optional[Union[str, &quot;pyproj.CRS&quot;]], optional): Target Coordinate Reference System for</span>
<span class="sd">            processing. If None, uses the input GeoDataFrame&#39;s CRS. Processing is more reliable in a</span>
<span class="sd">            projected CRS. Defaults to None.</span>
<span class="sd">        simplify (bool, optional): If True, applies initial simplification to the geometry before</span>
<span class="sd">            regularization. Defaults to True.</span>
<span class="sd">        simplify_tolerance (float, optional): Tolerance for the initial simplification step (if `simplify`</span>
<span class="sd">            is True). Also used for geometry cleanup steps. Defaults to 0.5.</span>
<span class="sd">        allow_45_degree (bool, optional): If True, allows edges to be oriented at 45-degree angles relative</span>
<span class="sd">            to the main direction during regularization. Defaults to True.</span>
<span class="sd">        diagonal_threshold_reduction (float, optional): Reduction factor in degrees to reduce the likelihood</span>
<span class="sd">            of diagonal edges being created. Larger values reduce the likelihood of diagonal edges.</span>
<span class="sd">            Defaults to 15.</span>
<span class="sd">        allow_circles (bool, optional): If True, attempts to detect polygons that are nearly circular and</span>
<span class="sd">            replaces them with perfect circles. Defaults to True.</span>
<span class="sd">        circle_threshold (float, optional): Intersection over Union (IoU) threshold used for circle detection</span>
<span class="sd">            (if `allow_circles` is True). Value between 0 and 1. Defaults to 0.9.</span>
<span class="sd">        num_cores (int, optional): Number of CPU cores to use for parallel processing. If 1, processing is</span>
<span class="sd">            done sequentially. Defaults to 1.</span>
<span class="sd">        include_metadata (bool, optional): If True, includes metadata about the regularization process in the</span>
<span class="sd">            output GeoDataFrame. Defaults to False.</span>
<span class="sd">        output_path (Optional[str], optional): Path to save the output GeoDataFrame. If None, the output is</span>
<span class="sd">            not saved. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the `to_file` method when saving the output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        gpd.GeoDataFrame: A new GeoDataFrame with regularized polygon geometries. Original attributes are</span>
<span class="sd">        preserved. Geometries that failed processing might be dropped.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input data is not a GeoDataFrame or a file path, or if the input GeoDataFrame is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">buildingregulariser</span><span class="w"> </span><span class="kn">import</span> <span class="n">regularize_geodataframe</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">install_package</span><span class="p">(</span><span class="s2">&quot;buildingregulariser&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">buildingregulariser</span><span class="w"> </span><span class="kn">import</span> <span class="n">regularize_geodataframe</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data must be a GeoDataFrame or a file path.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the input data is empty</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input GeoDataFrame is empty.&quot;</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">regularize_geodataframe</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">parallel_threshold</span><span class="o">=</span><span class="n">parallel_threshold</span><span class="p">,</span>
        <span class="n">target_crs</span><span class="o">=</span><span class="n">target_crs</span><span class="p">,</span>
        <span class="n">simplify</span><span class="o">=</span><span class="n">simplify</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span>
        <span class="n">allow_45_degree</span><span class="o">=</span><span class="n">allow_45_degree</span><span class="p">,</span>
        <span class="n">diagonal_threshold_reduction</span><span class="o">=</span><span class="n">diagonal_threshold_reduction</span><span class="p">,</span>
        <span class="n">allow_circles</span><span class="o">=</span><span class="n">allow_circles</span><span class="p">,</span>
        <span class="n">circle_threshold</span><span class="o">=</span><span class="n">circle_threshold</span><span class="p">,</span>
        <span class="n">num_cores</span><span class="o">=</span><span class="n">num_cores</span><span class="p">,</span>
        <span class="n">include_metadata</span><span class="o">=</span><span class="n">include_metadata</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.rowcol_to_xy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rowcol_to_xy</span><span class="p">(</span><span class="n">src_fp</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dst_crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.rowcol_to_xy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a list of (row, col) coordinates to (x, y) coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>src_fp</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source raster file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rows</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of row coordinates. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cols</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of col coordinates. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boxes</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of (row, col) coordinates in the format of [[left, top, right, bottom], [left, top, right, bottom], ...]</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zs (list or float, optional): Height associated with coordinates. Primarily used for RPC based coordinate transformations.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offset</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Determines if the returned coordinates are for the center of the pixel or for a corner.</p>
              </div>
            </td>
            <td>
                  <code>&#39;center&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output vector file path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dst_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The destination CRS. Defaults to "EPSG:4326".</p>
              </div>
            </td>
            <td>
                  <code>&#39;EPSG:4326&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to rasterio.transform.xy.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="float">float</span>], <span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of (x, y) coordinates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7338</span>
<span class="normal">7339</span>
<span class="normal">7340</span>
<span class="normal">7341</span>
<span class="normal">7342</span>
<span class="normal">7343</span>
<span class="normal">7344</span>
<span class="normal">7345</span>
<span class="normal">7346</span>
<span class="normal">7347</span>
<span class="normal">7348</span>
<span class="normal">7349</span>
<span class="normal">7350</span>
<span class="normal">7351</span>
<span class="normal">7352</span>
<span class="normal">7353</span>
<span class="normal">7354</span>
<span class="normal">7355</span>
<span class="normal">7356</span>
<span class="normal">7357</span>
<span class="normal">7358</span>
<span class="normal">7359</span>
<span class="normal">7360</span>
<span class="normal">7361</span>
<span class="normal">7362</span>
<span class="normal">7363</span>
<span class="normal">7364</span>
<span class="normal">7365</span>
<span class="normal">7366</span>
<span class="normal">7367</span>
<span class="normal">7368</span>
<span class="normal">7369</span>
<span class="normal">7370</span>
<span class="normal">7371</span>
<span class="normal">7372</span>
<span class="normal">7373</span>
<span class="normal">7374</span>
<span class="normal">7375</span>
<span class="normal">7376</span>
<span class="normal">7377</span>
<span class="normal">7378</span>
<span class="normal">7379</span>
<span class="normal">7380</span>
<span class="normal">7381</span>
<span class="normal">7382</span>
<span class="normal">7383</span>
<span class="normal">7384</span>
<span class="normal">7385</span>
<span class="normal">7386</span>
<span class="normal">7387</span>
<span class="normal">7388</span>
<span class="normal">7389</span>
<span class="normal">7390</span>
<span class="normal">7391</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rowcol_to_xy</span><span class="p">(</span>
    <span class="n">src_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">boxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dst_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a list of (row, col) coordinates to (x, y) coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_fp (str): The source raster file path.</span>
<span class="sd">        rows (list, optional): A list of row coordinates. Defaults to None.</span>
<span class="sd">        cols (list, optional): A list of col coordinates. Defaults to None.</span>
<span class="sd">        boxes (list, optional): A list of (row, col) coordinates in the format of [[left, top, right, bottom], [left, top, right, bottom], ...]</span>
<span class="sd">        zs: zs (list or float, optional): Height associated with coordinates. Primarily used for RPC based coordinate transformations.</span>
<span class="sd">        offset (str, optional): Determines if the returned coordinates are for the center of the pixel or for a corner.</span>
<span class="sd">        output (str, optional): The output vector file path. Defaults to None.</span>
<span class="sd">        dst_crs (str, optional): The destination CRS. Defaults to &quot;EPSG:4326&quot;.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to rasterio.transform.xy.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of (x, y) coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rows and cols must be provided.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">src_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

    <span class="k">if</span> <span class="n">boxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">boxes_to_vector</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.smooth_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">smooth_vector</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">segment_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth_iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">merge_collection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">merge_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merge_multipolygons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_area</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">area_tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.smooth_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Smooth a vector data using the smoothify library.
    See https://github.com/DPIRD-DMA/Smoothify for more details.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_data</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="geopandas.GeoDataFrame">GeoDataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector data to smooth.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to save the smoothed vector data. If None, returns the smoothed vector data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segment_length</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution of the original raster data in map units. If None (default), automatically
detects by finding the minimum segment length (from a data sample). Recommended to specify explicitly when known.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smooth_iterations</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of iterations to smooth the vector data.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_cores</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of cores to use for parallel processing. If 0 (default), uses all available cores.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_collection</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to merge/dissolve adjacent geometries in collections before smoothing.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name to use for dissolving geometries. Only valid when merge_collection=True.
If None, dissolves all geometries together. If specified, dissolves geometries grouped by the column values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_multipolygons</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to merge adjacent polygons within MultiPolygons before smoothing</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_area</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to restore original area after smoothing via buffering (applies to Polygons only)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentage of original area allowed as error (e.g., 0.01 = 0.01% error = 99.99% preservation).
Only affects Polygons when preserve_area=True</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>gpd.GeoDataFrame: The smoothed vector data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">geoai</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">geoai</span><span class="o">.</span><span class="n">read_vector</span><span class="p">(</span><span class="s2">&quot;path/to/vector.geojson&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">smoothed_gdf</span> <span class="o">=</span> <span class="n">geoai</span><span class="o">.</span><span class="n">smooth_vector</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">smooth_iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;path/to/smoothed_vector.geojson&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">smoothed_gdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">smoothed_gdf</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7853</span>
<span class="normal">7854</span>
<span class="normal">7855</span>
<span class="normal">7856</span>
<span class="normal">7857</span>
<span class="normal">7858</span>
<span class="normal">7859</span>
<span class="normal">7860</span>
<span class="normal">7861</span>
<span class="normal">7862</span>
<span class="normal">7863</span>
<span class="normal">7864</span>
<span class="normal">7865</span>
<span class="normal">7866</span>
<span class="normal">7867</span>
<span class="normal">7868</span>
<span class="normal">7869</span>
<span class="normal">7870</span>
<span class="normal">7871</span>
<span class="normal">7872</span>
<span class="normal">7873</span>
<span class="normal">7874</span>
<span class="normal">7875</span>
<span class="normal">7876</span>
<span class="normal">7877</span>
<span class="normal">7878</span>
<span class="normal">7879</span>
<span class="normal">7880</span>
<span class="normal">7881</span>
<span class="normal">7882</span>
<span class="normal">7883</span>
<span class="normal">7884</span>
<span class="normal">7885</span>
<span class="normal">7886</span>
<span class="normal">7887</span>
<span class="normal">7888</span>
<span class="normal">7889</span>
<span class="normal">7890</span>
<span class="normal">7891</span>
<span class="normal">7892</span>
<span class="normal">7893</span>
<span class="normal">7894</span>
<span class="normal">7895</span>
<span class="normal">7896</span>
<span class="normal">7897</span>
<span class="normal">7898</span>
<span class="normal">7899</span>
<span class="normal">7900</span>
<span class="normal">7901</span>
<span class="normal">7902</span>
<span class="normal">7903</span>
<span class="normal">7904</span>
<span class="normal">7905</span>
<span class="normal">7906</span>
<span class="normal">7907</span>
<span class="normal">7908</span>
<span class="normal">7909</span>
<span class="normal">7910</span>
<span class="normal">7911</span>
<span class="normal">7912</span>
<span class="normal">7913</span>
<span class="normal">7914</span>
<span class="normal">7915</span>
<span class="normal">7916</span>
<span class="normal">7917</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">smooth_vector</span><span class="p">(</span>
    <span class="n">vector_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">segment_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smooth_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">merge_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">merge_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">merge_multipolygons</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">preserve_area</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">area_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Smooth a vector data using the smoothify library.</span>
<span class="sd">        See https://github.com/DPIRD-DMA/Smoothify for more details.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_data: The vector data to smooth.</span>
<span class="sd">        output_path: The path to save the smoothed vector data. If None, returns the smoothed vector data.</span>
<span class="sd">        segment_length: Resolution of the original raster data in map units. If None (default), automatically</span>
<span class="sd">            detects by finding the minimum segment length (from a data sample). Recommended to specify explicitly when known.</span>
<span class="sd">        smooth_iterations: The number of iterations to smooth the vector data.</span>
<span class="sd">        num_cores: Number of cores to use for parallel processing. If 0 (default), uses all available cores.</span>
<span class="sd">        merge_collection: Whether to merge/dissolve adjacent geometries in collections before smoothing.</span>
<span class="sd">        merge_field: Column name to use for dissolving geometries. Only valid when merge_collection=True.</span>
<span class="sd">            If None, dissolves all geometries together. If specified, dissolves geometries grouped by the column values.</span>
<span class="sd">        merge_multipolygons: Whether to merge adjacent polygons within MultiPolygons before smoothing</span>
<span class="sd">        preserve_area: Whether to restore original area after smoothing via buffering (applies to Polygons only)</span>
<span class="sd">        area_tolerance: Percentage of original area allowed as error (e.g., 0.01 = 0.01% error = 99.99% preservation).</span>
<span class="sd">            Only affects Polygons when preserve_area=True</span>

<span class="sd">    Returns:</span>
<span class="sd">        gpd.GeoDataFrame: The smoothed vector data.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import geoai</span>
<span class="sd">        &gt;&gt;&gt; gdf = geoai.read_vector(&quot;path/to/vector.geojson&quot;)</span>
<span class="sd">        &gt;&gt;&gt; smoothed_gdf = geoai.smooth_vector(gdf, smooth_iterations=3, output_path=&quot;path/to/smoothed_vector.geojson&quot;)</span>
<span class="sd">        &gt;&gt;&gt; smoothed_gdf.head()</span>
<span class="sd">        &gt;&gt;&gt; smoothed_gdf.explore()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">smoothify</span><span class="w"> </span><span class="kn">import</span> <span class="n">smoothify</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">install_package</span><span class="p">(</span><span class="s2">&quot;smoothify&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">smoothify</span><span class="w"> </span><span class="kn">import</span> <span class="n">smoothify</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">vector_data</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">read_vector</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>

    <span class="n">smoothed_vector_data</span> <span class="o">=</span> <span class="n">smoothify</span><span class="p">(</span>
        <span class="n">geom</span><span class="o">=</span><span class="n">vector_data</span><span class="p">,</span>
        <span class="n">segment_length</span><span class="o">=</span><span class="n">segment_length</span><span class="p">,</span>
        <span class="n">smooth_iterations</span><span class="o">=</span><span class="n">smooth_iterations</span><span class="p">,</span>
        <span class="n">num_cores</span><span class="o">=</span><span class="n">num_cores</span><span class="p">,</span>
        <span class="n">merge_collection</span><span class="o">=</span><span class="n">merge_collection</span><span class="p">,</span>
        <span class="n">merge_field</span><span class="o">=</span><span class="n">merge_field</span><span class="p">,</span>
        <span class="n">merge_multipolygons</span><span class="o">=</span><span class="n">merge_multipolygons</span><span class="p">,</span>
        <span class="n">preserve_area</span><span class="o">=</span><span class="n">preserve_area</span><span class="p">,</span>
        <span class="n">area_tolerance</span><span class="o">=</span><span class="n">area_tolerance</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">smoothed_vector_data</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smoothed_vector_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.stack_bands" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stack_bands</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp_vrt</span><span class="o">=</span><span class="s1">&#39;stack.vrt&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s1">&#39;DEFLATE&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;COG&#39;</span><span class="p">,</span> <span class="n">extra_gdal_translate_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.stack_bands" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Stack bands from multiple images into a single multi-band GeoTIFF.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_files</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of input image paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output stacked image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output resolution. If None, inferred from first image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data type (e.g., "UInt16", "Float32").</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temp_vrt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Temporary VRT filename.</p>
              </div>
            </td>
            <td>
                  <code>&#39;stack.vrt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overwrite</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to overwrite the output file.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compress</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression method.</p>
              </div>
            </td>
            <td>
                  <code>&#39;DEFLATE&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GDAL output format (default is "COG").</p>
              </div>
            </td>
            <td>
                  <code>&#39;COG&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extra_gdal_translate_args</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extra arguments for gdal_translate.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7766</span>
<span class="normal">7767</span>
<span class="normal">7768</span>
<span class="normal">7769</span>
<span class="normal">7770</span>
<span class="normal">7771</span>
<span class="normal">7772</span>
<span class="normal">7773</span>
<span class="normal">7774</span>
<span class="normal">7775</span>
<span class="normal">7776</span>
<span class="normal">7777</span>
<span class="normal">7778</span>
<span class="normal">7779</span>
<span class="normal">7780</span>
<span class="normal">7781</span>
<span class="normal">7782</span>
<span class="normal">7783</span>
<span class="normal">7784</span>
<span class="normal">7785</span>
<span class="normal">7786</span>
<span class="normal">7787</span>
<span class="normal">7788</span>
<span class="normal">7789</span>
<span class="normal">7790</span>
<span class="normal">7791</span>
<span class="normal">7792</span>
<span class="normal">7793</span>
<span class="normal">7794</span>
<span class="normal">7795</span>
<span class="normal">7796</span>
<span class="normal">7797</span>
<span class="normal">7798</span>
<span class="normal">7799</span>
<span class="normal">7800</span>
<span class="normal">7801</span>
<span class="normal">7802</span>
<span class="normal">7803</span>
<span class="normal">7804</span>
<span class="normal">7805</span>
<span class="normal">7806</span>
<span class="normal">7807</span>
<span class="normal">7808</span>
<span class="normal">7809</span>
<span class="normal">7810</span>
<span class="normal">7811</span>
<span class="normal">7812</span>
<span class="normal">7813</span>
<span class="normal">7814</span>
<span class="normal">7815</span>
<span class="normal">7816</span>
<span class="normal">7817</span>
<span class="normal">7818</span>
<span class="normal">7819</span>
<span class="normal">7820</span>
<span class="normal">7821</span>
<span class="normal">7822</span>
<span class="normal">7823</span>
<span class="normal">7824</span>
<span class="normal">7825</span>
<span class="normal">7826</span>
<span class="normal">7827</span>
<span class="normal">7828</span>
<span class="normal">7829</span>
<span class="normal">7830</span>
<span class="normal">7831</span>
<span class="normal">7832</span>
<span class="normal">7833</span>
<span class="normal">7834</span>
<span class="normal">7835</span>
<span class="normal">7836</span>
<span class="normal">7837</span>
<span class="normal">7838</span>
<span class="normal">7839</span>
<span class="normal">7840</span>
<span class="normal">7841</span>
<span class="normal">7842</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stack_bands</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># e.g., &quot;UInt16&quot;, &quot;Float32&quot;</span>
    <span class="n">temp_vrt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;stack.vrt&quot;</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;COG&quot;</span><span class="p">,</span>
    <span class="n">extra_gdal_translate_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stack bands from multiple images into a single multi-band GeoTIFF.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_files (List[str]): List of input image paths.</span>
<span class="sd">        output_file (str): Path to the output stacked image.</span>
<span class="sd">        resolution (float, optional): Output resolution. If None, inferred from first image.</span>
<span class="sd">        dtype (str, optional): Output data type (e.g., &quot;UInt16&quot;, &quot;Float32&quot;).</span>
<span class="sd">        temp_vrt (str): Temporary VRT filename.</span>
<span class="sd">        overwrite (bool): Whether to overwrite the output file.</span>
<span class="sd">        compress (str): Compression method.</span>
<span class="sd">        output_format (str): GDAL output format (default is &quot;COG&quot;).</span>
<span class="sd">        extra_gdal_translate_args (List[str], optional): Extra arguments for gdal_translate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">leafmap</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No input files provided.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">input_files</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output file already exists: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_file</span>

    <span class="c1"># Infer resolution if not provided</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resolution_x</span><span class="p">,</span> <span class="n">resolution_y</span> <span class="o">=</span> <span class="n">get_raster_resolution</span><span class="p">(</span><span class="n">input_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resolution_x</span> <span class="o">=</span> <span class="n">resolution_y</span> <span class="o">=</span> <span class="n">resolution</span>

    <span class="c1"># Step 1: Build VRT</span>
    <span class="n">vrt_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdalbuildvrt&quot;</span><span class="p">,</span> <span class="s2">&quot;-separate&quot;</span><span class="p">,</span> <span class="n">temp_vrt</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_files</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">vrt_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Step 2: Translate VRT to output GeoTIFF</span>
    <span class="n">translate_cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;gdal_translate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-tr&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">resolution_x</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">resolution_y</span><span class="p">),</span>
        <span class="n">temp_vrt</span><span class="p">,</span>
        <span class="n">output_file</span><span class="p">,</span>
        <span class="s2">&quot;-of&quot;</span><span class="p">,</span>
        <span class="n">output_format</span><span class="p">,</span>
        <span class="s2">&quot;-co&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;COMPRESS=</span><span class="si">{</span><span class="n">compress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">dtype</span><span class="p">:</span>
        <span class="n">translate_cmd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;-ot&quot;</span><span class="p">)</span>
        <span class="n">translate_cmd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extra_gdal_translate_args</span><span class="p">:</span>
        <span class="n">translate_cmd</span> <span class="o">+=</span> <span class="n">extra_gdal_translate_args</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">translate_cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Step 3: Clean up VRT</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_vrt</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_vrt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.temp_file_path" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">temp_file_path</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span></code>

<a href="#geoai.utils.temp_file_path" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Returns a temporary file path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ext</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file extension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temporary file path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4982</span>
<span class="normal">4983</span>
<span class="normal">4984</span>
<span class="normal">4985</span>
<span class="normal">4986</span>
<span class="normal">4987</span>
<span class="normal">4988</span>
<span class="normal">4989</span>
<span class="normal">4990</span>
<span class="normal">4991</span>
<span class="normal">4992</span>
<span class="normal">4993</span>
<span class="normal">4994</span>
<span class="normal">4995</span>
<span class="normal">4996</span>
<span class="normal">4997</span>
<span class="normal">4998</span>
<span class="normal">4999</span>
<span class="normal">5000</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">temp_file_path</span><span class="p">(</span><span class="n">ext</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a temporary file path.</span>

<span class="sd">    Args:</span>
<span class="sd">        ext (str): The file extension.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The temporary file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_id</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">file_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.try_common_architectures" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">try_common_architectures</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span></code>

<a href="#geoai.utils.try_common_architectures" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Try to load the state_dict into common architectures to see which one fits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model's state dictionary</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6834</span>
<span class="normal">6835</span>
<span class="normal">6836</span>
<span class="normal">6837</span>
<span class="normal">6838</span>
<span class="normal">6839</span>
<span class="normal">6840</span>
<span class="normal">6841</span>
<span class="normal">6842</span>
<span class="normal">6843</span>
<span class="normal">6844</span>
<span class="normal">6845</span>
<span class="normal">6846</span>
<span class="normal">6847</span>
<span class="normal">6848</span>
<span class="normal">6849</span>
<span class="normal">6850</span>
<span class="normal">6851</span>
<span class="normal">6852</span>
<span class="normal">6853</span>
<span class="normal">6854</span>
<span class="normal">6855</span>
<span class="normal">6856</span>
<span class="normal">6857</span>
<span class="normal">6858</span>
<span class="normal">6859</span>
<span class="normal">6860</span>
<span class="normal">6861</span>
<span class="normal">6862</span>
<span class="normal">6863</span>
<span class="normal">6864</span>
<span class="normal">6865</span>
<span class="normal">6866</span>
<span class="normal">6867</span>
<span class="normal">6868</span>
<span class="normal">6869</span>
<span class="normal">6870</span>
<span class="normal">6871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">try_common_architectures</span><span class="p">(</span><span class="n">state_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to load the state_dict into common architectures to see which one fits.</span>

<span class="sd">    Args:</span>
<span class="sd">        state_dict: The model&#39;s state dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torchinfo</span>

    <span class="c1"># Test models and their initializations</span>
    <span class="n">models_to_try</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;FCN-ResNet50&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">fcn_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
        <span class="s2">&quot;DeepLabV3-ResNet50&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">deeplabv3_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trying to load state_dict into common architectures:&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model_fn</span> <span class="ow">in</span> <span class="n">models_to_try</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">()</span>
            <span class="c1"># Sometimes state_dict keys have &#39;model.&#39; prefix</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;model.&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">cleaned_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">6</span><span class="p">:]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">cleaned_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Successfully loaded (may have missing or unexpected keys)&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Generate model summary</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> architecture:&quot;</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">torchinfo</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Failed to load - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.vector_to_geojson" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vector_to_geojson</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.vector_to_geojson" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Converts a vector file to a geojson file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector file path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output geojson file path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The geojson dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7169</span>
<span class="normal">7170</span>
<span class="normal">7171</span>
<span class="normal">7172</span>
<span class="normal">7173</span>
<span class="normal">7174</span>
<span class="normal">7175</span>
<span class="normal">7176</span>
<span class="normal">7177</span>
<span class="normal">7178</span>
<span class="normal">7179</span>
<span class="normal">7180</span>
<span class="normal">7181</span>
<span class="normal">7182</span>
<span class="normal">7183</span>
<span class="normal">7184</span>
<span class="normal">7185</span>
<span class="normal">7186</span>
<span class="normal">7187</span>
<span class="normal">7188</span>
<span class="normal">7189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">vector_to_geojson</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a vector file to a geojson file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): The vector file path.</span>
<span class="sd">        output (str, optional): The output geojson file path. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The geojson dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdf</span><span class="o">.</span><span class="n">__geo_interface__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.vector_to_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vector_to_raster</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_raster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#geoai.utils.vector_to_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert vector data to a raster.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input vector file or a GeoDataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output raster file. If None, returns the array without saving.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a reference raster for dimensions, transform and CRS.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field name in the vector data to use for pixel values.
If None, all vector features will be burned with value 1.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shape of the output raster as (height, width).
Required if reference_raster is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform</code>
            </td>
            <td>
                  <code><span title="affine.Affine">Affine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Affine transformation matrix.
Required if reference_raster is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pixel_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size (resolution) as single value or (x_res, y_res).
Used to calculate transform if transform is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounds of the output raster as (left, bottom, right, top).
Used to calculate transform if transform is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crs</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="CRS">CRS</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system of the output raster.
Required if reference_raster is not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>all_touched</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, all pixels touched by geometries will be burned in.
If False, only pixels whose center is within the geometry will be burned in.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fill_value</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to fill the raster with before burning in features.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="numpy.dtype">dtype</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type of the output raster.</p>
              </div>
            </td>
            <td>
                  <code><span title="numpy.uint8">uint8</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nodata</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>No data value for the output raster.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_result</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to plot the resulting raster.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: The rasterized data array if output_path is None, else None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">vector_to_raster</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_raster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pixel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">all_touched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="n">nodata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert vector data to a raster.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str or GeoDataFrame): Path to the input vector file or a GeoDataFrame.</span>
<span class="sd">        output_path (str): Path to save the output raster file. If None, returns the array without saving.</span>
<span class="sd">        reference_raster (str): Path to a reference raster for dimensions, transform and CRS.</span>
<span class="sd">        attribute_field (str): Field name in the vector data to use for pixel values.</span>
<span class="sd">            If None, all vector features will be burned with value 1.</span>
<span class="sd">        output_shape (tuple): Shape of the output raster as (height, width).</span>
<span class="sd">            Required if reference_raster is not provided.</span>
<span class="sd">        transform (affine.Affine): Affine transformation matrix.</span>
<span class="sd">            Required if reference_raster is not provided.</span>
<span class="sd">        pixel_size (float or tuple): Pixel size (resolution) as single value or (x_res, y_res).</span>
<span class="sd">            Used to calculate transform if transform is not provided.</span>
<span class="sd">        bounds (tuple): Bounds of the output raster as (left, bottom, right, top).</span>
<span class="sd">            Used to calculate transform if transform is not provided.</span>
<span class="sd">        crs (str or CRS): Coordinate reference system of the output raster.</span>
<span class="sd">            Required if reference_raster is not provided.</span>
<span class="sd">        all_touched (bool): If True, all pixels touched by geometries will be burned in.</span>
<span class="sd">            If False, only pixels whose center is within the geometry will be burned in.</span>
<span class="sd">        fill_value (int): Value to fill the raster with before burning in features.</span>
<span class="sd">        dtype (numpy.dtype): Data type of the output raster.</span>
<span class="sd">        nodata (int): No data value for the output raster.</span>
<span class="sd">        plot_result (bool): Whether to plot the resulting raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The rasterized data array if output_path is None, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load vector data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">vector_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

    <span class="c1"># Check if vector data is empty</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The input vector data is empty. Creating an empty raster.&quot;</span><span class="p">)</span>

    <span class="c1"># Get CRS from vector data if not provided</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reference_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Get transform and output shape from reference raster if provided</span>
    <span class="k">if</span> <span class="n">reference_raster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reference_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
            <span class="k">if</span> <span class="n">nodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nodata</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if we have all required parameters</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pixel_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either reference_raster, transform, or both pixel_size and bounds must be provided.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Calculate transform from pixel size and bounds</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">x_res</span> <span class="o">=</span> <span class="n">y_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span> <span class="o">=</span> <span class="n">pixel_size</span>
                <span class="n">y_res</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_res</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Convert to negative for north-up raster</span>

            <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
                <span class="n">left</span><span class="p">,</span>
                <span class="n">bottom</span><span class="p">,</span>
                <span class="n">right</span><span class="p">,</span>
                <span class="n">top</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">((</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_res</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">((</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_res</span><span class="p">)),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Calculate output shape from bounds and pixel size</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pixel_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;output_shape must be provided if reference_raster is not provided and &quot;</span>
                    <span class="s2">&quot;cannot be calculated from bounds and pixel_size.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">x_res</span> <span class="o">=</span> <span class="n">y_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span> <span class="o">=</span> <span class="n">pixel_size</span>

            <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_res</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_res</span><span class="p">))</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="c1"># Ensure CRS is set</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;CRS must be provided either directly, from reference_raster, or from input vector data.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Reproject vector data if its CRS doesn&#39;t match the output CRS</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">crs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojecting vector data from </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Create empty raster filled with fill_value</span>
    <span class="n">raster_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Burn vector features into raster</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># Prepare shapes for burning</span>
        <span class="k">if</span> <span class="n">attribute_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attribute_field</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Use attribute field for values</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[</span><span class="n">attribute_field</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Burn with value 1</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">geom</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

        <span class="c1"># Burn shapes into raster</span>
        <span class="n">burned</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
            <span class="n">shapes</span><span class="o">=</span><span class="n">shapes</span><span class="p">,</span>
            <span class="n">out_shape</span><span class="o">=</span><span class="n">output_shape</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update raster data</span>
        <span class="n">raster_data</span> <span class="o">=</span> <span class="n">burned</span>

    <span class="c1"># Save raster if output path is provided</span>
    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create directory if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Define metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">raster_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">crs</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add nodata value if provided</span>
        <span class="k">if</span> <span class="n">nodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata</span>

        <span class="c1"># Write raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raster_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rasterized data saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot result if requested</span>
    <span class="k">if</span> <span class="n">plot_result</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Plot raster</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">attribute_field</span> <span class="k">if</span> <span class="n">attribute_field</span> <span class="k">else</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span>

        <span class="c1"># Plot vector boundaries for reference</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get the extent of the raster</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">raster_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate extent from transform and shape</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">output_shape</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">raster_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>

        <span class="c1"># Clip vector to raster extent for clarity in plot</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">gdf_clipped</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">raster_bbox</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gdf_clipped</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">gdf_clipped</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Rasterized Vector Data&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">raster_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.view_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bdx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip_percentiles</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">axis_off</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.view_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize an image using matplotlib.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The image to visualize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transpose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to transpose the image. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bdx</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The band index to visualize. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of the figure. Defaults to (10, 5).</p>
              </div>
            </td>
            <td>
                  <code>(10, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis_off</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to turn off the axis. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The title of the plot. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for plt.imshow().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_image</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bdx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clip_percentiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">axis_off</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize an image using matplotlib.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Union[np.ndarray, torch.Tensor]): The image to visualize.</span>
<span class="sd">        transpose (bool, optional): Whether to transpose the image. Defaults to False.</span>
<span class="sd">        bdx (Optional[int], optional): The band index to visualize. Defaults to None.</span>
<span class="sd">        figsize (Tuple[int, int], optional): The size of the figure. Defaults to (10, 5).</span>
<span class="sd">        axis_off (bool, optional): Whether to turn off the axis. Defaults to True.</span>
<span class="sd">        title (Optional[str], optional): The title of the plot. Defaults to None.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments for plt.imshow().</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bdx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bdx</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">clip_percentiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_low</span><span class="p">,</span> <span class="n">p_high</span> <span class="o">=</span> <span class="n">clip_percentiles</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">p_low</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">p_high</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">image</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis_off</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.view_raster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_raster</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s1">&#39;Raster&#39;</span><span class="p">,</span> <span class="n">layer_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom_to_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">array_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cors_all&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">basemap</span><span class="o">=</span><span class="s1">&#39;OpenStreetMap&#39;</span><span class="p">,</span> <span class="n">basemap_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;ipyleaflet&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.view_raster" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize a raster using leafmap.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source of the raster.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indexes</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The band indexes to visualize. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>colormap</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to apply. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vmin</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum value for colormap scaling. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vmax</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum value for colormap scaling. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nodata</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The nodata value. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The attribution for the raster. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the layer. Defaults to "Raster".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Raster&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_index</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the layer. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zoom_to_layer</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to zoom to the layer. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>visible</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the layer is visible. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>opacity</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The opacity of the layer. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>array_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for array processing. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>client_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the client. Defaults to {"cors_all": False}.</p>
              </div>
            </td>
            <td>
                  <code>{&#39;cors_all&#39;: False}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The basemap to use. Defaults to "OpenStreetMap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;OpenStreetMap&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the basemap. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>backend</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The backend to use. Defaults to "ipyleaflet".</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipyleaflet&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>leafmap.Map: The map object with the raster layer added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_raster</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">indexes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nodata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">layer_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Raster&quot;</span><span class="p">,</span>
    <span class="n">layer_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_to_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">visible</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">opacity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">array_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">client_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cors_all&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="n">basemap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OpenStreetMap&quot;</span><span class="p">,</span>
    <span class="n">basemap_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ipyleaflet&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize a raster using leafmap.</span>

<span class="sd">    Args:</span>
<span class="sd">        source (str): The source of the raster.</span>
<span class="sd">        indexes (Optional[int], optional): The band indexes to visualize. Defaults to None.</span>
<span class="sd">        colormap (Optional[str], optional): The colormap to apply. Defaults to None.</span>
<span class="sd">        vmin (Optional[float], optional): The minimum value for colormap scaling. Defaults to None.</span>
<span class="sd">        vmax (Optional[float], optional): The maximum value for colormap scaling. Defaults to None.</span>
<span class="sd">        nodata (Optional[float], optional): The nodata value. Defaults to None.</span>
<span class="sd">        attribution (Optional[str], optional): The attribution for the raster. Defaults to None.</span>
<span class="sd">        layer_name (Optional[str], optional): The name of the layer. Defaults to &quot;Raster&quot;.</span>
<span class="sd">        layer_index (Optional[int], optional): The index of the layer. Defaults to None.</span>
<span class="sd">        zoom_to_layer (Optional[bool], optional): Whether to zoom to the layer. Defaults to True.</span>
<span class="sd">        visible (Optional[bool], optional): Whether the layer is visible. Defaults to True.</span>
<span class="sd">        opacity (Optional[float], optional): The opacity of the layer. Defaults to 1.0.</span>
<span class="sd">        array_args (Optional[Dict], optional): Additional arguments for array processing. Defaults to {}.</span>
<span class="sd">        client_args (Optional[Dict], optional): Additional arguments for the client. Defaults to {&quot;cors_all&quot;: False}.</span>
<span class="sd">        basemap (Optional[str], optional): The basemap to use. Defaults to &quot;OpenStreetMap&quot;.</span>
<span class="sd">        basemap_args (Optional[Dict], optional): Additional arguments for the basemap. Defaults to None.</span>
<span class="sd">        backend (Optional[str], optional): The backend to use. Defaults to &quot;ipyleaflet&quot;.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        leafmap.Map: The map object with the raster layer added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;folium&quot;</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">leafmap.foliumap</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">leafmap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">leafmap.leafmap</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">leafmap</span>

    <span class="k">if</span> <span class="n">basemap_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basemap_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">array_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">basemap</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basemap_args</span><span class="p">:</span>
                    <span class="n">basemap_args</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basemap&quot;</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_cog_layer</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;layer_name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basemap_args</span><span class="p">:</span>
                    <span class="n">basemap_args</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basemap&quot;</span>
                <span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="o">**</span><span class="n">basemap_args</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">dict_to_image</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;bidx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexes</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;colormap_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colormap</span>
        <span class="k">if</span> <span class="n">attribution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attribution</span> <span class="o">=</span> <span class="s2">&quot;TiTiler&quot;</span>

        <span class="n">m</span><span class="o">.</span><span class="n">add_cog_layer</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
            <span class="n">attribution</span><span class="o">=</span><span class="n">attribution</span><span class="p">,</span>
            <span class="n">zoom_to_layer</span><span class="o">=</span><span class="n">zoom_to_layer</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span>
            <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
            <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
            <span class="n">attribution</span><span class="o">=</span><span class="n">attribution</span><span class="p">,</span>
            <span class="n">layer_name</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span>
            <span class="n">layer_index</span><span class="o">=</span><span class="n">layer_index</span><span class="p">,</span>
            <span class="n">zoom_to_layer</span><span class="o">=</span><span class="n">zoom_to_layer</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="n">visible</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
            <span class="n">array_args</span><span class="o">=</span><span class="n">array_args</span><span class="p">,</span>
            <span class="n">client_args</span><span class="o">=</span><span class="n">client_args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.view_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_vector</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">basemap_type</span><span class="o">=</span><span class="s1">&#39;streets&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">classification</span><span class="o">=</span><span class="s1">&#39;quantiles&#39;</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">highlight_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">highlight_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></code>

<a href="#geoai.utils.view_vector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize vector datasets with options for styling, classification, basemaps and more.</p>
<p>This function visualizes GeoDataFrame objects with customizable symbology.
It supports different vector types (points, lines, polygons), attribute-based
classification, and background basemaps.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_data</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector dataset to visualize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column to use for choropleth mapping. If None,
a single color will be used. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="matplotlib.colors.Colormap">Colormap</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Colormap to use for
choropleth mapping. Defaults to "viridis".</p>
              </div>
            </td>
            <td>
                  <code>&#39;viridis&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height) in inches.
Defaults to (10, 10).</p>
              </div>
            </td>
            <td>
                  <code>(10, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>title</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Title for the plot. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a legend. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a web basemap. Requires contextily.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basemap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of basemap to use. Options: 'streets', 'satellite'.
Defaults to 'streets'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;streets&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transparency of the vector features, between 0-1.
Defaults to 0.7.</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edge_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color for feature edges. Defaults to "black".</p>
              </div>
            </td>
            <td>
                  <code>&#39;black&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>classification</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Classification method for choropleth maps.
Options: "quantiles", "equal_interval", "natural_breaks".
Defaults to "quantiles".</p>
              </div>
            </td>
            <td>
                  <code>&#39;quantiles&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_classes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes for choropleth maps.
Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highlight_index</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices to highlight.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>highlight_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color to use for highlighted features.
Defaults to "red".</p>
              </div>
            </td>
            <td>
                  <code>&#39;red&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scheme</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>MapClassify classification scheme. Overrides
classification parameter if provided. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the figure. If None, the figure
is not saved. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dpi</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI for saved figure. Defaults to 300.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>matplotlib.axes.Axes: The Axes object containing the plot.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cities</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;cities.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector</span><span class="p">(</span><span class="n">cities</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">roads</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;roads.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector</span><span class="p">(</span><span class="n">roads</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">basemap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_vector</span><span class="p">(</span>
    <span class="n">vector_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">basemap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">basemap_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;streets&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">classification</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;quantiles&quot;</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">highlight_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">highlight_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">scheme</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize vector datasets with options for styling, classification, basemaps and more.</span>

<span class="sd">    This function visualizes GeoDataFrame objects with customizable symbology.</span>
<span class="sd">    It supports different vector types (points, lines, polygons), attribute-based</span>
<span class="sd">    classification, and background basemaps.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_data (geopandas.GeoDataFrame): The vector dataset to visualize.</span>
<span class="sd">        column (str, optional): Column to use for choropleth mapping. If None,</span>
<span class="sd">            a single color will be used. Defaults to None.</span>
<span class="sd">        cmap (str or matplotlib.colors.Colormap, optional): Colormap to use for</span>
<span class="sd">            choropleth mapping. Defaults to &quot;viridis&quot;.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height) in inches.</span>
<span class="sd">            Defaults to (10, 10).</span>
<span class="sd">        title (str, optional): Title for the plot. Defaults to None.</span>
<span class="sd">        legend (bool, optional): Whether to display a legend. Defaults to True.</span>
<span class="sd">        basemap (bool, optional): Whether to add a web basemap. Requires contextily.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        basemap_type (str, optional): Type of basemap to use. Options: &#39;streets&#39;, &#39;satellite&#39;.</span>
<span class="sd">            Defaults to &#39;streets&#39;.</span>
<span class="sd">        alpha (float, optional): Transparency of the vector features, between 0-1.</span>
<span class="sd">            Defaults to 0.7.</span>
<span class="sd">        edge_color (str, optional): Color for feature edges. Defaults to &quot;black&quot;.</span>
<span class="sd">        classification (str, optional): Classification method for choropleth maps.</span>
<span class="sd">            Options: &quot;quantiles&quot;, &quot;equal_interval&quot;, &quot;natural_breaks&quot;.</span>
<span class="sd">            Defaults to &quot;quantiles&quot;.</span>
<span class="sd">        n_classes (int, optional): Number of classes for choropleth maps.</span>
<span class="sd">            Defaults to 5.</span>
<span class="sd">        highlight_index (list, optional): List of indices to highlight.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        highlight_color (str, optional): Color to use for highlighted features.</span>
<span class="sd">            Defaults to &quot;red&quot;.</span>
<span class="sd">        scheme (str, optional): MapClassify classification scheme. Overrides</span>
<span class="sd">            classification parameter if provided. Defaults to None.</span>
<span class="sd">        save_path (str, optional): Path to save the figure. If None, the figure</span>
<span class="sd">            is not saved. Defaults to None.</span>
<span class="sd">        dpi (int, optional): DPI for saved figure. Defaults to 300.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.axes.Axes: The Axes object containing the plot.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">        &gt;&gt;&gt; cities = gpd.read_file(&quot;cities.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector(cities, &quot;population&quot;, cmap=&quot;Reds&quot;, basemap=True)</span>

<span class="sd">        &gt;&gt;&gt; roads = gpd.read_file(&quot;roads.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector(roads, &quot;type&quot;, basemap=True, figsize=(12, 8))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">contextily</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ctx</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>

    <span class="c1"># Check if input is a GeoDataFrame</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input data must be a GeoDataFrame&quot;</span><span class="p">)</span>

    <span class="c1"># Make a copy to avoid changing the original data</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Set up figure and axis</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Determine geometry type</span>
    <span class="n">geom_type</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geom_type</span>

    <span class="c1"># Plotting parameters</span>
    <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;ax&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="p">}</span>

    <span class="c1"># Set up keyword arguments based on geometry type</span>
    <span class="k">if</span> <span class="s2">&quot;Point&quot;</span> <span class="ow">in</span> <span class="n">geom_type</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_color</span>
    <span class="k">elif</span> <span class="s2">&quot;Line&quot;</span> <span class="ow">in</span> <span class="n">geom_type</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="s2">&quot;Polygon&quot;</span> <span class="ow">in</span> <span class="n">geom_type</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_color</span>

    <span class="c1"># Classification options</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use mapclassify scheme if provided</span>
            <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scheme</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use classification parameter</span>
            <span class="k">if</span> <span class="n">classification</span> <span class="o">==</span> <span class="s2">&quot;quantiles&quot;</span><span class="p">:</span>
                <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;quantiles&quot;</span>
            <span class="k">elif</span> <span class="n">classification</span> <span class="o">==</span> <span class="s2">&quot;equal_interval&quot;</span><span class="p">:</span>
                <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;equal_interval&quot;</span>
            <span class="k">elif</span> <span class="n">classification</span> <span class="o">==</span> <span class="s2">&quot;natural_breaks&quot;</span><span class="p">:</span>
                <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fisher_jenks&quot;</span>

        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_classes</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend</span>

    <span class="c1"># Plot the main data</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># Highlight specific features if requested</span>
    <span class="k">if</span> <span class="n">highlight_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">highlight_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">highlight_color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">basemap</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">basemap_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;streets&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span>
                <span class="s2">&quot;satellite&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">Esri</span><span class="o">.</span><span class="n">WorldImagery</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">basemap_options</span><span class="p">[</span><span class="n">basemap_type</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add basemap: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set title if provided</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Remove axes if not needed</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

    <span class="c1"># Adjust layout</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save figure if a path is provided</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.view_vector_interactive" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">view_vector_interactive</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s1">&#39;Vector Layer&#39;</span><span class="p">,</span> <span class="n">tiles_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#geoai.utils.view_vector_interactive" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Visualize vector datasets with options for styling, classification, basemaps and more.</p>
<p>This function visualizes GeoDataFrame objects with customizable symbology.
It supports different vector types (points, lines, polygons), attribute-based
classification, and background basemaps.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_data</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector dataset to visualize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the layer. Defaults to "Vector Layer".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Vector Layer&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tiles_args</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the localtileserver client.
get_folium_tile_layer function. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to GeoDataFrame.explore() function.
See https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folium.Map: The map object with the vector data added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cities</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;cities.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector_interactive</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">roads</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;roads.shp&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">view_vector_interactive</span><span class="p">(</span><span class="n">roads</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view_vector_interactive</span><span class="p">(</span>
    <span class="n">vector_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
    <span class="n">layer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Vector Layer&quot;</span><span class="p">,</span>
    <span class="n">tiles_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize vector datasets with options for styling, classification, basemaps and more.</span>

<span class="sd">    This function visualizes GeoDataFrame objects with customizable symbology.</span>
<span class="sd">    It supports different vector types (points, lines, polygons), attribute-based</span>
<span class="sd">    classification, and background basemaps.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_data (geopandas.GeoDataFrame): The vector dataset to visualize.</span>
<span class="sd">        layer_name (str, optional): The name of the layer. Defaults to &quot;Vector Layer&quot;.</span>
<span class="sd">        tiles_args (dict, optional): Additional arguments for the localtileserver client.</span>
<span class="sd">            get_folium_tile_layer function. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to GeoDataFrame.explore() function.</span>
<span class="sd">            See https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html</span>

<span class="sd">    Returns:</span>
<span class="sd">        folium.Map: The map object with the vector data added.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">        &gt;&gt;&gt; cities = gpd.read_file(&quot;cities.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector_interactive(cities)</span>

<span class="sd">        &gt;&gt;&gt; roads = gpd.read_file(&quot;roads.shp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; view_vector_interactive(roads, figsize=(12, 8))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">folium.plugins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plugins</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">leafmap</span><span class="w"> </span><span class="kn">import</span> <span class="n">cog_tile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">localtileserver</span><span class="w"> </span><span class="kn">import</span> <span class="n">TileClient</span><span class="p">,</span> <span class="n">get_folium_tile_layer</span>

    <span class="n">google_tiles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Roadmap&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=m&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Maps&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;Satellite&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=s&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Satellite&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;Terrain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=p&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Terrain&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;Hybrid&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mt1.google.com/vt/lyrs=y&amp;x=</span><span class="si">{x}</span><span class="s2">&amp;y=</span><span class="si">{y}</span><span class="s2">&amp;z=</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attribution&quot;</span><span class="p">:</span> <span class="s2">&quot;Google&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Google Hybrid&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">raster_layer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;tiles&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="ow">in</span> <span class="n">google_tiles</span><span class="p">:</span>
            <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="n">google_tiles</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">google_tiles</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Google&quot;</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tiles_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tiles_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="s2">&quot;Remote Raster&quot;</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cog_tile</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">tiles_args</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TiTiler&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basemap_layer_name</span> <span class="o">=</span> <span class="s2">&quot;Local Raster&quot;</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">TileClient</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">])</span>
                <span class="n">raster_layer</span> <span class="o">=</span> <span class="n">get_folium_tile_layer</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">**</span><span class="n">tiles_args</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raster_layer</span><span class="o">.</span><span class="n">tiles</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;localtileserver&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;max_zoom&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_zoom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
            <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vector_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>

    <span class="c1"># Check if input is a GeoDataFrame</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input data must be a GeoDataFrame&quot;</span><span class="p">)</span>

    <span class="n">layer_control</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;layer_control&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">fullscreen_control</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fullscreen_control&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Change the layer name</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">):</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">basemap_layer_name</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">layer_name</span> <span class="o">=</span> <span class="n">basemap_layer_name</span>

    <span class="k">if</span> <span class="n">layer_control</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">fullscreen_control</span><span class="p">:</span>
        <span class="n">plugins</span><span class="o">.</span><span class="n">Fullscreen</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.visualize_vector_by_attribute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visualize_vector_by_attribute</span><span class="p">(</span><span class="n">vector_path</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></code>

<a href="#geoai.utils.visualize_vector_by_attribute" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a thematic map visualization of vector data based on an attribute.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the vector file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attribute_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the attribute to visualize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Matplotlib colormap name. Defaults to 'viridis'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;viridis&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size as (width, height). Defaults to (10, 8).</p>
              </div>
            </td>
            <td>
                  <code>(10, 8)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if visualization was successful, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_vector_by_attribute</span><span class="p">(</span>
    <span class="n">vector_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a thematic map visualization of vector data based on an attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector_path (str): Path to the vector file</span>
<span class="sd">        attribute_name (str): Name of the attribute to visualize</span>
<span class="sd">        cmap (str, optional): Matplotlib colormap name. Defaults to &#39;viridis&#39;.</span>
<span class="sd">        figsize (tuple, optional): Figure size as (width, height). Defaults to (10, 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if visualization was successful, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read the vector data</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span>

        <span class="c1"># Check if attribute exists</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; not found in the dataset&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Create the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Determine plot type based on data type</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]):</span>
            <span class="c1"># Continuous data</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Categorical data</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Add title and labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vector_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>

        <span class="c1"># Add basemap or additional elements if available</span>
        <span class="c1"># Note: Additional options could be added here for more complex maps</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error visualizing data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="geoai.utils.write_colormap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_colormap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#geoai.utils.write_colormap" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Write a colormap to an image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The image to write the colormap to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>colormap</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap to write to the image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output file path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>geoai/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">7505</span>
<span class="normal">7506</span>
<span class="normal">7507</span>
<span class="normal">7508</span>
<span class="normal">7509</span>
<span class="normal">7510</span>
<span class="normal">7511</span>
<span class="normal">7512</span>
<span class="normal">7513</span>
<span class="normal">7514</span>
<span class="normal">7515</span>
<span class="normal">7516</span>
<span class="normal">7517</span>
<span class="normal">7518</span>
<span class="normal">7519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_colormap</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a colormap to an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: The image to write the colormap to.</span>
<span class="sd">        colormap: The colormap to write to the image.</span>
<span class="sd">        output: The output file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">get_image_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
    <span class="n">leafmap</span><span class="o">.</span><span class="n">write_image_colormap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="March 5, 2025 03:39:14 UTC"><span class="timeago" datetime="2025-03-05T03:39:14+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="March 5, 2025 03:39:14 UTC">2025-03-05</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="March 5, 2025 03:39:14 UTC"><span class="timeago" datetime="2025-03-05T03:39:14+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="March 5, 2025 03:39:14 UTC">2025-03-05</span>
  </span>

    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2025 Qiusheng Wu
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../js/timeago.min.js"></script>
      
        <script src="../js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>